<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18 Stomach And Duodenum - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">28</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A neonate presented with features of intestinal obstruction. The X-ray showed the following image. What is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Jejunoileal atresia"
      },
      {
        "id": 2,
        "text": "Esophageal atresia"
      },
      {
        "id": 3,
        "text": "Duodenal atresia"
      },
      {
        "id": 4,
        "text": "Colonic atresia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above plain abdominal radiograph shows a typical <strong>double-bubble sign</strong> suggestive of <strong>duodenal atresia.</strong></p>\n<p>The double-bubble represents dilatation of the <strong>stomach</strong> and the <strong>proximal duodenum.</strong></p>\n<p>Duodenal atresia is often associated with<strong> trisomy 21/Down syndrome</strong>, prematurity, maternal polyhydramnios, cardiac malformations, and malformations of the hepatobiliary system.</p>\n<p>It is caused due to <strong>failure of recanalization</strong> or partial recanalization of the duodenum or failure of vacuolization of the duodenum from its solid cord stage. The anatomic variants are as follows:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Type I:&nbsp;</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\"><strong>most common</strong></li>\n<li style=\"font-weight: 400;\" aria-level=\"2\">mucosal web with intact muscle wall (so-called <strong>windsock deformity</strong>)</li>\n</ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Type II:</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\">two ends separated by a fibrous cord, but muscle continuity present</li>\n</ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Type III:</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\">complete separation of two ends with a gap within the duodenum</li>\n</ul>\n</ul>\n<p>Clinical features:</p>\n<ul>\n<li>Obstructive features such as<br />\n<ul>\n<li>bilious emesis (due to duodenal obstruction distal to the ampulla of Vater)</li>\n<li>postprandial emesis</li>\n<li>upper abdominal distension with a <strong>scaphoid lower abdomen</strong></li>\n</ul>\n</li>\n<li>Delayed passage of meconium</li>\n</ul>\n<p>Abdominal radiographs show the <strong>double-bubble sign</strong>. If distal air is present, an upper GI contrast study should be considered to exclude midgut volvulus.</p>\n<p>Treatment:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">The initial treatment of infants with duodenal atresia includes <strong>nasogastric or orogastric decompression</strong>.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">IV fluids and parenteral nutrition are started to prevent <strong>acid-base imbalance.</strong></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Echocardiography, renal ultrasound, and radiology of the chest and spine should be performed to evaluate for<strong> associated anomalies</strong>.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Definitive correction of the atresia is done by <strong>duodenoduodenostomy</strong>. This procedure is also preferred in cases of the concomitant or isolated annular pancreas.</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d6aeb905fa9947ca966e6a3472a88362.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1b54b3db1aea47a38053c12f64383defx1280x1159.JPEG"
    ]
  },
  {
    "text": "An infant with Edward's syndrome presents with the following radiological finding. Which of the following is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "More common in boys"
      },
      {
        "id": 2,
        "text": "Mostly presents as vomiting within 1 week"
      },
      {
        "id": 3,
        "text": "Erythromycin exposure in the first 2 weeks of life can lead to this condition"
      },
      {
        "id": 4,
        "text": "Palpation of the pyloric olive is pathognomonic  for this condition"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The radiographic image&nbsp;showing the presence of an enlarged <strong>gastric gas bubble (single bubble) </strong>is suggestive of<strong>&nbsp;</strong>congenital hypertrophic pyloric stenosis (<strong>CHPS</strong>).<strong>&nbsp;</strong>It most commonly presents with<strong> non-bilious projectile vomiting </strong>between<strong> 2-8 weeks of age</strong> and is only rarely seen after 13 weeks.</p>\n<p>Hypertrophy of the circular muscle of the pylorus results in constriction and obstruction of the gastric outlet.&nbsp;First-born <strong>male infants</strong> are at the highest risk.</p>\n<p><strong>Risk factors&nbsp;</strong>for congenital hypertrophic pyloric stenosis:</p>\n<ul>\n<li>Turner syndrome</li>\n<li>Edwards syndrome</li>\n<li><strong>Erythromycin</strong> or <strong>azithromycin</strong> exposure in the first 2 weeks of life either orally or via mother's milk.</li>\n</ul>\n<p>Palpation of the <strong>olive-shaped</strong>&nbsp;<strong>mass</strong> in the epigastrium is considered pathognomonic.&nbsp;</p>\n<p><strong>USG</strong> criteria for diagnosing hypertrophic pyloric stenosis - <strong>pyloric</strong> muscle <strong>thickness</strong> of <strong>&gt;3-4 mm</strong> or a pyloric <strong>length</strong> <strong>&gt;15-18 mm</strong> in the presence of functional <strong>gastric outlet obstruction</strong> is diagnostic.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/071f4aaf0e2043eab94636df78cd7add.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "An abdominal mass in a patient with congenital hypertrophic pyloric stenosis is best seen _________.",
    "choices": [
      {
        "id": 1,
        "text": "During feeding"
      },
      {
        "id": 2,
        "text": "Soon after birth"
      },
      {
        "id": 3,
        "text": "During palpation over the left hypochondrium"
      },
      {
        "id": 4,
        "text": "During palpation over the epigastrium"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In a child with <strong>congenital hypertrophic pyloric stenosis </strong>(CHPS),<strong> </strong>the<strong>&nbsp;</strong>abdominal mass<strong> </strong>is best seen <strong>during test feed in the right upper quadrant</strong>.&nbsp;</p>\n<p><strong>Hypertrophic pyloric stenosis</strong>&nbsp;most presents with<strong>&nbsp;non-bilious projectile vomiting.</strong>&nbsp;It is common<strong>&nbsp;</strong>between<strong>&nbsp;</strong>2 and 8 weeks of age. Hypertrophy of the&nbsp;<strong>circular muscle</strong>&nbsp;of the pylorus results in constriction and obstruction of the gastric outlet. Male infants are at a higher risk.</p>\n<p>Clinically, when the infant is given a test feed, an <strong>olive-shaped mass</strong> is palpable in the right upper quadrant and <strong>visible peristalsis</strong>&nbsp;is usually observed moving from&nbsp;<strong>left to right&nbsp;</strong>across the abdomen.</p>\n<div class=\"ng-scope\">\n<div class=\"ng-scope\">\n<p>Infants with hypertrophic pyloric stenosis develop a characteristic metabolic abnormality-&nbsp;<strong>hypochloraemic hypokalaemic</strong>&nbsp;<strong>metabolic</strong>&nbsp;<strong>alkalosis</strong>. Persistent vomiting results in loss of hydrochloric acid leading to the development of&nbsp;<strong>metabolic</strong>&nbsp;<strong>alkalosis</strong>&nbsp;(due to loss of H<sup>+</sup>) and&nbsp;<strong>hypochloremia</strong>&nbsp;(due to loss of Cl<sup>-</sup>).</p>\n</div>\n</div>\n<p>All infants with congenital hypertrophic pyloric stenosis are evaluated with an <strong>ultrasound (investigation of choice)</strong>. It <strong>confirms the diagnosis</strong>&nbsp;in the majority of cases.</p>\n<p>Management: Rehydration and metabolic correction prior to definitive surgery - Ramstedt's pyloromyotomy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A child is diagnosed with congenital hypertrophic pyloric stenosis. Which among the following statements is true regarding her condition?",
    "choices": [
      {
        "id": 1,
        "text": "2 and 4"
      },
      {
        "id": 2,
        "text": "1, 3 and 5"
      },
      {
        "id": 3,
        "text": "1, 3, 4 and 5"
      },
      {
        "id": 4,
        "text": "1, 2 and 3"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Treatment:</p>\n<ul>\n<li>The child should be\u00a0rehydrated\u00a0and the\u00a0<strong>metabolic</strong>\u00a0<strong>abnormality</strong>\u00a0has to be <strong>corrected</strong>\u00a0<strong>preoperatively.</strong></li>\n<li>The\u00a0<strong>Ramstedt pyloromyotomy</strong>\u00a0is the standard surgical procedure for its treatment.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c81643cbfc947ebb28dc729268b8a3fx1280x1328.JPEG"
    ]
  },
  {
    "text": "Which part of the GIT is most sensitive to ischemia following a hypovolemic insult?",
    "choices": [
      {
        "id": 1,
        "text": "Griffith point"
      },
      {
        "id": 2,
        "text": "Sudeck point"
      },
      {
        "id": 3,
        "text": "Terminal ileum"
      },
      {
        "id": 4,
        "text": "Stomach"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Tonometry studies have shown that of all the parts of the gastrointestinal tract (GIT), the <strong>stomach </strong>is <strong>most sensitive to ischemia</strong> <strong>following a hypovolemic insult</strong> and is also the slowest to recover.</p>\n<p>This may explain the high incidence of <strong>stress ulceration</strong> in the stomach.</p>\n<p>The <strong>Griffiths point </strong>(or <strong>Griffiths critical point</strong>) refers to the site of watershed anastomosis between the ascending left colic artery&nbsp;and the marginal artery of Drummond occurring in the region of the splenic flexure. Most anatomy texts describe its location as two-thirds along the transverse colon.</p>\n<p>The <strong>Sudeck&nbsp;point </strong>(or <strong>Sudeck&nbsp;critical point</strong>) refers to a&nbsp;specific location in&nbsp;the&nbsp;arterial supply of the rectosigmoid junction, namely the&nbsp;origin of the last sigmoid arterial branch from the&nbsp;inferior mesenteric artery (IMA).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of upper GI bleeding?",
    "choices": [
      {
        "id": 1,
        "text": "Esophageal varices"
      },
      {
        "id": 2,
        "text": "Peptic ulcer"
      },
      {
        "id": 3,
        "text": "Gastric erosions"
      },
      {
        "id": 4,
        "text": "NSAID induced gastritis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>\u00a0The most common cause of upper GI bleeding is <strong>peptic ulcer</strong>.</p>\n<p>The causes of upper GI bleed in decreasing order of frequency:\u00a0</p>\n<ul>\n<li>Ulcers\n<ul>\n<li>Esophageal (6%)</li>\n<li>Gastric (21%)</li>\n<li>Duodenal (33%)</li>\n</ul>\n</li>\n<li>Erosions</li>\n<li>Mallory\u2013Weiss tear</li>\n<li>Esophageal varices</li>\n<li>Tumour</li>\n<li>Vascular lesions</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a492d21e43e94295bc25ea030cd59805x1280x2905.JPEG"
    ]
  },
  {
    "text": "A 35-year-old man came with complaints of dark-colored stools to the OPD. After undergoing endoscopy, the patient was diagnosed with an upper GI bleed. Which of the following structures is used as a demarcation point to differentiate it from a lower GI bleed?",
    "choices": [
      {
        "id": 1,
        "text": "Ampulla of Vater"
      },
      {
        "id": 2,
        "text": "Ligament of Treitz"
      },
      {
        "id": 3,
        "text": "Superior duodenal flexure"
      },
      {
        "id": 4,
        "text": "Ileocaecal junction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>ligament of Treitz</strong> is used as the demarcation point to differentiate between upper gastrointestinal bleeding and lower gastrointestinal bleeding. It is a part of the duodenojejunal junction.&nbsp;</p>\n<p>Upper GI bleeding refers to bleeding proximal to the ligament of Treitz, and lower GI bleeding refers to bleeding distal to the ligament of Treitz.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6df2624f514343f7b0598cef54335689x1280x1267.JPEG"
    ]
  },
  {
    "text": "A 45-year-old chronic alcoholic, with a history of binge drinking and multiple episodes of vomiting, presents with hematemesis. On endoscopy, a longitudinal mucosal tear is found in the gastroesophageal junction. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Boerhaave syndrome"
      },
      {
        "id": 2,
        "text": "Mallory-Weiss tear"
      },
      {
        "id": 3,
        "text": "Gastric antral vascular ectasia"
      },
      {
        "id": 4,
        "text": "Dieulafoy lesion"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Management of\u00a0Dieulafoy lesion:\u00a0</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Endoscopic electrocoagulation or sclerosant therapy</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Angiographic embolization.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/378902f95afd48589fcb29c274507abdx720x783.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3a86a746b09341888df90ed23c43f0e5x512x385.PNG"
    ]
  },
  {
    "text": "A 25-year-old male patient presented to the OPD with complaints of increasing heartburn and dyspepsia for the past several months. He was prescribed PPIs for one month but he has no relief. You perform a urea breath test which is found to be positive. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Type A gastritis"
      },
      {
        "id": 2,
        "text": "Type B gastritis"
      },
      {
        "id": 3,
        "text": "Reflux gastritis"
      },
      {
        "id": 4,
        "text": "Erosive gastritis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario and the <strong>positive urea breath test</strong> are suggestive of a <strong>Helicobacter pylori infection</strong> which is most commonly associated with <strong>Type B gastritis.</strong></p>\n<p><strong>Type B</strong> gastritis usually affects the <strong>antrum</strong>. Intestinal metaplasia associated with chronic pan-gastritis and atrophy is seen. It has greater potential for <strong>malignancy</strong> as compared to Type A gastritis.<strong>&nbsp;</strong></p>\n<p><strong>Type A </strong>gastritis affects the <strong>fundus</strong> with antral sparing. Its features can be easily remembered by 4 &lsquo;A&rsquo;s:</p>\n<ul>\n<li><strong>Autoimmune</strong> condition - has circulating antibodies to parietal cells</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Atrophy</strong> of parietal cell mass</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Achlorhydria -</strong>&nbsp;causes chronic hypergastrinemia and microadenomas of enterochromaffin-like (ECL) cells</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Anemia -</strong>&nbsp;leads to pernicious anemia, due to malabsorption of Vit B12 (as the intrinsic factor is also produced by parietal cells)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following causes gastritis in patients with AIDS?",
    "choices": [
      {
        "id": 1,
        "text": "Histoplasmosis"
      },
      {
        "id": 2,
        "text": "Cryptosporidiosis"
      },
      {
        "id": 3,
        "text": "Cytomegalovirus"
      },
      {
        "id": 4,
        "text": "Isospora belli"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Acquired immunodeficiency syndrome (<strong>AIDS</strong>)<strong> gastritis</strong> is secondary to infection with <strong>cryptosporidiosis</strong>.</p>\n<p>Other specific types of gastritis:</p>\n<ul>\n<li><strong>Eosinophilic gastritis</strong> appears to have an <strong>allergic basis</strong> and is treated with steroids and cromoglycate.</li>\n<li><strong>Granulomatous gastritis</strong> is seen rarely in <strong>Crohn&rsquo;s disease</strong> and also may be associated with tuberculosis.</li>\n<li><strong>Phlegmonous gastritis</strong> is a rare bacterial infection of the stomach, found in patients with severe intercurrent illnesses.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common site of gastric ulcer?",
    "choices": [
      {
        "id": 1,
        "text": "Lesser curvature near incisura"
      },
      {
        "id": 2,
        "text": "Greater curvature"
      },
      {
        "id": 3,
        "text": "Fundus"
      },
      {
        "id": 4,
        "text": "Prepyloric"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common site of gastric ulcer is the <strong>lesser curvature near incisura.</strong></p>\n<p class=\"p1\">Approximately 60% of ulcers are in this location and are classified as <strong>type I gastric ulcers.</strong></p>\n<p class=\"p1\">These ulcers are generally not associated with excessive acid secretion and may occur with low to normal acid output.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which type of gastric ulcer has increased gastric acid levels?",
    "choices": [
      {
        "id": 1,
        "text": "Type I"
      },
      {
        "id": 2,
        "text": "Type IV"
      },
      {
        "id": 3,
        "text": "Type V"
      },
      {
        "id": 4,
        "text": "Type III"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Gastric ulcers of Types II</strong> (gastric body with duodenal ulcer) <strong>and III</strong> (prepyloric) are associated with <strong>increased gastric acid levels.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A biopsy was obtained from a patient with chronic peptic ulcer disease. The pathological slide is given below. Identify the false statement regarding the causative agent of this condition.",
    "choices": [
      {
        "id": 1,
        "text": "Causes hypogastrinemia"
      },
      {
        "id": 2,
        "text": "Causes the most common type of gastritis"
      },
      {
        "id": 3,
        "text": "Associated with causation of gastric MALToma"
      },
      {
        "id": 4,
        "text": "Considered by WHO as class I carcinogen"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given slide shows the GI mucosa, stained with <strong>Warthin-Starry silver stain</strong>, infected with <strong>Helicobacter pylori.</strong> H. pylori cause <strong>hypergastrinemia</strong>.</p>\n<p>The ammonia released by H. pylori acts on the <strong>antral G-cells</strong> and releases gastrin. This is responsible for hypergastrinemia in these patients resulting in <strong>type B gastritis</strong> (the most common type of gastritis).</p>\n<p><strong>Urea breath test</strong> and antibodies to H. pylori help us with diagnosis. The <strong>gold standard</strong> investigation for H. pylori is a <strong>tissue biopsy.</strong></p>\n<p>H. pylori is classified by the WHO as a class I carcinogen because of the production of certain cytotoxins, notably the <strong>Cag A and Vac A</strong>, which are implicated in gastritis, peptic ulceration, and cancer.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ef7f79a8dba44027bdb4da09c53d2a34.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "What is the most common complication that you expect in patients suffering from peptic ulcer disease?",
    "choices": [
      {
        "id": 1,
        "text": "Bleeding"
      },
      {
        "id": 2,
        "text": "Obstruction"
      },
      {
        "id": 3,
        "text": "Perforation"
      },
      {
        "id": 4,
        "text": "Malignant transformation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>most common complication</strong> of peptic ulcer disease is <strong>bleeding</strong>, followed by perforation and obstruction.&nbsp;</p>\n<p>The <strong>most common site for perforation</strong> of peptic ulcers is the first part of the duodenum.</p>\n<p>Complications of peptic ulcers are</p>\n<ul>\n<li>Bleeding - It is the most common complication of <strong>posterior</strong> <strong>duodenal</strong> <strong>ulcer</strong>.</li>\n<li>Perforation - It is the most common complication of <strong>anterior</strong> <strong>duodenal</strong> <strong>ulcer</strong> and <strong>gastric</strong> <strong>ulcer</strong>.</li>\n<li>Obstruction</li>\n<li><strong>Hour-glass deformity</strong> of the stomach - Large long-standing gastric ulcers can lead to fibrosis. <strong>fibrosis</strong> if present can cause hourglass constriction of the stomach. <strong>Barium</strong> meal shows <strong>double</strong> <strong>pouched</strong> stomach.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Tea-pot deformity</strong> (handbag stomach) - It is caused by cicatrization and shortening of the lesser curvature.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">An ulcer can erode <strong>posteriorly</strong> into the <strong>pancreas</strong> and <strong>anteriorly</strong> into the <strong>liver</strong>.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Malignancy.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is used for the classification of the endoscopic appearance of bleeding peptic ulcers in a patient with peptic ulcer disease?",
    "choices": [
      {
        "id": 1,
        "text": "Forrest classification"
      },
      {
        "id": 2,
        "text": "Blatchford score"
      },
      {
        "id": 3,
        "text": "Rockall score"
      },
      {
        "id": 4,
        "text": "Bismuth classification"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Forrest classification</strong> is used for classifying the <strong>endoscopic</strong> appearance of <strong>bleeding peptic ulcers</strong>. It stratifies the <strong>risk of rebleeding</strong> based on observed stigmata of recent hemorrhage.&nbsp;</p>\n<table>\n<tbody>\n<tr>\n<td width=\"312\">\n<p><strong>Stigmata of Recent Hemorrhage</strong></p>\n</td>\n<td width=\"312\">\n<p><strong>Forrest Classification</strong></p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Active Spurting</strong></p>\n</td>\n<td width=\"312\">\n<p>I A</p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Active Oozing</strong></p>\n</td>\n<td width=\"312\">\n<p>I B</p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Non-bleeding vessel</strong></p>\n</td>\n<td width=\"312\">\n<p>II A</p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Adherent Clot</strong></p>\n</td>\n<td width=\"312\">\n<p>II B</p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Flat Pigmented Spot</strong></p>\n</td>\n<td width=\"312\">\n<p>II C</p>\n</td>\n</tr>\n<tr>\n<td width=\"312\">\n<p><strong>Clean Based Ulcer</strong></p>\n</td>\n<td width=\"312\">\n<p>III</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Forrest classification is clinically very significant as it provides <strong>prognostic information</strong> to the surgeon about the need for endoscopic therapeutic intervention and the risk of rebleeding.</p>\n<p>Option B:<strong> The Glasgow&ndash;Blatchford bleeding score</strong> (GBS) is a screening tool to <strong>assess</strong> the likelihood that a patient with acute upper gastrointestinal bleeding (UGIB) will <strong>need medical intervention</strong> such as a blood transfusion or endoscopic&nbsp;intervention. It incorporates the patient&rsquo;s blood urea level, hemoglobin level, blood pressure, and other clinical parameters.</p>\n<p>Option C:<strong> Rockall score</strong> assesses the<strong> risk of rebleeding and in-hospital mortality</strong> in patients with an upper GI bleed.</p>\n<p>Option D:<strong> The</strong> <strong>Bismuth&ndash;Corlette classification</strong> system provides an anatomic description of the tumor location and longitudinal extension in the biliary tree.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most commonly involved vessel in patients with bleeding peptic ulcers on the posterior wall?",
    "choices": [
      {
        "id": 1,
        "text": "Left gastric artery"
      },
      {
        "id": 2,
        "text": "Right gastroepiploic artery"
      },
      {
        "id": 3,
        "text": "Gastroduodenal artery"
      },
      {
        "id": 4,
        "text": "Left gastroepiploic artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most common vessel responsible for bleeding in peptic ulcer disease is the <strong>gastroduodenal artery</strong>. Ulcers located in the <strong>posterior wall</strong> can erode the mucosa and the gastroduodenal artery, leading to hematemesis and melena.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d79e038c12b545d09156261a5decdcdcx600x629.JPEG"
    ]
  },
  {
    "text": "A 23-year-old woman was admitted to the burns ward with an involvement of 45% of the body surface area. She is at an increased risk of developing ulcers in which of the following parts of the stomach?",
    "choices": [
      {
        "id": 1,
        "text": "Fundus"
      },
      {
        "id": 2,
        "text": "Body"
      },
      {
        "id": 3,
        "text": "Lesser curvature"
      },
      {
        "id": 4,
        "text": "Greater curvature"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A patient with burn is at risk of developing&nbsp;<strong>Curling&rsquo;s ulcers</strong> (stress ulcers). <strong>Stress ulcers</strong> in the stomach are located most commonly in the <strong>fundus</strong>.</p>\n<p>Stress gastritis occurs after a&nbsp;<strong>physical trauma, shock, sepsis, hemorrhage, or respiratory failure.&nbsp;</strong>It is characterized by <strong>multiple superficial (non-ulcerating) erosions</strong> that begin in the proximal or acid-secreting portion of the stomach and progress distally. They are almost always seen in the <strong>fundus</strong> of the stomach and usually develop within 1 to 2 days after a traumatic event.</p>\n<p>The stress-induced splanchnic vasoconstriction causes systemic hypotension and reduced blood flow leading to mucosal injury.</p>\n<p>On microscopic examination, they appear as <strong>wedge-shaped mucosal hemorrhages,</strong> with coagulation necrosis of the superficial mucosal cells. Stress ulcers present as <strong>painless</strong> upper GI bleeds.</p>\n<p>Note:&nbsp;Cushing ulcers&nbsp;arise in individuals with intracranial disease. They occur in the stomach, duodenum,&nbsp;and esophagus and carry a high incidence of perforation. They occur due to gastric acid hypersecretion from direct vagal nerve stimulation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 42-year-old man is brought to the emergency room with complaints of severe abdominal pain. On examination, his vitals are stable and there is abdominal rigidity and tenderness. The erect X-ray of the abdomen is suggestive of pneumoperitoneum and the patient is posted for emergency laparotomy. It reveals the presence of a perforated type I gastric ulcer. How will you manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Perform distal gastrectomy with Billroth I anastomosis"
      },
      {
        "id": 2,
        "text": "Closure of the perforation with Graham's patch repair"
      },
      {
        "id": 3,
        "text": "Perform truncal vagotomy and antrectomy"
      },
      {
        "id": 4,
        "text": "Perform truncal vagotomy with gastrojejunostomy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In <strong>stable</strong> <strong>patients</strong> without operative risks, Perforated type I gastric ulcers are best managed by <strong>distal gastrectomy with Billroth I anastomosis</strong> (with or without vagotomy).&nbsp; &nbsp; &nbsp; &nbsp;</p>\n<p>If the patient is hemodynamically <strong>unstable</strong> or <strong>unfit</strong> for surgery, <strong>simple</strong> <strong>patch</strong> <strong>repair</strong> <strong>with</strong> <strong>biopsy</strong>&nbsp;preferred.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p>\n<table style=\"height: 192px;\" width=\"483\">\n<tbody>\n<tr style=\"height: 14.0625px;\">\n<td style=\"width: 233.5px; height: 14.0625px;\">Type of Gastric Ulcer</td>\n<td style=\"width: 233.5px; height: 14.0625px;\">Management</td>\n</tr>\n<tr style=\"height: 61px;\">\n<td style=\"width: 233.5px; height: 61px;\">Type I&nbsp;</td>\n<td style=\"width: 233.5px; height: 61px;\">Distal gastrectomy&nbsp;</td>\n</tr>\n<tr style=\"height: 61px;\">\n<td style=\"width: 233.5px; height: 61px;\">&nbsp;Type II and III</td>\n<td style=\"width: 233.5px; height: 61px;\">Distal gastrectomy + Vagotomy</td>\n</tr>\n<tr style=\"height: 61px;\">\n<td style=\"width: 233.5px; height: 61px;\">&nbsp;Type IV</td>\n<td style=\"width: 233.5px; height: 61px;\">\n<p>&nbsp;</p>\n<p>&nbsp;Csendes procedure</p>\n<p>&nbsp;or</p>\n<p>&nbsp;Pauchet procedure</p>\n<p>&nbsp;or</p>\n<p>&nbsp;Kelling - Madlener procedure</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Kelling-Madlener procedure is done for _____",
    "choices": [
      {
        "id": 1,
        "text": "Type lll gastric ulcer"
      },
      {
        "id": 2,
        "text": "Type lV gastric ulcer"
      },
      {
        "id": 3,
        "text": "Type l gastric ulcer"
      },
      {
        "id": 4,
        "text": "Type ll gastric ulcer"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>Kelling-Madlener</strong> procedure is done for <strong>type lV Gastric ulcers.</strong></p>\n<p>Surgical management of type lV gastric ulcer</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Kelling-Madlener procedure</strong> - involves antrectomy and excision of gastric ulcer.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Pauchet&rsquo;s procedure</strong> - involves distal gastrectomy with a selective sleeve-like extension to the lesser curvature to remove the ulcer.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Csendes Procedure</strong>- subtotal gastrectomy with sleeve-like extension to the lesser curvature.</li>\n</ul>\n<p><br />Management of gastric ulcer</p>\n<table>\n<tbody>\n<tr>\n<td>Types of gastric ulcer</td>\n<td>Management</td>\n</tr>\n<tr>\n<td>Type l</td>\n<td>Distal gastrectomy</td>\n</tr>\n<tr>\n<td>Type ll &amp; lll</td>\n<td>Distal gastrectomy + Vagotomy</td>\n</tr>\n<tr>\n<td>Type lV</td>\n<td>\n<p>Pauchet&rsquo;s procedure <br />Or<br />Kelling-Madlener&rsquo;s procedure <br />Or &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />Csendes procedure</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b9909cf0bce442499d3fc6d6f61fee51x1280x2825.JPEG"
    ]
  },
  {
    "text": "A 25-year-old man on SSRI presented with hematemesis and abdominal pain. An endoscopy was performed immediately which showed an actively bleeding ulcer of size 2cm in the posterior wall of the duodenum. What is the next best step in the management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Electrocoagulation"
      },
      {
        "id": 2,
        "text": "Graham\u2019s patch repair"
      },
      {
        "id": 3,
        "text": "Duodenostomy"
      },
      {
        "id": 4,
        "text": "PPI + endoscopic monitoring"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The next best step to manage the above scenario is <strong>endoscopic electrocoagulation.</strong></p>\n<p><strong>Management of bleeding peptic ulcer</strong></p>\n<p>For actively bleeding ulcers or non-bleeding visible vessels,</p>\n<ul>\n<li><strong>Endoscopic therapy </strong>with a<strong> combination of epinephrine injection and electrocoagulation </strong>is done<strong>. </strong>Surgery is done only when 2 attempts of endoscopic therapy fail.</li>\n<li><strong>Surgical</strong> management includes <strong>duodenostomy</strong> and under-running of the vessel.&nbsp;<span style=\"font-size: 14px;\">Duodenal ulcers also show a good response to </span><strong style=\"font-size: 14px;\">acid-reducing surgery</strong><span style=\"font-size: 14px;\"> or vagotomy.</span></li>\n</ul>\n<p>&nbsp;Medical management includes PPIs and H.pylori eradication therapy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the preferred approach for treating a patient who has a duodenal ulcer with a perforation of 2.5cm?",
    "choices": [
      {
        "id": 1,
        "text": "Primary closure and buttress with well-vascularised omentum"
      },
      {
        "id": 2,
        "text": "Graham patch repair"
      },
      {
        "id": 3,
        "text": "Closure of defect and gastrojejunostomy"
      },
      {
        "id": 4,
        "text": "Managed conservatively"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The preferred treatment of perforations between&nbsp;1&ndash;3 cm in size is a <strong>Graham patch repair.</strong></p>\n<p>Treatment of<strong> perforated duodenal ulcer:</strong></p>\n<ul>\n<li>&lt;1 cm: Primary closure + buttress with well-vascularised omentum</li>\n<li>1&ndash;3 cm: Graham patch repair</li>\n<li>&gt;3 cm: Closure of defect using omentum or jejunal serosa + pyloric exclusion + gastrojejunostomy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false about the type of vagotomy shown in the image below?",
    "choices": [
      {
        "id": 1,
        "text": "Ulcer recurrence rate is highest"
      },
      {
        "id": 2,
        "text": "Acid reduction is maximum"
      },
      {
        "id": 3,
        "text": "Nerve of Latarjet is spared"
      },
      {
        "id": 4,
        "text": "Postoperative complications are minimum"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The picture depicts <strong>Highly Selective Vagotomy (HSV).&nbsp;</strong>Post-procedure<strong> acid reduction is minimum in HSV.</strong></p>\n<p>It involves resection of <strong>crowfoot branches</strong>, 6cm from the gastroesophageal junction but stopped 7cm from the pylorus.&nbsp;The<strong> nerve of Latarjet</strong> from the anterior and posterior vagal trunk supplies the acid pepsin areas of the stomach. It is<strong>&nbsp;spared</strong>&nbsp;in HSV.<strong>&nbsp;</strong>Usually, the motor branch to the pylorus is also preserved.</p>\n<p><strong>There are 3 types of vagotomy</strong></p>\n<ol>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Highly selective vagotomy</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Truncal vagotomy + gastrojejunostomy&nbsp;</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Truncal vagotomy + antrectomy.</li>\n</ol>\n<p><strong>Highly selective vagotomy</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Acid reduction is minimum.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Highest ulcer recurrence rate.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Minimum postoperative complications.</li>\n</ul>\n<p><strong>Truncal vagotomy + antrectomy</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Acid reduction is maximum.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Least ulcer recurrence rate.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Maximum postoperative complications.</li>\n</ul>\n<p>Note: Vagal nerves are motor to the stomach and denervation of the antro-pyloro-duodenal segment results in&nbsp;<strong>gastric stasis</strong>&nbsp;after truncal vagotomy. Hence, a drainage procedure, most commonly&nbsp;<strong>Heineke&ndash;Mikulicz pyloroplasty</strong>&nbsp;or gastrojejunostomy is done along with vagotomy.</p>\n<p><strong>The criminal nerve of Grassi</strong>&nbsp;is a branch of the posterior vagal trunk that arises at the gastroesophageal junction and supplies the fundus of the stomach.&nbsp;It is called a&nbsp;criminal nerve<strong>&nbsp;</strong>because it is often&nbsp;<strong>missed during vagotomy</strong>&nbsp;procedures and can result in&nbsp;<strong>recurrent peptic ulcer&nbsp;</strong>disease.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9c898d7b23364d779b4f80fee2dbc354.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/29d0ec5ab8fc4871bcba4d71ccb78005x1280x1723.JPEG"
    ]
  },
  {
    "text": "Identify the surgical procedure shown below.",
    "choices": [
      {
        "id": 1,
        "text": "Billroth I gastrectomy"
      },
      {
        "id": 2,
        "text": "Billroth II gastrectomy"
      },
      {
        "id": 3,
        "text": "Braun\u2019s modification of Billroth II"
      },
      {
        "id": 4,
        "text": "Roux-en Y gastrojejunostomy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The procedure illustrated in the image is <strong>Billroth II gastrectomy.</strong> Following resection, the distal end of the stomach is narrowed by the closure of the lesser curve aspect of the remnant. The greater curve aspect is then anastomosed, usually in a retro-colic fashion, to the jejunum.</p>\n<p>Option A: In <strong>Billroth I gastrectomy</strong>,&nbsp;the lower half of the stomach is removed, and the cut end of the stomach is anastomosed to the first part of the duodenum.</p>\n<p>Option C: <strong>Braun modification of classical Billroth II gastrectomy</strong> is Billroth II reconstruction with jejunojejunostomy.</p>\n<p>Option D: <strong>Roux-en Y gastrojejunostomy</strong> is a gastric bypass surgery where a loop of jejunum is anastomosed to a proximal gastric pouch.&nbsp;</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1869101514a04bbd89e6890cd1479c72.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1143f3067e434895aaf820bafe96209bx1280x5287.JPEG"
    ]
  },
  {
    "text": "A 40-year-old man presents to the ER with severe abdominal pain. Guarding is present on per abdomen examination. HR is 110bpm and BP is 88/60mmHg. Erect abdominal X-ray is shown below. Which of the following would you proceed with, for managing this case?",
    "choices": [
      {
        "id": 1,
        "text": "2,3"
      },
      {
        "id": 2,
        "text": "1,4"
      },
      {
        "id": 3,
        "text": "3,4,5"
      },
      {
        "id": 4,
        "text": "1,2,5"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario and erect X-ray abdomen showing&nbsp;<strong>gas under the diaphragm (pneumoperitoneum)&nbsp;</strong>is suggestive of gastrointestinal&nbsp;<strong>perforation.&nbsp;</strong>It is managed by initial resuscitation with IV fluids followed by exploratory laparotomy. It is a surgical emergency.</p>\n<p>Management includes:</p>\n<ul>\n<li>Adequate preoperative resuscitation with <strong>intravenous fluids</strong> followed by correction of electrolyte imbalance, instituting broad-spectrum intravenous antibiotics and</li>\n<li>Early surgical <strong>intervention/laparotomy</strong> to address the cause for pneumoperitoneum and stop further contamination of the peritoneal cavity.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/66a399549d934c2db9263a61dd812fb5.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 54-year-old man presented with acute onset of abdominal pain, fever, and vomiting. Examination revealed tenderness over the right iliac fossa. USG showed gas around the right kidney. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Appendicitis"
      },
      {
        "id": 2,
        "text": "Perforated duodenal ulcer"
      },
      {
        "id": 3,
        "text": "Cholecystitis"
      },
      {
        "id": 4,
        "text": "Pancreatitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of <strong>pneumoretroperitoneum</strong> caused by a <strong>perforated</strong> <strong>duodenal</strong> <strong>ulcer</strong>.</p>\n<p><strong>Posterior</strong> <strong>duodenal</strong> <strong>ulcer</strong> perforates into the retroperitoneum, and the contents leak through the <strong>right paracolic gutter</strong> into the right iliac fossa, <strong>mimicking</strong> <strong>appendicitis</strong>. This is called <strong>Valentino</strong> <strong>syndrome</strong>.</p>\n<p>On USG, gas can be seen around the right kidney known as the&nbsp;<strong>renal veil sign</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old actress who underwent Roux-en-Y gastric bypass surgery for obesity, presents with complaints of sweating, palpitations, epigastric fullness, and loose stools which start immediately after meals. Which of the following would you not associate with her condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is precipitated by carbohydrate rich food."
      },
      {
        "id": 2,
        "text": "It is more common after partial gastrectomy with the Billroth II reconstruction."
      },
      {
        "id": 3,
        "text": "It results in hypoglycemia."
      },
      {
        "id": 4,
        "text": "It is relieved by lying down."
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The clinical scenario is suggestive of <strong>early dumping syndrome</strong>. Hypoglycemia\u200b does not occur in early dumping syndrome. <strong>Hypoglycemia</strong> is seen in <strong>late dumping syndrome</strong> secondary to raised insulin levels.</p>\n<p>Dumping syndrome is a complication occurring post gastrectomy. It can be early or late.</p>\n<p><strong>Early dumping syndrome</strong> is due to the <strong>high osmotic load</strong> that reaches the small bowel, leading to sequestration of fluid from the circulation into the gastrointestinal tract (GIT). This fluid shift induces <strong>autonomic responses</strong>.\u00a0It is characterized by more GI and fewer cardiovascular effects such as:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Epigastric fullness</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Sweating</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Lightheadedness</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Tachycardia</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Diarrhea</li>\n</ul>\n<p>Symptoms are <strong>aggravated by having more food</strong> and relieved by lying down.</p>\n<p><strong>Late dumping syndrome</strong> is due to an <strong>increase in insulin levels</strong> and secondary hypoglycemia. This hypoglycemia causes a catecholamine surge, which results in predominantly cardiovascular effects such as:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Diaphoresis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Tremulousness</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Light-headedness</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Tachycardia</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Confusion</li>\n</ul>\n<p>The symptoms are aggravated by exercise and <strong>relieved by having food</strong>.</p>\n<p>The principal treatment for both types of dumping syndrome is <strong>dietary manipulation</strong>. Meals based on fat and protein are known to work the best. <strong>Octreotide</strong> before meals is useful.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented to the casualty with severe upper abdominal pain and recurrent retching with minimal vomiting. A nasogastric tube insertion was tried but it was unsuccessful. A chest X-ray showed diffuse distension of bowel loops and a left-sided diaphragmatic defect. Which of the following statements regarding this condition is false?",
    "choices": [
      {
        "id": 1,
        "text": "Mesenteroaxial type is more common"
      },
      {
        "id": 2,
        "text": "Organoaxial type is associated with a diaphragmatic defect"
      },
      {
        "id": 3,
        "text": "Surgery is performed through a transabdominal approach"
      },
      {
        "id": 4,
        "text": "Borchardt triad is seen"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>Borchardt triad</strong>&nbsp;is seen in gastric volvulus:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Sudden-onset severe upper abdominal pain</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Recurrent retching with production of little vomitus</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Inability to pass a nasogastric (NG) tube</li>\n</ul>\n<p>Management involves <strong>reduction and uncoiling of the stomach</strong> through a transabdominal approach.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/296772ab24de4fa28f3680b3a90730a3x339x480.PNG"
    ]
  },
  {
    "text": "A 40-year-old male presented to the OPD with complaints of abdominal pain, diarrhea, loss of appetite, and loss of weight. On examination, the patient had peripheral edema and ascites. Laboratory studies showed decreased serum albumin but normal serum levels of transaminases and gastrin. Upper GI endoscopy showed the following appearance of the stomach. Which of the following is true about the condition?",
    "choices": [
      {
        "id": 1,
        "text": "No malignant potential"
      },
      {
        "id": 2,
        "text": "Gastrectomy is the treatment of choice in severe cases"
      },
      {
        "id": 3,
        "text": "Caused by overexpression of TNF alpha"
      },
      {
        "id": 4,
        "text": "Characterized by hyperchlorhydria"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Cetuximab</strong>, an EGFR inhibitory antibody, is now considered the <strong>first-line treatment</strong> for Menetrier's disease, leaving <strong>total gastrectomy</strong> for <strong>severe disease</strong> with persistent and substantial protein loss refractory to cetuximab.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/21bc495a5403445fb1d1e25d0f46c19a.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/39baee5e43484a74af07c6d6ed580a1fx800x533.JPEG"
    ]
  }
];
        let quizName = '18 Stomach And Duodenum';
        const quizFilename = '18-stomach-and-duodenum-0294c549.html';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>