<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>02 Disorders Of Newborn - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pediatrics
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">19</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A male infant born at 34 weeks of gestation by emergency LSCS was found to have the following finding on histopathological examination of his umbilical cord. Anomalies of which of the following systems are most likely to be found in this infant?",
    "choices": [
      {
        "id": 1,
        "text": "Renal system"
      },
      {
        "id": 2,
        "text": "Central nervous system"
      },
      {
        "id": 3,
        "text": "Gastro-intestinal system"
      },
      {
        "id": 4,
        "text": "Endocrine system"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>normal umbilical cord</strong> contains <strong>2 arteries</strong> and <strong>1 vein</strong>. A single umbilical artery is the <strong>most common cord abnormality</strong>. Anomalies are seen in <strong>30% of cases</strong> with a single umbilical artery. The incidence is <strong>higher</strong> in <strong>twin deliveries</strong>.</p>\n<p><strong>Trisomy 18</strong> is a common association.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5a420f2e6e164a8896b87fcd0a1cadc3.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/10827f5c9c9c4555b6b49ad310524ff4x1280x1530.0423131170662.JPEG"
    ]
  },
  {
    "text": "On a particularly busy day in the labor room, you are requested by the PG to take anthropometric measurements and calculate the ponderal index of a baby while she attends to another baby. You find the ponderal index to be 1.45. Which of the following organs is unlikely to be affected in this neonate?",
    "choices": [
      {
        "id": 1,
        "text": "Subcutaneous fat"
      },
      {
        "id": 2,
        "text": "Muscle"
      },
      {
        "id": 3,
        "text": "Liver"
      },
      {
        "id": 4,
        "text": "Brain"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>A <strong>ponderal index</strong> of <strong>&lt;2</strong>\u00a0suggests asymmetric intrauterine growth restriction.\u00a0<strong>Asymmetric</strong>\u00a0<strong>IUGR</strong>\u00a0is associated with a<strong> brain-sparing effect,</strong> unlike symmetric IUGR, where there is no sparing of head growth.</p>\n<p>Ponderal index = Birth weight (gm)/Length (cm)<sup>3</sup>\u00a0x 100.</p>\n<p>It is a <strong>weight-height</strong>-related parameter used as an\u00a0indicator of<strong> fetal growth status</strong>.</p>\n<table style=\"height: 400px;\" width=\"468\">\n<tbody>\n<tr style=\"height: 19.6562px;\">\n<td style=\"width: 227.344px; text-align: center; height: 19.6562px;\"><strong>Symmetric</strong> <strong>IUGR </strong></td>\n<td style=\"width: 224.656px; text-align: center; height: 19.6562px;\"><strong>Asymmetric IUGR</strong></td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 227.344px; height: 18px;\">Insult on fetal growth occurs <strong>early</strong></td>\n<td style=\"width: 224.656px; height: 18px;\">Insult occurs in <strong>late gestation</strong></td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 227.344px; height: 18px;\">Head circumference, length, and weight are\u00a0<strong>equally</strong> affected</td>\n<td style=\"width: 224.656px; height: 18px;\">Relative <strong>sparing</strong> of<strong>\u00a0brain growth</strong></td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 227.344px; height: 18px;\">A ponderal index <strong>greater than</strong> <strong>or equal to</strong>\u00a0<strong>2\u00a0</strong></td>\n<td style=\"width: 224.656px; height: 18px;\">A ponderal index\u00a0<strong>less than 2</strong>\u00a0</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 227.344px; height: 18px;\">Caused by\u00a0genetic, chromosomal disorders, or TORCH infections</td>\n<td style=\"width: 224.656px; height: 18px;\">Caused by placental insufficiency, pregnancy-induced hypertension, or maternal medical diseases</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The ponderal index of a term baby delivered by elective cesarean section is 1.75. Which of the following is unlikely to be associated?",
    "choices": [
      {
        "id": 1,
        "text": "Gestational diabetes"
      },
      {
        "id": 2,
        "text": "Diabetes with vasculopathy"
      },
      {
        "id": 3,
        "text": "Hypertension"
      },
      {
        "id": 4,
        "text": "Sickle cell anemia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A ponderal index of 1.75 suggests <strong>intrauterine growth restriction.</strong>&nbsp;<strong>Gestational diabetes</strong>&nbsp;usually presents with<strong> fetal macrosomia.</strong></p>\n<p><strong>Maternal factors</strong> associated with intrauterine growth restriction <strong>(IUGR)</strong>:&nbsp;</p>\n<ul>\n<li>Hypertension/renal disease</li>\n<li><strong>Diabetes with placental vasculopathy</strong></li>\n<li>Hypoxemia</li>\n<li>Malnutrition</li>\n<li>Chronic illness</li>\n<li>Sickle cell anemia</li>\n<li>Drugs (narcotics, <strong>alcohol, cigarettes</strong>, cocaine)</li>\n<li>Maternal infection and parasite infestations</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An unbooked primigravida, with no antenatal records, delivers a 2.5kg male baby by normal delivery. While ascertaining the maturity of the child, which of the following would be against a diagnosis of prematurity?",
    "choices": [
      {
        "id": 1,
        "text": "No creases on sole"
      },
      {
        "id": 2,
        "text": "Insignificant breast nodule"
      },
      {
        "id": 3,
        "text": "Thick ear cartilage"
      },
      {
        "id": 4,
        "text": "Empty scrotum"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><span data-token-index=\"0\" data-reactroot=\"\"><strong>Thick cartilage</strong></span> with a<span data-token-index=\"2\" data-reactroot=\"\"> <strong>stiff ear</strong></span> in a newborn is a sign of <strong>maturity</strong> (not prematurity).</p>\n<table>\n<tbody>\n<tr>\n<td style=\"text-align: center;\"><strong>Score</strong></td>\n<td style=\"text-align: center;\"><strong>Ear</strong></td>\n</tr>\n<tr>\n<td>0</td>\n<td>Pinna flat and stays folded; no recoil</td>\n</tr>\n<tr>\n<td>1</td>\n<td>Slightly curved pinna; soft; slow recoil</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Well-curved pinna; soft but ready recoil</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Formed &amp; firm, instant recoil</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Thick cartilage, ear stiff</td>\n</tr>\n</tbody>\n</table>\n<p>No creases on the sole, insignificant breast nodule, and empty scrotum are all physical signs of prematurity in a newborn.</p>\n<p>Note:</p>\n<p>Abundant lanugo hair is not discriminatory evidence of prematurity. This is because neonates of diabetic mothers born as a term or even post-term have abundant lanugo hair, especially over the pinna and upper back.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7149845493384a3e8793e0ac4363ff1ax1280x1758.420310296192.JPEG"
    ]
  },
  {
    "text": "A lady with wrong dates and a corrected gestational age of 43 weeks presents with labor pains. The CTG suggests placental insufficiency, and she is taken up for emergency LSCS. Which of the following physical signs is unlikely to be seen in this neonate?",
    "choices": [
      {
        "id": 1,
        "text": "Long nails"
      },
      {
        "id": 2,
        "text": "Pale skin"
      },
      {
        "id": 3,
        "text": "Alert faces"
      },
      {
        "id": 4,
        "text": "Scanty hair"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The physical sign of an infant born <strong>post-term</strong> (43 weeks) in association with presumed <strong>placental insufficiency</strong> is&nbsp;<strong>abundant hair</strong>&nbsp;(not scanty hair).</p>\n<p>Infants born post-term in association with presumed placental insufficiency may have various physical signs, together termed as&nbsp;<strong>postmaturity syndrome</strong>&nbsp;(or <strong>dysmaturity syndrome</strong>).</p>\n<p>These include:</p>\n<ol>\n<li>Desquamation, pale skin, and long nails.</li>\n<li>Loose skin around the thighs and buttocks.</li>\n<li>Meconium-stained nails, skin, vernix, and umbilical cord.</li>\n<li>Presence of placental membranes.</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 34-year-old lady with an obstetric score of G3P2L2 delivers a baby boy at 43 weeks + 2 days period of gestation. Which of the following are unlikely to be associated in the given scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Anemia"
      },
      {
        "id": 2,
        "text": "Hypocalcemia"
      },
      {
        "id": 3,
        "text": "Meconium aspiration"
      },
      {
        "id": 4,
        "text": "Persistent pulmonary hypertension"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Anemia</strong>&nbsp;is not a complication of post-maturity. <strong>Polycythemia</strong> may be seen in neonates born after 42 weeks of gestation.</p>\n<p><strong>Complications</strong> of post-maturity include:</p>\n<ol>\n<li>Perinatal depression</li>\n<li><strong>Meconium aspiration</strong></li>\n<li><strong>Persistent pulmonary hypertension</strong></li>\n<li>Hypoglycemia</li>\n<li><strong>Hypocalcemia</strong></li>\n<li>Polycythemia</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Immediately following vaginal delivery, a baby is noted to have a diffuse ecchymotic swelling on the scalp. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Cephalohematoma"
      },
      {
        "id": 2,
        "text": "Caput succedaneum"
      },
      {
        "id": 3,
        "text": "Subgaleal hemorrhage"
      },
      {
        "id": 4,
        "text": "Epidural hematoma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most likely</strong> diagnosis is caput succedaneum.</p>\n<p><strong>Caput succedaneum</strong>&nbsp;is a diffuse,&nbsp;sometimes ecchymotic, edematous collection of serosanguinous fluid in the subcutaneous layer of the scalp, involving the presenting part in a vertex delivery.&nbsp;It may extend across the midline and <strong>crosses suture lines.</strong></p>\n<p>Option A: <strong>Cephalohematoma</strong> is a&nbsp;<strong>subperiosteal hemorrhage</strong>&nbsp;that is always&nbsp;<strong>limited</strong>&nbsp;to the&nbsp;surface of 1 cranial bone&nbsp;and&nbsp;does not cross suture lines.&nbsp;The swelling appears only&nbsp;<strong>several hours after birth.</strong>&nbsp;There is&nbsp;<strong>no discoloration</strong>&nbsp;of the overlying scalp.</p>\n<p>Option C: <strong>Subgaleal</strong> hemorrhages occur with the rupture of&nbsp;<strong>emissary veins</strong>, which connect the dural sinuses with the superficial veins of the scalp. Blood accumulates&nbsp;<strong>between the epicranial aponeurosis of the scalp and the periosteum</strong>&nbsp;and resolves over 2-3 weeks. Often associated with vacuum-assisted delivery.</p>\n<p>Option D: <strong>Epidural</strong> hemorrhages,<strong>&nbsp;</strong>usually <strong>traumatic</strong> in origin, are associated with cephalo-pelvic disproportion, prolonged labor, breech, precipitous labors, or occur as a result of mechanical assistance in labor. Majority resolve with no intervention.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f4ffc8ae42f0403eafd900279644393cx1280x1035.2011291460833.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a feature of marking B?",
    "choices": [
      {
        "id": 1,
        "text": "Swelling of the soft tissues of the scalp"
      },
      {
        "id": 2,
        "text": "Does not cross suture lines"
      },
      {
        "id": 3,
        "text": "Resorbed within 2 weeks to 3 months"
      },
      {
        "id": 4,
        "text": "Appears only several hours after birth"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>&nbsp;</p>\n<p>Other markings-</p>\n<p>A- Caput succedaneum. It is a diffuse ecchymotic or edematous collection in the soft tissues of the scalp with vertex presentation. It can extend across skull sutures and disappears with the first week of life.</p>\n<p>C- Sub-galeal hemorrhage. This a collection of blood under the aponeurosis of the scalp. It is a large potential space, thus bleeding can be extensive. It occurs as a result of ventouse deliveries due to tears of the emissary veins which connect to the dural venous sinuses. It can also occur in hereditary coagulopathies and in association with skull fractures.</p>\n<p>D- Epidural hemorrhage. Usually traumatic in origin, these are associated with cephalo-pelvic disproportion, prolonged labor, breech, precipitous labors, or as a result of mechanical assistance in labor. Majority resolve with no intervention.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/cef898ca57c841f9b14f311a5aec1c6d.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3417712db30f498780cd3e1a4d88fac0x1280x1035.2011291460833.JPEG"
    ]
  },
  {
    "text": "A baby in the postnatal ward is noted to have paralysis of the left hand along with ipsilateral ptosis and miosis. What is the most likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Erb-Duchenne paralysis"
      },
      {
        "id": 2,
        "text": "Phrenic nerve palsy"
      },
      {
        "id": 3,
        "text": "Horner syndrome"
      },
      {
        "id": 4,
        "text": "Klumpke's paralysis associated with Horner syndrome"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Left-hand paralysis</strong> with <strong>ipsilateral ptosis</strong> and <strong>miosis</strong> in a newborn suggests a diagnosis of <strong>Klumpke's paralysis</strong> associated with <strong>Horner syndrome.</strong></p>\n<p>There is an injury to the&nbsp;<strong>7th-8th&nbsp;cervical nerves and the 1st&nbsp;thoracic nerve.</strong> This produces a&nbsp;<strong>paralyzed hand</strong>&nbsp;where the intrinsic muscles of the hand (T1) and the ulnar flexors of the wrist and fingers (C8) are mainly affected, and the baby lies with the&nbsp;<strong>forearm supinated</strong>&nbsp;and the&nbsp;<strong>elbow flexed.</strong> There may be a&nbsp;<strong>unilateral Horner&rsquo;s syndrome,</strong> characterized by ipsilateral ptosis and miosis if the sympathetic fibers of the 1&nbsp;thoracic root are also injured.</p>\n<p>Option A: Erb&ndash;Duchenne paralysis affects the 5th and 6th cervical nerves. There is loss of abduction of the shoulder, external rotation, and supination. Moro's reflex is absent on the affected side.</p>\n<p>Option B: Phrenic nerve palsy (3, 4, and 5&nbsp;cervical nerves) results in diaphragmatic paralysis. It is characterized by cyanosis and irregular and labored breathing.</p>\n<p>Option C: Horner's syndrome&nbsp;is characterized by&nbsp;miosis, ptosis, enophthalmos, anhydrosis,&nbsp;and loss of ciliospinal reflex.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6ee83561856b4296b866beeba305d208x702x315.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7a244a635dcc49b1ab72c983b570f513x1280x1954.JPEG"
    ]
  },
  {
    "text": "Following a delivery complicated by shoulder dystocia, the baby is noted to have a deformity in the right upper limb. On inspection, the orthopedics JR notes an adducted, internally rotated arm and a pronated forearm. Which nerve roots are affected here?",
    "choices": [
      {
        "id": 1,
        "text": "Only C5"
      },
      {
        "id": 2,
        "text": "C5 and C6"
      },
      {
        "id": 3,
        "text": "C6 and C7"
      },
      {
        "id": 4,
        "text": "C7 and C8"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The clinical vignette suggests a diagnosis of&nbsp;<span data-token-index=\"1\" data-reactroot=\"\"><strong>Erb&ndash;Duchenne paralysis.</strong> T</span>he injury is limited to the&nbsp;<span data-token-index=\"3\" data-reactroot=\"\"><strong>5th</strong>&nbsp;and <strong>6th</strong>&nbsp;</span><strong>cervical nerve roots.</strong></p>\n<p>The characteristic position consists of&nbsp;<span data-token-index=\"5\" data-reactroot=\"\"><strong>adduction</strong> and <strong>internal rotation</strong> of the arm with <strong>pronation</strong> of the <strong>forearm.</strong> </span>There is <span data-token-index=\"7\" data-reactroot=\"\">loss </span>of <span data-token-index=\"9\" data-reactroot=\"\">abduction</span> of the shoulder, <span data-token-index=\"11\" data-reactroot=\"\">external rotation</span>, and <span data-token-index=\"13\" data-reactroot=\"\">supination</span>.</p>\n<p>There is an <span data-token-index=\"15\" data-reactroot=\"\"><strong>asymmetric Moro's</strong> Reflex</span></p>\n<p>Note: <br />In shoulder dystocia, the most common nerve injury is to the C5-6 nerve root. The most common bone to fracture is the clavicle.&nbsp;<br /><br /><br /></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/77da5732704845158990986f3c103626x600x450.JPEG"
    ]
  },
  {
    "text": "A term infant develops jaundice at day 2 of life. It first appeared on the sclera and progressed to the trunk by day 4. It completely disappeared by day 7 following phototherapy. Which of the following statements is false regarding the cause of this pattern of jaundice?",
    "choices": [
      {
        "id": 1,
        "text": "Due to a rise in unconjugated bilirubin"
      },
      {
        "id": 2,
        "text": "Due to limitation in the conjugation of bilirubin by the immature neonatal liver"
      },
      {
        "id": 3,
        "text": "Due to Rh incompatibility between maternal and fetal red blood cells"
      },
      {
        "id": 4,
        "text": "Due to increased breakdown of fetal red blood cells"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>&nbsp;</p>\n<p><strong>Note</strong>:&nbsp;&nbsp;</p>\n<p><strong>Depth of jaundice</strong>&nbsp;(degree of yellowness) should be carefully noted (light staining as lemon-yellow; deep staining as orange-yellow), as it is an important indicator of the level of jaundice. Earlier, the involvement of soles and palms indicated severe jaundice but&nbsp;<strong>deep yellow staining (even in absence of yellow soles or palms)</strong>&nbsp;may be associated with severe jaundice.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f6d634be7dbe4413b8d6b92919ff018bx1280x1232.JPEG"
    ]
  },
  {
    "text": "A male infant with a birth weight of 3.2 Kg is admitted to the phototherapy unit with a total bilirubin of 11mg/dl at 36 hours of life. Which of the following statements does not describe pathological jaundice?",
    "choices": [
      {
        "id": 1,
        "text": "Jaundice appears within first 24 hours after birth"
      },
      {
        "id": 2,
        "text": "Jaundice present at or beyond age 3 weeks"
      },
      {
        "id": 3,
        "text": "Jaundice associated with rise in bilirubin level at a rate of <5 mg/dl/24 hour"
      },
      {
        "id": 4,
        "text": "Jaundice seen in the mid-abdomen and soles"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Jaundice</strong> associated with a&nbsp;rise in bilirubin level at a rate of <strong>&lt;5 mg/dL/24 hours</strong>&nbsp;suggests <strong>physiological jaundice</strong>.</p>\n<p>Features suggestive of&nbsp;<strong>pathological jaundice:</strong></p>\n<ul>\n<li>Jaundice&nbsp;appears within the first 24 hours after birth</li>\n<li>Jaundice&nbsp;present at or beyond age 3 weeks&nbsp;or sick infant</li>\n<li>Elevated direct (or conjugated) bilirubin level</li>\n<li>Total serum bilirubin levels above the expected normal range;&nbsp;jaundice&nbsp;seen in the&nbsp;mid-abdominal region (&asymp; 15 mg/dL)&nbsp;and&nbsp;soles (&asymp; 20 mg/dL)</li>\n<li>Total serum bilirubin concentration not responding to phototherapy</li>\n<li>Total serum bilirubin rising rapidly (i.e., crossing percentiles) in an&nbsp;infant receiving phototherapy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The peripheral smear of a newborn baby girl sent on day 2 of life shows mild hemolysis. What is the most common cause of this finding in a newborn?",
    "choices": [
      {
        "id": 1,
        "text": "Rh incompatibility"
      },
      {
        "id": 2,
        "text": "ABO incompatibility"
      },
      {
        "id": 3,
        "text": "Kell antigen incompatibility"
      },
      {
        "id": 4,
        "text": "Hemolytic diseases due to infections"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>ABO incompatibility</strong> is the most common cause of hemolytic disease of newborns and affects the<strong> firstborn</strong>. It is usually <strong>mild</strong> and <strong>subclinical.</strong></p>\n<p>This incompatibility between the mother and fetus generally <strong>results in milder disease than Rh incompatibility does.&nbsp;</strong></p>\n<p>It arises when a&nbsp;<strong>mother </strong>with <strong>blood group type O</strong> becomes<strong> pregnant </strong>with a fetus of<strong> different blood type (A/B).</strong> The mother's serum contains naturally occurring anti-A and anti-B, which can cross the placenta and cause hemolysis of fetal RBCs.</p>\n<p>Although antibodies against A and B factors occur without previous immunization (natural antibodies), they are usually IgM, which do not cross the placenta. However, <strong>IgG</strong> antibodies to<strong> A antigen </strong>may be present, and these do<strong> cross</strong> the<strong> placenta,&nbsp;</strong>resulting in <strong>A-O iso-immune hemolytic disease</strong> in the&nbsp;first-born infant (A-O is more common than B-O).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 3.3 Kg term neonate is admitted on day 3 of life with yellowish discoloration of the skin and is going to undergo phototherapy. What is the most effective wavelength of light used for treatment?",
    "choices": [
      {
        "id": 1,
        "text": "370 to 390 nm"
      },
      {
        "id": 2,
        "text": "390 to 420 nm"
      },
      {
        "id": 3,
        "text": "460 to 490 nm"
      },
      {
        "id": 4,
        "text": "410 to 450 nm"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most effective range of <strong>wavelength of light</strong>\u00a0for phototherapy in <strong>neonatal indirect hyperbilirubinemia</strong> is <strong>460\u2013490 nm (blue-green light).</strong></p>\n<p>Clinical jaundice and indirect hyperbilirubinemia are reduced by exposure to the high intensity of light in the visible spectrum by 3 mechanisms:</p>\n<ul>\n<li><strong>Irreversible</strong>\u00a0<strong>structural isomerization:</strong>\u00a0Most\u00a0<strong>important</strong>\u00a0mechanism; acts by forming\u00a0<strong>lumirubin</strong>\u00a0from native bilirubin. It is then excreted by the\u00a0<strong>kidneys</strong>\u00a0in the unconjugated state.</li>\n<li><strong>Reversible photo-isomerization reaction:</strong>\u00a0converts toxic unconjugated bilirubin into an unconjugated configurational isomer. It is then excreted in\u00a0<strong>bile</strong>\u00a0without conjugation.</li>\n<li><strong>Photo-oxidation</strong>: minor method</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d08227b6a30a45cbac359d780696b8a7x1280x612.JPEG"
    ]
  },
  {
    "text": "A mother noticed yellowish discoloration of her term newborn within the first 6 hours of life. On examination, jaundice extended up to the lower abdomen and thighs. Which of the following drugs can be administered along with phototherapy?",
    "choices": [
      {
        "id": 1,
        "text": "Sn Mesoporphyrin"
      },
      {
        "id": 2,
        "text": "Tolazoline"
      },
      {
        "id": 3,
        "text": "Tromethamine"
      },
      {
        "id": 4,
        "text": "Sucrose"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Sn-mesoporphyrin (SnMP)</strong>,&nbsp;a synthetic&nbsp;<strong>metalloporphyrin</strong>&nbsp;is a potential alternative medical therapy for pathological jaundice in neonates.</p>\n<p>It acts by <strong>competitive inhibition</strong> of the&nbsp;<strong>conversion of heme protein to biliverdin</strong>&nbsp;by heme oxygenase. A single intramuscular dose on the 1st&nbsp;day of life reduces the need for subsequent phototherapy. <strong>Complication</strong>&nbsp;from metalloporphyrins includes&nbsp;<strong>transient erythema</strong>&nbsp;if the infant is receiving phototherapy.</p>\n<p><strong>Tolazoline</strong> is an&nbsp;alpha-adrenergic antagonist that produces systemic and pulmonary vasodilatation, which is used to&nbsp;<strong>correct pulmonary artery vasospasm</strong>&nbsp;when it causes severe right-left shunting soon after birth.</p>\n<p><strong>Tromethamine</strong>&nbsp;is an organic buffer used in the management of&nbsp;<strong>metabolic acidosis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While on rounds in the postnatal ward, the senior PG shows you a baby with dark, grayish-brown skin discoloration. It is a term, AGA baby on day 7 of life. She tells you that it is a case of bronze baby syndrome. This syndrome is caused by:",
    "choices": [
      {
        "id": 1,
        "text": "Phototherapy"
      },
      {
        "id": 2,
        "text": "Hemosiderosis"
      },
      {
        "id": 3,
        "text": "Vancomycin"
      },
      {
        "id": 4,
        "text": "Chloramphenicol"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The bronze baby syndrome is a&nbsp;<strong>dark, grayish-brown skin discoloration</strong> in infants undergoing<strong> phototherapy;</strong>&nbsp;it mainly occurs in infants with direct hyperbilirubinemia as an adverse effect of phototherapy.</p>\n<p>Despite the bronze baby syndrome, <strong>phototherapy</strong> <strong>can</strong> <strong>continue</strong> if needed.</p>\n<p><strong><span class=\"_Tgc _s8w\">Other complications of Phototherapy:&nbsp;</span></strong></p>\n<ol>\n<li><span class=\"_Tgc _s8w\">Loose stools</span></li>\n<li><span class=\"_Tgc _s8w\">Erythematous macular rash</span></li>\n<li><span class=\"_Tgc _s8w\">The purpuric rash associated with transient&nbsp;porphyrinemia</span></li>\n<li><span class=\"_Tgc _s8w\">Overheating</span></li>\n<li><span class=\"_Tgc _s8w\">Dehydration (increased insensible water&nbsp;loss, diarrhea)</span></li>\n<li><span class=\"_Tgc _s8w\">Hypothermia from exposure</span></li>\n</ol>\n<p><strong><span class=\"_Tgc _s8w\">Gray baby syndrome&nbsp;</span></strong><span class=\"_Tgc _s8w\">is an adverse effect of <strong>chloramphenicol.</strong>&nbsp;</span></p>\n<p><span class=\"_Tgc _s8w\"><strong>Redman syndrome&nbsp;</strong>is an adverse effect of <strong>vancomycin.</strong>&nbsp;</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 3.2 Kg term neonate born to a primigravida with gestational diabetes presented to the OPD with complaints of lethargy, hypotonia, and difficulty in feeding. Periodic monitoring of blood glucose is being done. What blood glucose levels indicate a need for the treatment of neonatal hypoglycemia?",
    "choices": [
      {
        "id": 1,
        "text": "< 45 mg/dL"
      },
      {
        "id": 2,
        "text": "< 40 mg/dL"
      },
      {
        "id": 3,
        "text": "<50 mg/dL"
      },
      {
        "id": 4,
        "text": "< 55 mg/dL"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The cut-off for the treatment of <strong>neonatal hypoglycemia </strong>to start IV glucose\u00a0is a blood glucose level of\u00a0<strong>&lt;40 mg/dL.</strong></p>\n<p>Neonatal hypoglycemia can be suspected when the blood glucose is <strong>&lt;45 mg/dL.</strong> Clinically in neonates, <strong>hypoglycemia</strong> can be <strong>asymptomatic</strong> or symptomatic. The neonate presents with tremors, cyanosis, <strong>convulsions</strong>, <strong>apneic spells</strong>, tachypnea, weak and high-pitched cry, <strong>lethargy</strong>,<strong> difficulty in feeding</strong>, episodes of sweating, sudden pallor, <strong>hypothermia</strong>, and rarely cardiac arrest.</p>\n<p>Management in <strong>symptomatic</strong> neonates:</p>\n<ul>\n<li>Blood glucose &lt;40mg/dL: IV glucose infusion</li>\n<li>Blood glucose &lt;25mg/dL: Bolus IV dextrose 1-2 mL/kg followed by infusion at the rate of 5-8mL/kg/min.</li>\n</ul>\n<p>Management in <strong>asymptomatic</strong> neonates:</p>\n<ul>\n<li>Breastfeeding within 30 minutes</li>\n<li>Start IV glucose therapy if blood glucose &lt;35 mg/dL</li>\n<li>Recheck blood glucose before the next feeding</li>\n<li>Continue skin-to-skin care</li>\n<li>Evaluation for other underlying illnesses</li>\n</ul>\n<p>The desired<strong> target glucose</strong> value is <strong>&gt;50mg/dL</strong> and blood glucose should be rechecked until<strong> three normal values</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "After the delivery of an infant of a diabetic mother, the blood glucose of the Infant was 60 mg/dl. Which other investigation would you do?",
    "choices": [
      {
        "id": 1,
        "text": "Serum potassium"
      },
      {
        "id": 2,
        "text": "Serum sodium"
      },
      {
        "id": 3,
        "text": "Serum chloride"
      },
      {
        "id": 4,
        "text": "Serum calcium"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In an <strong>infant of a diabetic mother</strong> with normal blood glucose levels, the next investigation to consider is <strong>serum calcium</strong> due to the high risk of developing <strong>hypocalcemia</strong>. Hypocalcemia in these infants is attributed to the <strong>delayed response of the parathyroid hormone system</strong>.\u00a0</p>\n<p><strong>Hypocalcemia</strong> is defined as a total serum calcium concentration of <strong>less than 8 mg/dL</strong> for a <strong>term</strong> baby (<strong>ionized calcium below 4mg/dL</strong>) and <strong>less than 7 mg/dL</strong> for a <strong>preterm</strong> baby. Asymptomatic neonates can be managed conservatively with early nutrition.<strong> Symptomatic neonates</strong> should receive <strong>iv or oral calcium</strong> replacement.\u00a0</p>\n<p><strong>Maternal hyperglycemia</strong> causes <strong>fetal hyperglycemia</strong>, and the fetal pancreatic response leads to <strong>fetal hyperinsulinemia</strong>, which causes neonatal<strong> hypoglycemia</strong>.\u00a0<strong>Neonatal hypoglycemia</strong> is defined as <strong>blood glucose &lt;40 mg/dL </strong>(plasma glucose &lt;45 mg/dL)<strong>.</strong>\u00a0The infant tends to be <strong>jittery</strong>, <strong>tremulous</strong>, hyperexcitable, hypotonic, <strong>lethargic</strong>, and<strong> poor sucking</strong> during the 1st three days after birth. These symptoms can also be related to <strong>hypocalcemia</strong> and <strong>hypomagnesemia</strong> which occur in the 1st 24 to 72 hours of life.\u00a0</p>\n<p><strong>Respiratory distress syndrome</strong>, <strong>macrosomia</strong>, hyperbilirubinemia, polycythemia, renal vein thrombosis,<strong> visceromegaly</strong>, heart failure, and persistent pulmonary hypertension are other features seen in infants of diabetic mothers.\u00a0</p>\n<p><strong>Congenital anomalies</strong> are seen in infants of mothers with pregestational diabetes. <strong>Neural tube defects</strong> (Encephalocele, meningomyelocele, anencephaly), transposition of great vessels (<strong>TGA</strong>), ventricular septal defect (<strong>VSD)</strong>, atrial septal defect (<strong>ASD</strong>), hypoplastic left heart, aortic stenosis and coarctation of the aorta are commonly seen.\u00a0</p>\n<p><strong>Caudal regression syndrome</strong> is rare, but a specific anomaly seen in infants of diabetic mothers. <strong>Small left colon syndrome</strong> is a rare anomaly that develops in the<strong> second</strong> and <strong>third</strong> trimesters.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 31-year-old lady with diabetes mellitus delivers a term neonate. Which of the following problems may be associated with the baby born to this lady?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2, 3"
      },
      {
        "id": 2,
        "text": "2, 3, 5"
      },
      {
        "id": 3,
        "text": "1, 4, 5"
      },
      {
        "id": 4,
        "text": "2, 3, 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Infants</strong> born to diabetic mothers may present with <strong>macrosomia</strong> (large for gestational age),<strong> hypocalcemia,</strong> and/ or<strong>\u00a0neural tube defects.</strong></p>\n<p>Other common features include:\u00a0</p>\n<ol>\n<li><strong>Hypoglycemia</strong></li>\n<li><strong>Respiratory distress syndrome</strong></li>\n<li><strong>Cardiomegaly</strong></li>\n<li>Heart failure</li>\n<li><strong>Lumbosacral agenesis</strong></li>\n<li>Cardiac malformations\n<ol style=\"list-style-type: lower-alpha;\">\n<li><strong>Ventricular or atrial septal defect</strong></li>\n<li><strong>Transposition of the great vessels (most specific)</strong></li>\n<li>Truncus arteriosus</li>\n<li>Double-outlet right ventricle</li>\n<li>Tricuspid atresia</li>\n<li>Coarctation of the aorta</li>\n</ol>\n</li>\n</ol>\n<p>Additional anomalies include <strong>neural tube defects</strong>, hydronephrosis, renal agenesis and dysplasia, duodenal or anorectal atresia, situs inversus, double ureter, and holoprosencephaly.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '02 Disorders Of Newborn';
        const quizFilename = '02-disorders-of-newborn-40027b3a.html';
        let hierarchy = ["Marrow", "qBank", "Pediatrics"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>