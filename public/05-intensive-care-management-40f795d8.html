<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05  Intensive Care Management - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        DAMS / DQB / Anesthesia
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">17</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "id": 50000,
    "choices": [
      {
        "id": 200000,
        "text": "CMV"
      },
      {
        "id": 200001,
        "text": "TENS"
      },
      {
        "id": 200002,
        "text": "CPAP"
      },
      {
        "id": 200003,
        "text": "SIMV"
      }
    ],
    "text": "All are modes of ventilation except",
    "unique_key": "Q7213337",
    "question_audio": null,
    "question_video": null,
    "map_id": 34655385,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) TENS Explanation for the Correct Answer: TENS (Transcutaneous Electrical Nerve Stimulation) is not a mode of ventilation. It is a therapeutic modality used to relieve pain by delivering electrical impulses through electrodes placed on the skin. TENS has no role in providing respiratory support or managing ventilation. This makes it the correct answer as it does not belong in a list of ventilation modes. Incorrect Options: A: CMV (Continuous Mandatory Ventilation) CMV is a mode of mechanical ventilation in which the ventilator delivers preset breaths at a fixed rate and volume, independent of the patient\u2019s efforts. It is commonly used in patients who require full respiratory support and have no spontaneous breathing activity. C: CPAP (Continuous Positive Airway Pressure) CPAP is a non-invasive mode of ventilation used primarily to maintain airway pressure and support spontaneous breathing in conditions like sleep apnea or respiratory failure. It does not provide breaths but helps keep the airways open. D: SIMV (Synchronized Intermittent Mandatory Ventilation) SIMV is a mode of ventilation that delivers mandatory breaths synchronized with the patient\u2019s spontaneous breathing efforts. It allows the patient to take their own breaths in between mandatory breaths, promoting gradual weaning from the ventilator.",
    "correct_choice_id": 200001,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/21794631698563490/21794631698563490.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/21794631698563490/21794631698563490.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50001,
    "choices": [
      {
        "id": 200004,
        "text": "Hypernatremia"
      },
      {
        "id": 200005,
        "text": "Hyponatremia"
      },
      {
        "id": 200006,
        "text": "Hyperkalemia"
      },
      {
        "id": 200007,
        "text": "Hypokalemia"
      }
    ],
    "text": "Central pontine mylenosis is seen with correction of",
    "unique_key": "Q5144286",
    "question_audio": null,
    "question_video": null,
    "map_id": 34205663,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Hyponatremia Central pontine myelinolysis (CPM) is a severe neurological condition that can occur when there is a rapid correction of hyponatremia (low sodium levels in the blood). The condition is characterized by the loss of myelin (the protective sheath covering nerve fibers) in the brainstem, particularly in the pons. When hyponatremia is corrected too quickly, especially with intravenous saline solutions, it can lead to osmotic shifts that cause damage to the myelin in the central pons, resulting in neurological symptoms like paralysis, dysarthria, and cognitive deficits. Therefore, rapid correction of hyponatremia is the correct answer as it is directly linked to CPM. Incorrect Options: A: Hypernatremia Hypernatremia (high sodium levels) is not typically associated with central pontine myelinolysis. Although the correction of hypernatremia should also be done cautiously to avoid complications like cerebral edema, it is hyponatremia, not hypernatremia, that is linked to the development of CPM. C: Hyperkalemia Hyperkalemia (elevated potassium levels) does not lead to central pontine myelinolysis. While hyperkalemia can cause serious issues such as cardiac arrhythmias and muscle weakness, it is not associated with the osmotic demyelination syndrome seen in CPM. D: Hypokalemia Hypokalemia (low potassium levels) also does not cause central pontine myelinolysis. While hypokalemia can affect muscle function and cause arrhythmias, it does not lead to the neurological damage seen in CPM. The rapid correction of potassium levels is not a known risk factor for this condition.",
    "correct_choice_id": 200005,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/58260631698563502/58260631698563502.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/58260631698563502/58260631698563502.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50002,
    "choices": [
      {
        "id": 200008,
        "text": "Resting CPK levels"
      },
      {
        "id": 200009,
        "text": "Ryanodine receptor identification"
      },
      {
        "id": 200010,
        "text": "Genetic testing"
      },
      {
        "id": 200011,
        "text": "Halothane-Caffeine contracture test"
      }
    ],
    "text": "Best diagnostic test for malignant hyperthermia:",
    "unique_key": "Q3420711",
    "question_audio": null,
    "question_video": null,
    "map_id": 34302474,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D)",
    "correct_choice_id": 200011,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/32032741698563518/32032741698563518.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/32032741698563518/32032741698563518.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50003,
    "choices": [
      {
        "id": 200012,
        "text": "Absence of pain perception"
      },
      {
        "id": 200013,
        "text": "Complete lack of pain sensation"
      },
      {
        "id": 200014,
        "text": "Unpleasant sensation with or without stimulus"
      },
      {
        "id": 200015,
        "text": "Perception of ordinary non-noxious stimulus as severe pain"
      }
    ],
    "text": "which of the following is the description used for the term allodynia during pain management",
    "unique_key": "Q3869802",
    "question_audio": null,
    "question_video": null,
    "map_id": 34193888,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Perception of ordinary non-noxious stimulus as severe pain Allodynia refers to the phenomenon where an individual experiences pain from stimuli that would not normally cause pain, such as light touch or gentle pressure. This condition occurs due to abnormal processing in the nervous system, often seen in neuropathic pain or after nerve injury. For example, a light touch on the skin that would usually be harmless can be perceived as severe pain, making ordinary sensations feel much more intense. This is the defining characteristic of allodynia. Incorrect Options: A: Absence of pain perception The absence of pain perception refers to analgesia, where the individual is unable to perceive any pain. This is not related to allodynia, which specifically involves abnormal pain perception due to stimuli that are normally non-painful. B: Complete lack of pain sensation This description aligns more with anesthesia or hypoalgesia, which are conditions where there is a significant reduction or complete absence of pain sensation. It contrasts with allodynia, where a person still experiences pain, but it is triggered by normally non-painful stimuli. C: Unpleasant sensation with or without stimulus This description is more akin to dysesthesia, which refers to an unpleasant or abnormal sensation, such as tingling, burning, or itching. While it can occur in conditions involving nerve damage, it is not the same as allodynia, which specifically involves the perception of pain from non-noxious stimuli.",
    "correct_choice_id": 200015,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/32877571698563534/32877571698563534.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/32877571698563534/32877571698563534.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50004,
    "choices": [
      {
        "id": 200016,
        "text": "IPPV"
      },
      {
        "id": 200017,
        "text": "SIMV"
      },
      {
        "id": 200018,
        "text": "CPAP"
      },
      {
        "id": 200019,
        "text": "PSV"
      }
    ],
    "text": "A patient is on ventilator, allowed to take spontaneous breath between mandatory breaths. He should be on \u2026\u2026\u2026\u2026\u2026\u2026. Mode of ventilation",
    "unique_key": "Q7370310",
    "question_audio": null,
    "question_video": null,
    "map_id": 34264743,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) SIMV (Synchronized Intermittent Mandatory Ventilation) SIMV (Synchronized Intermittent Mandatory Ventilation) is a mode of mechanical ventilation where the patient receives a set number of mandatory breaths, but is also allowed to take spontaneous breaths in between the mandatory breaths. This mode allows the patient to have control over their breathing pattern while ensuring that the ventilator delivers the necessary mechanical support when the patient is unable to initiate sufficient breaths. The mandatory breaths are synchronized with the patient's own efforts to avoid conflict between the ventilator and the patient's respiratory drive. Incorrect Options: A: IPPV (Intermittent Positive Pressure Ventilation) IPPV involves delivering breaths at a set rate, usually at fixed intervals, and typically does not allow for spontaneous breaths. It is a fully controlled mode of ventilation, where the patient does not initiate breaths independently. This does not align with the description of allowing spontaneous breaths between mandatory breaths. C: CPAP (Continuous Positive Airway Pressure) CPAP is a mode where the patient breathes spontaneously, but it provides continuous positive pressure throughout the respiratory cycle to help keep the airways open. However, it does not include mandatory breaths or synchronized ventilation, which is a key feature of SIMV. CPAP is used primarily for patients who do not require full mechanical ventilation support. D: PSV (Pressure Support Ventilation) PSV is a mode of ventilation where the ventilator provides support during spontaneous breaths to assist the patient in overcoming the work of breathing. However, it does not include mandatory breaths. In PSV, the patient controls the rate and timing of breathing, with the ventilator offering support during inspiration. While it allows spontaneous breathing, it does not match the description of alternating between mandatory and spontaneous breaths.",
    "correct_choice_id": 200017,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/49398241698563599/49398241698563599.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/49398241698563599/49398241698563599.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50005,
    "choices": [
      {
        "id": 200020,
        "text": "Mary cartall mask"
      },
      {
        "id": 200021,
        "text": "Venturi mask"
      },
      {
        "id": 200022,
        "text": "Poly mask"
      },
      {
        "id": 200023,
        "text": "Nasal cannulae"
      }
    ],
    "text": "Fixed performance device is",
    "unique_key": "Q9895928",
    "question_audio": null,
    "question_video": null,
    "map_id": 34962488,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Venturi mask A Venturi mask is a fixed-performance device used to deliver precise concentrations of oxygen to the patient. It works by using a set of color-coded adapters that regulate the flow of oxygen and mix it with room air, ensuring a specific, predetermined oxygen concentration. This ability to deliver a consistent oxygen concentration regardless of changes in the patient\u2019s breathing rate or tidal volume is why it is classified as a fixed-performance device. Incorrect Options: A: Mary Cartall mask The Mary Cartall mask is a non-rebreather mask that is designed to provide high concentrations of oxygen, but it does not provide a fixed level of oxygen concentration. Its performance can be affected by the patient\u2019s breathing pattern, so it cannot be classified as a fixed-performance device. C: Poly mask The Poly mask is also a type of non-rebreather mask. It provides high oxygen concentrations but does not ensure a specific, consistent oxygen level, as its performance depends on the patient\u2019s tidal volume and respiratory rate. Therefore, it is not a fixed-performance device. D: Nasal cannulae The nasal cannulae is a variable-performance device. It can provide supplemental oxygen at lower concentrations, but the exact oxygen concentration delivered depends on the flow rate and the patient\u2019s breathing patterns. It is not considered a fixed-performance device, as it does not guarantee a precise concentration of oxygen.",
    "correct_choice_id": 200021,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/70865701698563620/70865701698563620.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/70865701698563620/70865701698563620.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50006,
    "choices": [
      {
        "id": 200024,
        "text": "Controlled Mechanical ventilation (CMV)"
      },
      {
        "id": 200025,
        "text": "Synchronized intermittent mandatory ventilation (SIMV)"
      },
      {
        "id": 200026,
        "text": "Pressure support ventilation (PSV)"
      },
      {
        "id": 200027,
        "text": "Assist- control ventilation (ACV)"
      }
    ],
    "text": "The following modes of ventilation may be used for weaning off patients from mechanical ventilation except-",
    "unique_key": "Q4119422",
    "question_audio": null,
    "question_video": null,
    "map_id": 34837571,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Controlled Mechanical Ventilation (CMV) Controlled Mechanical Ventilation (CMV) is the least suitable mode for weaning patients from mechanical ventilation because it delivers all breaths at a set rate and volume without allowing for any spontaneous breathing. In this mode, the ventilator takes full control of the patient's breathing, meaning the patient cannot initiate breaths on their own. This makes CMV inappropriate for weaning, as the goal of weaning is to gradually allow the patient to take more spontaneous breaths while decreasing ventilator support. Incorrect Options: B: Synchronized Intermittent Mandatory Ventilation (SIMV) SIMV is often used for weaning because it allows the patient to breathe spontaneously between mandatory breaths delivered by the ventilator. This mode supports both controlled and spontaneous breathing, making it an excellent choice for weaning as it gradually reduces the need for mandatory ventilator breaths while encouraging the patient to take more spontaneous breaths. C: Pressure Support Ventilation (PSV) PSV is another mode frequently used for weaning. It allows the patient to breathe spontaneously, with the ventilator providing pressure support to reduce the effort required for each breath. This mode decreases the patient's work of breathing and helps transition them off mechanical ventilation by allowing them to take full control of their breathing while receiving some assistance from the ventilator. D: Assist-Control Ventilation (ACV) ACV is also used in weaning, although it is typically a step before completely switching to modes like SIMV or PSV. In this mode, the ventilator delivers breaths at a set rate, but it also allows the patient to initiate additional breaths, which are assisted by the ventilator. ACV can be used for weaning, as it supports spontaneous breathing but still provides mandatory breaths when the patient is unable to initiate them on their own.",
    "correct_choice_id": 200024,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/15628481698563634/15628481698563634.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/15628481698563634/15628481698563634.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50007,
    "choices": [
      {
        "id": 200028,
        "text": "Useful in situations where PO2 is low"
      },
      {
        "id": 200029,
        "text": "Raised CO2"
      },
      {
        "id": 200030,
        "text": "Impaired renal function"
      },
      {
        "id": 200031,
        "text": "Raised ICT"
      }
    ],
    "text": "All are true about PEEP except-",
    "unique_key": "Q6179517",
    "question_audio": null,
    "question_video": null,
    "map_id": 34476237,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) PEEP ( POSITIVE END EXPIRATORY PRESSURE) is a technique of giving a positive pressure at the end of ventilation in a mechanically ventilated patient. When it is given in a spontaneously breathing patient then its called as CPAP ( continuous positive airway pressure) Advantages of PEEP are:improvement of arterial oxygenation by \u2022 Increase FRC \u2022 Improve lung compliance \u2022 Correct ventilation/perfusion abnormalities. \u2022 The resulting decrease in intrapulmonary shunting \u2022 Redistribute extravascular lung water from the interstitial space between alveoli and endothelial cells toward peri bronchial and perihilar areas. Adverse effects are: \u2022 Excessive peep can cause baro trauma \u2022 Increase in venous pressures cause decrease in cardiac output \u2022 Decrease in hepatic and renal blood flow \u2022 Increase in intra cranial pressure",
    "correct_choice_id": 200031,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/52859991698563648/52859991698563648.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/52859991698563648/52859991698563648.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50008,
    "choices": [
      {
        "id": 200032,
        "text": "The most common preceding arrhythmia is bradycardia"
      },
      {
        "id": 200033,
        "text": "The most common cause is failure of ventilation"
      },
      {
        "id": 200034,
        "text": "Most occur during emergence from anaesthesia"
      },
      {
        "id": 200035,
        "text": "Most are considered unpreventable and untreatable"
      }
    ],
    "text": "With respect to cardiac arrests occurring during anaesthesia-",
    "unique_key": "Q6311152",
    "question_audio": null,
    "question_video": null,
    "map_id": 34852098,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) The most common preceding arrhythmia is bradycardia Bradycardia is indeed the most common arrhythmia that precedes cardiac arrest during anesthesia. Bradycardia can occur due to a variety of factors, including vagal stimulation, medication effects (such as opioids or anesthetics), or hypoxia. If bradycardia is not treated promptly, it can lead to a progression to more severe arrhythmias like asystole or ventricular fibrillation, ultimately leading to cardiac arrest. Early recognition and management of bradycardia, including the use of atropine or pacing if necessary, can help prevent a full cardiac arrest. Incorrect Options: B: The most common cause is failure of ventilation While failure of ventilation can certainly lead to cardiac arrest, it is not the most common cause during anesthesia. Factors such as drug overdose, equipment failure, or electrolyte disturbances can also contribute to a cardiac arrest, and failure of ventilation is just one of many potential causes. However, failure to ensure adequate oxygenation and ventilation is a critical issue that should be monitored and addressed during anesthesia to prevent complications. C: Most occur during emergence from anesthesia This statement is incorrect. Cardiac arrests during anesthesia are actually more likely to occur during induction or maintenance of anesthesia rather than during emergence. This is because the process of induction can lead to hemodynamic instability, such as hypotension or arrhythmias, and anesthetics during maintenance can depress cardiovascular function. Emergence is usually a less critical phase, although it still requires monitoring for complications like aspiration or airway obstruction. D: Most are considered unpreventable and untreatable This is not accurate. Cardiac arrests during anesthesia are not considered unpreventable or untreatable. With appropriate monitoring, early detection of changes in vitals, and prompt intervention (such as managing bradycardia or addressing ventilation issues), most cases of cardiac arrest can be prevented or treated effectively. Prevention measures, including proper airway management and monitoring, are key in reducing the risk of such events.",
    "correct_choice_id": 200032,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/7349691698563663/7349691698563663.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/7349691698563663/7349691698563663.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50009,
    "choices": [
      {
        "id": 200036,
        "text": "Bradycardia"
      },
      {
        "id": 200037,
        "text": "Hyperkalemia"
      },
      {
        "id": 200038,
        "text": "Metabolic acidosis"
      },
      {
        "id": 200039,
        "text": "Hypertension"
      }
    ],
    "text": "All are seen in Malignant hyperthermia except:",
    "unique_key": "Q8122840",
    "question_audio": null,
    "question_video": null,
    "map_id": 34860380,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Bradycardia Bradycardia is not typically seen in malignant hyperthermia (MH). Instead, MH generally leads to tachycardia (increased heart rate) as a result of the hypermetabolic state and the associated increases in body temperature, carbon dioxide production, and sympathetic nervous system activation. Bradycardia would be more indicative of other conditions, such as vagal stimulation or some drug effects, rather than MH. The cardiovascular effects of MH tend to involve tachycardia, not bradycardia. Incorrect Options: B: Hyperkalemia Hyperkalemia is a classic feature of malignant hyperthermia. The muscle rigidity and cellular damage associated with MH cause the release of potassium from inside muscle cells into the bloodstream. This leads to elevated levels of potassium in the blood, which can cause severe arrhythmias and other complications if not managed promptly. C: Metabolic acidosis Metabolic acidosis is another key feature of malignant hyperthermia. The hypermetabolic state, increased muscle activity, and anaerobic metabolism during MH cause a buildup of lactic acid and CO2, leading to a decrease in blood pH and resulting in metabolic acidosis. This is a critical manifestation of the condition that requires immediate treatment. D: Hypertension Hypertension is commonly seen in malignant hyperthermia due to the increased sympathetic nervous system activity, which leads to vasoconstriction and increased systemic vascular resistance. Additionally, the body's response to the extreme hypermetabolic state can also elevate blood pressure. Hypertension is therefore a common sign of MH.",
    "correct_choice_id": 200036,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/62606101698563678/62606101698563678.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/62606101698563678/62606101698563678.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50010,
    "choices": [
      {
        "id": 200040,
        "text": "Absorption atelactasis"
      },
      {
        "id": 200041,
        "text": "Increased pulmonary compliance"
      },
      {
        "id": 200042,
        "text": "Decreased vital capacity"
      },
      {
        "id": 200043,
        "text": "Endothelial damage"
      }
    ],
    "text": "Side effects of oxygen therapy are all except:",
    "unique_key": "Q9553633",
    "question_audio": null,
    "question_video": null,
    "map_id": 34032287,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Increased pulmonary compliance Increased pulmonary compliance is not a side effect of oxygen therapy. In fact, oxygen therapy does not typically increase pulmonary compliance. Pulmonary compliance refers to the ability of the lungs to expand and contract with ease. It is generally influenced by factors like lung tissue elasticity, surfactant levels, and the integrity of the lung's structural components. Oxygen therapy can cause damage to lung tissues, but it doesn't improve lung compliance. In certain conditions, such as in patients with chronic lung diseases or after prolonged high-concentration oxygen exposure, pulmonary compliance may actually decrease. Incorrect Options: A: Absorption atelectasis Absorption atelectasis is a well-known side effect of oxygen therapy, especially when high concentrations of oxygen are administered over a prolonged period. When a patient is given high concentrations of oxygen, nitrogen, which helps keep the alveoli open, is washed out. This results in the collapse of the alveoli due to the rapid absorption of oxygen and the lack of a stabilizing gas (like nitrogen). This leads to atelectasis, where part of the lung tissue becomes deflated. C: Decreased vital capacity Decreased vital capacity can occur as a result of oxygen toxicity, especially with prolonged exposure to high concentrations of oxygen. Oxygen toxicity can lead to lung injury and inflammation, which can impair lung function and decrease the total volume of air a person can exhale after taking a deep breath, thus reducing vital capacity. D: Endothelial damage Endothelial damage is a potential side effect of oxygen therapy, particularly when oxygen is administered at high concentrations for extended periods. Oxygen toxicity can cause the formation of reactive oxygen species (ROS) and free radicals, which can damage the endothelial cells lining blood vessels. This damage can impair vascular function and lead to complications such as pulmonary edema and impaired tissue perfusion.",
    "correct_choice_id": 200041,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/69037691698563690/69037691698563690.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/69037691698563690/69037691698563690.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50011,
    "choices": [
      {
        "id": 200044,
        "text": "Hemodynamic monitor failure"
      },
      {
        "id": 200045,
        "text": "Decreased cardiac output"
      },
      {
        "id": 200046,
        "text": "Impaired adrenal output"
      },
      {
        "id": 200047,
        "text": "Massive blood loss"
      }
    ],
    "text": "A 65-year-old male suffering from chronic shoulder pain is undergoing inguinal hernia repair. During the case, the patients' mean arterial pressure is becoming increasingly difficult to maintain above a goal of 65 mmHg. There is no significant blood loss. ETCO2 monitor reads a normal output of 35 mmHg, which has been stable throughout the case. The blood pressure cuff is securely in place. The patients' home medications include over the counter paracetamol, and oral steroid daily. What is the most likely cause of these patients' hemodynamic instability?",
    "unique_key": "Q2372288",
    "question_audio": null,
    "question_video": null,
    "map_id": 34644734,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Multiple case reports support the link between long term steroid use and adrenal insufficiency, which can predispose a patient to an eventual adrenal crisis, also known as an Addisonian crisis when under an adequate amount of physiologic stress, this case being surgery. Oral long term steroid therapy act as feedback inhibitors on the hypothalamic-pituitary-adrenal axis (HPA). Patients on chronic steroid therapy may experience HPAA suppression, resulting in low CRH and ACTH levels that lead to atrophy of the adrenal zona fasciculata and a decrease in cortisol production Inadequate cortisol production may predispose to vasodilatation and hypotension Steroid induced adrenal insufficiency has been well established in the chronic pain patient population, and best explains this patient's hemodynamic compromise. Massive blood loss is unlikely. Hemodynamic monitor failure is unlikely as the patients' blood pressure cuff is securely in place. Decreased cardiac output is unlikely as the ETCO2 monitor reads a normal range and stable output. Steroid should be replaced based on type of surgery Surgery - Recommendations Superficial - Daily dose only Minor - Daily dose plus hydrocortisone (25mg IV) Moderate - Daily dose plus hydrocortisone (50-75mg, taper 1-2 days) Major - Daily dose plus hydrocortisone (100-150mg, taper 1-2 days)",
    "correct_choice_id": 200046,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50012,
    "choices": [
      {
        "id": 200048,
        "text": "endobronchial intubation"
      },
      {
        "id": 200049,
        "text": "excessive expiratory time"
      },
      {
        "id": 200050,
        "text": "excessive tidal volume"
      },
      {
        "id": 200051,
        "text": "low cardiac output"
      }
    ],
    "text": "A previously healthy, 60-kg, 17-year-old boy is undergoing emergency surgery for a gunshot wound involving the iliac vein. Ventilation is controlled with a tidal volume of 700 ml/breath, rate of 14/min, and peak inspiratory pressure of 30 cmH2O. Body temperature is normal. The most likely cause of an end-tidal carbon dioxide partial pressure of 16 mmHg is",
    "unique_key": "Q3175670",
    "question_audio": null,
    "question_video": null,
    "map_id": 34557602,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Excessive tidal volume. Excessive tidal volume can lead to a decrease in end-tidal carbon dioxide (EtCO2) due to alveolar hyperventilation. When tidal volumes are higher than necessary for effective ventilation, they cause an excessive washout of carbon dioxide from the alveoli, leading to a lower concentration of CO2 in exhaled air. In this case, the patient is ventilated with a tidal volume of 700 mL, which exceeds the typical recommendation of 6\u20138 mL/kg of ideal body weight (360\u2013480 mL for a 60-kg patient). This results in hyperventilation, reduced arterial CO2, and a corresponding drop in EtCO2. While other conditions such as low cardiac output or hypoventilation can affect EtCO2, the excessive tidal volume in this scenario is the most plausible explanation for the significantly reduced EtCO2 of 16 mmHg, particularly in a patient with controlled ventilation and no other signs of hemodynamic instability. Explanation for Incorrect Responses: A. Endobronchial intubation: Endobronchial intubation (misplacement of the endotracheal tube into one mainstem bronchus) primarily results in ventilation of only one lung. This typically causes hypoxemia and increased peak inspiratory pressures due to reduced lung compliance, but it would not directly lead to a significant decrease in EtCO2 unless there were profound hypoperfusion or impaired CO2 delivery, which is not evident here. B. Excessive expiratory time: Excessive expiratory time is unlikely to cause low EtCO2. In mechanical ventilation, prolonging the expiratory phase primarily affects lung dynamics, such as reducing air trapping or improving gas exchange. It does not lead to hyperventilation or significantly reduced EtCO2 unless accompanied by other factors like high minute ventilation or low perfusion. D. Low cardiac output: While low cardiac output is a common cause of reduced EtCO2, this patient is not described as hemodynamically unstable or in shock, and there is no evidence of reduced perfusion (e.g., hypotension or poor oxygenation). Additionally, the normal body temperature indicates an absence of severe blood loss or metabolic compromise that could lead to significant low cardiac output. Therefore, this explanation is less likely than excessive tidal volume in the given scenario.",
    "correct_choice_id": 200050,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50013,
    "choices": [
      {
        "id": 200052,
        "text": "Apply positive end-expiratory pressure to the breathing circuit"
      },
      {
        "id": 200053,
        "text": "Attempt to aspirate air from the central venous catheter"
      },
      {
        "id": 200054,
        "text": "Expand intravascular volume"
      },
      {
        "id": 200055,
        "text": "Turn the patient to the left lateral decubitus position"
      }
    ],
    "text": "A 72-year-old man has massive venous hemorrhage during a radical prostatectomy. Blood pressure decreases from 110/60 to 75/30 mmHg and central venous pressure decreases from 12 to 4 mmHg. PetC02 decreases from 34 to 24 mmHg during constant minute ventilation. The oxygen saturation remained 100% .The most appropriate next step should be to",
    "unique_key": "Q8763291",
    "question_audio": null,
    "question_video": null,
    "map_id": 34399568,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Expand intravascular volume \u2022 Radical prostatectomy is a surgery associated with high risk of bleeding from the prostatic venous plexus. \u2022 This is a case of massive haemorrhage leading to sudden hypotension \u2022 Immediately expansion of intravascular space with bolus of crystalloid or colloid is recommended. \u2022 Later blood products should be used and if need be then use of inotropes and vasopressors are also indicated. \u2022 Application of PEEP will increase the intra thoracic pressure and will lead to more hypotension \u2022 If this case would have been a venous air embolism then aspiration of air through central venous catheter would have been beneficial \u2022 Maintenance of saturation is a distinguishing feature between VAE and hypotension due to massive haemorrhag",
    "correct_choice_id": 200054,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50014,
    "choices": [
      {
        "id": 200056,
        "text": "Cyanide toxicity"
      },
      {
        "id": 200057,
        "text": "Thiocyanate toxicity"
      },
      {
        "id": 200058,
        "text": "Methemoglobinemia"
      },
      {
        "id": 200059,
        "text": "Thiosulfate toxicity"
      }
    ],
    "text": "A 62-year-old man is brought to the ICU after elective repair of an abdominal aortic aneurysm. His vital signs are stable, but he requires a sodium nitroprusside infusion at a rate of 10 \u03bcg/kg/min to keep the systolic blood pressure below 110 mm Hg. The Sao2 is 98% with controlled ventilation at 12 breaths/min and an Fio2 of 0.60. After 3 days, his Sao2 decreases to 85% on the pulse oximeter. Chest x-ray film and results of physical examination are unchanged. Which of the following would most likely account for this desaturation?",
    "unique_key": "Q3987747",
    "question_audio": null,
    "question_video": null,
    "map_id": 34911266,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Methemoglobinemia \u2022 The metabolism of nitroprusside in the body requires the conversion of oxyhaemoglobin (Fe++) to methaemoglobin (Fe+++). \u2022 The presence of sufficient quantities of methaemoglobin in the blood will cause the pulse oximeter to read 85% saturation regardless of the true arterial saturation. \u2022 Cyanide toxicity is also a possibility in any patient who is receiving nitroprusside. \u2022 Cyanide toxicity should be suspected when the patient develops metabolic acidosis or becomes resistant to the hypotensive effects of this drug despite a sufficient infusion rate. \u2022 Thiocyanate toxicity is also a potential hazard of nitroprusside administration in patients with renal failure. \u2022 Patients suffering from thiocyanate toxicity display nausea, mental confusion, and skeletal-muscle weakness",
    "correct_choice_id": 200058,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50015,
    "choices": [
      {
        "id": 200060,
        "text": "Extubate the patient"
      },
      {
        "id": 200061,
        "text": "Sedation vacation and spontaneous breathing trial"
      },
      {
        "id": 200062,
        "text": "Do sedation vacation 2 days later"
      },
      {
        "id": 200063,
        "text": "Do a spontaneous breathing trial on sedative medications"
      }
    ],
    "text": "A 31-year-old patient with a past history for asthma presented to the ER with difficulty in breathing and cough. Examination shows that he was using accessory muscles and lung auscultation showed extensive expiratory wheezing. Labs and chest x-ray were unremarkable. He did not respond to nebulizations, steroids, and IV magnesium treatment. He was put on non-invasive positive pressure ventilation (BiPAP) by an ER physician which again he didn't tolerate. Eventually, he was intubated and to achieve better patient-ventilator synchrony he was deeply sedated. The second day in ICU his wheezing is much better. What is the next best step?",
    "unique_key": "Q8657031",
    "question_audio": null,
    "question_video": null,
    "map_id": 34491775,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) \u2022 The patient is doing well, and his asthma exacerbation is getting better. \u2022 In many of these patients, an estimated 33% of all admissions, are admitted for the respiratory failure of one etiology or another and subsequently are intubated and placed on mechanical ventilatory control. \u2022 Part of the standard of care for intubation is to sedate the patient continuously to reduce pain and anxiety; decrease oxygen consumption, and the body\u2019s stress response; prevent patient-ventilator desynchrony; reduce adverse neurocognitive impacts such as depression and post-traumatic stress disorder and ventilator-associated events including pneumonia and tracheostomy, and reduce total nursing requirements. \u2022 Regardless of which sedative agent was utilized, total continuous sedation was found to be associated with an extension of the total length of intubation and increased length of the ICU stay and limited the ability to properly assess the mental status of the patient, increased the risk for delirium, and suppressed brainwave function seen on EEG, linking to increased 6-month mortality. \u2022 It was assessed that daily, short-term cessation of sedation, a \u201csedation vacation,\u201d led to improved outcomes in patient care",
    "correct_choice_id": 200061,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50016,
    "choices": [
      {
        "id": 200064,
        "text": "Excessive anesthesia"
      },
      {
        "id": 200065,
        "text": "Pulmonary edema"
      },
      {
        "id": 200066,
        "text": "laryngospasm"
      },
      {
        "id": 200067,
        "text": "Worsening of bronchial asthma"
      }
    ],
    "text": "A 65-year-old female who is suffering from hypertension, diabetes, ischemic heart disease, and asthma undergoes emergency surgery for a ruptured appendix. She receives five liters of intravenous normal saline during surgery. Postoperatively, she is extubated uneventfully but later develops respiratory distress. Arterial blood gas report on room air shows pH 7.47, Pa02 55 mmHg, PaC02 36 mmHg, and HC03 21mEq/L. She has a low-grade fever, and blood pressure is 130/80 mm Hg. On auscultation, there are rales bilaterally. Her arterial blood gas fails to get better with supplementation of 100% oxygen. What is the most likely cause of her respiratory distress?",
    "unique_key": "Q7854967",
    "question_audio": null,
    "question_video": null,
    "map_id": 34036118,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Pulmonary edema \u2022 Clues toward the right answer are bilateral rales and failure to improve on high-flow oxygen. \u2022 Excessive fluid given during the surgery can lead to post-operative pulmonary edema. \u2022 Patient typically presents with tachypnea and tacycardia along with hypotension and bilateral rales on auscultation and a hypoxia that fails to respond to the oxygen therapy. \u2022 Other options can be ruled out \u2022 Excessive anesthesia will lead to depressed ventilatory drive and so there will be co2 accumulation along with hypoxia \u2022 Similar picture will be present with worsening of asthma along with this there will be wheeze on auscultation \u2022 Laryngospasm is an immediate event after extubation and causes airway obstruction and silent chest and rapid fall in saturation.",
    "correct_choice_id": 200065,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '05  Intensive Care Management';
        const quizFilename = '05-intensive-care-management-40f795d8.html';
        let hierarchy = ["DAMS", "DQB", "Anesthesia"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on navigation
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>