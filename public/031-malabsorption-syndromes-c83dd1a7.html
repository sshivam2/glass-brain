<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>031 Malabsorption Syndromes - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">25</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is unlikely to be seen in patients with malabsorption syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Anemia"
      },
      {
        "id": 2,
        "text": "Constipation"
      },
      {
        "id": 3,
        "text": "Tetany"
      },
      {
        "id": 4,
        "text": "Abdominal pain"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Constipation is not a feature of malabsorption syndrome.</p>\n<p>Malabsorption syndrome refers to a <strong>spectrum</strong> of conditions of various etiologies that arises due to diminished absorption of one or more dietary nutrients.</p>\n<p>The general features of malabsorption syndrome are <strong>abdominal pain</strong>,&nbsp;<strong>diarrhea</strong>, <strong>steatorrhea</strong>, and weight loss.</p>\n<p><strong>Anemia</strong>&nbsp;may be present when there is defective absorption of iron, folate, or vitamin B12. Hypocalcemia and <strong>tetany</strong>&nbsp;can be seen due to defective absorption of vitamin D.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following tests is useful for the assessment of intestinal mucosal function in a patient presenting with symptoms of malabsorption?",
    "choices": [
      {
        "id": 1,
        "text": "D-xylulose test"
      },
      {
        "id": 2,
        "text": "D-xylose test"
      },
      {
        "id": 3,
        "text": "Galactomannan test"
      },
      {
        "id": 4,
        "text": "Schilling test"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>D-xylose test</strong> is useful for the assessment of <strong>intestinal</strong> <strong>mucosal</strong> <strong>function</strong>.</p>\n<p>D-xylose is a <strong>monosaccharide</strong> that is directly absorbed by the intestinal mucosa without undergoing enzymatic digestion.</p>\n<p>The test is performed by administering 25g of D-xylose orally followed by the collection of urine 5h later. The test is considered <strong>abnormal</strong> (positive) if urinary D-xylose is <strong>&lt;4.5g</strong>. A positive D-xylose test indicates abnormal small intestinal mucosa.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The result of a D-xylose test showed urinary excretion of the monosaccharide at 3.6g after 5 hours. Which of the following can be a differential diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Irritable bowel syndrome"
      },
      {
        "id": 2,
        "text": "Ulcerative colitis"
      },
      {
        "id": 3,
        "text": "Pancreatic insufficiency"
      },
      {
        "id": 4,
        "text": "Crohn\u2019s disease"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>A urinary<strong> D-xylose &lt;4.5g </strong>after 5 hours of oral D-xylose<strong> (abnormal) </strong>can be seen in<strong> Crohn&rsquo;s disease.</strong></p>\n<p><strong>D-xylose</strong> is a monosaccharide that is <strong>directly absorbed</strong> by the small intestinal mucosa without undergoing enzymatic digestion. An abnormal (positive) D-xylose test indicates abnormal small intestinal mucosal absorption.</p>\n<p>A positive D-xylose test is seen in:</p>\n<ul>\n<li style=\"font-weight: 400;\">Celiac disease</li>\n<li style=\"font-weight: 400;\">Whipple&rsquo;s disease</li>\n<li style=\"font-weight: 400;\">Tropical sprue</li>\n<li style=\"font-weight: 400;\">Short bowel syndrome</li>\n<li style=\"font-weight: 400;\">Crohn&rsquo;s disease</li>\n</ul>\n<p>The test is of limited clinical value today and mostly has been replaced by small intestinal biopsy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Patients with which of the following conditions are likely to suffer from malabsorption?",
    "choices": [
      {
        "id": 1,
        "text": "Small bowel diverticulum"
      },
      {
        "id": 2,
        "text": "Anterior colon resection"
      },
      {
        "id": 3,
        "text": "Ulcerative colitis"
      },
      {
        "id": 4,
        "text": "Sigmoid volvulus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A&nbsp;<strong>small bowel diverticulum&nbsp;</strong>can result in malabsorption.</p>\n<p>A small bowel diverticulum is a <strong>blind pouch</strong> protruding from the small intestine that communicates with the lumen of the gut. It becomes a potential site for <strong>bacterial overgrowth</strong> which causes malabsorption. The growing gut bacteria <strong>depletes vitamin B12</strong>&nbsp;and <strong>deconjugates bile acids</strong> leading to steatorrhea, diarrhea, and macrocytic anemia.</p>\n<p>Anterior colon resection, ulcerative colitis, and sigmoid volvulus affect the large intestine and therefore do not cause malabsorption.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of short bowel syndrome in adults?",
    "choices": [
      {
        "id": 1,
        "text": "Crohn's disease"
      },
      {
        "id": 2,
        "text": "Mesenteric vascular occlusion"
      },
      {
        "id": 3,
        "text": "Necrotizing enterocolitis"
      },
      {
        "id": 4,
        "text": "Small intestinal perforation"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most common cause of <strong>short</strong> <strong>bowel</strong> <strong>syndrome</strong> in adults is <strong>mesenteric vascular occlusion.</strong></p>\n<p>Short bowel syndrome (SBS) is a malabsorption disorder caused by a <strong>lack of functional small intestine</strong>. In adults, the common causes are :</p>\n<ul>\n<li>Mesenteric vascular disease (e.g:&nbsp;mesenteric vascular occlusion.)</li>\n<li>Primary mucosal and submucosal disease (e.g: Crohn&rsquo;s disease)</li>\n<li>Operations without any preexisting small-intestinal disease (e.g: after trauma)</li>\n</ul>\n<p>In <strong>children</strong>, <strong>necrotizing</strong> <strong>enterocolitis</strong> is the most common cause.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Patients with which of the following conditions are unlikely to have protein malabsorption?",
    "choices": [
      {
        "id": 1,
        "text": "Enterokinase deficiency"
      },
      {
        "id": 2,
        "text": "Hartnup syndrome"
      },
      {
        "id": 3,
        "text": "Cystinuria"
      },
      {
        "id": 4,
        "text": "Homocystinuria"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Homocystinuria</strong> is not a protein malabsorption disorder. It is a <strong>disorder of methionine metabolism</strong> that leads to increased homocysteine levels.</p>\n<p>Proteins are broken down by pancreatic enzymes and are absorbed as amino acids and peptides. So, <strong>protein malabsorption</strong> usually occurs only in <strong>pancreatic insufficiency</strong>. Additionally, there are three <strong>rare genetic disorders</strong> that lead to protein malabsorption. They are:</p>\n<ul>\n<li style=\"font-weight: 400;\"><strong>Enterokinase deficiency</strong>- Defective conversion of the proenzyme trypsinogen to trypsin. It is characterised by:</li>\n<ul>\n<li style=\"font-weight: 400;\">Diarrhoea</li>\n<li style=\"font-weight: 400;\">Growth retardation</li>\n<li style=\"font-weight: 400;\">Hypoproteinemia</li>\n</ul>\n<li style=\"font-weight: 400;\"><strong>Hartnup disease</strong>- Defective transport of tryptophan and other neutral amino acids. It is characterised by:</li>\n<ul>\n<li style=\"font-weight: 400;\">Pellagra-like rash</li>\n<li style=\"font-weight: 400;\">Neuropsychiatric symptoms</li>\n</ul>\n<li style=\"font-weight: 400;\"><strong>Cystinuria</strong>- Defective transport of cystine and other dibasic amino acids. It is characterised by:</li>\n<ul>\n<li style=\"font-weight: 400;\">Renal calculi</li>\n<li style=\"font-weight: 400;\">Chronic pancreatitis</li>\n</ul>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A Schilling test was performed on a patient with vitamin B12 deficiency and the results are given below. What is the inference?",
    "choices": [
      {
        "id": 1,
        "text": "Ileal disease"
      },
      {
        "id": 2,
        "text": "Pernicious anemia"
      },
      {
        "id": 3,
        "text": "Small intestinal bacterial overgrowth"
      },
      {
        "id": 4,
        "text": "Chronic pancreatitis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above findings on Schilling test show reduced absorption of vitamin B12 irrespective of all interventions. This is suggestive of an <strong>ileal disease.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/015a7e6ffb2c4be68f24018495ba0303.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient presented with chronic diarrhea and steatorrhea. D-xylose test was normal and the Schilling test was abnormal. A duodenal biopsy was normal. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Celiac disease"
      },
      {
        "id": 2,
        "text": "Ulcerative colitis"
      },
      {
        "id": 3,
        "text": "Intestinal lymphangiectasia"
      },
      {
        "id": 4,
        "text": "Pancreatic insufficiency"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario describes a case of <strong>malabsorption syndrome </strong>(chronic diarrhea and steatorrhea), a <strong>normal xylose</strong> test and <strong>normal duodenal</strong> biopsy with <strong>abnormal</strong> <strong>schilling</strong> test points towards pancreatic insufficiency.</p>\n<p>A normal xylose test and normal duodenal biopsy rules out small intestinal pathologies like <strong>celiac disease </strong>(option A) and <strong>intestinal lymphangiectasia </strong>(option C), presence of steatorrhea rules out <strong>ulcerative colitis </strong>(option B) as it affects the large bowel which is not the main site of absorption of fat.&nbsp;&nbsp;</p>\n<p><strong>Ileal disease</strong> is also characterized by normal xylose test, normal duodenal biopsy and steatorrhea and abnormal schilling test but among the given options the most appropriate answer would be pancreatic insufficiency due to chronic pancreatitis.</p>\n<p><strong>Pancreatic insufficiency</strong> is characterised by the deficiency of exocrine pancreatic enzymes that result in maldigestion and malabsorption.</p>\n<p>The features in favor of the diagnosis:</p>\n<ul>\n<li style=\"font-weight: 400;\"><strong>Steatorrhea</strong> - a deficiency of pancreatic lipases can lead to <strong>undigested fat</strong> in stools.</li>\n<li style=\"font-weight: 400;\"><strong>D-xylose test</strong> - d-xylose is a monosaccharide that is directly absorbed by the intestinal mucosa without undergoing any enzymatic action. <strong>Normal</strong> d-xylose test denotes <strong>intact mucosa.</strong></li>\n<li style=\"font-weight: 400;\"><strong>Schilling test</strong> - it is abnormal as pancreatic enzymes are required for the absorption of vitamin B12.</li>\n</ul>\n<p><br />Diagnosis of various malabsorption syndromes:<br /><br /></p>\n<table style=\"width: 925.122px;\">\n<tbody>\n<tr>\n<td style=\"width: 195px;\"><strong>Pathologies</strong></td>\n<td style=\"width: 163px;\"><strong>D xylose test</strong></td>\n<td style=\"width: 285px;\"><strong>Duodenal mucosal biopsy</strong></td>\n<td style=\"width: 252.122px;\"><strong>Schilling test</strong></td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Celiac disease</td>\n<td style=\"width: 163px;\">Decreased&nbsp;</td>\n<td style=\"width: 285px;\">Abnormal; Short or absent villi; epithelial cell damage; crypts hypertrophy</td>\n<td style=\"width: 252.122px;\">Normal&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Ileal disease</td>\n<td style=\"width: 163px;\">Normal&nbsp;</td>\n<td style=\"width: 285px;\">Normal&nbsp;</td>\n<td style=\"width: 252.122px;\">Abnormal</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Chronic pancreatitis</td>\n<td style=\"width: 163px;\">Normal&nbsp;</td>\n<td style=\"width: 285px;\">Normal&nbsp;</td>\n<td style=\"width: 252.122px;\">Abnormal; normal after pancreatic enzymes substitution</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Intestinal lymphangiectasia</td>\n<td style=\"width: 163px;\">Normal&nbsp;</td>\n<td style=\"width: 285px;\">Abnormal; dilated lymphatics, clubbed villi</td>\n<td style=\"width: 252.122px;\">Normal&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Bacterial overgrowth syndrome</td>\n<td style=\"width: 163px;\">Normal or may be abnormal&nbsp;</td>\n<td style=\"width: 285px;\">Usually normal or can have diffuse non specific damage to villi</td>\n<td style=\"width: 252.122px;\">Usually abnormal; normal after antibiotics administration</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An 11-year-old boy presented with steatorrhea and chronic diarrhea. An evaluation revealed delayed intellectual development and ataxia. Acanthocytes were seen on the peripheral blood smear. Ophthalmological examination showed the following. Which of the following is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Gaucher's disease"
      },
      {
        "id": 2,
        "text": "Abetalipoproteinemia"
      },
      {
        "id": 3,
        "text": "Whipple's disease"
      },
      {
        "id": 4,
        "text": "Protein losing enteropathy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image showing <strong>retinitis</strong> <strong>pigmentosa</strong> and presence of <strong>acanthocytes</strong> along with the given clinical features is suggestive of&nbsp;<strong>abetalipoproteinemia.</strong></p>\n<p>Abetalipoproteinemia is a rare genetic disorder in which there is <strong>defective chylomicron formation</strong>. Chylomicrons are required for the absorption and transport of fats and fat-soluble vitamins.</p>\n<p>It presents in early childhood with steatorrhoea and diarrhea, hypolipidemia, failure to thrive, ataxia, sensory and motor neuropathies.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1ed17c0567d541cda63d1953178a1ad6.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "The findings associated with abetalipoproteinemia are :",
    "choices": [
      {
        "id": 1,
        "text": "Figure A,B & C"
      },
      {
        "id": 2,
        "text": "Figure B & C"
      },
      {
        "id": 3,
        "text": "Figure A & B"
      },
      {
        "id": 4,
        "text": "Figure A & C"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Figure A</strong> shows&nbsp;<strong>vacuoles</strong> (unabsorbed fat) in the cytoplasm of the enterocytes. <strong>Figure B</strong> shows&nbsp;<strong>acanthocytes.&nbsp;</strong>These findings are associated with <strong>abetalipoproteinemia.</strong>&nbsp;</p>\n<p><strong>Figure C</strong>&nbsp;shows distended macrophages in the lamina propria and periodic acid&ndash;Schiff (PAS)-positive granules as seen in <strong>Whipple's disease.</strong></p>\n<p><strong>Acanthocytes</strong> are abnormal red blood cells with&nbsp;<strong>spiked cell membranes</strong> due to thorn-like projections. Causes of acanthocytes in peripheral smear are:</p>\n<ul>\n<li>Abetalipoproteinemia&nbsp;</li>\n<li>Renal disease</li>\n<li>Liver disease</li>\n<li>Hemolytic anemia</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0fa8bf0b71ce48b19a98c6377e5ae09a.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1cbc5b38a1c54e5597dfe0c96d46abc6x1280x1573.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c369e8b531e40989efc34cd918a7e85x834x772.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/348ec69c00cb45e685040e337b70e39cx682x786.PNG"
    ]
  },
  {
    "text": "All are true about the types of celiac disease except :",
    "choices": [
      {
        "id": 1,
        "text": "Latent type is associated with HLA DQ 2,8"
      },
      {
        "id": 2,
        "text": "Atypical type has a negative serology"
      },
      {
        "id": 3,
        "text": "Silent type has a positive serology"
      },
      {
        "id": 4,
        "text": "Classic type presents with diarrhea and steatorrhea"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Atypical celiac disease</strong> has a <strong>positive serology</strong> with atypical symptoms.</p>\n<table style=\"height: 150px; width: 474px;\">\n<tbody>\n<tr>\n<td style=\"width: 27px;\">\u00a0</td>\n<td style=\"width: 162px;\">Type of celiac disease</td>\n<td style=\"width: 65.5px;\">Serology</td>\n<td style=\"width: 194.5px;\">Features</td>\n</tr>\n<tr>\n<td style=\"width: 27px;\">A</td>\n<td style=\"width: 162px;\">Classic</td>\n<td style=\"width: 65.5px; text-align: center;\">+</td>\n<td style=\"width: 194.5px;\">Diarrhea, steatorrhea</td>\n</tr>\n<tr>\n<td style=\"width: 27px;\">B</td>\n<td style=\"width: 162px;\">Atypical</td>\n<td style=\"width: 65.5px; text-align: center;\">+</td>\n<td style=\"width: 194.5px;\">Iron deficiency anemia, osteopenia, ataxia, peripheral neuropathy, infertility</td>\n</tr>\n<tr>\n<td style=\"width: 27px;\">C</td>\n<td style=\"width: 162px;\">Silent</td>\n<td style=\"width: 65.5px; text-align: center;\">+</td>\n<td style=\"width: 194.5px; text-align: left;\">No features</td>\n</tr>\n<tr>\n<td style=\"width: 27px;\">D</td>\n<td style=\"width: 162px;\">Latent</td>\n<td style=\"width: 65.5px; text-align: center;\">-</td>\n<td style=\"width: 194.5px;\">HLA DQ 2,8</td>\n</tr>\n</tbody>\n</table>\n<p>Serology in celiac disease refers to either anti-tissue transglutaminase antibodies (anti-tTG) or anti-endomysial antibodies.</p>\n<p>Note:\u00a0Tropical sprue and celiac disease have similar clinical, endoscopic and histologic findings. A diagnosis of tropical sprue must be considered with a negative celiac serology.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common extraintestinal manifestation of celiac disease?",
    "choices": [
      {
        "id": 1,
        "text": "Dermatitis herpetiformis"
      },
      {
        "id": 2,
        "text": "Infertility"
      },
      {
        "id": 3,
        "text": "Anemia"
      },
      {
        "id": 4,
        "text": "Peripheral neuropathy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most <strong>common</strong> <strong>extraintestinal</strong> manifestation of celiac disease is <strong>dermatitis herpetiformis</strong> (DH).</p>\n<p>DH is characterized by intensely pruritic small papules and vesicles on the extensor surfaces of extremities, buttocks, and neck. It can be considered a&nbsp;<strong>celiac disease of the skin.</strong></p>\n<p>Other extraintestinal manifestations of celiac disease are:</p>\n<ul>\n<li style=\"font-weight: 400;\"><strong>Anemia</strong></li>\n<li style=\"font-weight: 400;\">Low bone density</li>\n<li style=\"font-weight: 400;\">Ataxia</li>\n<li style=\"font-weight: 400;\"><strong>Peripheral</strong> <strong>neuropathy</strong></li>\n<li style=\"font-weight: 400;\"><strong>Infertility</strong></li>\n</ul>\n<p>Celiac disease is often associated with other conditions such as type 1 diabetes mellitus, autoimmune thyroid disease, IgA deficiency, bird fancier's lung<strong>,</strong> and Down syndrome<strong>.</strong></p>\n<p>The image below shows dermatitis herpetiformis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6da17930748548a4905ed1233b1f0441x720x472.JPEG"
    ]
  },
  {
    "text": "A 15-year-old girl presented with fatigue, chronic diarrhoea,  weight loss, bone pain, and abdominal distension.  Investigations revealed iron deficiency anemia and osteoporosis. Which of the following is the single best test to be done for her evaluation?",
    "choices": [
      {
        "id": 1,
        "text": "TSH levels"
      },
      {
        "id": 2,
        "text": "C-peptide levels"
      },
      {
        "id": 3,
        "text": "Urine sugar and ketone"
      },
      {
        "id": 4,
        "text": "IgA tissue transglutaminase antibody"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The presence of fatigue, chronic diarrhea, weight loss and abdominal distention along with investigations showing features of<strong> malabsorption (iron deficiency)</strong> lead to the diagnosis of <strong>celiac disease </strong>or<strong> gluten sensitive enteropathy. </strong>The single best test for which is checking serum for the presence of<strong> IgA tissue transglutaminase (anti-TTG) antibodies</strong> (Option D).</p>\n<p><strong>Celiac disease</strong> is a disorder characterized by an immunological response to gluten causing damage to the proximal intestinal mucosa<strong> (villous atrophy)</strong> and <strong>malabsorption</strong> of nutrients.</p>\n<p>Symptoms usually begin <strong>6 to 24 months</strong> from the introduction of gluten into diet, although most patients go undiagnosed.</p>\n<p>The common manifestations are - &nbsp;irritability, abdominal distention, chronic diarrhea, weight loss or muscle wasting and extra-intestinally, the symptoms observed are aphthous ulcers, delayed puberty, iron deficiency anemia and short stature.</p>\n<p><strong>Screening</strong> for celiac disease is by testing for <strong>tissue transglutaminase IgA,</strong> <strong>endomysial</strong>, and deamidated <strong>antigliadin</strong> antibodies. IgA levels in serum are measured to detect false-negative results because of<strong> IgA deficiency. </strong></p>\n<p><strong>Small intestinal biopsy</strong> shows characteristic <strong>villus blunting,</strong> <strong>crypt hyperplasia, </strong>and increased intraepithelial <strong>lymphocytes</strong>.</p>\n<p>The treatment involves the <strong>exclusion</strong> of <strong>gluten-containing</strong> food from diet.&nbsp;</p>\n<p>Long term complications observed are <strong>osteoporosis</strong>, anemia, infertility and malignancy <strong>(enteropathy related-T cell lymphoma</strong> is the most common association)&nbsp;</p>\n<p>The <strong>Marsh classification</strong> is used to categorize celiac disease into different types and to quantify severity of disease involvement.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who presented with severe malabsorption is found to be positive for IgA tissue trans-glutaminase antibodies. What will be the next best step?",
    "choices": [
      {
        "id": 1,
        "text": "Do an intestinal biopsy"
      },
      {
        "id": 2,
        "text": "Check for anti-endomysial antibodies"
      },
      {
        "id": 3,
        "text": "Check for anti-gliadin antibodies"
      },
      {
        "id": 4,
        "text": "Start gluten-free diet"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In this patient with positive serology, a <strong>biopsy</strong> should be done next, to <strong>confirm</strong> the <strong>diagnosis</strong> of <strong>celiac disease.</strong></p>\n<p><strong>Tissue transglutaminase Ab&nbsp;(tTG-IgA) </strong>is the best screening test. IgA endomysial antibodies (EMA) are most specific.</p>\n<p>But a small-intestinal biopsy is required to establish a diagnosis of celiac disease, before starting treatment.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old man presented with chronic diarrhea, steatorrhea, and weight loss. IgA tissue trans-glutaminase antibodies were found to be positive. Duodenal biopsy revealed the following. Which of the following complications would you not expect in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Intestinal lymphoma"
      },
      {
        "id": 2,
        "text": "Intestinal ulcers"
      },
      {
        "id": 3,
        "text": "Pancreatic insufficiency"
      },
      {
        "id": 4,
        "text": "Collagenous sprue"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above scenario along with the presence of&nbsp;IgA tissue trans-glutaminase antibodies and biopsy showing&nbsp;villous atrophy,&nbsp;crypt hyperplasia,&nbsp;lamina propria infiltrates&nbsp;indicate a case of&nbsp;<strong>celiac disease.</strong>&nbsp;Pancreatic insufficiency is not a complication of celiac disease.</p>\n<p>The <strong>complications</strong> of celiac disease are:</p>\n<ul>\n<li><strong>Intestinal lymphomas</strong></li>\n<li><strong>Intestinal ulcers</strong>- also known as ulcerative jejunoileitis</li>\n<li><strong>Collagenous sprue</strong>- development of a subepithelial collagen layer</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0a98f21957e449a3912a90d8026b5aef.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 46-year-old lady with celiac disease is recommended a gluten-free diet. Which among the following can she consume?",
    "choices": [
      {
        "id": 1,
        "text": "Wheat"
      },
      {
        "id": 2,
        "text": "Barley"
      },
      {
        "id": 3,
        "text": "Rye"
      },
      {
        "id": 4,
        "text": "Rice"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Rice</strong> can be consumed on a <strong>gluten-free</strong> diet.</p>\n<p>The primary management of celiac disease is avoiding gluten in the diet.</p>\n<table style=\"width: 367.472px;\">\n<tbody>\n<tr>\n<td style=\"width: 179px; text-align: center;\">\n<p><strong>Diet avoided (gluten)</strong></p>\n<p style=\"text-align: center;\"><strong>&ldquo;BROW</strong>&rdquo;</p>\n</td>\n<td style=\"width: 176.472px; text-align: center;\">\n<p><strong>Diet Allowed </strong></p>\n<p style=\"text-align: center;\"><strong>&ldquo;So MRP </strong>&rdquo;</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 179px;\">Barley</td>\n<td style=\"width: 176.472px;\">Soya bean</td>\n</tr>\n<tr>\n<td style=\"width: 179px;\">Rye</td>\n<td style=\"width: 176.472px;\">Maize</td>\n</tr>\n<tr>\n<td style=\"width: 179px;\">Oats</td>\n<td style=\"width: 176.472px;\">Rice</td>\n</tr>\n<tr>\n<td style=\"width: 179px;\">Wheat</td>\n<td style=\"width: 176.472px;\">Potato</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "When will you diagnose a patient with refractory celiac disease?",
    "choices": [
      {
        "id": 1,
        "text": "No remission of disease despite gluten free diet"
      },
      {
        "id": 2,
        "text": "Intestinal ulcers on biopsy"
      },
      {
        "id": 3,
        "text": "No response to steroids"
      },
      {
        "id": 4,
        "text": "Development of a subepithelial collagen layer"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Refractory celiac disease</strong> is diagnosed when there is <strong>no remission</strong> of disease despite a <strong>strict gluten-free diet</strong> for 6-12 months.</p>\n<p>Patients are <strong>symptomatic</strong> and have persistent small intestinal <strong>villous atrophy&nbsp;</strong>on biopsy. They respond well to <strong>steroids</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Match the following disorders with their respective sites of involvement:",
    "choices": [
      {
        "id": 1,
        "text": "1-ii , 2-i , 3-iii"
      },
      {
        "id": 2,
        "text": "1-iii, 2-ii , 3-i"
      },
      {
        "id": 3,
        "text": "1-i , 2-iii , 3-ii"
      },
      {
        "id": 4,
        "text": "1-ii, 2-iii, 3-i"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The sites involved in the given malabsorption syndromes are as follows:</p>\n<table>\n<tbody>\n<tr>\n<td><strong>Disorder</strong></td>\n<td><strong>Site of involvement</strong></td>\n</tr>\n<tr>\n<td>Celiac disease</td>\n<td>Proximal small intestine</td>\n</tr>\n<tr>\n<td>Whipple's disease</td>\n<td>Proximal &gt; Distal small intestine</td>\n</tr>\n<tr>\n<td>Tropical sprue</td>\n<td>Whole small intestine (panintestine)</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All are true about Whipple's disease except :",
    "choices": [
      {
        "id": 1,
        "text": "Caused by gram positive organism Tropheryma whipplei"
      },
      {
        "id": 2,
        "text": "Culture of organism from biopsy specimen helps in early diagnosis"
      },
      {
        "id": 3,
        "text": "Males affected more than females"
      },
      {
        "id": 4,
        "text": "Multiple systems are affected"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><em><strong>Tropheryma</strong> <strong>whipplei</strong></em> is <strong>difficult to culture</strong> from the biopsy specimen. Hence, it cannot be used for the early diagnosis of Whipple's disease.&nbsp;</p>\n<p><strong>Whipple's disease</strong> is a chronic <strong>multisystem disorder</strong> caused by the gram-positive bacteria <em>Tropheryma whipplei.</em> It primarily causes malabsorption along with central nervous system &amp; cardiac problems. It mostly <strong>affects men</strong>&nbsp;and presents with fever, diarrhea weight loss, and arthralgia.</p>\n<p>The diagnosis of Whipple's disease is made through a biopsy which shows&nbsp;the presence of<strong> PAS-positive macrophages </strong>in the small intestine and other organs with evidence of disease.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common CNS manifestation associated with Whipple\u2019s disease?",
    "choices": [
      {
        "id": 1,
        "text": "Progressive dementia"
      },
      {
        "id": 2,
        "text": "Supranuclear ophthalmoplegia"
      },
      {
        "id": 3,
        "text": "Opsoclonus myoclonus syndrome"
      },
      {
        "id": 4,
        "text": "Oculomasticatory myorrhythmia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>most common CNS</strong> manifestation associated with <strong>Whipple&rsquo;s</strong> disease is <strong>progressive dementia.</strong></p>\n<p>Other important CNS manifestations in Whipple's disease are:</p>\n<ul>\n<li>Personality and mood changes</li>\n<li>Progressive supranuclear ophthalmoplegia</li>\n<li>Focal neurologic presentations</li>\n<li><strong>Oculomasticatory myorrhythmia</strong> - an unusual combination of rhythmic eye and jaw movements which is pathognomonic of Whipple's disease.</li>\n</ul>\n<p>Whipple's disease associated with CNS symptoms has a poor prognosis.</p>\n<p>Note:&nbsp;<strong>Opsoclonus myoclonus syndrome</strong> is a paraneoplastic syndrome associated with <strong>neuroblastoma</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cardiovascular presentation seen in patients with Whipple's disease?",
    "choices": [
      {
        "id": 1,
        "text": "Endocarditis"
      },
      {
        "id": 2,
        "text": "Pericarditis"
      },
      {
        "id": 3,
        "text": "Myocarditis"
      },
      {
        "id": 4,
        "text": "Pericardial effusion"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common <strong>cardiovascular</strong> presentation in <strong>Whipple's</strong> disease is <strong>culture-negative endocarditis.</strong></p>\n<p>Other cardiovascular findings include:</p>\n<ul>\n<li>Congestive heart failure</li>\n<li>Pericarditis</li>\n<li>Myocarditis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 38-year-old man presented with chronic diarrhea, weight loss, and joint pains. A duodenal biopsy was done. Which of the following drug is used in the maintenance phase of treatment of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Penicillin G"
      },
      {
        "id": 2,
        "text": "Ceftriaxone"
      },
      {
        "id": 3,
        "text": "Meropenem"
      },
      {
        "id": 4,
        "text": "Trimethoprim / Sulfamethoxazole"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above image shows<strong>&nbsp;PAS-positive foamy macrophages </strong>present in the lamina propria<strong>. </strong>This along with the given features suggests<strong>&nbsp;Whipple's disease. Cotrimoxazole</strong>&nbsp;is used in the <strong>maintenance phase</strong> of the treatment of Whipple's disease.</p>\n<p>Treatment of Whipple's disease:</p>\n<ul>\n<li>Induction phase- ceftriaxone or meropenem or penicillin G + streptomycin - 2 weeks</li>\n<li>Maintenance phase- trimethoprim / sulfamethoxazole (TMP/SMX) for 1 year. It&nbsp;has high CNS penetration so it is used in maintenance to prevent relapse.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5573c6e5e2654b418593f975c1d02e85.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3bf8575962fd4d0a934ad25cdcd28d9dx589x732.PNG"
    ]
  },
  {
    "text": "A 42-year-old man presented with diarrhea, floating stools, and weight loss for 3 months. Celiac serology was negative. Biopsy of the small intestinal mucosa revealed villous atrophy and crypt hyperplasia with normal mucosal thickness. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Celiac disease"
      },
      {
        "id": 2,
        "text": "Whipple\u2019s disease"
      },
      {
        "id": 3,
        "text": "Tropical sprue"
      },
      {
        "id": 4,
        "text": "Radiation enteritis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The history of malabsorptive symptoms, a negative celiac serology, and<strong>&nbsp;</strong>the biopsy findings are suggestive of&nbsp;<strong>tropical sprue</strong>.</p>\n<p><strong>Improvement</strong> in symptoms after<strong> folic acid </strong>intake is a hallmark of tropical sprue.</p>\n<p>Tropical sprue is an acquired malabsorptive condition of probable <strong>infectious aetiology</strong>. It is seen in people from the tropics such as India, Southeast Asia and South America.</p>\n<p>Tropical sprue and celiac disease have similar clinical, endoscopic and histologic findings. However, a positive&nbsp;<strong>celiac serology</strong> (anti-tissue transglutaminase and anti-endomysial antibodies) can be used to <strong>rule out</strong> tropical sprue.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following would you prescribe for a patient with tropical sprue?",
    "choices": [
      {
        "id": 1,
        "text": "Tertacycline + Vitamin B12"
      },
      {
        "id": 2,
        "text": "Metronidazole + Folic acid"
      },
      {
        "id": 3,
        "text": "Amoxicillin + Vitamin B12"
      },
      {
        "id": 4,
        "text": "Tetracycline + Folic acid"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The treatment of tropical sprue is <strong>tetracycline + folic acid.</strong></p>\n<p>Because of marked folate deficiency, folic acid is most often given together with broad spectrum antibiotics for up to 6 months.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drug is used for the management of a patient with small intestinal bacterial overgrowth?",
    "choices": [
      {
        "id": 1,
        "text": "Ciprofloxacin"
      },
      {
        "id": 2,
        "text": "Azithromycin"
      },
      {
        "id": 3,
        "text": "Rifaximin"
      },
      {
        "id": 4,
        "text": "Streptomycin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Rifaximin</strong> is the&nbsp;<strong>preferred</strong> drug for&nbsp;the management of small intestinal bacterial overgrowth (<strong>SIBO</strong>).</p>\n<p>The antibiotics are given for around 3 weeks. The other drugs that can be used are :</p>\n<ul>\n<li>Tetracyclines</li>\n<li>Cephalosporins</li>\n<li>Metronidazole</li>\n<li>Amoxicillin-Clavulanic acid</li>\n</ul>\n<p>Rifaximin is the antibiotic used in <strong>hepatic encephalopathy</strong> to lower blood ammonia levels.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '031 Malabsorption Syndromes';
        const quizFilename = '031-malabsorption-syndromes-c83dd1a7.html';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>