<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16 Intravenous Anesthesia - Barbiturates, Benzodiazepines & Propofol - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Anesthesia
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">28</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "What concentration of intravenous thiopentone is used to induce anesthesia in a patient?",
    "choices": [
      {
        "id": 1,
        "text": "0.25%"
      },
      {
        "id": 2,
        "text": "1%"
      },
      {
        "id": 3,
        "text": "2%"
      },
      {
        "id": 4,
        "text": "2.5%"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: left;\"><strong>Thiopentone</strong> is used as a <strong>2.5%</strong> solution.</p>\n<p style=\"text-align: left;\">Thiopentone is prepared as a sodium salt (mixed with 6% by weight anhydrous sodium carbonate) and can be reconstituted with water, glucose 5%, or normal saline to produce a 2.5% solution of thiopental.</p>\n<p style=\"text-align: left;\">Other reconstituted solutions:</p>\n<ul style=\"text-align: left;\">\n<li><strong>2%</strong> solution of <strong>thiamylal</strong></li>\n<li><strong>1%</strong> solution of <strong>methohexital</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In patients administered thiopentone, which property of the drug allows for the rapid recovery from anesthesia?",
    "choices": [
      {
        "id": 1,
        "text": "Rapid elimination"
      },
      {
        "id": 2,
        "text": "Rapid reabsorption"
      },
      {
        "id": 3,
        "text": "Rapid metabolism"
      },
      {
        "id": 4,
        "text": "Rapid redistribution"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Rapid recovery</strong> from <strong>thiopentone anesthesia</strong> is due to its <strong>rapid redistribution</strong>.</p>\n<p>It is redistributed from the brain to tissues that are less perfused, like muscles, resulting in rapid recovery (within 20 minutes).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are asked to reconstitute thiopentone a few minutes before the 1st OT case is scheduled to start. Which of the following would you not use?",
    "choices": [
      {
        "id": 1,
        "text": "Normal saline"
      },
      {
        "id": 2,
        "text": "Glucose"
      },
      {
        "id": 3,
        "text": "Ringer's lactate"
      },
      {
        "id": 4,
        "text": "Water"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Thiopentone</strong> is an alkaline solution and should <strong>not</strong> be reconstituted with <strong>Ringer's lactate</strong> which has an acidic pH.&nbsp;Ringer's lactate <strong>decreases</strong> the<strong> alkalinity</strong> of the solution and the <strong>calcium</strong> present in it can result in the <strong>precipitation</strong> of thiopentone.&nbsp;</p>\n<p>Thiopentone and other barbiturates are prepared as sodium salts (mixed with 6% by weight anhydrous sodium carbonate) and can be reconstituted with<strong> water</strong>,<strong>&nbsp;5% glucose,&nbsp;</strong><strong>or normal saline</strong> to produce a <strong>2.5%</strong> <strong>solution</strong> of <strong>thiopental.</strong></p>\n<p>After reconstitution:</p>\n<ul>\n<li>Thiobarbiturates (thiopentone, thiamylal) &ndash; stable if refrigerated for 1 week</li>\n<li>Methohexital &ndash; stable if refrigerated for 6 weeks</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following patients can thiopentone be administered safely?",
    "choices": [
      {
        "id": 1,
        "text": "A 44-year-old man with brain tumor"
      },
      {
        "id": 2,
        "text": "A 24-year-old woman with history of acute intermittent porphyria"
      },
      {
        "id": 3,
        "text": "A 60-year-old woman in hypovolemic shock"
      },
      {
        "id": 4,
        "text": "A 52-year-old man with chronic obstructive pulmonary disease"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Thiopentone can be <strong>safely</strong> administered in a patient with <strong>raised intracranial tension</strong>, i.e., brain tumor.</p>\n<p>Thiopentone is <strong>cerebroprotective</strong> as it reduces CSF volume by facilitating its absorption. It also decreases cerebral blood flow, cerebral blood volume and helps in <strong>lowering intracranial pressure</strong>.</p>\n<p>The other options are <strong>contraindications</strong> to the use of thiopentone.</p>\n<p>Option B: Thiopentone induces aminolevulinic acid synthetase, which increases the formation of porphyrins. This precipitate porphyria attacks, especially acute intermittent porphyria or variegate porphyria in susceptible individuals.</p>\n<p>Option C:&nbsp;Thiopentone should be avoided in hypovolemic or shock patients because of the significant reduction in cardiac output (69%) and arterial blood pressure due to vasodilation and venous pooling.</p>\n<p>Option D: Thiopentone produces dose-related central respiratory depression, producing a characteristic ventilatory pattern called 'double apnea'.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "On administration of intravenous thiopentone for induction, a patient loses consciousness in less than thirty seconds. Which of the following is the reason for its rapid onset of action?",
    "choices": [
      {
        "id": 1,
        "text": "Low lipid solubility"
      },
      {
        "id": 2,
        "text": "Rapid redistribution"
      },
      {
        "id": 3,
        "text": "High amount of ionized fraction"
      },
      {
        "id": 4,
        "text": "High amount of unionized fraction"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: left;\"><strong>Thiopentone</strong> has a <strong>rapid onset</strong> of action due to the&nbsp;<strong>high</strong><strong>&nbsp;unionized fraction</strong>&nbsp;and&nbsp;<strong>high lipid solubility.</strong></p>\n<p style=\"text-align: left;\">Only the <strong>unionized</strong> form can cross the <strong>blood-brain barrier</strong> and exert its action (within 30 s).</p>\n<p style=\"text-align: left;\">Rapid redistribution is responsible for the termination of action of thiopentone. i.e., it governs the duration of the action, not the onset.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the statement regarding the drug given below is incorrect?",
    "choices": [
      {
        "id": 1,
        "text": "Rapid onset and ultrashort duration of action"
      },
      {
        "id": 2,
        "text": "Produces adequate analgesia"
      },
      {
        "id": 3,
        "text": "Contraindicated in status asthmaticus"
      },
      {
        "id": 4,
        "text": "Cerebroprotective"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Thiopentone <strong>does not produce analgesia</strong> and may even produce anti-analgesia by reducing the pain threshold.</p>\n<p>Option A: Thiopentone has a <strong>rapid onset</strong> of action (within 30 s) due to high lipid solubility and a high unionized fraction (60%). It has an&nbsp;<strong>ultra-short</strong> duration of action (within 20 mins) due to rapid redistribution.</p>\n<p>Option C: Thiopentone does not completely suppress airway responses to laryngoscopy and intubation and may lead to bronchospasm in asthmatics.&nbsp;</p>\n<p>Option D: Thiopentone is <strong>cerebroprotective </strong>as it&nbsp;reduces CSF volume by facilitating its absorption. It decreases cerebral blood flow and cerebral blood volume, thus lowering intracranial pressure. It also has an <strong>anticonvulsant</strong> property which is advantageous in neurosurgical patients who are at increased risk of seizures.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d43519b3e4a545888fe5975788ce5da2.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A middle-aged woman diagnosed with major depressive disorder associated with suicidal thoughts is scheduled to receive electroconvulsive therapy. What is the anesthetic agent of choice for her procedure?",
    "choices": [
      {
        "id": 1,
        "text": "Thiopentone"
      },
      {
        "id": 2,
        "text": "Methohexitone"
      },
      {
        "id": 3,
        "text": "Pentobarbitone"
      },
      {
        "id": 4,
        "text": "Lorazepam"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Intravenous <strong>methohexital</strong> is the agent of choice for providing anesthesia during <strong>electroconvulsive therapy</strong> (ECT).&nbsp;</p>\n<p>Methohexital can <strong>induce seizures</strong> and has a <strong>rapid recovery.</strong> It is also useful in <strong>identifying epileptic foci</strong> during surgery for resistant seizures.</p>\n<p>Note: According to Mental Health Care Act (MHCA) 2017, ECT should be performed only after administering a short-acting general anesthetic along with muscle relaxants. This method is known as modified ECT.</p>\n<div class=\"page\" title=\"Page 643\">&nbsp;</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following barbiturates is not completely eliminated by the liver?",
    "choices": [
      {
        "id": 1,
        "text": "Thiopentone"
      },
      {
        "id": 2,
        "text": "Phenobarbitone"
      },
      {
        "id": 3,
        "text": "Thiamylal"
      },
      {
        "id": 4,
        "text": "Methohexital"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Phenobarbitone</strong> is not completely eliminated by the liver. 25% to 50% of the drug is excreted by the kidneys in an unchanged form.</p>\n<p>All <strong>barbiturates </strong>(thiopentone, thiamylal, methohexital)<strong>&nbsp;</strong>other than phenobarbitone are completely eliminated by<strong>&nbsp;</strong>the liver.&nbsp;</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A school student is brought to the casualty unresponsive following trauma to the head. The NCCT image is shown below. Which drug would you prefer for induction of anesthesia in him?",
    "choices": [
      {
        "id": 1,
        "text": "Ketamine"
      },
      {
        "id": 2,
        "text": "Halothane"
      },
      {
        "id": 3,
        "text": "Nitrous oxide"
      },
      {
        "id": 4,
        "text": "Thiopentone"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The imaging suggests an <strong>extradural hemorrhage</strong> (EDH). <strong>Thiopentone</strong> is preferred for induction of anesthesia in <strong>head injury.</strong></p>\n<p>Thiopentone is&nbsp;<strong>cerebroprotective,&nbsp;</strong>as it decreases cerebral blood flow (CBF), thus lowering intracranial pressure (ICP). It reduces cerebral oxygen consumption (decreased CMRO<sub>2</sub>). It also has an anticonvulsant property which is advantageous in neurosurgical patients who are at increased risk of seizures.</p>\n<table style=\"height: 103px; width: 390px;\">\n<tbody>\n<tr>\n<td style=\"width: 107.922px;\">&nbsp;</td>\n<td style=\"width: 60.5938px; text-align: center;\"><strong>CBF</strong></td>\n<td style=\"width: 62.7812px; text-align: center;\"><strong>ICP</strong></td>\n<td style=\"width: 60.1094px; text-align: center;\"><strong>CMRO<sub>2</sub></strong></td>\n<td style=\"width: 64.5938px; text-align: center;\"><strong>Seizure</strong></td>\n</tr>\n<tr>\n<td style=\"width: 107.922px;\"><strong>Thiopentone</strong></td>\n<td style=\"width: 60.5938px; text-align: center;\">&darr;&darr;&darr;</td>\n<td style=\"width: 62.7812px; text-align: center;\">&darr;&darr;&darr;</td>\n<td style=\"width: 60.1094px; text-align: center;\">&darr;&darr;&darr;</td>\n<td style=\"width: 64.5938px; text-align: center;\">&darr;&darr;&darr;</td>\n</tr>\n<tr>\n<td style=\"width: 107.922px;\"><strong>Ketamine</strong></td>\n<td style=\"width: 60.5938px; text-align: center;\">&uarr;&uarr;</td>\n<td style=\"width: 62.7812px; text-align: center;\">&uarr;&uarr;</td>\n<td style=\"width: 60.1094px; text-align: center;\">&uarr;</td>\n<td style=\"width: 64.5938px; text-align: center;\">&uarr;</td>\n</tr>\n<tr>\n<td style=\"width: 107.922px;\"><strong>Halothane</strong></td>\n<td style=\"width: 60.5938px; text-align: center;\">&uarr;&uarr;</td>\n<td style=\"width: 62.7812px; text-align: center;\">&uarr;&uarr;</td>\n<td style=\"width: 60.1094px; text-align: center;\">&darr;</td>\n<td style=\"width: 64.5938px; text-align: center;\">&darr;</td>\n</tr>\n<tr>\n<td style=\"width: 107.922px;\"><strong>Nitrous oxide</strong></td>\n<td style=\"width: 60.5938px; text-align: center;\">&uarr;</td>\n<td style=\"width: 62.7812px; text-align: center;\">&uarr;</td>\n<td style=\"width: 60.1094px; text-align: center;\">&uarr;</td>\n<td style=\"width: 64.5938px; text-align: center;\">&darr;&nbsp;</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/be48d8c17d4b421bb2e752e37fe3e621.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "You administer intravenous thiopentone for induction in a patient. As soon as you inject the drug, the patient complains of excruciating pain in his fingers with burning sensation. Fingers turned pale initially and soon became cyanosed. What will be your next step in the management of this situation?",
    "choices": [
      {
        "id": 1,
        "text": "Administer saline"
      },
      {
        "id": 2,
        "text": "Administer heparin"
      },
      {
        "id": 3,
        "text": "Administer lidocaine"
      },
      {
        "id": 4,
        "text": "Remove the needle immediately"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical features of severe pain with burning sensation and cyanosis of fingers point to <strong>accidental intra-arterial administration</strong> of thiopentone.&nbsp;<strong>Saline</strong> administration <strong>via the same needle</strong> to dilute the drug should be the first step in managing this case.&nbsp;</p>\n<p>Intra-arterial injection of thiopentone <strong>can form crystals</strong> in the arterioles and capillaries, causing severe vasoconstriction, <strong>thrombosis</strong> and even <strong>gangrene</strong>. The degree of gangrene corresponds to the concentration of the drug.</p>\n<p>Treatment:</p>\n<ul>\n<li style=\"text-align: left;\">The <strong>needle should not be removed</strong> as it can aggravate vasospasm</li>\n<li style=\"text-align: left;\">Saline administered via the same needle to dilute the drug</li>\n<li style=\"text-align: left;\"><strong>Heparin </strong>to prevent thrombosis</li>\n<li style=\"text-align: left;\">Papaverine and lidocaine</li>\n<li style=\"text-align: left;\"><strong>Brachial plexus block</strong> or <strong>stellate ganglion block&nbsp;</strong>to relieve vasospasm</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the main goal of pre-medication prior to surgery?",
    "choices": [
      {
        "id": 1,
        "text": "Decrease secretions"
      },
      {
        "id": 2,
        "text": "Reduce postoperative nausea and vomiting"
      },
      {
        "id": 3,
        "text": "Diminish anxiety"
      },
      {
        "id": 4,
        "text": "Prevent aspiration"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The<strong> m<strong>ain goal</strong> </strong>of premedication is to<strong>&nbsp;d<strong>iminish anxiety.</strong></strong></p>\n<p>Preoperative medication may also provide relief of <strong>preoperative pain</strong> or <strong>perioperative amnesia.</strong></p>\n<p><strong>Indications for preoperative medication:</strong></p>\n<ul>\n<li>Prophylaxis against postoperative <strong>nausea</strong> and <strong>vomiting</strong> (5-HT3s)</li>\n<li>Prophylaxis against <strong>aspiration pneumonia</strong> (eg, antacids)</li>\n<li>Prevention of <strong>allergic</strong> reactions (eg, antihistamines)</li>\n<li><strong>Decreasing</strong> upper airway <strong>secretions</strong> (eg, anticholinergics)</li>\n</ul>\n<p>Some medications that are given preoperatively (e.g., opioids) decrease anaesthetic requirements and can cause smooth induction.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs should be avoided in patients with bronchial asthma?",
    "choices": [
      {
        "id": 1,
        "text": "Propofol"
      },
      {
        "id": 2,
        "text": "Ketamine"
      },
      {
        "id": 3,
        "text": "Etomidate"
      },
      {
        "id": 4,
        "text": "Thiopental"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Histamine release</strong> is more <strong>commonly </strong>seen with&nbsp;barbiturates like&nbsp;<strong>thiopental</strong> and methohexital.&nbsp;Hence thiopental&nbsp;should be<strong> avoided</strong> in patients with bronchial asthma to<strong> prevent wheezing</strong>.</p>\n<p>Barbiturates increase histamine release from mast cells and produce a higher incidence of wheezing when compared to propofol.</p>\n<p>Note: Thiopental and methohexital are ultra-short acting barbiturates indicated for the induction of anesthesia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 4-year-old child planned for an MRI requires to be sedated. Which short-acting benzodiazepine is to be ideally administered for this purpose?",
    "choices": [
      {
        "id": 1,
        "text": "Diazepam"
      },
      {
        "id": 2,
        "text": "Lorazepam"
      },
      {
        "id": 3,
        "text": "Midazolam"
      },
      {
        "id": 4,
        "text": "Temazepam"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The shortest-acting benzodiazepine among the given options is <strong>midazolam.\u00a0</strong>It is administered as a <strong>pre-medication</strong> in <strong>children</strong> having separation anxiety before procedures or in short procedures requiring <strong>sedation.</strong>\u00a0</p>\n<p>The benzodiazepines used in anesthesia are classified according to their metabolism and plasma clearance as follows:</p>\n<ul>\n<li>Ultra-short acting - Remimazolam (FDA-approved for procedural sedation\u2264<strong>\u00a0</strong>30 mins\u00a0in adults)</li>\n<li>Short-acting agent - Midazolam</li>\n<li>Intermediate-acting agents - Lorazepam, temazepam</li>\n<li>Long-acting agent - Diazepam</li>\n</ul>\n<p>Midazolam is the <strong>benzodiazepine of choice</strong> for<strong> induction</strong> of anesthesia. The onset of anesthesia is within 30 to 60 seconds.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Benzodiazepines are administered to a patient as pre-medication, per the anesthesia orders. These drugs have all the following effects except:",
    "choices": [
      {
        "id": 1,
        "text": "Allay anxiety"
      },
      {
        "id": 2,
        "text": "Analgesia"
      },
      {
        "id": 3,
        "text": "Muscle relaxation"
      },
      {
        "id": 4,
        "text": "Perioperative amnesia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Benzodiazepines <strong>do not produce analgesia</strong>, and so, they must be used with other anesthetic drugs to provide sufficient analgesia.</p>\n<p>Benzodiazepines are the most commonly administered drugs for premedication. They act through<strong> GABA A receptors</strong>:</p>\n<ul>\n<li><strong>\u03b1</strong><strong>1 subunit -</strong>\u00a0sedation, anterograde amnesia (retrograde memory unaffected) and anticonvulsant action</li>\n<li><strong>\u03b1</strong><strong>2 subunit</strong>\u00a0- anxiolysis and muscle relaxation</li>\n</ul>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Remimazolam is administered to a 44-year-old man prior to an esophagogastroduodenoscopy. Which of the following statements is incorrect regarding the drug?",
    "choices": [
      {
        "id": 1,
        "text": "Can be used for procedures thirty minutes or less"
      },
      {
        "id": 2,
        "text": "Faster acting than midazolam"
      },
      {
        "id": 3,
        "text": "Metabolized by nonspecific  esterases"
      },
      {
        "id": 4,
        "text": "New GABA-B receptor agonist"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Remimazolam</strong> is a new <strong> GABA-A </strong>receptor <strong>agonist.</strong></p>\n<p>It combines the properties of two unique drugs - midazolam and remifentanil.&nbsp;It acts on GABA-A receptors like midazolam and has organ independent metabolism like remifentanil.</p>\n<p>It is an <strong>ultra-short-acting</strong> intravenous benzodiazepine, which is rapidly degraded in plasma by<strong> nonspecific esterases</strong> to its carboxylic acid metabolite CNS 7054.</p>\n<p>It has a rapid onset of action, greater depth of sedation, and more rapid recovery than with midazolam.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following can be used as an intravenous induction agent?",
    "choices": [
      {
        "id": 1,
        "text": "Lorazepam"
      },
      {
        "id": 2,
        "text": "Bupivacaine"
      },
      {
        "id": 3,
        "text": "Dexmedetomidine"
      },
      {
        "id": 4,
        "text": "Neostigmine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Lorazepam</strong> is a benzodiazepine that can be used for <strong>induction of anesthesia </strong>at a dose of 0.1mg/kg, although <strong>midazolam</strong> is <strong>preferred</strong> among benzodiazepines.</p>\n<p>Benzodiazepines are mainly used for <strong>sedation</strong> and less commonly for induction of anesthesia due to the availability of better induction agents (propofol, etomidate, ketamine, and thiopentone).</p>\n<p>Dexmedetomidine is a selective alpha-2 agonist and is used primarily as an adjuvant. So, a better option would be lorazepam.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Overdose with which of the following drugs can be reversed with flumazenil?",
    "choices": [
      {
        "id": 1,
        "text": "Barbiturates"
      },
      {
        "id": 2,
        "text": "Benzodiazepines"
      },
      {
        "id": 3,
        "text": "Opioids"
      },
      {
        "id": 4,
        "text": "Amphetamines"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Flumazenil </strong>is the first<strong> benzodiazepine antagonist </strong>approved for<strong> clinical use </strong>to reverse the effects of benzodiazepines.</p>\n<p>It is a<strong> competitive reversible</strong> antagonist at the benzodiazepine receptor with high affinity and specificity.</p>\n<p>Flumazenil is used for both diagnostic and therapeutic reversal of benzodiazepine receptor agonists.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is incorrect concerning the drug in the image below?",
    "choices": [
      {
        "id": 1,
        "text": "Predisposes to systemic infections"
      },
      {
        "id": 2,
        "text": "Associated with pancreatitis"
      },
      {
        "id": 3,
        "text": "Reduces postoperative nausea and vomiting"
      },
      {
        "id": 4,
        "text": "Contraindicated in egg allergic patients"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Propofol is <strong>not contraindicated</strong> in <strong>egg allergy</strong> patients.</p>\n<p>Propofol is formulated as an oil-in-water emulsion, which contains soybean oil, glycerol, and egg lecithin. Usually, egg allergies are a reaction to <strong>egg white</strong> (egg<strong> albumin</strong>). But,&nbsp;<strong>propofol </strong>contains egg<strong> lecithin,&nbsp;</strong>which is extracted from egg<strong> yolk,</strong> and so, propofol is not necessarily contraindicated in patients with a history of egg allergy.</p>\n<p>Propofol has been associated with life-threatening<strong> systemic infections</strong> because it decreases polymorphonuclear leukocyte chemotaxis, but not adherence phagocytosis and killing. It inhibits phagocytosis and killing of <em>Staphylococcus aureus </em>and <em>Escherichia coli. </em></p>\n<p>Propofol is associated with <strong>hypertriglyceridemia</strong> which can predispose to <strong>pancreatitis.</strong></p>\n<p>It has antiemetic properties which help in reducing the incidence of post operative nausea and vomiting.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d4738d0221eb49c0b0c4902e4d25e642.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Bacterial contamination of drug vials is a risk with ___________.",
    "choices": [
      {
        "id": 1,
        "text": "Thiopentone"
      },
      {
        "id": 2,
        "text": "Etomidate"
      },
      {
        "id": 3,
        "text": "Propofol"
      },
      {
        "id": 4,
        "text": "Ketamine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Bacterial contamination</strong>&nbsp;of vials is a risk with <strong>propofol.&nbsp;</strong></p>\n<p>Propofol formulations contain egg lecithin and soyabean oil. The <strong>egg</strong>&nbsp;is a good medium for <strong>bacterial growth</strong> and the lack of preservatives supports the growth of bacteria which can lead to sepsis or even death.</p>\n<p>Hence, propofol must be used<strong> within 6 hours&nbsp;</strong>of opening the ampule.</p>\n<p>Nowadays, certain additives like 0.005% disodium edetate or 0.025% sodium metabisulfite have been added to propofol formulations so as to retard the rate of growth of microorganisms.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is incorrect regarding propofol?",
    "choices": [
      {
        "id": 1,
        "text": "Hypotension following induction"
      },
      {
        "id": 2,
        "text": "Severe pruritis following injection"
      },
      {
        "id": 3,
        "text": "Pain on injection"
      },
      {
        "id": 4,
        "text": "Depresses airway reflexes"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Propofol has <strong>antipruritic properties</strong>. It can also relieve cholestatic pruritus and may be as effective as naloxone in treating pruritus induced by spinal opiates.</p>\n<p>Option A:&nbsp;Propofol produces a 25% to 40% <strong>reduction</strong> in<strong> systolic blood pressure</strong> following injection.</p>\n<p>Option C:&nbsp;Propofol is formulated as a lipid emulsion that causes<strong> pain</strong> during injection. This can be decreased by using a large vein, avoiding veins in the dorsum of the hand, prior injection of lidocaine or by mixing lidocaine with propofol prior to injection (2 mL of 1% lidocaine in 18 mL propofol).</p>\n<p>Option D:&nbsp;Propofol produces maximum inhibition of airway reflexes and can facilitate intubation, endoscopy, or laryngeal mask placement without neuromuscular blockade.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You decide to use a prodrug of propofol for a bronchoscopy under conscious sedation. Which of the following is an incorrect statement regarding this drug?",
    "choices": [
      {
        "id": 1,
        "text": "Water soluble"
      },
      {
        "id": 2,
        "text": "Faster acting than propofol"
      },
      {
        "id": 3,
        "text": "No pain on injection"
      },
      {
        "id": 4,
        "text": "Less incidence of hypotension and apnea"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Fospropofol</strong> is a <strong>water-soluble prodrug</strong> of propofol that has a <strong>slower onset</strong>&nbsp;and <strong>slower recovery </strong>than propofol.&nbsp;It is hydrolyzed to propofol, phosphate, and formaldehyde.&nbsp;</p>\n<p>Fospropofol is advantageous since it is not associated with pain on injection.&nbsp;</p>\n<p>Fospropofol is approved for sedation during local and regional anesthesia e.g., conscious sedation and monitored anesthesia care.&nbsp;Due to its slower onset of sedation, it is associated with a lower incidence of hypotension, respiratory depression, apnea, and loss of airway patency.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following anesthetics have high abuse potential?",
    "choices": [
      {
        "id": 1,
        "text": "Etomidate"
      },
      {
        "id": 2,
        "text": "Thiopentone"
      },
      {
        "id": 3,
        "text": "Methohexital"
      },
      {
        "id": 4,
        "text": "Propofol"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Propofol</strong> is an intravenous induction agent that can be <strong>addictive</strong> because of its <strong>hypnotic</strong> property and development of <strong>tolerance</strong> on prolonged use.&nbsp;</p>\n<p>The abuse potential is common among health care workers with reports of self-administration. There is only a <strong>narrow therapeutic window</strong> between the hypnotic, euphoric effect of propofol and its lethal dose. When exceeded, it can cause airway obstruction, respiratory depression, hypoxia or an unstable hemodynamic response leading to <strong>death</strong>.</p>\n<p>Note:&nbsp;<strong>Ketamine</strong> also has the potential for abuse and addiction.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A critically ill patient was given an infusion of an intravenous anesthetic at a dose of 4mg/kg/hour. 48 hours later, the patient developed refractory bradycardia, and there was evidence of rhabdomyolysis on investigations. Which agent is most likely implicated?",
    "choices": [
      {
        "id": 1,
        "text": "Thiopentone"
      },
      {
        "id": 2,
        "text": "Propofol"
      },
      {
        "id": 3,
        "text": "Etomidate"
      },
      {
        "id": 4,
        "text": "Ketamine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given features point towards a diagnosis of <strong>propofol infusion syndrome</strong>. It is a <strong>rare</strong> but <strong>lethal</strong> syndrome seen when the dose of propofol infusion is <strong>&gt; 4 mg/kg/hour</strong> for<strong> 48 hours </strong>or longer.</p>\n<p>This syndrome is common in children and critically ill adults.</p>\n<p>Clinical features:</p>\n<ul>\n<li>Acute refractory <strong>bradycardia</strong> leading to asystole in the presence of one or more of the following:\n<ul>\n<li>Metabolic acidosis (base deficit &gt;10 mmol/L)</li>\n<li>Rhabdomyolysis</li>\n<li>Hyperlipidemia</li>\n<li>Enlarged or fatty liver</li>\n</ul>\n</li>\n<li>Other features -&nbsp;&nbsp;cardiomyopathy with acute cardiac failure, skeletal myopathy, hyperkalemia, hepatomegaly, and lipemia.</li>\n</ul>\n<p>The symptoms and signs are the results of muscle injury and the release of intracellular toxic contents. It is due to defect in<strong> mitochondrial metabolism </strong>and <strong>electron transport chain </strong>function.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Two days after he underwent a gastrectomy, a patient complained of severe abdominal pain, nausea, and vomiting.  Labs showed elevated serum amylase and lipase levels. CECT showed diffuse parenchymal enlargement of the pancreas. Administration of which of the following anesthetics is implicated here?",
    "choices": [
      {
        "id": 1,
        "text": "Propofol"
      },
      {
        "id": 2,
        "text": "Etomidate"
      },
      {
        "id": 3,
        "text": "Thiopentone"
      },
      {
        "id": 4,
        "text": "Ketamine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario is suggestive of&nbsp;<strong>acute pancreatitis</strong>, which can be predisposed by the administration of&nbsp;<strong>propofol.</strong>&nbsp;</p>\n<p>Propofol has been associated with <strong>hypertriglyceridemia,</strong> which may predispose the patient to pancreatitis.</p>\n<p>Risk factors for propofol-induced hypertriglyceridemia:</p>\n<ul>\n<li>Old age</li>\n<li>Longer ICU stay</li>\n<li>Received propofol for a longer duration.</li>\n</ul>\n<p>It is essential to monitor serum triglyceride levels when propofol is used for a prolonged duration or at higher infusion rates (especially in older patients).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following findings would not be seen in a patient with propofol infusion syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Bradycardia"
      },
      {
        "id": 2,
        "text": "Cardiac failure"
      },
      {
        "id": 3,
        "text": "Hyperlipidemia"
      },
      {
        "id": 4,
        "text": "Hypokalemia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Propofol infusion syndrome</strong> is associated with <strong>rhabdomyolysis</strong> which leads to <strong>h</strong><strong>yperkalemia.&nbsp;</strong></p>\n<p>Propofol infusion syndrome is a rare but lethal syndrome due to a defect in<strong> mitochondrial metabolism&nbsp;</strong>and&nbsp;<strong>electron transport chain&nbsp;</strong>function. It is seen when the dose of propofol infusion is greater than<strong>&nbsp;4mg/kg/hour </strong>for <strong>48 hours&nbsp;</strong>or longer.</p>\n<p>Clinical features:</p>\n<ul>\n<li>Acute refractory&nbsp;bradycardia&nbsp;leading to asystole in the presence of one or more of the following:\n<ul>\n<li>Metabolic acidosis&nbsp;(base deficit &gt;10 mmol/L)</li>\n<li>Rhabdomyolysis</li>\n<li>Hyperlipidemia</li>\n<li>Enlarged or fatty liver</li>\n</ul>\n</li>\n<li>Other features -&nbsp;&nbsp;cardiomyopathy with acute cardiac failure, skeletal myopathy, hyperkalemia, hepatomegaly, and lipemia.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which one of the following anesthetic agents shows the Robin Hood phenomenon?",
    "choices": [
      {
        "id": 1,
        "text": "Propofol"
      },
      {
        "id": 2,
        "text": "Etomidate"
      },
      {
        "id": 3,
        "text": "Ketamine"
      },
      {
        "id": 4,
        "text": "Thiopentone"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Robin Hood</strong> or<strong> reverse steal </strong>phenomenon is seen with<strong> thiopentone</strong>.</p>\n<p>Thiopentone <strong>constricts</strong> the <strong>cerebral vasculature,</strong> causing a decrease in cerebral blood flow, cerebral blood volume, and intracranial pressure. However, this vasoconstriction occurs only in <strong>normal areas.</strong>&nbsp;The blood vessels in the ischemic area remain dilated due to <strong>ischemia-induced vasomotor paralysis</strong> and are unaffected by thiopentone. This leads to <strong>redistribution </strong>of blood flow from <strong>normal to ischemic </strong>areas in the brain.&nbsp;This is called the Robin Hood phenomenon.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is true about total intravenous anesthesia?",
    "choices": [
      {
        "id": 1,
        "text": "Reduces cerebral metabolism and cerebral blood flow"
      },
      {
        "id": 2,
        "text": "Smooth induction with high incidence of post operative nausea and vomiting"
      },
      {
        "id": 3,
        "text": "Propofol inhibits pulmonary vasoconstriction d/t hypoxia"
      },
      {
        "id": 4,
        "text": "Higher chances of nephrotoxicity and pulmonary toxicity"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Total intravenous anesthesia results in<strong>&nbsp;reduced cerebral metabolism</strong>&nbsp;and<strong> cerebral blood flow.&nbsp;</strong>The most commonly used agent is<strong> propofol.&nbsp;</strong></p>\n<p><strong>Advantages</strong> of <strong>TIVA</strong> over inhaled anesthetics:</p>\n<ul>\n<li>Smooth induction and rapid recovery with a minimal hangover</li>\n<li>Low incidence of nausea and vomiting</li>\n<li>Safe in patients susceptible to malignant hyperpyrexia&nbsp;</li>\n<li>Reduced greenhouse effect of inhalational anesthesia</li>\n<li>Paralysis is not always required, reversal agents can be avoided and emergence is rapid (especially in propofol TIVA with remifentanil).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not an intravenous induction agent?",
    "choices": [
      {
        "id": 1,
        "text": "Propofol"
      },
      {
        "id": 2,
        "text": "Thiopentone"
      },
      {
        "id": 3,
        "text": "Etomidate"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Halothane is an <strong>inhalational</strong> agent which is a halogenated alkane. Induction with halothane is relatively <strong>slow </strong>due to its <strong>high blood: gas partition coefficient </strong>(2.5).</p>\n<p>Intravenous induction agents:</p>\n<ul>\n<li>Propofol is the most commonly used intravenous anesthetic.</li>\n<li>Thiopentone is the intravenous agent of choice to provide cerebral protection.</li>\n<li>Etomidate is the intravenous agent of choice to maintain cardiovascular stability in patients with coronary artery disease, cardiomyopathy and cerebral vascular disease.</li>\n<li>Ketamine is the intravenous agent of choice in asthmatics.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '16 Intravenous Anesthesia - Barbiturates, Benzodiazepines & Propofol';
        const quizFilename = '16-intravenous-anesthesia-barbiturates-benzodiazepines-propofol-99bd8a69.html';
        let hierarchy = ["Marrow", "qBank", "Anesthesia"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>