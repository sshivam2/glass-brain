<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27  Hepatobiliary System - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        DAMS / DQB / Anatomy
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">25</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "id": 50000,
    "choices": [
      {
        "id": 200000,
        "text": "L1"
      },
      {
        "id": 200001,
        "text": "L3"
      },
      {
        "id": 200002,
        "text": "S1"
      },
      {
        "id": 200003,
        "text": "S3"
      }
    ],
    "text": "Fundus of gallbladder at which vertebral level:",
    "unique_key": "Q3971702",
    "question_audio": null,
    "question_video": null,
    "map_id": 34082976,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) L1. Explanation for the Correct Answer: A. L1: The fundus of the gallbladder is typically located at the level of the L1 vertebra. It lies in the right upper quadrant of the abdomen and corresponds to the tip of the 9th costal cartilage, which is approximately at the L1 vertebral level. This location is significant in clinical practice, as it helps in the identification of the gallbladder during imaging studies. Explanation for Incorrect Answers: B. L3: The L3 vertebral level corresponds more closely to the lower abdomen. The gallbladder is located in the right upper quadrant of the abdomen, and the L3 level would be too low to correspond to the location of the gallbladder\u2019s fundus. C. S1: The S1 vertebral level is located in the sacral region, which is lower than the location of the gallbladder. The gallbladder is found in the upper abdomen, well above the sacral region. D. S3: The S3 vertebral level is even lower in the sacral region and does not correspond to the location of the gallbladder. As mentioned, the gallbladder is located at a much higher vertebral level, around L1.",
    "correct_choice_id": 200000,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/54536811697972665/54536811697972665.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/54536811697972665/54536811697972665.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50001,
    "choices": [
      {
        "id": 200004,
        "text": "Head"
      },
      {
        "id": 200005,
        "text": "Neck"
      },
      {
        "id": 200006,
        "text": "Body"
      },
      {
        "id": 200007,
        "text": "Uncinate process"
      }
    ],
    "text": "Dorsal pancreatic bud does not form one of the following -",
    "unique_key": "Q6957679",
    "question_audio": null,
    "question_video": null,
    "map_id": 34107909,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Uncinate process. Explanation for the Correct Answer: D. Uncinate process: The uncinate process of the pancreas is formed by the ventral pancreatic bud, not the dorsal pancreatic bud. The ventral bud contributes to the head of the pancreas and the uncinate process. During development, the ventral and dorsal pancreatic buds fuse to form the mature pancreas, but the uncinate process, specifically, originates from the ventral bud. Explanation for Incorrect Answers: A. Head: The head of the pancreas is derived from the ventral pancreatic bud but the dorsal pancreatic bud also contributes to the overall pancreatic structure. While the head itself comes primarily from the ventral bud, the entire head region, including parts of the pancreas, is a product of the fusion between both buds. B. Neck: The neck of the pancreas is a part of the fusion zone where the ventral and dorsal pancreatic buds meet. It is formed as a result of this fusion. C. Body: The body of the pancreas is primarily formed by the dorsal pancreatic bud, which also contributes to the tail of the pancreas. The dorsal bud gives rise to the body and tail, while the ventral bud contributes mainly to the head and uncinate process.",
    "correct_choice_id": 200007,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/73939171697972738/73939171697972738.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/73939171697972738/73939171697972738.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50002,
    "choices": [
      {
        "id": 200008,
        "text": "Gall bladder and groove for ligamentum teres"
      },
      {
        "id": 200009,
        "text": "IVC and ligamentum Venosum"
      },
      {
        "id": 200010,
        "text": "Posterior part of left lobe"
      },
      {
        "id": 200011,
        "text": "Anterior superior surface of liver"
      }
    ],
    "text": "Caudate lobe of liver is situated between-",
    "unique_key": "Q2709410",
    "question_audio": null,
    "question_video": null,
    "map_id": 34499641,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) lobe is positioned near the posterior part of the liver and extends around the IVC, making B the correct answer. Explanation for Incorrect Answers: A. Gall bladder and groove for ligamentum teres: The gall bladder is located on the right lobe of the liver, whereas the ligamentum teres is located on the anterior surface of the liver, in the falciform ligament area. These structures are not directly related to the position of the caudate lobe, making A incorrect. C. Posterior part of left lobe: The caudate lobe is not part of the left lobe of the liver, although it is on the posterior surface. The caudate lobe is technically a separate lobe of the liver that is located near the right lobe and is not confined to the posterior part of the left lobe, so C is incorrect. D. Anterior superior surface of liver: The anterior superior surface of the liver is typically where the right and left lobes are located, and it does not correspond to the position of the caudate lobe, which is located more posteriorly.",
    "correct_choice_id": 200009,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/50900751697972883/50900751697972883.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/50900751697972883/50900751697972883.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50003,
    "choices": [
      {
        "id": 200012,
        "text": "Lower end of esophagus"
      },
      {
        "id": 200013,
        "text": "Around umbilicus"
      },
      {
        "id": 200014,
        "text": "Lower third of rectum and anal canal"
      },
      {
        "id": 200015,
        "text": "All of the above"
      }
    ],
    "text": "In portal hypertension the sites of portosystemic anastomosis includes\u2013",
    "unique_key": "Q9020501",
    "question_audio": null,
    "question_video": null,
    "map_id": 34945192,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) All of the above. Explanation for the Correct Answer: D. All of the above: In portal hypertension, the increased pressure in the portal venous system leads to the development of portosystemic anastomoses, where blood flows through collateral vessels that bypass the liver. These anastomoses commonly occur in three key areas: Lower end of the esophagus: This is where esophageal varices develop, which are prominent in portal hypertension. Around the umbilicus: This area, known as the caput medusae, is where veins around the umbilicus become engorged due to the bypassing of blood through the portal system. Lower third of the rectum and anal canal: Hemorrhoidal varices occur here, due to the anastomosis between the superior rectal vein (which drains into the portal system) and the middle and inferior rectal veins (which drain into the systemic venous system). Thus, all three locations listed (lower end of esophagus, around the umbilicus, and lower third of the rectum and anal canal) are common sites for portosystemic anastomoses in portal hypertension, making D the correct answer. Explanation for Incorrect Answers: A. Lower end of esophagus: While the lower end of the esophagus is indeed one of the sites for portosystemic anastomosis, it is not the only site. This is a part of the esophageal varices and does not represent the complete answer, so A alone is not sufficient. B. Around umbilicus: This is another important site for portosystemic anastomoses (caput medusae) due to increased pressure in the portal venous system, but it also doesn't encompass all sites involved in portal hypertension, so B alone is not the correct choice. C. Lower third of rectum and anal canal: Hemorrhoidal varices can develop here as a result of portal hypertension, but again, this is only one of the three major sites for anastomoses. C alone doesn't cover the other areas involved in portal hypertension.",
    "correct_choice_id": 200015,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/62752331697972948/62752331697972948.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/62752331697972948/62752331697972948.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50004,
    "choices": [
      {
        "id": 200016,
        "text": "Ligamentum teres"
      },
      {
        "id": 200017,
        "text": "Ligamentum venosum"
      },
      {
        "id": 200018,
        "text": "Bile duct and portal vein"
      },
      {
        "id": 200019,
        "text": "Superior epigastric artery"
      }
    ],
    "text": "Falciform ligament contains -",
    "unique_key": "Q5446855",
    "question_audio": null,
    "question_video": null,
    "map_id": 34919155,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Ligamentum teres. Explanation for the Correct Answer: A. Ligamentum teres: The falciform ligament contains the ligamentum teres, which is the remnant of the fetal umbilical vein. This ligament connects the anterior surface of the liver to the anterior abdominal wall and the diaphragm. It is a part of the falciform ligament and plays a key role in the fetal circulation but has no significant function after birth, though it remains as a ligament. Explanation for Incorrect Answers: B. Ligamentum venosum: The ligamentum venosum is a different structure. It is the remnant of the fetal ductus venosus, which allowed blood to bypass the liver during fetal development. It is found on the posterior part of the liver and is not contained within the falciform ligament. C. Bile duct and portal vein: The bile duct and portal vein are structures located in the porta hepatis of the liver, but they are not contained within the falciform ligament. The falciform ligament primarily contains the ligamentum teres and does not house these vessels. D. Superior epigastric artery: The superior epigastric artery is a branch of the internal thoracic artery and supplies the anterior abdominal wall. It runs in the anterior abdominal wall but does not pass through the falciform ligament.",
    "correct_choice_id": 200016,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/24644951697972975/24644951697972975.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/24644951697972975/24644951697972975.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50005,
    "choices": [
      {
        "id": 200020,
        "text": "Falciform ligament"
      },
      {
        "id": 200021,
        "text": "Coronary ligament"
      },
      {
        "id": 200022,
        "text": "Lesser omentum"
      },
      {
        "id": 200023,
        "text": "Gastrosplenic ligament"
      }
    ],
    "text": "Ventral mesogastrium derivatives include A/E",
    "unique_key": "Q8022168",
    "question_audio": null,
    "question_video": null,
    "map_id": 34928919,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Gastrosplenic ligament. Explanation for the Correct Answer: D. Gastrosplenic ligament: The gastrosplenic ligament is derived from the dorsal mesogastrium, not the ventral mesogastrium. This ligament connects the stomach to the spleen and is formed from the dorsal mesogastrium during embryological development. Therefore, it is not derived from the ventral mesogastrium, making D the correct answer as it is the exception in this list. Explanation for Incorrect Answers: A. Falciform ligament: The falciform ligament is indeed derived from the ventral mesogastrium. It connects the anterior surface of the liver to the anterior abdominal wall and diaphragm. This ligament is an important structure derived from the ventral mesogastrium during fetal development. B. Coronary ligament: The coronary ligament is also a derivative of the ventral mesogastrium. It attaches the liver to the diaphragm and forms part of the boundary of the lesser sac. It plays a role in stabilizing the liver in the abdominal cavity. C. Lesser omentum: The lesser omentum is another structure derived from the ventral mesogastrium. It connects the liver to the lesser curvature of the stomach and the first part of the duodenum. It is an important mesenteric structure formed from the ventral mesogastrium.",
    "correct_choice_id": 200023,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/60021011697973264/60021011697973264.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/60021011697973264/60021011697973264.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50006,
    "choices": [
      {
        "id": 200024,
        "text": "Right hepatic artery"
      },
      {
        "id": 200025,
        "text": "Left hepatic artery"
      },
      {
        "id": 200026,
        "text": "Common hepatic artery"
      },
      {
        "id": 200027,
        "text": "Gastroduodenal artery"
      }
    ],
    "text": "Cystic artery arises from \u2013",
    "unique_key": "Q2887151",
    "question_audio": null,
    "question_video": null,
    "map_id": 34188306,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Right hepatic artery. Explanation for the Correct Answer: A. Right hepatic artery: The cystic artery typically arises from the right hepatic artery, which is a branch of the common hepatic artery. The cystic artery supplies blood to the gallbladder and the cystic duct, providing the necessary oxygen and nutrients to these structures. This anatomical relationship is vital during surgeries like cholecystectomy, where the cystic artery is often ligated. Explanation for Incorrect Responses: B. Left hepatic artery: This is incorrect because the cystic artery originates from the right hepatic artery, not the left. The left hepatic artery supplies the left lobe of the liver but does not provide blood to the gallbladder. C. Common hepatic artery: This is incorrect because while the common hepatic artery is the parent artery of the right hepatic artery, the cystic artery arises specifically from the right hepatic artery, not directly from the common hepatic artery itself. D. Gastroduodenal artery: This is incorrect because the gastroduodenal artery is a branch of the common hepatic artery, but it does not give rise to the cystic artery. The gastroduodenal artery primarily supplies the stomach and duodenum.",
    "correct_choice_id": 200024,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/77674751697973576/77674751697973576.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/77674751697973576/77674751697973576.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50007,
    "choices": [
      {
        "id": 200028,
        "text": "Right subphrenic space"
      },
      {
        "id": 200029,
        "text": "Right subhepatic space"
      },
      {
        "id": 200030,
        "text": "Left subhepatic space"
      },
      {
        "id": 200031,
        "text": "Left subphrenic space"
      }
    ],
    "text": "Morrison\u2019s pouch is",
    "unique_key": "Q7280187",
    "question_audio": null,
    "question_video": null,
    "map_id": 34286888,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Right subhepatic space. Explanation for the Correct Answer: B. Right subhepatic space: Morrison's pouch is a part of the right subhepatic space, located between the right lobe of the liver and the right kidney. It is an important anatomical region that can accumulate fluid, particularly in cases of trauma, ascites, or infections. This space is also known as the hepatorenal pouch and is the most dependent part of the abdominal cavity in a supine position. Explanation for Incorrect Responses: A. Right subphrenic space: This statement is incorrect. The right subphrenic space is located between the diaphragm and the liver, above Morrison\u2019s pouch. It does not specifically refer to the region where Morrison's pouch is located. C. Left subhepatic space: This statement is incorrect. The left subhepatic space is the region between the left lobe of the liver and the left kidney. Morrison\u2019s pouch is specifically located on the right side of the body, not the left. D. Left subphrenic space: This statement is incorrect. The left subphrenic space is similar to the right subphrenic space but on the left side of the body. It is located between the diaphragm and the liver on the left side and does not contain Morrison\u2019s pouch.",
    "correct_choice_id": 200029,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/61317001697973667/61317001697973667.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/61317001697973667/61317001697973667.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50008,
    "choices": [
      {
        "id": 200032,
        "text": "Lesser omentum"
      },
      {
        "id": 200033,
        "text": "Greater omentum"
      },
      {
        "id": 200034,
        "text": "Splenorenal ligament"
      },
      {
        "id": 200035,
        "text": "Gastrosplenic ligament"
      }
    ],
    "text": "Portal vein, hepatic artery and common bile duct are related to which of the following structure?",
    "unique_key": "Q3778843",
    "question_audio": null,
    "question_video": null,
    "map_id": 34471934,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Lesser omentum. Explanation for the Correct Answer: A. Lesser omentum: The lesser omentum is a structure in the abdominal cavity that connects the lesser curvature of the stomach and the duodenum to the liver. It contains the portal vein, hepatic artery, and common bile duct, which are collectively referred to as the portal triad. These structures pass through the lesser omentum as they enter or exit the liver, making it the correct answer. Explanation for Incorrect Responses: B. Greater omentum: The greater omentum is a large fold of fatty tissue that hangs down from the greater curvature of the stomach, covering the intestines. It does not contain the portal vein, hepatic artery, or common bile duct, so this option is incorrect. C. Splenorenal ligament: The splenorenal ligament is a ligament that connects the spleen to the left kidney. It contains the splenic vessels but does not contain the portal vein, hepatic artery, or common bile duct. Therefore, this option is incorrect. D. Gastrosplenic ligament: The gastrosplenic ligament connects the stomach to the spleen and contains the short gastric arteries and the left gastroepiploic artery, but not the portal vein, hepatic artery, or common bile duct. Hence, this option is incorrect.",
    "correct_choice_id": 200032,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/41160671697973740/41160671697973740.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/41160671697973740/41160671697973740.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50009,
    "choices": [
      {
        "id": 200036,
        "text": "Portal vein"
      },
      {
        "id": 200037,
        "text": "Hepatic artery"
      },
      {
        "id": 200038,
        "text": "Sinusoids"
      },
      {
        "id": 200039,
        "text": "Hepatic veins"
      }
    ],
    "text": "Venous blood of liver is drained by -",
    "unique_key": "Q9565211",
    "question_audio": null,
    "question_video": null,
    "map_id": 34517667,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Hepatic veins. Explanation for the Correct Answer: D. Hepatic veins: The hepatic veins are responsible for draining venous blood from the liver. After the blood flows through the liver's sinusoids, where it is processed and detoxified, it enters the hepatic veins. These veins eventually drain into the inferior vena cava, which returns the blood to the heart. The hepatic veins are the primary vessels responsible for the venous drainage of the liver. Explanation for Incorrect Responses: A. Portal vein: The portal vein brings blood to the liver, but it carries venous blood from the gastrointestinal tract and spleen to the liver for detoxification and processing. It does not drain blood from the liver; it supplies it. B. Hepatic artery: The hepatic artery provides oxygenated blood to the liver. It is not involved in venous drainage but supplies the liver with the nutrients and oxygen it needs for its metabolic functions. C. Sinusoids: Sinusoids are specialized capillaries within the liver where blood from the portal vein and hepatic artery mixes and undergoes filtration and processing. While sinusoids are involved in the blood flow within the liver, they do not drain the liver. They channel blood into the hepatic veins.",
    "correct_choice_id": 200039,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/61797321697974229/61797321697974229.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/61797321697974229/61797321697974229.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50010,
    "choices": [
      {
        "id": 200040,
        "text": "Right gastric"
      },
      {
        "id": 200041,
        "text": "Left gastric"
      },
      {
        "id": 200042,
        "text": "Hemiazygos"
      },
      {
        "id": 200043,
        "text": "Inferior phrenic"
      }
    ],
    "text": "In portal hypertension lower end of the esophagus may show dilatation of veins. Which of the following veins drains into the portal vein from the lower end of the esophagus:",
    "unique_key": "Q2813531",
    "question_audio": null,
    "question_video": null,
    "map_id": 34259106,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Left gastric. Explanation for the Correct Answer: B. Left gastric vein: The left gastric vein, also known as the coronary vein, is one of the main veins that drain the lower end of the esophagus. It is a tributary of the portal vein and plays a significant role in the venous drainage of the stomach and esophagus. In cases of portal hypertension, the left gastric vein and its tributaries can become engorged and form esophageal varices, which are dilated veins in the lower esophagus. Explanation for Incorrect Responses: A. Right gastric vein: The right gastric vein drains the right side of the stomach and generally drains into the portal vein via the hepatic portal system. However, it does not specifically drain the lower end of the esophagus, which is primarily drained by the left gastric vein. C. Hemiazygos vein: The hemiazygos vein is part of the azygos venous system, which drains the posterior thoracic wall and parts of the esophagus, but it does not drain into the portal vein. The hemiazygos vein eventually drains into the azygos vein, which in turn drains into the superior vena cava. The hemiazygos system does not contribute to the portal circulation. D. Inferior phrenic vein: The inferior phrenic vein drains the diaphragm and does not contribute to the venous drainage of the esophagus or portal venous system. It drains directly into the inferior vena cava.",
    "correct_choice_id": 200041,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/55030201697974344/55030201697974344.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/55030201697974344/55030201697974344.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50011,
    "choices": [
      {
        "id": 200044,
        "text": "Gastroduodenal artery"
      },
      {
        "id": 200045,
        "text": "Superior mesenteric vein"
      },
      {
        "id": 200046,
        "text": "Inferior vena cava"
      },
      {
        "id": 200047,
        "text": "Bile duct"
      }
    ],
    "text": "The neck of pancreas is related on its posterior surface to \u2013",
    "unique_key": "Q3355274",
    "question_audio": null,
    "question_video": null,
    "map_id": 34051802,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Superior mesenteric vein The neck of the pancreas is a short portion of the pancreas that lies anterior to major blood vessels. On its posterior surface, it is closely related to the superior mesenteric vein (SMV), which joins with the splenic vein posterior to the neck to form the portal vein. This anatomical relationship is crucial in understanding both normal vascular anatomy and surgical approaches to the pancreas. Explanation for Incorrect Options: A. Gastroduodenal artery: The gastroduodenal artery runs along the posterior aspect of the first part of the duodenum and does not directly relate to the posterior surface of the pancreatic neck. It supplies parts of the stomach, pancreas, and duodenum but is located more anteriorly. C. Inferior vena cava: The inferior vena cava lies more posteriorly and slightly to the right of the pancreas but does not have a direct relationship with the posterior surface of the neck. It is related more to the posterior abdominal wall. D. Bile duct: The bile duct runs posterior to the head of the pancreas, not the neck. Its relationship is significant during surgeries of the pancreatic head but not for the neck region.",
    "correct_choice_id": 200045,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/64105831697974512/64105831697974512.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/64105831697974512/64105831697974512.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50012,
    "choices": [
      {
        "id": 200048,
        "text": "Hepatic veins alone"
      },
      {
        "id": 200049,
        "text": "Portal vein alone"
      },
      {
        "id": 200050,
        "text": "Hepatic veins and common hepatic artery"
      },
      {
        "id": 200051,
        "text": "Hepatic veins and portal vein"
      }
    ],
    "text": "The segmental division of liver into eight segments is based on-",
    "unique_key": "Q1665452",
    "question_audio": null,
    "question_video": null,
    "map_id": 34956565,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Hepatic veins and portal vein. The segmental division of the liver into eight segments is based on the distribution of the hepatic veins and the portal vein. These veins serve as the primary anatomical landmarks for segmental division. The liver is functionally divided into segments based on the vascular supply and drainage, with the portal vein providing the blood supply to the liver segments and the hepatic veins draining the segments into the inferior vena cava. The eight segments correspond to different regions of the liver, each with its own portal venous inflow and hepatic venous outflow, facilitating precise surgical resection and liver transplantation. Now, for the incorrect options: A. Hepatic veins alone: This option is incorrect because the hepatic veins alone do not define the liver segments. They drain the liver, but the portal vein also plays a critical role in determining the functional anatomy of the segments. The hepatic veins are important for venous drainage, but they do not account for the liver's vascular supply. B. Portal vein alone: This option is also incorrect because although the portal vein is crucial for blood supply, it alone does not define the liver's segments. The hepatic veins are necessary to fully understand the segmentation, as they are responsible for draining the individual segments. C. Hepatic veins and common hepatic artery: This is incorrect as the common hepatic artery is not used to define liver segmentation. The artery supplies blood to the liver, but segmental division relies on the portal venous system and hepatic veins for functional boundaries, not the arterial supply.",
    "correct_choice_id": 200051,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/55816741697974888/55816741697974888.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/55816741697974888/55816741697974888.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50013,
    "choices": [
      {
        "id": 200052,
        "text": "Present at the junction of superior mesentric artery with the splenic artery"
      },
      {
        "id": 200053,
        "text": "Within the portal vein only"
      },
      {
        "id": 200054,
        "text": "The whole system is valveless"
      },
      {
        "id": 200055,
        "text": "In the intrahepatic portion of portal vein."
      }
    ],
    "text": "True about valves in portal venous system -",
    "unique_key": "Q6044305",
    "question_audio": null,
    "question_video": null,
    "map_id": 34339877,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) The whole system is valveless The portal venous system is entirely valveless. This means that there are no valves in the veins of the portal system, including the portal vein itself and its tributaries. The lack of valves allows for unidirectional blood flow toward the liver, where blood from the digestive organs is processed before returning to the heart. Therefore, C is the correct answer. Incorrect Responses: (A) Present at the junction of superior mesenteric artery with the splenic artery There are no valves at the junction of the superior mesenteric artery and the splenic artery. This option describes an anatomical location that does not have any valvular structures. The junction of these arteries forms the celiac trunk, and valves are not located here. Therefore, A is incorrect. (B) Within the portal vein only The portal vein does not contain valves, and thus the statement that valves are present within the portal vein is incorrect. The portal venous system is valveless throughout, including in the portal vein and its tributaries. Therefore, B is incorrect. (D) In the intrahepatic portion of portal vein Even in the intrahepatic portion of the portal vein (the part that runs within the liver), no valves are present. As mentioned earlier, the entire portal venous system is devoid of valves. Therefore, D is incorrect.",
    "correct_choice_id": 200054,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/27117691697975186/27117691697975186.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/27117691697975186/27117691697975186.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50014,
    "choices": [
      {
        "id": 200056,
        "text": "Cystic duct"
      },
      {
        "id": 200057,
        "text": "Cystic artery"
      },
      {
        "id": 200058,
        "text": "Common hepatic artery"
      },
      {
        "id": 200059,
        "text": "Common hepatic duct"
      }
    ],
    "text": "Which one of the following is a content of calots triangle ?",
    "unique_key": "Q9283112",
    "question_audio": null,
    "question_video": null,
    "map_id": 34615910,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Cystic artery The cystic artery is the primary structure found within Calot's triangle, which is the anatomical space located at the junction of the cystic duct, the common hepatic duct, and the lower border of the liver. The cystic artery supplies blood to the gallbladder and is a key structure in this area, making it the correct answer. Incorrect Responses: (A) Cystic duct While the cystic duct is indeed located in the vicinity of Calot's triangle, it is not considered a content of the triangle itself. Instead, it forms part of the boundaries of Calot's triangle, along with the common hepatic duct and the inferior border of the liver. Therefore, the cystic duct is part of the boundary, but not the content, making this option incorrect. (C) Common hepatic artery The common hepatic artery is located near Calot's triangle but does not pass through it. It gives rise to the gastroduodenal artery and the proper hepatic artery but is not a direct content of the triangle. The cystic artery (a branch of the proper hepatic artery) is the artery found within Calot's triangle, making this option incorrect. (D) Common hepatic duct The common hepatic duct is another important structure near Calot's triangle, but it forms the lateral boundary of the triangle, not its content. The content of Calot's triangle is limited to the cystic artery, which supplies the gallbladder, while the common hepatic duct contributes to the boundary.",
    "correct_choice_id": 200057,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/51452641697976235/51452641697976235.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/51452641697976235/51452641697976235.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50015,
    "choices": [
      {
        "id": 200060,
        "text": "2, 3"
      },
      {
        "id": 200061,
        "text": "1, 4b"
      },
      {
        "id": 200062,
        "text": "2, 4a"
      },
      {
        "id": 200063,
        "text": "1, 4a"
      }
    ],
    "text": "A hemangioma was found on the left of the falciform ligament of the liver. Surgeon dissecting Couinaud\u2019s segments of liver to the left of attachment of falciform ligament resects which lobes:",
    "unique_key": "Q3619324",
    "question_audio": null,
    "question_video": null,
    "map_id": 34045407,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) 2, 3. In Couinaud\u2019s liver segmentation system, the liver is divided into eight segments based on the venous drainage, with each segment being functionally independent. The falciform ligament attaches the liver to the anterior abdominal wall, and the area to the left of this ligament includes segments 2 and 3. These segments are located in the left lobe of the liver. If a surgeon is dissecting the liver to the left of the falciform ligament, they would be working in the region containing segments 2 and 3, and resection of these segments is necessary if the hemangioma is located in this area. Option B (1, 4b) is incorrect because segment 1 is the caudate lobe, located posteriorly and above the main part of the liver, while segment 4b is part of the left lobe but is situated more centrally. These segments are not located to the left of the falciform ligament, which is primarily where segments 2 and 3 are located. Option C (2, 4a) is incorrect because segment 4a lies more towards the central part of the left lobe, nearer to the porta hepatis, and is not entirely located to the left of the falciform ligament. Segment 2 is correctly located on the left side of the falciform ligament, but segment 4a is not fully included in this area for resection. Option D (1, 4a) is incorrect because segment 1 (caudate lobe) is located posteriorly and is not typically involved when working to the left of the falciform ligament. Segment 4a is also located near the porta hepatis and is not entirely to the left of the falciform ligament. Hence, this option does not accurately describe the segments involved in resection based on the given description.",
    "correct_choice_id": 200060,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/20122151697976407/20122151697976407.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/20122151697976407/20122151697976407.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50016,
    "choices": [
      {
        "id": 200064,
        "text": "Esophagus"
      },
      {
        "id": 200065,
        "text": "Liver"
      },
      {
        "id": 200066,
        "text": "Rectum"
      },
      {
        "id": 200067,
        "text": "Duodenum"
      }
    ],
    "text": "Portocaval (portosystemic) anastomosis is seen at all except-",
    "unique_key": "Q9775272",
    "question_audio": null,
    "question_video": null,
    "map_id": 34972249,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Duodenum. Portocaval (portosystemic) anastomoses are connections between the portal venous system and the systemic venous system, which help to divert blood flow in cases of portal hypertension. These anastomoses are typically found at certain sites in the body where the venous systems of the portal and systemic circulation meet. The duodenum is not typically involved in portocaval anastomoses. Instead, the anastomoses are most commonly found in the esophagus, rectum, and liver, as these regions are closely associated with both portal and systemic venous systems. Option A (Esophagus) is incorrect because portocaval anastomoses are indeed found in the esophagus. In the case of portal hypertension, the veins in the lower esophagus can form connections with the systemic circulation through the azygos vein, leading to the development of esophageal varices. Option B (Liver) is incorrect because portocaval anastomoses are naturally present in the liver as part of the portal venous system, where blood from the gastrointestinal tract, spleen, and pancreas enters the liver before returning to the heart. In the setting of portal hypertension, alternative pathways, such as through the coronary vein or through shunting via the spleen, can form connections with the systemic venous system. Option C (Rectum) is incorrect because portocaval anastomoses are found in the rectum as well. The veins in the rectum, particularly in the lower part, can form connections with the systemic venous system, and this is a site where hemorrhoidal varices can occur as a result of portal hypertension. Thus, the duodenum is the only option where portocaval anastomoses are not typically observed.",
    "correct_choice_id": 200067,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/63688691697976421/63688691697976421.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/63688691697976421/63688691697976421.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50017,
    "choices": [
      {
        "id": 200068,
        "text": "Lower end of esophagus"
      },
      {
        "id": 200069,
        "text": "Around umbilicus"
      },
      {
        "id": 200070,
        "text": "Lower third of rectum and anal canal"
      },
      {
        "id": 200071,
        "text": "All of the above"
      }
    ],
    "text": "In portal hypertension, the sites of portosystemic anastomosis includes-",
    "unique_key": "Q4415958",
    "question_audio": null,
    "question_video": null,
    "map_id": 34514359,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) All of the above. In portal hypertension, where there is increased pressure in the portal venous system, portosystemic anastomoses can form at several key sites where the portal circulation connects with the systemic circulation. These anastomoses are crucial for bypassing the liver when normal venous drainage is obstructed. The sites where these anastomoses are commonly seen include the lower end of the esophagus, around the umbilicus (forming caput medusae), and the lower third of the rectum and anal canal. All of these areas can develop varices (dilated veins) in the setting of portal hypertension, as blood is rerouted through these collateral pathways. Option A (Lower end of esophagus) is correct because, in portal hypertension, esophageal varices often develop due to portosystemic anastomoses. The lower esophagus is a major site for these anastomoses, where veins of the lower esophagus connect with the azygos vein, bypassing the liver. These varices can become life-threatening if they rupture. Option B (Around umbilicus) is correct because in portal hypertension, a collateral circulation can form around the umbilicus, leading to the characteristic appearance known as caput medusae. In this case, the paraumbilical veins connect with the systemic venous system, creating visible dilated veins around the navel. Option C (Lower third of rectum and anal canal) is correct because portosystemic anastomoses also occur in the rectum and anal canal. These anastomoses connect portal veins in the rectum with systemic veins such as those in the inferior vena cava. Hemorrhoidal varices can develop at these sites as a result of increased portal pressure.",
    "correct_choice_id": 200071,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/74816451697976437/74816451697976437.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/74816451697976437/74816451697976437.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50018,
    "choices": [
      {
        "id": 200072,
        "text": "Cystic duct"
      },
      {
        "id": 200073,
        "text": "Common bile duct"
      },
      {
        "id": 200074,
        "text": "Duodenum"
      },
      {
        "id": 200075,
        "text": "Jejunum"
      },
      {
        "id": 200076,
        "text": "Ileum"
      }
    ],
    "text": "A 52 years old female with a long history of gallstones presents to the emergency room complaining of cramping mid-abdominal pain, abdominal distention and vomiting for the last 12 hours. Abdominal X-ray reveals air in the gallbladder and biliary tree. In which of the following sites is a gallstone most likely lodged?",
    "unique_key": "Q5092747",
    "question_audio": null,
    "question_video": null,
    "map_id": 34865575,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (E) Gallstones have ruptured into duodenum which will be seen in Ileum at the ileocaecal valve.",
    "correct_choice_id": 200076,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/12930131698325115/12930131698325115.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/12930131698325115/12930131698325115.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50019,
    "choices": [
      {
        "id": 200077,
        "text": "Azygos and hemiazygos veins"
      },
      {
        "id": 200078,
        "text": "Gonadal veins"
      },
      {
        "id": 200079,
        "text": "External iliac veins"
      },
      {
        "id": 200080,
        "text": "Splenic vein"
      }
    ],
    "text": "A 54-year-old man has cirrhosis, with obstruction of the portal circulation within the liver. Portal blood could still be conveyed to the caval system via which of the following?",
    "unique_key": "Q7480367",
    "question_audio": null,
    "question_video": null,
    "map_id": 34598415,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) The esophageal venous plexus, which drains into the azygos and hemiazygos veins within the thorax, has anastomoses with branches of the left gastric vein. Thus, following blockage of the portal vein, portal blood may enter the superior vena cava via the azygos system. Other important portacaval connections include the superior rectal vein with the middle and inferior rectal veins; paraumbilical veins with epigastric veins (engorgement of these vessels results in caput medusae); and the colic and splenic veins with renal veins and veins of the posterior body wall. The gonadal veins (choice B) exclusively drain the gonads (although in the female, the ovarian vein communicates with the uterovaginal plexus). These vessels have no anastomoses with portal vessels. The external iliac veins (choice C), which drain much of the inferior extremities, have no demonstrated portal anastomoses. The splenic vein (choice D) is incorrect because it is itself a component of the portal venous system.",
    "correct_choice_id": 200077,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/1928901698329116/1928901698329116.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/1928901698329116/1928901698329116.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50020,
    "choices": [
      {
        "id": 200081,
        "text": "Common hepatic duct"
      },
      {
        "id": 200082,
        "text": "Cystic duct"
      },
      {
        "id": 200083,
        "text": "Inferior surface of liver"
      },
      {
        "id": 200084,
        "text": "Gall bladder"
      }
    ],
    "text": "Which of the following is not a boundary of calot\u2019s triangle",
    "unique_key": "Q5354870",
    "question_audio": null,
    "question_video": null,
    "map_id": 34793339,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Boundaries of Calots triangle are:- Option A- common hepatic duct Option B-Cystic duct Option C-Inferior surface of liver Option D-Gall bladder is not a boundary of calot\u2019s triangle.<p><img src=\"https://d2enu63wt1sf3u.cloudfront.net/ckfinder/files/37(125).jpg\" alt=\"Solution Image\"></p>",
    "correct_choice_id": 200084,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/10932721698501592/10932721698501592.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/10932721698501592/10932721698501592.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50021,
    "choices": [
      {
        "id": 200085,
        "text": "Portal veins"
      },
      {
        "id": 200086,
        "text": "Hepatic artery"
      },
      {
        "id": 200087,
        "text": "Bile duct"
      },
      {
        "id": 200088,
        "text": "Cystic duct"
      }
    ],
    "text": "Structure that divides liver anatomically based on Couinaud\u2019s classification system is:",
    "unique_key": "Q2464809",
    "question_audio": null,
    "question_video": null,
    "map_id": 34414301,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) The Couinaud classification of liver anatomy divides the liver into eight functionally indepedent segments. Each segment has its own vascular inflow, outflow and biliary drainage. In the centre of each segment there is a branch of the portal vein, hepatic artery and bile duct. It is based on the identification of three hepatic veins and the plane passing by the portal vein bifurcation.",
    "correct_choice_id": 200085,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/53318701701777262/53318701701777262.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/53318701701777262/53318701701777262.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50022,
    "choices": [
      {
        "id": 200089,
        "text": "A-B"
      },
      {
        "id": 200090,
        "text": "B-C"
      },
      {
        "id": 200091,
        "text": "C-D"
      },
      {
        "id": 200092,
        "text": "A-D"
      }
    ],
    "text": "During Deep inspiration,the lung extends upto which level of liver?<p><img src=\"https://d2enu63wt1sf3u.cloudfront.net/ckfinder/files/68(81).jpg\" alt=\"Question Image\"></p>",
    "unique_key": "Q7084288",
    "question_audio": null,
    "question_video": null,
    "map_id": 34789912,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Option A-Till A-B :Lung & pleura,both will reach. Option B-Till B-C :only pleura will reach. Option C-Till C-D :nothing will reach. Option D-Till A-D :as described above,nothing will reach till point D.",
    "correct_choice_id": 200089,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/59572821701777348/59572821701777348.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/59572821701777348/59572821701777348.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50023,
    "choices": [
      {
        "id": 200093,
        "text": "Left colic and middle colic veins"
      },
      {
        "id": 200094,
        "text": "Esophageal veins and left gastric veins"
      },
      {
        "id": 200095,
        "text": "Superior rectal and phrenic veins"
      },
      {
        "id": 200096,
        "text": "Sigmoid and superior rectal veins"
      }
    ],
    "text": "A patient comes with abdominal pain, jaundice, and portal hypertension. Anastomosis between which of the following veins is seen?",
    "unique_key": "Q9064261",
    "question_audio": null,
    "question_video": null,
    "map_id": 34846673,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Option A-Left colic and middle colic veins are part of portal circulation. Option B-In the given scenario of portal hypertension [abdominal pain, jaundice], anastomosis between esophageal veins and left gastric veins can be seen. Option C-Superior rectal and phrenic veins do not anastomose with each other. Option D-Sigmoid and superior rectal veins are part of portal circulation.<p><img src=\"https://d2enu63wt1sf3u.cloudfront.net/ckfinder/files/7_1(3).png\" alt=\"Solution Image\"></p>",
    "correct_choice_id": 200094,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50024,
    "choices": [
      {
        "id": 200097,
        "text": "Lies of portal vein"
      },
      {
        "id": 200098,
        "text": "Lies right to hepatic artery"
      },
      {
        "id": 200099,
        "text": "Lies left to hepatic artery"
      },
      {
        "id": 200100,
        "text": "Lies posterior to hepatic artery and portal vein"
      }
    ],
    "text": "The relation of common bile duct -",
    "unique_key": "Q7058522",
    "question_audio": null,
    "question_video": null,
    "map_id": 34983614,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Common bile duct Lies right to hepatic artery",
    "correct_choice_id": 200098,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '27  Hepatobiliary System';
        const quizFilename = '27-hepatobiliary-system-1b3f8333.html';
        let hierarchy = ["DAMS", "DQB", "Anatomy"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on navigation
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>