<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>071 Dvt And Pulmonary Embolism - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">18</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A patient was brought to the emergency with complaints of chest pain, hemoptysis, and severe dyspnea. CT scan showed vessel sign suggestive of pulmonary infarction. Which among the following is typically responsible for this?",
    "choices": [
      {
        "id": 1,
        "text": "Small pulmonary embolism"
      },
      {
        "id": 2,
        "text": "Submassive pulmonary embolism"
      },
      {
        "id": 3,
        "text": "Massive pulmonary embolism"
      },
      {
        "id": 4,
        "text": "Saddle embolism"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Pulmonary infarction as suggested by CT is typically due to a <strong>small pulmonary embolism.</strong></p>\n<p>Pulmonary infarction occurs when <strong>small thrombi</strong> lodge in the <strong>segmental</strong> and <strong>subsegmental vessels</strong>. These patients most often have <strong>pleuritic chest pain</strong>&nbsp;as the site where the thrombus lodges are near the innervation of pleural nerves.</p>\n<p><strong>Massive pulmonary emboli</strong> and <strong>saddle emboli</strong> that occlude the main pulmonary artery cause&nbsp;<strong>hypotension</strong> and <strong>shock</strong> as opposed to infarction. These are caused by&nbsp;<strong>l</strong><strong>arger-sized emboli</strong> that lodge more proximally in the pulmonary circulation.</p>\n<p>Pulmonary embolism is classified based on the degree of reduction of pulmonary vascular blood flow and associated hemodynamic disturbances:&nbsp;</p>\n<ul>\n<li aria-level=\"1\"><strong>Massive</strong>: Hypotension lasting for &gt;15 minutes or BP maintained with inotropes.</li>\n<li aria-level=\"1\"><strong>Submassive</strong>: No hypotension, but features of cardiac injury present.</li>\n<li aria-level=\"1\"><strong>Non-massive</strong>: No hypotension or features of cardiac injury.&nbsp;</li>\n</ul>\n<p>CT findings associated with pulmonary infarction include a <strong>feeding vessel</strong> or <strong>vessel sign</strong> as shown below. It depicts a distinct vessel feeding directly to a lesion, usually of hematogenous origin. However, it is not specific for pulmonary infarction.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/aebc617bd39743029953f67c33f9c404x1280x1278.JPEG"
    ]
  },
  {
    "text": "A patient with a suspected pulmonary embolism underwent a chest X-ray. It showed an enlarged right descending pulmonary artery.  What is this sign called?",
    "choices": [
      {
        "id": 1,
        "text": "Westermark\u2019s sign"
      },
      {
        "id": 2,
        "text": "Hampton\u2019s hump"
      },
      {
        "id": 3,
        "text": "Palla\u2019s sign"
      },
      {
        "id": 4,
        "text": "Black pleura sign"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Enlarged right descending pulmonary artery on a chest X-ray in pulmonary embolism is called <strong>Palla&rsquo;s sign.</strong></p>\n<p>The&nbsp;<strong>black pleura </strong>sign is seen in alveolar pulmonary microlithiasis. It refers to the shadow of the pleura between the extensive alveolar calcification and the adjacent rib cage.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Echocardiography in a patient with pulmonary embolism revealed akinesia of the right ventricular free wall with normal motion at the right ventricular apex. What is this sign called?",
    "choices": [
      {
        "id": 1,
        "text": "Moses\u2019 sign"
      },
      {
        "id": 2,
        "text": "McConnell\u2019s sign"
      },
      {
        "id": 3,
        "text": "Homan\u2019s sign"
      },
      {
        "id": 4,
        "text": "Lowenberg\u2019s sign"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The sign described is called <strong>McConnell&rsquo;s sign.</strong></p>\n<p>It demonstrates <strong>right</strong> <strong>ventricular dysfunction</strong> as&nbsp;akinesia of the right ventricular free wall with normal motion at the right ventricular apex.&nbsp;It<strong>&nbsp;</strong>is the best-known <strong>indirect</strong> sign of <strong>pulmonary embolism</strong> on transthoracic echocardiography.&nbsp;<strong><br /></strong></p>\n<p>Moses' (Bancroft's), Homan&rsquo;s, and&nbsp;Lowenberg&rsquo;s signs are seen in venous thrombosis. They're not specific to pulmonary embolism.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following biomarker is least likely to be elevated in a patient with pulmonary embolism?",
    "choices": [
      {
        "id": 1,
        "text": "Troponins"
      },
      {
        "id": 2,
        "text": "BNP"
      },
      {
        "id": 3,
        "text": "Heart-type fatty acid\u2013binding protein"
      },
      {
        "id": 4,
        "text": "NGAL"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>NGAL&nbsp;</strong>(Neutrophil gelatinase-associated lipocalin)&nbsp;is a <strong>kidney injury marker</strong> and not a cardiac injury marker.</p>\n<p>The following are biomarkers of cardiac injury in pulmonary embolism:</p>\n<ul>\n<li>Plasma brain natriuretic peptide (BNP)</li>\n<li>Heart-type fatty acid binding protein</li>\n<li>Troponins.</li>\n</ul>\n<p>Serum troponin and plasma heart-type fatty acid-binding protein levels increase because of right ventricular <strong>microinfarction</strong>. <strong>Myocardial stretch</strong> causes the release of brain natriuretic peptide (BNP) or NT-proBNP.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following conditions is likely to show increased D-dimer values?",
    "choices": [
      {
        "id": 1,
        "text": "1,2"
      },
      {
        "id": 2,
        "text": "1,3,4"
      },
      {
        "id": 3,
        "text": "2,3"
      },
      {
        "id": 4,
        "text": "1,2,3,4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>All of the conditions mentioned above have raised D-dimer levels.</p>\n<p>D-dimer is a <strong>fibrin</strong> <strong>degradation</strong> product.</p>\n<p>Plasma D-dimer levels commonly rise in <strong>DVT</strong> and <strong>pulmonary</strong> <strong>embolism</strong> due to the breakdown of fibrin by plasmin. D-dimer is more sensitive to pulmonary embolism than DVT. The <strong>sensitivity</strong> of D-dimer levels in the diagnosis of<strong> pulmonary embolism </strong>is &gt;<strong> 95%&nbsp;</strong>but it is&nbsp;is <strong>not specific</strong> for pulmonary embolism.</p>\n<p>Normal D-dimer rules out pulmonary embolism in low and intermediate-risk patients. Patients with a high risk of PE should undergo a CT pulmonary angiogram to effectively rule out PE.</p>\n<p>Conditions which have raised D-dimer levels include:</p>\n<ul>\n<li>Myocardial infarction</li>\n<li>Pneumonia</li>\n<li>Sepsis</li>\n<li>Cancer</li>\n<li>Postoperative state</li>\n<li>Pregnancy- second and third trimester</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged patient presents to the emergency department with a sudden onset pain in the right leg. The pain is associated with swelling, redness, and tenderness. Which of the following is false regarding the management of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Recurrence of this condition despite intensive anticoagulation is an indication for IVC filter"
      },
      {
        "id": 2,
        "text": "IVC filters can prevent recurrent PE in patients of right heart failure"
      },
      {
        "id": 3,
        "text": "IVC filters reduce the rate of recurrence of this condition"
      },
      {
        "id": 4,
        "text": "Pulmonary thromboendarterectomy is done in patients with chronic thromboembolic pulmonary hypertension"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above scenario is suggestive of deep vein thrombosis <strong>(DVT)</strong>. IVC filters <strong>increase </strong>the rate of<strong> recurrence </strong>of DVT (by providing a nidus for clot formation) even though they usually prevent pulmonary embolism (over the short term).</p>\n<p>The two <strong>principal</strong> <strong>indications</strong> for insertion of an <strong>IVC</strong> <strong>filter</strong> are:</p>\n<ol>\n<li>Active bleeding (prevents the use of anticoagulation)</li>\n<li>Recurrent venous thrombosis despite intensive anticoagulation</li>\n</ol>\n<p>Prevention of recurrent PE in patients with right heart failure who are not candidates for fibrinolysis and prophylaxis of extremely high-risk patients are some other indications for filter placement.</p>\n<p>Patients impaired by dyspnea due to chronic thromboembolic pulmonary hypertension should be considered for pulmonary thromboendarterectomy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A resident is evaluating a patient, who presented with acute onset of chest pain and dyspnea, for pulmonary embolism. Which of the following imaging test should be performed to confirm this diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Doppler echocardiography"
      },
      {
        "id": 2,
        "text": "CT pulmonary angiography"
      },
      {
        "id": 3,
        "text": "Ventilation perfusion scan of lungs"
      },
      {
        "id": 4,
        "text": "MR pulmonary angiography"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>CT pulmonary angiography</strong>&nbsp;should be performed as it is the <strong>principal</strong> imaging test for the <strong>diagnosis</strong> of pulmonary embolism (PE).</p>\n<p>Option A: Most patients with acute PE have <strong>normal</strong> <strong>echocardiograms</strong>. However, echocardiography is a very useful <strong>diagnostic tool</strong> for detecting conditions that may <strong>mimic PE</strong>, such as acute myocardial infarction, pericardial tamponade, and aortic dissection.</p>\n<p>Option C: <strong>Ventilation-perfusion</strong> (V/Q) scanning has become a <strong>second-line</strong> diagnostic test for PE, used mostly for patients who cannot tolerate intravenous contrast or in whom the CT results are inconclusive.</p>\n<p>Option D: <strong>MR pulmonary angiography</strong> may detect large proximal PE but is <strong>not reliable</strong> for smaller segmental and subsegmental PE. It is used when neither CT angiography nor ventilation-perfusion scan can be done.&nbsp;</p>\n<p>The images below demonstrate a pulmonary embolus (marked by arrows). The image of the gross specimen shows <strong>saddle thromboembolism.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3deedeebeb6c408483be4651e755d530x1072x831.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/faa4e0ce5d3c4987a19a999a4fa1ec57x800x570.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3dccaa20c5184acdbff5d98c7db3369dx800x542.JPEG"
    ]
  },
  {
    "text": "A 50-year-old patient is diagnosed with deep vein thrombosis in his right limb. Which of the following parameters is a part of Well\u2019s criteria that assess the clinical likelihood of pulmonary embolism in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Dyspnea"
      },
      {
        "id": 2,
        "text": "Orthopnea"
      },
      {
        "id": 3,
        "text": "Chest pain"
      },
      {
        "id": 4,
        "text": "Hemoptysis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hemoptysis</strong> is a parameter in <strong>Well&rsquo;s criteria</strong> used to assess the likelihood of<strong> pulmonary embolism</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with a Well's score of 1.5, which of the following should be the initial investigation?",
    "choices": [
      {
        "id": 1,
        "text": "D-dimer levels"
      },
      {
        "id": 2,
        "text": "CT pulmonary angiography"
      },
      {
        "id": 3,
        "text": "V/Q lung scan"
      },
      {
        "id": 4,
        "text": "Doppler ultrasonography"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A patient with Well's score of 1.5 has a&nbsp;<strong>low probability </strong>of pulmonary embolism. The <strong>initial investigation</strong> should be the measurement of <strong>D-dimer </strong>levels<strong>.</strong></p>\n<p>In a patient with<strong>&nbsp;</strong>a<strong> high probability </strong>of pulmonary embolism,&nbsp;the initial investigation is<strong> CT pulmonary angiography.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/27f85ad8831c4dd4ad111da9dd5b274ex1280x1408.JPEG"
    ]
  },
  {
    "text": "Which of the following is an indication for fibrinolytic therapy in a patient diagnosed with massive pulmonary embolism?",
    "choices": [
      {
        "id": 1,
        "text": "Persistent hypotension"
      },
      {
        "id": 2,
        "text": "RV dysfunction"
      },
      {
        "id": 3,
        "text": "RV enlargement on chest CT"
      },
      {
        "id": 4,
        "text": "Benign intracranial neoplasm"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>For <strong>fibrinolysis</strong>&nbsp;(thrombolytic therapy) in massive pulmonary embolism, the only widely accepted indication is <strong>persistent hypotension</strong> or<strong> shock</strong>.&nbsp;It is&nbsp;defined as SBP &lt;90mmHg or a decrease in SBP by <span class=\"Y0NH2b CLPzrc\">&ge;</span>40 mmHg from baseline for &gt;15 minutes.</p>\n<p><strong>Alteplase</strong> or recombinant tissue plasminogen activator (tPA),<strong> streptokinase, </strong>and<strong> urokinase</strong> are approved for the treatment of PE. tPA is the most commonly used fibrinolytic, but it is not superior to other agents.</p>\n<p>Pulmonary embolism is classified based on the degree of reduction of pulmonary vascular blood flow and associated hemodynamic disturbances:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Massive</strong>: Hypotension lasting for &gt;15 minutes or BP maintained with inotropes.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Submassive</strong>: No hypotension, but features of cardiac injury present.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Non-massive</strong>: No hypotension or features of cardiac injury.</li>\n</ul>\n<p><strong>Contraindications for thrombolysis:</strong></p>\n<ul>\n<li>Haemorrhagic stroke</li>\n<li>Ischemic stroke in the last 6 months</li>\n<li>CNS tumours</li>\n<li>Major surgery/trauma in the last 3 weeks</li>\n<li>Active bleeding</li>\n<li>Bleeding diathesis.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 32-year-old woman with SLE, secondary anti-phospholipid antibody syndrome develops pulmonary embolism. After admission, she is started on anticoagulants. For how long should the anticoagulation therapy be continued?",
    "choices": [
      {
        "id": 1,
        "text": "12-24 months"
      },
      {
        "id": 2,
        "text": "3-5 years"
      },
      {
        "id": 3,
        "text": "6-12 months"
      },
      {
        "id": 4,
        "text": "Indefinitely"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Duration</strong> of anticoagulation for DVT and venous thromboembolism <strong>secondary</strong> to antiphospholipid antibody syndrome <strong>(APLA)</strong> is <strong>lifelong.</strong></p>\n<p>Duration of anticoagulation for DVT and venous thromboembolism:</p>\n<table style=\"width: 381px; height: 367px;\">\n<tbody>\n<tr>\n<td style=\"width: 203.639px;\"><strong>Clinical Scenario</strong></td>\n<td style=\"width: 163.361px; text-align: left;\"><strong>Duration of Anticoagulation</strong></td>\n</tr>\n<tr>\n<td style=\"width: 203.639px;\">DVT isolated to an upper extremity or calf that has been provoked by surgery, trauma, estrogen, or an indwelling central venous catheter or pacemaker</td>\n<td style=\"width: 163.361px; text-align: left;\">3 months</td>\n</tr>\n<tr>\n<td style=\"width: 203.639px;\">Provoked proximal leg DVT or PE</td>\n<td style=\"width: 163.361px; text-align: left;\">3 to 6 months</td>\n</tr>\n<tr>\n<td style=\"width: 203.639px;\">For patients with cancer and VTE</td>\n<td style=\"width: 163.361px; text-align: left;\">\n<p>Prescribe LMW heparin</p>\n<p>Continue anticoagulation indefinitely unless the patient is rendered cancer-free</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 203.639px;\">Idiopathic unprovoked VTE</td>\n<td style=\"width: 163.361px; text-align: left;\">Indefinite</td>\n</tr>\n<tr>\n<td style=\"width: 203.639px;\">Antiphospholipid antibody syndrome</td>\n<td style=\"width: 163.361px; text-align: left;\">Indefinite</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drug was recently approved by FDA for the extended prophylaxis of venous thromboembolism in hospitalized medically ill patients?",
    "choices": [
      {
        "id": 1,
        "text": "Unfractionated heparin"
      },
      {
        "id": 2,
        "text": "Apixaban"
      },
      {
        "id": 3,
        "text": "Enoxaparin"
      },
      {
        "id": 4,
        "text": "Betrixaban"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Betrixaban </strong>is a new oral, once-daily factor <strong>Xa inhibitor</strong> approved by the United States Food and Drug Administration<strong> (FDA)</strong> for extended-duration<strong> prophylaxis of VTE </strong>in acute medically ill patients.</p>\n<p>In patients with no obvious risk factors for VTE, <strong>early ambulation</strong> with or without mechanical methods (pneumatic compression stockings or venous foot pump) should be advised.</p>\n<p>In patients with one risk factor for VTE with no risk of bleeding, <strong>LMWH</strong> is preferred.&nbsp;In presence of renal failure/cost issues,&nbsp;<strong>unfractionated heparin&nbsp;</strong>is used. In the case of heparin-induced thrombocytopenia,&nbsp;<strong>fondaparinux&nbsp;</strong>is preferred.</p>\n<p>In patients with multiple risk factors, increasing the dose of <strong>anticoagulants</strong> or using a mechanical device is advised. For patients with risk factors and a high risk of bleeding or contraindication for anticoagulation, <strong>mechanical methods</strong> are recommended.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is May-Thurner syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Compression of right iliac vein by right iliac artery"
      },
      {
        "id": 2,
        "text": "Compression of right iliac vein by left iliac artery"
      },
      {
        "id": 3,
        "text": "Compression of left iliac vein by right iliac artery"
      },
      {
        "id": 4,
        "text": "Compression of left iliac vein by left iliac artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>May-Thurner syndrome (MTS) is&nbsp;caused when the<strong> left iliac vein </strong>is<strong> compressed by </strong>the<strong> right iliac artery&nbsp;</strong>against the fifth lumbar vertebra.&nbsp;It is also called iliocaval venous compression syndrome, iliac vein compression syndrome, Cockett's syndrome, and venous spur.</p>\n<p>Most patients have a partial obstruction and are asymptomatic. It can however progress to symptomatic extensive deep vein thrombosis (DVT). It is a cause of <strong>recurrent DVT</strong> affecting the left leg.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are evaluating a patient with a cardio-respiratory compromise. Chest X-ray shows a focal area of oligemia. The ECG of the patient is shown below. Choose the false statement regarding this condition.",
    "choices": [
      {
        "id": 1,
        "text": "Most common symptom is dyspnea"
      },
      {
        "id": 2,
        "text": "Most common sign is tachycardia"
      },
      {
        "id": 3,
        "text": "Most common ECG abnormality is sinus tachycardia"
      },
      {
        "id": 4,
        "text": "Most preferred preliminary investigation is D-dimer"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above scenario is suggestive of pulmonary embolism. ECG shows the&nbsp;<strong>S1Q3T3 sign</strong>&nbsp;(i.e, an S wave in lead I, a Q wave in lead III, and an inverted T wave in lead III) that is relatively <strong>specific</strong> but insensitive.&nbsp;The most common <strong>sign</strong> of pulmonary embolism is <strong>tachypnea.</strong></p>\n<p>Most common <strong>symptom</strong> of pulmonary embolism is <strong>dyspnea</strong>. Most common <strong>ECG abnormality</strong> in pulmonary embolism is <strong>sinus tachycardia</strong>.Most common <strong>preliminary</strong> investigation used is <strong>D</strong>-<strong>dimer</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e0b61b3332b14758a20b2e04ef0862ed.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c65ce46408fd45f9815585362faea2c9x1280x1255.JPEG"
    ]
  },
  {
    "text": "A 45-year-old woman underwent bariatric surgery. On postoperative day 4, she developed pulmonary embolism as confirmed by a CT pulmonary angiography. Her blood pressure was 70/44 mmHg with poor urine output.  IV fluids were administered with dobutamine after which the blood pressure increased to 82/54 mmHg.  What is the most appropriate next step to manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Low molecular weight heparin"
      },
      {
        "id": 2,
        "text": "IVC filter"
      },
      {
        "id": 3,
        "text": "Surgical pulmonary embolectomy"
      },
      {
        "id": 4,
        "text": "Thrombolysis with tPA"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Surgical pulmonary embolectomy</strong> is the most appropriate next step in the management of this patient.&nbsp;</p>\n<p>This patient is suffering from a&nbsp;<strong>massive pulmonary embolism</strong>. In such cases, thrombolytic therapy is given once diagnosis is made using CT pulmonary angiography or bedside ECHO.</p>\n<p>But, since this patient underwent a large open abdominal operation (bariatric surgery), thrombolysis is contraindicated due to the increased risk of life-threatening bleeding. Therefore, <strong>surgical</strong> <strong>embolectomy</strong>&nbsp;must be done. The main pulmonary arteries are incised, and fresh clots are removed.</p>\n<p><strong>Contraindications for thrombolysis:</strong></p>\n<ul>\n<li>Haemorrhagic stroke</li>\n<li>Ischemic stroke in the last 6 months</li>\n<li>CNS tumours</li>\n<li>Major surgery/trauma in the last 3 weeks</li>\n<li>Active bleeding</li>\n<li>Bleeding diathesis.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 42-year-old lady was admitted with unprovoked pulmonary embolism from left distal leg DVT. On admission, her coagulation studies were normal. She was started on unfractionated heparin with the first dose of warfarin on the same day.",
    "choices": [
      {
        "id": 1,
        "text": "Discontinue warfarin and start long term low molecular weight heparin"
      },
      {
        "id": 2,
        "text": "Reinstitute heparin and continue warfarin"
      },
      {
        "id": 3,
        "text": "Send HIT tests and start argatroban or lepirudin"
      },
      {
        "id": 4,
        "text": "Continue warfarin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This patient had <strong>suboptimal anticoagulation</strong> management. The best approach would be to <strong>reinstitute</strong> <strong>heparin</strong> and continue <strong>warfarin.</strong></p>\n<p>The patient had unprovoked PE from lower limb DVT. She was started on warfarin bridged with heparin initially.</p>\n<p>Warfarin &amp; parenteral anticoagulation need to be overlapped for <strong>at least 5 days</strong>, independent of the INR achieved during these 5 days in patients with acute venous thromboembolism.</p>\n<p>Warfarin inhibits protein C, protein S (which is part of the fibrinolytic pathway) in addition to factors II, VII, IX, X. Protein C has a short half-life (4-6 hours) and thus decreases early. Since protein C is antithrombotic, decreased levels of protein C by warfarin renders the patient hypercoagulable during the first few days of treatment before factor II with a long half-life (36 hours) decreases and protects the patient from thrombosis.</p>\n<p>Thus <strong>warfarin</strong> creates a <strong>prothrombotic</strong> <strong>state</strong> in the first 5 days putting the patient at risk of progression of thrombosis unless a parenteral anticoagulant is given overlapping warfarin for these days.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old lady is admitted with unprovoked pulmonary embolism. On admission, her PT was 13.6 seconds (normal 9.6-13.4 seconds) and aPTT was 62 seconds (normal 28.2-34.6 seconds). She has no history of bleeding. Thrombophilia work up was done and she was found to have a strong lupus anticoagulant. How will you manage the patient\u2019s initial anticoagulation?",
    "choices": [
      {
        "id": 1,
        "text": "Start intravenous unfractionated  heparin with aPTT goal in the upper therapeutic range"
      },
      {
        "id": 2,
        "text": "Start intravenous unfractionated  heparin and monitor with anti Xa tests"
      },
      {
        "id": 3,
        "text": "Start warfarin without heparin bridge because aPTT is already in the therapeutic range"
      },
      {
        "id": 4,
        "text": "Start intravenous argatroban and monitor by aPTT"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\">This patient is most probably suffering from <strong>antiphospholipid antibody syndrome</strong> (APS) as her lupus anticoagulant is strongly positive. In such patients, the initial anticoagulation is with <strong>unfractionated heparin</strong> and is monitored by anti-Xa tests.</p>\n<p class=\"p1\">Due to the presence of lupus anticoagulant, the lab measurement of aPTT will show <strong>erroneously prolonged aPTT</strong>. Therefore, even though there is an apparently prolonged aPTT, the patient is at increased risk of thrombosis and not bleeding, and hence patients with APS should be anticoagulated.</p>\n<p class=\"p1\">Anti Xa tests are not influenced by APS. So, the patient can be monitored for the adequacy of anticoagulation with UFH by monitoring anti-Xa.</p>\n<p class=\"p2\">Option A: The patient&rsquo;s aPTT is already prolonged due to lupus anticoagulant, so we cannot monitor the patient with aPTT after starting unfractionated heparin.</p>\n<p class=\"p2\">Option C: Warfarin in the first few days of therapy, causes a decrease in Protein C &amp; S levels, causing a prothrombotic state. Hence, a heparin bridge is necessary for APS which is already a pro-thrombotic state.</p>\n<p class=\"p2\">Option D: Argatroban is a direct thrombin inhibitor used in heparin-induced thrombocytopenia(HIT) to prevent thrombosis and also to increase platelet levels. Therapy is monitored with aPTT.</p>\n<p class=\"p2\">Note: Lupus anticoagulant may function as an inhibitor in vitro by binding to the reagent phospholipid and blocking the phospholipid-dependent reactions of the intrinsic pathway. The net effect is a prolongation of the aPTT.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 53-year-old woman underwent hip replacement surgery. A week after the surgery, the patient developed swelling of the legs associated with pain on palpation. Her heart rate is 70 beats per min. There is no history of hemoptysis or significant weight loss. There is no previous history of pulmonary embolism. What is the risk of developing pulmonary embolism in the patient based on Well's score?",
    "choices": [
      {
        "id": 1,
        "text": "Low"
      },
      {
        "id": 2,
        "text": "High"
      },
      {
        "id": 3,
        "text": "Moderate"
      },
      {
        "id": 4,
        "text": "Cannot comment without d-dimer values"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The risk of developing pulmonary embolism in this patient is <strong>high</strong> (Option B) according to the three-tiered <strong>Well&rsquo;s clinical risk assessment score.&nbsp;</strong></p>\n<p>Calculation of <strong>Well's score:</strong></p>\n<ul>\n<li>Clinical signs of DVT = 3; &nbsp;- swelling of legs, pain on palpation (Moses sign)</li>\n<li>No alternative diagnosis = 3&nbsp;</li>\n<li>Heart rate is &lt;100 BPM = 0; - 70 BPM</li>\n<li>Surgery in previous 4 weeks = 1.5; - hip replacement surgery 1 week ago&nbsp;</li>\n<li>No previous pulmonary embolism = 0</li>\n<li>No Hemoptysis = 0</li>\n<li>No malignancy = 0; - no significant weight loss&nbsp;</li>\n</ul>\n<p><strong>Total score = 7.5</strong></p>\n<p><strong>Risk stratification:</strong></p>\n<ul>\n<li>High risk = &nbsp;&gt; 6.0</li>\n<li>Moderate risk = &nbsp;2.0 to 6.0</li>\n<li>Low risk = &lt;2.0 (in patients with low risk, to further confirm the risk - pulmonary embolism rule-out criteria (PERC) may be referred)&nbsp;</li>\n</ul>\n<p><strong>Note: </strong>There is no other alternative diagnosis which is more likely in this condition, where there is a clear clinical presentation of a deep vein thrombosis, with the associated risk factors of a recent surgery and immobilization. Hence, 3 points can be added to the score. &nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '071 Dvt And Pulmonary Embolism';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>