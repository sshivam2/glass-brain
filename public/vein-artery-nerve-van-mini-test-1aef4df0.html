<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vein, Artery & Nerve (Van) Mini Test - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / FMGE Mini Test Series / 2025
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following provides long-lasting results in a coronary artery bypass graft (CABG)?",
    "choices": [
      {
        "id": 1,
        "text": "Long saphenous vein"
      },
      {
        "id": 2,
        "text": "Internal mammary artery"
      },
      {
        "id": 3,
        "text": "Polytetra fluoro ethylene (PTFE)"
      },
      {
        "id": 4,
        "text": "Gastroepiploic artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The<strong>\u00a0left internal mammary artery (LIMA</strong>)\u00a0provides long-lasting results in a coronary artery bypass graft (CABG).\u00a0The most important criterion in conduit selection is <strong>graft patency</strong>. The conduit with the <strong>highest patency</strong> <strong>rate</strong> is the <strong>left internal mammary artery</strong> or internal thoracic artery.</p>\n<p>Left internal mammary artery &gt; Radial artery &gt; long saphenous vein\u00a0represents the correct order of graft patency in a patient undergoing a CABG procedure.</p>\n<p><strong>Venous grafts:</strong></p>\n<ul>\n<li>The <strong>long saphenous vein </strong>is the <strong>most common</strong> vein used as a conduit as it is straightforward to harvest, provides good length, and is easy to handle.</li>\n<li>The ten-year patency rate for long saphenous vein grafts is reported to be 50\u201360 percent.</li>\n</ul>\n<p><strong>Arterial grafts:</strong></p>\n<ul>\n<li>The <strong>Left internal mammary artery (LIMA</strong>) or <strong>internal thoracic artery </strong>has become the <strong>conduit of choice</strong> for the left anterior descending (LAD) coronary artery.\u00a0<strong>The radial artery </strong>can be used as a second or alternative arterial bypass graft. Other\u00a0arterial bypass grafts include the <strong>gastroepiploic artery and the inferior epigastric artery.</strong></li>\n<li>Long patency rates of &gt;98 percent have been reported.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with radial head fracture presents with an inability to extend the metacarpophalangeal joint. On examination, wrist extension is normal with no sensory impairment. Which of the following nerves is affected in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ulnar nerve"
      },
      {
        "id": 2,
        "text": "Radial nerve"
      },
      {
        "id": 3,
        "text": "Median nerve"
      },
      {
        "id": 4,
        "text": "Posterior interosseus nerve"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In the given clinical scenario, there is a likely injury to the<strong> posterior interosseous nerve.</strong></p>\n<p>It is prone to be injured in <strong>radial head fractures</strong> as the nerve winds around the radial neck to go into the posterior compartment of the forearm. There is no cutaneous sensory loss in lesions confined to the posterior interosseous nerve.</p>\n<p>The radial nerve divides into 2 branches, namely <strong>superficial (sensory)</strong> and <strong>deep (motor)</strong> branches at the cubital fossa.\u00a0</p>\n<p>Deep radial nerve after supplying <strong>extensor carpi radialis brevis (ECRB) </strong>and <strong>supinator,</strong> continues as posterior interosseous nerve <strong>(PIN).</strong> From the posterior compartment, the supinator muscle wraps around the upper 1/3rd of the radius to reach the anterior compartment.\u00a0</p>\n<p>PIN arches and winds around the radial neck along with the supinator muscle, into the posterior compartment of the forearm. Hence, it is in close relation with the radial head and neck, and the supinator arch or arcade of Froese.\u00a0</p>\n<p>There is <strong>no cutaneous innervation</strong> by the posterior interosseous nerve.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8e8810c043a44872ba64806ecffe2be8x1280x2062.JPEG"
    ]
  },
  {
    "text": "Which of the following are branches of the anterior division of the internal iliac artery?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2, 3, 5"
      },
      {
        "id": 2,
        "text": "2, 3, 4, 6"
      },
      {
        "id": 3,
        "text": "2, 3, 4, 5, 6"
      },
      {
        "id": 4,
        "text": "1, 4, 5, 6"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The branches from the anterior division include <strong>2, 3, 4, 5, 6.\u00a0</strong></p>\n<p>The internal iliac artery is the major artery of the pelvis. At the superior border of the greater sciatic foramen in the pelvis, it divides into anterior and posterior trunks.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/904913e2f83e4e95be719092e4a79a0dx795x599.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2dbdc4d411e54e38a8a7663dc7c93698x1280x1051.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is true about the appendicular artery?",
    "choices": [
      {
        "id": 1,
        "text": "Supplies the appendix and terminal ileum"
      },
      {
        "id": 2,
        "text": "Terminal segment of the artery is susceptible to thrombosis"
      },
      {
        "id": 3,
        "text": "It arises directly from the superior mesenteric artery"
      },
      {
        "id": 4,
        "text": "Artery of Seshachalam, an accessory appendicular artery, arises from the anterior cecal artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>terminal part</strong> of the appendicular artery lies on the <strong>wall of the appendix</strong> and may become <strong>thrombosed</strong> in appendicitis, resulting in distal gangrene or necrosis.</p>\n<p>The appendicular artery provides blood supply <strong>only to the appendix </strong>(Option A); it is an end artery and is a branch of the ileocolic artery.</p>\n<p>The appendicular artery usually arises directly from the <strong>ileocolic artery</strong> (Option C) and descends posterior to the terminal ileum to enter the <strong>mesoappendix,</strong> a short distance from the base of the appendix. Here, it gives off a recurrent branch, which anastomoses at the base of the appendix with a branch of the posterior cecal artery.</p>\n<p>Less commonly, the appendicular artery may arise from the posterior cecal artery or an ileal artery. An accessory appendicular artery called the <strong>artery of Seshachalam </strong>arising from the <strong>posterior cecal artery</strong> may be present. (Option D)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f4b2a5bcbc064b088ee4587b1c83a320x1280x1364.JPEG"
    ]
  },
  {
    "text": "During a parotidectomy, oozing is noted from the vein running within the substance of the gland. The concerned vein is formed by the joining of which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary vein and Facial vein"
      },
      {
        "id": 2,
        "text": "Superficial temporal vein and Maxillary vein"
      },
      {
        "id": 3,
        "text": "Transverse facial vein and Superficial temporal vein"
      },
      {
        "id": 4,
        "text": "Facial vein and Posterior auricular vein"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The vein that runs through the substance of the parotid gland is the <strong>r</strong><strong>etromandibular vein</strong>. It is formed by the union of the <strong>superficial temporal</strong> <strong>vein</strong> and the <strong>maxillary vein.</strong></p>\n<p>It can be remembered that the <strong>termination of the external carotid artery</strong> and the <strong>formation of the retromandibular vein</strong>, have the <strong>same named branches </strong>and<strong> tributaries,</strong> respectively.</p>\n<p>The <strong>retromandibular vein</strong> is <strong>joined by </strong>the <strong>transverse facial</strong> <strong>vein</strong> within the gland. The retromandibular vein then <strong>divides</strong> into the <strong>anterior </strong>and<strong> posterior divisions</strong> at the lower pole of the parotid. The <strong>anterior division joins </strong>the<strong> facial vein</strong> and the <strong>posterior division joins </strong>the<strong> posterior auricular vein.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fe71f61a744a422099fd9a77be276d7fx1280x1452.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6e824f363e814025870f1ff827840f33x1280x1452.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d4ffcb5845ea43c7a6f63cf5256a75c0x600x624.JPEG"
    ]
  },
  {
    "text": "A resident was inserting a central venous line through the femoral vein. However, he accidentally advanced the needle causing injury to the structure lying immediately medial to the femoral vein, lying within the femoral sheath. Which of the following structures is injured?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphatic vessels"
      },
      {
        "id": 2,
        "text": "Femoral artery"
      },
      {
        "id": 3,
        "text": "Femoral nerve"
      },
      {
        "id": 4,
        "text": "Genitofemoral nerve"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>The lymphatic vessels\u00a0</strong>lie medial to the femoral vein and are likely to be injured in this case.</p>\n<p>Femoral sheath is the funnel-shaped prolongation of the fascia which contains femoral vessels. Anteriorly it is made of <strong>transversalis fascia</strong> and posteriorly it is made of <strong>fascia iliaca.</strong></p>\n<p>It is divided into three compartments:</p>\n<ul>\n<li>The <strong>lateral</strong> compartment contains the <strong>femoral artery</strong></li>\n<li>The <strong>intermediate</strong> compartment contains the <strong>femoral vein</strong></li>\n<li>The <strong>medial</strong> compartment which is termed as <strong>femoral canal</strong> contains <strong>lymphatic vessels, areolar tissue, and lymph node of Cloquet.\u00a0</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1bfce278adec45bc822fd97f315744ffx1280x1535.JPEG"
    ]
  },
  {
    "text": "A 65-year-old female patient presented with sudden painless loss of vision and the following finding on fundoscopy. The artery involved is a direct branch of the vessel that travels through which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Superior orbital fissure"
      },
      {
        "id": 2,
        "text": "Inferior orbital fissure"
      },
      {
        "id": 3,
        "text": "Cavernous sinus"
      },
      {
        "id": 4,
        "text": "Optic canal"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario of sudden painless loss of vision with a cherry red spot noted on fundoscopy is suggestive of <strong>central retinal artery occlusion (CRAO)</strong>. The central retinal artery is a <strong>direct branch </strong>of the<strong> ophthalmic artery</strong> which passes through the <strong>optic canal</strong>.</p>\n<p>The structures passing through the optic canal are the<strong> optic nerve</strong> and the <strong>ophthalmic artery</strong>.</p>\n<p>The major structures passing through the <strong>superior orbital fissure </strong>(Option A) are:</p>\n<ul>\n<li>Oculomotor, Trochlear and Abducens Nerves (CN III, IV, VI)</li>\n<li>Lacrimal, Frontal and Nasociliary branches of the ophthalmic division of the Trigeminal Nerve (CN V<sub>1</sub>)</li>\n<li>Superior and Inferior Ophthalmic Veins</li>\n</ul>\n<p>The structures passing through the <strong>inferior orbital fissure </strong>(Option B) are:</p>\n<ul>\n<li>Infraorbital and Zygomatic branches of the maxillary division of the Trigeminal Nerve (CN V<sub>2</sub>)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/65f0e86d4100403dbf9d8231a631e8d2.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dd5ef4e300cf423aabedf8acbcdde313x1280x2027.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c25595eb48fe41ccae200b63c2aa735ex600x657.JPEG"
    ]
  },
  {
    "text": "In a patient, following venous cut down for access to the great saphenous vein, sensations over the medial side of the leg was lost. Which of the following nerves is involved in the given scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Obturator nerve"
      },
      {
        "id": 2,
        "text": "Posterior division of femoral nerve"
      },
      {
        "id": 3,
        "text": "Sural nerve"
      },
      {
        "id": 4,
        "text": "Anterior division of femoral nerve"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Loss of sensation of the medial side of the leg</strong> following venous cut down for access to the great saphenous vein denotes injury to the <strong>saphenous nerve</strong> which is a branch of the\u00a0<strong>posterior division of femoral nerve</strong>.</p>\n<p><strong>Saphenous nerve:</strong></p>\n<ul>\n<li>It is the longest and largest cutaneous branch of the femoral nerve and is the <strong>longest nerve in the body.</strong></li>\n<li>It arises from the <strong>posterior division of the femoral</strong> nerve. In the femoral triangle, it lies lateral to the femoral artery.</li>\n<li>It then enters the adductor canal where it crosses anterior to the femoral artery to lie medial to it. It leaves the adductor canal by piercing the fascia lata between the gracilis and sartorius and supplies the skin over patella.</li>\n<li>It then descends along the medial border of tibia along <strong>with long saphenous vein</strong> and supplies the skin on the <strong>medial side of knee leg and foot\u00a0</strong>as far as up to the first metatarsophalangeal joint.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b6c751b8791b4c4dabbcb5ee713f2bf7x1200x1836.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/55a94f6073cf4883a4856ccff008b15bx1200x1447.JPEG"
    ]
  },
  {
    "text": "Which of the following structures is related to the area marked A in the diagram below?",
    "choices": [
      {
        "id": 1,
        "text": "Superior vena cava"
      },
      {
        "id": 2,
        "text": "Arch of Aorta"
      },
      {
        "id": 3,
        "text": "Azygos vein"
      },
      {
        "id": 4,
        "text": "Left brachiocephalic trunk"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The area marked A is where the <strong>azygos vein</strong> arches over the hilum of the right lung.</p>\n<p>The diagram shown is of the\u00a0<strong>right lung</strong>, identified by the presence of <strong>hyparterial and eparterial bronchus at the hilum</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e7a06ab23c9a41199a6a76417dd1cc69.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "An intern was asked to give an intravenous injection to a vein in the cubital fossa. All of the following are true about the cubital fossa except:",
    "choices": [
      {
        "id": 1,
        "text": "Brachioradialis forms the lateral boundary"
      },
      {
        "id": 2,
        "text": "Musculocutaneous nerve is one of the contents"
      },
      {
        "id": 3,
        "text": "Radial nerve enters the fossa laterally"
      },
      {
        "id": 4,
        "text": "Median cubital vein forms the roof"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>musculocutaneous nerve</strong> is not a content of the cubital fossa.</p>\n<p>The <strong>cubital fossa</strong> is a triangular depression present in the anterior side of the elbow joint. The boundaries of the cubital fossa include:</p>\n<ul>\n<li>Medially: Lateral border of the pronator teres</li>\n<li><strong>Laterally:</strong> Medial border of the <strong>brachioradialis</strong> (option A)</li>\n<li>Base: Proximally by an imaginary line joining the epicondyles of the humerus</li>\n<li>Apex (pointed downward): Joining of the lateral and medial boundaries.</li>\n<li><strong>Roof:</strong> Skin, superficial fascia containing <strong>median cubital vein</strong> (option D) joining the cephalic and basilic veins, lateral cutaneous nerve of the forearm, medial cutaneous nerve of the forearm, bicipital aponeurosis, and deep fascia.</li>\n<li>Floor: Brachialis and supinator muscles.</li>\n</ul>\n<p>The contents of the brachial fossa are (from medial to lateral side):</p>\n<ul>\n<li><strong>Median nerve</strong></li>\n<li><strong>Brachial artery</strong>, terminating into radial and ulnar arteries</li>\n<li><strong>Biceps brachii</strong> tendon with the bicipital aponeurosis</li>\n<li><strong>Radial nerve\u00a0</strong>enters the fossa laterally (option C) in the groove between the brachialis and brachioradialis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9d1c9e2551964aefa6e0031604454010x1280x2558.JPEG"
    ]
  },
  {
    "text": "An angiography study was done for a patient who presented with chronic dysphagia. The following vascular anomaly of the aortic arch was found to be the cause. Identify the anomaly.",
    "choices": [
      {
        "id": 1,
        "text": "Aberrant right common carotid artery"
      },
      {
        "id": 2,
        "text": "Aberrant left common carotid artery"
      },
      {
        "id": 3,
        "text": "Aberrant right subclavian artery"
      },
      {
        "id": 4,
        "text": "Aberrant left subclavian artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The vascular anomaly that is causing the dysphagia in this patient is an<strong>\u00a0aberrant right subclavian artery</strong>.<strong> </strong>This condition is known as <strong>dysphagia lusoria</strong>.</p>\n<p>Dysphagia lusoria is dysphagia produced due to<strong>\u00a0</strong>compression of the esophagus by a developmental vascular anomaly, often an <strong>aberrant right subclavian artery</strong>. It arises directly from the aortic arch.</p>\n<p>It can be diagnosed\u00a0by\u00a0<strong>CT angiography</strong>. Treatment\u00a0is surgical repair either by\u00a0<strong>reconstruction</strong>\u00a0or\u00a0<strong>ligation</strong>\u00a0of the aberrant right subclavian artery.</p>\n<p>The CT image below shows the presence of an<strong>\u00a0</strong>aberrant right subclavian artery:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/230f17e7c4fc4333b739e8bab419e992.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/472a57c1711d41b19d2ed04d6fc0729ex720x688.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/00f86db621094550b23baaffe2ed7c76x1200x1324.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/36eb940199544c23ae66a51e7f290e80x720x458.PNG"
    ]
  },
  {
    "text": "Which of the following is the most medial structure passing through the canals in the flexor retinaculum of the foot?",
    "choices": [
      {
        "id": 1,
        "text": "Flexor digitorum longus tendon"
      },
      {
        "id": 2,
        "text": "Tibial nerve"
      },
      {
        "id": 3,
        "text": "Tibialis posterior tendon"
      },
      {
        "id": 4,
        "text": "Posterior tibial vessels"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Tibialis posterior tendon</strong> is the most medial structure passing through the canals in the <strong>flexor retinaculum</strong> of the foot.</p>\n<p>The flexor retinaculum of the foot converts grooves on the tibia and calcaneus into canals for the tendons. The structures passing through canals formed by flexor retinaculum are as follows: (Starting from the medial side- mnemonic <strong>T</strong>om, <strong>D</strong>ick <strong>A</strong>nd <strong>V</strong>ery <strong>N</strong>ervous <strong>H</strong>arry)</p>\n<p>T: <strong>t</strong>ibialis posterior tendon<br />D: flexor <strong>d</strong>igitorum longus<br />A: <strong>a</strong>rtery (posterior tibial)<br />V: <strong>v</strong>ein (posterior tibial)<br />N: <strong>n</strong>erve (tibial)<br />H: flexor <strong>h</strong>allucis longus tendon</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d5675634e95f4b0489a0d5195a327cb9x1280x2558.JPEG"
    ]
  },
  {
    "text": "Artery passing through the structure marked in the diagram below is a branch of?",
    "choices": [
      {
        "id": 1,
        "text": "Medial circumflex femoral artery"
      },
      {
        "id": 2,
        "text": "Lateral circumflex femoral artery"
      },
      {
        "id": 3,
        "text": "Obturator artery"
      },
      {
        "id": 4,
        "text": "Profunda femoris artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shown is the ligament of head of the femur and the artery passing through it is a branch of <strong>obturator artery.</strong></p>\n<p class=\"p1\">The blood supply of the femoral head is derived from an <strong>arterial ring\u00a0(Trochanteric anastomosis)</strong> around the neck of femur constituted by:</p>\n<ul>\n<li class=\"p1\">Medial\u00a0circumflex femoral arteries\u00a0</li>\n<li class=\"p1\">Lateral circumflex femoral arteries</li>\n<li class=\"p1\">Superior and inferior gluteal vessels (minor contributions)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9d39b13b8d6a472ca6147df575715512.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/64358d8d251f43c6b9ca926249901742x1280x1160.JPEG"
    ]
  },
  {
    "text": "During laparoscopic hernia surgery in a male patient, a nerve located within the triangle of doom is injured. This nerve provides sensory innervation to which of the following regions?",
    "choices": [
      {
        "id": 1,
        "text": "Suprapubic area"
      },
      {
        "id": 2,
        "text": "Anterior thigh below the inguinal ligament"
      },
      {
        "id": 3,
        "text": "Skin of scrotum"
      },
      {
        "id": 4,
        "text": "Root of the penis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>genital branch of the genitofemoral nerve</strong> is a content of the triangle of doom and can be injured in laparoscopic hernia surgery. The genital branch of the genitofemoral nerve supplies sensation to the <strong>skin of the scrotum.</strong></p>\n<p>The genital branch of the genitofemoral nerve provides nerve supply to:</p>\n<ul>\n<li><strong>Motor</strong> innervation to the <strong>cremaster</strong> muscle in males</li>\n<li>Sensory innervation to:\n<ul>\n<li>The <strong>skin of the scrotum</strong> in males</li>\n<li><strong>Mons pubis</strong> and <strong>labia majora</strong> in females</li>\n</ul>\n</li>\n</ul>\n<p>The boundaries of the triangle of doom are:</p>\n<ul>\n<li>Medially- ductus deferens</li>\n<li>Laterally- gonadal vessels in the spermatic cord</li>\n<li>Posteroinferiorly- peritoneal reflection</li>\n<li>Apex- deep inguinal ring</li>\n</ul>\n<p>The important <strong>contents</strong> of the triangle of doom include:</p>\n<ul>\n<li>External iliac vessels</li>\n<li>Deep circumflex iliac vein</li>\n<li><strong>Genital branch of the genitofemoral nerve</strong></li>\n<li>Femoral nerve</li>\n</ul>\n<p>Other important surgical landmarks in this region are the triangle of pain and the crown of death.</p>\n<p>The figure below shows the triangle of doom with its boundaries and contents-</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6b58ff5337824199864b1ce94f9b5f64x1279x1055.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/acc91eb5568b43a69105d2500b263844x1279x1662.JPEG"
    ]
  },
  {
    "text": "Which of the following Couinaud segments of the liver drains directly into the inferior vena cava?",
    "choices": [
      {
        "id": 1,
        "text": "Segment 4a"
      },
      {
        "id": 2,
        "text": "Segment 2"
      },
      {
        "id": 3,
        "text": "Segment 4b"
      },
      {
        "id": 4,
        "text": "Segment 1"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Segment 1 (Caudate lobe) </strong>drains directly into the Inferior vena cava(IVC).</p>\n<p><strong>Couinaud classification </strong>is the commonly used classification of the liver. It divides the liver into eight segments. It is based on the distribution of <strong>portal venous branches</strong> in the liver parenchyma. Each segment has its own dual vascular inflow, biliary drainage, and lymphatic drainage.</p>\n<p>The <strong>left lobe</strong> is composed of the left lateral segment (<strong>Couinaud\u2019s segments II and III</strong>) and the left medial segment (<strong>segment IV</strong>). The <strong>right lobe</strong> is composed of segments<strong> V, VI, VII, and VIII, </strong>with segments V and VIII making up the right anterior lobe and segments VI and VII making up the right posterior lobe.</p>\n<p><strong>Segment I</strong> corresponds to the <strong>caudate lobe </strong>of the liver and <strong>segment IV</strong> corresponds to the <strong>quadrate lobe</strong> of the liver. Segment IV is divided into segments<strong> IVa</strong> and <strong>IVb</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7ac09a7e054740718891cee0c9475987x1280x1080.JPEG"
    ]
  },
  {
    "text": "Identify the structure marked in the diagram given below:",
    "choices": [
      {
        "id": 1,
        "text": "Phrenic nerve"
      },
      {
        "id": 2,
        "text": "Accessory spinal nerve"
      },
      {
        "id": 3,
        "text": "Greater auricular nerve"
      },
      {
        "id": 4,
        "text": "Suprascapular nerve"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above image shows spinal accessory nerve.\u00a0<strong>Spinal accessory nerve enters the posterior triangle passing deep to the sternocleidomastoid muscle</strong> and runs in an oblique direction within the triangle to supply Trapezius.</p>\n<p>Phrenic nerve is seen related to the <strong>anterior</strong> surface of Scalenus anterior.\u00a0</p>\n<p>Greater auricular nerve (C2,3) Lesser occipital nerve (C2) and supraclavicular nerve (C3,4) emerge from the posterior border of sternocleidomastoid muscle.</p>\n<p>Lesser occipital nerve runs upwards along the posterior border of sternocleidomastoid muscle, greater auricular nerve ascends across the muscle and supraclavicular nerve descends and supplies skin over the clavicle).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a0fb70f2dfa34503a3f04f37e42b1f9d.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c948f5a15da48c58c064226760fcf6ax1280x1666.JPEG"
    ]
  },
  {
    "text": "A male patient was posted for abscess drainage from the ischioanal fossa. While draining the abscess, the surgeon injures the nerve present in Alcock's canal. Which nerve is injured in the given scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Obturator nerve"
      },
      {
        "id": 2,
        "text": "Genitofemoral nerve"
      },
      {
        "id": 3,
        "text": "Pudendal nerve"
      },
      {
        "id": 4,
        "text": "Accessory obturator nerve"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The nerve that passes through <strong>Alcock's canal</strong> and is injured in the given scenario is the <strong>pudendal nerve. </strong></p>\n<p><strong>Alcock's canal</strong>\u00a0or<strong> pudendal canal</strong> is an enclosed fascia along the <strong>lateral wall</strong> of the <strong>ischioanal fossa.</strong> Its contents include:</p>\n<ul>\n<li>Internal pudendal artery</li>\n<li>Internal pudendal vein</li>\n<li><strong>Pudendal nerve</strong></li>\n</ul>\n<p>The <strong>pudendal nerve</strong> originates from the <strong>ventral rami</strong> of <strong>S2, S3,</strong> and <strong>S4</strong> of the <strong>sacral plexus</strong>. It <strong>exits</strong> out of the<strong> pelvis</strong> by passing through the <strong>greater</strong> <strong>sciatic foramen</strong>. It then enters the perineum below the pelvic floor.\u00a0</p>\n<p>In the pudendal canal, the pudendal nerve gives off the inferior rectal nerve, perineal nerve, and dorsal nerve of the penis or clitoris.</p>\n<p>In females, the pudendal nerve supplies sensory branches to the lower of the vagina. Therefore, in vaginal surgeries, <strong>anesthesia</strong> can be <strong>infiltrated</strong> near the <strong>ischial spine</strong> by a needle passed through the vaginal wall and then guided by a finger.</p>\n<p>The image given below shows the contents and boundaries of the ischioanal fossa.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ec99b475d970402ea54a9bb292178747x1280x1244.JPEG"
    ]
  },
  {
    "text": "The relationship of the components of the neurovascular bundle from below upwards in intercostal space is _______",
    "choices": [
      {
        "id": 1,
        "text": "Vein-artery-nerve"
      },
      {
        "id": 2,
        "text": "Artery-nerve-vein"
      },
      {
        "id": 3,
        "text": "Vein-nerve-artery"
      },
      {
        "id": 4,
        "text": "Nerve-artery-vein"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The arrangement of the components of the neurovascular bundle in the intercostal space from<strong> below upwards</strong> is <strong>nerve-artery-vein</strong>.\u00a0</p>\n<p>The arrangement can be remembered from <strong>above downwards</strong> with the mnemonic <strong>VAN:</strong> <strong>v</strong>ein-<strong>a</strong>rtery-<strong>n</strong>erve.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/46f3afbb3c9d4b6a8297201220c33b98x600x596.JPEG"
    ]
  },
  {
    "text": "An elderly man with atherosclerosis presented with abdominal pain and blood-stained stools.  CECT abdomen is suggestive of ischemic colitis at the splenic flexure involving the marginal artery of Drummond. What are the arteries contributing to the formation of this structure?",
    "choices": [
      {
        "id": 1,
        "text": "Right colic and left colic arteries"
      },
      {
        "id": 2,
        "text": "Ileocolic and left colic arteries"
      },
      {
        "id": 3,
        "text": "Left colic and middle colic arteries"
      },
      {
        "id": 4,
        "text": "Left colic and sigmoid arteries"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The<strong> middle </strong>and<strong> left colic arteries</strong>\u00a0contribute to the formation of the <strong>marginal artery </strong>of<strong> Drummond </strong>at the splenic flexure.\u00a0The<strong> splenic flexure (Griffith's point) </strong>is a<strong> watershed area </strong>of the colon which is more prone to<strong> ischemia.\u00a0</strong></p>\n<p>The anastomotic vessel that runs in the mesentery along the inner margin of the colon is called the marginal artery of Drummond. From this artery, numerous small branches are given to the large bowel. It is formed by:</p>\n<ul>\n<li>Branches of <strong>superior mesenteric artery - </strong>middle colic, right colic, and ileocolic arteries</li>\n<li>Branches of <strong>inferior mesenteric artery - </strong>left colic, sigmoid, and superior rectal arteries</li>\n</ul>\n<p>When ischemia occurs at Griffith's point, the blood supply in this region is augmented by another arterial loop called the <strong>inner arterial arc (of Riolan).</strong> This arc connects the main trunk of the <strong>middle colic artery</strong> with the ascending branch of the<strong> left colic artery</strong>.</p>\n<p>Note: <strong>Sudeck's point</strong> is another watershed area present at the <strong>rectosigmoid junction</strong>. The <strong>sigmoid artery</strong> anastomoses with the <strong>superior rectal artery</strong> at this site.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e0e97a8c8aa3448a8c69bff4f49e06fex600x771.JPEG"
    ]
  },
  {
    "text": "In a cadaveric dissection, the openings of the diaphragm were observed. Through which of the following openings does the vagus nerve pass?",
    "choices": [
      {
        "id": 1,
        "text": "2"
      },
      {
        "id": 2,
        "text": "1"
      },
      {
        "id": 3,
        "text": "4"
      },
      {
        "id": 4,
        "text": "3"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>anterior</strong> and <strong>posterior trunks</strong> of the <strong>vagus</strong> nerve (cranial nerve X) pass through the <strong>esophageal hiatus</strong> (4) of the diaphragm.\u00a0</p>\n<p>Other structures:</p>\n<ul>\n<li>1 - Medial arcuate ligament\u00a0</li>\n<li>2 - Aortic opening\u00a0</li>\n<li>3 - Vena caval opening</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/cf1e637cf35e46e788d40b89290aaaaf.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3f41a7e8b2104d94b500b45a02651c90x1280x1382.JPEG"
    ]
  }
];
        let quizName = 'Vein, Artery & Nerve (Van) Mini Test';
        const quizFilename = 'vein-artery-nerve-van-mini-test-1aef4df0.html';
        let hierarchy = ["Marrow", "FMGE Mini Test Series", "2025"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>