<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fmge  Mini Test - 15 - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / FMGE Mini Test Series / 2021
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">15</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Identify the muscle marked as A in the image given below:",
    "choices": [
      {
        "id": 1,
        "text": "Anconeus"
      },
      {
        "id": 2,
        "text": "Extensor carpi ulnaris"
      },
      {
        "id": 3,
        "text": "Extensor carpi radialis brevis"
      },
      {
        "id": 4,
        "text": "Extensor digitorum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The muscle labeled as <strong>A </strong>is<strong> anconeus</strong> and its functions are</p>\n<ul>\n<li>Abduction of the wrist in pronated position</li>\n<li>Accessory extension of elbow joint</li>\n</ul>\n<p>Other options:&nbsp;</p>\n<ul>\n<li>The muscle marked as <strong>B</strong> is <strong>extensor</strong> <strong>carpi</strong> <strong>radialis</strong>&nbsp;<strong>brevis</strong>, and it extends and abducts the wrist joint</li>\n<li>The muscle marked as<strong>&nbsp;C is extensor digitorum,</strong> and it mainly extends the index, middle, ring, and little fingers and also extends the wrist.</li>\n<li>The muscle marked as <strong>D</strong><strong>&nbsp;is extensor carpi ulnaris,</strong> and it extends and adducts the wrist joint.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0efdd9c94fa1419aba065ee7593d16fa.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9ccf3983f3a9412db94b365bad66a425x1280x1850.JPEG"
    ]
  },
  {
    "text": "The ferrous form is converted to ferric form in the basolateral aspect of the intestinal mucosal cell by which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Ferric Reductase"
      },
      {
        "id": 2,
        "text": "Divalent Metal Transporter 1"
      },
      {
        "id": 3,
        "text": "Ferroportin 1"
      },
      {
        "id": 4,
        "text": "Hephaestin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hephaestin</strong> (Hp) converts <strong>Fe<sup>2+</sup>(ferrous) to Fe<sup>3+</sup> (ferric),</strong> which is transported in plasma bound to transferrin.</p>\n<p>Other Options:</p>\n<ul>\n<li><strong>Ferric Reductase (DCYTB):</strong> Converts dietary Fe3+ to absorbable Fe2+ in the apical/luminal aspect of the intestinal mucosal cell.</li>\n<li><strong>Divalent Metal Transporter 1 (DMT1):</strong> Transports Fe<sup>2+</sup> from the intestinal lumen into the intestinal mucosal cell.</li>\n<li><strong>Ferroportin 1 (FPN1):</strong> Transports Fe<sup>2+</sup> from the mucosal cell into the interstitial fluid and then into the plasma.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a68fb58fa17a4780822adc88ad469e48x1279x1098.JPEG"
    ]
  },
  {
    "text": "Which of the following anti-epileptic drug  is responsible for blisters, erythema, and discoloration of  hand as shown below.?",
    "choices": [
      {
        "id": 1,
        "text": "Phenobarbitone"
      },
      {
        "id": 2,
        "text": "Levetiracetam"
      },
      {
        "id": 3,
        "text": "Phenytoin"
      },
      {
        "id": 4,
        "text": "Lamotrigine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><span data-preserver-spaces=\"true\"><strong>Phenytoin&nbsp;</strong></span><span data-preserver-spaces=\"true\">is responsible for&nbsp;<strong>Purple glove syndrome&nbsp;</strong>as shown in the image.&nbsp;</span></p>\n<p><span data-preserver-spaces=\"true\">Side effects of phenytoin include:</span></p>\n<ul>\n<li><span data-preserver-spaces=\"true\">Hirsutism</span></li>\n<li><span data-preserver-spaces=\"true\">Hypersensitivity reactions</span></li>\n<li><span data-preserver-spaces=\"true\">Osteomalacia</span></li>\n<li><span data-preserver-spaces=\"true\">Megaloblastic anemia</span></li>\n<li><span data-preserver-spaces=\"true\">Fetal hydantoin syndrome (hypoplastic phalanges, cleft palate, hare lip, microcephaly) (First image shown below)</span></li>\n</ul>\n<p><strong><span data-preserver-spaces=\"true\">Dose-related toxicity</span></strong><span data-preserver-spaces=\"true\">&nbsp;of phenytoin causes the following:</span></p>\n<ul>\n<li><strong><span data-preserver-spaces=\"true\">Ataxia, vertigo, diplopia, and nystagmus</span></strong><span data-preserver-spaces=\"true\">&nbsp;(most characteristic)</span></li>\n</ul>\n<p><strong>Other options:&nbsp;</strong></p>\n<p>Phenobarbitone can also cause blisters (second image shown below) and bullae. But that is usually associated with chronic poisoning and is not an acute reaction. Levitracetam and Lamotrigene and very safe drugs with good efficacy.&nbsp;</p>\n<p><strong>Better alternative for IV phenytoin:</strong></p>\n<p>Instead of Phenytoin, IV Fosphenytoin is preferred in the management of status epilepticus. It is a pro-drug and is rapidly converted to Phenytoin and since it is an ester, it seldom causes such reaction.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7dd1f62a3849404ea7f1d71f187e3e94.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5e97bccf06d8446b8aa70167465ae978x1280x2129.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/afad8f1f83cd4736a9dfdff74b8012dcx720x698.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ecb756b2e02241829e9dcbdc4ad970afx303x519.PNG"
    ]
  },
  {
    "text": "Which of the following statements is incorrect regarding the causative organism in Q fever?",
    "choices": [
      {
        "id": 1,
        "text": "There is\u00a0no vector\u00a0involved in the transmission of this disease"
      },
      {
        "id": 2,
        "text": "It is a category A bioterrorism agent"
      },
      {
        "id": 3,
        "text": "Doxycycline and hydroxychloroquine are preferred for treatment"
      },
      {
        "id": 4,
        "text": "Indirect immunofluorescence is the best investigation for diagnosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Q fever </strong>is&nbsp;caused by<strong> Coxiella burnetti </strong>which is a Bioterrorism<strong> category B</strong>&nbsp;agent and should be&nbsp;cultivated in&nbsp;only biosafety level 3 laboratories.</p>\n<p>It is a zoonotic disease and the most commonly identified sources of human infection are farm animals, such as cattle, goats, and sheep.&nbsp;Infected mammals shed&nbsp;<em>C. burnetii</em>&nbsp;in their urine, feces, milk, and placenta.&nbsp;Human exposure to&nbsp;<em>C. burnetii</em>&nbsp;may occur as a result of inhalation of contaminated aerosols arising from the placenta or parturient fluids of infected livestock or from contaminated secretions and consumption of unpasteurized contaminated milk. There is&nbsp;<strong>no vector</strong>&nbsp;involved in the transmission of the disease to man. Ticks can act as reservoirs.</p>\n<p>Incubation period usually lasts for 2 to 3 weeks.</p>\n<p>People working with farm animals and veterinarians are at a higher risk of infection.</p>\n<p>Infection can be acute or chronic. Acute disease resembles influenza (fever, chills, headache), nonbacterial (atypical) pneumonia, and hepatitis.&nbsp;There is&nbsp;no skin lesion.</p>\n<p>Chronic Q fever lasts more than 6 months. Infective endocarditis is the most common form of disease in this phase. Blood cultures for bacteria are negative, and there is a high titer of antibodies to C burnetii.</p>\n<p><strong>Diagnosis</strong>:</p>\n<p>Serology is the diagnostic method of choice for Coxiella brunettii&nbsp;which shows&nbsp;a rise in the titer of specific antibodies to C. burnetii. But&nbsp;<strong>indirect immunofluorescence</strong> is considered the <strong>best method</strong>. PCR is&nbsp;useful in diagnosing culture-negative endocarditis.</p>\n<p>A&nbsp;<strong>single positive blood culture</strong>&nbsp;for&nbsp;<em><strong>Coxiella burnetti&nbsp;</strong></em>is considered as one of the&nbsp;<strong>major criteria</strong>&nbsp;to establish the&nbsp;<strong>diagnosis of infective endocarditis.</strong></p>\n<p><strong>Treatment:</strong></p>\n<p><strong>Doxycycline</strong> is the drug of choice for the treatment of acute Q fever.&nbsp;Chronic Q fever requires&nbsp;treatment for at least 18 months with&nbsp;doxycycline and hydroxychloroquine.</p>\n<p><strong>Prevention:</strong></p>\n<p>Currently,<strong> &ldquo;high-temperature, short-time&rdquo; pasteurization at 71.5&deg;C for 15 seconds </strong>is recommended&nbsp;to destroy viable Coxiella species in milk.</p>\n<p><strong>Pasteurization&nbsp;</strong>can be done by heating the&nbsp;Milk &nbsp;at either&nbsp;</p>\n<ul>\n<li><strong>63&deg;C&nbsp;for 30 minutes:</strong>&nbsp;the&nbsp;<strong>Holder&nbsp;</strong><strong>method</strong>&nbsp;or</li>\n<li><strong>72&deg;C&nbsp;for 15&ndash;20 seconds:</strong>&nbsp;the&nbsp;<strong>flash</strong>&nbsp;<strong>process</strong></li>\n</ul>\n<p>Once heated appropriately, the milk is&nbsp;<strong>cooled&nbsp;</strong>quickly to&nbsp;<strong>13&deg;C</strong>&nbsp;or lower.&nbsp;</p>\n<p>All the&nbsp;<strong>non-sporing</strong>&nbsp;pathogens are killed except&nbsp;<strong>Coxiella burnetti</strong><em><strong>,</strong></em>&nbsp;which may survive in the&nbsp;<strong>Holder method</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false about RB as the governor of cell cycle?",
    "choices": [
      {
        "id": 1,
        "text": "The function of RB protein is to regulate at the G1-S checkpoint"
      },
      {
        "id": 2,
        "text": "Hypophosphorylated state of the RB promote cell cycle progression"
      },
      {
        "id": 3,
        "text": "Active RB binds and inhibits the E2F family of transcription factors preventing transcription of cyclin E"
      },
      {
        "id": 4,
        "text": "Cyclin D/CDK-4 phosphorylates RB"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hyperphosphorylated state (inactive) </strong>of RB protein promotes <strong>cell cycle progression</strong>.</p>\n<p>RB, called the Governor of Proliferation is a key <strong>negative regulator</strong> of the <strong>G1/S cell cycle transition</strong> and is directly or indirectly inactivated in most human cancers.</p>\n<ul>\n<li>The <strong>normal RB gene </strong>is present on <strong>chromosome 13q14</strong>.</li>\n<li>RB -\u00a0 <strong>active hypophosphorylated </strong>state in quiescent cells and an inactive hyperphosphorylated state in cells passing through the G1/S cell cycle transition.</li>\n<li>Cyclin D/CDK-4 phosphorylates RB inactivating the protein, and <strong>releases E2F </strong>to induce target genes such as <strong>cyclin E</strong>.</li>\n<li>RB -\u00a0 antiproliferative effects by binding and inhibiting E2F transcription factors, thereby preventing transcription of cyclin E, required for cells to pass through the <strong>G1-S phase </strong>cell cycle checkpoint.</li>\n<li>The antiproliferative effect of RB is abrogated in cancers through a variety of mechanisms, including:\n<ul>\n<li>Loss-of-function mutations affecting RB</li>\n<li><strong>Gene amplification</strong> of CDK4 and cyclin D genes</li>\n<li>Loss of cyclin-dependent kinase inhibitors (p16/INK4a)</li>\n<li>Viral oncoproteins that bind and inhibit RB (E7 protein of HPV)</li>\n</ul>\n</li>\n</ul>\n<p><strong>Loss-of-function mutations</strong> of the RB gene are associated with retinoblastoma and osteosarcoma, a subset of glioblastomas, small-cell carcinomas of the lung, breast cancers, and bladder carcinomas.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are a medical officer actively spearheading the STD control program in your block. As part of this, the sexual partners of the diagnosed patients are investigated and treated for the disease. This type of case detection that is employed by your team is  called ___________",
    "choices": [
      {
        "id": 1,
        "text": "Cluster testing"
      },
      {
        "id": 2,
        "text": "High-risk screening"
      },
      {
        "id": 3,
        "text": "Selective screening"
      },
      {
        "id": 4,
        "text": "Contact tracing"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Method of case detection in control of STDs when the sexual partners of the diagnosed patients are tested and treated is <strong>contact tracing.</strong></p>\n<p>Methods employed in <strong>case of detection of STDs</strong> are</p>\n<ul>\n<li><strong>Screening</strong>: testing of apparently healthy volunteers from the general population for early detection of disease.</li>\n<li><strong>Contact tracing</strong>: the technique by which the sexual partners of diagnosed patients are identified, located, investigated, and treated.</li>\n<li><strong>Cluster testing</strong>: the patients are asked to name other persons of either sex who move in the same socio-sexual environment.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presents with a past history headache, fatigue and cyclical fever for which was treated with medication. Now he presents with complaints of glare and discomfort of the eyes. Findings seen on slit lamp examination are given below. Which of the following findings would you expect to see on a fundoscopy?",
    "choices": [
      {
        "id": 1,
        "text": "Hypotony maculopathy"
      },
      {
        "id": 2,
        "text": "Bull\u2019s eye maculopathy"
      },
      {
        "id": 3,
        "text": "Cystoid maculopathy"
      },
      {
        "id": 4,
        "text": "No maculopathy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The fundoscopy will reveal a&nbsp;<strong>Bull&rsquo;s eye maculopathy<br /> </strong></p>\n<p>The given clinical scenario and the given slit lamp findings of <strong>Cornea verticillata</strong> point to a treatment of suspected malarial fever with <strong>Chloroquine</strong>.</p>\n<p>Chloroquine is often implicated in the findings of Bull&rsquo;s eye maculopathy. <strong>&nbsp;</strong></p>\n<p>The image below shows Bull&rsquo;s eye maculopathy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/93bc305a4ef84029839219ad78dfd44d.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c807f3e7e4f047a399362602e62bac94x589x216.PNG"
    ]
  },
  {
    "text": "The center for the reflex that protects the cochlea from exposure to loud sounds is :",
    "choices": [
      {
        "id": 1,
        "text": "Medial Geniculate Body"
      },
      {
        "id": 2,
        "text": "Superior Colliculus"
      },
      {
        "id": 3,
        "text": "Lateral Lemniscus"
      },
      {
        "id": 4,
        "text": "Superior Olivary complex"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The center for the stapedial reflex that protects the cochlea from exposure to loud sounds is<strong> Superior Olivary Complex.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A baby is brought to the hospital with the following lesions on the body. The lesion started 2 days ago and has increased in number. Similar lesions are also present on the lower limbs. Examination of the oral cavity also has similar lesions. Which of the following infection most commonly proceeds with this skin condition?",
    "choices": [
      {
        "id": 1,
        "text": "Herpes simplex"
      },
      {
        "id": 2,
        "text": "Varicella"
      },
      {
        "id": 3,
        "text": "Variola"
      },
      {
        "id": 4,
        "text": "Mumps"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image shows <strong>target lesions&nbsp;</strong>that are seen in <strong>erythema multiforme.&nbsp;</strong>Infection with <strong>Herpes simplex</strong> commonly proceeds with this skin condition.</p>\n<p>Erythema Multiforme is a<strong>&nbsp;self\u2010limiting cytotoxic dermatitis</strong>&nbsp;resulting from cell\u2010mediated hypersensitivity most commonly to infection or drugs.</p>\n<p>The common triggers are</p>\n<ul>\n<li><strong>Herpes simplex infection</strong></li>\n<li>Mycoplasma infection</li>\n<li>Bacterial infections</li>\n<li>Fungal infections</li>\n<li>Vaccinations</li>\n<li>Malignancy: carcinoma, lymphoma, leukemia</li>\n<li>Drug reactions: sulfonamides, cotrimoxazole, penicillins</li>\n<li>Miscellaneous: Lupus erythematosus (Rowell Syndrome), Sarcoidosis, Polyarteritis Nodosa</li>\n</ul>\n<p>It presents clinically with macular, popular, or urticarial lesions, along with the&nbsp;<strong>classic acral iris</strong>&nbsp;or&nbsp;<strong>target lesions</strong>. The lesions are distributed on the distal extremities, palms or trunk, and oral and genital mucous membranes.</p>\n<p>Target lesions are less than 3 cm in diameter, rounded, and have&nbsp;<strong>three</strong>&nbsp;zones:</p>\n<ul>\n<li>The central area of&nbsp;<strong>dusky erythema</strong>&nbsp;or purpura</li>\n<li>Middle paler zone of&nbsp;<strong>edema</strong></li>\n<li>The outer ring of&nbsp;<strong>erythema</strong>&nbsp;with a well\u2010defined edge</li>\n</ul>\n<p>Atypical lesions will have only 2 zones. They fade in <strong>1-2 weeks</strong> leaving dusky <strong>discoloration.</strong></p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/92215aaded444c68936c0288c69f764d.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old man presents with complaints of excess uncontrollable worry over daily life activities, finance, and his health over the past 2 years. Because of this, he feels restless most of the time. He also complains of fatigue and disturbed sleep. Which of the following drugs are the first-line choice for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "SSRI"
      },
      {
        "id": 2,
        "text": "MAO-I"
      },
      {
        "id": 3,
        "text": "Benzodiazepines"
      },
      {
        "id": 4,
        "text": "TCA"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given symptoms favour a diagnosis of generalised anxiety disorder.&nbsp;<strong>Selective serotonin reuptake</strong> <strong>inhibitors</strong> are the first-line choice in the treatment of generalized anxiety disorder.</p>\n<p>Generalised anxiety disorder is characterized by:</p>\n<ul>\n<li>Excessive anxiety and worry about a number of events or activities for&nbsp;<strong>at least 6 months.</strong></li>\n<li>Associated with three (or more) of the following.\n<ul>\n<li>Restlessness</li>\n<li>Being easily fatigued</li>\n<li>Difficulty concentrating</li>\n<li>Irritability</li>\n<li>Muscle tension</li>\n<li>Sleep disturbance</li>\n</ul>\n</li>\n</ul>\n<p>Short acting benzodiazepines such as alprazolam are used during acute episodes.</p>\n<p>CBT is advised along with SSRIs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Right sided fish hook ureter is seen in ______",
    "choices": [
      {
        "id": 1,
        "text": "Retrocaval ureter"
      },
      {
        "id": 2,
        "text": "Retroperitoneal fibrosis"
      },
      {
        "id": 3,
        "text": "Medullary sponge kidney"
      },
      {
        "id": 4,
        "text": "Multicystic dysplastic kidney"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Right sided fish hook</strong> ureter describes the appearance of <strong>retrocaval ureter</strong> as the right ureter hooks behind the IVC, it has also been referred to as an S-shaped ureter.</p>\n<ul>\n<li><strong>Bilateral Fishhook ureters </strong>(<strong>\"J-shaped ureters\"</strong> or <strong>\"hockey stick ureter\"</strong><strong>) </strong>describe the course of the distal ureter in patients with significant <strong>benign prostatic hypertrophy</strong>.</li>\n<li><strong>Circumcaval ureter</strong>, or <strong>retrocaval ureter</strong>, is a <strong>developmental anomaly of the inferior vena cava (IVC)</strong>. This congenital abnormality occurs as a result of the right supracardinal system failing to develop normally. The <strong>right posterior cardinal vein persists, and therefore ends up passing in front of the ureter</strong>. The anomaly always occurs on the <strong>right side</strong>, as this is the side of the normal IVC.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8d32e8a75ff04552a9c7c6b3c898693a.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old chronic smoker patient is brought to the hospital due to pain and weakness in the left arm for the past week. He also complains of left-sided chest pain for the last 3 weeks along with malaise, fever and weight loss for the past month. Which of the following tests is more likely to point to the diagnosis in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Chest CT"
      },
      {
        "id": 2,
        "text": "MRI Abdomen"
      },
      {
        "id": 3,
        "text": "ECG"
      },
      {
        "id": 4,
        "text": "Cardiac troponins"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This patient&rsquo;s clinical features of left-sided chest pain, fever, weight loss, and malaise combined with pain and weakness of the left arm are suggestive of a <strong>Pancoast tumor</strong>. Chest CT is the best test to arrive at the diagnosis in this patient.</p>\n<p><strong>Pancoast syndrome/superior sulcus tumor</strong> results from a local extension of a tumor growing in the apex of the lung, with the involvement of C8, T1, and T2 nerve roots.</p>\n<p>It presents with pain that radiates to the ulnar distribution of the arm, often with the destruction of the 1st and 2nd ribs. Patients with the central or endobronchial growth of the primary tumor may present with a cough, hemoptysis, wheeze, stridor, dyspnea, or postobstructive pneumonitis.</p>\n<p>A regional spread can cause:</p>\n<ul>\n<li>Tracheal obstruction,</li>\n<li>Esophageal compression with dysphagia</li>\n<li>Recurrent laryngeal paralysis with hoarseness</li>\n<li>Phrenic nerve palsy with the elevation of the hemidiaphragm and dyspnea</li>\n<li>Sympathetic nerve paralysis with Horner&rsquo;s syndrome (enophthalmos, ptosis, miosis, and anhydrosis).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 55-year-old male presents with right upper quadrant pain, nausea, vomiting, and low-grade fever. Physical examination demonstrates crepitus over the right upper quadrant. Ultrasound evaluation reveals air in the walls of the gall bladder. What is the indicated management in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Emergency cholecystectomy"
      },
      {
        "id": 2,
        "text": "Antibiotics + Cholecystectomy 72hrs later"
      },
      {
        "id": 3,
        "text": "Antibiotics only"
      },
      {
        "id": 4,
        "text": "ERCP"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical vignette and USG findings of air in the wall of the gall bladder are suggestive of <strong>emphysematous cholecystitis.</strong>&nbsp;This is managed with <strong>emergency cholecystectomy.</strong></p>\n<p><strong>Emphysematous cholecystitis </strong>is a life-threatening form of acute cholecystitis that is more common in older patients with<strong> diabetes mellitus.&nbsp;</strong>The term refers to the presence of gas in the gallbladder lumen or wall. It is due to a secondary infection of the gallbladder wall with gas-forming organisms such as <strong>Clostridium welchii</strong>. Escherichia coli, staphylococci, streptococci, Pseudomonas, and Klebsiella may also be isolated.</p>\n<p id=\"xhash_H1150491211\" class=\"headingAnchor\">Patients present with right upper quadrant pain, nausea, vomiting, and low-grade fever. <strong>Crepitus</strong> is present on physical examination.&nbsp;Mild to moderate <strong>unconjugated hyperbilirubinemia</strong> may be present. USG reveals <strong>air in the walls of the gall bladder. </strong></p>\n<p>Emphysematous cholecystitis often heralds the development of <strong>gangrene, perforation</strong>, and other complications. Hence <strong>emergency cholecystectomy</strong> is indicated for the management of these patients.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 6-year-old boy had fallen on outstretched hands and presented with pain and swelling over his left elbow. His X-ray image is shown below. Which among the following classification is used in this case?",
    "choices": [
      {
        "id": 1,
        "text": "Garden's classification"
      },
      {
        "id": 2,
        "text": "Stimson classification"
      },
      {
        "id": 3,
        "text": "Gartland classification"
      },
      {
        "id": 4,
        "text": "Neer's classification"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The given clinical features and X-ray image is suggestive of <strong>supracondylar fracture of the humerus</strong> (extension type) and&nbsp;<span class=\"s1\"><strong>Gartland classification </strong>is used in this case.</span></p>\n<p class=\"p1\">Supracondylar fracture of humerus:</p>\n<ul>\n<li class=\"p1\">Most commonly seen in children of 5-8 years.</li>\n<li class=\"p1\">Most common type of supracondylar fracture : <strong>Extension type&gt; Flexion type.</strong></li>\n<li class=\"p1\">Most common mechanism of injury: Fall on an outstretched hand with an elbow in full extension.</li>\n<li class=\"p1\"><strong>Gartland classification</strong> is used for supracondylar fractures.</li>\n</ul>\n<p class=\"p1\"><span class=\"s1\"><strong>Gartland classification</strong> (in children):</span></p>\n<ul class=\"ul1\">\n<li class=\"li2\"><span class=\"s1\">Type I: Undisplaced</span></li>\n<li class=\"li2\"><span class=\"s1\">Type II: Displaced but posterior cortex is intact</span></li>\n<li class=\"li2\"><span class=\"s1\">Type III: Displaced but no intact posterior cortex and distal fragment could be either displaced:</span></li>\n<ul class=\"ul2\">\n<li class=\"li2\"><span class=\"s1\">Posteromedial</span></li>\n<li class=\"li2\"><span class=\"s1\">Posterolateral</span></li>\n</ul>\n<li class=\"li2\"><span class=\"s1\">Type IV: Complete loss of anterior and posterior periosteal hinge making it unstable in both flexion and extension</span></li>\n</ul>\n<p class=\"p1\"><strong>Three-point bony relationship is maintained</strong> in supracondylar fracture.</p>\n<p class=\"p1\">Three-point bony landmarks in elbow are the tips of medial and lateral epicondyles and the olecranon.</p>\n<p class=\"p1\">Characteristic displacements in Supracondylar fracture(Mnemonic: MID)</p>\n<ul>\n<li class=\"p1\"><strong>M</strong>- Medial rotation/medial tilt.</li>\n<li class=\"p1\"><strong>I</strong>- Impaction (proximal shift).</li>\n<li class=\"p1\"><strong>D</strong>- Dorsal displacement/dorsal tilt.</li>\n</ul>\n<p class=\"p1\">Nerve injury</p>\n<ul>\n<li class=\"p1\"><strong>Most common nerve</strong> to be injured in extension type: <strong>Anterior interosseous nerve</strong> &gt; Median nerve &gt; Radial nerve &gt; Ulnar nerve. (AMRU)</li>\n<li class=\"p1\">Most common nerve to be injured in flexion type : Ulnar nerve.</li>\n</ul>\n<p class=\"p1\">Vessel injury</p>\n<ul>\n<li class=\"p1\">Most common vessel to be injured: <strong>Brachial artery.</strong></li>\n</ul>\n<p class=\"p1\">On examination:</p>\n<ul>\n<li class=\"p1\">Unusual posterior prominence of tip of olecranon.</li>\n<li class=\"p1\">Three point bony relationship is maintained with respect to each other but not with respect to the shaft of humerus.</li>\n</ul>\n<p class=\"p1\">Complications:</p>\n<ul>\n<li class=\"p1\"><strong>Malunion (Most common)</strong>: Posteromedially displaced fracture<span class=\"Apple-converted-space\">&nbsp; </span>tend to develop <strong>Cubitus Varus</strong> (<strong>Gun stock deformity</strong>)</li>\n<li class=\"p1\">Nerve injury: usually neuropraxia, hence transient.</li>\n<li class=\"p1\">Volkmann&rsquo;s ischemic contracture and compartment syndrome (Most common fracture to cause this in children)</li>\n<li class=\"p1\"><strong>Non union is unknown.</strong></li>\n</ul>\n<p>Treatment of Supracondylar fracture:</p>\n<ul>\n<li>Closed reduction and K-wire fixation.</li>\n<li>Tractions used: Dunlop and Smith's.</li>\n</ul>\n<p>Treatment of Cubitus Varus deformity</p>\n<ul>\n<li>Lateral closed wedge osteotomy - French</li>\n<li>Medial open wedge osteotomy - King's</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/019760ec9c2943edb05b8c05f50505b0.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Gestational trophoblastic neoplasm does not include",
    "choices": [
      {
        "id": 1,
        "text": "Partial mole"
      },
      {
        "id": 2,
        "text": "Choriocarcinoma"
      },
      {
        "id": 3,
        "text": "Placental site trophoblastic tumor"
      },
      {
        "id": 4,
        "text": "Invasive mole"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"page\" title=\"Page 1\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Partial mole</strong> does not come under gestational trophoblastic neoplasm.</p>\n<p>The malignant forms of gestational trophoblastic disease are termed gestational trophoblastic neoplasia (GTN). These include</p>\n<div class=\"page\" title=\"Page 1\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li>Invasive mole</li>\n<li>Choriocarcinoma</li>\n<li>Placental site trophoblastic tumor</li>\n<li>Epithelioid trophoblastic tumor</li>\n</ul>\n<div class=\"page\" title=\"Page 1\">&nbsp;</div>\n<p>&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = 'Fmge  Mini Test - 15';
        const quizFilename = 'fmge-mini-test-15-0d1fbfb1.html';
        let hierarchy = ["Marrow", "FMGE Mini Test Series", "2021"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>