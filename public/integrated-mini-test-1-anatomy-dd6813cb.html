<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Mini Test 1 - Anatomy - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2024-25
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A 65-year-old female patient presented with sudden painless loss of vision and the following finding on fundoscopy. The artery involved is a direct branch of the vessel that travels through which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Superior Orbital Fissure"
      },
      {
        "id": 2,
        "text": "Inferior Orbital Fissure"
      },
      {
        "id": 3,
        "text": "Cavernous Sinus"
      },
      {
        "id": 4,
        "text": "Optic Canal"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario of sudden painless loss of vision with a cherry red spot noted on fundoscopy is suggestive of <strong>central retinal artery occlusion (CRAO)</strong>. The central retinal artery is a <strong>direct branch </strong>of the<strong> ophthalmic artery</strong> which passes through the <strong>optic canal</strong>.</p>\n<p>The structures passing through the optic canal are the<strong> optic nerve</strong> and the <strong>ophthalmic artery</strong>.</p>\n<p>The major structures passing through the <strong>superior orbital fissure </strong>(Option A) are:</p>\n<ul>\n<li>Oculomotor, Trochlear and Abducens Nerves (CN III, IV, VI)</li>\n<li>Lacrimal, Frontal and Nasociliary branches of the ophthalmic division of the Trigeminal Nerve (CN V<sub>1</sub>)</li>\n<li>Superior and Inferior Ophthalmic Veins</li>\n</ul>\n<p>The structures passing through the <strong>inferior orbital fissure </strong>(Option B) are:</p>\n<ul>\n<li>Infraorbital and Zygomatic branches of the maxillary division of the Trigeminal Nerve (CN V<sub>2</sub>)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/efbf7a816ee041f887ec3d0479302551.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dd5ef4e300cf423aabedf8acbcdde313x1280x2027.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c25595eb48fe41ccae200b63c2aa735ex600x657.JPEG"
    ]
  },
  {
    "text": "A young female patient from a rural area presented with severe pain in the lower abdomen and pelvic regions and vaginal bleeding. Her last menstrual period was 2 months back. Her urine pregnancy test appeared positive. Her physician suspected a ruptured ectopic pregnancy. However, no medical imaging or laboratory procedure was available.  The physician could confirm the diagnosis by obtaining the blood from?",
    "choices": [
      {
        "id": 1,
        "text": "Rectouterine pouch"
      },
      {
        "id": 2,
        "text": "Ovarian fossa"
      },
      {
        "id": 3,
        "text": "Posterior fornix"
      },
      {
        "id": 4,
        "text": "Vesicouterine pouch"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The physician could confirm the diagnosis by obtaining the blood from the <strong>rectouterine pouch,\u00a0</strong>which is also called the <strong>pouch of Douglas.\u00a0</strong>This procedure is called <strong>culdocentesis.</strong></p>\n<p>The classic triad of symptoms in tubal pregnancy are</p>\n<ul>\n<li>Severe lower abdominal pain</li>\n<li>Amenorrhea- usually for 6-8 weeks before the appearance of the symptoms</li>\n<li>Vaginal bleeding</li>\n</ul>\n<p>If a ruptured ectopic pregnancy is suspected, then blood samples should be sent for haemoglobin estimation and blood grouping. Estimation of \u03b2-HCG can be used to confirm pregnancy. Once it is suspected, transvaginal sonography or laparoscopy can be performed to visualise the ruptured ectopic.</p>\n<p>However, if the imaging techniques are not available, then culdocentesis can be performed. An 18 gauge lumbar puncture needle with a syringe is inserted into the <strong>rectouterine pouch</strong> by puncturing the posterior fornix. If non-clotting blood is obtained from the pouch, which has a hematocrit of <strong>more than 15%,</strong> it indicates the presence of ruptured ectopic pregnancy.</p>\n<p><strong>Peritoneum of the female pelvis:</strong></p>\n<p>In females, the peritoneum covers the anterior and anterolateral surface of the rectum, uterus, and urinary bladder. Spaces found in the female pelvis are:</p>\n<ul>\n<li><strong>Pararectal fossae</strong>- Present on either side of the rectum. They are limited laterally by the peritoneum that covers the uterosacral ligaments.\u00a0</li>\n<li><strong>Paravesical fossae</strong>- Present on either side of the bladder. It is limited laterally by the peritoneum, which covers the round ligament of the uterus.</li>\n<li><strong>Rectouterine pouch</strong> (pouch of Douglas)- The peritoneum, which covers the anterior surface of the rectum, is reflected anteriorly to cover the posterior surface of the posterior fornix of the vagina and the uterus, forming a rectouterine pouch.</li>\n<li><strong>Vesicouterine pouch</strong>- The peritoneum covering the fundus and body of the uterus is reflected anteriorly to cover the posterosuperior surface of the bladder, forming a vesicouterine pouch.</li>\n<li><strong>Ovarian fossa</strong>- a shallow depression in the peritoneal lining of the lateral pelvic wall between the peritoneal ridges. It is formed by the obliterated umbilical arteries anteriorly, the ureter posteriorly, and the external iliac vessels above. It lies behind the lateral attachment of the broad ligament and contains the ovary in nulliparous females.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f38dd4dca4a440dc8795b8fa2155d6acx1280x1532.JPEG"
    ]
  },
  {
    "text": "During radical neck dissection in a case of metastatic squamous cell carcinoma of the oropharynx, the oncosurgeon points out the given structure. Which of the following muscles is not supplied by it?",
    "choices": [
      {
        "id": 1,
        "text": "Geniohyoid"
      },
      {
        "id": 2,
        "text": "Sternohyoid"
      },
      {
        "id": 3,
        "text": "Sternothyroid"
      },
      {
        "id": 4,
        "text": "Inferior belly of omohyoid"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The structure marked is the<strong> ansa cervicalis</strong>. The geniohyoid is innervated by the <strong>first cervical spinal\u00a0nerve</strong>\u00a0and not ansa cervicalis.\u00a0</p>\n<p>Ansa cervicalis is a loop of nerves that are a part of the cervical plexus. It is made up of two roots. The upper root has contributions from the <strong>first cervical</strong> spinal nerve, and the lower root has contributions from the <strong>second </strong>and <strong>third cervical spinal nerves</strong>. It innervates the <strong>sternohyoid, sternothyroid, </strong>and<strong> omohyoid muscles</strong>.</p>\n<p><strong>Thyrohyoid</strong> and <strong>geniohyoid</strong> are not supplied by ansa cervicalis. They are supplied by branches of the <strong>first cervical spinal nerve</strong>\u00a0via the hypoglossal nerve.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8f1a0c09137f414d9cc57c507a42beea.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c481946af9e74039b9dd6a9e815049eex1280x1515.JPEG"
    ]
  },
  {
    "text": "A young adolescent male with a recurrent history of suppurative otitis media was brought to the hospital with high fever and chills, altered sensorium, and neck rigidity. Which part of the image given below should have been deficient for the patient to develop the current symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "1"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "3"
      },
      {
        "id": 4,
        "text": "4"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>tegmen tympani\u00a0</strong>(Marked as 2 in the image), which forms the<strong> roof</strong> of the middle ear cavity, should have been deficient for the patient to develop meningitis from suppurative otitis media.</p>\n<p>Tegmen tympani\u00a0separates the tympanic cavity from the\u00a0<strong>middle cranial fossa</strong>. It also extends posteriorly to form the roof of the aditus and antrum as<strong>\u00a0tegmen mastoidea</strong>. Any <strong>deficit</strong> in the tegmen tympani can<strong> facilitate</strong> the <strong>spread</strong> of middle ear infection to the middle cranial fossa.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/da35562823054ded9cf937e7754916d7.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3b7bac049d734538b7f9d58139f29547x1280x1349.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/94240ec6c0c5425190253b82c4954c78x1280x2185.JPEG"
    ]
  },
  {
    "text": "Identify the heart chamber marked in the given image.",
    "choices": [
      {
        "id": 1,
        "text": "Right atrium"
      },
      {
        "id": 2,
        "text": "Right ventricle"
      },
      {
        "id": 3,
        "text": "Left ventricle"
      },
      {
        "id": 4,
        "text": "Left atrium"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The structure marked in the above CT image is the\u00a0<strong>left ventricle.\u00a0</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e07f47e151a444d089ffe8781cba22d8.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ba441b083eeb4cd4a050561e0af5adabx827x595.PNG"
    ]
  },
  {
    "text": "A 55-year-old chronic alcoholic patient is diagnosed with early-stage hepatocellular carcinoma in the right lobe and is scheduled for a right anterior sectionectomy. Which of the following segments have to be removed in the patient?",
    "choices": [
      {
        "id": 1,
        "text": "V, VIII"
      },
      {
        "id": 2,
        "text": "VI, VII"
      },
      {
        "id": 3,
        "text": "V, VI, VII, VIII"
      },
      {
        "id": 4,
        "text": "IV, V, VI, VII, VIII"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the <strong>right anterior</strong> sectionectomy, segments <strong>V and VIII </strong>are removed.\u00a0</p>\n<p><strong>Cantlie\u2019s line </strong>or<strong>\u00a0main portal fissure</strong>\u00a0extends from the <strong>midpoint of the gallbladder fossa </strong>at the inferior margin of the liver to the <strong>midpoint of the inferior vena cava. </strong>It\u00a0divides the liver into the right and left hemiliver. It contains the<strong> middle hepatic vein. </strong>The liver\u00a0has 3 major fissures and 3 minor fissures.</p>\n<p>Couinaud classification is the commonly used classification of the liver. It divides the liver into <strong>eight segments</strong>.\u00a0It is based on the distribution of <strong>portal venous branches</strong> in the liver parenchyma.\u00a0Each segment has its own dual vascular inflow, biliary drainage, and lymphatic drainage. The <strong>left lobe\u00a0</strong>is composed of the left lateral segment (Couinaud\u2019s segments II and III) and the left medial segment (segment IV). The<strong> right lobe</strong>\u00a0is composed of segments V, VI, VII, and VIII, with segments V and VIII making up the right anterior lobe and segments VI and VII making up the right posterior lobe.</p>\n<div class=\"ng-star-inserted\">\n<div class=\"table-responsive font-weight-light answer-scroll ng-star-inserted\">\n<p><strong class=\"ng-binding\">Couinaud's liver segments\u00a0</strong>are as follows:</p>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/de5b2077510a46e3a32adee6a32b5c94.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e533be777c154d0eb3145d5368f31542x1280x1080.JPEG"
    ]
  },
  {
    "text": "A child is brought with complaints of bitemporal hemianopia, severe headaches associated with vomiting, growth failure, and delayed sexual maturation. CT scan showed the presence of a tumor with calcifications. T1 weighed MRI of the brain is done and is shown below. What is the embryonal basis for this tumor?",
    "choices": [
      {
        "id": 1,
        "text": "Rathke pouch"
      },
      {
        "id": 2,
        "text": "Rathke cleft"
      },
      {
        "id": 3,
        "text": "Ectoderm"
      },
      {
        "id": 4,
        "text": "Para-axial mesoderm"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The child has a <strong>craniopharyngioma</strong>\u00a0derived from the <strong>Rathke pouch,</strong> which may persist in the roof of the nasopharynx as a <strong>pharyngeal hypophysis</strong>.</p>\n<p>Rathke\u2019s pouch appears as an <strong>evagination</strong> of the <strong>oral cavity</strong> at about 3 weeks of embryonic life. It grows dorsally towards the infundibulum and eventually loses its connection to the oral cavity by the end of the 8<sup>th</sup> week. The <strong>anterior wall cells</strong> multiply rapidly to form the <strong>anterior pituitary</strong> or adenohypophysis, and the <strong>posterior wall</strong> of the pouch forms <strong>pars intermedia</strong>. The anterior wall cells have a small extension that grows along the stalk of the infundibulum, forming pars tuberalis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7ef2dabaf0f74bbb8b4bf6a52414312f.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 23-year-old woman slipped while skiing and fell on an outstretched hand. She complains of pain in her right wrist joint and deformity. Her wrist X-rays are shown below. Which muscle do you think exerts tension on the broken distal fragment of the affected bone?",
    "choices": [
      {
        "id": 1,
        "text": "Flexor carpi radialis longus"
      },
      {
        "id": 2,
        "text": "Brachioradialis"
      },
      {
        "id": 3,
        "text": "Extensor carpi ulnaris"
      },
      {
        "id": 4,
        "text": "Pronator quadratus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>brachioradialis inserts</strong> into the <strong>lowest part</strong> of the <strong>lateral surface</strong> of the <strong>radius</strong> just <strong>above the styloid</strong> process. The radius gets fractured <strong>2 cm above</strong> its <strong>lower end</strong> in a <strong>Colle\u2019s fracture,</strong> and the insertion of the brachioradialis exerts tension.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e02204942b5a4540a9dfd44adf8cb716.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8307e3866fc749859bca7ef8491acd33x1280x4170.JPEG"
    ]
  },
  {
    "text": "A 29-year-old woman presents with primary infertility. She has no other complaints. On the hysterosalpingogram, the right fallopian tube has a tobacco pouch appearance. Which part of the fallopian tube is most commonly involved in this underlying condition?",
    "choices": [
      {
        "id": 1,
        "text": "Infundibulum"
      },
      {
        "id": 2,
        "text": "Ampulla"
      },
      {
        "id": 3,
        "text": "Isthmus"
      },
      {
        "id": 4,
        "text": "Interstitium"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The scenario of primary infertility and a hysterosalpingogram finding of the \"<strong>tobacco</strong> <strong>pouch</strong>\" appearance of the fallopian tube is suggestive of <strong>tuberculous</strong> <strong>salpingitis</strong> caused by Mycobacterium tuberculosis. The <strong>ampullary part</strong> of the <strong>fallopian tube</strong> is <strong>most commonly involved</strong> in <strong>genital tuberculosis.</strong>\u00a0 \u00a0 \u00a0</p>\n<p>The fallopian tubes are almost always involved in <strong>genital</strong> <strong>tuberculosis</strong>. The lesions are generally <strong>bilateral</strong>. The <strong>mode</strong> of <strong>spread</strong> of the disease is <strong>hematogenous</strong>, arising from a primary infective focus in the lung.\u00a0The <strong>ampulla</strong> is most commonly affected<strong>,</strong> while the fimbriae and interstitium are spared.\u00a0<br /><br />Genital tuberculosis is almost always secondary to a primary focus elsewhere. The most frequent location is the lungs (50%), although it can also come from lymph nodes (40%), kidneys, joints, the gastrointestinal system, or as part of a broad miliary infection. It mostly spreads via the haematogenous route or lymphatics sometimes.\u00a0</p>\n<p>In Genital tuberculosis, the leading presenting complaints include <strong>infertility</strong>, abdominal pain, vaginal discharge, and suspicion of neoplasm. 10-15% of women are found to be asymptomatic as well.\u00a0</p>\n<p><strong>Hysterosalpingogram</strong>\u00a0may reveal the following:\u00a0</p>\n<ul>\n<li><strong>Tobacco pouch appearance</strong> of hydrosalpinx and pyosalpinx</li>\n<li><strong>Lead pipe appearance</strong> (rigid, nonperistaltic pipe)</li>\n<li>Beading and variation due to filling defects</li>\n<li>Calcification of the tube</li>\n<li>Cornual block</li>\n<li>Jagged fluffiness of tubal outline</li>\n</ul>\n<p>Hysteroscopy will reveal the presence of synechiae, partial obliteration of the cavity, the <strong>golf-hole appearance</strong> of the tubal ostia, and the presence of ulcers.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient develops a sore throat after general anaesthesia. He was diagnosed as having a postoperative sore throat (POST). The anaesthetist injects a local anaesthetic in the plane of the marked structure. Which of the following pierces the marked structure?",
    "choices": [
      {
        "id": 1,
        "text": "Internal laryngeal nerve, accompanied by inferior thyroid vessels"
      },
      {
        "id": 2,
        "text": "External laryngeal nerve, accompanied by inferior thyroid vessels"
      },
      {
        "id": 3,
        "text": "Internal laryngeal nerve, accompanied by superior laryngeal vessels"
      },
      {
        "id": 4,
        "text": "External laryngeal nerve, accompanied by superior laryngeal vessels"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The marked structure shows\u00a0the <strong>thyrohyoid membrane.</strong> It is pierced by the <strong>internal laryngeal nerve</strong>, along with <strong>superior laryngeal vessels</strong>.\u00a0USG-guided block of the internal branch of the superior laryngeal nerve is used in the management of POST.\u00a0</p>\n<p>The diagram given below shows the structures piercing the thyrohyoid membrane.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f0108e7a152142e6ab4bf3f25acf9ec7.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ca3c19156e244ac890920d3d6a6e4a48x1280x1056.JPEG"
    ]
  },
  {
    "text": "A patient presents with cystocele and rectocele. Which level of uterine support is likely to be damaged as per the DeLancey classification?",
    "choices": [
      {
        "id": 1,
        "text": "Level IV"
      },
      {
        "id": 2,
        "text": "Level III"
      },
      {
        "id": 3,
        "text": "Level II"
      },
      {
        "id": 4,
        "text": "Level I"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">Damage to<strong> DeLancey level II </strong>structures results in <strong>cystocele </strong>and<strong> rectocele.</strong></p>\n<p class=\"p1\"><strong>Level II </strong>supports mainly consist of <strong>pubocervical fascia</strong> anteriorly,\u00a0<strong>rectovaginal fascia</strong>\u00a0(along with septum) posteriorly, and <strong>paracolpos</strong> (vascular and connective tissue structures present beside the cervix). As the name suggests, pubocervical fascia connects the cervix to the posterior surface of the pubic bone. The rectovaginal septum separates the rectum from the vagina and cervix of the uterus. Together, these structures form a supportive sling that helps maintain the position of the bladder and rectum. Therefore, damage to these structures results in cystocele and rectocele.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While dissecting the inguinal canal, the following structure is noted. Which of the following does not contribute to the coverings of the structure marked as 'A'?",
    "choices": [
      {
        "id": 1,
        "text": "External oblique"
      },
      {
        "id": 2,
        "text": "Transversalis fascia"
      },
      {
        "id": 3,
        "text": "Internal oblique"
      },
      {
        "id": 4,
        "text": "Transversus abdominis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The structure marked as 'A'<span data-preserver-spaces=\"true\">\u00a0is the <strong>spermatic cord.</strong>\u00a0External oblique aponeurosis, internal oblique, and transversalis fascia contribute to the three coverings of the spermatic cord. There is no contribution from the transversus abdominis muscle.\u00a0<br /></span></p>\n<p><span data-preserver-spaces=\"true\">The coverings of the spermatic cord are:</span></p>\n<ol>\n<li><span data-preserver-spaces=\"true\"><strong>External spermatic fascia</strong> is a continuation of the <strong>external</strong> <strong>oblique</strong> aponeurosis and is attached to the superficial inguinal ring.\u00a0</span></li>\n<li><span data-preserver-spaces=\"true\"><strong>Cremasteric fascia</strong> and cremasteric muscle\u00a0are derived from the <strong>internal oblique</strong> muscle and form the middle covering of the spermatic cord. They are involved in the <strong>cremasteric reflex</strong>. Gently touching the skin around the anterior aspect of the thigh stimulates the <strong>ilioinguinal</strong> <strong>nerve</strong> (<strong>afferent</strong>). The sensory fibres enter the spinal cord at the L1 level. The <strong>efferent</strong> nerve is the <strong>genital</strong> branch of the <strong>genitofemoral</strong> <strong>nerve</strong> (L1, L2), which causes contraction of the cremasteric muscle and the elevation of the testis. The cremasteric reflex is more active in children and diminishes with age.\u00a0</span></li>\n<li><span data-preserver-spaces=\"true\"><strong>Internal spermatic fascia</strong> is derived from <strong>transversalis</strong> <strong>fascia\u00a0</strong>and is attached to the deep inguinal ring.\u00a0</span></li>\n</ol>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/30c240853d3d493e9431b82cf28ff4c3.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9c102e017a21498685ccaa80023493b4x1280x1093.JPEG"
    ]
  },
  {
    "text": "Identify the structure based on the histological features of the specimen obtained after radical hysterectomy with bilateral salpingo-oophorectomy.",
    "choices": [
      {
        "id": 1,
        "text": "Ovary"
      },
      {
        "id": 2,
        "text": "Cervix"
      },
      {
        "id": 3,
        "text": "Fallopian tube"
      },
      {
        "id": 4,
        "text": "Vagina"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given structure can be identified as a <strong>fallopian tube</strong> based on the histological features.\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/09539b123e864a7e90065f9bb75bf47e.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e9e1012ce05342c7987bf1ae50bc45dcx510x533.GIF"
    ]
  },
  {
    "text": "A 57-year-old male patient who has been diagnosed with aggressive pancreatic cancer presents with deep abdominal pain in the epigastric region. Intraoperatively, there was retroperitoneal haemorrhage due to erosion of the artery running along the superior border of the pancreas. Which of the following arteries is injured?",
    "choices": [
      {
        "id": 1,
        "text": "1"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "3"
      },
      {
        "id": 4,
        "text": "4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>superior border of the pancreas</strong> is formed by the <strong>splenic artery</strong> which is marked as '<strong>4'</strong>.</p>\n<p>Borders of the pancreas:\u00a0\u00a0</p>\n<p><strong>Superior border:\u00a0</strong>Related to the celiac artery and its branches, the common hepatic artery, and the <strong>splenic artery.</strong></p>\n<p><strong>Inferior border:</strong></p>\n<ul>\n<li>Behind the gland, the superior mesenteric vessels emerge.</li>\n<li>The inferior mesenteric vein runs\u00a0behind the inferior border to join the splenic vein or where the confluence of splenic and superior mesenteric veins meet.</li>\n</ul>\n<p><strong>Posterior surface:</strong></p>\n<ul>\n<li>Devoid of the peritoneum.</li>\n<li>Anterior to the aorta and the origin of the superior mesenteric artery, left suprarenal gland, the left crus of the diaphragm, left renal vein, and\u00a0the upper pole of the left kidney surrounded by perirenal fascia\u00a0</li>\n<li>The splenic vein runs on the surface from left to right</li>\n</ul>\n<p><strong>Relations of the pancreas\u00a0</strong></p>\n<p>1)<strong> Uncinate process:\u00a0</strong>Anterior - superior mesenteric artery and superior mesenteric vein</p>\n<p>2)<strong> Neck of the pancreas:\u00a0</strong>Posterior - superior mesenteric vein and portal vein</p>\n<p>3)<strong> Body of pancreas:\u00a0</strong>Posterior - Splenic vein</p>\n<p>4)<strong> Tail of pancreas: </strong>Present in lienorenal ligament</p>\n<p>5)<strong> Head of the pancreas: </strong>Posterior - inferior vena cava, right and left renal vein</p>\n<p><strong>Blood supply of the stomach</strong></p>\n<p>The arterial supply of the stomach is contributed exclusively by the <strong>celiac trunk</strong> through its branches:</p>\n<ul>\n<li><strong>Left gastric artery\u00a0</strong>- Supplies the lesser curvature of the stomach</li>\n<li><strong>Splenic artery</strong>\n<ul>\n<li><strong>Short gastric arteries:</strong> Supplies the fundus of the stomach</li>\n<li><strong>Left gastroepiploic artery:</strong> Supplies the greater curvature of the stomach</li>\n</ul>\n</li>\n<li><strong>Common hepatic artery</strong>\n<ul>\n<li><strong>Right gastric artery:</strong>\u00a0Supplies the lesser curvature of the stomach</li>\n<li><strong>Gastroduodenal artery:</strong> The right gastroepiploic artery arises from this and supplies the greater curvature of the stomach.\u00a0</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ae70a120d914465e912dd817b947a8ac.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1a1bafeb2dd741d89864a110de70892ex1280x1342.JPEG"
    ]
  },
  {
    "text": "A 45-year-old man with a tumor of the mandible is set to undergo mandibular reconstruction. Which of the following is the bone likely to be used for grafting in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Ulna"
      },
      {
        "id": 2,
        "text": "Iliac crest"
      },
      {
        "id": 3,
        "text": "Fibula"
      },
      {
        "id": 4,
        "text": "Sternum"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Vascularised</strong> <strong>fibular grafts,</strong> based on the fibular artery, are the <strong>gold standard</strong> bone grafts preferred in <strong>mandibular reconstruction</strong> procedures.</p>\n<p>Since fibula does not take part in the transmission of body weight, it is a common <strong>source of bone for grafting.</strong></p>\n<p>The fibular artery has five perforators. While the<strong> fibular graft</strong> based on the <strong>fibular artery</strong> is used for <strong>mandibular reconstruction</strong>, small fasciocutaneous and adipofascial flaps based on the<strong> perforators</strong> can be used for covering <strong>soft tissue defects.\u00a0</strong>Therefore, this graft provides convenient tissue for the simultaneous reconstruction of bony and soft tissue defects inside as well as outside the oral cavity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/61873fe51384485f884bf09e066e629ax1280x1827.JPEG"
    ]
  },
  {
    "text": "A patient who underwent parotidectomy developed sweating that occurs when he smells or tastes food. It was suspected to be due to aberrant regeneration of parasympathetic fibres to the parotid gland. Which of the following foramina do these fibres pass through?",
    "choices": [
      {
        "id": 1,
        "text": "3 and 4"
      },
      {
        "id": 2,
        "text": "2 and 4"
      },
      {
        "id": 3,
        "text": "1 and 4"
      },
      {
        "id": 4,
        "text": "1 and 2"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario of <strong>sweating</strong> occurring while <strong>smelling</strong> or <strong>tasting food</strong>, secondary to <strong>aberrant regeneration</strong> of <strong>parasympathetic fibres</strong>, suggests <strong>Frey's syndrome</strong>. These fibres to the parotid gland pass through the <strong>foramen ovale\u00a0</strong>and\u00a0<strong>jugular foramen</strong>, marked as <strong>2</strong> and<strong> 4</strong> in the image, respectively.</p>\n<p>Parasympathetic nerves are secretomotor to the parotid gland. The preganglionic parasympathetic fibres begin in the <strong>inferior salivatory nucleus.\u00a0</strong>These fibres travel via the glossopharyngeal nerve and reach the tympanic plexus via the tympanic branch of the glossopharyngeal nerve through the <strong>jugular foramen.</strong> Then, these fibres travel via the lesser petrosal nerve and come out of the <strong>foramen ovale</strong> to relay in the <strong>otic ganglion.</strong> The postganglionic parasympathetic fibres emerging from the otic ganglion pass via the <strong>auriculotemporal</strong> nerve to reach the parotid gland.</p>\n<p>The image given below shows the parasympathetic pathway of the parotid gland.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/34ac77a7c5674fdebd093d877131e7a9.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/44b01c5cda094f79a1a009cf57f3ca17x1280x1693.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/38db9393d25241fea9d0c86e8a2c78ebx1279x1050.JPEG"
    ]
  },
  {
    "text": "A male patient was diagnosed with an aneurysm of the posterior communicating artery. He has ocular symptoms suggestive of third cranial nerve palsy. Which of the muscles marked in the given image is not supplied by this nerve?",
    "choices": [
      {
        "id": 1,
        "text": "1"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "3"
      },
      {
        "id": 4,
        "text": "4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The muscle marked as '3' in the image is<strong>\u00a0superior oblique,</strong> which is innervated by the <strong>trochlear nerve </strong>(4<sup>th</sup> cranial nerve). The other muscles marked in the image, i.e., 1-\u00a0<strong>superior rectus</strong>, 2- <strong>levator palpebrae superioris</strong>, and 4- <strong>inferior oblique,</strong>\u00a0are supplied by the <strong>oculomotor nerve</strong> (3rd cranial nerve).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3086a105ed6c45a4a7f3530d82f18c8f.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e483debcee9d444b86d53bb9c3206fabx640x480.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f5759aa1ef1c4d3882c6f7d5f95bde1cx288x342.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/98a65ec5d45c49f4adc2a781b1226afbx766x605.JPEG"
    ]
  },
  {
    "text": "A boy came to the hospital with complaints of diplopia and progressive headache. Examination of extraocular movements revealed the findings as shown in the image when the patient attempted to look right. At what level of the brainstem does the affected cranial nerve nucleus arise?",
    "choices": [
      {
        "id": 1,
        "text": "Superior colliculus"
      },
      {
        "id": 2,
        "text": "Inferior colliculus"
      },
      {
        "id": 3,
        "text": "Facial colliculus"
      },
      {
        "id": 4,
        "text": "Inferior olivary nucleus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The clinical finding shown in the image is suggestive of <strong>lateral rectus palsy </strong>of the<strong> right eye. </strong>This\u00a0occurs due to the lesion involving<strong>\u00a0</strong>the<strong>\u00a0abducens nerve</strong>. The abducens nerve nucleus arises at the level of <strong>facial colliculus</strong> in the pons.\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d54f040dfba84dd7b20069bb3f0a2f66.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cee6aaeef64b465ab4f9d891e84d34eex1280x1427.JPEG"
    ]
  },
  {
    "text": "A 20-year-old male patient has been brought to the hospital following blunt trauma to the chest and abdomen. On examination, it was found that the structures passing through the most posteroinferior large diaphragmatic opening situated at the level of the T12 vertebra have been injured. All of the following structures are injured in this case except?",
    "choices": [
      {
        "id": 1,
        "text": "Thoracic duct"
      },
      {
        "id": 2,
        "text": "Right vagus nerve"
      },
      {
        "id": 3,
        "text": "Azygous vein"
      },
      {
        "id": 4,
        "text": "Hemiazygous vein"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most <strong>posteroinferior</strong> <strong>large</strong> <strong>diaphragmatic</strong> <strong>opening</strong> situated at the <strong>level</strong> of the <strong>T12</strong> <strong>vertebra</strong> is the aortic opening. The<strong> right vagus nerve</strong> is not injured in the given case as it <strong>passes</strong> <strong>through</strong> the <strong>oesophageal</strong> <strong>opening</strong> while all these other structures are injured. <br /><br />The diaphragm has several openings through which structures can pass between the thorax and abdomen. There are <strong>three large openings</strong> and <strong>several smaller openings</strong>. The large openings are the <strong>aortic</strong> hiatus, the <strong>oesophagal</strong> hiatus, and the <strong>caval</strong> hiatus.</p>\n<p>The<strong> aortic opening</strong> is the most<strong> </strong>posteroinferior large diaphragmatic opening. It is found at the level of the lower border of the twelfth thoracic\u00a0vertebra and the corresponding intervertebral disc. It is bounded by the <strong>diaphragmatic crura</strong> laterally, the <strong>vertebral column</strong> posteriorly, and the <strong>median arcuate ligament</strong> anteriorly.\u00a0</p>\n<p>Structures passing through the aortic opening are,</p>\n<ul>\n<li>Aorta</li>\n<li><strong>Thoracic duct</strong></li>\n<li><strong>Azygous vein</strong></li>\n<li><strong>Hemiazygous vein</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old man presented with a mass at the anus associated with painless bleeding. Examination revealed the following findings. Identify the correct pair of involved veins and their tributaries in this condition.",
    "choices": [
      {
        "id": 1,
        "text": "Inferior rectal vein\u2192 Inferior mesenteric vein"
      },
      {
        "id": 2,
        "text": "Superior rectal vein\u2192 Inferior mesenteric vein"
      },
      {
        "id": 3,
        "text": "Superior rectal vein\u2192Internal iliac vein"
      },
      {
        "id": 4,
        "text": "Middle rectal vein\u2192 Inferior mesenteric vein"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given scenario and image are suggestive of <strong>internal haemorrhoids.</strong>\u00a0The correctly involved veins and tributaries are <strong>superior rectal veins </strong>draining into<strong>\u00a0</strong>the<strong> inferior mesenteric vein.\u00a0</strong>In the image, the mass is appearing to arise above the level of the dentate line, and prominent enlargement can be found at the <strong>3 o\u2019clock</strong>, <strong>11 o\u2019clock,\u00a0</strong>and <strong>7 o\u2019clock</strong>\u00a0positions.</p>\n<p>Internal haemorrhoids arise from the hemorrhoidal plexus consisting of 3 soft engorgements, referred to as anal cushions or haemorrhoids. Upright posture, the absence of valves in the portal venous system, and raised abdominal pressure contribute to venous plexus engorgement and the development of varicosities.<span class=\"Apple-converted-space\">\u00a0</span></p>\n<p><span class=\"Apple-converted-space\">Patients will present with <strong>painless bleeding</strong> per rectum and <strong>mass</strong> near the anal orifice.</span></p>\n<p>The venous plexus and its drainage are as follows:</p>\n<div class=\"page\" title=\"Page 1595\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The\u00a0upper part of the anal canal, including the internal hemorrhoidal plexus:</p>\n<ul>\n<li>The <strong>superior rectal vein</strong> draining into<strong><strong>\u00a0</strong></strong>the<strong><strong> inferior mesenteric vein</strong>-\u00a0</strong>Portal vein tributaries</li>\n<li>The\u00a0<strong>middle rectal vein</strong>\u00a0draining into the\u00a0<strong><strong>internal iliac vein-\u00a0</strong></strong>Systemic veins</li>\n</ul>\n<div class=\"page\" title=\"Page 1600\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The lower part of the anal canal, including the external haemorrhoidal venous plexus:</p>\n</div>\n</div>\n</div>\n</div>\n<ul>\n<li>The <strong>inferior rectal veins</strong> into the<strong> internal pudendal veins\u00a0</strong>(later into the internal iliac vein)-\u00a0Systemic veins</li>\n</ul>\n<p>The rectal venous plexus is, therefore, a site of communication between the portal and systemic venous systems. Hence, patients with portal hypertension develop rectal varices that should not be confused with haemorrhoids.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/db4d289cadd84168991406b8debf9d6e.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7a197dfefac7447da07c699ed24d6748x600x425.JPEG"
    ]
  }
];
        let quizName = 'Integrated Mini Test 1 - Anatomy';
        const quizFilename = 'integrated-mini-test-1-anatomy-dd6813cb.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2024-25"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>