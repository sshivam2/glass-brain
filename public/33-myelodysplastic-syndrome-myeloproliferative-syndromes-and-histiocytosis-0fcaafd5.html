<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33 Myelodysplastic Syndrome, Myeloproliferative Syndromes And Histiocytosis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pathology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">29</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A 73-year-old woman presents with chronic fatigue and easy bruising. She has had surgery for ovarian cancer 7 years ago along with chemoradiation. Her lab reports reveal pancytopenia and bone marrow biopsy shows the following finding. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Aplastic anemia"
      },
      {
        "id": 2,
        "text": "Myelodysplastic syndrome"
      },
      {
        "id": 3,
        "text": "Acute lymphoblastic leukemia"
      },
      {
        "id": 4,
        "text": "Myelophthisic anemia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Myelodysplastic syndrome is&nbsp;a group of&nbsp;<strong>clonal stem cell disorders</strong>&nbsp;characterized by&nbsp;<strong>maturation defects,&nbsp;</strong>associated with ineffective hematopoiesis.</p>\n<p>It is of two&nbsp;<strong>types</strong>:</p>\n<ul>\n<li>Primary MDS - develops slowly, usually after 50 years of age.</li>\n<li>Secondary or therapy-related MDS (t-MDS) -<strong>&nbsp;</strong>develops 2 to 8 years after toxic drug or radiation exposure with poor prognosis</li>\n</ul>\n<p>Patients usually present with weakness, infections and hemorrhages due to pancytopenia. Both types of MDS have a high risk of&nbsp;<strong>transformation</strong>&nbsp;to acute myeloid leukemia&nbsp;(<strong>AML</strong>). However, most frequent and rapid transformation occurs in&nbsp;<strong>therapy-related MDS</strong>&nbsp;(t-MDS).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a25775b4073c4f32abbddcd1957a1ad2.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/346ee94f46484e2283e80f30c925710fx798x599.JPEG"
    ]
  },
  {
    "text": "What is the most common cytogenetic change in children with myelodysplastic syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "5q deletion"
      },
      {
        "id": 2,
        "text": "Monosomy 5"
      },
      {
        "id": 3,
        "text": "7q deletion"
      },
      {
        "id": 4,
        "text": "Monosomy 7"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Monosomy 7 </strong>is the most common cytogenetic change&nbsp;seen in myelodysplastic syndrome (MDS) in<strong> children.</strong></p>\n<p><strong>5q deletion </strong>is the most common cytogenetic change seen in MDS in <strong>adults</strong>.</p>\n<p>The del(5q) abnormality is the dominant clone in most cases of MDS. This involves the stem-cell compartment and hence occurs as an early or initiating event in disease pathogenesis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of these histopathological findings would you not expect to see in patients with myelodysplastic syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Ringed sideroblast"
      },
      {
        "id": 2,
        "text": "Pawn-ball megakaryocyte"
      },
      {
        "id": 3,
        "text": "Dohle bodies"
      },
      {
        "id": 4,
        "text": "Pelger-Huet cells"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Pseudo&ndash;Pelger&ndash;Huet cells</strong> are seen in <strong>myelodysplastic syndrome</strong> (MDS)<strong>&nbsp;</strong>and not Pelger<strong>&ndash;</strong>Huet cells.</p>\n<p>Pelger&ndash;Huet cells are seen in<strong> Pelger&ndash;Huet syndrome</strong>, which is due to mutations in the <strong>lamin B-receptor</strong><strong> gene.</strong> It is a&nbsp;neutrophil differentiation disorder with leukocyte appearance as:</p>\n<ul>\n<li><strong>Dumbbell-shaped bilobed</strong> nuclei</li>\n<li>Reduced number of nuclear segments</li>\n<li>Coarse clumping of the nuclear chromatin</li>\n</ul>\n<p>In <strong>MDS</strong>, pseudo-Pelger Huet cells are seen due to <strong>abnormal nuclear budding</strong> i.e. neutrophils with only 2 nuclear lobes.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following bone marrow and peripheral blood findings is not seen in patients with myelodysplastic syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Image 1"
      },
      {
        "id": 2,
        "text": "Image 2"
      },
      {
        "id": 3,
        "text": "Image 3"
      },
      {
        "id": 4,
        "text": "Image 4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Image 3 showing hypocellular bone marrow is not seen in <strong>myelodysplastic syndrome</strong> (MDS.) In this condition, bone marrow is<strong>&nbsp;hypercellular.</strong>&nbsp;However, <strong>pancytopenia</strong> results from ineffective hematopoiesis.</p>\n<p>The image given below shows the histopathological findings seen in MDS.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4b596660e31f4986aca23ef3a02ba206.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6d9304056c604d0da59e14bf27ad3dd1x1280x1545.JPEG"
    ]
  },
  {
    "text": "A 60-year-old man presents with complaints of fatigue, weight loss, and heaviness in the left hypochondrium for 6 months. His hemogram and peripheral smear are given below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic lymphocytic leukemia"
      },
      {
        "id": 2,
        "text": "Chronic myeloid leukemia"
      },
      {
        "id": 3,
        "text": "Acute lymphoblastic leukemia"
      },
      {
        "id": 4,
        "text": "Acute myeloid leukemia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>CML is a myeloproliferative disorder with peak incidence in the 5th to 6th decades of life. It occurs due to the&nbsp;chimeric BCR-ABL&nbsp;gene.</p>\n<p><strong>Clinical features</strong> of CML:</p>\n<ul>\n<li>Hypermetabolism</li>\n<li>Fatigability</li>\n<li>Weakness</li>\n<li>Weight loss and anorexia</li>\n<li>Extensive extramedullary hematopoiesis causing -\n<ul>\n<li>Splenomegaly</li>\n<li>Mild hepatomegaly</li>\n<li>Lymphadenopathy</li>\n</ul>\n</li>\n</ul>\n<p><strong>Hematological findings</strong> include:</p>\n<ul>\n<li>Mild-to-moderate anemia&nbsp;</li>\n<li>Leukocytosis</li>\n<li>Platelets - usually increased</li>\n<li>DLC shows&nbsp;predominantly neutrophils, band forms, metamyelocytes, myelocytes, eosinophils, and basophils and blasts (&gt;10%)&nbsp;</li>\n</ul>\n<p>Note:&nbsp;Convent girl appearance is seen in CLL.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8d5eaf70693448a29859e5222aafaa7a.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a1e04758334842edbcaa3e45942ffc6dx1280x1117.JPEG"
    ]
  },
  {
    "text": "What mutation results in Philadelphia chromosome?",
    "choices": [
      {
        "id": 1,
        "text": "t(9;22)(q11;q34)"
      },
      {
        "id": 2,
        "text": "t(22;9)(q11;q34)"
      },
      {
        "id": 3,
        "text": "t(22;9)(q34;q11)"
      },
      {
        "id": 4,
        "text": "t(9;22)(q34;q11)"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>This translocation can be identified on fluorescence in situ hybridisation (FISH).</p>\n<p>The image given below shows<strong>&nbsp;</strong>(9;22) translocation as seen on FISH.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/59e76b8423e64e0d9c3ded3140dd6b99x1280x2541.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/75b99376f9834259a64754975241eae7x604x598.PNG"
    ]
  },
  {
    "text": "Bone marrow biopsy in a patient shows pseudo-Gaucher cells. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Primary myelofibrosis"
      },
      {
        "id": 2,
        "text": "Chronic myeloid leukemia"
      },
      {
        "id": 3,
        "text": "Essential thrombocythemia"
      },
      {
        "id": 4,
        "text": "Chronic Lymphocytic leukemia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Psuedo-Gaucher</strong> cells are characteristic of chronic myeloid leukemia (<strong>CML</strong>).&nbsp; These cells&nbsp;are scattered macrophages with abundant wrinkled, green-blue cytoplasm. Their presence indicates a good prognosis.</p>\n<p><strong>Bone marrow </strong>findings in <strong>CML: </strong></p>\n<ul>\n<li>Markedly hypercellular marrow - increased&nbsp;maturing granulocytic precursors</li>\n<li>Elevated eosinophils and basophils</li>\n<li>Increased megakaryocytes - include small, dysplastic forms</li>\n<li>Erythroid progenitors - normal or mildly decreased</li>\n<li>Increased reticulin deposition</li>\n<li>Overt marrow fibrosis - rare early in the course</li>\n<li>Pseudo-Gaucher cells&nbsp;</li>\n<li>Sea blue histiocytes</li>\n</ul>\n<p>The image given below shows pseudo-Gaucher cells in chronic myeloid leukemia (CML).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0d2d7dd368714ca6b08e3fd2fdf81551x436x356.PNG"
    ]
  },
  {
    "text": "A 60-year-old woman with fever and splenomegaly was diagnosed to have chronic myeloid leukemia. She was started on imatinib therapy. After a few months of therapy, she had persistent progressive splenomegaly and fatigue. Which of the following will not be seen in this phase?",
    "choices": [
      {
        "id": 1,
        "text": ">20% blasts in blood or marrow"
      },
      {
        "id": 2,
        "text": "> 20% basophils in blood"
      },
      {
        "id": 3,
        "text": "Platelet count  of <100 \u00d7 10^9/L"
      },
      {
        "id": 4,
        "text": "WBC count >10 \u00d7 10^9/L"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In a patient with chronic myeloid leukemia (<strong>CML</strong>), progressive splenomegaly, not responsive to therapy is suggestive of an&nbsp;<strong>accelerated phase</strong>. In this phase, <strong>blasts</strong> are <strong>&lt;20%</strong> in blood or marrow.&nbsp;</p>\n<p><strong>Diagnosis</strong> of an accelerated phase of CML requires one of the following <strong>criteria:</strong></p>\n<ul>\n<li>Persistent or increasing WBC (&gt;10 &times; 10<sup>9</sup>/L), unresponsive to therapy</li>\n<li>Persistent or increasing splenomegaly, unresponsive to therapy</li>\n<li>Persistent thrombocytosis (&gt;1000 &times; 10<sup>9</sup>/L), unresponsive to therapy</li>\n<li>Persistent thrombocytopenia (&lt;100 &times; 10<sup>9</sup>/L) unrelated to therapy</li>\n<li>20% or more basophils in the peripheral blood</li>\n<li>10%-19% blasts&nbsp;in the peripheral blood or bone marrow</li>\n<li>Additional clonal chromosomal abnormalities in Ph<sup>+</sup> cells at diagnosis that include &ldquo;major route&rdquo; abnormalities (second Ph, trisomy 8, isochromosome 17q, trisomy 19), complex karyotype, or abnormalities of 3q26.2</li>\n<li>Any new clonal chromosomal abnormality in Ph<sup>+</sup> cells that occurs during therapy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the percentage of blast cells in the blast phase of CML?",
    "choices": [
      {
        "id": 1,
        "text": "<10%"
      },
      {
        "id": 2,
        "text": "10-15%"
      },
      {
        "id": 3,
        "text": ">20%"
      },
      {
        "id": 4,
        "text": "15-20%"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the <strong>blast phase</strong> of chronic myeloid leukemia, there are <strong>&gt;20% </strong>blasts in the bone marrow.</p>\n<p>The 3 <strong>phases</strong> of <strong>CML</strong> are:</p>\n<ol>\n<li><strong>Chronic</strong> phase is the most common presentation. It is characterized by:\n<ul>\n<li>Leukocytosis - bimodal distribution with higher proportions of mature segmented neutrophils and myelocytes</li>\n<li>Blast cells &lt;10%</li>\n<li>Increased basophils and eosinophils</li>\n<li>Monocytosis &lt;3%</li>\n</ul>\n</li>\n<li><strong>Accelerated</strong> phase occurs in 50% of the patients who present with increasing anemia, thrombocytopenia and splenomegaly. It is characterized by:\n<ul>\n<li>Blast count 10-19%</li>\n<li>Basophilia &gt;20%</li>\n</ul>\n</li>\n<li><strong>Blast</strong> phase in CML occurs in an average of 3 years after the diagnosis. It is characterized by:\n<ul>\n<li>Large foci or clusters of blasts on the bone marrow biopsy &gt;20%.</li>\n<li>Presence of extramedullary blastic infiltrates (e.g., myeloid sarcoma or chloroma)</li>\n</ul>\n</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not seen in a patient with Myelodysplastic/Myeloproliferative syndrome (MDS/MPN) with neutrophilia?",
    "choices": [
      {
        "id": 1,
        "text": "Philadelphia chromosome negative"
      },
      {
        "id": 2,
        "text": "Basophilia >10%"
      },
      {
        "id": 3,
        "text": "Blasts <20%"
      },
      {
        "id": 4,
        "text": "Neutrophil precursors >10%"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Myelodysplastic/Myeloproliferative syndrome (MDS/MPN) with neutrophilia (previously named as atypical chronic myeloid leukemia) shows minimal absolute <strong>basophilia</strong>, i.e., <strong>&lt;2%</strong> of total WBCs.</p>\n<p>Myelodysplastic/Myeloproliferative syndrome (MDS/MPN) with neutrophilia is a leukemic disorder having features of both myelodysplastic and myeloproliferative features at the time of diagnosis. It is classified under the <strong>WHO 5th edition (2022) MDS/MPN</strong> category.</p>\n<p><strong>Characteristics </strong>of myelodysplastic/myeloproliferative syndrome (MDS/MPN) with neutrophilia:</p>\n<ul>\n<li>Peripheral blood leukocytosis with an&nbsp;increased number of mature and immature neutrophils</li>\n<li>Prominent dysgranulopoiesis</li>\n<li><strong>Philadelphia chromosome-negative</strong></li>\n<li><strong>Neutrophil</strong> <strong>precursors</strong>&nbsp;(promyelocytes, myelocytes, metamyelocytes)<strong> &gt;10%</strong> of WBCs</li>\n<li>Minimal absolute <strong>basophilia &lt;2%</strong> of WBCs</li>\n<li>Absolute monocytosis &lt;10% of WBCs</li>\n<li>Hypercellular bone marrow</li>\n<li><strong>&lt;20% blasts</strong> in blood and bone marrow</li>\n<li>Thrombocytopenia</li>\n</ul>\n<p><strong>Differences</strong> between CML and myelodysplastic/myeloproliferative syndrome (MDS/MPN) with neutrophilia:</p>\n<table style=\"height: 265px;\" width=\"517\">\n<tbody>\n<tr>\n<td style=\"width: 165px;\"><strong>Feature</strong></td>\n<td style=\"width: 165px;\"><strong>CML</strong></td>\n<td style=\"width: 165px;\">Myelodysplastic/Myeloproliferative syndrome (MDS/MPN) with neutrophilia</td>\n</tr>\n<tr>\n<td style=\"width: 165px;\">BCR-ABL gene&nbsp;</td>\n<td style=\"width: 165px;\">Present</td>\n<td style=\"width: 165px;\">Absent</td>\n</tr>\n<tr>\n<td style=\"width: 165px;\">Basophilia</td>\n<td style=\"width: 165px;\">Present</td>\n<td style=\"width: 165px;\">&lt;2%</td>\n</tr>\n<tr>\n<td style=\"width: 165px;\">\n<p>Myeloblasts in peripheral blood</p>\n<p>Myeloblasts in bone marrow</p>\n</td>\n<td style=\"width: 165px;\">\n<p>&lt;2%</p>\n<p>&lt;5%</p>\n</td>\n<td style=\"width: 165px;\">\n<p>&lt;20%</p>\n<p>&lt;20%</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 165px;\">Granulocytic dysplasia</td>\n<td style=\"width: 165px;\">Minimal/ absent</td>\n<td style=\"width: 165px;\">Prominent</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following patients will have a decreased leukocyte alkaline phosphatase score?",
    "choices": [
      {
        "id": 1,
        "text": "A 65-year-old-man with garden party appearance on peripheral smear"
      },
      {
        "id": 2,
        "text": "A 50-year-old man with Reed Sternberg cells on LN biopsy"
      },
      {
        "id": 3,
        "text": "A 35-year-old woman with Hb level of 23 g/dL"
      },
      {
        "id": 4,
        "text": "A 43-year-old woman with smudge cells on peripheral smear"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Leukocyte alkaline phosphatase (<strong>LAP</strong>) score is <strong>decreased</strong> in chronic myeloid leukemia (<strong>CML</strong>) i.e. garden party appearance on peripheral smear.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following does not cause relative polycythemia?",
    "choices": [
      {
        "id": 1,
        "text": "Dehydration"
      },
      {
        "id": 2,
        "text": "Dengue hemorrhagic fever"
      },
      {
        "id": 3,
        "text": "Gaisbock syndrome"
      },
      {
        "id": 4,
        "text": "High altitude"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>High altitude produces absolute polycythemia and not relative polycythemia.</p>\n<p><strong>Polycythemia</strong> denotes an abnormally high red cell count, usually with a corresponding increase in the hemoglobin level (&gt; 16 &plusmn;2 g/dL). It is <strong>2 types</strong>:</p>\n<ul>\n<li>Relative - hemoconcentration due to decreased plasma volume</li>\n<li>Absolute - increase in the total red cell mass</li>\n</ul>\n<p><strong>Causes</strong> of <strong>relative</strong> polycythemia include:</p>\n<ul>\n<li>Dehydration - deprivation of water, prolonged vomiting or diarrhea, excessive use of diuretics</li>\n<li>Gaisb&ouml;ck syndrome -&nbsp;stress polycythemia where affected individuals are usually hypertensive, obese, and anxious</li>\n</ul>\n<p><strong>Causes</strong> of <strong>absolute</strong> polycythemia include:</p>\n<ul>\n<li>Primary -&nbsp;intrinsic abnormality of hematopoietic precursors&nbsp;\n<ul>\n<li>Polycythemia vera</li>\n<li>Inherited erythropoietin receptor mutations</li>\n</ul>\n</li>\n<li>Secondary -&nbsp;red cell progenitors responding to increased levels of erythropoietin\n<ul>\n<li>Compensatory due to cyanotic heart and lung disease, high altitude</li>\n<li>Paraneoplastic erythropoietin secreting tumours</li>\n</ul>\n</li>\n</ul>\n<p>Note: In dengue hemorrhagic fever, increased vascular permeability causes plasma leakage and volume loss. Hence, relative polycythemia is seen.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young boy from high altitude came with fever and weakness and had the following reports - Hemoglobin 17 g%, TLC is 21,000 with neutrophils 25, lymphocytes 30, eosinophils 5, myelocytes and metamyelocytes 40 in peripheral smear. Next step in the investigation should be:",
    "choices": [
      {
        "id": 1,
        "text": "Philadelphia chromosome"
      },
      {
        "id": 2,
        "text": "JAK mutation"
      },
      {
        "id": 3,
        "text": "Erythropoietin levels"
      },
      {
        "id": 4,
        "text": "Bone Marrow biopsy with reticulin stain"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of <strong>polycythemia</strong> (Hb&gt;16 g/dL). Hence, <strong>erythropoietin levels</strong> (EPO)&nbsp;are estimated next, to differentiate between <strong>primary</strong> or <strong>secondary</strong> polycythemia. Based on EPO levels:</p>\n<ul>\n<li>Primary polycythemia -&nbsp;normal/ decreased</li>\n<li>Secondary polycythemia&nbsp;- increased</li>\n</ul>\n<p>Options A and B: JAK 2 mutation and Philadelphia chromosome analysis is only done as a last resort.</p>\n<p>Option D: Bone marrow estimation with reticulin is done for myelofibrosis&nbsp;which can be seen in the spent/ late stage of the disease. However, peripheral smear findings are not suggestive of primary myelofibrosis. Leukoerythroblastic reaction with dacrocytes is seen in myelofibrosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 24-year-old woman who presented with aquagenic pruritis had a Hb level of 20 g/dL. Her lab investigations are given below. Which of the following is not seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Acute meyloid leukemia"
      },
      {
        "id": 2,
        "text": "Budd-Chiari syndrome"
      },
      {
        "id": 3,
        "text": "Myelofibrosis"
      },
      {
        "id": 4,
        "text": "Hepatic failure"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario is suggestive&nbsp;of <strong>polycythemia vera</strong>. Hepatic failure is not seen in this condition.</p>\n<p>Polycythemia vera is strongly associated with activating point <strong>mutations</strong> in the tyrosine kinase <strong>JAK2.</strong>&nbsp;In this condition, clonal erythrocytosis occurs autonomously i.e. independent of erythropoietin.</p>\n<p><strong>Clinical features</strong> of polycythemia vera:</p>\n<ul>\n<li>Headache</li>\n<li>Hypertension</li>\n<li>Dizziness</li>\n<li>Intense pruritis, <strong>aquagenic pruritis</strong></li>\n<li>Peptic ulcer</li>\n<li>Venous thrombosis - <strong>Budd-Chiari syndrome</strong> (hepatic vein thrombosis), bowel infarction, stroke, myocardial infarction</li>\n<li>Minor hemorrhages - epistaxis, gum bleeding</li>\n</ul>\n<p><strong>Laboratory findings</strong> in polycythemia vera:</p>\n<ul>\n<li>Panmyelosis - increased marrow production of red cells, granulocytes, and platelets</li>\n<li><strong>Low erythropoietin </strong></li>\n<li>Elevated hematocrit</li>\n<li>Hyperuricemia</li>\n</ul>\n<p><strong>Complications</strong> of polycythemia vera:</p>\n<ul>\n<li><strong>Myelofibrosis</strong> and extensive extramedullary hematopoiesis - spent /late phase</li>\n<li><strong>Acute myeloid leukemia</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 63-year-old woman complains about throbbing pain over both palms. Her examination findings and lab reports are given below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Polycythemia vera"
      },
      {
        "id": 2,
        "text": "Essential thrombocythemia"
      },
      {
        "id": 3,
        "text": "Myelofibrosis"
      },
      {
        "id": 4,
        "text": "Leukemoid reaction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of&nbsp;<strong>essential&nbsp;thrombocythemia</strong> (ET). The image showing erythematous hands is suggestive of <strong>erythromelalgia</strong>.</p>\n<p>Essential thrombocythemia (essential thrombocytosis) is a myeloproliferative neoplasm. It is associated with mutations that increase JAK-STAT signaling.</p>\n<p><strong>WHO criteria</strong> for diagnosis of essential thrombocythemia:</p>\n<ul>\n<li>Major criteria -\n<ul>\n<li>Platelet count &ge;450 &times; 10<sup>9</sup>/L</li>\n<li>Bone marrow biopsy showing proliferation mainly of the megakaryocyte lineage with increased numbers of enlarged, mature megakaryocytes with hyperlobulated nuclei</li>\n<li>Not meeting WHO criteria for BCR-ABL1 chronic myeloid leukemia, PV, PMF, myelodysplastic syndromes, or other myeloid neoplasms</li>\n<li>Presence of JAK2, CALR, or MPL mutation</li>\n</ul>\n</li>\n<li>Minor criteria - the presence of a clonal marker or absence of evidence for reactive thrombocytosis</li>\n</ul>\n<p><strong>Diagnosis</strong> of ET requires meeting all <strong>4 major</strong> criteria <strong>or</strong> the first <strong>3 major</strong> criteria and the <strong>minor</strong> criterion</p>\n<p>Option A: Polycythemia vera can also present with erythromelalgia. However, it also presents with <strong>increased Hb</strong> levels.&nbsp;</p>\n<p>Option C: <strong>Fibrosis</strong> (not reticulin fibrils) is seen in bone marrow biopsy of primary myelofibrosis.&nbsp;</p>\n<p>Option D: <strong>WBC counts</strong> are <strong>increased</strong> in leukemoid reactions.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/68bf629723124f318c01b3ab2614be1d.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Patients with which of the following conditions do not have a leukoerythroblastic picture on peripheral smear?",
    "choices": [
      {
        "id": 1,
        "text": "Myelofibrosis"
      },
      {
        "id": 2,
        "text": "Myelophthisic anemia"
      },
      {
        "id": 3,
        "text": "Thalassemia"
      },
      {
        "id": 4,
        "text": "Gaucher disease"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Leukoerythroblastic picture is not seen in patients with thalassemia as it is a hemoglobinopathy and does not involve myeloid precursors.</p>\n<p>Abnormal presence of <strong>immature</strong> <strong>precursors</strong> of blood in the peripheral blood smear is called <strong>leukoerythroblastosis.&nbsp;</strong>Findings include:</p>\n<ul>\n<li>Nucleated red cells</li>\n<li>Dacryocytes (or teardrop RBC) - formed due to damage to red cell membrane caused by fibrous tissue in the marrow</li>\n<li>Immature cells of granulocytic series</li>\n</ul>\n<p>It occurs due to conditions causing <strong>marrow replacement</strong> like:</p>\n<ul>\n<li>Primary myelofibrosis - fibrosis of bone marrow</li>\n<li>Myelophthisic anemia - space occupying lesions of bone marrow</li>\n<li>Gauchers disease</li>\n<li>Spent phase of polycythemia vera</li>\n</ul>\n<p>&nbsp;The image given below shows a leukoerythroblastic blood picture with nucleated RBCs, tear-drop cells, and immature myeloid cells.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e1437ea4c10340708c6a4b076d29433cx1280x960.JPEG"
    ]
  },
  {
    "text": "Which of the following is not included under MDS/MPN overlap syndromes?",
    "choices": [
      {
        "id": 1,
        "text": "MDS/MPN with neutrophilia"
      },
      {
        "id": 2,
        "text": "Chronic myelomonocytic leukemia"
      },
      {
        "id": 3,
        "text": "MDS/MPN with SF31B mutation and thrombocytosis"
      },
      {
        "id": 4,
        "text": "MDS with excess blasts"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Myelodysplastic syndrome/ myeloproliferative neoplasm (<strong>MDS/MPN</strong>) <strong>overlap </strong>syndromes are a group of chronic clonal myeloid malignancies in which there are features of both MDS and MPN at the time of presentation. According to the 5th edition WHO classification (2022), it includes:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Chronic myelomonocytic leukemia</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">MDS/MPN with neutrophilia (previously atypical chronic myeloid leukemia)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">MDS/MPN with SF31B mutation and thrombocytosis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">MDS/MPN not otherwise specified</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not compatible with a diagnosis of chronic myelomonocytic leukemia?",
    "choices": [
      {
        "id": 1,
        "text": "Peripheral blood monocytosis more than 1\u00d710^9/L"
      },
      {
        "id": 2,
        "text": "Absence of Philadelphia chromosome"
      },
      {
        "id": 3,
        "text": "More than 20% blasts in blood or bone marrow"
      },
      {
        "id": 4,
        "text": "Absent or minimal dysplasia in myeloid lineages"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>More than 20% of blasts in the blood or bone marrow are not compatible with a diagnosis of chronic myelomonocytic leukemia (<strong>CMML</strong>). In this condition, <strong>blasts</strong> are <strong>less than 20%</strong>.</p>\n<p><strong>WHO 5th edition diagnostic criteria</strong>&nbsp;(2022_for chronic myelomonocytic leukemia (CMML) include:</p>\n<p><strong>Prerequisite criteria:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">1. Persistent absolute (<strong>&ge;0.5 &times; 10<sup>9</sup>/ L</strong>) and relative (<strong>&ge;10%</strong>) peripheral blood monocytosis.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">2. Blasts constitute <strong>&lt;20%</strong> of the cells in the peripheral blood and bone marrow.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">3. Not meeting diagnostic criteria of chronic myeloid leukemia or other myeloproliferative neoplasms (MPN).<sup>b</sup></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">4. Not meeting diagnostic criteria of myeloid/lymphoid neoplasms with tyrosine kinase fusions.<sup>c</sup></li>\n</ul>\n<p><strong>Supporting criteria:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">1. Dysplasia involving &ge;1 myeloid lineage.<sup>d</sup></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">2. Acquired clonal cytogenetic or molecular abnormality.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">3. Abnormal partitioning of peripheral blood monocyte subsets.<sup>e</sup></li>\n</ul>\n<p><strong>Pre-requisite criteria must be present in all cases:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">If monocytosis is &ge; 1 &times; 10<sup>9</sup>/ L: one or more supporting criteria must be met.</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">If monocytosis is &ge;0.5 and &lt;1 &times; 10<sup>9</sup>/ L: supporting criteria 1 and 2 must be met.</li>\n</ul>\n<p><strong>Subtype criteria:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Myelodysplastic CMML (MD-CMML): WBC &lt; 13 &times; 10<sup>9</sup>/L</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Myeloproliferative CMML (MP-CMML): WBC &ge; 13 &times; 10<sup>9</sup>/L</li>\n</ul>\n<div class=\"page\" title=\"Page 7\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><span style=\"font-size: 10pt;\">a. Blasts and blast equivalents include myeloblasts, monoblasts, and promonocytes.</span><br /><span style=\"font-size: 10pt;\"> b. MPN with monocytosis can mimic CMML. In these instances, a documented history of MPN excludes CMML. The presence of MPN features in the bone marrow and/or a high burden of MPN-associated mutations (JAK2, CALR, or MPL) tends to support MPN with monocytosis rather than CMML.</span></p>\n<p><span style=\"font-size: 10pt;\">c. Criteria for myeloid/lymphoid neoplasms with tyrosine kinase fusions should be specifically excluded in cases with eosinophilia.</span><br /><span style=\"font-size: 10pt;\"> d. Morphologic dysplasia should be present in &ge;10% of cells of a hematopoietic lineage in the bone marrow.</span></p>\n<p><span style=\"font-size: 10pt;\">e. Based on the detection of increased classical monocytes (&gt;94%) in the absence of known active autoimmune diseases and/or systemic inflammatory syndromes.</span></p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 2-year-old boy with Noonan syndrome presents with hepatosplenomegaly and lymphadenopathy. You are suspecting juvenile myelomonocytic leukemia. Which of the following is not seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "GM-CSF hypersensitivity"
      },
      {
        "id": 2,
        "text": "Absence of Philadelphia chromosome"
      },
      {
        "id": 3,
        "text": "Poor prognosis"
      },
      {
        "id": 4,
        "text": "Increased Hb A2 level"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>HbF</strong> levels are <strong>increased</strong> in <strong>juvenile myelomonocytic leukemia</strong> (JMML),&nbsp;not Hb A2.&nbsp;</p>\n<p>JMML is a hematopoietic stem cell-derived myeloproliferative neoplasm of early childhood. It is one of the myeloproliferative neoplasms. It is associated with mutations in the RAS pathway. Neurofibromatosis 1, Noonan syndrome, and trisomy 8 mosaicism can predispose to this condition.&nbsp;Aggressive types include PTPN11 mutation and neurofibromatosis type 1.</p>\n<p><strong>WHO diagnostic guidelines </strong>of JMML:</p>\n<table border=\"0\">\n<tbody>\n<tr>\n<td>\n<p><strong>Category I (Mandatory):</strong></p>\n<p><strong>Clinical and hematologic features</strong></p>\n</td>\n<td>\n<p><strong>Category II: </strong></p>\n<p><strong>Genetic (only 1 required)</strong></p>\n</td>\n<td><strong>Category III: Category I + these findings:</strong></td>\n</tr>\n<tr>\n<td>\n<ul>\n<li>Splenomegaly</li>\n<li>Peripheral blood monocyte count &ge;1 &times; 10<sup>9</sup>/L</li>\n<li>Blast percentage in peripheral blood and bone marrow &lt;20%</li>\n<li>No Philadelphia chromosome (BCR/ABL1 rearrangement)</li>\n<li>Exclusion of KMT2A mutation</li>\n</ul>\n</td>\n<td>\n<ul>\n<li>Somatic mutation in&nbsp;<em>PTPN11</em>* or&nbsp;<em>KRAS</em>* or&nbsp;<em>NRAS</em>*</li>\n<li>Clinical diagnosis of Neurofibromatosis type 1 or NF1 mutation</li>\n<li>Germline CBL mutation</li>\n</ul>\n</td>\n<td>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Hemoglobin F increased for age</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Myeloid or erythroid precursors on the peripheral blood smear</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Hypersensitivity to GM-CSF by colony assay and STAT5 hyperphosphorylation</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Thrombocytopenia with hypercellular bone marrow</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>\n<p>*Germline mutation (indicating Noonan syndrome) needs to be excluded.</p>\n<p>It is associated with a<strong> poor prognosis</strong> and only a few patients undergo spontaneous regression.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "JAK2 mutation is most commonly associated with _____",
    "choices": [
      {
        "id": 1,
        "text": "Polycythemia vera"
      },
      {
        "id": 2,
        "text": "Essential thrombocytosis"
      },
      {
        "id": 3,
        "text": "CML"
      },
      {
        "id": 4,
        "text": "PMF"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Polycythemia vera </strong>is strongly associated with activating point <strong>mutations</strong> in the tyrosine kinase<strong> JAK2</strong>.</p>\n<p>A mutation in JAK2, a key member of the cytokine intracellular signaling pathway, can be found in <strong>90&ndash;95%</strong> of patients with polycythemia vera.</p>\n<p>It is characterized by :</p>\n<ul>\n<li>Increased marrow production of red cells, granulocytes, and platelets&nbsp;<strong>(panmyelosis)</strong></li>\n<li><strong>Low&nbsp;</strong><strong>erythropoietin levels and elevated hematocrit</strong></li>\n<li>Blood viscosity and sludging lead to both thrombosis and bleeding.</li>\n<li>Headache, dizziness, hypertension, dizziness, venous thrombosis (Budd Chiari syndrome due to hepatic vein thrombosis), bowel infarction, and stroke.</li>\n<li><strong>Intense pruritus especially aquagenic pruritus</strong>&nbsp;</li>\n<li>Peptic ulceration, hyperuricemia</li>\n<li>15% to 20% of patients after an average period of 10 years -&gt;Myelofibrosis and extensive extramedullary hematopoiesis,</li>\n<li>PCV transforms into AML in 2% of patients.</li>\n</ul>\n<p><strong>Primary myelofibrosis</strong></p>\n<ul>\n<li>Marrow fibrosis associated with extramedullary hemopoiesis in the spleen.</li>\n<li><strong>Activating mutation in JAK2&nbsp;</strong><strong>(more commonly) or&nbsp;<em>MPL</em>.</strong></li>\n<li>Presence of neoplastic megakaryocytes, which are responsible for the release of fibrogenic factors like PDGF (platelet-derived growth factor) and TGF-&beta;.</li>\n<li>Bone&nbsp;<strong>marrow aspiration&nbsp;</strong><strong>yields dry tap&nbsp;</strong>due to fibrosis of the bone marrow.</li>\n<li>So,&nbsp;<strong>bone marrow biopsy is the investigation of choice</strong>, which shows the presence of hypocellularity with increased deposition of reticulin inside the marrow, abnormal megakaryocytes and the characteristic finding of dilated marrow sinusoids.</li>\n<li>Blood shows mild leukocytosis, decreased Hb and hematocrit levels, and elevated LAP scores.</li>\n<li>Acute myeloid leukemia (AML) occurs in 5% to 20% of cases.</li>\n</ul>\n<p><strong>Essential thrombocytosis (ET)</strong> may also be associated with&nbsp;<em>JAK2</em>,&nbsp;<em>MPL</em>, or&nbsp;<em>CALR</em>&nbsp;mutations.</p>\n<ul>\n<li>Essential thrombocytosis (ET) is often associated with activating point mutations in&nbsp;<strong><em>JAK2</em>&nbsp;(50% of cases) or&nbsp;<em>MPL</em>&nbsp;(5% to 10% of cases)</strong>, a receptor tyrosine kinase that is normally activated by thrombopoietin.</li>\n<li>In addition, recent DNA sequencing studies have revealed that most of the remaining cases have mutations in&nbsp;<strong>calreticulin (CALR)</strong>, a protein with several functions in the endoplasmic reticulum and the cytoplasm. Since&nbsp;<em>JAK2</em>&nbsp;and calreticulin mutations are mutually exclusive, it is hypothesized that the calreticulin mutations also increase JAK-STAT signaling through mechanisms that are currently unknown.</li>\n</ul>\n<p>CML is the consequence of the balanced translocation between chromosomes 9 and 22 (t[9;22]).</p>\n<p>PV, PMF, and ET are characterized by driver mutations that directly or indirectly constitutively activate JAK2, a tyrosine kinase essential for the function of the erythropoietin andthrombopoietin receptors and also utilized by granulocyte colony stimulating factor receptor.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following patients is least likely to have leukemoid reaction?",
    "choices": [
      {
        "id": 1,
        "text": "A patient with severe meningitis"
      },
      {
        "id": 2,
        "text": "A child with Down syndrome"
      },
      {
        "id": 3,
        "text": "A patient with hemorrhagic shock"
      },
      {
        "id": 4,
        "text": "A patient with acute myocardial infarction"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Myocardial infarction does not cause leukemoid reaction.</p>\n<p><strong>Leukemoid reaction </strong>is defined as <strong>persistent leukocytosis </strong>above 50000 cells /mm<sup>3</sup>,<sup>&nbsp;</sup>where the cause is other than leukemia.</p>\n<p><strong>Causes </strong>of leukemoid reaction include:</p>\n<ul>\n<li>Severe infections</li>\n<li>Malignancy</li>\n<li>Severe hemorrhage</li>\n<li>Acute hemolysis</li>\n<li>Trisomy 21 (Down syndrome)</li>\n<li>Asplenia</li>\n<li>Diabetic ketoacidosis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Electron microscopic picture of which of the following conditions is shown below?",
    "choices": [
      {
        "id": 1,
        "text": "Bernard\u2013Soulier syndrome"
      },
      {
        "id": 2,
        "text": "Mycosis fungoides"
      },
      {
        "id": 3,
        "text": "Glanzmann thrombasthenia"
      },
      {
        "id": 4,
        "text": "Langerhans cell histiocytosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Note: Tennis racket cells&nbsp;in light microscopy seen in sarcoma botryoides.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c284377481414961ab0bc7d4b46d52c1.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4dcf900614ef422d95f0a0eb2baa5943x1280x1589.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3ab4f69596b042458b6695eb55c25bc4x1280x1078.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a histiocytic neoplasm?",
    "choices": [
      {
        "id": 1,
        "text": "Langerhans cell histiocytosis"
      },
      {
        "id": 2,
        "text": "Rosai-Dorfman disease"
      },
      {
        "id": 3,
        "text": "Erdheim-Chester disease"
      },
      {
        "id": 4,
        "text": "Disseminated juvenile xanthogranuloma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Rosai&ndash;Dorfman disease is not a histiocytic neoplasm. It is sinus histiocytosis with massive lymphadenopathy.</p>\n<p>WHO classification of histiocytic/ hematolymphoid neoplasm 2016 includes the following:</p>\n<ul>\n<li>Histiocytic sarcoma</li>\n<li><strong>Langerhans cell histiocytosis</strong></li>\n<li>Langerhans cell sarcoma</li>\n<li>Indeterminate dendritic cell tumour</li>\n<li>lnterdigitating dendritic cell sarcoma</li>\n<li>Follicular dendritic cell sarcoma</li>\n<li>Fibroblastic reticular cell tumour</li>\n<li><strong>Disseminated juvenile xanthogranuloma</strong></li>\n<li><strong>Erdheim&ndash;Chester disease</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are suspecting Langerhans cell histiocytosis in a child with an enlarging scalp lesion. Which of the following markers will you test to confirm your diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "CD11a"
      },
      {
        "id": 2,
        "text": "HLA-DQ"
      },
      {
        "id": 3,
        "text": "CD107"
      },
      {
        "id": 4,
        "text": "S-100"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>S-100</strong> is a marker for <strong>Langerhans cell histiocytosis</strong>.</p>\n<p>Tumour cells in this condition typically express the following:</p>\n<ul>\n<li>HLA-DR</li>\n<li>S-100</li>\n<li>CD1a</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 5-year-old girl is brought to you by her father, who states that the girl is drinking a lot of water lately. Physical examination reveals exophthalmos. Further workup shows the presence of multiple lytic bone lesions involving her calvarium and the base of her skull.  What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Letterer-Siwe disease"
      },
      {
        "id": 2,
        "text": "Hand- Schuller- Christian disease"
      },
      {
        "id": 3,
        "text": "Eosionophilic granuloma"
      },
      {
        "id": 4,
        "text": "Unifocal Langerhans cell histiocytosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of&nbsp;<strong>Hand&ndash;Sch&uuml;ller&ndash;Christian disease. </strong></p>\n<p>Langerhans cell histiocytosis presents as multiple clinicopathological entities:</p>\n<p>1.&nbsp;<strong>Hand&ndash;Sch&uuml;ller&ndash;Christian </strong>disease&nbsp;is a multifocal unisystem&nbsp;Langerhans cell histiocytosis.&nbsp;It&nbsp;usually affects young children.&nbsp;It is characterized by the triad of:</p>\n<ul>\n<li>Diabetes insipidus (excessive thirst) -&nbsp;involvement of the posterior pituitary stalk of the hypothalamus</li>\n<li>Exophthalmos</li>\n<li>Multiple lytic bone lesions</li>\n</ul>\n<p>It usually undergoes spontaneous regression. It is treated with local excision or irradiation.</p>\n<p>2.<strong> Letterer&ndash;Siwe disease</strong> is a multifocal multisystem Langerhans cell histiocytosis. It occurs most frequently before 2 years of age, but occasionally affects adults.</p>\n<p>It is characterized by the following features:</p>\n<ul>\n<li>Cutaneous lesions, resembling a seborrheic eruption - caused by infiltrates of Langerhans cells over the front and back of the trunk and on the scalp</li>\n<li>Hepatosplenomegaly</li>\n<li>Lymphadenopathy</li>\n<li>Pulmonary lesions</li>\n<li>Destructive osteolytic bone lesions</li>\n<li>Due to marrow infiltration - anemia, thrombocytopenia, predisposition to recurrent infections (otitis media and mastoiditis)&nbsp;</li>\n</ul>\n<p>Treatment involves intensive chemotherapy. This condition is fatal if left untreated.</p>\n<p>3. <strong>Eosinophilic granuloma</strong> is a unifocal unisystem Langerhans cell histiocytosis. It is characterized by the proliferation of Langerhans cells admixed with variable numbers of eosinophils, lymphocytes, plasma cells, and neutrophils.&nbsp;</p>\n<p>These lesions occur in the following sites:</p>\n<ul>\n<li>Medullary cavities of bones - most commonly the calvarium, ribs, and femur</li>\n<li>Skin</li>\n<li>Lungs</li>\n<li>Stomach</li>\n</ul>\n<p>Bone lesions can manifest as:</p>\n<ul>\n<li>Asymptomatic</li>\n<li>Pain</li>\n<li>Tenderness</li>\n<li>Pathologic fractures.</li>\n</ul>\n<p>Treatment is by local excision or irradiation.</p>\n<p>&nbsp;</p>\n<p>4. <strong>Pulmonary</strong> Langerhans cell histiocytosis is most often seen in adult smokers. It regresses spontaneously upon cessation of smoking.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The X-ray of a 65-year-old man is given below. Clinical examination, and hematological and urinary tests were normal. Which of the following is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Multiple myeloma"
      },
      {
        "id": 2,
        "text": "Langerhans cell histiocytosis"
      },
      {
        "id": 3,
        "text": "Metastasis"
      },
      {
        "id": 4,
        "text": "Hyperparathyroidism"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image showing a <strong>solitary</strong>&nbsp;<strong>punched-out lytic lesion</strong>&nbsp;without a sclerotic rim with&nbsp;a&nbsp;<strong>beveled</strong><strong>&nbsp;edge</strong>&nbsp;appearance, along with the age of the patient with history of <strong>normal</strong> hematological and urinary tests is suggestive of&nbsp;<strong>Langerhans cell histiocytosis.</strong></p>\n<p>Langerhans cell histiocytosis occurs due to the proliferation of a special type of immature dendritic cells, called&nbsp;Langerhans cells.&nbsp;Their&nbsp;normal function is to present antigens.</p>\n<p>It is characterized by&nbsp;<strong>single </strong>or<strong> multiple osteolytic bone lesions.&nbsp;</strong>It<strong>&nbsp;</strong>can also infiltrate the skin (of the scalp), lungs, liver, spleen, bone marrow, or the central nervous system.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fb3d2835a649456290292b0401eb3fc4.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not true regarding the procedure done using the instrument given in the image below?",
    "choices": [
      {
        "id": 1,
        "text": "Contraindicated if platelet count <40,000"
      },
      {
        "id": 2,
        "text": "Breath holding is required"
      },
      {
        "id": 3,
        "text": "Procedure can be done in both lateral & prone position"
      },
      {
        "id": 4,
        "text": "Diagnosing an infiltrative or granulomatous disease"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image shows a <strong>bone marrow biopsy needle.&nbsp;Thrombocytopenia </strong>is<strong> not </strong>in itself a<strong> contraindication </strong>for bone marrow biopsy.<strong>&nbsp;</strong>However, a platelet count &gt;20,000 is ensured for safety purposes.</p>\n<p><strong>Indications </strong>of bone marrow biopsy:</p>\n<ul>\n<li>Evaluation of unexplained anemia, leukopenia, thrombocytopenia, pancytopenia</li>\n<li>Evaluation of polycythemia, thrombocytosis, leukocytosis</li>\n<li>Diagnosis and staging of lymphoma or solid tumors</li>\n<li>Diagnosis and evaluation of plasma cell disorders and leukemias</li>\n<li>Evaluation of suspected infiltrative and storage diseases</li>\n<li>Evaluation of fever of unknown origin, suspected mycobacterial, fungal, or parasitic infections, or granulomatous diseases</li>\n</ul>\n<p><strong>Contraindications</strong> of bone marrow biopsy:</p>\n<ul>\n<li>Severe hemophilia</li>\n<li>Severe disseminated intravascular coagulopathy</li>\n<li>Severe bleeding disorders</li>\n</ul>\n<p><strong>Procedure</strong> for bone marrow biopsy:</p>\n<p>Prone or lateral position is chosen for the procedure. Posterior superior iliac spine is identified. After disinfection and local anaesthesia, the patient is asked to inhale slowly through the nose and exhale slowly through the mouth to relieve anxiety .The needle is inserted and rotated on its axis.</p>\n<p>On reaching the desired depth, the stylet is removed and needle is advanced. The needle is rotated in the opposite direction to loosen the specimen. It is then withdrawn using the same rotational movement.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9e1a29810adf4e8db425729998e4107e.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/abc691ac348544e79127b6941c1c71e6x800x640.JPEG"
    ]
  },
  {
    "text": "Blood examination shows pancytopenia, which can be correct?",
    "choices": [
      {
        "id": 1,
        "text": "B, D"
      },
      {
        "id": 2,
        "text": "A, B, C"
      },
      {
        "id": 3,
        "text": "B, C,  D"
      },
      {
        "id": 4,
        "text": "A, B, D"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Megaloblastic anemia</strong> (hypocellular phase), <strong>hairy cell leukemia,</strong> and <strong>hypocellular MDS</strong>&nbsp;can show <strong>pancytopenia</strong>. Acute promyelocytic leukemia is not associated with pancytopenia.&nbsp;&nbsp;</p>\n<p>Causes of <strong>pancytopenia</strong> with <strong>hypocellular bone marrow:</strong></p>\n<ul>\n<li>Acquired aplastic anemia</li>\n<li>Hypocellular myelodysplastic syndrome</li>\n<li>Rare aleukemic leukemia</li>\n<li>Some acute lymphoid leukemia</li>\n<li>Rare lymphomas of bone marrow</li>\n<li>Copper deficiency</li>\n</ul>\n<p>Causes of <strong>pancytopenia</strong> with <strong>cellular&nbsp;bone&nbsp;marrow:</strong></p>\n<ul>\n<li class=\"p2\">Myelodysplastic syndromes</li>\n<li class=\"p2\">Systemic lupus erythematosus</li>\n<li class=\"p2\">Paroxysmal nocturnal hemoglobinuria (PNH)</li>\n<li class=\"p2\">Hypersplenism</li>\n<li class=\"p2\">B<span class=\"s1\">12</span>, folate deficiency, Copper deficiency</li>\n<li class=\"p2\">Myelofibrosis</li>\n<li class=\"p2\">Aleukemic leukemia</li>\n<li class=\"p2\">HIV,&nbsp;Brucellosis,&nbsp;Leishmaniasis,&nbsp;Tuberculosis Sepsis</li>\n<li class=\"p2\">Myelophthisis&nbsp;</li>\n<li class=\"p2\">Bone marrow lymphoma</li>\n<li class=\"p2\">Sarcoidosis</li>\n<li class=\"p2\">Hairy cell leukemia</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following conditions will have the least chances of a dry tap on bone marrow aspiration?",
    "choices": [
      {
        "id": 1,
        "text": "Hairy cell leukemia"
      },
      {
        "id": 2,
        "text": "Follicular lymphoma"
      },
      {
        "id": 3,
        "text": "AML M7"
      },
      {
        "id": 4,
        "text": "Myelodysplastic syndrome"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Follicular lymphoma</strong>\u00a0is the least likely cause of a dry tap on bone marrow aspiration.</p>\n<p>Causes of\u00a0<strong>dry tap</strong>\u00a0are:</p>\n<ul>\n<li>Metastatic carcinoma infiltration\u00a0</li>\n<li>Chronic myeloid leukemia\u00a0</li>\n<li><strong>Myelofibrosis</strong>\u00a0</li>\n<li><strong>Hairy cell leukemia</strong>\u00a0</li>\n<li>Acute leukemia\u00a0</li>\n<li>Hodgkin's lymphoma</li>\n<li><strong>AML- M7</strong></li>\n</ul>\n<p>Causes of\u00a0<strong>pancytopenia with cellular marrow</strong>\u00a0are:</p>\n<p>Primary disease of marrow-</p>\n<ul>\n<li>Myelodysplastic syndrome</li>\n<li>Paroxysmal nocturnal\u00a0hemoglobinuria (PNH)</li>\n<li>Myelofibrosis</li>\n<li>Aleukemic leukemia</li>\n<li>Myelophthisis</li>\n<li>Bone marrow lymphoma</li>\n<li>Hairy cell leukemia</li>\n</ul>\n<p>Secondary to systemic disease-</p>\n<ul>\n<li>SLE, sarcoidosis</li>\n<li>B12, folate deficiency</li>\n<li>Copper deficiency</li>\n<li>Hypersplenism</li>\n<li>Alcohol</li>\n<li>HIV infection, TB</li>\n<li>Brucellosis, leishmaniasis\u00a0</li>\n</ul>\n<p>\u00a0</p>\n<p>Note: Although marrow is hypercellular in CML, MDS etc., extensive marrow fibrosis (rare) has been proposed to account for a dry tap on bone marrow biopsy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '33 Myelodysplastic Syndrome, Myeloproliferative Syndromes And Histiocytosis';
        const quizFilename = '33-myelodysplastic-syndrome-myeloproliferative-syndromes-and-histiocytosis-0fcaafd5.html';
        let hierarchy = ["Marrow", "qBank", "Pathology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>