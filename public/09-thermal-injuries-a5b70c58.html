<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>09 Thermal Injuries - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Forensic Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is not a thermal injury?",
    "choices": [
      {
        "id": 1,
        "text": "Lightning stroke"
      },
      {
        "id": 2,
        "text": "Burns"
      },
      {
        "id": 3,
        "text": "Electrical injuries"
      },
      {
        "id": 4,
        "text": "Gunshot"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Gunshot wound is not a thermal injury.</p>\n<p><strong>Thermal injuries</strong></p>\n<table>\n<tbody>\n<tr>\n<td width=\"154\">\n<p>Heat</p>\n</td>\n<td width=\"154\">\n<p>Cold</p>\n</td>\n<td width=\"154\">\n<p>Others</p>\n</td>\n</tr>\n<tr>\n<td width=\"154\">\n<p>Heat cramps</p>\n<p>Heat prostration</p>\n<p>Heatstroke</p>\n<p>Hyperthermic anhydrosis</p>\n</td>\n<td width=\"154\">\n<p>Frostbite</p>\n<p>Trench foot</p>\n<p>Immersion foot</p>\n<p>Hypothermia</p>\n<p>Neonatal cold injury</p>\n</td>\n<td width=\"154\">\n<p>Burns</p>\n<p>Scalds</p>\n<p>Electrical injuries</p>\n<p>Lightning stroke</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Thermal deaths are those which result from the effects of systemic/localized exposure to excessive heat and cold.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A person is considered to be hypothermic when their temperature falls below:",
    "choices": [
      {
        "id": 1,
        "text": "30\u00b0 C"
      },
      {
        "id": 2,
        "text": "32\u00b0 C"
      },
      {
        "id": 3,
        "text": "34\u00b0 C"
      },
      {
        "id": 4,
        "text": "35\u00b0 C"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hypothermia</strong> occurs when the body's core temperature drops <strong>below&nbsp;35&deg;C.</strong></p>\n<ul>\n<li class=\"bulletIndent1\">Mild hypothermia &ndash; Core temperature 32 to 35&deg;C (90 to 95&deg;F)</li>\n<li class=\"bulletIndent1\">Moderate hypothermia &ndash; Core temperature 28 to 32&deg;C (82 to 90&deg;F)</li>\n<li class=\"bulletIndent1\">Severe hypothermia &ndash; Core temperature below 28&ordm;C (82&deg;F)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Temperature regulation by the hypothalamus completely fails below which body temperature?",
    "choices": [
      {
        "id": 1,
        "text": "28 \u00b0 C"
      },
      {
        "id": 2,
        "text": "34 \u00b0 C"
      },
      {
        "id": 3,
        "text": "32 \u00b0 C"
      },
      {
        "id": 4,
        "text": "30 \u00b0 C"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p class=\"p1\">Once the body temperature has fallen <strong>below</strong> about 85\u00b0F (<strong>30\u00b0C</strong>), the ability of the hypothalamus to regulate temperature is lost.\u00a0</p>\n<p class=\"p1\">For each 10\u00b0F decrease in body temperature,\u00a0the rate of chemical heat production in each cell is depressed almost twofold. This is the reason for diminished temperature regulation.\u00a0Sleepiness followed by coma, depresses the activity of the CNS heat control mechanisms and prevents shivering.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly man was brought to the OPD with cold hands and feet. He was found unconscious in a snowstorm near his village. On examination, his temperature showed 32.5\u00b0C. Which among the following is least likely to develop in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary edema"
      },
      {
        "id": 2,
        "text": "Gastric erosions"
      },
      {
        "id": 3,
        "text": "Acute pancreatitis"
      },
      {
        "id": 4,
        "text": "Extradural hematoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Note: A condition resembling extradural hematoma may be found in burns patients, called heat hematoma.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/79efd483f0284599bfdef8ac305d3970x475x358.JPEG"
    ]
  },
  {
    "text": "A body of a hiker is found naked on a snow trail. It is hypothesized that he actively undressed just minutes prior to his death. Which of the following statements regarding this phenomenon is true?",
    "choices": [
      {
        "id": 1,
        "text": "Indicator of mild to moderate hypothermia"
      },
      {
        "id": 2,
        "text": "Associated with increased carbon monoxide in circulation"
      },
      {
        "id": 3,
        "text": "Always associated with hide-and-die syndrome"
      },
      {
        "id": 4,
        "text": "The mechanism is that of peripheral vasodilation"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given phenomenon of <strong>paradoxical undressing</strong> is likely due to&nbsp;<strong>peripheral vasodilation.</strong></p>\n<p>It is a phenomenon encountered in <strong>severe hypothermic states</strong>.&nbsp;It is characterized by the act of active undressing, despite low ambient temperatures. Proposed mechanisms are:</p>\n<ul>\n<li>Reflex vasoconstriction, which happens in the first stage of hypothermia, leads to paralysis of the vasomotor center thus giving rise to the sensation that the body temperature is higher than it really is.</li>\n<li>Vasodilatation<strong>&nbsp;</strong>happens when&nbsp;cold-induced paralysis of the nerves in the vessel walls&nbsp;gives an absurd feeling of heat.</li>\n</ul>\n<p>Other associated features include:</p>\n<ul>\n<li>Bruises and scratches of the knees, shanks, and upper limbs caused by late-phase attempts at crawling.&nbsp;</li>\n<li>The hide-and-die phenomenon in some cases.</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly woman was found dead during winter in her wardrobe. On house inspection, the heater was found to be broken. She was also identified to be a known case of hypothyroidism. Which of the following most likely explains her scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Myxedema coma"
      },
      {
        "id": 2,
        "text": "Terminal burrowing behaviour"
      },
      {
        "id": 3,
        "text": "Paradoxical undressing"
      },
      {
        "id": 4,
        "text": "Sudden cardiac arrest"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most likely explanation for the given scenario is <strong>terminal burrowing behaviour</strong> or <strong>hide and die syndrome</strong>.&nbsp;</p>\n<p>An elderly lady with hypothyroidism is more likely to develop hypothermia. About 20% of hypothermia cases are associated with terminal burrowing behaviour.</p>\n<p>In some cases the bodies were found in strange situations, i.e. lying under a bed, behind a wardrobe, or on a shelf, etc. indicating that the final positions were a kind of self-protective burrowing-like behaviour.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A farmer suddenly collapsed on a hot summer afternoon after working on the field since morning. On examination, his pupils were constricted associated with dry hot flushed skin and no sweating. This is seen at a core body temperature above:",
    "choices": [
      {
        "id": 1,
        "text": "40.5\u00b0 C"
      },
      {
        "id": 2,
        "text": "38.5\u00b0 C"
      },
      {
        "id": 3,
        "text": "39.5\u00b0 C"
      },
      {
        "id": 4,
        "text": "41.5\u00b0 C"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p class=\"p1\">The given scenario is suggestive of <strong>heatstroke</strong> and a core temperature<strong> &gt;40.5&deg;C</strong> helps establish the diagnosis.</p>\n<p class=\"p1\"><span class=\"s1\">A</span>s body core temperature rises, excessive cutaneous vasodilation can lead to a fall in arterial pressure and therefore to a <strong>decrease</strong> in<strong> brain perfusion</strong>. This leads to a total loss of thermoregulatory function. As core temperature approaches 41&ordm;C, sweating stops, confusion and, ultimately, loss of consciousness occurs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following scoring systems is used to assess the risk of mortality in a burns patient?",
    "choices": [
      {
        "id": 1,
        "text": "Grant score"
      },
      {
        "id": 2,
        "text": "Flint score"
      },
      {
        "id": 3,
        "text": "Baux score"
      },
      {
        "id": 4,
        "text": "Rockall score"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The <strong>Baux score</strong>&nbsp;was used for many years to predict mortality in burns.</p>\n<p class=\"p1\">Baux score: Mortality risk = age + %TBSA</p>\n<p class=\"p1\">Advancements in burn care have lowered overall mortality to the point that the <strong>Baux score may no longer be accurate</strong>. However, age and burn size, as well as inhalation injury, continues to be the most robust indicators for burn mortality.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements about burns is true?",
    "choices": [
      {
        "id": 1,
        "text": "Minimum temperature for producing burn is 42\u00b0C for 5-6 hours"
      },
      {
        "id": 2,
        "text": "Minimum temperature for producing burn is 40\u00b0C for 3 hours"
      },
      {
        "id": 3,
        "text": "Minimum temperature for producing burn is 44\u00b0C for 5-6 hours"
      },
      {
        "id": 4,
        "text": "Minimum temperature for producing burn is 44\u00b0C for 3 hours"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The lowest temperature that causes burn damage is <strong>44&deg;C</strong> and requires&nbsp;<strong>5-6 hours</strong> before a burn appears.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The three-stage classification of burns was provided by:",
    "choices": [
      {
        "id": 1,
        "text": "Dupuytren"
      },
      {
        "id": 2,
        "text": "Wilson"
      },
      {
        "id": 3,
        "text": "Heister"
      },
      {
        "id": 4,
        "text": "Rockall"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>three-stage</strong> classification of burn degrees was provided by<strong> Wilson.</strong></p>\n<p>Wilson classification of burns:</p>\n<ul>\n<li>First degree - Erythema and blistering without loss of dermis</li>\n<li>Second degree - Destruction of the full thickness of skin</li>\n<li>Third-degree - Destruction of deeper tissues below the skin</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is the most precise method of estimation of burn surface area?",
    "choices": [
      {
        "id": 1,
        "text": "Wallace's rule of nines"
      },
      {
        "id": 2,
        "text": "Lund-Browder chart"
      },
      {
        "id": 3,
        "text": "Parkland formula"
      },
      {
        "id": 4,
        "text": "Dupuytren's classification"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Use of patient's hand -&nbsp;</strong>The area of the back of the patient&rsquo;s hand is approximately 1% of their total body surface area. The number of 'hands' that equal the area of the burn can approximate the percentage of body surface area burned.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4b72c90222724759afb72455bd82fb26x1280x1508.PNG"
    ]
  },
  {
    "text": "What is the primary cause of late mortality in burns?",
    "choices": [
      {
        "id": 1,
        "text": "Laryngeal edema"
      },
      {
        "id": 2,
        "text": "Multi-organ failure"
      },
      {
        "id": 3,
        "text": "Hypovolemic shock"
      },
      {
        "id": 4,
        "text": "Electrolyte imbalance"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The primary cause of late mortality in burns is <strong>septicemia </strong>and<strong> multiorgan failure</strong>.</p>\n<p>The primary cause of early mortality in burns is <strong>burn shock</strong>.&nbsp;The term burn shock describes the rapidly developing hypovolemic circulatory failure seen in the first 72 hours after burns.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An autopsy was done on a burn victim. Which of the following is a reliable indicator that the victim was alive while the fire was in progress?",
    "choices": [
      {
        "id": 1,
        "text": "Vital reaction in the burned area"
      },
      {
        "id": 2,
        "text": "Redness of the exposed skin surface"
      },
      {
        "id": 3,
        "text": "Elevated carboxyhemoglobin levels"
      },
      {
        "id": 4,
        "text": "Blistering of the skin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Elevated\u00a0levels of <strong>carbon monoxide</strong> in the<strong> circulating blood</strong> and <strong>carbon particles </strong>in the<strong> air passages</strong> and <strong>lungs</strong>\u00a0are reliable indicators suggesting that the victim was alive while the fire was in progress.</p>\n<p>The carbon monoxide concentration in blood depends on various factors like the concentration of carbon monoxide in the air, blood hemoglobin level, duration of exposure, etc. The presence of carbon particles and elevated Carboxy hemoglobin levels are <strong>absolute proof </strong>that the victim was alive when the fire occurred. Though there is no definite level that confirms the presence or absence of carboxyhemoglobin in the blood, a level of 10% is needed to confirm unless the person is a heavy smoker.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following injuries is the pugilistic attitude of the victim seen?",
    "choices": [
      {
        "id": 1,
        "text": "Electrical injury"
      },
      {
        "id": 2,
        "text": "Lightning injury"
      },
      {
        "id": 3,
        "text": "Burn injury"
      },
      {
        "id": 4,
        "text": "Blast injury"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The attitude of general flexion called the <strong>pugilistic attitude</strong> is seen in a <strong>burn victim.</strong></p>\n<p class=\"p1\">Muscle contractures are common where substantial heat has reached the body.&nbsp; The muscle becomes shortened by <strong>dehydration</strong> and <strong>protein denaturation.</strong> The <strong>flexors,</strong> being bulkier than the extensors, <strong>contract more</strong> and force the limbs into a position of <strong>general flexion,</strong> the so-called <strong>boxer's</strong>&nbsp;or <strong>pugilistic attitude.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A victim who allegedly died in a fire at his house was brought in for an autopsy. On examination, he has wounds that appear like lacerations on his forehead and extensor surfaces. There is no sign of bleeding within the deeper tissues in the wound. Which of the following can be an indicator of homicidal death?",
    "choices": [
      {
        "id": 1,
        "text": "There is no evidence"
      },
      {
        "id": 2,
        "text": "Lacerated looking wounds"
      },
      {
        "id": 3,
        "text": "Bleeding in the epidural space"
      },
      {
        "id": 4,
        "text": "Elevated HbCO in blood of the heat hematoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the above scenario, there is no evidence that indicates the victim may have died from a homicidal injury and that the fire may have been used to cover up the crime.</p>\n<p>The <strong>lacerated-looking wounds</strong> found in this victim are <strong>spurious</strong> findings commonly found in <strong>burn</strong> victims.</p>\n<p>Spurious wounds in burns :</p>\n<ul>\n<li><strong>Skin splits</strong> -\u00a0Heated skin contracts markedly and splits often appear.\u00a0These splits may be anywhere but are especially seen over extensor surfaces and joints, as well on the head.\u00a0The false split will show no bleeding\u00a0in the deeper tissues and its position is usually suggestive.</li>\n<li><strong>Heat hematoma</strong> - the mass of blood resembling a true extradural hematoma may form between the skull and the dura. This may arise either from venous sinuses or out of the diploic space in the skull through emissary venous channels.</li>\n</ul>\n<p>If death occured during the fire (<strong>antemortem</strong>), levels of carboxyhemoglobin will be <strong>elevated</strong> in the <strong>blood</strong> and the <strong>heat hematoma</strong>. If the victim died before the fire (<strong>postmortem</strong>), the levels of carboxyhemoglobin will be little to none.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements about heat fractures of the skull is false?",
    "choices": [
      {
        "id": 1,
        "text": "It resembles a spider-web fracture"
      },
      {
        "id": 2,
        "text": "Seen at the base of the skull"
      },
      {
        "id": 3,
        "text": "It requires 20 minutes of heat application"
      },
      {
        "id": 4,
        "text": "It does not involve the suture lines"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Heat fractures</strong> of the skull are most commonly seen at the <strong>sides </strong>of the<strong> skull</strong>, usually bilaterally.</p>\n<p>Fractures to the base of the skull are unheard of in the case of thermal fractures and should be considered to be an antemortem injury.</p>\n<p>Heat fractures of the skull\u00a0take approximately <strong>20 minutes </strong>of<strong> heat </strong>application before the skull starts to crack</p>\n<p>The pattern of fracture commonly resembles a <strong>spider web. </strong>They\u00a0may cross the suture line but<strong>\u00a0</strong>usually do not involve the sutures, even in young persons with un-united sutures.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a 45-year-old man with a history of burning, the following finding was seen. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Curling ulcer"
      },
      {
        "id": 2,
        "text": "Marjolin\u2019s ulcer"
      },
      {
        "id": 3,
        "text": "Basal cell carcinoma"
      },
      {
        "id": 4,
        "text": "Cushing's ulcer"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\">The image shows a '<strong>Marjolin ulcer</strong>' which is&nbsp;a rare type of SCC (squamous cell carcinoma) that arises in sites of chronic wounds or scars.</p>\n<p class=\"headingAnchor\">The malignant transformation is slow, with an average latency time of approx 30 years.&nbsp;</p>\n<p class=\"headingAnchor\">The tumor may initially present as:</p>\n<ul>\n<li class=\"headingAnchor\">Ulceration</li>\n<li class=\"headingAnchor\">Nodules&nbsp;</li>\n<li class=\"headingAnchor\">Rolled or everted wound margins</li>\n<li class=\"headingAnchor\">Excessive granulation tissue</li>\n<li class=\"headingAnchor\">A rapid increase in size</li>\n<li class=\"headingAnchor\">Bleeding on touch.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7f50446553f44ebf9c4873c7402c78f4.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "In which of the following condition can Curling's ulcer be seen?",
    "choices": [
      {
        "id": 1,
        "text": "Head injury"
      },
      {
        "id": 2,
        "text": "Burn victims"
      },
      {
        "id": 3,
        "text": "Electrical injury"
      },
      {
        "id": 4,
        "text": "Abdominal trauma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Curling's ulcers</strong> are seen in<strong> burn victims.</strong></p>\n<p>This is seen due to intravascular depletion leading to mucosal ischemia and disruption of the protective mucosal barrier.</p>\n<p class=\"p1\">H<span class=\"s1\">2</span> -receptor antagonists or PPIs have proved effective against the development of stress gastritis.</p>\n<p class=\"p1\">Note:<strong> Brain tumors, traumatic head injury, </strong>and other intracranial processes including infections can cause increased intracranial pressure. This leads to overstimulation of the vagus nerve. As a result, increased secretion of gastric acid may occur which leads to gastro-duodenal ulcer formation known as <strong>Cushing's ulcer.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presents with a skin lesion, as shown in the image below. Which of the following is least likely to cause it?",
    "choices": [
      {
        "id": 1,
        "text": "Steam"
      },
      {
        "id": 2,
        "text": "Chemical fire"
      },
      {
        "id": 3,
        "text": "Hot water"
      },
      {
        "id": 4,
        "text": "Molten rubber"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows a scald injury. A <strong>chemical fire</strong> is going to cause a <strong>burn,</strong> not a scald.</p>\n<p>Scalds are sharply demarcated lesions with reddening, desquamation, and blistering.\u00a0When tipped or splashed, the hot liquid runs under gravity so that trickle patterns may be seen.\u00a0</p>\n<p>It is caused due to tissue damage from hot liquids like:</p>\n<ul>\n<li>Hot water</li>\n<li>Hot oils</li>\n<li>Molten rubber</li>\n<li>Liquid chemicals</li>\n<li>Steam.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c5d067dab7e74116a8ca2669de501bb9.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A lineman working on an electric pole suffered an electrical injury. Which of the following statements is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "The most common cause of death is ventricular fibrillation ending in cardiac arrest"
      },
      {
        "id": 2,
        "text": "The most dangerous contact path is entry through the right hand and exit through the opposite feet"
      },
      {
        "id": 3,
        "text": "With repeated exposure, tolerance develops to electric shock"
      },
      {
        "id": 4,
        "text": "Direct current is more damaging than alternating current"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Alternating current</strong> is <strong>more damaging</strong> than direct current.</p>\n<p>It has been claimed that the most<strong> dangerous </strong>current<strong> path </strong>is contacted with the<strong> right hand </strong>and <strong>exits </strong>through the<strong> left foot</strong>, as this causes the maximum<strong>&nbsp;</strong>of the total body current to flow through the<strong> heart.</strong> when compared with head to feet, left hand to feet, hand to hand, or foot to foot.</p>\n<p><strong>Most deaths </strong>from electricity are from<strong> cardiac arrhythmias</strong>, usually, <strong>ventricular fibrillation</strong> ending in cardiac arrest.</p>\n<p>It is commonly said that <strong>tolerance can be gained to electric shock</strong> and that professional electricians often work on live 240 V conductors with impunity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2936087126e04e90bc2a8e77c0762804x1280x1801.JPEG"
    ]
  },
  {
    "text": "While performing an autopsy on a burn victim, the following cutaneous findings were noted. What is the term used to describe these burns?",
    "choices": [
      {
        "id": 1,
        "text": "Crocodile skin"
      },
      {
        "id": 2,
        "text": "Joule burn"
      },
      {
        "id": 3,
        "text": "Spark lesion"
      },
      {
        "id": 4,
        "text": "Filigree burn"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>&nbsp;</p>\n<p>Image below shows the various electrical marks.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0c35f193bb8c47e99b3926ace6ede985.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/13741355a1e04fd5ad79ddf1264227c6x720x484.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/57e5c58f46f54bd8b9491f6c04aa6325x512x342.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5f6de74e540b4acfb333fe58a2f0b013x1280x1882.JPEG"
    ]
  },
  {
    "text": "Which of the following features of electrical injury will develop if the contact with the electrocuting surface is poorly established?",
    "choices": [
      {
        "id": 1,
        "text": "Crocodile skin"
      },
      {
        "id": 2,
        "text": "Joule burn"
      },
      {
        "id": 3,
        "text": "Bone pearl"
      },
      {
        "id": 4,
        "text": "Spark lesion"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>When the contact with the electrocuting surface is not firm, the skin lesion that develops is called a <strong>spark lesion</strong>.</p>\n<p>When the contact is less firm, an air gap (albeit narrow) exists between skin and conductor the current jumps the gap as a spark. This causes the outer skin keratin to melt over a small area. On cooling, the keratin fuses into a hard brownish nodule, usually raised above the surrounding surface.</p>\n<p>Various skin lesions in electrical injury:</p>\n<ul>\n<li>When the skin has been in firm contact with an electrical conductor, this may split the layers of the epidermis or the epidermal-dermal junction and produce a raised blister called&nbsp;<strong>Joule burns.</strong></li>\n<li>In high-voltage burns, such as those sustained from high-tension grid transmission cables, where the voltage is in the multi-kilovolt range, sparking may occur over many centimeters. This can cause multiple spark lesions giving rise to a <strong>&lsquo;crocodile-skin&rsquo; effect.</strong></li>\n<li>The heat generated by the current may melt the calcium phosphate, which is radiologically seen as typical round dense foci called as '<strong>bone pearls</strong>' or 'wax drippings'.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/78a1a5b9a362479bb6c741086b8a9730x1280x1882.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bb8aec3bc8a04cca8b628abeca0ff59ex720x484.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e4a5bf7f876f43f08e4eb6aaface8651x512x342.JPEG"
    ]
  },
  {
    "text": "The 'hold-on effect' is characteristically seen in",
    "choices": [
      {
        "id": 1,
        "text": "Pugilistic attitude"
      },
      {
        "id": 2,
        "text": "Immersion foot"
      },
      {
        "id": 3,
        "text": "Electrical injury"
      },
      {
        "id": 4,
        "text": "Lightning injury"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The<strong> hold-on effect</strong> is seen in <strong>electrical injuries</strong>.</p>\n<p>When the entry point is in the hand, the stronger flexor muscles of the arm go into spasm and&nbsp;cause a hold-on effect. Any object being held in the hand is involuntarily clenched and the current thus continues to flow.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '09 Thermal Injuries';
        const quizFilename = '09-thermal-injuries-a5b70c58.html';
        let hierarchy = ["Marrow", "qBank", "Forensic Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>