<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27 Cardiovascular Conditions In Pregnancy - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Obstetrics & Gynecology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "The most common valvular heart disease in pregnancy is ______",
    "choices": [
      {
        "id": 1,
        "text": "Aortic stenosis"
      },
      {
        "id": 2,
        "text": "Mitral stenosis"
      },
      {
        "id": 3,
        "text": "Mitral regurgitation"
      },
      {
        "id": 4,
        "text": "Mitral valve prolapse"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Mitral stenosis</strong> is the most common valvular heart disease in pregnancy.</p>\n<p>The commonest cardiac lesions are of <strong>rheumatic</strong> origin followed by congenital conditions. The incidence of cardiac lesions is less than 1% amongst hospital deliveries.&nbsp;Rheumatic valvular lesions predominantly include mitral stenosis (80%).&nbsp;&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the commonest congenital valvular lesion observed in pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Mitral stenosis"
      },
      {
        "id": 2,
        "text": "Mitral regurgitation"
      },
      {
        "id": 3,
        "text": "Mitral valve prolapse"
      },
      {
        "id": 4,
        "text": "Aortic stenosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Mitral valve prolapse</strong> (MVP) is the commonest <strong>congenital</strong> valvular lesion observed in pregnancy.&nbsp;<strong>Mitral stenosis </strong>is the commonest<strong> acquired </strong>heart lesion during pregnancy.</p>\n<table style=\"width: 502.3125px;\" cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr style=\"height: 27px;\">\n<td style=\"width: 228px; height: 27px; text-align: left;\" valign=\"top\">\n<p><strong>Condition in pregnancy</strong></p>\n</td>\n<td style=\"width: 282.3125px; height: 27px; text-align: left;\" valign=\"top\">\n<p style=\"text-align: left;\"><strong>Most common lesion</strong></p>\n</td>\n</tr>\n<tr style=\"height: 33px;\">\n<td style=\"width: 228px; height: 33px; text-align: left;\" valign=\"top\">\n<p>Congenital heart disease</p>\n</td>\n<td style=\"width: 282.3125px; height: 33px; text-align: left;\" valign=\"top\">\n<p>Atrial septal defect</p>\n</td>\n</tr>\n<tr style=\"height: 19px;\">\n<td style=\"width: 228px; height: 19px; text-align: left;\" valign=\"top\">\n<p>Congenital valvular lesion</p>\n</td>\n<td style=\"width: 282.3125px; height: 19px; text-align: left;\" valign=\"top\">\n<p>Mitral valve prolapse</p>\n</td>\n</tr>\n<tr style=\"height: 64px;\">\n<td style=\"width: 228px; height: 64px; text-align: left;\" valign=\"top\">\n<p>Cyanotic Congenital Heart disease</p>\n</td>\n<td style=\"width: 282.3125px; height: 64px; text-align: left;\" valign=\"top\">\n<p>Tetrology of Fallot</p>\n</td>\n</tr>\n<tr style=\"height: 64px;\">\n<td style=\"width: 228px; height: 64px; text-align: left;\" valign=\"top\">\n<p>Acquired valvular heart disease</p>\n</td>\n<td style=\"width: 282.3125px; height: 64px; text-align: left;\" valign=\"top\">\n<p>Mitral stenosis &gt; Mitral regurgitation &gt; Aortic stenosis</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 24-year-old lady with rheumatic mitral stenosis becomes pregnant. At what point during her pregnancy would you be least concerned about her developing cardiac failure?",
    "choices": [
      {
        "id": 1,
        "text": "24 weeks of gestation"
      },
      {
        "id": 2,
        "text": "30 weeks of gestation"
      },
      {
        "id": 3,
        "text": "During labor"
      },
      {
        "id": 4,
        "text": "Immediate post-partum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Cardiac failure in pregnancy is least likely to occur during <strong>24 weeks</strong>, considering the given options.</p>\n<p>The order of risk of cardiac failure in pregnancy is<strong> immediate postpartum &gt; 2nd stage of labor &gt; 30 weeks &gt; 22 weeks.</strong></p>\n<p>Maternal cardiac<strong> risk predictors</strong>: [Mnemonic: NOPE]</p>\n<p>&nbsp; <strong>N</strong>-NYHA class &gt;2</p>\n<p><strong>&nbsp; O</strong>-Obstructive lesions of left heart (Mitral valve area &lt;2 cm<sup>2 </sup>&nbsp;or aortic valve area &lt;1.5 cm<sup>2</sup>, peak LV outflow tract gradient&nbsp;&gt;30 mmHg)</p>\n<p>&nbsp; <strong>P</strong>-Prior cardiac events before pregnancy</p>\n<p>&nbsp; <strong>E</strong>-Ejection fraction &lt;40%</p>\n<p>Scoring systems used to calculate risk are Cardiac Disease in Pregnancy (<strong>CARPREG</strong>) and <strong>ZAHARA</strong> scores.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An intern posted in the antenatal OPD auscultates a patient who came for her routine checkup. Presence of which of the following features would not suggest a physiological change of pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Loud S1 with splitting"
      },
      {
        "id": 2,
        "text": "Ejection systolic murmur at left sternal border"
      },
      {
        "id": 3,
        "text": "Continuous murmur at  2nd to 4th intercostal space"
      },
      {
        "id": 4,
        "text": "Late systolic murmur"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Late systolic murmur</strong> is pathological in pregnancy.</p>\n<p>CVS <strong>physiological</strong> changes in pregnancy:</p>\n<ul>\n<li>Pulse rate: Increases</li>\n<li><strong>Diastolic BP: Decreases</strong></li>\n<li><strong>S1: Loud and split</strong></li>\n<li>S2:Normal</li>\n<li>S3:prominent (occasional)</li>\n<li>Jugular venous distension and venous hum</li>\n<li>Murmurs\n<ul>\n<li><strong>Ejection systolic murmur</strong> at left sternal border.</li>\n<li><strong>Continous murmur</strong> at 2nd-4th intercostal space (known as mammary souffle)</li>\n</ul>\n</li>\n<li>Heart is displaced upwards and to the left</li>\n<li><strong>ECG changes</strong>\n<ul>\n<li>Left axis deviation (due to elevation of diaphragm)</li>\n<li>T wave inversion, biatrial enlargement</li>\n<li>Mild ST changes in the inferior leads</li>\n<li>Premature atrial and ventricular contractions are relatively frequent.</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not an absolute indication for therapeutic termination of pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Primary pulmonary hypertension"
      },
      {
        "id": 2,
        "text": "Eisenmenger's syndrome"
      },
      {
        "id": 3,
        "text": "Pulmonary venoocclusive disease"
      },
      {
        "id": 4,
        "text": "Prosthetic valve replacement"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Prosthetic valve replacement</strong> is not an indication for therapeutic termination as it comes&nbsp;under the <strong>WHO category risk 3.</strong>&nbsp;Only conditions included under <strong>WHO category risk 4</strong> are considered as indications for<strong> termination of pregnancy.</strong></p>\n<p>WHO class 4 comprises of diseases with very high risk of maternal mortality or severe morbidity, such as:</p>\n<ul>\n<li><strong>Pulmonary arterial hypertension</strong></li>\n<li>Severe systemic ventricular dysfunction (NYHA III-IV or LVEF 30-40%)</li>\n<li>Previous peripartum cardiomyopathy with any residual impairment of left ventricular function</li>\n<li>Severe left heart obstruction</li>\n<li>Marfan syndrome with aorta dilated &gt;40 mm</li>\n</ul>\n<p>Termination of pregnancy is also advised in patients with <strong>Eisenmenger syndrome.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A pregnant lady with heart failure planned for valve replacement surgery is posted for cesarean section. Which of the following is not a cardiac indication for cesarean delivery?",
    "choices": [
      {
        "id": 1,
        "text": "Coarctation of aorta"
      },
      {
        "id": 2,
        "text": "Aortic dissection"
      },
      {
        "id": 3,
        "text": "Recent myocardial infarction"
      },
      {
        "id": 4,
        "text": "Primary pulmonary hypertension"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Primary pulmonary hypertension</strong> is not a cardiac indication for caesarean delivery.</p>\n<p>In primary pulmonary hypertension, maternal mortality is about 50% and the majority die (75%) postpartum.</p>\n<p><strong>Simpson&rsquo;s criteria</strong> for cesarean delivery for cardiac disease in pregnancy:</p>\n<ul>\n<li>Dilated aortic root &gt;4 cm or aortic aneurysm</li>\n<li>Acute severe congestive heart failure</li>\n<li>Recent myocardial infarction</li>\n<li>Severe symptomatic aortic stenosis</li>\n<li>Warfarin administration within 2 weeks of delivery</li>\n<li>Need for emergency valve replacement immediately after delivery</li>\n</ul>\n<p>Coarctation of the aorta and aortic dissection are other indications for cesarean delivery.</p>\n<p>In general, <strong>vaginal delivery</strong> is preferred, and labor induction is usually safe. Cesarean delivery is limited to obstetric indications, and considerations are given for the specific cardiac&nbsp;lesions only. <strong>Epidural</strong> anesthesia is given during LSCS in heart disease. The major problem with epidural/spinal analgesia is <strong>maternal hypotension</strong>. This is especially dangerous in women with <strong>intracardiac shunts</strong> in whom flow may be reversed (blood passes from right to left and bypasses the lungs). So in case of a shunt lesion, only <strong>general anesthesia</strong> should be given.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are performing CPR on a woman who is 38-weeks pregnant. She was admitted to the emergency after a massive pulmonary embolism led to cardio-pulmonary arrest. Despite the initial management of airway, oxygenation and vasopressor support, there is no improvement. What is the cut off time  for perimortem cesarean delivery in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "1 minute"
      },
      {
        "id": 2,
        "text": "2 minutes"
      },
      {
        "id": 3,
        "text": "5 minutes"
      },
      {
        "id": 4,
        "text": "3 minutes"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Perimortem cesarean delivery</strong> should be considered if there is no return of spontaneous circulation in<strong> 5 minutes</strong>, according to the AHA 2020 Guidelines.&nbsp;</p>\n<p>The goal of <strong>perimortem cesarean section&nbsp;</strong>(PMCS) should be primarily aimed at saving the life of the mother. PMCS improves maternal survival by decreasing compression of the IVC by the gravid uterus. This improves venous return and diaphragmatic&nbsp;displacement, which in turn&nbsp;improves respiratory dynamics.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/050e165bee624c89ad3142f1391d0540x1279x2110.JPEG"
    ]
  },
  {
    "text": "A G2P1 patient with mitral valve prolapse goes into labor. Which of the following should not be done in the management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Cut short second stage of labour using ventouse"
      },
      {
        "id": 2,
        "text": "Fluid restriction"
      },
      {
        "id": 3,
        "text": "Antibiotic prophylaxis"
      },
      {
        "id": 4,
        "text": "Trendelenburg position during first stage of labor"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Lateral recumbent position&nbsp;</strong>is advised during the first stage of labor in this patient.</p>\n<p>Management of labor in patients with heart disease:</p>\n<p><strong>First stage:</strong></p>\n<ul>\n<li>Lateral recumbent or propped up position</li>\n<li>Oxygen administration (5 to 6 L/min)</li>\n<li>Analgesia by epidural</li>\n<li>Fluids should not be infused more than 75 ml/h</li>\n<li>Prophylactic antibiotics for bacterial endocarditis&nbsp;during labour and 48 h after delivery</li>\n<li>Central venous pressure monitoring</li>\n</ul>\n<p><strong>Second stage:</strong></p>\n<ul>\n<li><strong>No</strong> <strong>maternal pushing</strong></li>\n<li><strong>Cut short second stage by forceps or ventouse </strong>under pudendal and/or perineal block anaesthsia</li>\n<li>The benefit of avoiding haemodynamic fluctuations resulting from pushing must be weighed against an increased risk of perineal trauma, haemorrhage and fetal head injury with forceps or vacuum delivery.</li>\n</ul>\n<p><strong>Third stage:</strong></p>\n<ul>\n<li>Oxytocin by infusion</li>\n<li>IV frusemide if needed</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A pregnant woman with cardiac disease is on warfarin therapy. When will the final switch to heparin be advised?",
    "choices": [
      {
        "id": 1,
        "text": "At the onset of labour"
      },
      {
        "id": 2,
        "text": "34 weeks"
      },
      {
        "id": 3,
        "text": "36 weeks"
      },
      {
        "id": 4,
        "text": "40 weeks"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<table>\n<tbody>\n<tr>\n<td>Period of pregnancy</td>\n<td>Anticoagulation of choice</td>\n</tr>\n<tr>\n<td>First trimester</td>\n<td>\n<p>If dose of warfarin <strong>&lt; 5mg/day</strong>&ndash; <strong>continue warfarin till 36 weeks&nbsp;</strong></p>\n<p>If dose of <strong>warfarin &gt; 5mg</strong> /day or warfarin embryopathy present &ndash;<strong> replace it with heparin / LMWH</strong></p>\n</td>\n</tr>\n<tr>\n<td>From <strong>12 weeks to 36 weeks</strong></td>\n<td><strong>warfarin</strong></td>\n</tr>\n<tr>\n<td><strong>At 36 weeks</strong></td>\n<td>Switch to <strong>LMWH</strong></td>\n</tr>\n<tr>\n<td>1 week before EDD / 3 days before EDD</td>\n<td>Switch to <strong>UFH</strong> (as LMWH have longer T1/2&ndash; increased chances of PPH)</td>\n</tr>\n<tr>\n<td>On the day of delivery</td>\n<td>Stop all anticoagulant</td>\n</tr>\n<tr>\n<td>6 hrs after vaginal delivery / 6-12 hrs after cesarean&nbsp;&nbsp;</td>\n<td>Restart UFH and Warfarin. When INR is 2.5 to 3 withdraw UFH &amp; continue warfarin</td>\n</tr>\n</tbody>\n</table>\n<p>LMWH- low molecular weight heparin<br />UFH- Unfractionated heparin</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 28-year-old G2P1 was admitted to the labor room at 38 weeks of gestation. She is a known case of mitral valve prolapse.  Which of the following is the best for managing the second stage of labor in this patient ?",
    "choices": [
      {
        "id": 1,
        "text": "Unassisted vaginal delivery"
      },
      {
        "id": 2,
        "text": "Using ventouse delivery"
      },
      {
        "id": 3,
        "text": "Zavanelli maneuver"
      },
      {
        "id": 4,
        "text": "Emergency cesarean section"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The best technique for managing the second stage of labor in a patient with heart disease is <strong>using</strong> <strong>ventouse.</strong></p>\n<p>For most cardiac patients, <strong>vaginal delivery</strong> is preferred and cesarean section is reserved for obstetric indications since the cesarean section is associated with more blood loss and higher thromboembolic and infection risk.&nbsp;If vaginal delivery is selected as the mode of choice, it will be conducted with the laboring woman in an <strong>upright</strong> position, or in the <strong>left decubitus</strong> position. This minimizes aortocaval compression.</p>\n<p>Active pushing during the second stage may also be limited, depending on the degree of cardiac compromise. In moderate to severe cardiac disease, it may be prudent to completely avoid an active second stage. Regional anesthesia can be used to allow the fetal head to descend to the perineum without active pushing. Delivery can be further facilitated by <strong>forceps or vacuum extraction.&nbsp;</strong></p>\n<p>The benefit of avoiding hemodynamic fluctuations resulting from pushing must be weighed against an increased risk of perineal trauma, hemorrhage, and fetal head injury with forceps or vacuum delivery.</p>\n<p>Some journals report that ventouse is preferable to forceps,<strong>&nbsp;</strong>as it can be applied without putting the patient in lithotomy position (raising the legs increases the cardiac load) however it is <strong>controversial.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "General anesthesia is the preferable mode of analgesia in pregnant women with ______",
    "choices": [
      {
        "id": 1,
        "text": "Aortic stenosis"
      },
      {
        "id": 2,
        "text": "Prosthetic heart valves"
      },
      {
        "id": 3,
        "text": "MVP with MR"
      },
      {
        "id": 4,
        "text": "Intracardiac shunts"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In pregnant ladies with <strong>intracardiac shunts</strong>, general anesthesia is the preferable mode of analgesia.</p>\n<p>The major problem with epidural/spinal analgesia is <strong>maternal hypotension</strong>. This is especially dangerous in women with intracardiac shunts in whom <strong>flow may be reversed</strong> (blood passes from right to left and bypasses the lungs). So in case of a shunt lesion, only general anesthesia should be given.</p>\n<p><strong>Note</strong>: Aortic stenosis will also be affected by the hypotension caused by epidural/spinal analgesia. However, in aortic stenosis, slow epidural anesthesia is adequate and doesn't compromise ventricular preload. Only a few severe cases of aortic stenosis warrant GA. Hence, in the context of this MCQ, 'intracardiac shunts' would be the most appropriate answer.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A pregnant lady with mitral stenosis requires anticoagulation. Which of the following statements is false regarding her management?",
    "choices": [
      {
        "id": 1,
        "text": "LMWH or UFH is used until 13 weeks of pregnancy"
      },
      {
        "id": 2,
        "text": "From 13 weeks till close to delivery substitute UFH with warfarin"
      },
      {
        "id": 3,
        "text": "Following vaginal delivery, anticoagulation with LMWH or UFH is restarted after 6 hours"
      },
      {
        "id": 4,
        "text": "Warfarin is contraindicated during lactation"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Warfarin is not contraindicated during lactation.</p>\n<p><strong>Warfarin</strong>, low-molecular-weight heparin (LMWH),&nbsp;unfractionated heparin (UFH)<strong> do not accumulate in breast milk.</strong>&nbsp;They do not induce an anticoagulant effect in the infant.</p>\n<p>The choice of anticoagulants is the main problem in pregnancy due to the following reasons:</p>\n<ul>\n<li><strong>Warfarin:</strong> Although safe for the mother, can lead to warfarin<strong> embryopathy</strong>, miscarriage, IUGR, and stillbirths.</li>\n<li><strong>Heparin:</strong> It is <strong>safe</strong> for the fetus as it does not cross the placenta but <strong>less effective</strong> than warfarin.</li>\n<li><strong>LMWH</strong>: Inadequate and ACOG does not recommend its use in pregnant women with prosthetic heart valves.</li>\n</ul>\n<table class=\"t1\" style=\"width: 499.765625px;\" cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr>\n<td class=\"td1\" style=\"width: 262px; text-align: left;\" valign=\"top\">\n<p class=\"p1\"><strong>Period of gestation</strong></p>\n</td>\n<td class=\"td1\" style=\"width: 235.765625px; text-align: left;\" valign=\"top\">\n<p class=\"p1\"><strong>Anticoagulant</strong></p>\n</td>\n</tr>\n<tr>\n<td class=\"td1\" style=\"width: 262px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">Till 12 completed weeks</p>\n</td>\n<td class=\"td1\" style=\"width: 235.765625px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">LMWH or UFH</p>\n</td>\n</tr>\n<tr>\n<td class=\"td1\" style=\"width: 262px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">13 to 36 weeks</p>\n</td>\n<td class=\"td1\" style=\"width: 235.765625px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">Warfarin</p>\n</td>\n</tr>\n<tr>\n<td class=\"td1\" style=\"width: 262px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">36 weeks to 6 hours before delivery</p>\n</td>\n<td class=\"td1\" style=\"width: 235.765625px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">LMWH or UFH</p>\n</td>\n</tr>\n<tr>\n<td class=\"td1\" style=\"width: 262px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">6 hours after vaginal and 24 hours after cesarian section</p>\n</td>\n<td class=\"td1\" style=\"width: 235.765625px; text-align: left;\" valign=\"top\">\n<p class=\"p1\">LMWH or UFH (ACOG recommendation)</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>If the patient delivers when the anticoagulant is still effective and bleeds excessively, then <strong>protamine sulfate</strong> is given intravenously.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding hypertrophic cardiomyopathy in pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Most affected patients are asymptomatic during pregnancy"
      },
      {
        "id": 2,
        "text": "Diuretics are generally not used in this patient"
      },
      {
        "id": 3,
        "text": "She may develop chest pain, palpitations, and syncope"
      },
      {
        "id": 4,
        "text": "The most common cause for death is cardiac failure"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The most common cause of death in HOCM in pregnant women is <strong>ventricular tachyarrhythmias</strong>.</p>\n<p>Most affected women are <strong>asymptomatic</strong>, but some patients may develop:</p>\n<ul>\n<li>Dyspnea</li>\n<li>Anginal or atypical chest pain</li>\n<li>Syncope</li>\n<li>Arrhythmias.</li>\n</ul>\n<p>Strenuous exercise is prohibited during pregnancy.&nbsp;Abrupt positional changes are avoided to prevent reflex vasodilation and decrease of preload.&nbsp;<strong>Diuretics</strong> and vasodilators are<strong> generally not used&nbsp;</strong>as they decrease preload. If angina develops,<strong> beta-blockers </strong>or calcium channel blockers are used.</p>\n<p>The mode of delivery depends upon obstetric indications and if cesarean section is done,<strong> general anesthesia</strong> is considered the safest.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All are true regarding peripartum cardiomyopathy except _____",
    "choices": [
      {
        "id": 1,
        "text": "Development of cardiac failure within 5 months of delivery"
      },
      {
        "id": 2,
        "text": "Left ventricular diastolic dysfunction"
      },
      {
        "id": 3,
        "text": "Absence of identifiable cause"
      },
      {
        "id": 4,
        "text": "Dilated left ventricle"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Left ventricular <strong>systolic dysfunction</strong> is a feature of peripartum cardiomyopathy (also known as postpartum cardiomyopathy) and <strong>not diastolic dysfunction</strong>.</p>\n<p>Peripartum cardiomyopathy (PPCM) is a type of <strong>dilated</strong> cardiomyopathy. It develops during the&nbsp;<strong>last</strong> <strong>month</strong> of pregnancy or <strong>within</strong> the first <strong>5 months</strong> following delivery.&nbsp;</p>\n<p>The predisposing factors&nbsp;include&nbsp;<strong>Cardiac gene mutations</strong>&nbsp;involving several genes like&nbsp;TTNC1, TTN, and STAT3,&nbsp;<strong>Twin pregnancy/ multifetal gestation,&nbsp;</strong><strong>Smoking,</strong> and<strong>&nbsp;</strong><strong>Preeclampsia.&nbsp;</strong>Other proposed causes include viral myocarditis, abnormal immune response to pregnancy, malnutrition, inflammation, etc.</p>\n<p class=\"p1\">PPCM is associated with <strong>increased</strong>&nbsp;secretion of <strong>prolactin</strong>&nbsp;by the pituitary and antiangiogenic molecule&nbsp;<strong>sFlt-1</strong> (soluble fms-like tyrosine kinase) by the <strong>placenta</strong> at term gestation.</p>\n<p class=\"p1\"><strong>Pearson&rsquo;s diagnostic criteria</strong> for PPCM:</p>\n<ul>\n<li>Development of cardiac failure in the <strong>last month </strong>of pregnancy or within <strong>5 months after delivery</strong></li>\n<li>Absence of an identifiable cause for the cardiac failure</li>\n<li>Absence of recognizable heart disease prior to the last month of pregnancy, and</li>\n<li>Left ventricular systolic dysfunction demonstrated by&nbsp;<strong>echocardiographic criteria</strong>, such as ejection fraction &lt;45% or fractional shortening &lt;30% along with a dilated left ventricle.</li>\n</ul>\n<p>Management involves treating the features of heart failure.<strong> Bromocriptine</strong> has been found useful in this condition. Many women recover within 6 months of delivery, while some continue to have residual effects.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following agents has been proposed to be responsible for peripartum cardiomyopathy?",
    "choices": [
      {
        "id": 1,
        "text": "Estrogen"
      },
      {
        "id": 2,
        "text": "Progesterone"
      },
      {
        "id": 3,
        "text": "Beta hCG"
      },
      {
        "id": 4,
        "text": "Prolactin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Prolactin</strong> has been proposed to be responsible for peripartum cardiomyopathy.</p>\n<p>Oxidative stress during late pregnancy leads to the proteolytic cleavage of<strong> prolactin</strong>.&nbsp;The resulting 16-kDa prolactin fragment has been found to be cardiotoxic and can impair the metabolism and contractility of cardiomyocytes.</p>\n<p>The etiology of peripartum cardiomyopathy remains unknown. Many potential causes&nbsp;have been proposed but are not proven.</p>\n<ul>\n<li>Viral myocarditis</li>\n<li>Abnormal immune response to pregnancy</li>\n<li>Abnormal response to the increased hemodynamic burden of pregnancy</li>\n<li>Malnutrition</li>\n<li>Inflammation</li>\n<li>Apoptosis</li>\n<li>Prolactin</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A P1L1 lady presents with complaints of fatigue and paroxysmal nocturnal dyspnea 3 months after her delivery. On examination, she has pedal edema and echo shows left ventricular systolic dysfunction. Which of the following drugs has shown to be effective for the treatment of her condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ribavirin"
      },
      {
        "id": 2,
        "text": "Misoprostol"
      },
      {
        "id": 3,
        "text": "Danazol"
      },
      {
        "id": 4,
        "text": "Bromocriptine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given scenario is suggestive of <strong>peripartum cardiomyopathy</strong> and <strong>bromocriptine</strong> is effective for its treatment.</p>\n<p>Oxidative stress during late pregnancy leads to the proteolytic cleavage of prolactin.\u00a0The resulting 16-kDa prolactin fragment has been found to be <strong>cardiotoxic</strong> and can impair the metabolism and contractility of cardiomyocytes.\u00a0Based on this proposed mechanism, <strong>bromocriptine </strong>therapy has been suggested because it inhibits prolactin secretion.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 34-year-old lady came to the antenatal OPD with 6 weeks of amenorrhea. Her UPT is positive.  She is a known case of mitral stenosis for 5 years.  Which is the best time to do surgery for mitral stenosis in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "8\u201310 weeks"
      },
      {
        "id": 2,
        "text": "10\u201314 weeks"
      },
      {
        "id": 3,
        "text": "14\u201318 weeks"
      },
      {
        "id": 4,
        "text": "24\u201326 weeks"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The best time of surgery for mitral stenosis in pregnancy is between <strong>14\u201318 weeks</strong>.</p>\n<p><strong>Balloon valvuloplasty</strong> is the procedure of choice for mitral stenosis in pregnancy. Any\u00a0cardiac surgery in pregnancy\u00a0should usually be postponed until after delivery, but if required, it can be <strong>performed safely in </strong>the<strong>\u00a02<sup>nd</sup> trimester</strong>.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A lady with ventricular septal defect becomes pregnant. Which of the following is not a common complication that is expected to occur in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Congestive cardiac failure"
      },
      {
        "id": 2,
        "text": "Arrhythmia"
      },
      {
        "id": 3,
        "text": "Hypotension"
      },
      {
        "id": 4,
        "text": "Left ventricular dysfunction"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Hypertension</strong> is a common maternal complication of congenital cardiac disease in pregnancy.</p>\n<p>The common maternal complications in patients with congenital cardiac disease include:</p>\n<ul>\n<li>Congestive cardiac failure</li>\n<li>Pulmonary edema</li>\n<li>Arrhythmia</li>\n<li>Hypertension</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common arrhythmia encountered in pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Atrial fibrillation"
      },
      {
        "id": 2,
        "text": "Atrial flutter"
      },
      {
        "id": 3,
        "text": "PSVT"
      },
      {
        "id": 4,
        "text": "Bradyarrhythmia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most common arrhythmia seen in reproductive-aged women is <strong>paroxysmal supraventricular tachycardia</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Women with the highest risk of endocarditis in pregnancy are those with _____",
    "choices": [
      {
        "id": 1,
        "text": "1, 4 and 5"
      },
      {
        "id": 2,
        "text": "3 and 5"
      },
      {
        "id": 3,
        "text": "1 and 2"
      },
      {
        "id": 4,
        "text": "2, 3 and 4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Women at the highest risk for <strong>endocarditis </strong>are those with<strong> cyanotic cardiac disease</strong>&nbsp;and<strong> prosthetic valves.</strong></p>\n<p>The American heart association recommends prophylaxis for dental procedures with:</p>\n<ul>\n<li>Prosthetic valves</li>\n<li>Unrepaired cyanotic heart defects</li>\n<li>Valvulopathy after heart transplantation</li>\n</ul>\n<p>American College of Obstetricians and Gynecologists do not recommend endocarditis prophylaxis for either vaginal or cesarean delivery in the absence of pelvic infection.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is associated with the highest risk of maternal mortality during pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Coarctation of aorta"
      },
      {
        "id": 2,
        "text": "Mitral stenosis"
      },
      {
        "id": 3,
        "text": "Eisenmenger syndrome"
      },
      {
        "id": 4,
        "text": "Aortic stenosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Eisenmenger syndrome</strong>&nbsp;is the heart disease with the&nbsp;<strong>worst prognosis,</strong>&nbsp;having a maternal mortality rate of 50%.</p>\n<p>The most common cause of death in Eisenmenger&rsquo;s syndrome is<strong> right ventricular failure with cardiogenic shock</strong>. If antenatal diagnosis of Eisenmenger syndrome is made in the first trimester, termination of pregnancy is advised.&nbsp;Eisenmenger syndrome has the highest risk of maternal mortality. However, since <strong>mitral stenosis</strong> is the most common cardiac condition in pregnancy, it is the most common cause of maternal mortality overall.&nbsp;</p>\n<p>Mitral regurgitation, mitral valve prolapse and pulmonary stenosis are well tolerated during pregnancy. Severe aortic stenosis can be life-threatening. However, women with mild to moderate aortic valve stenosis&nbsp;may have a relatively low-risk pregnancy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 32-year-old primigravida delivered a full-term male baby by vaginal delivery.  She is a known case of rheumatic mitral stenosis for 4 years. After the delivery of the placenta, she started to bleed profusely.  Which among the following should not be used to control bleeding?",
    "choices": [
      {
        "id": 1,
        "text": "Methyl ergometrine"
      },
      {
        "id": 2,
        "text": "Carboprost"
      },
      {
        "id": 3,
        "text": "Misoprostol"
      },
      {
        "id": 4,
        "text": "Oxytocin"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given scenario indicates <strong>postpartum hemorrhage </strong>(PPH) in a primigravida with rheumatic mitral stenosis.&nbsp;<strong>Methyl ergometrine is contraindicated</strong> in patients with organic heart disease.</p>\n<p><strong>Contraindications </strong>of methyl ergometrine are<strong>:</strong></p>\n<ul>\n<li><strong>Twin pregnancy -</strong>&nbsp;Second baby gets compromised by tetanic contractions of uterus if given after delivery of first baby</li>\n<li><strong>Organic cardiac disease -</strong>&nbsp;Causes overloading of right heart by squeezing blood from uterine circulation.</li>\n<li><strong>Severe pre-eclampsia</strong> and <strong>eclampsia</strong></li>\n<li><strong>Rh negative mother -&nbsp;</strong>&nbsp;Increases chance of fetomaternal transfusion.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '27 Cardiovascular Conditions In Pregnancy';
        const quizFilename = '27-cardiovascular-conditions-in-pregnancy-578b728b.html';
        let hierarchy = ["Marrow", "qBank", "Obstetrics & Gynecology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>