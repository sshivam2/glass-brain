<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>31 Uro-Gynecology - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Obstetrics & Gynecology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A woman with urinary incontinence was diagnosed to have a vesicovaginal fistula. What is the most common cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Congenital"
      },
      {
        "id": 2,
        "text": "Acquired"
      },
      {
        "id": 3,
        "text": "Idiopathic"
      },
      {
        "id": 4,
        "text": "Infectious"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Vesicovaginal fistulas </strong>are&nbsp;mostly <strong>acquired.&nbsp;</strong></p>\n<p>In developing countries, the most common cause is&nbsp;<strong>obstetric trauma</strong>.&nbsp;In developed countries,&nbsp;<strong>iatrogenic injury</strong>&nbsp;during pelvic surgery is responsible for 90% of the vesicovaginal fistulas.&nbsp;</p>\n<p><strong>Congenital</strong>&nbsp;genitourinary fistulas and fistulas resulting from<strong> infectious</strong> conditions are&nbsp;<strong>rare.&nbsp;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following types of genitourinary fistulas has not been reported?",
    "choices": [
      {
        "id": 1,
        "text": "Ureterovaginal"
      },
      {
        "id": 2,
        "text": "Vesicouterine"
      },
      {
        "id": 3,
        "text": "Uterourethral"
      },
      {
        "id": 4,
        "text": "Urethrocervical"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Uterourethral type of fistula has not been reported.</p>\n<div class=\"page\" title=\"Page 604\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>A <strong>genitourinary fistula</strong> is defined as an abnormal communication between the urinary system (ureter, bladder, urethra) and the genital systems (vagina, cervix, uterus).</p>\n<div class=\"page\" title=\"Page 605\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Most genitourinary fistulas are <strong>acquired. </strong>In <strong>developing countries</strong>, the most common cause is&nbsp;<strong>obstetric trauma</strong>.&nbsp;In <strong>developed countries</strong>, <strong>iatrogenic injury</strong> during pelvic surgery is responsible for 90% of the vesicovaginal fistulas.&nbsp;</p>\n<p><strong>Congenital</strong>&nbsp;genitourinary fistulas are <strong>rare. </strong>If present, they are commonly&nbsp;associated with&nbsp;other renal or urogenital abnormalities.</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following does not cause genitourinary fistulas?",
    "choices": [
      {
        "id": 1,
        "text": "Hysterectomy"
      },
      {
        "id": 2,
        "text": "Radiotherapy"
      },
      {
        "id": 3,
        "text": "Prolonged obstructed labour"
      },
      {
        "id": 4,
        "text": "Hysteroscopy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Hysteroscopy is not an etiology for <strong>genitourinary fistulae</strong>. It can occur following <strong>hysterectomy</strong>.&nbsp;</p>\n<p>Most genitourinary fistulas are&nbsp;<strong>acquired. </strong>Its&nbsp;causes are enumerated below:</p>\n<ul>\n<li>Prolonged<strong> obstructed labor</strong> -&nbsp;major cause in developing countries</li>\n<li>Difficult instrumental or manipulative deliveries</li>\n<li>Injury to bladder or ureter during hysterectomy -&nbsp;major cause in developed contries</li>\n<li>Congenital (rare)</li>\n<li>Other causes include:\n<ul>\n<li><strong>Radiation</strong></li>\n<li>Malignancy</li>\n<li>Trauma&nbsp;</li>\n<li>Infections - PID, tuberculosis etc.&nbsp;</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A P1L1 woman presents with constant dribbling of urine. She gives a history of unattended vaginal delivery following a difficult and prolonged labor 3 months back. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Ureterovaginal fistula"
      },
      {
        "id": 2,
        "text": "Vesicouterine fistula"
      },
      {
        "id": 3,
        "text": "Vesicovaginal fistula"
      },
      {
        "id": 4,
        "text": "Urethrovaginal fistula"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given case scenario is suggestive of a <strong>vesicovaginal fistula.</strong></p>\n<p>Vesicovaginal fistulas usually present with:</p>\n<ul>\n<li><strong>Constant dribbling</strong> of urine from the vagina</li>\n<li>Excoriation in the groin region due to constant leakage of urine</li>\n<li>History of pelvic surgery, <strong>vaginal delivery</strong> or <strong>prolonged labor</strong></li>\n<li>Amenorrhea may be present</li>\n</ul>\n<p>On examination, the fistula may be visualized by observing urine collection in the vagina. Bimanual examination reveals its fixity and extent.</p>\n<p>Note: <strong>Ureterovaginal</strong> fistulas usually occur following accidental ureteric injury during<strong> C-sections</strong> in <strong>developing countries</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most useful test in vesicovaginal fistula?",
    "choices": [
      {
        "id": 1,
        "text": "Cystoscopy"
      },
      {
        "id": 2,
        "text": "3 swab test"
      },
      {
        "id": 3,
        "text": "MRI"
      },
      {
        "id": 4,
        "text": "Cystometry"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option C: <strong>MRI</strong> is usually not needed for the diagnosis of VVF. They can be used to study <strong>vesicouterine fistulas</strong>.</p>\n<p>Option D: <strong>Cystometry</strong> is done to measure the capacity of the bladder. It is used to investigate <strong>urge incontinence</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/62d20aefbac94edeb295d66f846d17ccx1280x1082.JPEG"
    ]
  },
  {
    "text": "A patient comes with a complaint of dribbling of urine from the vagina during micturition. She has a history of obstructed labor. Methylene blue 3 swab test is done, and the lowest swab gets stained. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Ureterovaginal fistula"
      },
      {
        "id": 2,
        "text": "Vesicovaginal fistula"
      },
      {
        "id": 3,
        "text": "Urethrovaginal fistula"
      },
      {
        "id": 4,
        "text": "Vesicouterine fistula"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of a&nbsp;<strong>u</strong><strong>rethrovaginal fistula.</strong></p>\n<p>Urethrovaginal fistulas have the following clinical features:</p>\n<ul>\n<li><strong>Continent</strong> and dry at rest</li>\n<li>Urinary <strong>dribbling</strong> <strong>during</strong> <strong>micturition</strong></li>\n<li>Fistulous opening is seen on per speculum examination</li>\n</ul>\n<p>In the methylene blue 3-swab test, a catheter is introduced into the bladder through the urethra. The vaginal cavity is packed with three sterile cotton swabs. One at the vault, one at the middle, and one just above the introitus. 50&ndash;100 mL of dilute methylene blue dye is injected into the bladder using a catheter.</p>\n<p>Interpretation:</p>\n<ul>\n<li>The<strong>&nbsp;uppermost</strong>&nbsp;swab gets wet and not stained - the leak is from the ureter, seen in&nbsp;<strong>u</strong><strong>reterovaginal</strong>&nbsp;fistula</li>\n<li><strong>Middle</strong>&nbsp;swab gets stained - the leak is from the bladder, seen in&nbsp;<strong>v</strong><strong>esicovaginal</strong>&nbsp;fistula</li>\n<li>The<strong>&nbsp;lowermost</strong>&nbsp;swab gets stained- the leak is from the urethra,&nbsp;seen in&nbsp;<strong>u</strong><strong>rethrovaginal</strong>&nbsp;fistula</li>\n</ul>\n<p>The given image shows the 3-swab test.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dcfec068a7fd4df2a2ae3bfcb6d13b75x1279x966.JPEG"
    ]
  },
  {
    "text": "A 40-year-old woman with a history of colporrhaphy is diagnosed with a vesicovaginal fistula. Which of the following investigations is not preferred in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Urine culture"
      },
      {
        "id": 2,
        "text": "Ultrasound abdomen"
      },
      {
        "id": 3,
        "text": "Cystoscopy"
      },
      {
        "id": 4,
        "text": "MRI"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>MRI is not preferred for a case of vesicovaginal fistula as other investigations are more specific and useful.</p>\n<p><strong>Investigations in VVF</strong> include:</p>\n<ul>\n<li><strong>Urine</strong> <strong>culture</strong> - to treat concurrent UTI.</li>\n<li><strong>Ultrasound</strong> <strong>abdomen</strong> - kidney, bladder and ureter should be observed for the presence of a urinoma or hydronephrosis.</li>\n<li><strong>Intravenous pyelography</strong> - to look for hydronephrosis</li>\n<li><strong>Cystoscopy</strong>&nbsp;- used to visualise the number of fistulae and their location.</li>\n</ul>\n<p>Methylene blue&nbsp;<strong>3-swab test </strong>in <strong>urinary fistulae</strong>&nbsp;-&nbsp;A catheter is introduced into the bladder through the urethra and 50-100ml methylene blue is injected. The vaginal cavity is packed with three sterile cotton swabs. It is interpreted as follows:</p>\n<ul>\n<li>The<strong>&nbsp;uppermost</strong>&nbsp;swab gets wet and not stained - the leak is from the ureter, seen in&nbsp;<strong>u</strong><strong>reterovaginal</strong>&nbsp;fistula.</li>\n<li><strong>Middle</strong>&nbsp;swab gets stained - the leak is from the bladder, seen in&nbsp;<strong>v</strong><strong>esicovaginal</strong>&nbsp;fistula.</li>\n<li>The<strong>&nbsp;lowermost</strong>&nbsp;swab gets stained- the leak is from the urethra,&nbsp;seen in&nbsp;<strong>u</strong><strong>rethrovaginal</strong>&nbsp;fistula.</li>\n</ul>\n<p>The given image shows the methylene blue 3-swab test.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6d7bd34a77b547cf9ed3b33bf75b2a9bx1279x966.JPEG"
    ]
  },
  {
    "text": "A 40-year-old woman came for a follow-up visit one week following a vaginal hysterectomy. You note she has developed a large vesicovaginal fistula. What is the best time for fistula repair in this case?",
    "choices": [
      {
        "id": 1,
        "text": "Immediately"
      },
      {
        "id": 2,
        "text": "After 3 weeks"
      },
      {
        "id": 3,
        "text": "After 6 weeks"
      },
      {
        "id": 4,
        "text": "After 3 months"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the given scenario,&nbsp;the best time to perform <strong>fistula repair</strong> is <strong>6 weeks</strong>&nbsp;<strong>after</strong> the inciting <strong>surgery.</strong></p>\n<p>In <strong>uncomplicated fistulas,</strong>&nbsp;early surgical<strong> intervention</strong>&nbsp;is preferred <strong>within</strong> the first <strong>24 to 48 hours</strong> following the inciting surgery.&nbsp;This avoids the brisk postoperative inflammatory response.</p>\n<p>However, if <strong>extensive</strong> and severe <strong>inflammation</strong> is present, <strong>repair</strong> of fistula can be delayed to <strong>6 weeks</strong> <strong>after the surgery</strong>. This is usually done in a patient who has undergone major surgery,</p>\n<p>During this delay it is ensured that all the tissue inflammation has subsided, tissue vascularisation has improved and local infection has cleared. <strong>Estrogen therapy</strong> should be instituted in <strong>postmenopausal women</strong> in this time period.&nbsp;</p>\n<p>In case the fistula repair fails, a&nbsp;<strong>second attempt</strong>&nbsp;is made only&nbsp;<strong>after 3 months.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 34-year-old woman presents to the OPD with complaints of blood in her urine. She informs you that this happens every month for 1 week and stops on its own. She underwent a C-section 1 year ago and has no history of incontinence. During clinical examination, a catheter is inserted into the bladder, and the following finding is seen. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Urethrouterine fistula"
      },
      {
        "id": 2,
        "text": "Vesicouterine fistula"
      },
      {
        "id": 3,
        "text": "Vesicovaginal fistula"
      },
      {
        "id": 4,
        "text": "Ureterovaginal fistula"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows the <strong>catheter emerging</strong> from the <strong>cervical os</strong>. This, along with the history of <strong>cyclical hematuria</strong>, is suggestive of <strong>Youssef syndrome</strong> seen in a case of&nbsp;<strong>vesicouterine fistula.</strong></p>\n<p>Vesicouterine fistulas can develop after <strong>cesarean section,</strong> uterine rupture, and placenta accreta. Most cases <strong>present</strong> weeks to <strong>years later.</strong></p>\n<p>Vesicouterine fistulas can present with cyclical hematuria, urinary incontinence or complete continence, menstrual abnormalities, and urinary tract infections. <strong>Youssef syndrome</strong> is seen in cases of vesicouterine fistulas, and it is associated with a <strong>classic triad</strong>:</p>\n<ul>\n<li><strong>Amenorrhea</strong></li>\n<li>Cyclical hematuria - also called <strong>menouria:&nbsp;</strong>Menstrual blood trickles into the bladder through the fistula, causing hematuria</li>\n<li>Urinary <strong>continence</strong>&nbsp;(there is no vaginal leakage of urine)</li>\n</ul>\n<p><strong>Hysteroscopy</strong> and <strong>cystoscopy</strong> are gold-standard investigations.&nbsp;</p>\n<p>Vesicouterine fistulas are treated as follows:&nbsp;</p>\n<div class=\"page\" title=\"Page 237\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li><strong>Prolonged bladder</strong> <strong>catheterization</strong> - leads to spontaneous closure</li>\n<li><strong>Surgical repair</strong> via abdominal route</li>\n</ul>\n<p>&nbsp;</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/806ebeb62ca148db9b0c5928c4c6556e.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Intravenous pyelography in a patient suspected to have a genitourinary fistula revealed a ureteric fistula. Which of the following is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is mostly caused by gynecological surgeries"
      },
      {
        "id": 2,
        "text": "Continuous dribbling of urine occurs, but the patient can also micturate"
      },
      {
        "id": 3,
        "text": "In 3-swab test, the swab is stained blue"
      },
      {
        "id": 4,
        "text": "Hydronephrosis is present on the affected side"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Swabs stained</strong> with methylene blue are obtained in a <strong>bladder fistula</strong> and&nbsp;not in a ureteric fistula.</p>\n<p><strong>Ureteric fistulas</strong> can present with the following<strong> features</strong>:</p>\n<ul>\n<li>Constant urinary dribbling</li>\n<li>Flank pain or loin tenderness</li>\n<li>Renal angle tenderness</li>\n<li>Fever</li>\n<li>Hematuria&nbsp;</li>\n<li>Oliguria</li>\n</ul>\n<p>Ureteric fistulas are most commonly caused by<strong> iatrogenic trauma</strong> during pelvic surgeries, especially <strong>gynecological surgeries.</strong> An excretory urogram (<strong>intravenous pyelography</strong>) or a CT urogram are the <strong>investigations of choice</strong>. Hydronephrosis may be present on the affected side.</p>\n<p>It is managed by performing a&nbsp;<strong>ureteroneocystostomy</strong> and <strong>percutaneous</strong> <strong>nephrostomy.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You need to locate the ureter while performing an abdominal hysterectomy. Which of the following features will help you identify it?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2, 5"
      },
      {
        "id": 2,
        "text": "1, 2, 3"
      },
      {
        "id": 3,
        "text": "2, 3, 4"
      },
      {
        "id": 4,
        "text": "2, 3, 5"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>ureter</strong> is <strong>identified</strong> intraoperatively by the following features:</p>\n<ul>\n<li><strong>Ovarian artery</strong> crosses <strong>anterior</strong> to it</li>\n<li>It is <strong>cord-like</strong> on palpation</li>\n<li><strong>Peristalsis</strong> occurs on palpation</li>\n<li>It has a <strong>pale, glistening</strong> appearance&nbsp;</li>\n<li><strong>Uterine artery crosses</strong> it, from lateral to medial, 2 cm <strong>lateral to</strong> the <strong>cervix</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bbb31a9da7904a629013a5fe77416698x1280x1298.JPEG"
    ]
  },
  {
    "text": "During post-op rounds, you note one of the patients has developed fever and flank pain. The nurses inform you that her abdominal drain outputs have been consistently high. Which of the following procedures has the highest incidence of the complication suspected here?",
    "choices": [
      {
        "id": 1,
        "text": "Vaginal hysterectomy"
      },
      {
        "id": 2,
        "text": "Wertheim\u2019s hysterectomy"
      },
      {
        "id": 3,
        "text": "Abdominal hysterectomy"
      },
      {
        "id": 4,
        "text": "Emergency cesarean section"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The<strong>\u00a0</strong>given case scenario is suggestive of <strong>ureteric injury</strong>. The highest incidence of this complication is seen with\u00a0<strong>Wertheim\u2019s hysterectomy</strong>.</p>\n<p class=\"headingAnchor\">Urinary tract injury occurs almost exclusively in major gynecologic surgery that involves surgical dissection in proximity to the ureters or bladder.\u00a0<strong>Vaginal hysterectomy</strong> tends to have <strong>lower rates</strong> of ureteric injuries <strong>than open</strong> (abdominal, Wertheim)\u00a0or <strong>laparoscopic</strong> routes.\u00a0The highest risk for\u00a0ureteric injury is associated with the following procedures:</p>\n<ul>\n<li class=\"headingAnchor\">Surgical debulking of gynecological cancers</li>\n<li class=\"headingAnchor\">Advanced pelvic reconstructive surgery</li>\n<li class=\"headingAnchor\">Laparoscopic hysterectomy</li>\n</ul>\n<p>Patients with ureteric injuries have a complicated post-operative period. They can present with the following features:</p>\n<ul>\n<li><strong>Fever</strong></li>\n<li><strong>Flank pain</strong></li>\n<li>Abdominal distension</li>\n<li>Prolonged paralytic ileus - bowel sounds are absent</li>\n<li><strong>High drain outputs</strong>, in case abdominal drains are placed.</li>\n</ul>\n<p><strong>CT urogram</strong> and <strong>retrograde pyelography</strong> are the <strong>investigations of choice</strong>. They reveal urinary extravasation from the ureter. Ureteric injuries are prevented by careful division of tissue planes during pelvic or genitourinary surgeries. The condition is <strong>managed</strong> by prompt surgical repair by <strong>ureteroureterostomy</strong> or <strong>percutaneous ureterostomy</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with uterine fibroids is set to undergo a hysterectomy. While obtaining informed consent for the procedure, you counsel her about the potential risk of ureteric injury. Which of the following sites is the injury least likely to occur at?",
    "choices": [
      {
        "id": 1,
        "text": "Infundibulopelvic ligament"
      },
      {
        "id": 2,
        "text": "Ureteric canal"
      },
      {
        "id": 3,
        "text": "Uterosacral ligament"
      },
      {
        "id": 4,
        "text": "Ureteropelvic junction"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Iatrogenic</strong> <strong>injury</strong> to the ureter&nbsp;is<strong> unlikely</strong> to occur <strong>at the ureteropelvic junction</strong> during gynaecological surgeries&nbsp;like a hysterectomy.<strong>&nbsp;</strong></p>\n<p>Ureteric injury is most commonly caused <strong>by</strong> <strong>gynecological surgeries</strong> such as laparoscopic hysterectomy, abdominal hysterectomy, etc.&nbsp; It&nbsp;can occur at:</p>\n<ul>\n<li>The <strong>infundibulopelvic ligament</strong> on the lateral pelvic wall</li>\n<li>In the <strong>ureteric canal</strong> when the uterine vessels are ligated</li>\n<li>Near the internal cervical os&nbsp;</li>\n<li>Near the <strong>uterosacral ligament</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of rectovaginal fistula?",
    "choices": [
      {
        "id": 1,
        "text": "Improper suturing of perineal tears"
      },
      {
        "id": 2,
        "text": "Tuberculosis of the anus"
      },
      {
        "id": 3,
        "text": "Carcinoma cervix"
      },
      {
        "id": 4,
        "text": "Radiotherapy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Improper suturing</strong> of complete perineal tears is the most common cause of <strong>rectovaginal fistula.</strong></p>\n<p>Rectovaginal fistulas occur most commonly due to&nbsp;<strong>obstetric causes</strong>&nbsp;such as perineal tears, obstructed labor, and instrumental deliveries. Other causes include:</p>\n<ul>\n<li><strong>Tuberculosis</strong></li>\n<li>Lymphogranuloma venerum</li>\n<li>Bartholinitis - rupture of an abscess into the rectum can cause a fistula</li>\n<li>Diverticulitis&nbsp;</li>\n<li><strong>Carcinoma cervix</strong></li>\n<li><strong>Radiotherapy</strong> - can cause ulceration which can develop into a fistula</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a prerequisite for maintaining female urinary continence?",
    "choices": [
      {
        "id": 1,
        "text": "Normal urethral closure pressure more than 20 cm of water"
      },
      {
        "id": 2,
        "text": "Urethrovesical angle > 100"
      },
      {
        "id": 3,
        "text": "Internal urinary sphincter must lie above levator ani"
      },
      {
        "id": 4,
        "text": "Innervation of internal sphincter by Onuf's nucleus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>external urinary sphincter</strong> is innervated by the <strong>Onuf's nucleus</strong>, but not the internal one.</p>\n<p>The following factors are <strong>prerequisites for continence in women:</strong></p>\n<ul>\n<li>Position of internal urinary sphincter lies above levator ani muscles</li>\n<li>Normal urethral closure pressure is &gt;20 cm of water</li>\n<li>Urethrovesical angle &gt;100</li>\n<li>The tone of pelvic floor muscles</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly woman presented with a mass per vaginum and incontinence. She complains that she has to push the mass inwards to be able to urinate normally. What is the type of incontinence seen here?",
    "choices": [
      {
        "id": 1,
        "text": "Urge incontinence"
      },
      {
        "id": 2,
        "text": "Stress incontinence"
      },
      {
        "id": 3,
        "text": "Overflow incontinence"
      },
      {
        "id": 4,
        "text": "Neurogenic bladder"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given case scenario is suggestive of a <strong>cystocele</strong> in a case of <strong>genital prolapse</strong>. <strong>Stress incontinence</strong> is seen in these cases.</p>\n<p>In stress incontinence,&nbsp;involuntary leakage of urine occurs when there is increased intraabdominal pressure, such as during<strong>&nbsp;</strong>laughing, sneezing, or coughing. There is no normal urge to pass urine.</p>\n<p>Option A:&nbsp;<strong>Urge incontinence</strong> is the <strong>involuntary voiding</strong> of urine when there is an <strong>imminent</strong> <strong>urge</strong> to urinate.</p>\n<p>Option C:&nbsp;<strong>Overflow incontinence</strong> is an old term that refers to the inability to empty the bladder, with involuntary, continuous <strong>urinary dribbling</strong>. Currently, it refers to another presentation of urge incontinence.&nbsp;</p>\n<p>Option D: <strong>Neurogenic bladder</strong> occurs due to <strong>defects</strong> anywhere in the pathway of the <strong>micturition reflex</strong>, e.g., spinal cord trauma, diabetes etc. It presents with with urgency or urge incontinence.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A gynecologist performs a Marshall and Bonney test in the OPD on an elderly woman. Which of the following conditions is this used to diagnose?",
    "choices": [
      {
        "id": 1,
        "text": "Vesicovaginal fistula"
      },
      {
        "id": 2,
        "text": "Genuine stress incontinence"
      },
      {
        "id": 3,
        "text": "Prolapse"
      },
      {
        "id": 4,
        "text": "Rectovaginal fistula"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Marshall and Bonney's test</strong> is used to diagnose <strong>genuine stress incontinence.</strong>&nbsp;It also helps in assessing how successful a surgical repair will be.</p>\n<p>It is performed as follows:</p>\n<table style=\"height: 116px; width: 515px;\">\n<tbody>\n<tr>\n<td style=\"width: 187.598px; text-align: center;\"><strong>Test</strong></td>\n<td style=\"width: 310.402px; text-align: center;\"><strong>Marshall test</strong></td>\n<td style=\"width: 249px; text-align: center;\"><strong>Bonney's test</strong></td>\n</tr>\n<tr>\n<td style=\"width: 187.598px;\">Procedure</td>\n<td style=\"width: 310.402px;\">The vagina in the region of the bladder neck is infiltrated with local anesthetic and it is elevated.</td>\n<td style=\"width: 249px;\">Two fingers are placed in the vagina at the urethrovesical junction and the bladder neck is elevated.</td>\n</tr>\n<tr>\n<td style=\"width: 187.598px;\">Positive test</td>\n<td style=\"width: 310.402px;\">Absence of leakage of urine on straining or coughing</td>\n<td style=\"width: 249px;\">Absence of leakage of urine on straining or coughing</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A wrestler in the post-partum period complains of spurting of urine during weight-lifting practice. Which of the following investigations will help aid your diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Q-tip test"
      },
      {
        "id": 2,
        "text": "Methylene blue 3 swab test"
      },
      {
        "id": 3,
        "text": "Intravenous pyelography"
      },
      {
        "id": 4,
        "text": "Transvaginal ultrasound"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given case scenario&nbsp;is suggestive of&nbsp;<strong>stress incontinence</strong>. It can be diagnosed with the help of the&nbsp;<strong>Q-tip test</strong>.</p>\n<p>This test is performed by placing a<strong>&nbsp;xylocaine-covered Q-tip</strong> cotton swab stick <strong>in</strong> the <strong>patient's urethra</strong>.&nbsp;Initially, the stick will be parallel to the floor. Then the patient&nbsp;is asked to strain or cough.&nbsp;<strong>Normally</strong> the stick will reach an<strong> angle</strong> of around <strong>10-15&deg;</strong>.</p>\n<p>In genuine stress incontinence (<strong>GSI</strong>), this <strong>angle increases</strong> by <strong>20&deg;</strong> or more<strong>.&nbsp;</strong>A <strong>positive test</strong> indicates a sufficient degree of <strong>bladder neck descent</strong>. Unfortunately, all patients with GSI may not have a positive test, and it is not specific.</p>\n<p><strong>Tests done for GSI</strong>(Genuine stress incontinence) include:</p>\n<ol>\n<li>Stress test</li>\n<li>Cotton swab&nbsp;stick test</li>\n<li>Marshall and Bonney test</li>\n<li>Urethroscopy</li>\n<li>Urodynamic evaluation- cystometry, urethrocystometry, uroflowmetry etc</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young mother presented with dribbling of urine on coughing or sneezing. Marshall and Bonney's test was positive. What is the next step in management?",
    "choices": [
      {
        "id": 1,
        "text": "Conservative management"
      },
      {
        "id": 2,
        "text": "Venlafaxine therapy"
      },
      {
        "id": 3,
        "text": "Burch colposuspension"
      },
      {
        "id": 4,
        "text": "Marshall\u2013Marchetti\u2013Krantz operation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given scenario is suggestive of<strong> stress incontinence</strong>. In this case, the <strong>first line</strong> of treatment is <strong>conservative management.</strong></p>\n<p>Stress incontinence is managed as follows:</p>\n<p><strong>Conservative</strong> management:</p>\n<ul>\n<li>It is the first line of treatment.</li>\n<li>It includes:\n<ul>\n<li><strong>Kegel </strong>pelvic floor exercises for 4&ndash;6 months</li>\n<li><strong>Electric/magnetic stimulation</strong> for nerve damage, magnetic stimulation</li>\n<li><strong>Artificial</strong> urinary <strong>sphincter</strong> in neurological condition</li>\n<li>Vaginal cones</li>\n</ul>\n</li>\n<li>It is also done in case surgery fails.&nbsp;</li>\n</ul>\n<p><strong>Medical&nbsp;</strong>management:</p>\n<ul>\n<li>Estrogen cream in menopausal woman</li>\n<li><strong>Venlafaxine</strong> 75 mg daily</li>\n<li>Imipramine 10&ndash;20 mg BD</li>\n</ul>\n<p><strong>Surgical</strong> management:</p>\n<ul>\n<li>Kelly's repair - vaginal approach</li>\n<li><strong>Marshall&ndash;Marchetti&ndash;Krantz</strong> operation - abdominal approach. It not done anymore as it causes osteitis of the pubis.</li>\n<li><strong>Burch colposuspension</strong></li>\n<li>Combined vaginal and abdominal suspension - Pereyra operation</li>\n<li>Slings\n<ul>\n<li>Tension-free vaginal taping</li>\n<li>Transobturator taping</li>\n</ul>\n</li>\n<li>Laparoscopic suspension of the bladder neck</li>\n<li>Periurethral collagen injection&nbsp;</li>\n</ul>\n<p><strong>Vaginal sling</strong>&nbsp;operations have the&nbsp;<strong>highest long term cure rate</strong>&nbsp;in cases of GSI (genuine stress incontinence). Their long term cure rate is&nbsp;<strong>more than 90%.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 24-year-old primiparous woman with Grade 2 genuine stress incontinence did not respond to conservative management. Which of the following surgeries will not be beneficial for her condition?",
    "choices": [
      {
        "id": 1,
        "text": "Pereyra operation"
      },
      {
        "id": 2,
        "text": "Tension-free vaginal taping"
      },
      {
        "id": 3,
        "text": "Burch colposuspension"
      },
      {
        "id": 4,
        "text": "Latzko procedure"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Latzko procedure</strong> is not beneficial for a patient with genuine stress incontinence as it is done for <strong>vesicovaginal fistula</strong>.</p>\n<p>The various<strong> surgeries done for genuine stress incontinence</strong> (GSI) are as follows:</p>\n<ul>\n<li>Vaginal approach\n<ul>\n<li>Kelly repair</li>\n<li>Pacey repair</li>\n</ul>\n</li>\n<li>Marshall-Marchetti-Krantz&nbsp;operation - abdominal approach. It is not done anymore as it causes osteitis of the pubis.</li>\n<li><strong>Burch colposuspension</strong></li>\n<li>Combined vaginal and abdominal suspension - <strong>Pereyra</strong> operation</li>\n<li>Slings\n<ul>\n<li><strong>Tension-free vaginal taping</strong></li>\n<li>Transobturator taping</li>\n</ul>\n</li>\n<li>Laparoscopic suspension of the bladder neck</li>\n<li>Periurethral collagen injection</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 62-year-old woman presented with complaints of urinary urgency followed by involuntary escape of urine. What is the etiology of the condition she's likely suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Pelvic mass in pouch of Douglas"
      },
      {
        "id": 2,
        "text": "Prolapse of anterior vaginal wall"
      },
      {
        "id": 3,
        "text": "Detrusor instability"
      },
      {
        "id": 4,
        "text": "Retroverted gravid uterus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given case scenario is suggestive of<strong> urge incontinence</strong>. It occurs due to&nbsp;<strong>detrusor instability</strong>.</p>\n<p>During normal micturition, the detrusor muscle contracts after being stimulated by the parasympathetic nerves. In detrusor instability,&nbsp;<strong>detrusor</strong> muscle <strong>contracts spontaneously</strong> or on provocation <strong>during filling</strong> of the bladder. It is often caused by <strong>overactivity</strong> of<strong> parasympathetic</strong> nerves. It is usually seen in older women and is caused by:</p>\n<ul>\n<li>Decreased bladder capacity&nbsp;- due to fibrosis</li>\n<li>Decreased sensation&nbsp;</li>\n<li>Central nervous system&nbsp;(CNS)&nbsp;inhibition&nbsp;- due to stroke, multiple sclerosis, spinal cord involvement etc.</li>\n</ul>\n<p>It is associated with the following symptoms:&nbsp;</p>\n<ul>\n<li>Incontinence</li>\n<li>Urge to urinate&nbsp;</li>\n<li>Increased frequency</li>\n<li>Nocturia&nbsp;</li>\n<li>Urination during sexual intercourse and with the sound of water, hand-washing.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following patients with urinary incontinence will not have detrusor instability?",
    "choices": [
      {
        "id": 1,
        "text": "1 and 4"
      },
      {
        "id": 2,
        "text": "2 and 5"
      },
      {
        "id": 3,
        "text": "2 only"
      },
      {
        "id": 4,
        "text": "3 only"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In patient 3, detrusor instability is not seen, as this is a case of functional incontinence.</p>\n<p>During normal micturition, the detrusor muscle contracts after being stimulated by the parasympathetic nerves. In detrusor instability,&nbsp;<strong>detrusor</strong> muscle <strong>contracts spontaneously</strong> or on provocation <strong>during filling</strong> of the bladder. It is often caused by the&nbsp;<strong>overactivity</strong> of<strong> parasympathetic</strong> nerves. It is seen usually in older women and is caused by:</p>\n<ul>\n<li><strong>Decreased</strong> bladder <strong>capacity</strong> - due to fibrosis</li>\n<li><strong>Decreased sensation</strong>&nbsp;</li>\n<li>Central nervous system <strong>(CNS) inhibition</strong> - due to stroke, multiple sclerosis, spinal cord involvement etc.</li>\n</ul>\n<p>It is associated with the following symptoms:&nbsp;</p>\n<ul>\n<li>Incontinence</li>\n<li>Urge to urinate&nbsp;</li>\n<li>Increased frequency</li>\n<li>Nocturia&nbsp;</li>\n<li>Urination during sexual intercourse and with the sound of water, hand-washing.</li>\n</ul>\n<p><strong>Treatment</strong>&nbsp;is initially&nbsp;<strong>conservative</strong> and include decreasing caffeine intake, smoking cessation, fluid restriction and weight reduction. <strong>Anticholinergic drugs</strong> and<strong> bladder training</strong>&nbsp;may also be tried.</p>\n<p>Note:&nbsp;<strong>Functional incontinence</strong> occurs in <strong>patients with disabilities</strong>, whose bladder movements are normal. However, due to <strong>environmental</strong> or <strong>physical barriers</strong>, involuntary leakage of urine occurs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 34-year-old G3P2L2 woman presents to the ER with hypotension, tachycardia, and severe abdominal pain. On examination, fetal parts are palpable in the abdomen. USG abdomen revealed a large uterine wall defect. What's the most common cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "C-section scar dehiscence"
      },
      {
        "id": 2,
        "text": "Obstructed labor"
      },
      {
        "id": 3,
        "text": "Blunt abdominal trauma"
      },
      {
        "id": 4,
        "text": "Prolonged induction of labor"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given case scenario is suggestive of <strong>uterine rupture</strong>. The most common cause&nbsp;is<strong> scar dehiscence</strong> due to a<strong> previous cesarean section</strong>. This can occur due to trial of labour after C-section, or due to spontaneous labor in a patient with previous C-section. Other causes of uterine rupture are:</p>\n<ul>\n<li><strong>Prolonged induction</strong> or augmentation of labor</li>\n<li><strong>Obstructed labor</strong></li>\n<li><strong>Blunt abdominal trauma</strong> during pregnancy</li>\n<li>Rupture of hematometra</li>\n<li>Rupture of pyometra&nbsp;</li>\n</ul>\n<p>&nbsp;Uterine rupture is managed as follows:</p>\n<ul>\n<li>Immediate cesarean section</li>\n<li>Depending upon the extent of rupture:\n<ul>\n<li>Subtotal hysterectomy</li>\n<li>Hysterectomy</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '31 Uro-Gynecology';
        const quizFilename = '31-uro-gynecology-5747c480.html';
        let hierarchy = ["Marrow", "qBank", "Obstetrics & Gynecology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>