<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>042 Asthma & Copd - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">24</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which among the following about idiosyncratic asthma is false?",
    "choices": [
      {
        "id": 1,
        "text": "Presents in childhood"
      },
      {
        "id": 2,
        "text": "Normal IgE levels"
      },
      {
        "id": 3,
        "text": "Commonly have concomitant nasal polyps"
      },
      {
        "id": 4,
        "text": "Negative skin test for common inhalant allergens"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Idiosyncratic </strong>or <strong>intrinsic asthma</strong> does not present in childhood. It typically shows a later onset of disease (<strong>adult-onset asthma</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 36-year-old woman presented with wheezing after taking aspirin for a headache. Which of the following is true regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Raised serum IgE levels"
      },
      {
        "id": 2,
        "text": "Positive skin test for inhaled allergens"
      },
      {
        "id": 3,
        "text": "Associated with nasal polyps"
      },
      {
        "id": 4,
        "text": "A type of extrinsic asthma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of<strong> aspirin-sensitivity asthma</strong>. It&nbsp;is closely associated with <strong>nasal polyps</strong>.</p>\n<p>Aspirin-exacerbated respiratory disease (AERD), also known as <strong>Samter&rsquo;s triad</strong> or<strong> aspirin-sensitive asthma</strong>. It is a chronic medical condition that consists of:</p>\n<ul>\n<li><strong> Intrinsic asthma</strong></li>\n<li>Recurrent sinus disease with nasal polyps</li>\n<li>Sensitivity to aspirin and other NSAIDs</li>\n</ul>\n<p>It has <strong>normal serum IgE</strong> levels&nbsp;and a <strong>negative skin</strong>&nbsp;<strong>test</strong> for inhaled allergens.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the best way to diagnose patients with suspected bronchial asthma?",
    "choices": [
      {
        "id": 1,
        "text": "Chest X-ray"
      },
      {
        "id": 2,
        "text": "Skin test for inhaled allergens"
      },
      {
        "id": 3,
        "text": "FEV1 values"
      },
      {
        "id": 4,
        "text": "Demonstration of reversible obstruction"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The best way to diagnose bronchial asthma is by the <strong>demonstration of reversible obstruction </strong>of the airways.&nbsp;Following the administration of an inhaled beta 2 agonist, a <strong>12%</strong> and <strong>200 ml increase</strong> in the FEV1 demonstrates the reversibility of airway obstruction.</p>\n<p>Options A and B: Chest X-ray and skin test for inhaled allergens are not diagnostic of bronchial asthma.</p>\n<p>Option C: FEV1 values are measured to calculate FEV1/FVC ratio to diagnose any obstructive pathology and not specifically for asthma alone.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young woman is rushed to ED due to wheezing and gasping for breath. She is unable to speak in full sentences. Her husband reports that she has had a cough with fever for 3 days. On examination, PR- 121/min, RR- 32/min, and has cyanosis. Her ABG analysis and chest X-ray are given below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Acute respiratory distress syndrome"
      },
      {
        "id": 2,
        "text": "Asthma with impending failure"
      },
      {
        "id": 3,
        "text": "Acute pneumothorax"
      },
      {
        "id": 4,
        "text": "Acute severe asthma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario of <strong>dyspnea</strong>, <strong>tachycardia</strong> along with the ABG analysis suggestive of <strong>respiratory alkalosis</strong> and chest-Xray showing <strong>hyperinflated lungs</strong> is pointing to a diagnosis of&nbsp;<strong>acute severe asthma</strong>. A history of cough with fever is indicating a probable <strong>respiratory infection</strong> to have triggered the asthma exacerbation.&nbsp;</p>\n<p>Features of acute severe asthma vs asthma with impending respiratory failure:&nbsp;</p>\n<table style=\"height: 456px; width: 464px;\">\n<tbody>\n<tr>\n<td style=\"width: 224.045px;\"><strong>Acute severe asthma</strong></td>\n<td style=\"width: 225.99px;\"><strong>Asthma with impending respiratory failure</strong></td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Dyspneic, speaks in words</td>\n<td style=\"width: 225.99px;\">Mute patient</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Agitated patient</td>\n<td style=\"width: 225.99px;\">Silent / confused patient</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Heart rate &gt; 120 /min, tachycardia</td>\n<td style=\"width: 225.99px;\">Relative bradycardia</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Pulsus paradoxus present</td>\n<td style=\"width: 225.99px;\">Pulsus paradoxus absent (due to respiratory muscle fatigue)</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Accessory muscles of respiration used</td>\n<td style=\"width: 225.99px;\">Paradoxical breathing is seen</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Loud wheeze throughout the respiration</td>\n<td style=\"width: 225.99px;\">Silent chest</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Peak expiratory flow rate &lt; 40 ml/min</td>\n<td style=\"width: 225.99px;\">Peak expiratory flow rate &lt; 25 ml/min</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Respiratory alkalosis</td>\n<td style=\"width: 225.99px;\">Respiratory acidosis</td>\n</tr>\n<tr>\n<td style=\"width: 224.045px;\">Hyperventilation leading to low or normal PaCO2</td>\n<td style=\"width: 225.99px;\">Normal or rising PaCO2</td>\n</tr>\n</tbody>\n</table>\n<p>Note: The X-ray is not showing the features of<strong>&nbsp;ARDS</strong> and&nbsp;<strong>pneumothorax</strong>, hence they are ruled out as the right options.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/080872a670a842b0b3b3b4f511f2526a.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs is not recommended in the treatment of patients with bronchial asthma?",
    "choices": [
      {
        "id": 1,
        "text": "Sodium cromoglycate"
      },
      {
        "id": 2,
        "text": "Zafirlukast"
      },
      {
        "id": 3,
        "text": "Roflumilast"
      },
      {
        "id": 4,
        "text": "Dupilumab"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Roflumilast</strong> is a phosphodiesterase-4 inhibitor used in the treatment of <strong>COPD</strong>, not asthma.</p>\n<p><strong>Drugs used</strong> in the <strong>treatment of bronchial asthma</strong></p>\n<p><strong>Bronchodilators</strong></p>\n<ul>\n<li>Beta-2 sympathomimetics: Salmeterol, formoterol</li>\n<li>Methylxanthines: Theophylline, aminophylline</li>\n<li>Anticholinergics: Ipratropium bromide, tiotropium bromide</li>\n</ul>\n<p><strong>Anti-inflammatory </strong></p>\n<ul>\n<li>Corticosteroids (inhalational): Beclomethasone, budesonide, fluticasone</li>\n<li>Corticosteroids (systemic): Prednisolone, hydrocortisone</li>\n<li>Mast cell stabilizers: <strong>Sodium cromoglycate</strong>, ketotifen</li>\n<li>Leukotriene antagonists: Montelukast, <strong>zafirlukast</strong></li>\n<li>Anti-IgE: Omalizumab</li>\n<li>Anti-IL5: Mepolizumab, reslizumab</li>\n<li>Anti-IL4 receptor:&nbsp;<strong>Dupilumab</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false regarding leukotriene modifiers in the management of bronchial asthma?",
    "choices": [
      {
        "id": 1,
        "text": "Ketotifen belongs to this group"
      },
      {
        "id": 2,
        "text": "Associated with Churg- Strauss syndrome"
      },
      {
        "id": 3,
        "text": "Protect against exercise-induced asthma"
      },
      {
        "id": 4,
        "text": "Diminishes nocturnal symptoms of asthma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Ketotifen</strong> is an example of a&nbsp;<strong>mast cell stabilizer</strong>, not leukotriene modifiers.</p>\n<p><strong>Leukotriene modifiers&nbsp;</strong>are a&nbsp;group of agents used for mild persistent asthma. They <strong>block LT1-receptors</strong> thus causing reduced eosinophilic inflammation and causing bronchodilator. They include <strong>montelukast</strong>, <strong>zafirlukast</strong>, and<strong> zileuton</strong>.</p>\n<p>Leukotriene modifiers are less effective than inhaled corticosteroids (ICS) in controlling asthma. They are used as add-on therapy in some patients whose asthma is not controlled with low doses of ICS.</p>\n<p><strong>Churg&ndash;Strauss syndrome</strong> (CSS) is a rare granulomatous small vessel vasculitis, that affects the heart, kidneys, peripheral nerves, etc. It occurs against a background of long-standing asthma and marked peripheral eosinophilia. Several cases of CSS are associated with the use of <strong>montelukast</strong> and <strong>zafirlukast</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Treatment of choice for patients with type 2 brittle asthma is:",
    "choices": [
      {
        "id": 1,
        "text": "Inhaled Salbutamol"
      },
      {
        "id": 2,
        "text": "Subcutaneous salbutamol"
      },
      {
        "id": 3,
        "text": "Subcutaneous terbutaline"
      },
      {
        "id": 4,
        "text": "Subcutaneous adrenaline"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The<strong> treatment</strong> of choice for <strong>type II brittle asthma</strong> is <strong>subcutaneous adrenaline</strong>.</p>\n<p><strong>Brittle asthma</strong> is a type of <strong>severe asthma</strong> where patients have very serious and often, life-threatening attacks despite appropriate therapy. It is of two types:</p>\n<table style=\"height: 156px; width: 671.984375px;\">\n<tbody>\n<tr style=\"height: 31px;\">\n<td style=\"width: 327px; text-align: center; height: 31px;\"><strong>Type 1</strong></td>\n<td style=\"width: 330.984375px; text-align: center; height: 31px;\"><strong>Type 2</strong></td>\n</tr>\n<tr style=\"height: 62px;\">\n<td style=\"width: 327px; height: 62px;\">\n<p>A persistent pattern of variability in PEFR (peak expiratory flow rate) readings</p>\n</td>\n<td style=\"width: 330.984375px; height: 62px;\">\n<p>Generally normal or near-normal PEFR readings but few unpredictable exacerbations occur without an obvious trigger</p>\n</td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 327px; height: 36px;\">Oral steroids, infusion of bronchodilators, and dietary exclusion of allergens may be helpful</td>\n<td style=\"width: 330.984375px; height: 36px;\">&nbsp;Respond only to subcutaneous epinephrine</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following class of drugs cannot be used in the treatment of patients with bronchial asthma?",
    "choices": [
      {
        "id": 1,
        "text": "IL-4 receptor antagonists"
      },
      {
        "id": 2,
        "text": "Anti\u2013IL-5 antibodies"
      },
      {
        "id": 3,
        "text": "Anti IgE antibody"
      },
      {
        "id": 4,
        "text": "IL- 1 antagonist"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The treatment options for asthma do not include IL-1 antagonists&nbsp;(anakinra). <strong>Anakinra</strong> is used in the treatment of <strong>rheumatoid arthritis.&nbsp;</strong></p>\n<p>Cytokines mediating airway inflammation in asthma:&nbsp;<strong>IL-4, IL-5, IL-13, TGF-&beta;</strong>,&nbsp;and chemokines.</p>\n<p><strong>Omalizumab</strong> is a monoclonal antibody <strong>against IgE</strong>. It is available for the treatment of children &ge;6 years of age with documented allergen-induced asthma that is inadequately controlled by inhaled corticosteroids. &nbsp;</p>\n<p>The new treatment options for asthma under clinical trial are:&nbsp;</p>\n<ul>\n<li><strong>Mepolizumab:</strong> anti&ndash;IL-5 antibody</li>\n<li><strong>Benralizumab:&nbsp;</strong>anti&ndash;IL-5 receptor antibody</li>\n<li><strong>Dupilumab:</strong> anti&ndash;IL-4 receptor antibody</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 6-year-old asthmatic boy is rushed to the casualty. He is not responding to the commands and is having fast shallow breathing.  On auscultation, the chest is silent and paradoxical breathing is present. ABG analysis shows respiratory acidosis. What is the best step in management for him?",
    "choices": [
      {
        "id": 1,
        "text": "Hyperbaric oxygen therapy"
      },
      {
        "id": 2,
        "text": "MDI with salbutamol and corticosteroids"
      },
      {
        "id": 3,
        "text": "Immediate endotracheal intubation"
      },
      {
        "id": 4,
        "text": "Intravenous magnesium sulfate"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of <strong>severe asthma</strong> with impending <strong>respiratory failure</strong>. The&nbsp;best step in the management is <strong>immediate endotracheal intubation</strong>.</p>\n<p>Features of asthma with impending respiratory failure are:</p>\n<ul>\n<li>Mute or confused patient</li>\n<li><strong>Paradoxical breathing</strong></li>\n<li><strong>Silent</strong>&nbsp;<strong>chest</strong> on auscultation&nbsp;</li>\n<li>Relative bradycardia</li>\n<li>Peak expiratory flow rate (PEFR) &lt;25ml/min</li>\n<li>Arterial blood gas analysis shows<strong> respiratory acidosis</strong>.</li>\n</ul>\n<p>Option A: Hyperbaric oxygen is given in CO poisoning and high altitude pulmonary edema.</p>\n<p>Option B: MDI with salbutamol and corticosteroids is only useful for acute severe asthma.</p>\n<p>Option D: Intravenous magnesium sulfate is not routinely used.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding COPD?",
    "choices": [
      {
        "id": 1,
        "text": "Increased resistance is seen in airways \u22642 mm diameter"
      },
      {
        "id": 2,
        "text": "Changes in large airways cause cough and sputum"
      },
      {
        "id": 3,
        "text": "Ventilation-perfusion mismatching is seen"
      },
      {
        "id": 4,
        "text": "Rise in post bronchodilator FEV1>12%"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The rise in post-bronchodilator FEV1&gt;12% is a feature of asthma, not COPD. It suggests reversible airflow obstruction.\u00a0</p>\n<p>Chronic obstructive pulmonary disease (<strong>COPD</strong>) is a chronic respiratory disease characterized by the presence of <strong>airflow obstruction</strong> that is <strong>partially reversible</strong>.</p>\n<p><strong>Cigarette smoking</strong> is the <strong>most common cause</strong> of COPD. Cigarette smoke exposure affects large airways, small airways, and alveoli:</p>\n<ul>\n<li>Changes in<strong> large airways </strong>cause <strong>cough </strong>and<strong> sputum</strong></li>\n<li>Changes in <strong>small airways</strong> (<strong>\u22642mm</strong>) and alveoli are responsible for physiologic alterations</li>\n</ul>\n<p>The major site of<strong> increased resistance</strong> in most individuals with COPD is in airways \u22642 mm diameter.</p>\n<p>Characteristic cellular changes include goblet cell metaplasia. <strong>Goblet cells</strong> are mucus-secreting cells that replace surfactant-secreting Club cells.</p>\n<p>Nonuniform ventilation and <strong>ventilation-perfusion mismatching</strong> are characteristic of COPD.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What happens to Reid index in patients with chronic bronchitis?",
    "choices": [
      {
        "id": 1,
        "text": "Increases"
      },
      {
        "id": 2,
        "text": "Decreases"
      },
      {
        "id": 3,
        "text": "Remains same"
      },
      {
        "id": 4,
        "text": "Increases initially and then decreases"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Reid index</strong> is <strong>increased</strong> in chronic bronchitis.</p>\n<p>Reid index is the ratio of the thickness of the mucous gland layer to the thickness of the bronchial wall.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b41a1fc073494da7b25ccb1d8eb442bdx1280x1391.JPEG"
    ]
  },
  {
    "text": "Which of the following findings is least likely to be seen in patients with COPD?",
    "choices": [
      {
        "id": 1,
        "text": "Barrel chest"
      },
      {
        "id": 2,
        "text": "Hoover's sign"
      },
      {
        "id": 3,
        "text": "Cyanosis"
      },
      {
        "id": 4,
        "text": "Clubbing"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Clubbing is not a sign of COPD. Its presence should trigger the investigation of the causes of clubbing, particularly<strong> lung cancer</strong>.</p>\n<p><strong>Signs of COPD</strong>:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Signs of respiratory distress\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Tripod posture\u00a0</strong>- facilitates the use of accessory muscles of respiration</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Pursed lip breathing - seen in emphysema</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Central cyanosis</strong></li>\n</ul>\n</li>\n<li>Signs of cachexia\n<ul>\n<li>Severe weight loss</li>\n<li>Bitemporal wasting</li>\n</ul>\n</li>\n<li>Signs of hypercapnia (<strong>type 2 respiratory failure</strong>) - more common in chronic bronchitis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Barrel-shaped chest\u00a0</strong>- increase in the anteroposterior diameter</li>\n<li>Enlarged lung volumes</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Positive Hoover's sign\u00a0</strong>- paradoxical inward movement of the chest during inspiration</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Early inspiratory coarse crackles\u00a0\u00a0</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Normal vesicular breath sounds of reduced-intensity with bilaterally prolonged expiration</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Blue bloaters -\u00a0</strong>cyanotic (blue) and edematous (bloaters), <strong>chronic bronchitis</strong> predominant features</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Pink puffers</strong> - thin, non-cyanotic (pink) at rest, and severely dyspneic (puffers), <strong>emphysema</strong> predominant features\u00a0</li>\n</ul>\n<p><strong>Causes of clubbing</strong>:</p>\n<ul>\n<li style=\"font-weight: 400;\"><strong>Pulmonary</strong></li>\n<ul>\n<li style=\"font-weight: 400;\">Bronchogenic carcinoma</li>\n<li style=\"font-weight: 400;\">Lung abscess, empyema, bronchiectasis</li>\n<li style=\"font-weight: 400;\">Chronic interstitial pneumonitis</li>\n<li style=\"font-weight: 400;\">Cystic fibrosis</li>\n<li style=\"font-weight: 400;\">Sarcoidosis</li>\n</ul>\n<li style=\"font-weight: 400;\"><strong>Gastrointestinal\u00a0</strong></li>\n<ul>\n<li style=\"font-weight: 400;\">Inflammatory bowel disease</li>\n<li style=\"font-weight: 400;\">Sprue</li>\n<li style=\"font-weight: 400;\">Neoplasms - esophagus, liver, bowel</li>\n</ul>\n<li style=\"font-weight: 400;\"><strong>Cardiovascular</strong></li>\n<ul>\n<li style=\"font-weight: 400;\">Cyanotic congenital heart disease</li>\n<li style=\"font-weight: 400;\">Subacute bacterial endocarditis</li>\n<li style=\"font-weight: 400;\">Aortic aneurysm</li>\n<li style=\"font-weight: 400;\">Arteriovenous fistula</li>\n</ul>\n<li style=\"font-weight: 400;\"><strong>Endocrine </strong>\n<ul>\n<li style=\"font-weight: 400;\">Hyperthyroidism (Grave\u2019s disease)</li>\n</ul>\n</li>\n</ul>\n<p>The image below shows the characteristic <strong>tripod posture</strong> in a patient with COPD.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f427aee2ac5f4865be9410361221c7bex960x1280.JPEG"
    ]
  },
  {
    "text": "A 28-year-old coal miner presented with breathing difficulties. He reported that his symptoms get aggravated at work. His chest X-ray showed features of emphysema. On evaluation, he was found to have an \u03b11-antitrypsin deficiency. Which pathological type of emphysema is most likely present in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Centri-acinar"
      },
      {
        "id": 2,
        "text": "Pan-acinar"
      },
      {
        "id": 3,
        "text": "Irregular"
      },
      {
        "id": 4,
        "text": "Para-septal"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The pathological type most likely to be present in this patient is&nbsp;<strong>pan-acinar emphysema.&nbsp;</strong>This type is commonly seen in patients with&nbsp;<strong>&alpha;1-antitrypsin deficiency</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly man is being evaluated for exertional dyspnea, cough, and weight loss. His chest CT is given below. What is it suggestive of?",
    "choices": [
      {
        "id": 1,
        "text": "Emphysematous lung"
      },
      {
        "id": 2,
        "text": "Atypical pneumonia"
      },
      {
        "id": 3,
        "text": "Calcified granulomas"
      },
      {
        "id": 4,
        "text": "Interstitial fibrosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>CT scan</strong> shows <strong>emphysematous lungs</strong>, with reduced parenchymal markings and focal areas of low attenuation. This represents the emphysematous destruction of the lung, indicative of<strong> hyperinflation</strong>.</p>\n<p>Radiographic studies in COPD show:</p>\n<ul>\n<li>Emphysematous bullae</li>\n<li>A paucity of parenchymal markings</li>\n<li>Hyperlucency suggests the presence of emphysema</li>\n<li>Increased lung volumes and<strong> flattening </strong>of the<strong> diaphragm</strong> suggest hyperinflation</li>\n</ul>\n<p>Option B: Atypical pneumonia shows patchy bilateral ground-glass opacities.</p>\n<p>Option C: Calcified granulomas are seen as dense, bright nodules.</p>\n<p>Option D: Interstitial fibrosis shows a honeycomb pattern of the lung parenchyma as shown below.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/34ead242e43644ef935196bd29c60e7f.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2a4c2e6ed9534c45ae3752d9ca23c784x246x157.JPEG"
    ]
  },
  {
    "text": "A 55-years old chronic smoker presented with chronic cough with expectoration. He has been having similar episodes for the past 2 years. He also reported that he had to rest every few minutes while walking due to breathlessness. Pulmonary function tests showed FEV1/FVC of  0.5 and FEV1  of 50%. Which of the following is not a feature of the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "Irreversible airflow limitation"
      },
      {
        "id": 2,
        "text": "Affects small airway disease"
      },
      {
        "id": 3,
        "text": "Decrease in residual volume"
      },
      {
        "id": 4,
        "text": "Associated with ineffective repair of elastin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The clinical picture is highly suggestive of chronic obstructive pulmonary disease(<strong>COPD</strong>). An <strong>increase</strong> in the <strong>residual volume</strong> is a feature of COPD.</p>\n<p>COPD is defined as a chronic respiratory disease&nbsp;characterized by the presence of <strong>airflow obstruction</strong> that is <strong>partially reversible</strong>.&nbsp;</p>\n<p>COPD is the clinical expression of <strong>abnormalities</strong> of <strong>airways</strong> and/or <strong>alveoli</strong> and includes:&nbsp;</p>\n<ul>\n<li><strong>Emphysema&nbsp;</strong>is defined pathologically as the abnormal and <strong>permanent dilation</strong> of <strong>airways</strong> distal to the terminal bronchiole, along with the destruction of their walls.</li>\n<li><strong>Chronic bronchitis </strong>is&nbsp;defined clinically as the presence of <strong>persistent cough</strong> with <strong>sputum production</strong> on most of the days for <strong>&ge;3 months</strong> in <strong>2 consecutive years</strong>.&nbsp;</li>\n<li><strong>Small airways diseases&nbsp;</strong>are conditions affecting<strong> airways</strong> of<strong> &le;2 mm</strong>, resulting in inflammation and narrowing of the same.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Chest X-ray of an emphysematous patient is as shown.  What is the best investigation to measure his lung volume?",
    "choices": [
      {
        "id": 1,
        "text": "Body plethysmography"
      },
      {
        "id": 2,
        "text": "Gas dilution"
      },
      {
        "id": 3,
        "text": "Fractional exhaled NO"
      },
      {
        "id": 4,
        "text": "DLCO"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Body plethysmography is the best investigation to measure lung volume in an emphysematous patient with<strong> bullous lesions</strong> as seen on the X-ray.</p>\n<p>To measure absolute lung volumes, two techniques are used:</p>\n<ol>\n<li><strong>Body plethysmography:&nbsp;</strong>It is used to measure the volume of any gas containing space in the thorax <strong>including&nbsp;bullae.</strong> It is accurate in both obstructive and restrictive diseases.</li>\n<li><strong>Inert gas dilution technique:&nbsp;</strong>It is used to measure the volume of regions that are well ventilated which <strong>excludes</strong> trapped gas or bullae. It is accurate in restrictive diseases only.</li>\n</ol>\n<p>The amount of gas trapped in bullae can be measured by subtracting lung volumes measured by inert gas dilution technique from lung volume measured by body plethysmography.</p>\n<p>Fractional exhaled nitric oxide (F<sub>E</sub>NO) is a<strong> non-invasive test</strong>&nbsp;used in the diagnosis and monitoring of bronchial asthma. NO levels are <strong>increased</strong> in asthmatics&nbsp;and related to the eosinophilic inflammation in the airways.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c6cb2450349c4f668a25e9ca1e9b2a76.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 66-year-old chronic smoker presents with progressive shortness of breath and chronic cough. On examination, he has a barrel chest and has pursed-lip breathing. Hyperresonance and inspiratory wheezes are heard. Pulmonary functions are likely to reveal all of the following, except:",
    "choices": [
      {
        "id": 1,
        "text": "Decreased vital capacity"
      },
      {
        "id": 2,
        "text": "Increased diffusion capacity for carbon monoxide"
      },
      {
        "id": 3,
        "text": "Increased total lung capacity"
      },
      {
        "id": 4,
        "text": "Decreased FEV1/FVC ratio"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical diagnosis is suggestive of <strong>COPD</strong> and the underlying pathological change is likely to be<strong> emphysema. </strong>It&nbsp;is associated with <strong>a decreased</strong> diffusion capacity for carbon monoxide (<strong>DLCO</strong>).</p>\n<p>Emphysema&nbsp;is defined pathologically as the <strong>abnormal</strong> and <strong>permanent dilation</strong> of <strong>airways</strong> distal to the terminal bronchiole, along with the <strong>destruction</strong> of their <strong>walls</strong>.&nbsp;This leads to hyperinflation due to air trapping and impaired diffusion of gases.</p>\n<p><strong>Pulmonary function tests in COPD:</strong></p>\n<ul>\n<li>TLC: Normal or increased</li>\n<li>FEV1: Decreased (&lt;80% predicted)</li>\n<li>FVC: Decreased</li>\n<li>FEV1/FVC: Decreased</li>\n<li>DLCO: Decreased</li>\n</ul>\n<p><strong>Diseases associated with lowered DLCO:</strong></p>\n<ul>\n<li>Emphysema</li>\n<li>Interstitial Lung disease</li>\n<li>Primary pulmonary hypertension</li>\n</ul>\n<p>Note - <strong>Bronchial asthma</strong> is associated with an <strong>increased DLCO.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The Gold's criteria for severe COPD are:",
    "choices": [
      {
        "id": 1,
        "text": "FEV1/FVC <0.7 and FEV1 \u2265 30%"
      },
      {
        "id": 2,
        "text": "FEV1/FVC <0.7 and  FEV1 < 30%"
      },
      {
        "id": 3,
        "text": "FEV1/FVC<0.7 and  FEV1< 20%"
      },
      {
        "id": 4,
        "text": "FEV1/FVC<0.7 and FEV1 \u2265 50%"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Recent update:&nbsp;<strong>PRISm</strong> refers to a group of COPD patients with <strong>apparent normal spirometry</strong>, but with <strong>emphysema (as seen on radiographic evaluation)</strong> and a wide range of lung function impairment.&nbsp; These patients have a <strong>higher mortality risk</strong> as compared to other COPD patients. The possible risk factors are exposure to smoking, high BMI, and reduced total lung capacity. Spirometry findings are <strong>low to normal FEV1</strong>, and <strong>normal FEV1/FVC ratio</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presents to the OPD with shortness of breath. He reports walking slower than his peers due to breathlessness. He has had two hospitalizations for similar complaints this year. His post-bronchodilator PFTs are FEV1/FVC < 0.55 and FEV1 55%.  Under what category would he be classified based on GOLD criteria?",
    "choices": [
      {
        "id": 1,
        "text": "Moderate COPD, Group C"
      },
      {
        "id": 2,
        "text": "Moderate COPD, Group E"
      },
      {
        "id": 3,
        "text": "Severe COPD, Group A"
      },
      {
        "id": 4,
        "text": "Severe COPD, Group D"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This patient belongs to <strong>moderate COPD</strong>, <strong>group E</strong>\u00a0category.</p>\n<p>The severity of COPD assessed by the Global Initiative for Lung Disease (GOLD) is classified as:</p>\n<table style=\"height: 281px; width: 356px;\" border=\"1\">\n<tbody>\n<tr>\n<td style=\"width: 64.8611px;\">\n<p><strong>GOLD Stage</strong></p>\n</td>\n<td style=\"width: 90.816px;\">\n<p><strong>Severity </strong></p>\n</td>\n<td style=\"width: 181.042px;\">\n<p><strong>Spirometry </strong></p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 64.8611px;\">\n<p>I</p>\n</td>\n<td style=\"width: 90.816px;\">\n<p>Mild</p>\n</td>\n<td style=\"width: 181.042px;\">\n<p>FEV1/FVC &lt;0.7 and FEV1 \u226580% predicted</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 64.8611px;\">\n<p>II</p>\n</td>\n<td style=\"width: 90.816px;\">\n<p>Moderate</p>\n</td>\n<td style=\"width: 181.042px;\">\n<p>FEV1/FVC &lt;0.7 and FEV1 \u226550% but &lt;80% predicted</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 64.8611px;\">\n<p>III</p>\n</td>\n<td style=\"width: 90.816px;\">\n<p>Severe</p>\n</td>\n<td style=\"width: 181.042px;\">\n<p>FEV1/FVC &lt;0.7 and FEV1 \u226530% but &lt;50% predicted</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 64.8611px;\">\n<p>IV</p>\n</td>\n<td style=\"width: 90.816px;\">\n<p>Very severe</p>\n</td>\n<td style=\"width: 181.042px;\">\n<p>FEV1/FVC &lt;0.7 and FEV1 &lt;30% predicted</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>\n<p>According to <strong>GOLD 2023 guidelines</strong>, COPD patients are classified into Group <strong>A, B, or E</strong> based on the <strong>severity of dyspnoea,</strong>\u00a0<strong>frequency of exacerbations and hospitilization</strong>. Dyspnoea may be assessed using the modified MRC Dyspnoea scale or COPD Assessment Test (CAT score)</p>\n<table style=\"height: 43px;\" width=\"732\">\n<tbody>\n<tr>\n<td style=\"width: 358px;\">&gt;=2 moderate exacerbations or &gt;=1 leading to hospitalisation</td>\n<td style=\"width: 358px;\">\n<p>Group E:<br />\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 <strong>\u00a0LABA+LAMA</strong></p>\n<p>consider LABA+LAMA+ICS* if blood eosinophil count &gt;=300</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>\n<table style=\"height: 91px;\" width=\"738\">\n<tbody>\n<tr>\n<td style=\"width: 240.711px;\">0 or 1 moderate exacerbation (not leading to hospital admissions)</td>\n<td style=\"width: 241.383px;\">\n<p>Group A: mMRC 0-1, CAT&lt;10</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<strong> Bronchodilator</strong></p>\n</td>\n<td style=\"width: 233.906px;\">\n<p>Group B: mMRC &gt;=2, CAT &gt;=10</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0<strong> LABA + LAMA*</strong></p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>* single inhaler therapy maybe more convenient and effective than multiple inhalers</p>\n<p>ICS - inhaled corticosteroids<br />LAMA - Long-acting Muscarinic Antagonists<br />LABA - Long-acting Beta Agonists</p>\n<p><strong>Modified MRC (mMRC) dyspnoea scale:</strong></p>\n<ul>\n<li>0- Breathless only with strenuous exercise</li>\n<li>1- Breathless when hurrying on a level or walking up a hill</li>\n<li>2- Walks slower than peers or has to stop for breath when walking on level</li>\n<li>3- Stops for breath after walking about 100m or for a few minutes</li>\n<li>4- Breathless at rest</li>\n</ul>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false regarding acute exacerbations in COPD patients?",
    "choices": [
      {
        "id": 1,
        "text": "May not be accompanied with fever"
      },
      {
        "id": 2,
        "text": "Viral infection is a common precipitating factor"
      },
      {
        "id": 3,
        "text": "Glucocorticoids are contraindicated"
      },
      {
        "id": 4,
        "text": "May present with congestive heart failure"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Glucocorticoids</strong> are used during an <strong>exacerbation of COPD</strong>. They <strong>hasten recovery</strong> and reduce the chances of future exacerbations.</p>\n<p>Exacerbations are episodes of <strong>increased dyspnoea and cough</strong>, with a change in the amount and character of sputum. They are often <strong>triggered by an infection</strong> with one-third of cases having a viral etiology.&nbsp;They <strong>may or may not </strong>have other signs of illness such as <strong>fever</strong>, myalgias, and sore throat.&nbsp;In severe cases, they may present with pneumonia and<strong> congestive heart failure</strong>.</p>\n<p>Note: While oral glucocorticoids are contraindicated in long-term treatment due to side effects, they are used for acute exacerbation of COPD.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old male patient who is a known case of COPD presented with acute exacerbation and is admitted to the ICU. Which of the following statements is correct with regards to the initial management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Non-Invasive PPV should be given"
      },
      {
        "id": 2,
        "text": "Invasive PPV should be given"
      },
      {
        "id": 3,
        "text": "IV corticosteroids should be administered"
      },
      {
        "id": 4,
        "text": "Permissive hypercapnia is allowed"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Non-invasive positive pressure ventilation </strong>(NIPPV) should be the <strong>first</strong> mode of ventilation used in COPD patients with acute respiratory failure provided there are <strong>no absolute contraindications. </strong>This approach improves gas exchange, reduces work of breathing and the need for intubation, decreases hospitalization duration and enhances overall survival outcomes.</p>\n<p><strong>Invasive positive pressure ventilation</strong> is only considered after <strong>failure</strong> of NIPPV, resulting in severe respiratory distress, life threatening hypoxemia, severe hypercarbia and/or acidosis, markedly impaired mental status, <strong>respiratory arrest</strong> or<strong> hemodynamic instability</strong> (Option B).</p>\n<p>Apart from NIPPV, <strong>short-acting inhaled beta 2 agonists </strong>(albuterol, salbutamol) with or without <strong>short-acting anticholinergics</strong> (ipratropium) and\u00a0<strong>Long-acting anticholinergics </strong>(tiotropium) are recommended as the initial bronchodilators. <strong>Maintenance</strong> therapy with long-acting beta 2 agonists (formoterol) must be started as soon as possible.</p>\n<p><strong>Systemic corticosteroids </strong>are useful in the treatment of acute exacerbations of COPD as they reduce airway inflammation and improve lung function over time. However, the effects are not immediate. NIPPV on the other hand provides<strong> immediate relief </strong>to the patient and reduces the work of breathing. Therefore, it would not be the best choice in this case. (Option C)</p>\n<p><strong>Antibiotics</strong> can also be considered, as they reduce duration of hospitalisation. Treatment is given for <strong>5 days.\u00a0</strong></p>\n<p><strong>Permissive hypercapnia </strong>refers to a ventilation strategy where tidal volume is reduced in order to avoid hyperinflation-associated lung trauma. It is not preferred at the initial presentation. It is only permitted once invasive PPV is started following NIPPV failure (Option D)\u00a0</p>\n<p>An<strong> exacerbation of COPD </strong>is defined as an event characterized by dyspnea and/or cough and sputum that worsen over &lt; 14 days. Exacerbations of COPD are often associated with <strong>increased</strong> <strong>local</strong> and <strong>systemic</strong> <strong>inflammation</strong> caused by airway infection, pollution, or other insults to the lungs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old obese chronic smoker is rushed to the ER with difficulty in breathing and a productive cough. He has a past history of two similar episodes this year. On examination, RR- 34/min, with use of accessory muscles and central cyanosis is present. ABG is as shown. Chest X-ray shows increased vascular markings. What is the best initial step of management?",
    "choices": [
      {
        "id": 1,
        "text": "Low flow humidified oxygen"
      },
      {
        "id": 2,
        "text": "High  flow humidified oxygen"
      },
      {
        "id": 3,
        "text": "Salbutamol and budesonide nebulisation"
      },
      {
        "id": 4,
        "text": "Slow infusion of theophylline"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario along with the ABG and X-ray findings is suggestive of <strong>acute exacerbation of COPD</strong> with respiratory failure. The best initial step of management is&nbsp;<strong>low-flow</strong> <strong>humidified</strong> <strong>oxygen.</strong></p>\n<p>Oxygen supplementation is a crucial component of acute therapy. Administering O2 should target a <strong>SpO2- 88-92%</strong> or <strong>PaO2- 60-70 mmHg</strong>. This helps to minimize the risk of worsening hypercapnia with excess supplemental oxygen.</p>\n<p>The given ABG shows<strong> respiratory acidosis</strong> as <strong>PaCO2 &gt;45 mmHg</strong>, and<strong> pH&lt;7.35</strong>. In respiratory acidosis, a trial of non-invasive ventilation is given. Hence, low-flow humidified oxygen is the first step in management.</p>\n<p>Option B: High flow oxygen causes dryness, crusting epistaxis, and damages the lung hence not used.&nbsp;</p>\n<p>Option C: Salbutamol and budesonide nebulization are not effective as initial management in exacerbation of COPD with respiratory failure.</p>\n<p>Option D: Methylxanthines are not recommended in the management of acute exacerbations due to their side effect profiles.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In patients with which of the following conditions is NIPPV contraindicated?",
    "choices": [
      {
        "id": 1,
        "text": "COPD"
      },
      {
        "id": 2,
        "text": "Central hypoventilation syndrome"
      },
      {
        "id": 3,
        "text": "Cardiovascular instability"
      },
      {
        "id": 4,
        "text": "Chest wall disorders"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Noninvasive positive-pressure ventilation (<strong>NIPPV</strong>) is contraindicated in <strong>cardiovascular instability</strong>. NIPPV&nbsp;can impede venous filling of the heart, decrease cardiac output, and worsen/precipitate hypotension. Moreover, in unstable states with impending cardiovascular collapse,<strong> invasive ventilation</strong> is preferred.</p>\n<p><strong>Indications of NIPPV:</strong></p>\n<ul>\n<li>Apnea - central and obstructive</li>\n<li>Central hypoventilation syndrome</li>\n<li>Neuromuscular and chest wall disorders</li>\n<li>Respiratory failure - PaCO<sub>2&nbsp;</sub>&gt;45 mmHg</li>\n</ul>\n<p><strong>Contraindications of NIPPV:</strong></p>\n<ul>\n<li><strong>Cardiovascular instability</strong></li>\n<li>Impaired mental status or inability to cooperate</li>\n<li>Copious secretions or the inability to clear secretions</li>\n<li>Craniofacial abnormalities</li>\n<li>Trauma precluding effective fitting of the mask</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not used in the long-term treatment of COPD patients?",
    "choices": [
      {
        "id": 1,
        "text": "Theophylline"
      },
      {
        "id": 2,
        "text": "Azithromycin"
      },
      {
        "id": 3,
        "text": "Oral glucocorticoids"
      },
      {
        "id": 4,
        "text": "N Acetylcysteine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Oral glucocorticoids</strong> are not used in the long-term treatment of COPD because of an <strong>unfavorable </strong>benefit/risk ratio.</p>\n<p>Chronic use of glucocorticoids is associated with significant side effects, including osteoporosis, weight gain, cataracts, glucose intolerance, and increased risk of infection.</p>\n<p><strong>Treatment of COPD:</strong></p>\n<ul>\n<li>Smoking cessation</li>\n<li>Anticholinergic agents- Ipratropium bromide</li>\n<li>Beta Agonists-&nbsp;Long-acting inhaled &beta; agonists, such as salmeterol or formoterol are commonly used.&nbsp;</li>\n<li>Methylxanthines- <strong>theophylline</strong> produces improvements in expiratory flow rates and vital capacity.&nbsp;</li>\n<li>Phosphodiesterase inhibitors - roflumilast is used when FEV1&lt;50%.&nbsp;</li>\n<li>Antibiotics- macrolides like <strong>azithromycin</strong> reduce exacerbations when used over one year</li>\n<li><strong><em>N</em>-acetylcysteine</strong> has been used in patients with COPD for both its mucolytic and antioxidant properties</li>\n<li>Oxygen therapy</li>\n</ul>\n<p><strong>Non-pharmacologic therapies:</strong></p>\n<ul>\n<li>Lung volume reduction surgery</li>\n<li>Lung transplantation</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '042 Asthma & Copd';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>