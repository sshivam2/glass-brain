<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>31 Gall Bladder - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">30</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following statements about the anatomy of the gallbladder is false?",
    "choices": [
      {
        "id": 1,
        "text": "Valves of Heister are present around the neck of the gallbladder"
      },
      {
        "id": 2,
        "text": "Gall bladder has a very thick submucosal layer"
      },
      {
        "id": 3,
        "text": "Hartmann's pouch may hinder safe dissection of the cystic pedicle"
      },
      {
        "id": 4,
        "text": "Phrygian cap anomaly is not an indication for cholecystectomy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The gallbladder does not have <strong>muscularis mucosa</strong> and <strong>submucosa</strong>. Those layers are <strong>absent</strong> in the <strong>gallbladder</strong>.</p>\n<p>The mucosa of the cystic duct is arranged in spiral folds known as the <strong>valves of the Heister</strong>. The valves act to keep gallstones from entering the common bile duct in spite of distention and intraluminal pressure.</p>\n<p><strong>Hartmann\u2019s pouch</strong> is a diverticulum that can occur at the neck of the gallbladder. It\u00a0may obscure the cystic duct and Calot\u2019s triangle during laparascopic surgical dissection.</p>\n<p>The <strong>Phrygian cap</strong> is present in 2\u20136 percent of cholecystograms and may be mistaken for a pathological deformity of the organ. It is not an indication for cholecystectomy.<br /><br /></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a02a09a7cd4649b18f9e8d852b296863x1280x1471.JPEG"
    ]
  },
  {
    "text": "While assisting a laparoscopic cholecystectomy for gallstones, the surgeon asks you to identify the Calot's triangle. Which of the following structures does not form the boundaries of this triangle?",
    "choices": [
      {
        "id": 1,
        "text": "Cystic duct"
      },
      {
        "id": 2,
        "text": "Common hepatic duct"
      },
      {
        "id": 3,
        "text": "Cystic artery"
      },
      {
        "id": 4,
        "text": "The inferior surface of the liver"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Note: The cystic artery is one of the contents as well as forms the superior boundary of the Calot's triangle (originally described in 1891 by Jean-Fran\u00e7ois Calot)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9bc7189805334ecb92fd7a820f756ad3x1280x1284.JPEG"
    ]
  },
  {
    "text": "Which type of gallstones is most likely to be seen in the Asian population?",
    "choices": [
      {
        "id": 1,
        "text": "Cholesterol stone"
      },
      {
        "id": 2,
        "text": "Pigment stone"
      },
      {
        "id": 3,
        "text": "Mixed stone"
      },
      {
        "id": 4,
        "text": "Struvite stone"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Struvite stone</strong> (triple phosphate stone) is a type of <strong>renal calculi</strong>. It is made of magnesium, ammonium, and phosphate.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c718ca106c974e85a13e189f1dc96d63x720x930.JPEG"
    ]
  },
  {
    "text": "A 28-year-old obese woman underwent laparoscopic cholecystectomy and the specimen of gallstones removed is given below. Which of the following is least likely to be a risk factor for the formation of this type of gallstone in her?",
    "choices": [
      {
        "id": 1,
        "text": "Prolonged fasting"
      },
      {
        "id": 2,
        "text": "High-caloric diets"
      },
      {
        "id": 3,
        "text": "Oral contraceptive pills"
      },
      {
        "id": 4,
        "text": "Hereditary spherocytosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above image shows <strong>cholesterol</strong><strong>\u00a0gallstones. </strong>Hereditary<strong>\u00a0</strong>spherocytosis is not a risk factor for the formation of cholesterol gallstones. <strong>Hereditary spherocytosis</strong> leads to the production of <strong>black pigment stones.</strong></p>\n<p>Obesity, high-caloric diets, prolonged fasting, certain medications (e.g., oral contraceptives), and resection of the terminal ileum result in <strong>increased secretion of cholesterol</strong> and <strong>supersaturation of bile</strong>. This enhances the lithogenicity of bile.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/124e5b7c4eac4c6c93ee6e8f19c1dd38.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old woman was brought to the casualty with complaints of abdominal pain and vomiting. CT scan of the abdomen revealed the following finding. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Gallstones"
      },
      {
        "id": 2,
        "text": "Empyema gallbladder"
      },
      {
        "id": 3,
        "text": "Common bile duct stones"
      },
      {
        "id": 4,
        "text": "Carcinoma gallbladder"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The CT&nbsp;image shows the <strong>Mercedes-Benz sign</strong>. It is a characteristic sign seen in <strong>gallstones</strong>.</p>\n<p>In gallstone, rarely, the <strong>center</strong> of the <strong>stone</strong> may contain radiolucent <strong>gas</strong> in a <strong>triradiate or biradiate fissure. </strong>This gives rise to characteristic dark shapes on a radiograph called the <strong>Mercedes&ndash;Benz sign </strong>(triradiate sign)<strong> or seagull sign </strong>(biradiate sign).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c908dad341344c0c9883393bb490245c.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/015a1b7cc0f1499b9158e9cc822c3f6cx510x438.GIF"
    ]
  },
  {
    "text": "What percentage of gallstones are radio-opaque?",
    "choices": [
      {
        "id": 1,
        "text": "10%"
      },
      {
        "id": 2,
        "text": "20%"
      },
      {
        "id": 3,
        "text": "30%"
      },
      {
        "id": 4,
        "text": "90%"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Only <strong>10%</strong> of gallstones are <strong>radiopaque</strong>.</p>\n<p>Approximately <strong>90%</strong> of <strong>renal</strong> <strong>stones</strong>, <strong>10%</strong> of <strong>gall</strong> <strong>stones</strong>, and <strong>5%</strong> of <strong>appendicoliths</strong> contain enough calcium to appear <strong>radiopaque</strong> on plain films.</p>\n<p>Gallbladder diseases are regularly diagnosed by <strong>ultrasound</strong> because of the superficial location of the gallbladder and the absence of overlying bowel gas. Ultrasound has a high specificity and sensitivity for cholelithiasis. It is considered as the<strong> first test of choice</strong> for delineation of any biliary pathology. Stones appear acoustically dense and also produce an <strong>acoustic shadow</strong>. They also move with a change in posture. However, CT provides superior anatomic information and therefore is indicated when more anatomic delineation is required.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/da20109037224e43b82a2521c9375607x784x576.JPEG"
    ]
  },
  {
    "text": "While performing the HIDA scan in a patient with gallstones, the gallbladder was not visualized. What could be the possible diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Acute cholecystitis"
      },
      {
        "id": 2,
        "text": "Carcinoma gallbladder"
      },
      {
        "id": 3,
        "text": "Empyema gallbladder"
      },
      {
        "id": 4,
        "text": "Bile duct obstruction"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>&nbsp;</p>\n<p>Unlike bilirubin, <strong>iminodiacetic acid (IDA)</strong> compounds do not undergo conjugation in the hepatocytes. They are rapidly <strong>excreted into the bile</strong>. This enables excellent visualization of the bile ducts and gallbladder within 30&ndash;60 minutes of injection.</p>\n<p>Since <strong>cystic duct obstruction</strong> initiates acute cholecystitis, there is&nbsp;<strong>non-visualization</strong> of the gallbladder 3 - 4 hours after the intravenous injection of 99m Tc-IDA. This is <strong>characteristic of acute cholecystitis</strong>. Thus visualization of the GB establishes cystic duct patency and rules out acute cholecystitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f799b8bb185949a9957dfcca812fd6f6x1228x618.JPEG"
    ]
  },
  {
    "text": "A 25-year-old patient was admitted with right hypochondriac pain and vomiting. USG demonstrates a stone within the bile duct. All of the following clinical features can be seen in this patient except:",
    "choices": [
      {
        "id": 1,
        "text": "Jaundice"
      },
      {
        "id": 2,
        "text": "Dyspepsia"
      },
      {
        "id": 3,
        "text": "Flatulence"
      },
      {
        "id": 4,
        "text": "Murphy\u2019s sign"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Murphy's triad</strong> is associated with acute appendicitis.</p>\n<ul>\n<li>Pain in the right illiac fossa</li>\n<li>Vomiting</li>\n<li>Fever</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e64e66a529844c14ab4f5cb57a444df9x600x774.JPEG"
    ]
  },
  {
    "text": "According to the Tokyo Consensus Guidelines for grading the severity of acute cholecystitis, which of the following conditions is classified under moderate (Grade II) acute cholecystitis?",
    "choices": [
      {
        "id": 1,
        "text": "Presence of cardiovascular dysfunction"
      },
      {
        "id": 2,
        "text": "WBC count > 12000/mm3"
      },
      {
        "id": 3,
        "text": "Right upper quadrant pain"
      },
      {
        "id": 4,
        "text": "Duration of complaints >72 hours"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>If the duration of complaints is <strong>&gt;72 hours</strong>,&nbsp;the patient is classified as having <strong>moderate (Grade II) acute cholecystitis.</strong></p>\n<table style=\"height: 342px; width: 547px;\" border=\"1\">\n<tbody>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\"><strong><strong>Tokyo Consensus Guidelines for&nbsp;</strong></strong><strong>grading the severity of acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade III (severe) acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">Associated with organ dysfunction</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">1. Cardiovascular dysfunction</td>\n<td style=\"width: 274px;\"><strong>Hypotension*</strong> requiring treatment with dopamine <strong>&gt;5 mcg/kg/min</strong>, or any dose of noradrenaline</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">2. Neurological dysfunction</td>\n<td style=\"width: 274px;\">Decreased level of consciousness</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">3. Respiratory dysfunction</td>\n<td style=\"width: 274px;\">PaO<sub>2</sub>/FiO<sub>2</sub>&nbsp;ratio &lt;300</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">4. Renal dysfunction</td>\n<td style=\"width: 274px;\">Oliguria; serum creatinine &gt;2 mg/dL</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">5. Hepatic dysfunction</td>\n<td style=\"width: 274px;\">Prothrombin time (PT-INR)&gt;1.5</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">6. Hematological dysfunction&nbsp;</td>\n<td style=\"width: 274px;\">Platelet count, &lt;100,000/mm<sup>3</sup></td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade II (moderate) acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">\n<p>Associated with dysfunction of any one of the following:</p>\n<ol>\n<li style=\"text-align: left;\">Elevated white blood cell count (&gt;18,000/mm<sup>3</sup>)</li>\n<li>Palpable tender mass in the right upper abdominal quadrant</li>\n<li>Duration of complaints &gt;72 hours</li>\n<li>Marked local inflammation (gangrenous cholecystitis, pericholecystic abscess, hepatic abscess, biliary peritonitis, emphysematous cholecystitis)</li>\n</ol>\n</td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade I (mild) acute cholecystitis&nbsp;</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">\n<p>Does not meet the criteria of grade II or III acute cholecystitis.</p>\n<p>Acute cholecystitis in a healthy person with no organ dysfunction and mild inflammatory changes in the gall bladder, making cholecystectomy a safe and low-risk operative procedure.</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p><br />Acute cholecystitis is treated by keeping the patient <strong>nil per oral (NPO)</strong>, administering&nbsp;<strong>intravenous fluids</strong>,&nbsp;<strong>analgesics</strong>, and <strong>IV&nbsp;antibiotics</strong>.</p>\n<p>The timing of surgery in acute cholecystitis remains controversial:</p>\n<ul>\n<li>If the patient presents <strong>within 3 days</strong>, <strong>emergency cholecystectomy</strong> is done.</li>\n<li>If the patient presents <strong>after 3 days</strong>, <strong>conservative management</strong> is done initially. Once the inflammation subsides, cholecystectomy is performed after 6 weeks (<strong>interval cholecystectomy</strong>).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old man with a past medical history of diabetes mellitus, hypertension and ischemic heart disease presented with fever, nausea and right upper abdominal pain for the past 2 days. On evaluation, he is hypotensive and has a right upper quadrant palpable mass. Laboratory findings are mentioned below. Which of the following is the most appropriate management for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Percutaneous cholecystostomy, followed by interval cholecystectomy"
      },
      {
        "id": 2,
        "text": "Laparoscopic cholecystectomy"
      },
      {
        "id": 3,
        "text": "Conservative management, followed by delayed cholecystectomy after 6 weeks"
      },
      {
        "id": 4,
        "text": "Open cholecystectomy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical vignette is suggestive of <strong>severe acute cholecystitis (grade III)</strong> based on <strong>Tokyo Consensus Guideline.</strong> Patients who have <strong>multiple comorbidities</strong> and present with severely acute cholecystitis should ideally undergo USG guided <strong>percutaneous cholecystostomy</strong>, followed by<strong> interval cholecystectomy</strong> once the condition has been stabilized..</p>\n<table style=\"height: 342px; width: 547px;\" border=\"1\">\n<tbody>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\"><strong>Tokyo Consensus Guidelines for&nbsp;</strong><strong>grading the severity of acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade III (severe) acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">Associated with organ dysfunction</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">1. Cardiovascular dysfunction</td>\n<td style=\"width: 274px;\"><strong>Hypotension*</strong> requiring treatment with dopamine <strong>&gt;5 mcg/kg/min</strong>, or any dose of noradrenaline</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">2. Neurological dysfunction</td>\n<td style=\"width: 274px;\">Decreased level of consciousness</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">3. Respiratory dysfunction</td>\n<td style=\"width: 274px;\">PaO<sub>2</sub>/FiO<sub>2</sub>&nbsp;ratio &lt;300</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">4. Renal dysfunction</td>\n<td style=\"width: 274px;\">Oliguria; serum creatinine &gt;2 mg/dL</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">5. Hepatic dysfunction</td>\n<td style=\"width: 274px;\">Prothrombin time (PT-INR)&gt;1.5</td>\n</tr>\n<tr>\n<td style=\"width: 259px;\">6. Hematological dysfunction&nbsp;</td>\n<td style=\"width: 274px;\">Platelet count, &lt;100,000/mm<sup>3</sup></td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade II (moderate) acute cholecystitis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">\n<p>Associated with dysfunction of any one of the following:</p>\n<ol>\n<li style=\"text-align: left;\">Elevated white blood cell count (&gt;18,000/mm<sup>3</sup>)</li>\n<li>Palpable tender mass in the right upper abdominal quadrant</li>\n<li>Duration of complaints &gt;72 hours</li>\n<li>Marked local inflammation (gangrenous cholecystitis, pericholecystic abscess, hepatic abscess, biliary peritonitis, emphysematous cholecystitis)</li>\n</ol>\n</td>\n</tr>\n<tr>\n<td style=\"width: 533px; text-align: center;\" colspan=\"2\"><strong>Grade I (mild) acute cholecystitis&nbsp;</strong></td>\n</tr>\n<tr>\n<td style=\"width: 533px;\" colspan=\"2\">\n<p>Does not meet the criteria of grade II or III acute cholecystitis.</p>\n<p>Acute cholecystitis in a healthy person with no organ dysfunction and mild inflammatory changes in the gall bladder, making cholecystectomy a safe and low-risk operative procedure.</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Management of cholecystitis</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Nil per oral (NPO)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">IV fluids</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Analgesics</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">IV antibiotics</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Surgery</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\"><strong>Grade III</strong>&nbsp;</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"3\">with comorbidities - a <strong>percutaneous cholecystostomy</strong> can be performed by a radiologist under <strong>ultrasound guidance</strong>. An interval cholecystectomy once the condition has been stabilized.</li>\n<li style=\"font-weight: 400;\" aria-level=\"3\">without comorbidities - unless the patient is extremely hemodynamically unstable, operative intervention (<strong>cholecystectomy</strong>) should be performed.</li>\n</ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\"><strong>Grade I-II&nbsp;</strong></li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"3\">presenting within 3 days - <strong>emergency cholecystectomy</strong> is done.</li>\n<li style=\"font-weight: 400;\" aria-level=\"3\">presenting after 3 days - <strong>conservative</strong> management is done<strong> initially</strong>. Once the inflammation subsides, cholecystectomy is performed after 6 weeks (<strong>interval cholecystectomy</strong>).</li>\n</ul>\n</ul>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A diabetic patient presents with complaints of right upper quadrant pain, fever and nausea. On examination, there is tenderness over the right upper quadrant. CT scan revealed the following finding. What is the most common organism implicated in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Clostridium perfringens"
      },
      {
        "id": 2,
        "text": "Proteus"
      },
      {
        "id": 3,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 4,
        "text": "E. coli"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Note:&nbsp;<strong>E. coli</strong>&nbsp;is the&nbsp;most commonly implicated organism in&nbsp;<strong>acute emphysematous pyelonephritis.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ed1925b6dea44e11af9e5418f2ac4148.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cdecd943642842fd8a4b1bec1ce223e1x1128x1174.PNG"
    ]
  },
  {
    "text": "A patient in the burns ward complains of right hypochondriac pain and fever. USG reveals a thickened, hyperemic gallbladder with sludge formation surrounded by pericholecystic fluid but no gallstones. Which of the following statements is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "CT-guided cholecystostomy is the treatment of choice"
      },
      {
        "id": 2,
        "text": "It has a high mortality rate"
      },
      {
        "id": 3,
        "text": "Murphy's sign will be positive"
      },
      {
        "id": 4,
        "text": "E. coli is the causative agent"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario along with the USG findings point to a diagnosis of&nbsp;<strong>acalculous cholecystitis.</strong> E. coli is not a causative agent of acalculous cholecystitis.&nbsp;</p>\n<p><strong>Acute and chronic inflammation</strong> of the <strong>gallbladder</strong> can occur in the <strong>absence of stones</strong> and are referred to as acalculous cholecystitis.</p>\n<p>It is mainly seen in <strong>critically ill patients</strong> and those recovering from major surgery, trauma, and burns. It has a <strong>high mortality</strong> rate.</p>\n<p>The bacterial infections of the gallbladder causing acalculous cholecystitis include:</p>\n<ul>\n<li>Leptospira</li>\n<li>Streptococcus</li>\n<li>Salmonella</li>\n<li>Vibrio cholerae</li>\n</ul>\n<p>Clinical features are similar to that of acute calculous cholecystitis, such as:</p>\n<div class=\"page\" title=\"Page 1355\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li>Right upper quadrant pain</li>\n<li>Fever</li>\n<li>Positive Murphy's sign</li>\n<li>Leukocytosis</li>\n<li>Sepsis</li>\n</ul>\n<div class=\"page\" title=\"Page 1355\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>A <strong>USG</strong> demonstrates a distended gallbladder with <strong>thickened wall,</strong> <strong>biliary sludge</strong>, <strong>pericholecystic fluid</strong>, and the presence or absence of abscess formation. <strong>HIDA scan</strong>&nbsp;shows a <strong>non-visualization </strong>of the gallbladder.&nbsp;</p>\n<div class=\"page\" title=\"Page 1358\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Acalculous cholecystitis requires urgent intervention. <strong>Percutaneous ultrasound</strong> <strong>or</strong> <strong>CT-guided cholecystostomy</strong> is the treatment of choice for these patients, as they are usually unfit for surgery.</p>\n<p><strong>Cholecystectomy</strong> is performed after the patient has recovered from the underlying illness.</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 25-year-old lady was incidentally found to have gallstones during the abdominal ultrasound. She is otherwise healthy and does not complain of any symptoms. In which of the following clinical scenarios you will not advise her for prophylactic cholecystectomy?",
    "choices": [
      {
        "id": 1,
        "text": "Choledocholithiasis"
      },
      {
        "id": 2,
        "text": "Gallbladder polyp > 1cm"
      },
      {
        "id": 3,
        "text": "Sickle cell disease"
      },
      {
        "id": 4,
        "text": "Presence of a 1.5 cm gallstone"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Prophylactic cholecystectomy</strong> in asymptomatic cholelithiasis is indicated only when <strong>gallstones &gt;3 cm.</strong></p>\n<p>Indications for consideration of <strong>prophylactic cholecystectomy in asymptomatic</strong> patients:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Risk factors for carcinoma</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Choledochal cysts</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Gallbladder adenomas</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Porcelain (calcified) gallbladder</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Solitary gallbladder polyp larger than 1 cm</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Choledocholithiasis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Gallstones &gt;3 cm</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">The patient lives in a remote location from a healthcare facility</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Sickle cell disease/spherocytosis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Transplant or immunosuppressant therapy.</li>\n</ul>\n<p><span style=\"font-size: 10pt;\">Note: Some books also mention \"Prophylactic cholecystectomy is indicated in asymptomatic cholelithiasis when gallstones &gt;2 cm.\"</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Medical therapy for gallstones using ursodeoxycholic acid will be considered in all of the following conditions, except:",
    "choices": [
      {
        "id": 1,
        "text": "If the size of the cholesterol stone is < 10mm"
      },
      {
        "id": 2,
        "text": "If the patient has biliary pain without any complications"
      },
      {
        "id": 3,
        "text": "In recurrent choledocholithiasis after cholecystectomy"
      },
      {
        "id": 4,
        "text": "In the presence of radio-opaque cholesterol gallstones"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Medical therapy using ursodeoxycholic acid (<strong>UDCA</strong>)&nbsp;for gall stones is indicated for <strong>radiolucent cholesterol stones.</strong></p>\n<p>Selection criteria for oral bile acid dissolution therapy:</p>\n<ul>\n<li>Symptomatic patients without complications</li>\n<li>Patients with normal gallbladder functioning and a patent cystic duct</li>\n<li>Patients with <strong>radiolucent</strong> stones and diameter &lt; 10 mm</li>\n</ul>\n<p>Stones &gt;10 mm in size rarely dissolve. Patients with <strong>cholesterol gallstone</strong> disease who develop <strong>recurrent choledocholithiasis after cholecystectomy</strong> should be on long-term treatment with <strong>UDCA</strong>. The dose of UDCA should be <strong>10&ndash;15 mg/kg per day</strong>.</p>\n<p>Pigment stones are non-responsive to UDCA therapy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with symptomatic gallstones but refusing surgery is at risk of developing all of the following complications except:",
    "choices": [
      {
        "id": 1,
        "text": "Intestinal obstruction"
      },
      {
        "id": 2,
        "text": "Diverticulosis"
      },
      {
        "id": 3,
        "text": "Acute cholangitis"
      },
      {
        "id": 4,
        "text": "Acute pancreatitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Diverticulosis is not a complication due to gallstones.</p>\n<p>Clinical <strong>complications</strong> due to&nbsp;<strong>gallstones</strong> include the following:</p>\n<ul>\n<li>Biliary colic</li>\n<li>Acute cholecystitis</li>\n<li>Chronic cholecystitis</li>\n<li>Empyema of the gallbladder</li>\n<li>Mucocele</li>\n<li>Perforation</li>\n<li>Biliary obstruction</li>\n<li>Acute cholangitis</li>\n<li>Acute pancreatitis</li>\n<li>Intestinal obstruction (gallstone ileus).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statement is false regarding the mucocele of the gallbladder?",
    "choices": [
      {
        "id": 1,
        "text": "Caused due to prolonged obstruction of cystic duct"
      },
      {
        "id": 2,
        "text": "Early cholecystectomy needs to be done"
      },
      {
        "id": 3,
        "text": "Obstruction can be seen in the neck of the gallbladder"
      },
      {
        "id": 4,
        "text": "A tender, non palpable gallbladder is characteristic of this condition"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The image below shows empyema of the gallbladder.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cc5b25972774495db03809e9c3b70cf5x499x474.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6066d3c87ca84f9aacd803e8d2dabfd6x1176x720.PNG"
    ]
  },
  {
    "text": "A middle-aged woman with a history of cholelithiasis was rushed to the casualty with complaints of vomiting, abdominal distension, and obstipation. On examination, high-pitched bowel sounds were heard. Her  X-ray erect abdomen is given below. Which statement is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is associated with Rigler's triad"
      },
      {
        "id": 2,
        "text": "Jejunum is the most common site of obstruction"
      },
      {
        "id": 3,
        "text": "CT scan is the investigation of choice"
      },
      {
        "id": 4,
        "text": "Enterotomy is done in the absence of strangulation"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A large gallstone causing gallstone ileus is shown below.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/33f7f5a3b56e4c5aa6ad23c100c88f1b.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1b451cba77094f738f78b2a0e6caa663x527x630.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2c754ee0e6754e3cab693595a2a07819x1280x427.PNG"
    ]
  },
  {
    "text": "In what condition would you see the gallbladder as shown below?",
    "choices": [
      {
        "id": 1,
        "text": "Cholesterolosis"
      },
      {
        "id": 2,
        "text": "Cholesterol polyposis"
      },
      {
        "id": 3,
        "text": "Cholecystitis glandularis proliferans"
      },
      {
        "id": 4,
        "text": "Adenomyomatosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows a <strong>strawberry gallbladder</strong>. Strawberry gallbladder is seen in <strong>cholesterolosis</strong> and is associated with cholesterol stones.</p>\n<p>Cholesterolosis is characterized by&nbsp;<strong>mucosal villous hyperplasia</strong>. The interior of the gallbladder resembles a strawberry. The yellow specks are aggregations of cholesterol crystals and cholesterol esters in the lamina propria. This corresponds to the seeds of a strawberry.</p>\n<p>Option A: <strong>Cholesterol polyposis</strong> - Cholecystography or ultrasonography shows negative shadows in a functioning gallbladder, indicating the presence of a well-defined polyp.</p>\n<p>Options B and C: <strong>Cholecystitis glandularis proliferans/adenomyomatosis</strong> - All layers of the gallbladder wall may be thickened, but sometimes, an incomplete septum forms that separate the hyperplastic from the normal layer. Intraparietal \"mixed\" calculi may be present.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8f9d899e80774b7a82bf94a1d2f06059.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old lady presented with colicky abdominal pain, jaundice and generalized pruritus. She has a palpable gallbladder. Which of the following is the least likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Stone impacted in the cystic duct"
      },
      {
        "id": 2,
        "text": "Stone impacted in the fundus of gallbladder"
      },
      {
        "id": 3,
        "text": "Stone impacted within the gallbladder and common bile duct"
      },
      {
        "id": 4,
        "text": "Carcinoma of the head of the pancreas"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A stone impacted within the fundus of the gallbladder is least likely to cause jaundice with a palpable gallbladder.</p>\n<p>According to <strong>Courvoisier's law</strong>, the presence of a painless, palpable, enlarged gallbladder and mild jaundice, is unlikely due to gallstones. It usually indicates a possibility of <strong>carcinoma</strong> in the <strong>head of the pancreas</strong>. However, apart from a cancer in the pancreatic head, certain other conditions may also cause a palpable gallbladder in presence of jaundice. For example,</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Double impacted</strong> stones (stones in both the cystic duct and the distal common bile duct)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Primary CBD stone</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Oriental cholangiohepatitis\u00a0</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Mirizzi's syndrome</strong> (an impacted gallstone in the <strong>cystic duct</strong> or neck of the gallbladder due to inflammation, causing common bile duct <strong>(CBD) obstruction</strong>, jaundice and a palpable gallbladder)</li>\n</ul>\n<p>These are considered <strong>exceptions</strong> to <strong>Courvoisier's law</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old lady presented with abdominal pain, vomiting and jaundice. Her ALP and direct bilirubin levels were raised. She had undergone laparoscopic cholecystectomy 1 year back. On USG there is dilatation of biliary radicles. Which of the following is the ideal management for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Laparoscopic exploration of common bile duct"
      },
      {
        "id": 2,
        "text": "Open surgical exploration of common bile duct"
      },
      {
        "id": 3,
        "text": "ERCP+Sphincterotomy"
      },
      {
        "id": 4,
        "text": "Addition of ursodeoxycholic acid, followed by repeat USG after 10 days"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given scenario is suggestive of <strong>choledocholithiasis</strong>. When diagnosed<strong> postoperatively</strong> (after cholecystectomy), it should be managed with <strong>ERCP + sphincterotomy.</strong></p>\n<p>Stone detected within 2 years after cholecystectomy is called<strong> retained stone</strong>. Stone detected more than 2 years after cholecystectomy is considered <strong>recurrent stone.</strong></p>\n<p><strong>CBD stone and GB stone detected before cholecystectomy:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">ERCP+Sphincterotomy, followed by laparoscopic cholecystectomy after a few days should be done.</li>\n</ul>\n<p><strong>CBD stone detected during surgery (intraoperatively):</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Laparoscopic cholecystectomy </strong>+<strong> laparoscopic CBD exploration</strong> should ideally be done in the <strong>same sitting</strong> to avoid the need for additional operative sitting and anaesthesia.</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\">A <strong>transcystic approach</strong> is preferred usually.</li>\n<li style=\"font-weight: 400;\" aria-level=\"2\">If there is a small, friable cystic duct; numerous (more than eight) stones in the common bile duct; and large stones (&gt;1 cm), <strong>laparoscopic choledocholithotomy</strong> is performed.</li>\n<li style=\"font-weight: 400;\" aria-level=\"2\">If laparoscopic choledocholithotomy exploration is not feasible, it would necessitate the need for an open CBD exploration.</li>\n</ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">A <strong>T-tube</strong> is placed in the CBD after laparoscopic choledocholithotomy or open CBD exploration. It is followed by a cholangiography to exclude retained stone.</li>\n</ul>\n<p><strong>CBD stone detected after surgery:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Endoscopic removal (<strong>ERCP</strong>) with sphincterotomy is usually the management of choice.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An 80-year-old woman presented with complaints of fatigue. On imaging, she was found to have a scleroatrophic gall bladder with impacted stones in it. A large stone was also present in the common bile duct and the biliary tree is dilated. What is the next step in management?",
    "choices": [
      {
        "id": 1,
        "text": "Immediately take up patient for cholecystectomy"
      },
      {
        "id": 2,
        "text": "Endoscopic retrograde cholangiopancreatography"
      },
      {
        "id": 3,
        "text": "Wait and watch"
      },
      {
        "id": 4,
        "text": "CT scan"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>An 80-year-old woman with imaging showing a <strong>scleroatrophic gall bladder</strong> with <strong>impacted stones</strong> and a <strong>stone in the bile duct</strong> is suggestive of chronic cholelithiasis with choledocholithiasis. <strong>ERCP</strong> is the next line of management for this patient.&nbsp;</p>\n<p>Choledocholithiasis is the presence of stone in the common bile duct (CBD) or biliary tree. It can be primary or secondary:&nbsp;&nbsp;</p>\n<ul>\n<li>Primary stones are formed in the CBD or biliary tree itself and are rare.</li>\n<li>Secondary stones are passed from the gallbladder to the CBD. They are easier to manage than primary stones.</li>\n</ul>\n<p>It can be an asymptomatic and incidental finding or present with features such as jaundice (most common), abdominal pain, and <strong>fatigue</strong>. When there is inflammation of the biliary tree (cholangitis), the patient will have intermittent pain, fever, and jaundice (<strong>Charcot's triad</strong>).&nbsp;</p>\n<p>Investigations:&nbsp;</p>\n<ul>\n<li>Liver function tests will show elevated direct bilirubin and alkaline phosphatase levels.&nbsp;</li>\n<li>Abdominal ultrasound is the first imaging modality done and may show <strong>gallstones</strong> and <strong>dilated bile duct</strong> (&gt;8 mm).&nbsp;</li>\n<li>CT is sensitive for CBD stones. It shows stones, location, ductal stricture or block, ductal dilatation, and intrahepatic biliary changes.</li>\n<li>MRCP is highly sensitive and specific for CBD stones, but it is<strong> only diagnostic</strong> and intervention cannot be performed.</li>\n</ul>\n<p>Management:&nbsp;</p>\n<ul>\n<li><strong>ERCP with sphincterotomy</strong> is the procedure of choice, followed by the removal of stones using a dormia basket or placement of a stent.</li>\n<li>Despite ERCP being an invasive procedure, it has the advantage of being <strong>both a diagnostic and therapeutic procedure</strong> and is more suited for <strong>elderly patients</strong> who cannot tolerate anesthesia and surgery.</li>\n</ul>\n<p>Other options:&nbsp;</p>\n<p>Option A: Cholecystectomy is not recommended for elderly patients, owing to the risk of old age and associated anesthetic and surgical complications.</p>\n<p>Option C: Wait and watch approach can be done for asymptomatic patients, and patients with smaller stones.</p>\n<p>Option D: CT is sensitive for CBD stones, but it is only diagnostic and intervention cannot be performed.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the best investigation in a patient suspected to have an impacted gallstone at the ampulla of Vater?",
    "choices": [
      {
        "id": 1,
        "text": "Computed tomography scan"
      },
      {
        "id": 2,
        "text": "Endoscopic retrograde cholangiopancreatography"
      },
      {
        "id": 3,
        "text": "Endoscopic ultrasound"
      },
      {
        "id": 4,
        "text": "Magnetic resonance cholangiopancreatography"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Endoscopic retrograde cholangiopancreatography&nbsp;(ERCP)</strong> will be the best investigation in the management of <strong>impacted stone</strong> at the <strong>ampulla of</strong> <strong>Vater</strong>. It allows the surgeon to visualize the presence of gallstone at the ampulla of Vater along with the therapeutic extraction of the stone.</p>\n<p>The following image shows an ERCP procedure&nbsp;(endoscope visible).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/71920b64b58c4cae8a7244d407587af7x720x641.PNG"
    ]
  },
  {
    "text": "Which of the following features are part of Reynold's pentad?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2, 3"
      },
      {
        "id": 2,
        "text": "1, 3, 5"
      },
      {
        "id": 3,
        "text": "2, 3, 4"
      },
      {
        "id": 4,
        "text": "1, 3, 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Vomiting and diaphoresis are not part of Reynold's pentad.&nbsp;<strong>Reynold's pentad</strong> is seen in&nbsp;<strong>acute suppurative cholangitis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A jaundiced patient presented with complaints of colicky abdominal pain and itching all over the body. USG abdomen showed thickening of the gallbladder wall and pericholecystic fluid. MRCP showed extrinsic compression of the common bile duct, suggestive of Mirizzi syndrome. Identify the incorrect statement about this condition.",
    "choices": [
      {
        "id": 1,
        "text": "Surgery consists of removing the cystic duct, gallbladder, and the stone"
      },
      {
        "id": 2,
        "text": "Cystic duct obstruction will be present"
      },
      {
        "id": 3,
        "text": "Fistula forms between the gallbladder and common bile duct"
      },
      {
        "id": 4,
        "text": "Palpable gallbladder rules out gallstones"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>A <strong>palpable gallbladder</strong> will not rule out gallstones in <strong>Mirizzi syndrome</strong>. It is an <strong>exception to Courvoisier's law</strong>.</p>\n<p>Courvoisier's law states that in the presence of a <strong>painless</strong>, <strong>palpable, enlarged gallbladder</strong> and mild <strong>jaundice</strong>, the cause is <strong>unlikely to be gallstones</strong>.\u00a0Its exceptions include:</p>\n<ul>\n<li>Double impacted stones (stones in both the cystic duct and the distal common bile duct)</li>\n<li>Primary CBD stone</li>\n<li>Oriental cholangiohepatitis\u00a0</li>\n<li>Mirizzi's syndrome</li>\n</ul>\n<p>In <strong>Mirizzi\u2019s syndrome, gallstones</strong> become impacted in the <strong>cystic duct</strong> or neck of the gallbladder due to inflammation. This causes common bile duct (<strong>CBD</strong>) <strong>obstruction</strong> and jaundice. The <strong>gallbladder</strong> is distended and may be <strong>palpable</strong>.</p>\n<p><strong>ERCP, PTC</strong> (Percutaneous transhepatic cholangiography), or\u00a0<strong>MRCP</strong> will usually demonstrate the characteristic <strong>extrinsic compression of the CBD</strong>.\u00a0</p>\n<p>Surgery consists of removing the cystic duct, diseased gallbladder, and the impacted stone.\u00a0In patients whose gallbladder is densely adherent to the common bile duct, <strong>partial cholecystectomy</strong> should be done.</p>\n<p>If left untreated, a fistula forms between the gallbladder and common bile duct (<strong>cholecysto-choledochal fistula</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Identify the condition.",
    "choices": [
      {
        "id": 1,
        "text": "Cholesterolosis"
      },
      {
        "id": 2,
        "text": "Strawberry gallbladder"
      },
      {
        "id": 3,
        "text": "Gallbladder polyps"
      },
      {
        "id": 4,
        "text": "Gallbladder carcinoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Options A and B: <strong>Cholesterolosis</strong> (<strong>s</strong><strong>trawberry</strong> <strong>gallbladder</strong>) is characterized by the accumulation of lipids (triglycerides, cholesterol precursors and cholesterol esters) in the lamina propria of the gallbladder wall. The nodules are less than 1 mm in diameter and there is mucous villous hyperplasia, which gives it a <strong>coarse</strong>, <strong>yellow</strong> and <strong>granular</strong> appearance, giving it a strawberry-like appearance. The given images below show cholesterolosis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/dbe2a1d8317444f588e2eb0614dcb595.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/64ec8d9f0e824a66b33048308c981be0x358x281.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2e8340a134f94f8b8a488cd497e4fe24x1280x850.JPEG"
    ]
  },
  {
    "text": "A 45-year old lady is found to have a gall bladder polyp of size 1.2cm on abdominal USG. She appears to be healthy and is asymptomatic. How will you manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Regular follow up every 2 months"
      },
      {
        "id": 2,
        "text": "Polypectomy"
      },
      {
        "id": 3,
        "text": "Exploratory laparotomy"
      },
      {
        "id": 4,
        "text": "Cholecystectomy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p class=\"p1\"><span style=\"font-family: verdana, geneva, sans-serif;\"><strong>Gallbladder polyps larger than 1 cm</strong> have an increased risk of malignancy and should be treated by performing a&nbsp;<strong>cholecystectomy.&nbsp;</strong></span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8d1e74e816c14d3aabbe2af0acb5cba4x1280x1634.JPEG"
    ]
  },
  {
    "text": "What is the treatment of choice for the condition shown below?",
    "choices": [
      {
        "id": 1,
        "text": "Cholecystectomy"
      },
      {
        "id": 2,
        "text": "Ursodeoxycholic acid"
      },
      {
        "id": 3,
        "text": "Observation"
      },
      {
        "id": 4,
        "text": "Extended cholecystectomy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The X-ray image shows calcification of the gallbladder, also known as&nbsp;<strong>porcelain gallbladder. </strong>This condition is&nbsp;associated with the risk of gall bladder carcinoma.&nbsp;<strong>Cholecystectomy </strong>is the treatment of choice.</p>\n<p><strong>Extended cholecystectomy</strong> includes&nbsp;removal of the <strong>gall bladder</strong> with&nbsp;a <strong>2 cm non-anatomical wedge of the liver</strong> and <strong>lymphadenectomy</strong>. It is performed for <strong>stage Ib</strong> with perineural, lymphatic, vascular invasion, and <strong>stage II</strong> of gallbladder carcinoma.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/af787f07450f47eca8b8a4836c96d2be.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following are risk factors for gallbladder carcinoma, except:",
    "choices": [
      {
        "id": 1,
        "text": "Salmonella typhi carrier state"
      },
      {
        "id": 2,
        "text": "Cholelithiasis"
      },
      {
        "id": 3,
        "text": "Sclerosing cholangitis"
      },
      {
        "id": 4,
        "text": "Adenomyomatosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Adenomyomatosis is not a risk factor for carcinoma gallbladder.</p>\n<p><strong>Adenomyomatosis</strong> is a <strong>benign</strong>&nbsp;condition of the gallbladder characterized by <strong>hypertrophy of the mucosal epithelium.</strong>&nbsp;It invaginates into the thickened muscularis forming<strong> Rokitansky-Aschoff sinuses.</strong></p>\n<p>Risk factors for carcinoma gallbladder:</p>\n<ul>\n<li><strong>Gallstones of size &gt;3 cm </strong>(most important risk factor)</li>\n<li><strong>Porcelain gallbladder</strong></li>\n<li>Anomalous pancreato-biliary junction</li>\n<li>Choledochal cyst</li>\n<li>Adenomatous polyps</li>\n<li><strong>Primary sclerosing cholangitis</strong></li>\n<li>Obesity</li>\n<li>Salmonella typhii infection.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false regarding gallbladder carcinoma?",
    "choices": [
      {
        "id": 1,
        "text": "Squamous cell carcinoma is the most common type"
      },
      {
        "id": 2,
        "text": "Jaundice is a late feature"
      },
      {
        "id": 3,
        "text": "Depth of invasion is the most important prognostic factor"
      },
      {
        "id": 4,
        "text": "CA 19-9 is used for monitoring"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common type of gallbladder carcinoma is <strong>adenocarcinoma </strong>(80&ndash;90%). Squamous carcinomas also occur and are believed to arise from areas of mucosal squamous metaplasia.</p>\n<p><strong>Gallbladder carcinoma</strong> is a rare malignancy that is seen in the <strong>elderly</strong>. It is associated with a<strong> poor prognosis</strong> and is indistinguishable from cholecystitis or cholelithiasis. It is usually <strong>diagnosed </strong>when patients undergo<strong> cholecystectomy</strong> for gallstones.</p>\n<p>Its clinical features include right upper quadrant pain, nausea, vomiting, and anorexia. <strong>Jaundice</strong> is a <strong>late feature</strong>.&nbsp;<strong>CA 19-9</strong> is elevated in the carcinoma gallbladder and is used for <strong>monitoring</strong>.</p>\n<div class=\"page\" title=\"Page 1232\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 1232\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The <strong>preoperative</strong> diagnosis is often made on <strong>ultrasonography</strong> and followed up by a <strong>CT </strong>scan or<strong> MRI/Magnetic resonance cholangiopancreatography</strong>.</p>\n<p>A <strong>percutaneous biopsy</strong> under radiological guidance is done for pathological examination. PET scanning helps in detecting metastatic disease.</p>\n<p>In select cases, a <strong>laparoscopic examination</strong> is useful in staging the disease. Laparoscopy can also detect peritoneal or liver metastases. The most important prognostic factor is the depth of invasion (T-stage).</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient underwent laparoscopic cholecystectomy for cholelithiasis. Histopathology of the resected gall bladder is reported as Stage T1a of gallbladder cancer. What is the next step in management?",
    "choices": [
      {
        "id": 1,
        "text": "No further treatment"
      },
      {
        "id": 2,
        "text": "Perform extended cholecystectomy"
      },
      {
        "id": 3,
        "text": "Adjuvant chemotherapy"
      },
      {
        "id": 4,
        "text": "Palliative nonsurgical therapy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Cholecystectomy</strong> is sufficient for gallbladder carcinoma with T1a lesions, wherein the tumor penetrates the lamina propria but does not invade the muscle layer.</p>\n<p>Treatment of gallbladder carcinoma (in general):</p>\n<table style=\"height: 272px; width: 407px;\">\n<tbody>\n<tr>\n<td style=\"width: 128.28125px;\"><strong>TNM staging</strong></td>\n<td style=\"width: 263.71875px;\"><strong>Treatment</strong></td>\n</tr>\n<tr>\n<td style=\"width: 128.28125px;\">T<sub>1a</sub></td>\n<td style=\"width: 263.71875px; text-align: left;\">Simple cholecystectomy</td>\n</tr>\n<tr>\n<td style=\"width: 128.28125px;\">T<sub>1b</sub>, T<sub>2</sub>, T<sub>3</sub></td>\n<td style=\"width: 263.71875px; text-align: left;\">Radical cholecystectomy</td>\n</tr>\n<tr>\n<td style=\"width: 128.28125px;\">T<sub>4</sub></td>\n<td style=\"width: 263.71875px; text-align: left;\">Unresectable, chemotherapy and palliative nonsurgical therapy are provided</td>\n</tr>\n<tr>\n<td style=\"width: 128.28125px;\">N<sub>1</sub></td>\n<td style=\"width: 263.71875px; text-align: left;\">Regional lymphadenectomy</td>\n</tr>\n<tr>\n<td style=\"width: 128.28125px;\">N<sub>2</sub></td>\n<td style=\"width: 263.71875px; text-align: left;\">Radical cholecystectomy plus hepatopancreatic duodenectomy</td>\n</tr>\n</tbody>\n</table>\n<p><br />If the carcinoma gall bladder was found incidentally after cholecystectomy:</p>\n<ul>\n<li>Up to stage Ia and stage Ib with negative margins,&nbsp;<strong>standard cholecystectomy</strong> would suffice</li>\n<li>Stage Ib with perineural, lymphatic, vascular invasion and stage II, <strong>extended cholecystectomy</strong> should be performed</li>\n</ul>\n<div class=\"page\" title=\"Page 1232\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>If the initial procedure was performed laparoscopically, the surgeon should examine the laparoscopic port sites. The finding of disease at the port sites is a sign of generalized peritoneal disease and carries a very poor prognosis. However,&nbsp;<strong>resection of port sites </strong>is<strong> no longer recommended.</strong></p>\n<p>Chemotherapy is not required in early gall bladder cancer. Radiation has no role.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '31 Gall Bladder';
        const quizFilename = '31-gall-bladder-7a6e472c.html';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>