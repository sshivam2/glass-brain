<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>22 Gas Transport In Blood - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Physiology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is correct?",
    "choices": [
      {
        "id": 1,
        "text": "PT = nRV"
      },
      {
        "id": 2,
        "text": "V = PnRT"
      },
      {
        "id": 3,
        "text": "P = VnRT"
      },
      {
        "id": 4,
        "text": "PV = nRT"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Boyle&rsquo;s law </strong>states that, at a given temperature,<strong> the product of pressure time&rsquo;s volume for a gas is constant</strong>.</p>\n<p><strong>PV = nRT</strong></p>\n<table style=\"height: 309px; width: 489px;\">\n<tbody>\n<tr>\n<td style=\"width: 177px;\">\n<p>Boyle's law:</p>\n<ul>\n<li>At a given temperature, the product of pressure times volume for a gas is constant</li>\n<li>PV=nRT</li>\n</ul>\n<p>Charles law:</p>\n<ul>\n<li>At constant&nbsp;pressure,&nbsp;the volume occupied by a fixed mass of gas is proportional to temperature</li>\n<li>V/T = constant</li>\n</ul>\n<p>Dalton's Law:</p>\n<ul>\n<li>It states that the partial pressure of a gas in a mixture of gases is the pressure that gas would exert if it occupied the total volume of the mixture.</li>\n<li>Partial pressure is the total pressure multiplied by the fractional concentration of dry gas.</li>\n</ul>\n<p>Henry's Law:</p>\n<ul>\n<li>The amount of gas dissolved is directly proportional to the partial pressure of the gas with which it is in equilibrium.</li>\n</ul>\n<p>Graham's Law:</p>\n<ul>\n<li>The rate of diffusion of a gas is inversely proportional to molecular weight.</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Transport of CO is diffusion limited because_____",
    "choices": [
      {
        "id": 1,
        "text": "Alveolar membrane is less permeable to CO"
      },
      {
        "id": 2,
        "text": "High affinity of CO to hemoglobin"
      },
      {
        "id": 3,
        "text": "CO crosses epithelial barrier slowly"
      },
      {
        "id": 4,
        "text": "None"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Transport of CO is diffusion limited because of the <strong>high affinity of CO to hemoglobin.</strong></p>\n<p><strong>Diffusion across the alveolocapillary membrane:</strong></p>\n<ul>\n<li>Blood takes <strong>0.75s </strong>to traverse pulmonary capillaries.</li>\n<li><strong>CO</strong> diffuses into blood and <strong>combines with Hb with very high affinity</strong>. Thus the partial pressure of CO doesn't rise (Only dissolved form of gas can increase the partial pressure, Gas which combines with Hb or plasma proteins cannot). Partial pressure gradient necessary for diffusion of CO is maintained for the whole 0.75s and hence it is <strong>D</strong><strong>iffusion limited.</strong></li>\n<li>In the case of <strong>N<sub>2</sub>O </strong>it&nbsp;does not react and reaches equilibrium in about <strong>0.1s</strong>. The amount of N<sub>2</sub>O taken up is not limited by diffusion but by the amount of blood flowing through the pulmonary capillaries; that is, it is <strong>F</strong><strong>low-limited.</strong></li>\n<li><strong>O<sub>2</sub></strong>&nbsp;is intermediate between&nbsp;N<sub>2</sub>O and CO; it is taken up by haemoglobin, but much less avidly than CO, and it reaches equilibrium with capillary blood in about <strong>0.3 s</strong>. Thus, its uptake is <strong>Perfusion-limited</strong>.</li>\n</ul>\n<p>In the case of perfusion limited gases, an increase in pulmonary blood flow increases the amount of gas transferred. Hence O2 transport increases with an increase in pulmonary blood flow.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the percentage of O2 carried, chemically bound to Hb?",
    "choices": [
      {
        "id": 1,
        "text": "97%"
      },
      {
        "id": 2,
        "text": "3%"
      },
      {
        "id": 3,
        "text": "37%"
      },
      {
        "id": 4,
        "text": "66%"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Remember:</p>\n<p><strong>Gases are transported in 3 forms:</strong></p>\n<ul>\n<li><strong>Dissolved gas</strong> - This is the form which <strong>contributes to partial pressure</strong>. <strong>Nitrogen</strong> is carried only in dissolved form in blood.</li>\n<li><strong>Bound gas</strong> - O<sub>2</sub>, CO are bound to Hb in RBC; CO<sub>2</sub> is bound to Hb in RBC as well as plasma protein.</li>\n<li><strong>Chemically modified gas</strong> - CO2 in the form of HCO<sub>3</sub>-.</li>\n</ul>\n<p><strong>Total gas concentration</strong> in solution is the <strong>sum</strong> of dissolved gas plus bound gas plus chemically modified gas.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The presence of hemoglobin in normal arterial blood increases its O2 concentration approximately by how many times?",
    "choices": [
      {
        "id": 1,
        "text": "70"
      },
      {
        "id": 2,
        "text": "10"
      },
      {
        "id": 3,
        "text": "30"
      },
      {
        "id": 4,
        "text": "40"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The presence of hemoglobin in normal arterial blood increases its O2 concentration approximately by 70 times</p>\n<ul>\n<li>Normal arterial blood has <strong>Po<sub>2</sub> of about 100 mm Hg.</strong></li>\n</ul>\n<p>Amount of O<sub>2</sub> transported in dissolved form (Calculated by using&nbsp;<strong>Henry's law):</strong></p>\n<ul>\n<li><strong>Concentration of dissolved O<sub>2</sub></strong> = Partial pressure of O<sub>2</sub>&nbsp;&times; solubility of O<sub>2</sub> = 100 mmHg&nbsp;&times;&nbsp;0.003 mL O<sub>2</sub>/100 mL blood per mm Hg&nbsp;=<strong>&nbsp;0.3 mL O<sub>2</sub>/100 mL</strong></li>\n<li>Hence<strong> 1L of plasma has 3mL of 0<sub>2</sub> in dissolved form.</strong></li>\n<li><strong>5L&nbsp;</strong>of plasma can carry maximum <strong>15mL of 0<sub>2</sub>.</strong></li>\n<li>At rest,&nbsp;<strong>O<sub>2</sub> demand</strong> is around <strong>250mL/min.&nbsp;</strong></li>\n<li>Hence dissolved O<sub>2</sub> alone is not sufficient to meet body demands.</li>\n</ul>\n<p>Amount of O<sub>2</sub> transported bound to Hb:</p>\n<ul>\n<li>Concentration of Hb is <strong>15g/100 mL</strong></li>\n<li><strong>Each gram</strong> of Hb binds to <strong>1.34 mL of O<sub>2</sub></strong></li>\n<li>Hence, 15 g binds to 20.1mL of O<sub>2</sub>/100 mL</li>\n<li>On average, the <strong>15 g of hemoglobin in 100 mL of blood</strong> can <strong>combine with a total of about 20 mL of O<sub>2</sub>.</strong></li>\n</ul>\n<p>Thus, this value (20.1) in the presence of Hb is about 70 times the value (0.3) in the absence of Hb.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "O2 delivery to tissues depends on all except_____",
    "choices": [
      {
        "id": 1,
        "text": "Type of fluid administered"
      },
      {
        "id": 2,
        "text": "Hemoglobin"
      },
      {
        "id": 3,
        "text": "Ventilation"
      },
      {
        "id": 4,
        "text": "Cardiac output"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Oxygen delivery is the volume of oxygen delivered to the systemic vascular bed per minute. It is the product of the cardiac output and the arterial oxygen concentration.</p>\n<p>Oxygen delivery to tissue depends on (refer flow chart)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/31540bb5ba9a4ebdb4d4b8b5a9314beex1020x956.JPEG"
    ]
  },
  {
    "text": "Each molecule of hemoglobin carries ______ molecules of O2.",
    "choices": [
      {
        "id": 1,
        "text": "2"
      },
      {
        "id": 2,
        "text": "4"
      },
      {
        "id": 3,
        "text": "8"
      },
      {
        "id": 4,
        "text": "16"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Hemoglobin has <strong>4 subunits</strong> each of which has heme molecule and polypeptide chain. Ferrous in heme binds to a molecule of O<sub>2</sub>. Hence, hemoglobin binds to 4 molecules of O<sub>2</sub>.</p>\n<ul>\n<li>Hemoglobin is a protein made up of <strong>four subunits.</strong></li>\n<li><strong>Each subunit</strong>&nbsp;contains a <strong>heme moiety attached to a polypeptide chain</strong>.</li>\n<li><strong>Heme</strong> is a <strong>porphyrin ring</strong> complex that includes <strong>one atom of ferrous iron.</strong></li>\n<li>In normal adults, most of the hemoglobin molecules contain <strong>two &alpha; and two &beta; chains.</strong></li>\n<li>Each of the four iron atoms in hemoglobin can reversibly bind one O<sub>2</sub>. The <strong>iron stays in the ferrous state</strong> so that the reaction is <strong>oxygenation </strong>(not oxidation).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Most of the CO2 transported in the arterial blood is in the form of_____",
    "choices": [
      {
        "id": 1,
        "text": "HCO3-"
      },
      {
        "id": 2,
        "text": "Attached to haemoglobin"
      },
      {
        "id": 3,
        "text": "Carbamino compounds"
      },
      {
        "id": 4,
        "text": "Carbonic acid (H2CO3)"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>CO<sub>2</sub> is carried in the blood in <strong>three forms:</strong></p>\n<ul>\n<li><strong>Bicarbonate (HCO<sub>3</sub><sup>\u2212</sup>)\u00a0- Quantitatively the most important(70%)</strong></li>\n<li><strong>Carbaminohemoglobin (23%)</strong></li>\n<li><strong>Dissolved CO<sub>2</sub> (7%)</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements about hemoglobin is false?",
    "choices": [
      {
        "id": 1,
        "text": "The T configuration of Hb does not favor O2 binding"
      },
      {
        "id": 2,
        "text": "The R configuration of Hb does not favor O2 binding"
      },
      {
        "id": 3,
        "text": "The R configuration of Hb favors O2 binding"
      },
      {
        "id": 4,
        "text": "Each Hb molecules carries 4 oxygen molecules"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A <strong>relaxed</strong> <strong>(R) configuration, </strong>exposes more O<sub> 2</sub> binding sites.</p>\n<p>The quaternary structure of hemoglobin determines its affinity for O<sub>2</sub>.</p>\n<p>In deoxyhemoglobin, the globin units are tightly bound in a <strong>tense (T) configuration, </strong>which <strong>reduces the affinity of the molecule for O<sub>2</sub>.</strong></p>\n<p>When O <sub>2</sub> is first bound, the bonds holding the globin units are released, producing a <strong>relaxed</strong> <strong>(R) configuration, </strong>which exposes more O<sub>2</sub> binding sites. The net result is a 500-fold increase in O<sub>2</sub></p>\n<p>In tissues, these reactions are reversed, resulting in O<sub>2&nbsp; <span style=\"font-size: 12pt;\"><strong>dissociation </strong></span></sub>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4802269477ce4187b9675eabb5b76d2ex1280x1009.JPEG"
    ]
  },
  {
    "text": "The oxygen-haemoglobin dissociation curve is sigmoid shape because_____",
    "choices": [
      {
        "id": 1,
        "text": "Binding of one O2 molecule increases the affinity of binding of subsequent O2 molecules"
      },
      {
        "id": 2,
        "text": "Binding of one O2 molecule decreases the affinity of binding of subsequent O2 molecules"
      },
      {
        "id": 3,
        "text": "Bohr effect"
      },
      {
        "id": 4,
        "text": "Haldane effect"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The oxygen-haemoglobin dissociation curve is <strong>sigmoid shape</strong> because binding of one O2 molecule <strong>increases the affinity</strong> of binding of subsequent O2 molecules.</p>\n<p>The <strong>oxygen-hemoglobin dissociation curve </strong>relates per&shy;centage saturation of the O<sub>2 </sub>carrying power of hemoglobin (abbreviated as SaO<sub>2</sub>) to the Po<sub>2.&nbsp;</sub>It<strong>&nbsp;</strong>has a <strong>characteristic sigmoid shape</strong> due to the <strong>T&ndash;R interconversion.&nbsp;</strong>Combination of the first heme in the Hb molecule with O<sub>2</sub> increases the affinity of the second heme for O<sub>2</sub> and oxygenation of the second increases the affinity of the third, and so on, such that the affinity of Hb for the fourth O<sub>2</sub> molecule is many times that for the first <strong>(Positive Co-operative Effect).</strong></p>\n<p><strong>Option C:&nbsp;</strong>The effect of PCO<sub>2</sub> and pH on the O<sub>2</sub>-hemoglobin dissociation curve is called the Bohr effect.</p>\n<p><strong>Option D:&nbsp;</strong>O<sub>2</sub> bound to hemoglobin changes its affinity for CO<sub>2</sub>, such that when less O<sub>2</sub> is bound, the affinity of hemoglobin for CO<sub>2</sub> increases. This is referred to as the Haldane effect.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Hb would be expected to become 100% saturated with oxygen at Po2 of (in mmHg)_____",
    "choices": [
      {
        "id": 1,
        "text": "75"
      },
      {
        "id": 2,
        "text": "90"
      },
      {
        "id": 3,
        "text": "100"
      },
      {
        "id": 4,
        "text": "760"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>When blood is equilibrated with 100% O<sub>2</sub>, the normal hemoglobin becomes 100% saturated.</p>\n<ul>\n<li>In vivo, the hemoglobin in the blood at the end of the pulmonary capillaries is about 97.5% saturated with O<sub>2</sub> (Po2 = 100 mm Hg).</li>\n<li>Because of a slight admixture with venous blood that bypasses the pulmonary capillaries <strong>(i.e,</strong> <strong>physiologic shunt),</strong> the hemoglobin in systemic arterial blood is only 97% saturated.</li>\n<li>Graph relates the percentage of saturated hemoglobin (SaO<sub>2</sub>) to PO<sub>2 </sub>and dissolved O<sub>2.</sub></li>\n</ul>\n<table style=\"height: 115px;\" width=\"365\">\n<tbody>\n<tr>\n<td style=\"width: 174px;\">Partial pressure of O2</td>\n<td style=\"width: 175px;\">Corresponding SpO2</td>\n</tr>\n<tr>\n<td style=\"width: 174px;\">100</td>\n<td style=\"width: 175px;\">99 - 100%</td>\n</tr>\n<tr>\n<td style=\"width: 174px;\">60</td>\n<td style=\"width: 175px;\">89%</td>\n</tr>\n<tr>\n<td style=\"width: 174px;\">40</td>\n<td style=\"width: 175px;\">75%</td>\n</tr>\n<tr>\n<td style=\"width: 174px;\">27</td>\n<td style=\"width: 175px;\">50%</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c32a21bda6e046b893b34572369a2189x439x413.JPEG"
    ]
  },
  {
    "text": "The normal value of P50 in an adult is(mm Hg)______",
    "choices": [
      {
        "id": 1,
        "text": "27"
      },
      {
        "id": 2,
        "text": "45"
      },
      {
        "id": 3,
        "text": "10"
      },
      {
        "id": 4,
        "text": "100"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Normal P<sub>50</sub></strong> is about <strong>27 mm of Hg for adult Hb.</strong></p>\n<p>P<sub>50</sub>&nbsp;is the partial pressure of O<sub>2</sub> at which Hb is 50 % saturated.&nbsp;P<sub>50</sub> is an index of the affinity of Hb with O<sub>2</sub>.</p>\n<p>Higher the P<sub>50</sub> value, lower is the affinity: Oxygen-Hemoglobin Dissociation Curve shifts to right.</p>\n<p>Lower the P<sub>50</sub>&nbsp;value, the higher is the affinity:&nbsp;Oxygen-Hemoglobin Dissociation Curve shifts to left.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/94f708da8d5a4f50ae848a5139c80c03x639x541.PNG"
    ]
  },
  {
    "text": "Decrease in pH shifts the oxygen dissociation curve to_____",
    "choices": [
      {
        "id": 1,
        "text": "Right"
      },
      {
        "id": 2,
        "text": "Left"
      },
      {
        "id": 3,
        "text": "Doesn\u2019t affect"
      },
      {
        "id": 4,
        "text": "On either side depending on other factors"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The pH decreasing from the normal value shifts the O<sub>2</sub>-hemoglobin dissociation curve, to the right.</p>\n<p><strong>Oxygen-Hb dissociation curve (OHDC)</strong></p>\n<ul>\n<li>This is a <strong>plot of the partial pressure of O<sub>2</sub> and the % saturation of Hb with O<sub>2</sub></strong>.</li>\n<li>It is normally <strong>sigmoid-shape.</strong></li>\n<li>If OHDC is shifted to the right, it means that affinity of Hb for O<sub>2</sub> has become less (which favors O<sub>2</sub> delivery) i.e. Higher the P<sub>50</sub>. (<strong>R - R</strong>ight shift&nbsp;<strong>R</strong>eleases oxygen)</li>\n</ul>\n<p><strong>Shift to the right is caused by: </strong>(Conditions with increased requirement of O2 - metabolically active tissues)</p>\n<ul>\n<li>Hypoxia and Hypercarbia - Metabolically active tissues utilise O<sub>2</sub> and tissues produce CO<sub>2</sub></li>\n<li>&darr; pH - Secondary to increased CO<sub>2</sub> production</li>\n<li>&uarr; in temperature, heat&nbsp;</li>\n<li>&uarr; in 2,3-DPG - increased anaerobic glycolysis</li>\n<li>Growth hormone, thyroid hormone, androgen - by increasing 2,3 DPG</li>\n<li>Sickle cell anaemia - reduced affinity for O<sub>2</sub></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e0af2591c1b248b28d22ee452a48616bx600x647.JPEG"
    ]
  },
  {
    "text": "Four molecules of myoglobin will bind how many molecules of oxygen?",
    "choices": [
      {
        "id": 1,
        "text": "4"
      },
      {
        "id": 2,
        "text": "16"
      },
      {
        "id": 3,
        "text": "1"
      },
      {
        "id": 4,
        "text": "8"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>4 molecules of myoglobin will bind 4 molecules of oxygen.</p>\n<ul>\n<li><strong>Myoglobin: </strong>This is present in skeletal muscles.</li>\n<li>1 molecule of myoglobin binds 1 molecule of O<sub>2</sub>. Thus, 4 molecules of myoglobin will bind 4 molecules of oxygen</li>\n<li><strong>The shape of O<sub>2</sub>-myoglobin dissociation curve is the rectangular hyperbola</strong>. It lies to the left of Oxygen-Hemoglobin Dissociation Curve (OHDC)(refer figure).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0ba185f28d3e41d19cfc15407dc051c0x1280x1345.JPEG"
    ]
  },
  {
    "text": "Bohr effect",
    "choices": [
      {
        "id": 1,
        "text": "Facilitates O2 transport"
      },
      {
        "id": 2,
        "text": "Facilitates CO2 transport"
      },
      {
        "id": 3,
        "text": "Facilitates chloride transport"
      },
      {
        "id": 4,
        "text": "None"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"page\" title=\"Page 654\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Facilitation of oxygen transport</strong> depends on the oxygen-hemoglobin dissociation curve, explained by the Bohr effect.&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n<p>When the metabolic activity of tissues increases, the production of&nbsp;<strong>CO<sub>2 </sub>increases</strong>. This&nbsp;CO<sub>2 </sub>diffuses into the blood and in turn, raises the blood H<sub>2</sub>CO<sub>3</sub> and causes an <strong>increase in the H<sup>+</sup> </strong>concentration and a decrease in pH. This <strong>decreases the affinity</strong> of Hb for O<sub>2, </sub>shifting the O<sub>2</sub>- hemoglobin dissociation curve to the right. This facilitates the <strong>unloading of O<sub>2</sub> in the tissues.</strong> The effect of Pco<sub>2</sub> and pH on O<sub>2</sub> hemoglobin dissociation curve is called <strong>the Bohr Effect. </strong></p>\n<p>Conversely, in the lungs, CO<sub>2</sub> diffuses from the blood to the alveoli&nbsp;and the H<sup>+</sup> concentration decreases and theO<sub>2</sub> hemoglobin dissociation curve shifts to the left increasing the affinity of Hb to O<sub>2</sub>.</p>\n<p>Note:&nbsp;</p>\n<p><strong>Double Bohr effect occurring in the placenta:</strong> Oxygen&ndash;hemoglobin dissociation curve of fetal blood and maternal blood move in opposite directions.</p>\n<p><strong> Mechanism:</strong></p>\n<ul>\n<li>The fetal blood entering the placenta carries large amounts of carbon dioxide, but most of it<strong>&nbsp;diffuse from the fetal blood into the maternal blood. </strong></li>\n<li><strong>Fetal blood</strong> - loss of CO<sub>2</sub> - reduced H<sup>+</sup> - <strong>shift to left</strong> - loading of O<sub>2</sub> i.e. <strong>oxygenation of fetal Hb.</strong></li>\n<li><strong>Maternal blood</strong> - increase in CO<sub>2</sub> - increase in H<sup>+</sup> - <strong>shift to the right</strong> - <strong>Release of oxygen.</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The level of 2,3 \u2013DPG is decreased in______",
    "choices": [
      {
        "id": 1,
        "text": "Anemia"
      },
      {
        "id": 2,
        "text": "Acidosis"
      },
      {
        "id": 3,
        "text": "High altitude"
      },
      {
        "id": 4,
        "text": "Exercise"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The level of 2,3&ndash;DPG is decreased in <strong>acidosis</strong>.</p>\n<p>2,3-DPG is produced from 3-phosphoglycerate which is a product of glycolysis. Acidosis <strong>inhibits</strong> red cell <strong>glycolysis</strong> which <strong>decreases</strong> the levels of 2,3-DPG<strong>.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "High affinity of HbF to O2 is due to_____",
    "choices": [
      {
        "id": 1,
        "text": "Decreased binding with 2,3-DPG"
      },
      {
        "id": 2,
        "text": "Increased binding with 2,3-DPG"
      },
      {
        "id": 3,
        "text": "Increase in pH"
      },
      {
        "id": 4,
        "text": "Decrease in concentration of Hb"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Increased affinity of HbF to O<sub>2</sub> is </strong>due to <strong>decreased affinity of&nbsp;&gamma; chains of HbF to 2,3DPG.</strong></p>\n<p><strong>HbF</strong> is the <strong>fetal variant</strong> of hemoglobin.</p>\n<p>The <strong>&beta; chains</strong> of adult hemoglobin (hemoglobin A) are <strong>replaced by &gamma; chains</strong> in HbF. This modification results in <strong>increased affinity of hemoglobin for O<sub>2</sub></strong>, a <strong>left shift</strong> of the O<sub>2</sub>-hemoglobin dissociation curve, and decreased P50.<br />The <strong>mechanism of the left shift is based on the binding of 2,3-DPG</strong>. 2,3-DPG does not bind as avidly to the &gamma; chains of HbF as it binds to the &beta; chains of hemoglobin A. When <strong>less 2,3-DPG is bound, the affinity for O<sub>2</sub> increases and facilitates the movement of O<sub>2</sub> from the mother to the fetus.</strong></p>\n<p>This increased affinity is beneficial to the fetus, whose PaO<sub>2</sub> is low (approximately 40 mm Hg).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Haldane effect is _______",
    "choices": [
      {
        "id": 1,
        "text": "Binding of O2 to Hb favours release of CO2"
      },
      {
        "id": 2,
        "text": "Binding of CO2 to Hb favours release of O2"
      },
      {
        "id": 3,
        "text": "HCO3- leaving RBC in exchange for Cl-"
      },
      {
        "id": 4,
        "text": "None of the above"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Binding of O<sub>2 </sub>with hemoglobin tends to displace CO<sub>2 </sub></strong>from the blood. This effect is called the <strong>Haldane effect. </strong>(Remember - Haldane effect occurs in lungs and causes&nbsp;left shift of O2-Hb dissociation curve)</p>\n<p><strong>Haldane Effect</strong></p>\n<ul>\n<li>Binding of O<sub>2 </sub>with hemoglobin tends to displace CO<sub>2 </sub>from the blood. This effect, called the Haldane effect, is important in promoting CO<sub>2</sub> transport.</li>\n<li>The Haldane effect results from the simple fact that the combination of O<sub>2</sub> with hemoglobin in the lungs causes the hemoglobin to become a stronger acid. This displaces CO<sub>2</sub> from the blood and into the alveoli.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are comparing the packed cell volume (PCV) obtained from an arterial and venous blood sample of the same patient. Why is PCV higher in venous blood?",
    "choices": [
      {
        "id": 1,
        "text": "Haldane effect"
      },
      {
        "id": 2,
        "text": "Bohr effect"
      },
      {
        "id": 3,
        "text": "Chloride shift"
      },
      {
        "id": 4,
        "text": "Affinity of Hb to 2,3-DPG"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<ul>\n<li>Upon entering the red blood cell, <strong>CO<sub>2</sub> </strong>is rapidly<strong> hydrated to H<sub>2</sub>CO<sub>3</sub> </strong>by carbonic&nbsp;anhydrase.</li>\n<li>H<sub>2</sub>CO<sub>3</sub> is in equilibrium with <strong>H<sup>+</sup></strong> and its conjugate base, <strong>HCO<sub>3</sub><sup>-</sup></strong>.</li>\n<li><strong>H<sup>+</sup> </strong>can interact with<strong> deoxyhemoglobin</strong>, whereas <strong>HCO<sub>3</sub><sup>-</sup> </strong>can be<strong> transported outside of the cell </strong>via anion exchanger 1 (AE1 or Band 3).</li>\n<li>In effect, <strong>for each CO<sub>2</sub> molecule</strong> that enters the red cell, there is<strong> an additional HCO<sub>3</sub><sup>-</sup> or Cl<sup>-</sup> </strong>in the cell.</li>\n<li>Because of this <strong>chloride shift</strong>, the <strong>Cl <sup>&ndash;</sup> content of the red cells in venous blood is significantly greater than</strong> that in arterial blood.</li>\n<li>Note that <strong>for each CO<sub>2</sub> molecule added to a red cell</strong>, there is an <strong>increase of one osmotically active particles in the cell - either a HCO <sub>3</sub> <sup>&ndash; </sup>or a Cl <sup>&ndash; </sup></strong>ion. Consequently, <strong>the red cells take up water and increase in size</strong>.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c1d18e71705d452b9784f20e4f635e58x1280x1369.JPEG"
    ]
  },
  {
    "text": "What makes CPDA superior than ACD for blood storage:",
    "choices": [
      {
        "id": 1,
        "text": "The fall in 2, 3 DPG is less"
      },
      {
        "id": 2,
        "text": "Decreased release of O2"
      },
      {
        "id": 3,
        "text": "It has less P50"
      },
      {
        "id": 4,
        "text": "It is less acidic"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The fall in 2, 3 DPG is less when the blood is stored in CPDA compared with ACD.</p>\n<p><strong>2, 3 DPG</strong> (2,3-diphosphoglycerate) binds to&nbsp;<strong>deoxygenated</strong> <strong>haemoglobin</strong>. Therefore, an increase in 2,3 DPG causes increased release of O<sub>2</sub>&nbsp;to the tissues. The equilibrium&nbsp;between Hb and O<sub>2</sub> can be understood from the following equation:</p>\n<div class=\"page\" title=\"Page 642\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>HbO<sub>2</sub></strong> + 2,3-DPG <strong>\u21c4</strong> <strong>Hb</strong>&minus;2,3-DPG + <strong>O<sub>2</sub></strong></p>\n<p>In stored blood, the 2,3 DPG levels usually fall. As a result, stored blood releases less oxygen to the tissues than the normal circulating blood, thus limiting its use in hypoxic patients (Eg: anaemia).</p>\n<p>However, such a<strong> fall in 2,3 DPG is less</strong> when it is stored in a phosphate-containing solution like <strong>CPDA</strong> (Citrate, phosphate, dextrose, adenine), rather than <strong>ACD</strong> (Acid citrate dextrose). Therefore, the blood stored in CPDA, in comparison with blood stored in ACD has:</p>\n<ul>\n<li>Higher 2,3 DPG concentration</li>\n<li>More amount of deoxygenated blood bound to 2,3 DPG</li>\n<li>Decreased affinity of Hb to the oxygen.</li>\n<li><strong>Increased release of oxygen</strong> to the tissues.</li>\n<li><strong>Raised</strong> <strong>P50</strong> (PO2 at which Hb is half saturated)</li>\n<li>Shift in O2-Hb dissociation curve to the right</li>\n</ul>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The oxygen carrying capacity of a 18 year old boy with haemoglobin of 14g/dl is",
    "choices": [
      {
        "id": 1,
        "text": "22"
      },
      {
        "id": 2,
        "text": "16"
      },
      {
        "id": 3,
        "text": "14"
      },
      {
        "id": 4,
        "text": "18"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The oxygen carrying capacity of a boy with haemoglobin 14g/dl is <strong>18.</strong></p>\n<p>When blood is saturated with 100% O2, the haemoglobin is also 100% saturated and each gram of normal haemoglobin contains 1.39 mL of O2.</p>\n<p>However, blood normally contains some inactive haemoglobin derivatives, and the measured value in vivo is thus slightly lower hence, each gram of haemoglobin in vivo contains&nbsp;<strong>1.31 mL of O2 (Hufner&rsquo;s constant).</strong></p>\n<p>According to the above question, when Hb=14g/dl, O2= 1.31*14= <strong>18.34</strong>&nbsp;</p>\n<p><strong>The oxygen-hemoglobin dissociation curve</strong></p>\n<ul>\n<li>Demonstrates a progressive increase in the percentage of haemoglobin bound with oxygen as blood Po2 increases, which is called the percent saturation of haemoglobin.</li>\n<li>Blood leaving the lungs and entering the systemic arteries usually has a Po2 of about 95 mm Hg, the usual oxygen saturation of systemic arterial blood averages 97 per cent.</li>\n<li>Conversely, in normal venous blood returning from the peripheral tissues, the Po2 is about 40 mm Hg, and the saturation of haemoglobin averages 75 per cent.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e4c790e02e4c4d2f876f56db4b32e281x500x417.JPEG"
    ]
  }
];
        let quizName = '22 Gas Transport In Blood';
        let hierarchy = ["Marrow", "qBank", "Physiology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>