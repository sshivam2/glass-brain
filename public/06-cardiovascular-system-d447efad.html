<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06 Cardiovascular System - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Radiology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "On a chest x-ray, which of the following structures does not make up the right cardiac border?",
    "choices": [
      {
        "id": 1,
        "text": "SVC"
      },
      {
        "id": 2,
        "text": "IVC"
      },
      {
        "id": 3,
        "text": "Right atrium"
      },
      {
        "id": 4,
        "text": "Right ventricle"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The heart has\u00a0<strong>four</strong>\u00a0<strong>borders.</strong></p>\n<table style=\"height: 142px; width: 289.21875px;\">\n<tbody>\n<tr>\n<td style=\"width: 69.7812px; text-align: left;\">Cardiac border</td>\n<td style=\"width: 190.844px; text-align: left;\">Structures</td>\n</tr>\n<tr>\n<td style=\"width: 69.7812px; text-align: left;\">Superior</td>\n<td style=\"width: 190.844px; text-align: left;\">\n<ul>\n<li>Right atrium</li>\n<li>Left atrium</li>\n<li>Great vessels</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 69.7812px; text-align: left;\">Right</td>\n<td style=\"width: 190.844px; text-align: left;\">\n<ul>\n<li>Right atrium</li>\n<li>SVC</li>\n<li>IVC</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 69.7812px; text-align: left;\">Left\u00a0</td>\n<td style=\"width: 190.844px; text-align: left;\">\n<ul>\n<li>Left atrial appendage</li>\n<li>Left ventricle</li>\n<li>Aortic knuckle</li>\n<li>Subclavian artery</li>\n<li>Pulmonary artery segment</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 69.7812px; text-align: left;\">Inferior</td>\n<td style=\"width: 190.844px; text-align: left;\">\n<ul>\n<li>Left ventricle</li>\n<li>Right ventricle</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>\n<p>The<strong>\u00a0right</strong>\u00a0<strong>ventricle</strong>\u00a0is the most\u00a0<strong>anteriorly</strong>\u00a0placed cardiac chamber.</p>\n<p>The image below shows an MRI of the heart and its chambers.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6328c1f36af1483aa0180536b979f92cx1024x1024.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b37192fc622444aa9adee570fa9e428bx796x641.PNG"
    ]
  },
  {
    "text": "Identify the structure marked in the CT scan shown below:",
    "choices": [
      {
        "id": 1,
        "text": "Descending aorta"
      },
      {
        "id": 2,
        "text": "Ascending aorta"
      },
      {
        "id": 3,
        "text": "Superior vena cava"
      },
      {
        "id": 4,
        "text": "Right pulmonary artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The structure marked in the given CT thorax image is the <strong>superior vena cava</strong>.</p>\n<p>The image below depicts all the major structures labelled in the CT thorax image:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/43966f30310a4b5dbc3d6503e02a83b0.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3b234e0f93f24261b48cb390197bf6c9x1280x964.JPEG"
    ]
  },
  {
    "text": "A 60-year-old man presents with a 5-day history of cough and fever. Chest X-ray shows obliteration of the right cardiac border. Which anatomical site is likely involved in the pathology?",
    "choices": [
      {
        "id": 1,
        "text": "Right lower lobe"
      },
      {
        "id": 2,
        "text": "Right atrium"
      },
      {
        "id": 3,
        "text": "Right middle lobe"
      },
      {
        "id": 4,
        "text": "Right ventricle"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Positive silhouette sign and corresponding anatomical site of pathology:</p>\n<ul>\n<li><strong>Right heart border -\u00a0</strong>right middle lobe or medial right lower lobe</li>\n<li><strong>Left heart border -\u00a0</strong>lingula segments of the left upper lobe</li>\n<li>Left hemidiaphragm or descending aorta - left lower lobe</li>\n<li><strong>Aortic knuckle -\u00a0</strong>left upper lobe (posterior segment)</li>\n<li>Right hemidiaphragm - right lower lobe</li>\n<li>Right paratracheal stripe - right upper lobe</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a83317ddbc9a42e7b2b7261e28690774x1024x472.JPEG"
    ]
  },
  {
    "text": "A 35-year-old man presents with a 1-week history of low-grade fever and progressive chest pain. Chest X-ray revealed the following. Considering the symptoms and imaging, what is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pericardial effusion"
      },
      {
        "id": 2,
        "text": "Pneumonia"
      },
      {
        "id": 3,
        "text": "Coarctation of aorta"
      },
      {
        "id": 4,
        "text": "Aortic dissection"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The investigation of choice is <strong>e</strong><strong>chocardiography</strong>. However, the following x-ray findings are also characteristic for pericardial effusion:</p>\n<ul>\n<li>AP view - money bag or <strong>leather bottle-shaped heart</strong></li>\n<li>Lateral view -<strong>\u00a0Oreo cookie sign</strong> (fluid is seen between two layers of fat)</li>\n</ul>\n<p>In the following image,\u00a0<strong>pericardial fluid</strong> (yellow asterisk) outlined by\u00a0<strong>paracardial fat</strong> (blue arrows) and <strong>epicardial fat</strong> (orange arrows) is called the Oreo cookie sign.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d2ac833752db43eb9f4b84f661cec0d0.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fbe4acec9d7546cc8eeafdfe219216a1x510x535.GIF",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/482c0990edbc4f918157835536c31c27x1024x1024.PNG"
    ]
  },
  {
    "text": "What is the earliest sign of left atrial enlargement on a chest x-ray ?",
    "choices": [
      {
        "id": 1,
        "text": "Straightening of right cardiac border"
      },
      {
        "id": 2,
        "text": "Enlargement of left atrial appendage"
      },
      {
        "id": 3,
        "text": "Presence of double atrial shadow"
      },
      {
        "id": 4,
        "text": "Elevation of left main bronchus and widening of carina"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>\u00a0The causes of left atrial enlargement are as follows:</p>\n<ul>\n<li>Congenital: Ventricular septal defect , Patent ductus arteriosus</li>\n<li>Acquired: Mitral valvular disease, left ventricular failure, left atrial myxoma</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dc9f03a621aa4e91a5fabdf444107afdx1069x699.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e5d5ded10df847af8a9ca993699a6317x753x785.JPEG"
    ]
  },
  {
    "text": "A 5-year-old male child presents with cyanosis that worsens during activity and progressive breathlessness. Chest X-ray is done and shown below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Tetralogy of Fallot"
      },
      {
        "id": 2,
        "text": "Coarctation of aorta"
      },
      {
        "id": 3,
        "text": "Transposition of great arteries"
      },
      {
        "id": 4,
        "text": "Ebstein's anomaly"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>\u00a0TOF\u00a0is a\u00a0<strong>cyanotic congenital </strong>heart condition and has <strong>four </strong>characteristic components: Ventricular septal defect, right ventricular outflow tract obstruction (pulmonary stenosis), overriding aorta, right ventricular hypertrophy (late feature).</p>\n<p>Other radiographic features seen in TOF are pulmonary oligaemia (due to pulmonary stenosis), normal size heart without heart failure and right-sided aortic arch (in 25% of cases)</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ac1b2ebb924746c9adafcf91b10bf3de.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/eebe437a1c1a489faeca2d364b65f396x510x558.GIF"
    ]
  },
  {
    "text": "A baby is brought to the clinic as he turns blue every time he cries. Chest x-ray reveals the following. Which of the following best describes the underlying condition?",
    "choices": [
      {
        "id": 1,
        "text": "Atrialization of the ventricle"
      },
      {
        "id": 2,
        "text": "Right outflow tract obstruction with overriding of aorta"
      },
      {
        "id": 3,
        "text": "Abnormal pulmonary vein drainage into systemic venous circulation"
      },
      {
        "id": 4,
        "text": "Single great artery for systemic and pulmonary circulation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Ebstein anomaly is characterized by an <strong>abnormal tricuspid</strong> <strong>valve</strong> that is displaced downwards into the right ventricle. Hence,\u00a0a part of the right\u00a0ventricle\u00a0is now located above the tricuspid valve. This is called\u00a0<strong>atrialization of the ventricle</strong>. There can be associated tricuspid regurgitation with or without stenosis.</p>\n<p>X-ray findings depend on the degree to which the tricuspid valve is displaced downwards. The features are an <strong>enlarged right atrium</strong> which causes severe right-sided cardiomegaly, giving rise to a box-shaped cardiac shadow and pulmonary oligemia.\u00a0</p>\n<p>Other options:</p>\n<p>Option B: Pulmonary stenosis, ventricular septal defect (VSD), aorta overriding the VSD and right ventricular hypertrophy are the defining features of <strong>Tetralogy of Fallot</strong>, a cyanotic congenital heart disease. X-ray findings show characteristic 'coeur-en-sabot' or <strong>boot-shaped heart</strong>.</p>\n<p>Option C:\u00a0Pulmonary veins returning to the <strong>right atrium</strong> or <strong>systemic venous circulation</strong> instead of the left atrium, define <strong>total anomalous pulmonary venous circulation</strong>, a congenital cardiac malformation, with <strong>supracardiac</strong> variety being the most common. As a result, a large supracardiac shadow can be seen with normal cardiac shadow and gives a characteristic pattern of <strong>snowman appearance/ figure of 8</strong> on chest X-ray.</p>\n<p>Option D: Failure of the embryonic common truncus arteriosus to divide into the aorta and pulmonary artery characterises <strong>truncus arteriosus</strong>, a cyanotic congenital heart anomaly. A single great artery arises from the heart, supplying both the pulmonary and systemic circulation. This condition is associated with <strong>pulmonary plethora,</strong> unlike tetralogy of Fallot and is characterised by the <strong>sitting duck appearance </strong>of the heart on X-ray.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b6e30b9c62a7477381b4f02e1ee00fa2.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3324711ee3594107909dafbfb62febf4x510x487.GIF"
    ]
  },
  {
    "text": "An infant is brought with poor feeding and lethargy. Chest X-ray reveals an egg-on-string appearance. Which of the following conditions is this finding most suggestive of?",
    "choices": [
      {
        "id": 1,
        "text": "Transposition of great arteries"
      },
      {
        "id": 2,
        "text": "Total anomalous pulmonary venous return"
      },
      {
        "id": 3,
        "text": "Endocardial cusion defect"
      },
      {
        "id": 4,
        "text": "Partial anomalous pulmonary venous return"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In d-TGA, the <strong>aorta</strong> arises from\u00a0the <strong>right</strong> <strong>ventricle,</strong> whereas the <strong>pulmonary trunk</strong>\u00a0arises from the <strong>left</strong> <strong>ventricle</strong>. d-TGA is also called uncorrected TGA.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4c2516a5abcf47d9a2a78e2396a243cax510x670.GIF"
    ]
  },
  {
    "text": "A 61-year-old woman presented with chest pain and fatigue. The chest radiograph is shown below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pericardial effusion"
      },
      {
        "id": 2,
        "text": "Constrictive pericarditis"
      },
      {
        "id": 3,
        "text": "Pulmonary artery hypertension"
      },
      {
        "id": 4,
        "text": "Hypertrophic obstructive cardiomyopathy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows <strong>calcified pericardium</strong>, called an<strong>\u00a0egg-in-cup</strong>\u00a0appearance. It is typically seen in\u00a0<strong>c</strong><strong>onstrictive pericarditis</strong>.</p>\n<p>In constrictive pericarditis, there is\u00a0fibrous or calcific constrictive thickening of the anterior and lateral pericardium that prevents normal diastolic filling\u00a0of the heart.\u00a0The resulting\u00a0<strong>diastolic dysfunction</strong> leads to features of right heart failure. The\u00a0thickness of the pericardium is best assessed on MRI.</p>\n<p>Note: The\u00a0<strong>egg-in-cup</strong>\u00a0(or ball-on-tee) appearance is also a urographic finding seen in\u00a0<strong>r</strong><strong>enal papillary necrosis</strong>.\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3c2e0fb7f7d74410b355691759198b27.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Hilar dance was seen on fluoroscopy of an infant with suspected congenital heart disease. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Atrial septal defect"
      },
      {
        "id": 2,
        "text": "Ventricular septal defect"
      },
      {
        "id": 3,
        "text": "Patent ductus arteriosus"
      },
      {
        "id": 4,
        "text": "Tetralogy of Fallot"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Hilar dance</strong> on fluoroscopy is seen in patients with an <strong>atrial septal defect</strong> (<strong>ASD</strong>), due to vigorous<strong> pulmonary artery pulsations</strong>.</p>\n<p>ASD is characterised by an <strong>abnormal opening</strong> in the atrial septum, allowing communication between the right and left atria. There are <strong>four</strong>\u00a0<strong>types</strong>\u00a0based on their location within the septum:</p>\n<ul>\n<li>Secundum ASD -\u00a0<strong>most common</strong>, usually an isolated abnormality</li>\n<li>Primum ASD - associated with abnormal mitral valve leaflet (partial AV septal defect)</li>\n<li>Sinus venous - associated with anomalous right pulmonary venous return to the\u00a0SVC or RA</li>\n<li>Coronary sinus type ASD - also called unroofed coronary sinus</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6e17ae2c4b26467e8f9823d175671e21x1280x1274.JPEG"
    ]
  },
  {
    "text": "Sitting-duck appearance of the heart on chest X-ray is seen in patients with which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Persistent truncus arteriosus"
      },
      {
        "id": 2,
        "text": "Transposition of great vessels"
      },
      {
        "id": 3,
        "text": "Tetralogy of Fallot"
      },
      {
        "id": 4,
        "text": "Pulmonary artery hypertension"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Truncus arteriosus is a <strong>cyanotic congenital</strong> heart anomaly. A\u00a0single great artery arises from the heart, due to a <strong>failure </strong>of the<strong> division </strong>of the embryonic<strong> common truncus arteriosus</strong>. Single trunk supplies both the pulmonary and systemic circulation, instead of a separate aorta and a pulmonary trunk.</p>\n<p>The X-ray findings are similar to ToF. However, <strong>pulmonary plethora </strong>is seen in this condition, as opposed to pulmonary oligemia in ToF. This is because the pulmonary artery originates from the truncus, which is part of the systemic circulation.\u00a0</p>\n<p>The following image shows persistent truncus arteriosus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/81ee174574524a978f9d6854d48706cex1280x1260.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8c3acc75aa994cc680debacb9a48410bx1280x1260.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a5bf215b88634cc79288b95c4d1a4552x1200x1821.JPEG"
    ]
  },
  {
    "text": "What is the diagnosis based on the following x-ray?",
    "choices": [
      {
        "id": 1,
        "text": "Endocardial cushion defect"
      },
      {
        "id": 2,
        "text": "Total anomalous pulmonary venous circulation"
      },
      {
        "id": 3,
        "text": "Supravalvular aortic stenosis"
      },
      {
        "id": 4,
        "text": "Primary pulmonary artery hypertension"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>\u00a0</p>\n<p>TAPVC is a\u00a0<strong>cyanotic</strong>\u00a0type of\u00a0<strong>congenital </strong>heart disease with abnormal drainage anatomy of the entire pulmonary venous system. In obstructive TAPVC, there is a normal-sized heart with severe <strong>pulmonary venous hypertension</strong>. This results in the\u00a0ground-glass appearance of the lungs.</p>\n<p>In TAPVC, all systemic and pulmonary venous blood enters the right atrium and nothing drains into the left atrium. A <strong>right-to-left shunt</strong> in the form of a patent foramen ovale (PFO) or ASD is<strong>\u00a0required for survival.</strong>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e8c2a70afa77427d903206359499ccce.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/983b47ffdc5c47dc9956e7bd94da3facx510x494.GIF"
    ]
  },
  {
    "text": "A 30-year-old woman presents with persistent hypertension, chest pain and cramping in her legs, particularly during exertion. A chest radiograph was taken, which reveals the condition, as shown in the image below. What is the likely\u200b underlying cause of her hypertension?",
    "choices": [
      {
        "id": 1,
        "text": "Coarctation of aorta"
      },
      {
        "id": 2,
        "text": "Essential hypertension"
      },
      {
        "id": 3,
        "text": "Aortic aneurysm"
      },
      {
        "id": 4,
        "text": "Aortaarteritis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Other chest X-ray features in coarctation of the aorta are dilated left subclavian artery, dilated ascending aorta and <strong>n</strong><strong>otching of ribs</strong> 4-8 due to rib erosion by dilated collateral vessels.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/db6795bb8e974e029c718a031ea7fc9e.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c7fffb4172ef4d8db11123e94ae98643x510x660.GIF"
    ]
  },
  {
    "text": "A radiologist observes the following finding on a patient's  X-ray. Which condition is it seen in?",
    "choices": [
      {
        "id": 1,
        "text": "Coarctation of aorta"
      },
      {
        "id": 2,
        "text": "Rickets"
      },
      {
        "id": 3,
        "text": "Marfan's syndrome"
      },
      {
        "id": 4,
        "text": "Multiple myeloma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The X-ray shows\u00a0inferior<strong> rib notching</strong>. It is seen in <strong>coarctation of aorta</strong>.</p>\n<p>The most common location of the coarctation is just beyond the origin of the left subclavian artery. The following\u00a0radiograph findings are seen in this condition:</p>\n<ul>\n<li>Inferior rib notching (<strong>Roesler sign</strong>):\n<ul>\n<li>It occurs due to <strong>erosion</strong> of inferior margins of ribs by\u00a0dilated intercostal<strong> collateral vessels</strong> that are formed to bypass the coarctation\u00a0</li>\n<li>It is a <strong>late feature</strong> and is unusual in patients &lt; 5 years of age</li>\n<li>Ribs 4-8 are commonly notched and ribs\u00a01-2<sup>\u00a0</sup>are usually spared</li>\n</ul>\n</li>\n<li><strong>Figure of 3 </strong>or<strong>\u00a0</strong>reverse 3 sign refers to an abnormality in the contour of the aorta, as shown below.</li>\n</ul>\n<p>Causes for inferior rib notching (<strong>Roesler sign</strong>) are:</p>\n<ul>\n<li>Unilateral:\n<ul>\n<li>Subclavian artery occlusion.</li>\n<li>Coarctation of aorta involving left subclavian or anomalous right subclavian artery</li>\n</ul>\n</li>\n<li>Bilateral:\n<ul>\n<li>Coarctation of aorta, occlusion, aortitis</li>\n<li>Takayasu\u2019s disease and atheroma of\u00a0subclavian artery</li>\n<li>Pulmonary oligemia (ToF, pulmonary atresia, stenosis)</li>\n<li>SVC or IVC obstruction</li>\n<li>AV malformation</li>\n<li>Neurofibromatosis type 1</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c178ee18abbc429a95a35dc23bbe88f3.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/71d0357800424aeea41702bae86c38f0x510x660.GIF"
    ]
  },
  {
    "text": "The patient's chest radiograph reveals the finding shown below. Which of the following can be excluded from the differential diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Rheumatoid arthritis"
      },
      {
        "id": 2,
        "text": "Systemic lupus erythematosus"
      },
      {
        "id": 3,
        "text": "Neurofibromatosis"
      },
      {
        "id": 4,
        "text": "Coarctation of aorta"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given image shows superior rib notching. <strong>Coarctation </strong>of aorta\u00a0is associated with <strong>inferior</strong> <strong>rib notching</strong>.</p>\n<p>Hyperparathyroidism and <strong>neurofibromatosis</strong> cause <strong>both superior and inferior</strong> rib notching.</p>\n<p>Causes of\u00a0<strong>superior</strong> <strong>rib notching</strong> are:</p>\n<ul>\n<li>Normal finding in the elderly</li>\n<li><strong>Rheumatoid arthritis</strong></li>\n<li><strong>Systemic lupus erythematosus</strong></li>\n<li>Marfan's syndrome</li>\n<li>Paraplegics and poliomyelitis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/66701647bf854d02898a3e73ef08ee4b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Pruning of pulmonary arteries is seen in which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary hypertension"
      },
      {
        "id": 2,
        "text": "Pulmonary embolism"
      },
      {
        "id": 3,
        "text": "Pulmonary edema"
      },
      {
        "id": 4,
        "text": "Pulmonary infarction"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Pulmonary</strong> <strong>artery</strong> <strong>hypertension</strong> is associated with <strong>peripheral pruning </strong>of pulmonary vessels.</p>\n<p>This means that the <strong>blood vessels </strong>appear<strong> cut off </strong>before they reach the<strong> outer 1/3 of the lung. </strong>Hence,<strong> </strong>the edge of the lung fields is <strong>darker than usual,</strong>\u00a0and the central area is often whiter.</p>\n<p>Plain radiographic findings in pulmonary artery hypertension include elevated cardiac apex due to right ventricular hypertrophy, enlarged right atrium, prominent pulmonary outflow tract, enlarged pulmonary arteries, and\u00a0<strong>peripheral pruning.</strong></p>\n<p>The image below shows\u00a0Chest X-ray findings in pulmonary hypertension:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/78f7f81bc1f04f4ea823bae7b3045af1x1280x1298.JPEG"
    ]
  },
  {
    "text": "Plethoric lung fields are seen in:",
    "choices": [
      {
        "id": 1,
        "text": "Total Anomalous Pulmonary Venous Connection"
      },
      {
        "id": 2,
        "text": "Tricuspid atresia"
      },
      {
        "id": 3,
        "text": "Ebstein anomaly"
      },
      {
        "id": 4,
        "text": "Tetrology of Fallot"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Plethoric lung fields</strong>\u00a0are seen in<strong> Total Anomalous Pulmonary Venous Connection </strong>(TAPVC). In this condition, pulmonary venous obstruction results in pulmonary arterial hypertension, resulting in plethoric lung fields.</p>\n<table style=\"height: 179px; width: 456px;\">\n<tbody>\n<tr>\n<td style=\"width: 84.7734px;\">\u00a0</td>\n<td style=\"width: 160.766px;\"><strong>Increased</strong> pulmonary blood flow (pulmonary plethora)</td>\n<td style=\"width: 167.945px;\"><strong>Decreased </strong>pulmonary blood flow</td>\n</tr>\n<tr>\n<td style=\"width: 84.7891px;\">Acyanotic\u00a0</td>\n<td style=\"width: 160.805px;\">Ventricular septal defect, Atrial septal defect, Patent ductus arteriosus</td>\n<td style=\"width: 167.977px; text-align: center;\">\u00a0\u2014</td>\n</tr>\n<tr>\n<td style=\"width: 84.7969px;\">Cyanotic</td>\n<td style=\"width: 160.812px;\">TAPVC</td>\n<td style=\"width: 168px;\">Ebstein anomaly, Tetrology of Fallot, Tricuspid atresia</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old patient has come with sudden onset of chest pain and his CT scan shows the following picture. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary embolism"
      },
      {
        "id": 2,
        "text": "Aortic dissection"
      },
      {
        "id": 3,
        "text": "Aortic aneurysm"
      },
      {
        "id": 4,
        "text": "Myocardial infarction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The\u00a0<strong>beak sign</strong>\u00a0in aortic dissection is a reliable sign to identify the <strong>false lumen</strong>. It refers to the acute angle formed at the edge of the false lumen in aortic dissection in axial cross-section. It is formed by the borders of the outer aortic wall and the intimal flap, and maybe partially thrombosed (blunted beak).\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ed3d3df71e8d4aa6861785a8933d6bed.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/efaaf6fd415d4ed1bafe29e6781b9bfex512x187.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2b826d74b9c348e6a1bc84eb4ab52fa6x258x245.PNG"
    ]
  },
  {
    "text": "The appearance of USG at saphenofemoral junction, showing common femoral vein, common femoral artery and the great saphenous vein is called as:",
    "choices": [
      {
        "id": 1,
        "text": "Mickey mouse sign"
      },
      {
        "id": 2,
        "text": "String sign"
      },
      {
        "id": 3,
        "text": "Tillaux sign"
      },
      {
        "id": 4,
        "text": "Stemmer sign"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Other options:</p>\n<p>Option B<strong>: String sign</strong> (of Kantor) on barium studies appears as a thin, thread-like stream of contrast passing through the stenosed bowel segment, particularly in Crohn's disease.\u00a0\u00a0</p>\n<p>Option C:\u00a0<strong>Tillaux sign</strong> is said to be positive if the mass/swelling is mobile perpendicular to the mesentery attachment line. Tillaux\u2019s sign is seen in a mesenteric cyst.</p>\n<p>Option D:<strong> Stemmer's sign</strong> is the inability to tent the skin at the base of the toes due to skin thickening, as seen in lymphedema.\u00a0</p>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c83353ec4cb34473b6ecd7aeb21023c0x1280x1750.JPEG"
    ]
  },
  {
    "text": "A 57-year-old woman with chest pain was diagnosed with acute myocardial infarction. What test can detect areas of reversible myocardial ischemia in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Coronary angiography"
      },
      {
        "id": 2,
        "text": "MUGA Scan"
      },
      {
        "id": 3,
        "text": "Thallium scan"
      },
      {
        "id": 4,
        "text": "Resting echocardiography"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A<strong> thallium</strong>\u00a0<strong>scan</strong> is performed to detect <strong>reversible myocardial</strong> <strong>ischemia</strong>. It evaluates myocardial perfusion both at rest and during stress (exercise/pharmacological).\u00a0</p>\n<p>In <strong>reversible</strong> ischemia, a <strong>cold</strong> spot is seen during exercise or stress due to reduced perfusion, but <strong>normal</strong> perfusion is observed at rest. Conversely, <strong>irreversible</strong> infarction is indicated by<strong> cold spot</strong> during rest and stress/exercise.\u00a0</p>\n<p>In technetium and pyrophosphate scanning, infarct appears as a <strong>hot</strong> spot.</p>\n<p><strong>MUGA </strong>(multiple gated acquisition) scan is a nuclear imaging test that can evaluate the <strong>function</strong> of the<strong>\u00a0ventricles.</strong> It is used for informed diagnostic intervention in heart failure. Its specific uses are in evaluating the degree of myocardial damage following myocardial infarction and in assessing cardiac dysfunction in patients on cardiotoxic drugs like anthracyclines.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '06 Cardiovascular System';
        let hierarchy = ["Marrow", "qBank", "Radiology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>