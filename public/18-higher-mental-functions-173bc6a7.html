<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18 Higher Mental Functions - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Physiology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">29</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following statements about the reticular activating system is false?",
    "choices": [
      {
        "id": 1,
        "text": "Involved in arousal"
      },
      {
        "id": 2,
        "text": "Polysynaptic pathway"
      },
      {
        "id": 3,
        "text": "Receives collateral from sensory pathway"
      },
      {
        "id": 4,
        "text": "Does not produce EEG alerting response"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<div class=\"page\" title=\"Page 291\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>High-frequency stimulation</strong> of the <strong>midbrain reticular formation</strong> (the RAS) produces the<strong> EEG alerting response</strong> and arouses a sleeping animal.</p>\n</div>\n</div>\n</div>\n</div>\n<p>The <strong>Reticular Activating System (RAS)</strong> is a complex <strong>polysynaptic pathway</strong> arising from the brainstem reticular formation and hypothalamus with projections to the intralaminar and reticular nuclei of the thalamus which, in turn, project diffusely and nonspecifically to wide regions of the cortex including the frontal, parietal, temporal, and occipital cortices.</p>\n<p><strong>Collaterals</strong> funnel into it from the long ascending sensory tracts,&nbsp;the trigeminal, auditory, visual, and olfactory systems.</p>\n<p>The reticular formation plays an important role in determining the <strong>level of arousal</strong>; thus, it is called the <strong>ascending reticular activating system (ARAS).</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which is the EEG wave recorded in a subject who is awake but eyes closed?",
    "choices": [
      {
        "id": 1,
        "text": "Alpha waves"
      },
      {
        "id": 2,
        "text": "Beta waves"
      },
      {
        "id": 3,
        "text": "Theta waves"
      },
      {
        "id": 4,
        "text": "Delta waves"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Alpha-waves are recorded best in the&nbsp;<strong>parieto-occipital region</strong> in adults at<strong> rest</strong>,<strong>&nbsp;i.e. awake but relaxed with eyes closed.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following structures regulates the sleep-wake cycle?",
    "choices": [
      {
        "id": 1,
        "text": "Basal ganglia"
      },
      {
        "id": 2,
        "text": "Hypothalamus"
      },
      {
        "id": 3,
        "text": "Medulla"
      },
      {
        "id": 4,
        "text": "Cerebellum"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The<strong> hypothalamus</strong> and several non-specific nuclei in <strong>ascending reticular activating system (ARAS)</strong> located in the <strong>midbrain</strong> are involved in the regulation of the&nbsp;<strong>sleep-wake cycle.</strong></p>\n<p><strong>Sleep Centres</strong></p>\n<p>Stimulation of the <strong>midbrain reticular formation (RAS</strong>) produces the <strong>EEG alerting response and promotes the waking state</strong>.&nbsp;</p>\n<p><strong>The nucleus coeruleus (locus coeruleus) is rich in norepinephrine</strong> and the <strong>raphe nuclei of ARAS is rich in serotonin</strong>. These regions when stimulated induce wakefulness.</p>\n<p>The cholinergic neurons in the&nbsp;<strong>pontine reticular formation</strong>, on stimulation, induce <strong>sleep.</strong></p>\n<p>Stimulation of the <strong>histaminergic neurons of the posterior hypothalamus</strong> produces&nbsp;<strong>arousal</strong>.&nbsp;</p>\n<p>Electrical stimulation of the <strong>anterior hypothalamus</strong> and the adjacent basal forebrain region rapidly induces sleep. This sleep-inducing effect is thought to be mediated by <strong>GABA-ergic inhibitory neurons.</strong></p>\n<p><strong>Orexin</strong> produced by <strong>hypothalamic neurons</strong> also appears to have a role in sleep-wake transition by regulating the changes in activity in these brainstem neurons.</p>\n<table>\n<tbody>\n<tr>\n<td><strong>wakeful state&nbsp;</strong></td>\n<td><strong>Sleep&nbsp;</strong></td>\n</tr>\n<tr>\n<td>Norepinephrine&nbsp;</td>\n<td>Acetylcholine&nbsp;</td>\n</tr>\n<tr>\n<td>Serotonin&nbsp;</td>\n<td>GABA&nbsp;</td>\n</tr>\n<tr>\n<td>Histamine&nbsp;</td>\n<td>&nbsp;</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which stage of sleep are K complex and sleep spindles seen?",
    "choices": [
      {
        "id": 1,
        "text": "REM"
      },
      {
        "id": 2,
        "text": "Stage 1 NREM"
      },
      {
        "id": 3,
        "text": "Stage 2 NREM"
      },
      {
        "id": 4,
        "text": "Stage 3 NREM"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Stage 2 of NREM sleep is marked by the appearance of sinusoidal waves called <strong>sleep spindles </strong>(12\u201314 Hz) and occasional high-voltage biphasic waves called <strong>K complexes.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/327aadf2122f475f88923e4013f5aad5x853x448.PNG"
    ]
  },
  {
    "text": "Which stage constitutes the largest amount of sleep time of a young adult?",
    "choices": [
      {
        "id": 1,
        "text": "REM"
      },
      {
        "id": 2,
        "text": "NREM 1"
      },
      {
        "id": 3,
        "text": "NREM 2"
      },
      {
        "id": 4,
        "text": "NREM 3"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<ul>\n<li>In young adults, the <strong>largest amount of sleep time</strong> (50&ndash;60%) is spent in <strong>stage 2 NREM</strong> sleep; REM phases constitute 20&ndash;25% of total sleep time, stages 3 and 4 NREM about 15&ndash;20%, and stage 1 non-REM about 5%.</li>\n<li>REM sleep occupies 80% of total sleep time in premature infants and 50 % in full-term neonates. In most adults, it is 25 %. In the <strong>elderly</strong>,<strong> it falls to about 20%</strong>.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is observed during sleep induction?",
    "choices": [
      {
        "id": 1,
        "text": "\u2191 Norepinephrine and serotonin"
      },
      {
        "id": 2,
        "text": "\u2191 Acetyl choline"
      },
      {
        "id": 3,
        "text": "\u2191Histamine"
      },
      {
        "id": 4,
        "text": "\u2193GABA"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>cholinergic</strong> neurons in <strong>pontine reticular formation&nbsp;</strong>on stimulation, induce <strong>sleep.</strong></p>\n<p class=\"p2\">When the activity of norepinephrine and serotonin containing neurons<strong> (locus coeruleus and raphe nuclei)</strong> is dominant, there is a reduced level of activity in acetylcholine-containing neurons in the pontine reticular formation leading to wakefulness. The reverse of this pattern leads to REM sleep. A more even balance in the activity of these groups of neurons is associated with NREM sleep.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In NREM sleep, which part of brain is not involved?",
    "choices": [
      {
        "id": 1,
        "text": "Dorsal Raphe nucleus"
      },
      {
        "id": 2,
        "text": "Thalamus"
      },
      {
        "id": 3,
        "text": "Hypothalamus"
      },
      {
        "id": 4,
        "text": "Basal forebrain"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>nucleus coeruleus</strong> (locus coeruleus) is rich in <strong>norepinephrine</strong> and the <strong>Raphe nuclei</strong> of ARAS is rich in <strong>serotonin</strong>. These regions when stimulated induce arousal. Thus, the dorsal raphe nucleus is not involved in NREM sleep.</p>\n<p><strong>Genesis and Regulation of NREM sleep </strong></p>\n<ul>\n<li>Electrical stimulation of <strong>the anterior hypothalamus and the adjacent basal forebrain region </strong>rapidly induces sleep mediated by <strong>GABA-ergic inhibitory neurons</strong> called the <strong>NREM-on cells</strong>.\n<ul>\n<li>These cells are thought to produce sleep by inhibiting the <strong>histaminergic cells</strong> in the <strong>posterior hypothalamus</strong> as well as cells of the nucleus reticularis pontis oralis in the midbrain that mediate arousal.</li>\n<li>They are maximally active in NREM sleep and inactive during waking and REM sleep.</li>\n</ul>\n</li>\n<li>NREM sleep is produced by synchronized synaptic potentials in cortical neurons generated by the rhythmic firing of <strong>thalamic relay neurons</strong> that project to the cortex. (Thalamocortical loop)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Delta waves are seen in______",
    "choices": [
      {
        "id": 1,
        "text": "Deep sleep"
      },
      {
        "id": 2,
        "text": "REM Sleep"
      },
      {
        "id": 3,
        "text": "Awake state"
      },
      {
        "id": 4,
        "text": "NREM 1"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>D</strong>elta waves are predominant in N3 (formerly called stage 3 and 4) of NREM. This is characteristic of <strong>d</strong>eep sleep, also referred to as slow wave sleep.</p>\n<p>(<strong>D</strong>elta waves for <strong>D</strong>eep sleep)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is associated with slow-wave sleep?",
    "choices": [
      {
        "id": 1,
        "text": "Nightmares"
      },
      {
        "id": 2,
        "text": "Cardiac arrhythmias"
      },
      {
        "id": 3,
        "text": "Penile tumescence"
      },
      {
        "id": 4,
        "text": "Delta activity"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In <strong>slow-wave sleep</strong>, (Stages 3 and 4 of NREM) <strong>delta waves</strong> predominate the EEG.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the source of melatonin?",
    "choices": [
      {
        "id": 1,
        "text": "Pineal gland"
      },
      {
        "id": 2,
        "text": "Hypothalamus"
      },
      {
        "id": 3,
        "text": "Adrenal cortex"
      },
      {
        "id": 4,
        "text": "Melanocytes"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Melatonin</strong> is released by the&nbsp;<strong>pineal gland</strong>&nbsp;(<strong>pinealocytes</strong>) that&nbsp;plays an important role in sleep mechanisms.&nbsp;</p>\n<p>In<strong> infants</strong>,<strong>&nbsp;</strong>the<strong> pineal gland</strong> is <strong>large</strong> and the cells are arranged in alveoli.&nbsp;It begins to <strong>involute before</strong> <strong>puberty</strong> and small concretions of calcium phosphate and carbonate appear (radiopaque structure) = physiological calcification.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A businessman who takes frequent long trips to overseas destinations visits the clinic asking for ''something that helps with falling asleep and adapt with the local time''. He is given a low dose of melatonin as a part of his treatment plan. Which of the following best describes its action?",
    "choices": [
      {
        "id": 1,
        "text": "Facilitates ACTH secretion"
      },
      {
        "id": 2,
        "text": "Prevents sleep induction"
      },
      {
        "id": 3,
        "text": "Regulates circadian rhythm"
      },
      {
        "id": 4,
        "text": "Release of melanin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Melatonin</strong> plays a key role in regulating the <strong>circadian rhythm.&nbsp;</strong>Therefore it is helpful in restoring the usual sleep wake pattern in patients with <strong>jetlag.</strong></p>\n<p><strong>Diurnal variation</strong> in melatonin secretion may function as a timing signal to coordinate events with the <strong>light-dark cycle</strong> in the environment (<strong>circadian rhythm</strong>).</p>\n<p><strong>Melatonin</strong> <strong>synthesis</strong> and secretion are <strong>increased </strong>during the<strong> dark</strong> period of the day and maintained at<strong> low levels </strong>during the <strong>daytime</strong>.</p>\n<p>Increased melatonin levels induce sleepiness.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b677a69dbc8d45d8a774fe06f4f58afbx936x620.PNG"
    ]
  },
  {
    "text": "In which type of memory are basal ganglia involved?",
    "choices": [
      {
        "id": 1,
        "text": "Conditioning"
      },
      {
        "id": 2,
        "text": "Procedural"
      },
      {
        "id": 3,
        "text": "Explicit"
      },
      {
        "id": 4,
        "text": "None"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Procedural memory </strong>includes skills and habits, which, once acquired, become unconscious and automatic. This type of memory is processed in the <strong>striatum</strong>.</p>\n<p><strong>Implicit memory/Non-declarative memory</strong>:<strong>&nbsp;</strong>It&nbsp;does not require being conscious or awareness.&nbsp;E.g., Remembering how to brush your teeth. They are of 4 types:</p>\n<ul>\n<li><strong>Procedural memory&nbsp;</strong>(skills and habits) in striatum, cerebellum, motor cortex</li>\n<li><strong>Priming&nbsp;</strong>in neocortex</li>\n<li><strong>Non-associative learning&nbsp;</strong>(includes habituation and sensitization, e.g., Byhearting facts)</li>\n<li><strong>Associative learning</strong>:<strong>&nbsp;</strong>classical and operant conditioning</li>\n</ul>\n<p><strong>Explicit/declarative memory</strong>:<strong>&nbsp;</strong>Memory of words,rules, language, etc. Associated with consciousness/awareness. E.g., recalling first day in school.</p>\n<p>They are of two types:</p>\n<ul>\n<li><strong>Semantic memory&nbsp;</strong>(facts) e.g., Knowing capital of India: Parts of brain involved are temporal cortex and prefrontal cortex.</li>\n<li><strong>Episodic memory&nbsp;</strong>(events) e.g., Recalling first day in college: hippocampus, medial temporal lobe and neocortex.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old lady develops severe anterograde amnesia. On further evaluation, a suprasellar craniopharyngioma invading adjacent structures is seen on T1-weighted MRI. Compression of which of the following structures can explain her symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Prefrontal cortex"
      },
      {
        "id": 2,
        "text": "Neocortex"
      },
      {
        "id": 3,
        "text": "Mammillary body"
      },
      {
        "id": 4,
        "text": "Amygdala"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Compression or a lesion affecting the <strong>mammillary body</strong>&nbsp;will cause <strong>anterograde amnesia</strong>.</p>\n<p>The Hippocampus,&nbsp;<strong>mammillary body</strong> and <strong>mammillothalamic tract</strong>&nbsp;are the primary structures involved in the&nbsp;<strong>conversion </strong>of<strong> short-term </strong>memory to<strong> long-term </strong>memory. Any lesion involving this pathway will affect the ability to convert&nbsp;short-term memory to long-term memory, leading to anterograde amnesia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following neural mechanism is not involved in synaptic plasticity and learning?",
    "choices": [
      {
        "id": 1,
        "text": "Post-tetanic potentiation"
      },
      {
        "id": 2,
        "text": "Habituation"
      },
      {
        "id": 3,
        "text": "Desensitization"
      },
      {
        "id": 4,
        "text": "Long-term depression"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sensitization</strong> is a neural mechanism involved in synaptic plasticity and learning (<strong>not desensitization</strong>).</p>\n<p><strong>Neural basis of synaptic plasticity and learning </strong></p>\n<ul>\n<li><strong>Post-tetanic Potentiation</strong>\n<ul>\n<li>Production of enhanced postsynaptic potential, which occurs after a brief tetanizing train of stimuli in the presynaptic neuron</li>\n<li>This enhancement lasts up to 60 seconds.</li>\n</ul>\n</li>\n<li><strong>Habituation</strong>\n<ul>\n<li>A simple form of learning in which neutral stimulus is repeated many times until the subject becomes habituated to the stimulus and ignores it</li>\n<li>A&nbsp;classic example of non-associative learning (e.g., learning a fact by heart)</li>\n</ul>\n</li>\n<li><strong>Sensitization</strong>:<strong>&nbsp;T</strong><strong>he opposite of habituation</strong></li>\n<li><strong>Long-term Potentiation (LTP)</strong>\n<ul>\n<li>A rapidly developing <strong>persistent enhancement</strong> of the&nbsp;post-synaptic potential response to presynaptic stimulation, after<strong>&nbsp;rapidly repeated stimulation</strong> of presynaptic neuron</li>\n<li>Characteristically observed in the&nbsp;<strong>hippocampus</strong></li>\n</ul>\n</li>\n<li><strong>Long-term Depression</strong>\n<ul>\n<li>Is the opposite of LTP</li>\n<li>Characterized by a decrease in synaptic strength</li>\n<li>Produced by <strong>slower stimulation</strong> of presynaptic neuron</li>\n<li>May be involved in the neural mechanism by which learning occurs in the <strong>cerebellum</strong></li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The type of potentiation in hippocampus is ______",
    "choices": [
      {
        "id": 1,
        "text": "Long-term potentiation"
      },
      {
        "id": 2,
        "text": "Post tetanic potentiation"
      },
      {
        "id": 3,
        "text": "Long-term depression"
      },
      {
        "id": 4,
        "text": "Habituation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Long-term potentiation occurs in the hippocampus.</p>\n<p>LTP is a rapidly developing <strong>persistent enhancement</strong> of the post-synaptic potential response to presynaptic stimulation, after <strong>rapidly repeated stimulation</strong> of presynaptic neuron.</p>\n<p><strong>NMDA receptors&nbsp;</strong>are involved in <strong>LTP</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Wernickes area is in ________",
    "choices": [
      {
        "id": 1,
        "text": "Superior temporal gyrus"
      },
      {
        "id": 2,
        "text": "Precentral gyrus"
      },
      {
        "id": 3,
        "text": "Post central gyrus"
      },
      {
        "id": 4,
        "text": "Inferior frontal gyrus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<ul>\n<li>Wernicke&rsquo;s area, lies behind the primary auditory cortex in the <strong>posterior part of the superior gyrus of the temporal lobe.</strong></li>\n<li><strong>Wernicke&rsquo;s area</strong> is concerned with language comprehension.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ede88ce4fb7f4ea89b4551585d8aed5bx407x513.PNG"
    ]
  },
  {
    "text": "Which of the following is false about Broca\u2019s aphasia?",
    "choices": [
      {
        "id": 1,
        "text": "Lesion lies in frontal lobe"
      },
      {
        "id": 2,
        "text": "Fluency is impaired"
      },
      {
        "id": 3,
        "text": "Neologisms are absent"
      },
      {
        "id": 4,
        "text": "Repetition is preserved"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<ul>\n<li><strong>Repetition</strong> is <strong>impaired</strong> in <strong>Broca&rsquo;s aphasia</strong>.</li>\n<li>Aphasias are abnormalities of language functions that are not due to defects of vision or hearing or motor paralysis. They are caused by lesions in the categorical hemispheres.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A lesion in the broca\u2019s area will affect which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Word formation"
      },
      {
        "id": 2,
        "text": "Word comprehension"
      },
      {
        "id": 3,
        "text": "Word memorization"
      },
      {
        "id": 4,
        "text": "Reading"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A lesion in broca&rsquo;s area will lead to an impairment of&nbsp;<strong>word-formation.</strong></p>\n<p><strong>Broca&rsquo;s area </strong>is in the inferior frontal lobe.</p>\n<p>Broca area processes the information received from the wernicke area into a detailed and coordinated pattern for <strong>vocalization</strong> and then projects the pattern via a s<strong>peech articulation area</strong> in the insula to the <strong>motor cortex</strong>. This then initiates the appropriate movements of the lips, tongue, and larynx to produce speech.</p>\n<p>The probable sequence of events that occurs when a subject names a visual object is shown in the figure and flowchart.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/64bf1bfe04254f1dbb3c0de91e23f407x690x598.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4662084ca369483fa0fe3357494679bfx774x600.PNG"
    ]
  },
  {
    "text": "A patient is able to recognize a person by name but not face. Which of the following is the most likely site of the lesion?",
    "choices": [
      {
        "id": 1,
        "text": "Frontal lobe"
      },
      {
        "id": 2,
        "text": "Occipital lobe"
      },
      {
        "id": 3,
        "text": "Post parietal region"
      },
      {
        "id": 4,
        "text": "Occipitotemporal"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>This condition is prosopagnosia, which occurs in the lesions of the<strong> inferior occipitotemporal lobe</strong>.</p>\n<p>In humans, storage and recognition of faces are more strongly represented in the <strong>right inferior temporal lobe</strong> in <strong>right-handed</strong> individuals (i.e non-dominant inferior temporal lobe).</p>\n<p>Damage to this area can cause <strong>prosopagnosia</strong>, the inability to recognize faces. Patients with this abnormality can recognize people by their voices, body language, etc. How&shy;ever, they cannot identify the familiar people by seeing their faces. The left hemisphere is also involved, but the role of the right hemi&shy;sphere is primary.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the test for immediate memory?",
    "choices": [
      {
        "id": 1,
        "text": "Digit span forward up to 7 digits with 2 skips allowed"
      },
      {
        "id": 2,
        "text": "Serial (100-7) subtraction test up to 5 steps"
      },
      {
        "id": 3,
        "text": "Digit span backwards up to 5 digits with 2 skips allowed"
      },
      {
        "id": 4,
        "text": "Serial (20-1) subtraction test up to 5 steps"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Forward digit span test is</strong>&nbsp;the <strong>best test</strong> among the given options.</p>\n<p>Memory is of 3 types:</p>\n<ul>\n<li>Immediate</li>\n<li>Recent</li>\n<li>Remote</li>\n</ul>\n<p><strong>Immediate</strong> memory is <strong>attention</strong> dependent. Tests of attention and memory include</p>\n<ul>\n<li>Digit span test: <strong>Most important </strong>and <strong>best test for immediate memory</strong></li>\n<li>Serial (100-7) subtraction test is the best for <strong>concentration</strong></li>\n<li>Days of the week backwards</li>\n<li>Spell WORLD backwards</li>\n<li>(20&ndash;3) test</li>\n</ul>\n<p><strong>Digit span test</strong></p>\n<p>The examiner recites numbers randomly without any sequence and asks the patient to repeat the same. The examiner starts with a 2-number sequence and the digit span increases from 2 numbers to 3 numbers and so on. The patient is asked to repeat until he/she fails to repeat all numbers correctly.&nbsp;</p>\n<p><strong>Digit forward</strong></p>\n<ul>\n<li>Normally a person can repeat up to<strong> 7 digits (+/- 2)</strong></li>\n<li>E.g., Examiner says 2 - 4 &ndash;8 &ndash;1 &ndash;5 &ndash;7 - 9. The person has to repeat in the same order 2 &ndash; 4 &ndash; 8 &ndash;1 &ndash;5 &ndash;7 &ndash;9.</li>\n</ul>\n<p><strong>Digit backward</strong></p>\n<ul>\n<li>Reproduction of longer digits in backward direction.</li>\n<li>Normally a person can repeat up <strong>to 5 digits</strong> (+/- 1) in backward direction (making option C wrong)</li>\n<li>Eg : Examiner says 2 - 4 &ndash;8 &ndash;1 &ndash;5 &ndash;7 - 9. The person has to repeat it backwards. 9 -7 -5 -1 -8- 4- 2.</li>\n</ul>\n<p>&nbsp;</p>\n<p><strong>Serial (100-7) subtraction test</strong></p>\n<ul>\n<li>5 scores / steps are taken in to account\n<ul>\n<li>1st score &ndash; When the patient tells 93 (100 - 7 = 93)</li>\n<li>2nd score - When the patient tells 86 (93 &ndash; 7 = 86)</li>\n<li>And so on . . 100 , 93 , 86 , 79 , 72 , 65</li>\n</ul>\n</li>\n</ul>\n<p>Hence among the given options :</p>\n<p><strong>Digit span forward up to 7 digits with 2 skips allowed </strong>would be the answer of choice as it is the best test for immediate memory</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The marked area given in the sleep polysomnography is of ______",
    "choices": [
      {
        "id": 1,
        "text": "REM sleep"
      },
      {
        "id": 2,
        "text": "NREM stage 1"
      },
      {
        "id": 3,
        "text": "NREM stage 2"
      },
      {
        "id": 4,
        "text": "NREM stage 3"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The following table helps identify the state of wakefulness from the graph :</p>\n<table>\n<tbody>\n<tr>\n<td>&nbsp;</td>\n<td><strong>&nbsp; EEG</strong></td>\n<td><strong>EOG</strong></td>\n<td><strong>EMG</strong></td>\n</tr>\n<tr>\n<td>Active state</td>\n<td>&nbsp; Fast</td>\n<td>&nbsp; +</td>\n<td>&nbsp; +</td>\n</tr>\n<tr>\n<td><strong>REM sleep</strong></td>\n<td><strong>&nbsp;Mixed&nbsp;</strong></td>\n<td><strong>&nbsp; +</strong></td>\n<td><strong>&nbsp; -</strong></td>\n</tr>\n<tr>\n<td>NREM sleep</td>\n<td>&nbsp; Slow</td>\n<td>&nbsp; -</td>\n<td>&nbsp; +</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>\n<p>In the marked area,</p>\n<ul>\n<li>EOG shows Positive activity</li>\n<li>EEG shows Mixed waves</li>\n<li>EMG shows Minimal activity</li>\n</ul>\n<p>This is characteristic of <strong>REM sleep</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a6b6553bc57e436b99c8bc5dfd328a30.PNG"
    ],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/d0f0e7a59a714a3f98cb061ff4ce285cx324x232.PNG",
      "https://cdn1.dailyrounds.org/uploads/8d4dfe5fa3fe4c7c884944743a8feb2ex407x293.PNG"
    ]
  },
  {
    "text": "In which phase of sleep bruxism occurs?",
    "choices": [
      {
        "id": 1,
        "text": "NREM2"
      },
      {
        "id": 2,
        "text": "NREM 3"
      },
      {
        "id": 3,
        "text": "REM"
      },
      {
        "id": 4,
        "text": "NREM 4"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Sleep-related bruxism is diagnosed when an individual <strong>grinds or clenches the teeth during sleep</strong>.<strong>&nbsp;</strong>Bruxism occurs more commonly<strong> during NREM 2.</strong></p>\n<p><strong>Parasomnias&nbsp;</strong>refer to abnormal behavior or experiences that arise from or occur during sleep.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following sleep disorder does not  occur in stage 3 of NREM?",
    "choices": [
      {
        "id": 1,
        "text": "Night terror"
      },
      {
        "id": 2,
        "text": "Nocturnal enuresis"
      },
      {
        "id": 3,
        "text": "Bruxism"
      },
      {
        "id": 4,
        "text": "Sleep walking"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Bruxism occurs in stage 2 of NREM, whereas other sleep disorders given in the option &nbsp;occur in stage 3 of NREM</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old male, who met with an RTA, regained consciousness after 36 hours. It was then discovered that the patient is unable to create new memories. Which of the following is the probable site of the lesion?",
    "choices": [
      {
        "id": 1,
        "text": "Amygdala"
      },
      {
        "id": 2,
        "text": "Neocortex"
      },
      {
        "id": 3,
        "text": "Hippocampus"
      },
      {
        "id": 4,
        "text": "Hypothalamus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>From the history, it is clear that the patient is suffering fron <strong>anterograde</strong> <strong>amnesia</strong>, most probably due to a lesion is <strong>hippocampus.</strong></p>\n<p>Hippocampus is the primary structure within the temporal lobe involved in conversion of short-term memory to long-term memory.</p>\n<p>Hippocampal cognitive map is inappropriately reactivated during a deja vu experience.</p>\n<p>Hippocampus does not store memory but only converts short-term memory to long-term memory. Hence, hippocampal lesions cause only anterograde amnesia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is correctly paired to show the relationship between a brain area and a type of memory?",
    "choices": [
      {
        "id": 1,
        "text": "Neocortex and associative learning"
      },
      {
        "id": 2,
        "text": "Medial temporal lobe and declarative memory"
      },
      {
        "id": 3,
        "text": "Angular gyrus and procedural memory"
      },
      {
        "id": 4,
        "text": "Striatum and priming"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Declarative memory</strong> involves the<strong> hippocampus</strong> and the <strong>medial temporal lobe</strong> for <strong>retention.</strong></p>\n<p>Priming&nbsp;-&nbsp;neocortex.</p>\n<p>Procedural memory&nbsp;-&nbsp;striatum.</p>\n<p>Associative learning-&nbsp;&nbsp;amygdala for its emotional responses and the cerebellum for the motor responses.</p>\n<p>Nonassociative learning&nbsp;-&nbsp;&nbsp;various reflex pathways.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old man is severely injured in a road traffic accident. Brain MRI shows significant damage to the bilateral frontal lobes. Which of the following neurological features will be least likely seen in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Slowed thinking"
      },
      {
        "id": 2,
        "text": "Decreased curiosity"
      },
      {
        "id": 3,
        "text": "Social withdrawal"
      },
      {
        "id": 4,
        "text": "Retained judgement"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Retained judgement&nbsp;will be least likely seen if the patient survives such a devastating injury.</p>\n<p>Injury to the frontal lobe may lead to&nbsp;<strong>frontal lobe syndrome</strong>, which consists of <strong>poor judgment</strong>, <strong>slowed thinking</strong>, <strong>decreased curiosity</strong>, <strong>social withdrawal</strong>, and <strong>irritability.&nbsp;</strong></p>\n<p><strong>Frontal lobe injury:</strong></p>\n<ul>\n<li>Impairs the executive functions: motivation, attention, and sequencing of actions</li>\n<li>Aphasia, apraxia, constructional apraxia, neglect, and memory deficits can be seen</li>\n<li>Characterized by changes in personality</li>\n<li>Apathetic indifference and impulsive behaviour.</li>\n<li>Commonly urinary incontinence and faecal incontinence is seen</li>\n<li>Commonly produced by trauma, infarcts, tumours, lobotomy, multiple sclerosis, or Pick's disease.</li>\n</ul>\n<p>Frontal lobe pathology may become apparent only under unstructured, stressful, real-life situations and are difficult to detect in intelligence scales, as IQ mostly requires parietal lobe activation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A lady presents with vascular injury to the inferior frontal gyrus. Which functional area is likely to be affected?",
    "choices": [
      {
        "id": 1,
        "text": "Motor speech area"
      },
      {
        "id": 2,
        "text": "Wernicke's area"
      },
      {
        "id": 3,
        "text": "Auditory area"
      },
      {
        "id": 4,
        "text": "Visual area"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Broca's motor speech area </strong>is likely to be affected in the vascular injury of the<strong> inferior frontal gyrus</strong></p>\n<p>A lesion in this region leads to motor/Broca's aphasia.&nbsp;Speech is non-fluent and interrupted by many word-finding pauses. The speech is impoverished in function words that contribute to the syntax but is enriched in meaningful nouns and verbs. However, comprehension of speech is intact and the patient knows what he wants to say.</p>\n<p>For example, a patient with Broca's aphasia may say \"walk dog\" instead of \"I want to take the dog for a walk\".</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is Prosopagnosia?",
    "choices": [
      {
        "id": 1,
        "text": "Impairment of consciousness"
      },
      {
        "id": 2,
        "text": "Being unaware of one\u2019s problems"
      },
      {
        "id": 3,
        "text": "Difficulty in identifying known faces"
      },
      {
        "id": 4,
        "text": "Failure to identify objects"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Prosopagnosia</strong> is <strong>difficulty</strong> in <strong>identifying known faces.</strong></p>\n<p>In humans, storage and recognition of faces is more strongly represented in the <strong>right inferior temporal lobe</strong> in right-handed individuals, though the left lobe is also active. Damage to this area can cause prosopagnosia.</p>\n<p>Patients with this abnormality <strong>can</strong> recognize forms and reproduce them. They <strong>can</strong> recognize people by their voices, and many of them show <strong>autonomic responses</strong> when they see familiar as opposed to unfamiliar faces. However, they <strong>cannot</strong> identify the familiar faces they see. The left hemisphere is also involved, but the role of the right hemisphere is primary.</p>\n<p>The presence of autonomic response to a familiar face in the absence of recognition has been explained by postulating the existence of a separate dorsal pathway for processing information about faces that leads to recognition at only a subconscious level.</p>\n<p>Note:</p>\n<ul>\n<li><strong>Autotopagnosia</strong>&nbsp;- inability to recognize or to orient any part of one's own body</li>\n<li><strong>Simultagnosia</strong>&nbsp;- inability to recognize multiple elements in a visual presentation, one object or some elements of a scene can be appreciated but not the display as a whole</li>\n<li><strong>Somatagnosia</strong>&nbsp;- inability to identify any part of the body, either one&rsquo;s own or another&rsquo;s body</li>\n<li><strong>Tactile agnosia (astereognosis</strong>) - &nbsp;inability to recognize objects by touch, in the presence of intact cutaneous and proprioceptive hand sensation; caused by a lesion in the contralateral parietal lobe</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Emotion is regulated by:",
    "choices": [
      {
        "id": 1,
        "text": "Temporal lobe"
      },
      {
        "id": 2,
        "text": "Frontal lobe"
      },
      {
        "id": 3,
        "text": "Limbic system"
      },
      {
        "id": 4,
        "text": "Parietal lobe"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Emotion is regulated by the frontal lobe.</p>\n<p>There are two aspects of emotion:</p>\n<ul>\n<li><strong>Genesis of emotion </strong>and rating of emotional importance&nbsp;&ndash;from the limbic system &ndash; <strong>amygdala.</strong>&nbsp;\n<ul>\n<li>The limbic system houses the emotional association areas, which direct the hypothalamus to express the motor and endocrine components of the emotional state.</li>\n<li>The amygdala rates the emotional importance of an experience and activates the hippocampus (memory) accordingly. Thus an emotionally intense experience is etched in memory, which is the basis for learned fear responses.</li>\n<li>Damage to the amygdala ablates the ability to distinguish fear and anger in other persons' voices and facial expressions.</li>\n</ul>\n</li>\n<li><strong>Regulation of emotion&nbsp;</strong>-&nbsp;<strong>frontal lobe.</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d8ef5a926c6d468ba9063acd5f2105afx800x533.PNG"
    ]
  }
];
        let quizName = '18 Higher Mental Functions';
        const quizFilename = '18-higher-mental-functions-173bc6a7.html';
        let hierarchy = ["Marrow", "qBank", "Physiology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>