<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>23 Childhood Respiratory Disorders - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pediatrics
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">32</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A mother brought a healthy-looking, 3-month-old infant for routine immunization. As you were giving the shot, you noticed some noisy breathing in the baby, which became worse once he started crying. However, it decreased, as you held him in a prone position. There were no clear signs of distress. According to his mother, he had been feeding well at home and has not had any episodes of apnea or cyanosis. Which is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Laryngeal stenosis"
      },
      {
        "id": 2,
        "text": "Laryngeal web"
      },
      {
        "id": 3,
        "text": "Laryngomalacia"
      },
      {
        "id": 4,
        "text": "Laryngeal papilloma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>\u00a0</p>\n<p>On laryngoscopy, an <strong>omega-shaped</strong> epiglottis is visualized.\u00a0</p>\n<p>In most children, only <strong>expectant observation</strong> is required as the condition resolves secondary to nervous system maturation, within <strong>18 to 24</strong> <strong>months</strong> of birth. However, neonates with severe laryngomalacia may develop marked upper airway obstruction resulting in cor pulmonale, life-threatening apneic episodes, feeding difficulties, obstructive sleep apnea, and failure to thrive.\u00a0In such cases, <strong>surgical resection of supraglottic tissues</strong> and <strong>supraglottoplasty</strong> has been the favoured approach.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3c41e8790dcf4087bf87a9691f0ec405x720x720.JPEG"
    ]
  },
  {
    "text": "A senior casualty nurse informs you that a 5-year-old girl with severe respiratory distress might require intubation. You just finished stabilising and placing an ET tube in Mohan, a 57-year-old man with head trauma and a GCS of 7. Which of the following is not a feature of child's airway?",
    "choices": [
      {
        "id": 1,
        "text": "The larynx being located higher in the neck at the level of C3-C4"
      },
      {
        "id": 2,
        "text": "The narrowest part being the subglottic region"
      },
      {
        "id": 3,
        "text": "The tongue being relatively larger"
      },
      {
        "id": 4,
        "text": "Having a cylindrical shape"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The pediatric airway is <strong>funnel shaped</strong>. In comparison, the adult airway is cylindrical.</p>\n<p>In newborns, the larynx is situated at the level of <strong>C3-C4</strong>, where it facilitates simultaneous respiration and swallowing during feeding.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a night shift, you get a call from the ER to come and see a toddler, who presented with complaints of fever, drooling, and a muffled voice since evening. On examination, the child has a stridor and you pick up a \"thumb sign\" on the lateral x-ray of his neck. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Croup"
      },
      {
        "id": 2,
        "text": "Acute epiglottitis"
      },
      {
        "id": 3,
        "text": "Foreign body aspiration"
      },
      {
        "id": 4,
        "text": "Retropharyngeal abscess"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Thumb sign&nbsp;</strong>on lateral x-ray of neck is pathognomonic for <strong>acute epiglottitis (AE)</strong>. It is seen due to epiglottic enlargement.</p>\n<p>AE is an inflammation of the epiglottis. The arytenoids, false cords, and posterior tongue may also be involved.</p>\n<p>In children, <em><strong>Haemophilus influenzae type B (Hib)</strong></em> is the most common cause. This has decreased dramatically since the widespread availability of immunization (pentavalent). <em>Streptococcus pyogenes, S. pneumoniae</em>, and <em>S. aureus</em> have also been implicated. Non-infectious causes can be foreign body ingestion and trauma from thermal or caustic agents.</p>\n<p>It has a progressive and potentially fulminating course, characterised by high fever, sore throat, dyspnea, and rapidly progressing respiratory obstruction.</p>\n<p>AE is a <strong>clinical diagnosis</strong> and a true emergency,&nbsp;X-ray soft tissue neck is not necessary to confirm it.&nbsp; It may be used to rule out differentials such as laryngotracheobronchitis, foreign body obstruction, retropharyngeal abscess or congenital anomalies. The time taken for X-rays should be avoided in a critically ill child due to the risk of sudden complete airway obstruction.</p>\n<p>The definitive diagnosis of AE is made during <strong>direct laryngoscopy.&nbsp;</strong>However, since manipulation can induce a laryngospasm, it is <strong>generally avoided</strong>.</p>\n<p>The image below shows thumb sign:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a7fe8389fc634856bb9010d8ae4b7fa1x467x422.JPEG"
    ]
  },
  {
    "text": "Which of the following is the most common etiological agent associated with epiglottitis in children, overall in the world?",
    "choices": [
      {
        "id": 1,
        "text": "H. Influenza type B"
      },
      {
        "id": 2,
        "text": "Influenza virus"
      },
      {
        "id": 3,
        "text": "Moraxella"
      },
      {
        "id": 4,
        "text": "Streptococcus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The most common etiological agent, overall in the world, of acute epiglottitis in the pediatric age group, now is <em>Streptococcus</em>.</p>\n<p class=\"p1\">In the past, <em>Haemophilus influenzae</em> type b (Hib) used to be the most commonly identified cause of acute epiglottitis. But, since the widespread use of the <em>H. influenzae</em>&nbsp;type b vaccine, invasive disease caused by <em>H. influenzae</em> type b in pediatric patients has been reduced by 99%.</p>\n<p class=\"p1\">Therefore, other organisms, such as <em>Streptococcus pyogenes</em>&nbsp;(GAS), <em>Streptococcus penumoniae</em>, non-typeable <em>H. influenzae</em>, and <em>Staphylococcus aureus</em>, have become the common causes of acute epiglottitis in pediatric age group, overall in the world.</p>\n<p class=\"p1\">Lateral X-ray of the&nbsp;neck shows the&nbsp;<strong>thumb sign&nbsp;</strong>in acute epiglottitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 5 year old boy was suffering from low grade fever, inspiratory stridor and barking cough for past 5 days. His chest X-ray is given below. What is the cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Moraxella"
      },
      {
        "id": 2,
        "text": "Parainfluenza"
      },
      {
        "id": 3,
        "text": "Hemophilus influenza"
      },
      {
        "id": 4,
        "text": "Staphylococcus aureus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Barking cough</strong> is a feature of <strong>laryngotracheobronchitis,</strong> which is caused by the <strong>parainfluenza virus. </strong>The X-ray finding is the '<strong>Steeple sign'</strong>&nbsp;due to subglottic narrowing.</p>\n<p>The age of presentation of laryngotracheobronchitis ranges from<strong>&nbsp;</strong>6 months-6 years. The clinical features include barking cough, inspiratory stridor, hoarseness, low-grade fever.</p>\n<p>Management:</p>\n<ul>\n<li><strong>Racemic epinephrine nebulization</strong>&nbsp;leads to&nbsp;the rapid improvement of upper airway obstruction. Epinephrine constricts pre-capillary arterioles in the upper airway mucosa and decreases capillary hydrostatic pressure, leading to fluid resorption and <strong>improvement</strong> in <strong>airway edema.</strong></li>\n<li><strong>Dexamethasone</strong>-by the <strong>least invasive</strong> route (Oral&gt;IV&gt;IM ). It is indicated in all the grades of croup.</li>\n<li><strong>Oxygen</strong> should be administered to children who are hypoxemic (SpO2 &lt;92 %)</li>\n</ul>\n<p>Antibiotics are not indicated in laryngotracheobronchitis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a48f0784d9574f9b998d3e7d37e96180.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "2-year-old Neha has been having fever since yesterday and is refusing food. Parents became alarmed when she developed an abnormal barking cough today morning and have brought her to the casualty. On examination, the child looked exhausted and had visible chest retractions and stridor. The temperature was 39.6 degrees and SpO2 was 93% on room air. Chest X-ray reveals a 'steeple' sign. What is the treatment of choice in this child?",
    "choices": [
      {
        "id": 1,
        "text": "Racemic epinephrine nebulization"
      },
      {
        "id": 2,
        "text": "Humidified oxygen and salbutamol nebulization"
      },
      {
        "id": 3,
        "text": "Send a throat swab and start IV antibiotics"
      },
      {
        "id": 4,
        "text": "High dose dexamethasone injection"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Fever, barking cough, inspiratory stridor and a steeple sign on chest radiograph are suggestive of <strong>acute laryngotracheobronchitis</strong> (croup). The treatment of choice in this child is <strong>nebulization&nbsp;with racemic epinephrine.&nbsp;</strong></p>\n<p>Epinephrine <strong>acts rapidly</strong> and provides immediate relief. It <strong>constricts pre-capillary arterioles</strong> in the upper airway mucosa and decreases capillary hydrostatic pressure. This increases fluid resorption and <strong>reduces airway edema.</strong></p>\n<p><strong>Westley Croup Severity Score:</strong>&nbsp;</p>\n<table style=\"height: 235px; width: 487px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 102px; height: 18px;\"><strong>Feature</strong></td>\n<td style=\"width: 63px; height: 18px;\"><strong>&nbsp;0</strong></td>\n<td style=\"width: 74px; height: 18px;\"><strong>1</strong></td>\n<td style=\"width: 72px; height: 18px;\"><strong>2</strong></td>\n<td style=\"width: 49px; height: 18px;\"><strong>3</strong></td>\n<td style=\"width: 62px; height: 18px;\"><strong>4</strong></td>\n<td style=\"width: 21px; height: 18px;\"><strong>5</strong></td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 102px; height: 36px;\"><strong>Stridor</strong></td>\n<td style=\"width: 63px; height: 36px;\">None</td>\n<td style=\"width: 74px; height: 36px;\">With agitation</td>\n<td style=\"width: 72px; height: 36px;\"><strong>At rest</strong></td>\n<td style=\"width: 49px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 62px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 21px; height: 36px;\">&nbsp;</td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 102px; height: 36px;\"><strong>Air Entry</strong></td>\n<td style=\"width: 63px; height: 36px;\">Normal</td>\n<td style=\"width: 74px; height: 36px;\">Decreased</td>\n<td style=\"width: 72px; height: 36px;\">Markedly decreased</td>\n<td style=\"width: 49px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 62px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 21px; height: 36px;\">&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 102px; height: 18px;\"><strong>Retractions</strong></td>\n<td style=\"width: 63px; height: 18px;\">None</td>\n<td style=\"width: 74px; height: 18px;\"><strong>Mild</strong></td>\n<td style=\"width: 72px; height: 18px;\">Moderate</td>\n<td style=\"width: 49px; height: 18px;\">Severe</td>\n<td style=\"width: 62px; height: 18px;\">&nbsp;</td>\n<td style=\"width: 21px; height: 18px;\">&nbsp;</td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 102px; height: 36px;\"><strong>Cyanosis</strong></td>\n<td style=\"width: 63px; height: 36px;\">None</td>\n<td style=\"width: 74px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 72px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 49px; height: 36px;\">&nbsp;</td>\n<td style=\"width: 62px; height: 36px;\">With agitation</td>\n<td style=\"width: 21px; height: 36px;\">At Rest</td>\n</tr>\n<tr style=\"height: 55px;\">\n<td style=\"width: 102px; height: 55px;\"><strong>Level of Consciousness</strong></td>\n<td style=\"width: 63px; height: 55px;\"><strong>Normal,</strong> including sleep</td>\n<td style=\"width: 74px; height: 55px;\">&nbsp;</td>\n<td style=\"width: 72px; height: 55px;\">&nbsp;</td>\n<td style=\"width: 49px; height: 55px;\">&nbsp;</td>\n<td style=\"width: 62px; height: 55px;\">&nbsp;</td>\n<td style=\"width: 21px; height: 55px;\">Disoriented</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Overall score and severity</strong></p>\n<ul>\n<li>0 to 2- mild</li>\n<li><strong>3 to 7- moderate</strong></li>\n<li>8 to 11- severe</li>\n<li>12 to 17- impending respiratory failure</li>\n</ul>\n<p><strong>Treatment of moderate to severe croup :</strong></p>\n<ul>\n<li>Racemic <strong>epinephrine</strong> nebulization</li>\n<li><strong>Dexamethasone </strong>is indicated in all grades of croup and is given<strong>&nbsp;</strong>by the least invasive route <strong>(Oral</strong>&gt;IM&gt;IV<strong>)</strong></li>\n<li><strong>Oxygen</strong> should be administered to children who are hypoxemic (SpO2 &lt;92 %)</li>\n<li>Antibiotics are <strong>not indicated</strong> in croup</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A child in your unit is admitted with acute bronchiolitis. Which of the following is the most common etiological agent responsible for this condition during infancy?",
    "choices": [
      {
        "id": 1,
        "text": "Influenza virus"
      },
      {
        "id": 2,
        "text": "Para Influenza virus"
      },
      {
        "id": 3,
        "text": "Rhinovirus"
      },
      {
        "id": 4,
        "text": "Respiratory syncytial virus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Acute bronchiolitis is predominantly a <strong>viral</strong> disease in children <strong>younger than 2 years</strong>. <strong>Respiratory syncytial virus (RSV)</strong>&nbsp;is the most likely etiological agent and is responsible for more than 50% of cases.</p>\n<p>Acute bronchiolitis refers to airway inflammation and obstruction of the lower respiratory tract.</p>\n<p>Clinical features of bronchiolitis include fever, cough,&nbsp;<strong>fine inspiratory crackles, expiratory wheezes</strong>, and breathing difficulty. Cyanosis may be seen in severe cases.</p>\n<p>Radiographs may be normal in some patients. In the majority of them, there will be&nbsp;<strong>interstitial infiltrates</strong>,&nbsp;<strong>hyper-expansion</strong>&nbsp;of the&nbsp;<strong>chest</strong>, and&nbsp;<strong>peribronchial thickening</strong>.&nbsp;</p>\n<p>Management is mainly conservative.&nbsp;Hypoxemic children should receive cool, humidified oxygen. Rarely, a child might develop respiratory failure and require hospitalization and invasive ventilation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "10-month-old Ishaan was presented to the OPD with a 3-day history of lower respiratory tract symptoms and an expiratory wheeze. Chest X-ray showed mild peribronchial thickening.  Which of the following statements is false regarding the condition described?",
    "choices": [
      {
        "id": 1,
        "text": "The risk is higher for infants with young mothers or mothers who smoked during pregnancy."
      },
      {
        "id": 2,
        "text": "It is more common in children who have not been breastfed."
      },
      {
        "id": 3,
        "text": "The mainstay of treatment is antibiotics."
      },
      {
        "id": 4,
        "text": "There is a higher incidence of wheezing and asthma in children with a history of bronchiolitis."
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of <strong>acute bronchiolitis.</strong> The\u00a0<strong>treatment</strong> is mainly<strong> supportive</strong>. Hypoxemic children should receive cool, humidified oxygen. Rarely, a child might develop respiratory failure and require hospitalization and invasive ventilation.</p>\n<p>It is more common in boys, in those who have <strong>not been breastfed</strong>, and in those who live in crowded conditions. The risk is higher for infants with <strong>young </strong>mothers or mothers who <strong>smoked</strong> during pregnancy.</p>\n<p>Acute bronchiolitis is predominantly a viral disease caused by <strong>respiratory syncytial virus (RSV)</strong> and antibiotics are not indicated.</p>\n<p>There is a higher incidence of wheezing and asthma in children with a history of bronchiolitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The pediatric intensivist is contemplating whether to start aerosolized ribavirin in a young boy with a severe respiratory infection. There would be a clear indication to start the drug if _________.",
    "choices": [
      {
        "id": 1,
        "text": "The child is immunocompromised"
      },
      {
        "id": 2,
        "text": "The child has not received any immunization"
      },
      {
        "id": 3,
        "text": "There is a history of severe atopy"
      },
      {
        "id": 4,
        "text": "There is a history of recurrent infection"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Ribavirin is the only specific antiviral therapy available for the treatment of <strong>severe bronchiolitis</strong> caused by <strong>RSV</strong> infections. It is reserved as a last-line agent for life-threatening bronchiolitis in patients who are <strong>immunocompromised</strong> or who have <strong>hemodynamically significant cardiopulmonary disease.</strong> &nbsp;In otherwise healthy children, the management of acute RSV bronchiolitis is typically supportive.&nbsp;</p>\n<p>Ribavirin is a prodrug, which when metabolized resembles purine RNA nucleotides. In this form, it interferes with RNA metabolism required for viral replication.&nbsp;</p>\n<p><strong>MNEMONIC: </strong>(for&nbsp;indications of ribavirin)&nbsp;</p>\n<ul>\n<li><strong>C-RIBA</strong>virin:\n<ul>\n<li>Hepatitis <strong>C</strong></li>\n<li><strong>R</strong>SV</li>\n<li><strong>I</strong>nfluenza <strong>B</strong></li>\n<li><strong>A</strong>renaviruses (Lassa, Bolivian, etc.)</li>\n</ul>\n</li>\n</ul>\n<p><strong>Note</strong> - Ribavirin is also used in the treatment of hepatitis C and some viral hemorrhagic fevers.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "3-year-old Sravya was referred with a one-week history of being unable to look upwards, constant neck flexion, and deviation to the right side. Parents also complained of feeding difficulty. On examination, the child was noted to have poor oral hygiene and the neck was tender on palpation. The X-ray is given below. Which of the following statements are false about the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "It occurs mostly in children younger than 3-4 years"
      },
      {
        "id": 2,
        "text": "It is more common in boys"
      },
      {
        "id": 3,
        "text": "Examination shows unilateral bulging of the posterior pharyngeal wall"
      },
      {
        "id": 4,
        "text": "Trauma to the posterior pharynx is the most common cause"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The history of progressive torticollis, neck pain and dysphagia in a young child along with a neck X-ray demonstrating a prevertebral soft-tissue swelling are all indicative of a <strong>retropharyngeal abscess. </strong>In young children<strong>, an antecedent upper respiratory tract infection\u00a0</strong>is the most common cause of an RP abscess and <strong>not trauma.\u00a0</strong></p>\n<p>It involves the suppuration of lymph nodes present in the RP space and is more common in <strong>children younger than 3-4 years\u00a0</strong>since\u00a0these lymph node chains <strong>involute</strong> after 5 years of age.\u00a0<strong>Boys </strong>are affected more often than girls.\u00a0In<strong> older children and adults</strong>, the cause is usually<strong> trauma</strong> to the posterior pharynx, which leads to inoculation of the retropharyngeal space.</p>\n<p>Risk factors include poor oral hygiene, diabetes, an immunocompromised state, and low socioeconomic status.</p>\n<p>Clinical manifestations are nonspecific and include fever, decreased oral intake, and drooling. Neck stiffness and torticollis may also be present.\u00a0As the abscess grows in size, it can also lead to upper airway obstruction and asphyxiation. The physical examination can reveal <strong>unilateral</strong> bulging of the posterior pharyngeal wall.\u00a0</p>\n<p>Although lateral radiograph is used for initial imaging, <strong>CT of the neck with intravenous contrast</strong> is the best imaging study to evaluate patients with a retropharyngeal abscess. Treatment ranges from prolonged courses of intravenous antibiotics to surgical incision and drainage.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/af51b1c3b83d4a8cb4692187b7c62470.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "The most common cause of bacterial pneumonia in children 3 weeks to 4 years of age is ______.",
    "choices": [
      {
        "id": 1,
        "text": "Haemophilus influenzae"
      },
      {
        "id": 2,
        "text": "Streptococcus pneumoniae"
      },
      {
        "id": 3,
        "text": "Streptococcus pyogenes"
      },
      {
        "id": 4,
        "text": "Staphylococcus aureus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong><em>Streptococcus pneumoniae</em></strong> (pneumococcus) is the most common <strong>bacterial</strong> pathogen in children 3 weeks to 4 years of age.</p>\n<p>Aetiology of infectious pneumonia grouped by age of the patient:</p>\n<table style=\"height: 251px; width: 752.797px;\">\n<tbody>\n<tr>\n<td style=\"width: 161px;\"><strong>Age group</strong></td>\n<td style=\"width: 575.797px;\"><strong>Frequent pathogens (in order of frequency)</strong></td>\n</tr>\n<tr>\n<td style=\"width: 161px;\">&lt; 3 weeks</td>\n<td style=\"width: 575.797px;\">Group B Streptococcus, E.coli, gram-negative bacilli, S. pneumoniae, Hemophilus influenzae (type b)</td>\n</tr>\n<tr>\n<td style=\"width: 161px;\">3 weeks - 4 years</td>\n<td style=\"width: 575.797px;\">RSV, other respiratory viruses (rhinovirus, influenza, parainfluenza and adenovirus), <strong>S. pneumoniae</strong>,&nbsp;Hemophilus influenzae (type b), Mycoplasma pneumoniae</td>\n</tr>\n<tr>\n<td style=\"width: 161px;\">&gt; 4 years</td>\n<td style=\"width: 575.797px;\">Mycoplasma pneumoniae, Chlamydophila pneumoniae,&nbsp;S. pneumoniae, Hemophilus influenzae (type b)</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 9-year-old boy presented with a 4-day history of high-grade fever and a productive cough with yellow sputum. Chest x-ray showed a consolidation in the right middle zone. According to WHO guidelines, which of the following is not an indication for hospital admission?",
    "choices": [
      {
        "id": 1,
        "text": "Chest indrawing"
      },
      {
        "id": 2,
        "text": "Persistent vomiting"
      },
      {
        "id": 3,
        "text": "Convulsions"
      },
      {
        "id": 4,
        "text": "Severe malnutrition"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>As per the revised 2014 WHO guidelines, it is <strong>safe</strong> to <strong>treat chest indrawing pneumonia at home</strong>.</p>\n<p>However, a child who is <strong>HIV positive </strong>and has <strong>chest indrawing</strong> will need to be referred for <strong>inpatient treatment.</strong>\u00a0Only those children who have general danger signs are classified as having \u201csevere pneumonia\u201d and need to be referred to a higher level (hospital admission).</p>\n<p><strong>Danger signs:</strong></p>\n<ul>\n<li>Not able to drink</li>\n<li>Persistent vomiting</li>\n<li>Convulsions</li>\n<li>Lethargic or unconscious</li>\n<li>Stridor in a calm child</li>\n<li>Severe malnutrition</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ac092692af4842abbdce039bc6d5802ex517x291.PNG"
    ]
  },
  {
    "text": "A 5th standard girl is brought to the OPD with a high fever and cough with expectoration for 3 days. Her chest X-ray shows multiple pneumatoceles. Which of the following is the most common etiological agent implicated in this presentation?",
    "choices": [
      {
        "id": 1,
        "text": "Mycobacterium tuberculosis"
      },
      {
        "id": 2,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 3,
        "text": "Mycobacterium avium intracellulare"
      },
      {
        "id": 4,
        "text": "Pneumocystis carnii"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong><em>Staphylococcus aureus</em></strong> pneumonia manifests as confluent bronchopneumonia, which is often <strong>unilateral</strong> and characterized by the presence of<strong> hemorrhagic necrosis </strong>and<strong> irregular </strong>areas of <strong>cavitation</strong> of the lung parenchyma<strong>,</strong> resulting in<strong> pneumatoceles, empyema, or </strong>at times, <strong>bronchopulmonary fistulas</strong>.&nbsp;</p>\n<p>The following CT image shows cavitating pneumonia by <em>S. aureus</em>:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/640d1bfba49d452991d3e3987c9010e7x718x600.PNG"
    ]
  },
  {
    "text": "A one-and-half-year-old child brought to the hospital with a history of breathlessness, fever, cough, and cold. On examination, respiratory rate was 46/min, and there were no chest retractions. Which is the most appropriate management?",
    "choices": [
      {
        "id": 1,
        "text": "Give IV antibiotics and observe"
      },
      {
        "id": 2,
        "text": "Give IV antibiotics and refer to higher centre"
      },
      {
        "id": 3,
        "text": "Oral antibiotics, warn of danger signs, and send home"
      },
      {
        "id": 4,
        "text": "No need of treatment only home remedies"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>&nbsp;</p>\n<p>Fast breathing is defined as given in the table below:</p>\n<table border=\"1\">\n<tbody>\n<tr>\n<td><strong>Age of child</strong></td>\n<td><strong>Fast breathing RR</strong></td>\n</tr>\n<tr>\n<td>&lt;2 months</td>\n<td>60 breaths/min</td>\n</tr>\n<tr>\n<td>2-12 months</td>\n<td>50 breaths/min</td>\n</tr>\n<tr>\n<td>1-5 years</td>\n<td>40 breaths/min</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/258c38a90e844f21be5225fcde567d28x1280x757.3534971644613.PNG"
    ]
  },
  {
    "text": "An adolescent boy with a family history of asthma presented with intermittent wheeze and cough for 2 months. The onset of wheeze is triggered during exercise and while playing at school. Which of the following is preferred as regular therapy for the prevention of his symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Inhaled short acting beta 2 agonist (SABA)"
      },
      {
        "id": 2,
        "text": "Inhaled corticosteroids"
      },
      {
        "id": 3,
        "text": "Inhaled long acting beta 2 agonist (LABA)"
      },
      {
        "id": 4,
        "text": "Anti \u2013 IgE antibody"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Inhaled corticosteroids</strong> are recommended as <strong>regular therapy</strong> for the prevention of his symptoms of <strong>exercise-induced asthma.</strong></p>\n<p>According to GINA 2021 guidelines, exercise-induced bronchoconstriction can be prevented with daily treatment (regular therapy) with inhaled corticosteroids. SABA, LABA, or chromones may be used prior to exercise, along with warm-up before exercise.&nbsp;</p>\n<p>Those who have mild exercise-induced asthma can use their regular inhaled corticosteroid before exercise and need not take SABA pre-exercise.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 17-year-old boy presented to the clinic with an acute respiratory tract infection. He has a history of asthma associated with recurrent respiratory tract infections and sinusitis. Genetic testing in childhood had revealed CFTR mutations. Which of the following is likely to be decreased in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Sweat chloride"
      },
      {
        "id": 2,
        "text": "Serum bicarbonate level"
      },
      {
        "id": 3,
        "text": "Sperm count"
      },
      {
        "id": 4,
        "text": "Stool fat"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option A:&nbsp;<strong>Sweat chloride</strong>&nbsp;levels are elevated (<strong>&ge;60 mEq/L</strong>) due to abnormalities in the CFTR protein leading to&nbsp;<strong>defective chloride transport</strong>.&nbsp;</p>\n<p>Option B:&nbsp;<strong>Serum bicarbonate</strong>&nbsp;levels are increased due to excessive loss of salt in the sweat resulting in&nbsp;<strong>hypochloremic alkalosis</strong>.</p>\n<p>Option D: Patients with&nbsp;cystic fibrosis have fat <strong>malabsorption</strong> secondary to<strong> exocrine pancreatic insufficiency,</strong>&nbsp;hence the <strong>increased</strong> stool <strong>fat.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following has similar inheritance pattern as cystic fibrosis?",
    "choices": [
      {
        "id": 1,
        "text": "Accumulation of glycogen in the lysosome"
      },
      {
        "id": 2,
        "text": "Trinucleotide repeat expansion of CAG on chromosome 4"
      },
      {
        "id": 3,
        "text": "Adult onset polycystic kidney disease"
      },
      {
        "id": 4,
        "text": "RB gene mutation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Cystic fibrosis (CF)</strong>, is an <strong>autosomal-recessive disorder</strong>. Accumulation of glycogen in the lysosome is seen in <strong>Pompe's disease&nbsp;</strong>which is&nbsp;another autosomal-recessive disorder.</p>\n<p>Option B: Trinucleotide repeat expansion of CAG on chromosome 4 is seen in Huntington's disease, which is autosomal dominant.</p>\n<p>Options C and D: Adult-onset polycystic kidney disease and retinoblastoma (<em>RB</em> gene mutation) are autosomal-dominant diseases.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements about cystic fibrosis is not true?",
    "choices": [
      {
        "id": 1,
        "text": "It is an autosomal-recessive disorder."
      },
      {
        "id": 2,
        "text": "Abnormality in CFTR gene leads to defective calcium transport."
      },
      {
        "id": 3,
        "text": "Mutation in cystic fibrosis transport regulator is seen."
      },
      {
        "id": 4,
        "text": "Males have infertility in adult life"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Cystic fibrosis (CF) is an <strong>autosomal-recessive</strong> disorder of children and adults. Dysfunction of the CFTR, the primary defect, leads to a wide and variable array of presenting manifestations and complications.</p>\n<p>The most common CFTR mutation is <strong>F508 deletion</strong>.</p>\n<p>More than 95% of males are <strong>azoospermic</strong> because of failure of development of Wolffian duct structures, but the sexual function is generally unimpaired.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The most common organism causing pneumonia in cystic fibrosis among the pediatric age group is ________.",
    "choices": [
      {
        "id": 1,
        "text": "Pseudomonas aeruginosa, non-mucoid"
      },
      {
        "id": 2,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 3,
        "text": "Burkholderia cepacia"
      },
      {
        "id": 4,
        "text": "Streptococcus pneumoniae"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong><em>Staphylococcus aureus</em></strong> is the <strong>most common</strong> organism causing pneumonia in cystic fibrosis among the given options.</p>\n<p>The most common organisms causing pneumonia in CF patients:</p>\n<ul>\n<li>The <strong>pediatric</strong> age group-<em><strong>&nbsp;S. aureus&nbsp;</strong></em></li>\n<li>The <strong>adult</strong> population-<em><strong>&nbsp;P.&nbsp;aeruginosa&nbsp;</strong></em>(mucoid)</li>\n</ul>\n<p><strong><em>Pseudomonas aeruginosa</em></strong>-<strong>mucoid</strong>&nbsp;may also cause pneumonia in pediatric CF patients.</p>\n<p>In cystic fibrosis,<em> P. aeruginosa</em>&nbsp;shows a special feature of developing a&nbsp;<strong>mucoid capsule</strong>.&nbsp;This complex polysaccharide generates a biofilm that&nbsp;provides a hypoxic environment and thereby protects <em>Pseudomonas</em> against antimicrobial agents.</p>\n<p><em>Burkholderia cepacia </em>pneumonia is associated with <strong>higher mortality</strong>, but it is not the most common. These patients are found to have severe pulmonary hypertension, possibly due to pulmonary inflammatory vascular response.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 5-year-old boy was evaluated for cystic fibrosis. Sweat chloride shows value of 38 and 44 mEq/L (normal<40). Which is the next best test to confirm the diagnosis of cystic fibrosis?",
    "choices": [
      {
        "id": 1,
        "text": "72-hour fecal fat"
      },
      {
        "id": 2,
        "text": "CT chest"
      },
      {
        "id": 3,
        "text": "DNA analysis"
      },
      {
        "id": 4,
        "text": "Trans epithelial nasal potential difference"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Options A and B: 72-hour fecal fat and chest CT are not used in the diagnosis of CF.\u00a0</p>\n<p>Option D: This testing is primarily used in research applications and has never undergone extensive validation as a clinical tool.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A couple planning for pregnancy visits you for genetic counseling. They are both known to be heterozygous carriers of CFTR mutations. Which of the following is the most likely complication in an affected child at birth?",
    "choices": [
      {
        "id": 1,
        "text": "Hyaline membrane disease"
      },
      {
        "id": 2,
        "text": "Transient tachypnea of newborn"
      },
      {
        "id": 3,
        "text": "Meconium ileus"
      },
      {
        "id": 4,
        "text": "Sigmoid volvulus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Radiological image shows contrast enema in a newborn infant with abdominal distention and failure to pass meconium. Several air&ndash;fluid levels in the small bowel are visible on the upright lateral view.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3829a83ac0fe40d4bc0a545d8685360fx453x600.JPEG"
    ]
  },
  {
    "text": "A 9-year-old boy, diagnosed with cystic fibrosis shortly after birth has been having around 2-3 exacerbations per year, requiring hospital admissions. Infection by which of the following organisms has increased mortality in such patients?",
    "choices": [
      {
        "id": 1,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 2,
        "text": "Pseudomonas aerogenes"
      },
      {
        "id": 3,
        "text": "Burkholderia cepacia"
      },
      {
        "id": 4,
        "text": "Aeromonas"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Cystic fibrosis</strong> patients with <strong><em>Burkholderia cepacia </em></strong>pneumonia are found to have severe pulmonary hypertension, possibly due to pulmonary inflammatory vascular response, and have <strong>higher mortality.</strong></p>\n<p><strong><em>Staphylococcus aureus</em></strong> and <strong><em>Pseudomonas aeruginosa</em>&nbsp;(mucoid)</strong> are the <strong>most common</strong> pathogens causing pneumonia in CF patients. However, they have lower mortality compared to <em>B. cepacia</em>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 3-year-old boy presents with a history of recurrent pneumonia and chronic diarrhea. His mother states that he has 6-8 foul-smelling stools per day. Physical examination reveals a low-grade fever and scattered rhonchi over both lung fields. Sweat chloride testing is elevated on 2 separate occasions. Which of the following drugs is used as a treatment option for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ivacaftor"
      },
      {
        "id": 2,
        "text": "Ravulizumab"
      },
      {
        "id": 3,
        "text": "Tecovirimat"
      },
      {
        "id": 4,
        "text": "Mepolizumab"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p class=\"p1\">The given clinical scenario is suggestive of <strong>cystic fibrosis</strong> (CF).&nbsp;<strong>Ivacaftor</strong> is used in the treatment of cystic fibrosis.</p>\n<p class=\"p1\">Ivacaftor is a potentiator of the chloride channel and overcomes its defect. It activates the CFTR-G551D mutant protein.</p>\n<p class=\"p1\">Remember: Iva<strong>C</strong>a<strong>FT</strong>o<strong>R</strong> (CFTR mutation in CF)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 4-year-old girl presented with cough and difficulty breathing following accidental inhalation of a peanut. On examination, there was localised wheezing and decreased breath sounds on the right side. What is the next best step in management?",
    "choices": [
      {
        "id": 1,
        "text": "Chest X-ray"
      },
      {
        "id": 2,
        "text": "Rigid bronchoscopy"
      },
      {
        "id": 3,
        "text": "Flexible endoscopy"
      },
      {
        "id": 4,
        "text": "Direct Laryngoscopy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In a\u00a0child with a<strong> suspected foreign body</strong> in the lung, the next best step would be to do a <strong>rigid bronchoscopy </strong>as it is<strong>\u00a0both diagnostic and therapeutic</strong>.</p>\n<p>The rigid bronchoscope has a ventilation mechanism and a suction port making it easy for visualization and handling of the foreign body. However, it is pertinent\u00a0to note that the initial investigation is usually a <strong>chest X-ray.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All the following are true about Macleod syndrome except that _______.",
    "choices": [
      {
        "id": 1,
        "text": "It is also called Swyer-James syndrome."
      },
      {
        "id": 2,
        "text": "It is not a true emphysema."
      },
      {
        "id": 3,
        "text": "It is mostly linked to adenovirus."
      },
      {
        "id": 4,
        "text": "Affected lung is larger in size compared to unaffected lung."
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Macleod syndrome refers to the inability of the lungs to grow after a severe obstructive bronchiolitis. Children with this condition often have chronic cough, recurrent pneumonia, and wheezing. On CT scan, the <strong>affected lung shows small size</strong> and decreased vascularity, hyperexpansion,&nbsp;and hyperlucency <strong>(false emphysema)</strong>.</p>\n<p>It is also called Swyer&ndash;James syndrome. It is mostly linked to adenovirus.&nbsp;Patients respond well to bronchodilators.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 15-year-old child has been recurrently hospitalized for infections, since 2 years of age. After a detailed evaluation, a diagnosis of Kartagener's syndrome was suspected. All of the following are components of the Kartagener triad except _____.",
    "choices": [
      {
        "id": 1,
        "text": "Situs inversus totalis"
      },
      {
        "id": 2,
        "text": "Chronic sinusitis"
      },
      {
        "id": 3,
        "text": "Male infertility"
      },
      {
        "id": 4,
        "text": "Bronchiectasis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Male infertility is typical in Kartagener syndrome, but not a component of the triad.</p>\n<p><strong>Kartagener&rsquo;s syndrome</strong> is <strong>primary ciliary dyskinesia</strong>characterized by the classical triad of:</p>\n<ul>\n<li>Situs inversus</li>\n<li>Chronic sinusitis</li>\n<li>Bronchiectasis</li>\n</ul>\n<p>Primary ciliary dyskinesia (also called immotile cilia syndrome) is an <strong>autosomal recessive</strong> disorder affecting <strong>ciliary motility</strong>. It occurs due to ultrastructural defects in the<strong> dynein</strong> arm of cilia.&nbsp;This causes the retention of secretions due to a failed mucociliary clearance mechanism. Clinically, this manifests as <strong>chronic sinusitis&nbsp;</strong>and recurrent infections that ultimately lead to <strong>bronchiectasis.</strong></p>\n<p>As ciliary function is necessary to ensure proper rotation of the developing organs in the chest and abdomen. Its absence, will lead to&nbsp;<strong>situs inversus</strong> or a partial lateralizing abnormality.</p>\n<p><strong>Male</strong> patients with this condition tend to be<strong> infertile</strong>,&nbsp;due to <strong>asthenospermia</strong> (immotile spermatozoa due to impaired sperm flagella function).&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All the following are components of Young's syndrome except:",
    "choices": [
      {
        "id": 1,
        "text": "Bronchiectasis"
      },
      {
        "id": 2,
        "text": "Asthma"
      },
      {
        "id": 3,
        "text": "Sinusitis"
      },
      {
        "id": 4,
        "text": "Obstructive azoospermia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Asthma is not usually seen in Young's syndrome.</p>\n<p><strong>Young's syndrome</strong> is characterized by:</p>\n<ul>\n<li>Bronchiectasis</li>\n<li>Sinusitis</li>\n<li>Obstructive azoospermia</li>\n</ul>\n<p>In contrast, <strong>Kartagener's syndrome</strong> is characterized by</p>\n<ul>\n<li>Bronchiectasis</li>\n<li>Sinusitis\u00a0</li>\n<li>Situs inversus</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A term male neonate develops respiratory distress at birth, unresponsive to surfactant. Echocardiography is normal and chest X-ray shows a ground-glass appearance. Parents say that their first child died at 10 days of birth due to similar complaints. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Totally anomalous pulmonary venous congestion"
      },
      {
        "id": 2,
        "text": "Meconium aspiration"
      },
      {
        "id": 3,
        "text": "Neonatal pulmonary alveolar proteinosis"
      },
      {
        "id": 4,
        "text": "Diffuse herpes simplex infection"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Treatment options include<strong> total lung lavage</strong>, inhaled or subcutaneous granulocyte-macrophage colony<wbr />-stimulating factor (GM-CSF).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cad662e29af4481a87bcb9934850c01fx1060x939.JPEG"
    ]
  },
  {
    "text": "A 3-month old previously healthy baby was brought to the casualty when the parents found that the baby was not breathing while asleep. Following resuscitative measures, the baby was still apnoeic, pulseless and asystolic. Which of the following is not a risk factor for sudden infant death syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Infants of higher birth order"
      },
      {
        "id": 2,
        "text": "Infants born to women aged >35 years"
      },
      {
        "id": 3,
        "text": "Infants of mother who smoked during pregnancy"
      },
      {
        "id": 4,
        "text": "Infants sleeping in prone position"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Higher maternal age</strong> is not a risk factor for sudden infant death syndrome (SIDS).</p>\n<p>Risk factors for SIDS include</p>\n<ul>\n<li>Low socioeconomic status</li>\n<li>3-4 months of age have the highest incidence</li>\n<li>Higher birth order irrespective of maternal age and low birth weight</li>\n<li>Cigarette smoking, alcohol, and drug abuse during pregnancy</li>\n<li>Sleeping prone, even side sleeping increases the risk</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 6-month-old infant was admitted because of increasing stridor since birth, cough, pulmonary infections, and episodes of acute respiratory distress. On detailed evaluation using bronchoscopy and MRI imaging, a bronchial cyst was found to be the cause. The following are features of the lesion except that __.",
    "choices": [
      {
        "id": 1,
        "text": "It is mostly mediastinal."
      },
      {
        "id": 2,
        "text": "It is usually confined to 1 lobe."
      },
      {
        "id": 3,
        "text": "It is rarely uniloculated."
      },
      {
        "id": 4,
        "text": "It is never associated with malignancy."
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Bronchial cysts are associated with malignancy <strong>(pleuropulmonary blastoma)</strong>.</p>\n<p>Bronchial cysts are congenital malformations of the\u00a0bronchial tree. It mainly presents as a\u00a0<strong>mediastinal</strong> <strong>mass</strong> that may enlarge and cause local compression.</p>\n<p>It is usually confined to a single lobe and is mostly multiloculated.</p>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a child with yellow nail syndrome, you would expect to find all the following clinical features except _______.",
    "choices": [
      {
        "id": 1,
        "text": "Pleural effusion"
      },
      {
        "id": 2,
        "text": "Lymphedema"
      },
      {
        "id": 3,
        "text": "Clubbing"
      },
      {
        "id": 4,
        "text": "Discolored nails"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Yellow nail syndrome is <strong>not</strong> associated with <strong>clubbing</strong>.</p>\n<p>Yellow nail syndrome is characterized by <strong>respiratory manifestation</strong> (pleural effusion, bronchiectasis), <strong>lymphedema, </strong>and<strong> discoloured nails</strong>. &nbsp;</p>\n<p>Yellow nail syndrome&nbsp;almost always occurs after 50&nbsp;years of age, but a juvenile or familial form has also been observed.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most likely cause of a mediastinal mass in a 2-year-old child?",
    "choices": [
      {
        "id": 1,
        "text": "Neurogenic tumors"
      },
      {
        "id": 2,
        "text": "Thymoma"
      },
      {
        "id": 3,
        "text": "Germ cell tumors"
      },
      {
        "id": 4,
        "text": "Lymphoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common mediastinal masses in young children are neurogenic tumours (50%-60%). In most cases (&lt; 4 years of age), they are invariably malignant (neuroblastomas).</p>\n<p><strong>Anterior mediastinal masses:</strong></p>\n<ul>\n<li><strong>Thymoma</strong> - most common</li>\n<li>Malignant lymphoma (Hodgkin's\u00a0and\u00a0non-Hodgkin's)</li>\n<li>Teratoma\u00a0</li>\n<li>Thyroid\u00a0(retro- or sub-sternal extension)</li>\n<li>Thymic cyst</li>\n<li>Angioma</li>\n</ul>\n<p><strong>Middle mediastinal masses:\u00a0</strong> \u00a0 \u00a0</p>\n<ul>\n<li><strong>Foregut duplication cyst</strong>\u00a0(bronchogenic,\u00a0enteric, and neurenteric) - most common</li>\n<li>Lymphadenopathy</li>\n<li>Vascular malformations</li>\n</ul>\n<p><strong>Posterior mediastinal masses:</strong>\u00a0\u00a0</p>\n<ul>\n<li><strong>Neurogenic tumour</strong> - most common overall\u00a0\u00a0</li>\n<li>Foregut duplication cyst\u00a0 \u00a0 \u00a0\u00a0</li>\n<li>Vascular malformations\u00a0</li>\n<li>Extramedullary hematopoiesis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '23 Childhood Respiratory Disorders';
        const quizFilename = '23-childhood-respiratory-disorders-bd4852fc.html';
        let hierarchy = ["Marrow", "qBank", "Pediatrics"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>