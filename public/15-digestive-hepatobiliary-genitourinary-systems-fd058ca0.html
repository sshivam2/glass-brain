<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15 Digestive, Hepatobiliary & Genitourinary Systems - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Anatomy
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "The hard palate contains ________",
    "choices": [
      {
        "id": 1,
        "text": "Keratinised epithelium, submucosa, minor salivary glands"
      },
      {
        "id": 2,
        "text": "Keratinised epithelium, absent submucosa, no salivary glands"
      },
      {
        "id": 3,
        "text": "Non-keratinised epithelium, submucosa, minor salivary glands"
      },
      {
        "id": 4,
        "text": "Non-keratinised epithelium , absent submucosa, minor salivary glands"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p class=\"p1\">The hard palate contains <strong>keratinised stratified squamous epithelium,</strong> has a submucosa, and contains minor salivary gland. This keratinised stratified squamous epithelium has regional variations and may be <strong>orthokeratinised or parakeratinised</strong>(found in hard palate and gingiva).</p>\n<p class=\"p1\">The <strong>bony structure</strong> of the hard palate is covered by a <strong>firmly attached mucosa</strong> in the central part. In the lateral parts, the hard palate also has a submucosal layer containing blood vessels. There are minor mucous type salivary glands in the submucosa in the posterior part of the hard palate.&nbsp;&nbsp;</p>\n<p class=\"p1\">(Note: In the orthokeratinized epithelium the cell nuclei disappear in the keratinized layer, whereas in the parakeratinized epithelium flattened, highly condensed nuclei remain in the cell cytoplasm of the keratinized layer until exfoliation)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The muscularis externa layer of the gut wall has ___________",
    "choices": [
      {
        "id": 1,
        "text": "Inner longitudinal and outer circular muscle fibres"
      },
      {
        "id": 2,
        "text": "Inner circular and outer longitudinal muscle fibres"
      },
      {
        "id": 3,
        "text": "only circular muscle fibres"
      },
      {
        "id": 4,
        "text": "only longitudinal muscle fibres"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>muscularis externa</strong> has an inner <strong>circular</strong> muscle fibers and outer <strong>longitudinal</strong> muscle fibers.&nbsp;</p>\n<p>The gut wall receives its strength mainly from the muscularis externa, which is the thick layer of muscle that surrounds the submucosa.<strong>&nbsp;</strong>It is responsible for gut movements such as peristalsis.&nbsp;</p>\n<p><strong>Note:</strong></p>\n<ul>\n<li>Muscularis externa contains smooth muscle, <strong>except </strong>in <strong>upper part</strong> of<strong> esophagus</strong> where it has only <strong>striated muscle</strong> fibres.&nbsp;</li>\n<li>The <strong>stomach</strong> has <strong>3 layers</strong> in the muscularis externa, with an extra oblique layer.&nbsp;</li>\n<li>In the <strong>colon</strong>, the outer&nbsp;<strong>longitudinal fibers</strong> join to form prominent bundles called the <strong>taenia coli.</strong></li>\n</ul>\n<p>Given below is a histological section of the duodenum showing the inner and outer layers of muscularis externa.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/502da17e30604431990f7dec1dad6b86x1280x1386.JPEG"
    ]
  },
  {
    "text": "A patient with suspected oesophagal carcinoma is planned for an endoscopic biopsy. A section of the lesion was taken and sent for histopathological examination. Which of the following layers of the gastrointestinal tract is not expected to be seen on microscopic examination of the section?",
    "choices": [
      {
        "id": 1,
        "text": "Mucosa"
      },
      {
        "id": 2,
        "text": "Muscularis propria"
      },
      {
        "id": 3,
        "text": "Submucosa"
      },
      {
        "id": 4,
        "text": "Serosa"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In general, the <strong>gut tube</strong> is made of the following <strong>layers</strong> (inner to outer side):</p>\n<ul>\n<li><strong>Mucosa </strong>-&nbsp;The inner-most layer is the <strong>mucous membrane</strong> with the following sub-layers:\n<ul>\n<li>Lining epithelium&nbsp;</li>\n<li>Lamina propria - A layer of connective tissue supporting the lining epithelium</li>\n<li>Muscularis mucosae - A thin layer of smooth muscle</li>\n</ul>\n</li>\n<li><strong>Submucosa </strong>-&nbsp;Made of loose areolar tissue on which the mucous membrane rests</li>\n<li><strong>Muscularis externa </strong>-&nbsp;Thick layer of muscle around the submucosa (with inner circular and outer longitudinal fibres)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/30033465e9574360aa8061793762c844x1280x1386.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/da402a001f734082b8095ac948063836x1280x924.JPEG"
    ]
  },
  {
    "text": "Which of the following statements regarding the esophagus is false?",
    "choices": [
      {
        "id": 1,
        "text": "It is lined by stratified squamous epithelium"
      },
      {
        "id": 2,
        "text": "The upper third contains only skeletal muscle"
      },
      {
        "id": 3,
        "text": "The middle third contains both skeletal and smooth muscles"
      },
      {
        "id": 4,
        "text": "The lower third contains only skeletal muscle"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>lower third of the oesophagus</strong> consists of only the <strong>smooth muscles.</strong></p>\n<div class=\"page\" title=\"Page 165\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The oesophagus consists of the following layers:</p>\n<ul>\n<li><strong>Mucosa </strong>-<strong>&nbsp;</strong>consists of a <strong>non-keratinized stratified squamous epithelium</strong>, lamina propria, and muscularis mucosae</li>\n<li><strong>Submucosa </strong>-&nbsp;A special feature of the submucosa is the presence of compound tubuloalveolar mucous glands</li>\n<li><strong>Muscularis externa </strong>-&nbsp;with the usual circular and longitudinal layers\n<ul>\n<li>Upper 1/3rd - Only&nbsp;<strong>skeletal muscle </strong>fibres are present</li>\n<li>Middle 1/3rd -&nbsp;<strong>Both skeletal and smooth muscle</strong> fibres are present</li>\n<li>Lower 1/3rd - Only <strong>smooth muscle </strong>fibres&nbsp;are present</li>\n</ul>\n</li>\n<li><strong>Adventitia </strong>-&nbsp;Most of the oesophagus has a dense fibrous tissue covering called the adventitia. Only a short length of the oesophagus in the lower part has a peritoneal covering (serosa).</li>\n</ul>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Within which part of the gastric gland are the chief cells located?",
    "choices": [
      {
        "id": 1,
        "text": "Gastric pit"
      },
      {
        "id": 2,
        "text": "Isthmus"
      },
      {
        "id": 3,
        "text": "Neck"
      },
      {
        "id": 4,
        "text": "Base"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Chief cells are located mostly in the <strong>basal part</strong> of the gastric glands.&nbsp;</p>\n<p>Gastric glands are simple or&nbsp;branched tubular glands that lies perpendicular to the gastric mucosa.&nbsp;They can be identified to have 3 main sections:</p>\n<ol>\n<li>Basal part (deep part)</li>\n<li>Neck</li>\n<li>Isthmus (connects to gastric pit) - Gastric glands&nbsp;open into the gastric pits.&nbsp;</li>\n</ol>\n<p><strong>Types of cells in the gastric glands&nbsp;</strong></p>\n<p><strong>Chief cells&nbsp;</strong>(also called <strong>peptic</strong> or <strong>zymogen cells</strong>)</p>\n<ul>\n<li>Mostly found in the&nbsp;<strong>basal </strong>or<strong> deep</strong>&nbsp;portion of the gastric glands</li>\n<li>Cells are <strong>cuboidal </strong>or low columnar shaped</li>\n<li>The cytoplasm is <strong>basophilic&nbsp;</strong>and contains prominent secretory granules</li>\n<li>Secrete&nbsp;<strong>pepsinogen</strong>&nbsp;(precursor of pepsin) and <strong>lipase</strong></li>\n</ul>\n<p><strong>Oxyntic cells&nbsp;</strong>(or<strong> parietal cells</strong>)</p>\n<ul>\n<li>Found in the <strong>upper part&nbsp;</strong>of the gland&nbsp;</li>\n<li>Cells are<strong> large, ovoid</strong> or polyhedral</li>\n<li>Stain strongly with <strong>eosin</strong></li>\n<li>Produce <strong>hydrochloric acid</strong> (HCl) and <strong>intrinsic factor</strong></li>\n</ul>\n<p><strong>Mucous neck cells:</strong></p>\n<ul>\n<li>Prominently found at the <strong>neck part</strong> of the gastric glands</li>\n<li>They&nbsp;<strong>secrete mucus </strong></li>\n</ul>\n<p><strong>Neuroendocrine cells:</strong></p>\n<ul>\n<li>Situated mostly in the <strong>basal or deeper parts</strong> of the glands, along with the chief cells. T</li>\n<li>Cells are <strong>pleomorphic-shaped</strong>&nbsp;and display irregular nuclei surrounded by granular cytoplasm</li>\n<li>Synthesize many important biogenic amines and polypeptides such as:\n<ul>\n<li><strong>G cells</strong> - Gastrin</li>\n<li><strong>D cells</strong> - Somatostatin</li>\n<li><strong>Enterochromaffin cells</strong> - Serotonin</li>\n<li><strong>ECL cells</strong> (enterochromaffin-like cells) - Histamine</li>\n<li><strong>P/D1 cells</strong> - Ghrelin</li>\n</ul>\n</li>\n</ul>\n<p class=\"p1\"><strong>Stem cells:</strong></p>\n<ul>\n<li class=\"p1\">Undifferentiated cells that multiply and replace other cells</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c83b25cff5ba46b7a9fb2c25e2891ea3x1280x3194.JPEG"
    ]
  },
  {
    "text": "Which of the following statements regarding the gastric glands is false?",
    "choices": [
      {
        "id": 1,
        "text": "Pyloric antrum has many acid secreting cells"
      },
      {
        "id": 2,
        "text": "Oxyntic cells secrete  hydrochloric acid"
      },
      {
        "id": 3,
        "text": "Cardiac region has many mucus secreting cells"
      },
      {
        "id": 4,
        "text": "Parietal cells secrete intrinsic factor"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>pylorus</strong> consists of mainly <strong>mucus-secreting</strong>&nbsp;<strong>glands. </strong></p>\n<p class=\"p1\">The gastric glands can be divided into 3&nbsp;groups which are namely:</p>\n<ol>\n<li><strong>Principal gastric glands -</strong>&nbsp;They are found in the <strong>body</strong> and <strong>fundus</strong>. About 3-7 principal glands open into the gastric pit. These glands contain at least <strong>5 different types of cells:&nbsp;</strong>&nbsp;\n<ul>\n<li>Chief cells</li>\n<li>Parietal cells</li>\n<li>Mucous neck cells</li>\n<li>Neuroendocrine cells</li>\n<li>Stem cells.&nbsp;</li>\n</ul>\n</li>\n<li><strong>Cardiac gastric glands -</strong>&nbsp;They are found in the small area near the <strong>cardiac orifice</strong>. Some are simple tubular glands, others are compound branched tubular. They contain <strong>mucus-secreting cells predominantly</strong>. Parietal and chief cells are sparsely present.</li>\n<li><strong>Pyloric gastric glands -</strong>&nbsp;Found in the&nbsp;<strong>pyloric antrum</strong>. About 2-3&nbsp;convoluted tubes open into deep gastric pits. They <strong>mainly have mucus-secreting cells.</strong> They also have <strong>neuroendocrine cells</strong>, especially gastrin-secreting G cells. Parietal and chief cells are scarce.</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The Brunner's glands are seen in _____",
    "choices": [
      {
        "id": 1,
        "text": "Jejunum"
      },
      {
        "id": 2,
        "text": "Upper duodenum"
      },
      {
        "id": 3,
        "text": "Lower duodenum"
      },
      {
        "id": 4,
        "text": "Appendix"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Brunner's glands</strong> (or duodenal glands) are <strong>compound</strong> <strong>tubular submucosal glands</strong>&nbsp;present in the&nbsp;<strong>upper duodenum</strong>&nbsp;(above the sphincter of Oddi).</p>\n<p>The alveoli of <strong>duodenal glands</strong> are lined mostly by&nbsp;<strong>mucous secreting columnar cells</strong>. Their ducts pass through the muscularis mucosae and empty into the <strong>intestinal crypts</strong> (<strong>of</strong> <strong>Lieberkuhn</strong>).&nbsp;</p>\n<p>The duodenum&nbsp;can be easily differentiated from the jejunum or ileum by the presence of these submucosal glands. The jejunum and ileum do not have glands in their submucosa.&nbsp;</p>\n<p>Given below is the histological section of normal duodenum showing the Brunner's glands at the submucosal layer.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c1b6fb58cac44127937f8c4207b1803dx1280x2063.JPEG"
    ]
  },
  {
    "text": "An intern accidentally sent an incompletely labelled sample of the resected bowel wall from a patient with intestinal obstruction for histopathological examination. Given below is the microscopic image of the section of the sample. Which part of the gastrointestinal tract is being visualised here?",
    "choices": [
      {
        "id": 1,
        "text": "Esophagus"
      },
      {
        "id": 2,
        "text": "Stomach"
      },
      {
        "id": 3,
        "text": "Ileum"
      },
      {
        "id": 4,
        "text": "Duodenum"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image is a <strong>section through the ileum </strong>as evident by the <strong>thin</strong> and <strong>slender</strong> villi and&nbsp;an aggregated lymphatic follicle (<strong>Peyer&rsquo;s patch</strong>) in the <strong>submucosa</strong>.</p>\n<p>These aggregations of lymphatic follicles are known as <strong>Mucosa Associated Lymphoid Tissue</strong> (MALT), and<strong>&nbsp;</strong>also as&nbsp;<strong>gut-associated lymphoid tissue (GALT).&nbsp;</strong>Peyer's patches in submucosa are found in large size and numerously in the terminal <strong>ileum</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/18dd90e791d74d17abcc2147c3056d24.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false about Paneth cells?",
    "choices": [
      {
        "id": 1,
        "text": "They are rich in rough endoplasmic reticulum"
      },
      {
        "id": 2,
        "text": "Rich in zinc"
      },
      {
        "id": 3,
        "text": "Contain lysozyme"
      },
      {
        "id": 4,
        "text": "Foamy appearance"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>foamy appearance</strong> or frothy cytoplasm is <strong>not</strong> a feature of <strong>Paneth</strong> cells, but of Goblet cells. Mucus-secreting <strong>Goblet cells</strong> contain lipid or&nbsp;mucinous material<strong>&nbsp;</strong>with a <strong>foamy appearance.</strong></p>\n<p><strong>Paneth cells (Enzyme cells)&nbsp;</strong>are present&nbsp;only in the deeper portions of the intestinal crypts. They contain many eosinophilic secretory granules. On microscopic examination, the Paneth cells are seen to contain a significant amount of&nbsp;<strong>rough endoplasmic reticulum.&nbsp;</strong>They are also&nbsp;<strong>rich in zinc</strong>.&nbsp;The function of Paneth cells is to produce <strong>lysozyme</strong> that kills bacteria. They may also produce other enzymes.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/719a0409e5824a72a9b5270951e8222ex1280x2086.JPEG"
    ]
  },
  {
    "text": "A 42-year-old man presented to the clinic with a history of anemia, non-bloody diarrhoea and poor appetite. A diagnosis of celiac disease is suspected and a duodenal biopsy is taken for histopathological examination. Which of the following cells are not likely to be seen on microscopic examination of the section?",
    "choices": [
      {
        "id": 1,
        "text": "Stem cells"
      },
      {
        "id": 2,
        "text": "Goblet cells"
      },
      {
        "id": 3,
        "text": "Paneth cells"
      },
      {
        "id": 4,
        "text": "Neck cells"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Neck cells</strong>&nbsp;are not likely to be seen on microscopy as they are <strong>not present</strong> in the <strong>small intestine.</strong> The neck cells are the <strong>mucous secreting cells</strong> that are present in the upper end (or &lsquo;neck&rsquo;) of the main gastric glands of the <strong>stomach</strong>.</p>\n<p>Option A: <strong>Stem cells&nbsp;</strong>are the <strong>undifferentiated</strong> <strong>cells</strong> present in the wall of the intestinal crypts.&nbsp;</p>\n<p>Option B: <strong>Goblet cells</strong> are <strong>mucous secreting cells</strong>. Each goblet cell has an expanded upper part that is distended with mucin granules. The nucleus is flattened and is situated near the base of the cell.</p>\n<p>Option C: Paneth Cells (zymogen cells) are found only in the deeper parts of intestinal crypts. They contain prominent eosinophilic secretory granules.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following structures are centroacinar cells mainly present?",
    "choices": [
      {
        "id": 1,
        "text": "Pancreas"
      },
      {
        "id": 2,
        "text": "Parotid gland"
      },
      {
        "id": 3,
        "text": "Prostate"
      },
      {
        "id": 4,
        "text": "Liver"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Centroacinar cells are mainly present in the pancreas.&nbsp;</p>\n<p><strong>Centroacinar cells</strong> are present in the alveoli of the <strong>exocrine pancreas. </strong>They are&nbsp;called so because they are visible near the <strong>centre of the acinus (or alveolus</strong>). These cells actually are actually part of the intercalated ducts that are invaginated into the secretory elements of the pancreas.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c0beb59b49724010af472979a5bc3dd2x1280x1100.JPEG"
    ]
  },
  {
    "text": "Which of the following structures does not form the portal triad of the liver?",
    "choices": [
      {
        "id": 1,
        "text": "Hepatic artery"
      },
      {
        "id": 2,
        "text": "Hepatic vein"
      },
      {
        "id": 3,
        "text": "Bile duct"
      },
      {
        "id": 4,
        "text": "Portal vein"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hepatic vein</strong> does not form part of the portal triad.</p>\n<p>Portal canals are present at the angular intervals at the periphery of each hepatic lobule. They are filled with&nbsp;<strong>connective tissue </strong>and&nbsp;form a connective tissue network across the entire liver substance.</p>\n<p>Each &lsquo;canal&rsquo; consists of</p>\n<ul>\n<li>A branch of the <strong>portal vein</strong></li>\n<li>A branch of the <strong>hepatic artery</strong></li>\n<li>An <strong>interlobular bile duct</strong>.</li>\n</ul>\n<p>These <strong>three</strong> structures collectively form a <strong>portal triad</strong>.</p>\n<p>The image given below shows a cross-section of the normal hepatic tissue showing the portal triad.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/47ceb71a40d5401aac366c1f6653b52ax1280x2148.JPEG"
    ]
  },
  {
    "text": "The space of Disse consists of all of the following except ______",
    "choices": [
      {
        "id": 1,
        "text": "Microvilli"
      },
      {
        "id": 2,
        "text": "Blood plasma"
      },
      {
        "id": 3,
        "text": "Kupffer's cells"
      },
      {
        "id": 4,
        "text": "Fat cells"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The space of Disse consists of all of the following mentioned above except Kupffer cells. They<strong>&nbsp;</strong>are present in the lining of the&nbsp;<strong>walls of the sinusoids</strong>, not in the Space of Disse (perisinusoidal space).&nbsp;</p>\n<p><strong>Kupffer cells&nbsp;</strong>are also known as stellate macrophages or Kupffer-Borowicz cells. They are specialized macrophages present in the liver and are part of the mononuclear phagocyte system.</p>\n<p><strong>Space of Disse </strong>or&nbsp;the <strong>perisinusoidal space</strong>&nbsp;is present in the liver <strong>between</strong> the <strong>hepatocyte</strong> and a <strong>sinusoid</strong>. This space&nbsp;contains the <strong>blood plasma.&nbsp;</strong>The <strong>microvilli</strong> of hepatocytes extend into this space. This allows absorption of proteins and other plasma components from the sinusoids by the hepatocytes. This space may also have some <strong>fat cells</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/30d56388bdfc47c3857415654d48802ax1280x803.JPEG"
    ]
  },
  {
    "text": "Sinusoids are present in",
    "choices": [
      {
        "id": 1,
        "text": "1, 2, 3, 4, & 5"
      },
      {
        "id": 2,
        "text": "1, 3, 4, & 5"
      },
      {
        "id": 3,
        "text": "1, 2, 4, & 5"
      },
      {
        "id": 4,
        "text": "2, 3, 4, & 5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The sinusoids are present in all the above-mentioned structures except kidneys.</p>\n<p>They are present in:</p>\n<ul>\n<li>Liver</li>\n<li>Spleen</li>\n<li>Lymph nodes</li>\n<li>Endocrine glands (adrenal medulla, parathyroid)</li>\n<li>Bone marrow</li>\n<li>Carotid body</li>\n</ul>\n<p>The given image is a graphical representation of sinusoids (sinus-like) which are small blood channels formed by subdivision of the lumen of large blood vessels (sinuses) by the invasion of developing parenchymal cell-cords.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c1184f0474754caf9f59cbdbb7c06393x1280x1063.JPEG"
    ]
  },
  {
    "text": "The transitional epithelium lines all of the following except _____",
    "choices": [
      {
        "id": 1,
        "text": "Ureters"
      },
      {
        "id": 2,
        "text": "Minor calyx"
      },
      {
        "id": 3,
        "text": "Urinary bladder"
      },
      {
        "id": 4,
        "text": "Membranous urethra"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Transitional</strong> <strong>epithelium</strong> lines all the above structures <strong>except</strong> the <strong>membranous</strong> urethra.<br />Transitional epithelium is found in the <strong>renal</strong> <strong>pelvis</strong> and <strong>calyces</strong>, the <strong>ureter</strong>, the <strong>urinary</strong> <strong>bladder</strong>, and <strong>pre-prostatic </strong>&amp;<strong> prostatic parts</strong> of the<strong> urethra</strong>. Because of this distribution, it is also called the&nbsp;<strong>urothelium</strong>.</p>\n<p>Both in the male and female, the <strong>greater part of the urethra</strong> is lined by <strong>pseudostratified columnar epithelium</strong>. A short part adjoining the urinary bladder is lined by <strong>transitional epithelium</strong>, while the part near the external orifice is lined by <strong>stratified squamous epithelium</strong>.</p>\n<p>The following are various parts of the urethra in males and their lining epithelium:</p>\n<ul>\n<li><strong>Pre-prostatic &amp; prostatic urethra -</strong>&nbsp;Transitional epithelium</li>\n<li><strong>Membranous urethra -</strong>&nbsp;Pseudostratified/stratified columnar</li>\n<li><strong>Penile/spongy urethra -</strong>&nbsp;Proximally by pseudostratified columnar, <strong>distally </strong>by stratified squamous</li>\n</ul>\n<p>Given below is the histological section of the urinary bladder showing the transitional epithelium.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d08d82d545bf4815b7899a9df650acf2x1280x2380.JPEG"
    ]
  },
  {
    "text": "Which of the following accurately describes the lining epithelium of the vagina?",
    "choices": [
      {
        "id": 1,
        "text": "Pseudostratified keratinized columnar epithelium"
      },
      {
        "id": 2,
        "text": "Keratinized stratified squamous epithelium"
      },
      {
        "id": 3,
        "text": "Non-keratinized stratified squamous epithelium"
      },
      {
        "id": 4,
        "text": "Pseudostratified non-keratinized columnar epithelium"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The lining epithelium of the vagina is made up of <strong>non-keratinised stratified squamous</strong> epithelium.&nbsp;</p>\n<p>Other sites lined by the non-keratinised squamous epithelium are:</p>\n<ul>\n<li>Mouth</li>\n<li>Tongue</li>\n<li>Pharynx</li>\n<li>Oesophagus</li>\n<li>Cornea</li>\n</ul>\n<p><strong>Keratinised stratified squamous epithelium</strong> covers the skin of the whole body and forms the epidermis.</p>\n<p>The given image shows a histological section of the vaginal epithelium showing the non-keratinised stratified squamous epithelium.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5b60d109739447b0ac490859d976dd7cx1280x1386.JPEG"
    ]
  },
  {
    "text": "In which of the following structures is the type of epithelium as shown in the image seen?",
    "choices": [
      {
        "id": 1,
        "text": "Bile duct"
      },
      {
        "id": 2,
        "text": "Common bile duct"
      },
      {
        "id": 3,
        "text": "Skin"
      },
      {
        "id": 4,
        "text": "Urinary bladder"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above image shows <strong>transitional epithelium</strong> and is seen<strong>&nbsp;</strong>in the <strong>urinary bladder.</strong></p>\n<p>The <strong>deepest layer </strong>has&nbsp;<strong>columnar cells</strong>, the <strong>middle layers</strong> are made up of <strong>polyhedral cells</strong> and the <strong>surface layer</strong>&nbsp;has cells that are <strong>large</strong> and shaped like an <strong>umbrella.</strong></p>\n<p><strong>Transitional epithelium</strong> is found in the <strong>renal pelvis</strong> and <strong>calyces</strong>, the <strong>ureter</strong>, the <strong>urinary bladder</strong>, and part of the <strong>urethra</strong>. Because of this distribution, it is also called the&nbsp;<strong>urothelium</strong>. In the <strong>urinary bladder</strong>, it is usually observed that <strong>transitional epithelium</strong> can be <strong>stretched considerably</strong> without being damaged. When stretched it appears to be thinner and the <strong>cells become flattened or rounded</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8c7324cc234c49449f3b43a50288fce5.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the structure shown in the histological image below.",
    "choices": [
      {
        "id": 1,
        "text": "Female urethra"
      },
      {
        "id": 2,
        "text": "Male urethra"
      },
      {
        "id": 3,
        "text": "Ureter"
      },
      {
        "id": 4,
        "text": "Vas deferens"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image shows <strong>histological section of ureter.</strong></p>\n<p>The image shows a thick, <strong>fibroelastic</strong>, <strong>lamina propria</strong> lying underneath the stratified, <strong>transitional epithelium</strong>. There are <strong>no mucosal</strong> or <strong>submucosal glands&nbsp;</strong>and <strong>no submucosa</strong>. There is a <strong>layer of smooth muscle</strong> outside the mucosa. The<strong> outer</strong>&nbsp;<strong>adventitial layer</strong> has fibroelastic connective tissue, with blood vessels, lymphatics and nerves.</p>\n<p>Given below is a cross-section of the ureter showing the transitional epithelium and the layer of smooth muscle.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/318ddb7fc32f46b1977fea8469f71bd4.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/463fbe5f84df42a3a0bee360d7bd32ccx1280x1374.JPEG"
    ]
  },
  {
    "text": "Which of the following are the epithelial supporting cells of the seminiferous tubules?",
    "choices": [
      {
        "id": 1,
        "text": "Germ cells"
      },
      {
        "id": 2,
        "text": "Leydig cells"
      },
      {
        "id": 3,
        "text": "Sertoli cells"
      },
      {
        "id": 4,
        "text": "Peritubular cells"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sertoli cells</strong> also called <strong>sustentacular cells</strong> are the epithelial supporting cells of the <strong>seminiferous tubules</strong>.</p>\n<p>Sertoli cells are derived from the <strong>epithelial sex cords</strong> of the developing gonads. They are <strong>tall simple columnar cells</strong>.&nbsp; They surround the proliferating and differentiating germ cells forming pockets around these cells. Sertoli cells provide nutrients and phagocytose excess cytoplasm from the newly forming spermatozoa.</p>\n<p>The given image is a section of seminiferous ducts showing the different types of cells.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b824dfe0ca87428099998a0a2837fd74x1280x2345.JPEG"
    ]
  },
  {
    "text": "Identify the structure shown in the histological image below.",
    "choices": [
      {
        "id": 1,
        "text": "Ureter"
      },
      {
        "id": 2,
        "text": "Epididymis"
      },
      {
        "id": 3,
        "text": "Seminal vesicle"
      },
      {
        "id": 4,
        "text": "Vas deferens"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Among the given options the histological section is most likely to be of the <strong>vas deferens</strong> or the ductus deferens.</p>\n<p>The epithelium of this tube displays a <strong>pseudostratified columnar epithelium</strong>. It&nbsp;is surrounded by a prominent <strong>muscular layer</strong>. This layer contains <strong>inner</strong> and<strong> outer longitudinal muscle</strong> and a&nbsp;<strong>middle circular</strong> layer.<strong>&nbsp;</strong>An <strong>adventitia</strong> of connective tissue surrounds the muscularis layer.&nbsp;The <strong>ductus deferens</strong> extends from the <strong>epididymis</strong> to the<strong> ejaculatory ducts</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/886d6a2d5c804e78b9450730d38602b6.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/aa3fcab2bc1d43809814e37168b01c5bx1280x1345.JPEG"
    ]
  },
  {
    "text": "Identify the structure shown in the image below.",
    "choices": [
      {
        "id": 1,
        "text": "Seminiferous tubule"
      },
      {
        "id": 2,
        "text": "Prostate"
      },
      {
        "id": 3,
        "text": "Endometrium"
      },
      {
        "id": 4,
        "text": "Mammary gland"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Among the given options, the histological image is likely to be of the <strong>endometrium.</strong>&nbsp;It shows the presence of<strong> glycogen</strong> masses in the<strong> basal cytoplasm</strong> of the epithelial cells lining the glands which are the features of the&nbsp;early<strong> secretory phase</strong> of the<strong> endometrium</strong>.</p>\n<p>The <strong>uterus</strong> is made up of an external layer of smooth muscle called the <strong>myometrium</strong>, and an internal layer called the <strong>endometrium</strong>. The endometrium has three layers which are namely:</p>\n<ol>\n<li><strong>Stratum compactum</strong>,</li>\n<li><strong>Stratum spongiosum</strong> (which make up the stratum functionalis)</li>\n<li><strong>Stratum basalis</strong>.</li>\n</ol>\n<p>The changes observed in the endometrium during the menstrual cycle are continuous and may be summarized as follows:</p>\n<ul>\n<li><strong> Increase in thickness of endometrium -</strong>&nbsp;The endometrium progressively increases in thickness. In the postmenstrual phase, it is 0.5&ndash;1 mm thick; in the proliferative phase it is 2&ndash;3 mm thick, and in the secretory phase, its thickness reaches 5&ndash;7 mm.</li>\n<li><strong>Increase in dimensions of uterine glands -</strong>&nbsp;The uterine glands grow in length. At first, they are straight but gradually become convoluted. Because of these convolutions, the glands acquire a '<strong>saw-toothed'</strong>&nbsp;appearance when seen in the longitudinal section. The glands also increase in diameter.</li>\n<li><strong>Change in the epithelial lining of glands -</strong>&nbsp;The epithelium lining the glands is at first cuboidal. During the proliferative stage, it becomes <strong>columnar.</strong> Glycogen accumulates in the basal portion of the epithelial cell, pushing the nucleus nearer the lumen. During the secretory phase, the apical part of the cell is shed off as part of the secretion and&nbsp;the cell again becomes cubical.</li>\n</ul>\n<div class=\"page\" title=\"Page 57\">&nbsp;Given below is a histological section of the endometrium in the proliferative phase.</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d49a6e227f5740a0a9e82d327a73b47c.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2c6048c81cb6449a800c870868682e85x1280x2133.JPEG"
    ]
  },
  {
    "text": "The structures marked in the image below are found in the epithelial lining  of all of the following sites, except:",
    "choices": [
      {
        "id": 1,
        "text": "Oviduct"
      },
      {
        "id": 2,
        "text": "Epididymis"
      },
      {
        "id": 3,
        "text": "Bronchi"
      },
      {
        "id": 4,
        "text": "Ependyma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Cilia are minute hair-like projections, while stereocilia are very long, thick microvilli measuring about 5&ndash;10 &mu;m in length.</p>\n<p><strong>Ciliated epithelium:</strong></p>\n<ul>\n<li>The epithelium bears cilia, which moves in a coordinated fashion, and help in the movement of the mucus, or propel the movement of any other structures such as ova or spermatozoa.</li>\n<li>The ciliated columnar epithelium is found in&nbsp;most of the <strong>respiratory tract,</strong> the uterus, and the <strong>uterine tube</strong>&nbsp;<strong>(oviduct),</strong> efferent ductules of the testis, parts of the middle ear and auditory tube; the <strong>ependyma</strong> lining the central canal of the spinal cord and the ventricles of the brain.</li>\n<li>The pseudostratified ciliated columnar epithelium is seen in the trachea and in <strong>large bronchi.</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9318e76d9e294ac7a22199533ec23ba2.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/019f8a1459f24ce39694e87510f6add7x1280x1345.JPEG"
    ]
  }
];
        let quizName = '15 Digestive, Hepatobiliary & Genitourinary Systems';
        const quizFilename = '15-digestive-hepatobiliary-genitourinary-systems-fd058ca0.html';
        let hierarchy = ["Marrow", "qBank", "Anatomy"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>