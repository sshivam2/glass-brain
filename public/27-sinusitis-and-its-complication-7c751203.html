<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>27 Sinusitis And Its Complication - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / ENT
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">31</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is the most common cause of sinusitis?",
    "choices": [
      {
        "id": 1,
        "text": "Nasal infections"
      },
      {
        "id": 2,
        "text": "Dental infections"
      },
      {
        "id": 3,
        "text": "Trauma"
      },
      {
        "id": 4,
        "text": "Swimming and diving"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Nasal infections </strong>are the <strong>most common </strong>cause of <strong>sinusitis </strong>since sinus mucosa is a continuation of nasal mucosa and infections from the nose can travel <strong>directly</strong> by continuity or by way of<strong> submucosal lymphatics</strong>. <br />The most common cause of acute sinusitis is <strong>viral rhinitis </strong>followed by <strong>bacterial invasion</strong>.</p>\n<p>Other causes:</p>\n<ul>\n<li><strong>Dental infections</strong> cause <strong>maxillary sinus </strong>infections.</li>\n<li>Trauma</li>\n<li>Swimming and diving.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Identify the most common sinus involved in sinusitis in adults.",
    "choices": [
      {
        "id": 1,
        "text": "4"
      },
      {
        "id": 2,
        "text": "3"
      },
      {
        "id": 3,
        "text": "2"
      },
      {
        "id": 4,
        "text": "1"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The structure marked 4 is the <strong>maxillary sinus</strong> and is the <strong>most common</strong> sinus involved in acute sinusitis in adults.&nbsp;</p>\n<p>Order of frequency of sinuses involved in acute sinusitis in adults is <strong>maxillary &gt;&nbsp;</strong><strong>ethmoid &gt; frontal &gt; sphenoid</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/bbaa01a22c6a42a4a1b526571618debd.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/67475f224fc9475ca1cfb62db39fedc1x1280x1016.JPEG"
    ]
  },
  {
    "text": "A patient with sinusitis is least likely to present with which of the following symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Occipital headache"
      },
      {
        "id": 2,
        "text": "Eyelid edema"
      },
      {
        "id": 3,
        "text": "Diplopia"
      },
      {
        "id": 4,
        "text": "Postnasal drip"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Diplopia</strong> is <strong>least likely to be seen</strong> in sinusitis.</p>\n<p>Patients with sinusitis typically present with a dull throbbing headache which worsens on moving the head or bending forward, nasal discharge and blockage, &amp; constitutional symptoms like fever, general malaise and bodyache.</p>\n<p>Option A: <strong>Occipital headache</strong> can be seen in sphenoid sinusitis.</p>\n<p>Option B: <strong>Eyelid edema</strong> can be seen in frontal and ethmoidal sinusitis.</p>\n<p>Option D: <strong>Post-nasal drip</strong> and nasal discharge is a common finding in sinusitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 28-year-old IT professional with a recent history of upper respiratory tract infection has a headache that worsens during office hours. The headache comes upon waking, tends to be at its worst by about midday and improves as the day progresses. This characteristic periodicity is seen in?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary sinusitis"
      },
      {
        "id": 2,
        "text": "Frontal sinusitis"
      },
      {
        "id": 3,
        "text": "Ethmoid sinusitis"
      },
      {
        "id": 4,
        "text": "Sphenoid sinusitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Headache </strong>in<strong> frontal sinusitis</strong> shows <strong>characteristic periodicity</strong>, i.e. comes upon waking, gradually increases, reaches its peak by about<strong> midday</strong>, and then starts subsiding. It is also called <strong>office headache</strong>&nbsp;because of its presence only during office hours.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most common sinusitis in children?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary"
      },
      {
        "id": 2,
        "text": "Frontal"
      },
      {
        "id": 3,
        "text": "Sphenoid"
      },
      {
        "id": 4,
        "text": "Ethmoid"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The<strong>&nbsp;ethmoid sinus</strong> is the most common sinus involved in <strong>pediatric</strong> sinusitis.</p>\n<p>It usually occurs when the infection spreads through the lamina papyracea.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 12-year-old child diagnosed with sphenoid sinusitis was brought to the hospital with complaints of a fever and headache. The headache would most likely be localised to?",
    "choices": [
      {
        "id": 1,
        "text": "Frontal"
      },
      {
        "id": 2,
        "text": "Occiput"
      },
      {
        "id": 3,
        "text": "Temporal region"
      },
      {
        "id": 4,
        "text": "Root of nose."
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Headache in <strong>sphenoid sinusitis</strong> is localized to <strong>occiput </strong>or<strong> vertex</strong>. <br />Frontal headache is seen in maxillary and frontal sinusitis. Headache in frontal sinusitis has characteristic periodicity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man with a history of recurrent episodes of sinusitis for two years presented with complaints of a dull aching pain over his cheek, persistent nasal obstruction which worsens at night and an urge to constantly clear his throat. Which of the following anterior rhinoscopy findings is pathognomonic of the condition?",
    "choices": [
      {
        "id": 1,
        "text": "Muco-pus in middle meatus"
      },
      {
        "id": 2,
        "text": "Inferior turbinate atrophy"
      },
      {
        "id": 3,
        "text": "Inferior turbinate hypertrophy"
      },
      {
        "id": 4,
        "text": "Crusting on the turbinates"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical history is suggestive of <strong>chronic maxillary sinusitis</strong>. Mucoid or<strong> mucopurulent discharge</strong> in the <strong>middle meatus</strong> seen on anterior rhinoscopy is a <strong>pathognomonic</strong> finding in chronic maxillary sinusitis.</p>\n<p>Other signs include mucosal edema primarily in the middle meatus as well as polyps. Clinically, patients present with nasal <strong>blockage</strong>, congestion,&nbsp;<strong>postnasal drip,&nbsp;</strong>reduced olfaction, and <strong>facial pain</strong> or pressure.&nbsp;On CT, mucosal changes within the osteomeatal complex and sinuses may be seen.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 21-year-old female patient presented with fever, headache and, hawking sensation. Suspecting severe sinusitis, you order an X-ray of the PNS. Which view would be best in capturing all the paranasal sinuses in a single film?",
    "choices": [
      {
        "id": 1,
        "text": "Lateral View"
      },
      {
        "id": 2,
        "text": "Caldwell\u2019s view"
      },
      {
        "id": 3,
        "text": "Water's view"
      },
      {
        "id": 4,
        "text": "Submento-vertical view"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>lateral view</strong>\u00a0shows all the paranasal sinuses in a single film.</p>\n<p>The lateral side of the skull lies against the film,\u00a0and an X-ray beam is projected perpendicular to the other\u00a0side.</p>\n<p>Structures seen are:</p>\n<ul>\n<li>Anterior and posterior extent of the sphenoid, frontal sinus</li>\n<li>Maxillary sinuses</li>\n<li>Ethmoid sinuses</li>\n<li>Sella turcica</li>\n<li>Alveolar process</li>\n<li>Condyle and neck of the mandible.</li>\n</ul>\n<p>Note: Though all the abnormalities and diagnoses of Paranasal sinuses cannot be concluded through the lateral view alone, the lateral view radiographically covers all the sinuses in the same view.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/eacc2242151840c49487faf7e0f534acx1280x1186.JPEG"
    ]
  },
  {
    "text": "A patient with deviated nasal septum presents with a headache that starts upon waking and reaches its peak by about midday. On examination, she has upper eyelid oedema and tenderness on pressing just above the medial canthus. Which of the following X-ray views is preferred to best evaluate the sinus involved?",
    "choices": [
      {
        "id": 1,
        "text": "Water\u2019s view"
      },
      {
        "id": 2,
        "text": "Caldwell view"
      },
      {
        "id": 3,
        "text": "Schuller\u2019s view"
      },
      {
        "id": 4,
        "text": "Water's view with mouth open"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario points to a diagnosis of <strong>frontal sinusitis</strong>. The <strong>best&nbsp;view</strong> for evaluating the frontal sinus is <strong>Caldwell's view</strong>.</p>\n<p>It is also known as <strong>occipitofrontal</strong> view or nose-forehead position.</p>\n<p>Structures seen are:&nbsp;</p>\n<ul>\n<li><strong>Frontal sinuses&nbsp;</strong></li>\n<li>Ethmoid sinuses</li>\n<li>Maxillary sinuses</li>\n<li>Frontal process of the zygoma and the zygomatic process of the frontal bone</li>\n<li>Superior margin of orbit and lamina papyracea</li>\n<li>Superior orbital fissure</li>\n<li>Foramen rotundum (inferolateral to superior orbital fissure)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7564279e02374269913e8e939206c09fx1280x1411.JPEG"
    ]
  },
  {
    "text": "Which of the following is used to make a definitive diagnosis of sinusitis?",
    "choices": [
      {
        "id": 1,
        "text": "X Ray PNS"
      },
      {
        "id": 2,
        "text": "Nasal endoscopy"
      },
      {
        "id": 3,
        "text": "Proof puncture"
      },
      {
        "id": 4,
        "text": "Transillumination test"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Diagnostic nasal endoscopy </strong>findings are used to confirm the diagnosis of <strong>sinusitis</strong>.</p>\n<p>Indications of diagnostic nasal endoscopy:</p>\n<ul>\n<li>To diagnose any disease of the nose and PNS</li>\n<li>To find the source of bleeding in epistaxis</li>\n<li>To assess response to medical or surgical treatment of the nose and PNS disease</li>\n<li>To take a precise biopsy from the nose and nasopharynx</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following complications would you not expect to see in a patient diagnosed with sinusitis?",
    "choices": [
      {
        "id": 1,
        "text": "Orbital cellulitis"
      },
      {
        "id": 2,
        "text": "Brain abscess"
      },
      {
        "id": 3,
        "text": "Eye lid edema"
      },
      {
        "id": 4,
        "text": "Soft palate paralysis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Soft palate paralysis is <strong>not</strong> a known complication of sinusitis.</p>\n<p>Complications of paranasal sinus infection:</p>\n<ul>\n<li>Local\n<ul>\n<li>Mucocele/Mucopyocele</li>\n<li>Mucous retention cyst</li>\n<li>Osteomyelitis - Frontal bone (more common), maxilla</li>\n</ul>\n</li>\n<li>Orbital\n<ul>\n<li>Preseptal inflammatory oedema of lids</li>\n<li>Subperiosteal abscess</li>\n<li>Orbital cellulitis</li>\n<li>Orbital abscess</li>\n<li>Superior orbital fissure syndrome</li>\n<li>Orbital apex syndrome</li>\n</ul>\n</li>\n<li>Intracranial\n<ul>\n<li>Meningitis</li>\n<li>Extradural abscess</li>\n<li>Subdural abscess</li>\n<li>Brain abscess</li>\n<li>Cavernous sinus thrombosis</li>\n</ul>\n</li>\n<li>Descending infections</li>\n<li>Focal infections</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most common complication following acute rhinosinusitis?",
    "choices": [
      {
        "id": 1,
        "text": "Orbital cellulitis"
      },
      {
        "id": 2,
        "text": "Meningitis"
      },
      {
        "id": 3,
        "text": "Osteomyelitis"
      },
      {
        "id": 4,
        "text": "Septicaemia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Orbital cellulitis</strong> is the most common complication following acute rhinosinusitis.</p>\n<p>Complications of acute rhinosinusitis&nbsp;are typically classified as <strong>orbital </strong>(60&ndash;75 per cent), <strong>intracranial</strong> (15&ndash;20 per cent) and <strong>osseous</strong> (5&ndash;10 per cent), and local and descending infections.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old lady presents with pain and swelling around the left upper eyelid region, diplopia and a headache. She gives a history of recurrent episodes of rhinosinusitis in the past. On examination, there is a downward, and outward deviation of the eyeball & the most prominent part of the swelling has a punctum with a mucopurulent discharge, just above the upper eyelid. Which of the following sinuses is most commonly involved in this complication?",
    "choices": [
      {
        "id": 1,
        "text": "Frontal sinus"
      },
      {
        "id": 2,
        "text": "Maxillary sinus"
      },
      {
        "id": 3,
        "text": "Ethmoid sinus"
      },
      {
        "id": 4,
        "text": "Sphenoid sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical history and findings are suggestive of a <strong>mucocele</strong> secondary to <strong>frontal sinusitis</strong>. The frontal sinus is<strong> most&nbsp;commonly</strong> involved in mucocele formation.</p>\n<p>The sinuses commonly affected by mucocele in the <strong>order of frequency</strong> are the <strong>frontal&gt;ethmoidal&gt;maxillary&gt;sphenoid</strong></p>\n<p>The image given below shows a coronal MRI demonstrating a frontal mucocele and an orbital cystic mass.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/33d76cc70edc4ca4a7be3078b5723b90x512x510.PNG"
    ]
  },
  {
    "text": "Which of the following statements is false about mucoceles?",
    "choices": [
      {
        "id": 1,
        "text": "Frontal sinus is most commonly involved"
      },
      {
        "id": 2,
        "text": "Presents as a cystic swelling in the superomedial quadrant"
      },
      {
        "id": 3,
        "text": "Eyeball is pushed downwards, forwards and medially"
      },
      {
        "id": 4,
        "text": "Treatment is frontoethmoidectomy"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Eyeballs</strong> are pushed <strong>downwards</strong>,<strong> forwards</strong> and<strong> laterally</strong>.</p>\n<p>Option A: <strong>Frontal sinus</strong> is <strong>most commonly</strong> involved in mucocele.</p>\n<p>Option B: It presents as a <strong>cystic</strong> swelling in the <strong>superomedial quadrant </strong>of orbit.</p>\n<p>Option D: Treatment is <strong>frontoethmoidectomy</strong> with free drainage of the frontal sinus into the middle meatus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young man was referred to the maxillofacial surgeon with complaints of pain and tenderness over the left cheek, inability to move the left eye, and numbness over the left forehead. He gave a history of chronic sinusitis for two years. Superior orbital fissure syndrome was suspected. Which of the following nerves is least likely to be involved in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Oculomotor nerve"
      },
      {
        "id": 2,
        "text": "Ophthalmic division of trigeminal nerve"
      },
      {
        "id": 3,
        "text": "Maxillary division of trigeminal nerve"
      },
      {
        "id": 4,
        "text": "Trochlear nerve"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Orbital apex syndrome </strong>is<strong> superior orbital fissure syndrome</strong> with additional involvement of <strong>optic nerve and maxillary division of trigeminal nerve</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dd5ef4e300cf423aabedf8acbcdde313x1280x2027.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is not true?",
    "choices": [
      {
        "id": 1,
        "text": "Osteomyelitis of maxilla is more common in children"
      },
      {
        "id": 2,
        "text": "Osteomyelitis of frontal bone is more common in adults"
      },
      {
        "id": 3,
        "text": "Ethmoidal sinusitis spreads through lamina papyracea"
      },
      {
        "id": 4,
        "text": "Pott\u2019s puffy tumor is related to osteomyelitis of maxilla"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Pott's puffy tumor&nbsp;</strong>refers to&nbsp;osteomyelitis of the <strong>frontal bone</strong> with the development of a subperiosteal abscess manifesting as a puffy swelling on the forehead or scalp. It usually occurs as a complication of <strong>frontal sinusitis.</strong></p>\n<p>Option A: Osteomyelitis of the maxilla is more often seen in infants and children than adults because of the presence of <strong>spongy bone</strong> in the anterior wall of the maxilla.</p>\n<p>Option B: Osteomyelitis of frontal bone is more often seen in adults as <strong>frontal</strong> sinus is <strong>not developed</strong> in infants and children.</p>\n<p>Option C:&nbsp;Ethmoidal sinusitis spreads through lamina papyracea</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged patient with a history of recurrent upper respiratory tract infections presents with diplopia and protrusion of the left eyeball. Inflammation of which of the following paranasal sinuses would most likely lead to this complication?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary sinus"
      },
      {
        "id": 2,
        "text": "Frontal sinus"
      },
      {
        "id": 3,
        "text": "Ethmoid sinus"
      },
      {
        "id": 4,
        "text": "Sphenoid sinus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical vignette is suggestive of <strong>orbital complications</strong> secondary to sinusitis. The orbit and its contents are closely related to the ethmoid, frontal, and maxillary sinuses, but most of the complications, however, follow infection of <strong>ethmoids </strong>as they are separated from the orbit only by a thin lamina of bone called&nbsp;<strong>lamina papyracea</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A procedure that involves puncturing and irrigating the sinus is planned for a patient with a history of chronic sinusitis. For which of the following paranasal sinuses is this procedure performed?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary sinus"
      },
      {
        "id": 2,
        "text": "Frontal sinus"
      },
      {
        "id": 3,
        "text": "Ethmoid sinus"
      },
      {
        "id": 4,
        "text": "Sphenoid sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Proof puncture </strong>or <strong>antral lavage</strong> involves&nbsp;puncturing the <strong>medial wall of maxillary sinus</strong> in the region of inferior meatus to allow for irrigation and drainage of the sinus.</p>\n<p>It is called proof puncture, as the presence of an infection can be proven during the procedure.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1a97cfbf149141d0a10d8b9b286e6745x1280x1094.JPEG"
    ]
  },
  {
    "text": "In which of the following conditions is antral lavage not indicated?",
    "choices": [
      {
        "id": 1,
        "text": "Treatment of acute maxillary sinusitis"
      },
      {
        "id": 2,
        "text": "Diagnosis of chronic maxillary sinusitis"
      },
      {
        "id": 3,
        "text": "Treatment of chronic maxillary sinusitis"
      },
      {
        "id": 4,
        "text": "Collect specimen from maxillary antrum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In <strong>acute maxillary sinusitis</strong>, antral lavage is actually <strong>contraindicated</strong> for the risk of osteomyelitis.</p>\n<p>Antral lavage is usually done therapeutically to<strong> remove pus </strong>and diagnostically for&nbsp;<strong>confirmation&nbsp;</strong>of chronic maxillary sinusitis. It can also be done to <strong>collect the specimen</strong> of the antral contents for culture and sensitivity, or cytological examination to exclude early malignancy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While performing a therapeutic antral lavage of the maxillary sinus, the patient developed a fatal complication. He stopped breathing, the colour of his face became ashen grey, and the pupils became dilated. Attempts to resuscitate the patient were futile, and he was declared dead after 20 minutes. Which of the following could be the most likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary artery thrombus"
      },
      {
        "id": 2,
        "text": "Air embolism"
      },
      {
        "id": 3,
        "text": "Bleeding"
      },
      {
        "id": 4,
        "text": "Meningitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Air embolism</strong> is a&nbsp;<strong>rare</strong> but<strong> fatal complication</strong> that can occur during antral lavage through the veins that are damaged during the puncture.</p>\n<p>This complication can be prevented by avoiding the insufflation of air into the antrum after lavage.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following sinuses is accessed via the Caldwell-Luc approach?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary sinus"
      },
      {
        "id": 2,
        "text": "Frontal sinus"
      },
      {
        "id": 3,
        "text": "Ethmoid sinus"
      },
      {
        "id": 4,
        "text": "Sphenoid sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Caldwell&ndash;Luc operation</strong> is a surgery where<strong>&nbsp;the maxillary antrum is opened through canine fossa</strong> by sublabial approach and pathology inside the antrum dealt with.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/81d80a8db8d7401ab1160ab12121d602x512x433.PNG"
    ]
  },
  {
    "text": "Which of the following structures is pierced while creating a nasoantral window in Caldwell Luc operation?",
    "choices": [
      {
        "id": 1,
        "text": "Superior meatus"
      },
      {
        "id": 2,
        "text": "Middle meatus"
      },
      {
        "id": 3,
        "text": "Inferior meatus"
      },
      {
        "id": 4,
        "text": "Uncinate process"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Nasoantral window</strong> of &lt;1.5cm in<strong> diameter</strong> is created through the&nbsp;<strong>inferior meatus</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3cb4641ee0b04be38638fbe6dd1eb996x1280x2274.JPEG"
    ]
  },
  {
    "text": "Which of the following is the most common complication of Caldwell Luc operation?",
    "choices": [
      {
        "id": 1,
        "text": "Bleeding"
      },
      {
        "id": 2,
        "text": "Oroantral fistula"
      },
      {
        "id": 3,
        "text": "Infra orbital nerve injury"
      },
      {
        "id": 4,
        "text": "Orbital cellulitis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most common complication of Caldwell Luc operation is <strong>infraorbital nerve injury.</strong></p>\n<p><strong>Paraesthesia</strong> due to damage of the infraorbital nerve may be temporary or permanent and is reported in<strong> 21%</strong>&nbsp;of cases.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/201ebd01846e40a49761e047a2ba7239x1280x2274.JPEG"
    ]
  },
  {
    "text": "What does FESS stand for?",
    "choices": [
      {
        "id": 1,
        "text": "Functional endonasal sinus surgery"
      },
      {
        "id": 2,
        "text": "Functional endoscopic sinus surgery"
      },
      {
        "id": 3,
        "text": "Factual endoscopic sinus surgery"
      },
      {
        "id": 4,
        "text": "Factual endonasal sinus surgery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>FESS stands for <strong>Functional Endoscopic Sinus Surgery</strong>.</p>\n<p>FESS is a&nbsp;minimally invasive procedure&nbsp;that uses nasal endoscopes to <strong>enlarge the nasal drainage pathways</strong> of the<strong> paranasal sinuses</strong> to improve sinus ventilation and allow access to topical medications.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following conditions is not an indication for functional endoscopic sinus surgery?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic sinusitis"
      },
      {
        "id": 2,
        "text": "Epistaxis"
      },
      {
        "id": 3,
        "text": "Nasal polyp"
      },
      {
        "id": 4,
        "text": "Cavernous sinus thrombosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Cavernous sinus thrombosis is <strong>not</strong> an indication for functional endoscopic sinus surgery(<strong>FESS</strong>).</p>\n<p><strong class=\"ng-binding\">Indications of FESS:</strong></p>\n<ul>\n<li>Chronic bacterial sinusitis unresponsive to adequate medical treatment</li>\n<li>Recurrent acute bacterial sinusitis</li>\n<li>Fungal sinusitis with fungal ball</li>\n<li>Nasal polyps</li>\n<li>Mucocele&nbsp;</li>\n<li>Control of epistaxis&nbsp;</li>\n<li>Removal of foreign body from the nose or sinus</li>\n<li>Barotrauma sinusitis (pain in the face during descent in aircraft or descent whilst scuba diving)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following conditions is a contraindication for endoscopic sinus surgery?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic bacterial rhinosinusitis"
      },
      {
        "id": 2,
        "text": "Allergic fungal sinusitis with mycetoma"
      },
      {
        "id": 3,
        "text": "Acute rhinosinusitis with epidural abscess"
      },
      {
        "id": 4,
        "text": "Repair of cerebrospinal fluid leak"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Acute rhinosinusitis with epidural abscess</strong> is a <strong>contraindication</strong> for functional endoscopic sinus surgery.</p>\n<p>The endoscopic approach is contraindicated in the presence of an <strong>intracranial complication</strong> of acute infection such as:</p>\n<ul>\n<li>Meningitis</li>\n<li>Subperiosteal abscess</li>\n<li>Epidural abscess</li>\n<li>Cavernous sinus thrombosis</li>\n<li>Any visual loss\u00a0</li>\n</ul>\n<p>Note:\u00a0Endoscopic sinus surgery is indicated in chronic bacterial rhinosinusitis, allergic fungal sinusitis with mycetoma and repair of cerebrospinal fluid leak.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following structures cannot be accessed by performing an endoscopic nasal surgery?",
    "choices": [
      {
        "id": 1,
        "text": "Pituitary"
      },
      {
        "id": 2,
        "text": "Optic nerve"
      },
      {
        "id": 3,
        "text": "Cerebellum"
      },
      {
        "id": 4,
        "text": "Lacrimal sac"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Cerebellum</strong> cannot be accessed by performing endoscopic nasal surgery.</p>\n<p>Apart from the nose and paranasal sinuses, endoscopic surgery can be used to access the orbit, optic nerve, lacrimal sac, and pituitary gland.</p>\n<p><strong>Indications of</strong>&nbsp;<strong>advanced nasal endoscopic techniques</strong>:</p>\n<ul>\n<li>Removal of benign tumors, e.g. inverted papillomas or angiofibromas</li>\n<li>Orbital abscess or cellulitis management.</li>\n<li>Dacryocystorhinostomy</li>\n<li>Repair of CSF leak</li>\n<li>Pituitary surgery</li>\n<li>Optic nerve decompression</li>\n<li>Orbital decompression for Graves&rsquo; disease</li>\n<li>Control of posterior epistaxis (endoscopic clipping of sphenopalatine artery)</li>\n<li>Choanal atresia</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old-man with a history of chronic sinusitis unresponsive to medications is planned for functional endoscopic sinus surgery. Which of the following is the first step in the procedure?",
    "choices": [
      {
        "id": 1,
        "text": "Middle turbinectomy"
      },
      {
        "id": 2,
        "text": "Uncinectomy"
      },
      {
        "id": 3,
        "text": "Bullectomy"
      },
      {
        "id": 4,
        "text": "Sphenoidotomy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Uncinectomy</strong> where uncinate process is incised with sickle knife and removed with Blakesley forceps is the <strong>first definitive surgical step in FESS</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/405950c219254d738b6714f4255023e8x1280x2455.JPEG"
    ]
  },
  {
    "text": "You are a third-year ENT resident performing a functional endoscopic sinus surgery on a patient diagnosed with chronic maxillary sinusitis. During the procedure, the lateral wall of the infundibulum is punctured adjacent to the maxillary sinus ostium. Why is this step done?",
    "choices": [
      {
        "id": 1,
        "text": "To approach the middle meatus"
      },
      {
        "id": 2,
        "text": "To approach the nasolacrimal duct"
      },
      {
        "id": 3,
        "text": "To approach  the superior meatus"
      },
      {
        "id": 4,
        "text": "To approach the ethmoidal sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Infundibulotomy, </strong>also known as <strong>uncinectomy,</strong> is the first surgical step in FESS and it is done to approach the<strong> middle meatus</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Water\u2019s view is used to best visualize which of the following sinuses?",
    "choices": [
      {
        "id": 1,
        "text": "Maxillary sinus"
      },
      {
        "id": 2,
        "text": "Ethmoidal sinus"
      },
      {
        "id": 3,
        "text": "Frontal sinus"
      },
      {
        "id": 4,
        "text": "Sphenoid sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p class=\"p1\">Water&rsquo;s view is used to best visualize the <strong>maxillary sinus</strong>. <strong>Frontal</strong> and <strong>ethmoidal</strong> sinuses can also be visualized. <strong>Sphenoid</strong> sinus can be seen in Water's view with <strong>open mouth</strong>.</p>\n<p class=\"p1\">It is also known as the occipitomental view. The X-ray beam is angled at <strong>37&deg;-45&deg;</strong> to the orbitomeatal line.&nbsp;</p>\n<p class=\"p1\">The recommended imaging views for different sinuses are as follows:</p>\n<ul>\n<li><strong>Ethmoidal</strong> sinus: <strong>Rheese's</strong> view</li>\n<li><strong>Frontal</strong> sinus: <strong>Caldwell's</strong> view</li>\n<li><strong>Sphenoid</strong> sinus: <strong>Hirtz</strong> view</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8138f7bedf9042a8aaf499f7059fe71dx1280x1244.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/18bac6acf99c447cac1a2bd4f69b3983x600x729.JPEG"
    ]
  },
  {
    "text": "The radiograph shown below is done for better assessment of the frontal sinus. What is the common name of this view?",
    "choices": [
      {
        "id": 1,
        "text": "Water\u2019s view"
      },
      {
        "id": 2,
        "text": "Caldwell view"
      },
      {
        "id": 3,
        "text": "Pierre's view"
      },
      {
        "id": 4,
        "text": "Towne\u2019s view"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Other options:</p>\n<p>Option A:<strong> Water's view</strong>&nbsp;(occipitomental view or nose-chin position) is a radiographic view where an X-ray beam is angled at 45 degrees to the orbitomeatal line. Structures seen are the&nbsp;<strong>maxillary sinus</strong> (best seen), <strong>sphenoid&nbsp;sinus</strong> (if the film is taken with<strong>&nbsp;an open mouth</strong>), <strong>frontal sinus</strong>, zygoma, zygomatic arch, nasal bone, and infratemporal fossa.&nbsp;</p>\n<p>Option C:<strong> Pierre's view</strong> is the <strong>occipitomental with an open mouth.</strong> It helps in visualizing the <strong>sphenoid sinus</strong> as well, in addition to the sinuses that can be seen in water's view.</p>\n<p>Option D: <strong>Towne's view</strong>&nbsp;is an angled anteroposterior radiograph of the skull. Structures seen are the&nbsp;<strong>petrous part of the pyramids,&nbsp;</strong>arcuate eminence, superior semicircular canal, <strong>mastoid</strong> <strong>antrum</strong>, <strong>internal auditory canal</strong>, tympanic cavity, cochlea, and external auditory canal. This view is taken for <strong>acoustic neuroma</strong> and<strong> apical petrositis</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ac37aab57daa487483ef967125efba0e.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/26211f142c9f49b2b948b86428d191bex720x721.JPEG"
    ]
  }
];
        let quizName = '27 Sinusitis And Its Complication';
        const quizFilename = '27-sinusitis-and-its-complication-7c751203.html';
        let hierarchy = ["Marrow", "qBank", "ENT"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>