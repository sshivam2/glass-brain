<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>53 Esophagus - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pathology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">21</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "What is the most common site of fistulization in GIT?",
    "choices": [
      {
        "id": 1,
        "text": "Esophagus"
      },
      {
        "id": 2,
        "text": "Rectum"
      },
      {
        "id": 3,
        "text": "Anal canal"
      },
      {
        "id": 4,
        "text": "Ileum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>esophagus</strong> is the most common site of fistulization in the gastrointestinal&nbsp;tract (GIT).</p>\n<div class=\"page\" title=\"Page 1895\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>A <strong>tracheoesophageal fistula (TEF)</strong> is an abnormal fistula communication between the esophagus and trachea. The&nbsp;fistula is usually <strong>present</strong> near the <strong>tracheal bifurcation</strong>, with or without esophageal atresia. A blind proximal pouch with a distal tracheo&shy;oesophageal fistula is the most common type of tracheoesophageal fistula <strong>(Type C)</strong>.</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"page\" title=\"Page 154\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>10%</strong> of the patients have associated <strong>VACTERL</strong> anomalies (vertebral, anorectal, cardiac, tracheal, esophageal, renal, and limb).</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most frequent site of ectopic gastric mucosa?",
    "choices": [
      {
        "id": 1,
        "text": "Upper esophagus"
      },
      {
        "id": 2,
        "text": "Lower esophagus"
      },
      {
        "id": 3,
        "text": "Pancreas"
      },
      {
        "id": 4,
        "text": "Meckel's diverticulum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"page\" title=\"Page 757\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The most frequent site of the ectopic gastric mucosa is the <strong>upper third</strong> of the esophagus, where it is referred to as an <strong>inlet patch</strong>.</p>\n</div>\n</div>\n</div>\n</div>\n<p>It is <strong>congenital</strong> and mostly <strong>asymptomatic</strong>. Occasionally, it can release acid, which can result in dysphagia, esophagitis, Barrett esophagus, or, rarely, adenocarcinoma.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 57-year-old man came with complaints of difficulty in swallowing and a persistent feeling of something stuck in his throat. He also reports bad breath and regurgitation of food particles. Barium swallow revealed the following. This condition occurs due to a defect in which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Laimer\u2013Hackermann\u2019s triangle"
      },
      {
        "id": 2,
        "text": "Killian\u2013Jamieson area"
      },
      {
        "id": 3,
        "text": "Zenker's triangle"
      },
      {
        "id": 4,
        "text": "Killian's triangle"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario and barium swallow image are diagnostic of<strong> Zenker&rsquo;s diverticulum</strong>. It occurs due to a defect in the<strong>&nbsp;</strong><strong>Killian's triangle </strong>(Killian's dehiscence).</p>\n<p>Killian's triangle is<strong>&nbsp;</strong>an<strong>&nbsp;</strong>anatomical triangular area bordered superiorly by the firm oblique fibers of the <strong>thyropharyngeus</strong> muscle and inferiorly by the horizontal fibers of the <strong>cricopharyngeus</strong> muscle. It is located immediately above the upper esophageal sphincter.</p>\n<p>Although the Killian-Jamieson diverticulum is an anterolateral defect, it is <strong>rarely symptomatic</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3f7b9aef3c8b4f078da0cb1aa0ea1467.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following may be seen in patients with Plummer-Vinson syndrome except:",
    "choices": [
      {
        "id": 1,
        "text": "Cheilosis"
      },
      {
        "id": 2,
        "text": "Iron-deficiency anemia"
      },
      {
        "id": 3,
        "text": "Glossitis"
      },
      {
        "id": 4,
        "text": "Progressive dysphagia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Paterson&ndash;Brown&ndash;Kelly</strong> or <strong>Plummer&ndash;Vinson</strong> syndrome is associated with<strong> non-progressive dysphagia</strong>, especially with&nbsp;incompletely chewed food.</p>\n<p>This syndrome is common in <strong>women</strong> aged <strong>&gt;</strong><strong>40 years</strong>. The other components of this syndrome are:</p>\n<ul>\n<li>Post-cricoid webs in the upper esophagus</li>\n<li>Iron-deficiency anemia</li>\n<li>Glossitis</li>\n<li>Cheilosis</li>\n</ul>\n<p><strong>Esophageal webs </strong>are&nbsp;idiopathic, semi-circumferential lesions composed of&nbsp;fibrovascular connective tissue and overlying epithelium. They&nbsp;are usually limited to the&nbsp;<strong>proximal esophagus</strong>&nbsp;and may cause <strong>obstruction</strong>. They are associated with:</p>\n<ul>\n<li>Plummer&ndash;Vinson syndrome</li>\n<li>Gastroesophageal reflux disease</li>\n<li>Chronic graft-versus-host disease</li>\n<li>Blistering skin diseases</li>\n</ul>\n<div class=\"page\" title=\"Page 760\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>&nbsp;The images below show endoscopic and barium swallow appearances of esophageal webs.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/75875baa7fc941338e9e48a90a6ea47ax468x360.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5ea5a778ad9e4b99ac073daa49dd83aex720x1339.JPEG"
    ]
  },
  {
    "text": "A 45-year-old woman presented with complaints of difficulty in swallowing solid foods. An upper GI endoscopy revealed the following finding just above the gastroesophageal junction. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Type A ring"
      },
      {
        "id": 2,
        "text": "Type C ring"
      },
      {
        "id": 3,
        "text": "Type D ring"
      },
      {
        "id": 4,
        "text": "Type B ring"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows an<strong> esophageal ring</strong>. Rings located above the&nbsp;gastroesophageal junction are classified as<strong>&nbsp;type A</strong>&nbsp;esophageal rings.</p>\n<p>Esophageal rings are circumferential and&nbsp;thick. They include mucosa, submucosa, and occasionally, hypertrophic muscularis propria. There are 3 types:</p>\n<table style=\"height: 80px;\" width=\"448\">\n<tbody>\n<tr>\n<td style=\"width: 142px;\"><strong>Type A rings</strong></td>\n<td style=\"width: 142px;\"><strong>Type B&nbsp;</strong>or<strong> Schatzki rings</strong></td>\n<td style=\"width: 142px;\"><strong>Type C rings</strong></td>\n</tr>\n<tr>\n<td style=\"width: 142px;\">\n<p>Caused by normal physiologic smooth muscle contractions</p>\n</td>\n<td style=\"width: 142px;\">\n<p>Most common type</p>\n<p>Associated with hiatus hernia</p>\n</td>\n<td style=\"width: 142px;\">\n<p>Rare findings</p>\n<p>Indentations on radiographic studies due to diaphragmatic crural pressure</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 142px;\">\n<p>Seen <strong>above</strong> the gastroesophageal junction (<strong>GEJ</strong>) in the distal esophagus</p>\n<p>Covered by squamous mucosa</p>\n</td>\n<td style=\"width: 142px;\">\n<p>Located at the <strong>squamocolumnar</strong> <strong>junction</strong></p>\n<p>Covered by gastric cardia-type mucosa</p>\n</td>\n<td style=\"width: 142px;\">Found in the most <strong>distal</strong> portion of the esophagus</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Steakhouse syndrome</strong> refers to&nbsp;intermittent <strong>food impaction</strong> causing complete <strong>obstruction</strong> due to the presence of <strong>Schatzki</strong> rings.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0884d398704a41bfb546ced35159814a.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 52-year-old woman is being evaluated for dysphagia and chest pain. She traveled to Brazil on a business trip 5 months ago. Barium swallow reveals the following finding. Which of the following could have caused this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Leishmania donovani"
      },
      {
        "id": 2,
        "text": "Trypanosoma cruzi"
      },
      {
        "id": 3,
        "text": "Trypanosoma brucei"
      },
      {
        "id": 4,
        "text": "Schistosoma haematobium"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario and barium swallow showing the <strong>bird-beak appearance</strong>&nbsp;are suggestive of&nbsp;<strong>achalasia cardia.&nbsp;</strong>With respect to this patient's travel history,&nbsp;<strong>Chagas' disease</strong>&nbsp;due to infection with<em>&nbsp;<strong>Trypanosoma cruzi&nbsp;</strong></em>must be suspected.</p>\n<p>The infection destroys&nbsp;the<strong> myenteric plexus&nbsp;</strong>which results in failure of peristalsis and <strong>esophageal dilatation</strong>. Duodenal, colonic, and ureteric myenteric plexuses can also be affected by Chagas' disease.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c72dd4d7c6974fbfbc4083113b5dae5a.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is true about the pathology of achalasia cardia?",
    "choices": [
      {
        "id": 1,
        "text": "Relaxation of lower esophageal sphincter"
      },
      {
        "id": 2,
        "text": "Defective peristalsis"
      },
      {
        "id": 3,
        "text": "Decreased release of NO and VIP in the distal part of esophagus"
      },
      {
        "id": 4,
        "text": "Decreased tone of the  lower esophageal sphincter"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Achalasia cardia is characterized by <strong>decreased&nbsp;</strong>release of<strong> NO</strong>(nitric oxide)<strong> and VIP</strong>(vasoactive intestinal polypeptide) in the<strong> distal part </strong>of<strong> esophagus.</strong></p>\n<p>Normally, NO and VIP are secreted by the <strong>inhibitory</strong> neurons of the&nbsp;<strong>Auerbach's</strong> <strong>plexus</strong> in the distal esophagus. This leads to relaxation of the lower esophageal sphincter (LES). In achalasia cardia, these inhibitory neurons <strong>degenerate</strong> leading to decreased release of NO and VIP. This causes increased LES tone.</p>\n<p>The triad of achalasia cardia is as follows:</p>\n<ol>\n<li>Incomplete relaxation of LES</li>\n<li>Increased tone of LES</li>\n<li>Absent peristalsis (aperistalisis)</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A mother brought her 8-year-old son to the OPD with complaints of refusal to eat and poor weight gain. The child complained that food often gets stuck in his throat. Endoscopy revealed the following finding. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Gastroesophageal reflux disease"
      },
      {
        "id": 2,
        "text": "Eosinophilic esophagitis"
      },
      {
        "id": 3,
        "text": "Achalasia cardia"
      },
      {
        "id": 4,
        "text": "Plummer-Vinson syndrome"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Differentiating features between eosinophilic esophagitis and GERD:</p>\n<table style=\"height: 334px; width: 614px;\">\n<tbody>\n<tr>\n<td style=\"width: 172px; text-align: center;\"><strong>Factors</strong></td>\n<td style=\"width: 202.390625px; text-align: center;\"><strong>Eosinophilic esophagitis</strong></td>\n<td style=\"width: 220.609375px; text-align: center;\"><strong>GERD</strong></td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Dominant symptoms</td>\n<td style=\"width: 202.390625px;\">Dysphagia</td>\n<td style=\"width: 220.609375px;\">Heartburn and regurgitation</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Food impaction</td>\n<td style=\"width: 202.390625px;\">Common</td>\n<td style=\"width: 220.609375px;\">Uncommon</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Gender</td>\n<td style=\"width: 202.390625px;\">Male predominance</td>\n<td style=\"width: 220.609375px;\">Male = female</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Age</td>\n<td style=\"width: 202.390625px;\">Children, young adults</td>\n<td style=\"width: 220.609375px;\">Middle age</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Esophageal findings on endoscopy</td>\n<td style=\"width: 202.390625px;\">\n<ul>\n<li>Edema</li>\n<li>Multiple stacked rings (feline esophagus) and&nbsp;longitudinal furrows</li>\n<li>Punctate exudates</li>\n<li>Strictures and narrow-caliber esophagus</li>\n<li>Crepe-paper esophagus</li>\n</ul>\n<strong>Normal</strong> findings in <strong>&lt;10%</strong> patients</td>\n<td style=\"width: 220.609375px;\">\n<ul>\n<li>Erosions and ulcers</li>\n<li>Strictures</li>\n<li>Barrett's esophagus and adenocarcinoma</li>\n</ul>\n<strong>Normal</strong> findings on endoscopy in <strong>majority</strong> of patients</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Ambulatory pH testing</td>\n<td style=\"width: 202.390625px;\">Negative or positive</td>\n<td style=\"width: 220.609375px;\">Positive</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Histology</td>\n<td style=\"width: 202.390625px;\">&ge;15 eosinophils/hpf</td>\n<td style=\"width: 220.609375px;\">&lt;7 eosinophils/hpf</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Etiology</td>\n<td style=\"width: 202.390625px;\">Atopic or immune-mediated, acid reflux is not prominent</td>\n<td style=\"width: 220.609375px;\">Acid reflux</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Primary treatment</td>\n<td style=\"width: 202.390625px;\">\n<p>Proton-pump inhibitors (PPIs)</p>\n<p>Steroids (topical)</p>\n<p>Elimination diet</p>\n</td>\n<td style=\"width: 220.609375px;\">\n<p>Antacids</p>\n<p>H<sub>2</sub>&nbsp;receptor blockers</p>\n<p>Proton-pump inhibitors (PPIs)</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [
      "https://daily-rounds-staging.s3.amazonaws.com/uploads/ef764b2d194e4526b1a5922e9a01385f.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is incorrect about eosinophilic esophagitis?",
    "choices": [
      {
        "id": 1,
        "text": "Majority of patients have associated atopic conditions"
      },
      {
        "id": 2,
        "text": "Feline esophagus is an endoscopic finding"
      },
      {
        "id": 3,
        "text": "Treatment of choice is systemic steroids"
      },
      {
        "id": 4,
        "text": "May be associated with food products like cow\u2019s milk and soy products"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Treatment of choice are <strong>proton pump inhibitors</strong>, which when started as primary therapy is effective in <strong>30 - 50 %</strong> of affected individuals.&nbsp;<br />Additionally, <strong>elimination</strong> of allergenic proteins from diet as it is is associated with&nbsp;<strong>atopy</strong>&nbsp;and exposure to food allergens like <strong>cow&rsquo;s milk</strong> and <strong>soy</strong> products. <br /><strong>Swallowed topical steroids</strong> are used as well.</p>\n<p><strong>Immunocompromised</strong> patients are treated with <strong>acyclovir</strong>, famciclovir or valacyclovir.</p>\n<table style=\"height: 334px; width: 614px;\">\n<tbody>\n<tr>\n<td style=\"width: 172px; text-align: center;\"><strong>Factors</strong></td>\n<td style=\"width: 202.390625px; text-align: center;\"><strong>Eosinophilic esophagitis</strong></td>\n<td style=\"width: 220.609375px; text-align: center;\"><strong>GERD</strong></td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Dominant symptoms</td>\n<td style=\"width: 202.390625px;\">Dysphagia</td>\n<td style=\"width: 220.609375px;\">Heartburn and regurgitation</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Food impaction</td>\n<td style=\"width: 202.390625px;\">Common</td>\n<td style=\"width: 220.609375px;\">Uncommon</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Gender</td>\n<td style=\"width: 202.390625px;\">Male predominance</td>\n<td style=\"width: 220.609375px;\">Male = female</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Age</td>\n<td style=\"width: 202.390625px;\">Children, young adults</td>\n<td style=\"width: 220.609375px;\">Middle age</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Esophageal findings on endoscopy</td>\n<td style=\"width: 202.390625px;\">\n<ul>\n<li>Edema</li>\n<li>Multiple stacked rings (<strong>feline esophagus</strong>) and&nbsp;longitudinal furrows</li>\n<li>Punctate exudates</li>\n<li>Strictures and narrow-caliber esophagus</li>\n<li>Crepe-paper esophagus</li>\n</ul>\nNormal findings in &lt;10% patients</td>\n<td style=\"width: 220.609375px;\">\n<ul>\n<li>Erosions and ulcers</li>\n<li>Strictures</li>\n<li>Barrett's esophagus and adenocarcinoma</li>\n</ul>\nNormal findings on endoscopy in majority of patients</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Ambulatory pH testing</td>\n<td style=\"width: 202.390625px;\">Negative or positive</td>\n<td style=\"width: 220.609375px;\">Positive</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Histology</td>\n<td style=\"width: 202.390625px;\">&ge;15 eosinophils/hpf</td>\n<td style=\"width: 220.609375px;\">&lt;7 eosinophils/hpf</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Etiology</td>\n<td style=\"width: 202.390625px;\">Atopic or immune-mediated, acid reflux is not prominent</td>\n<td style=\"width: 220.609375px;\">Acid reflux</td>\n</tr>\n<tr>\n<td style=\"width: 172px;\">Primary treatment</td>\n<td style=\"width: 202.390625px;\">\n<p>Proton-pump inhibitors (PPIs)</p>\n<p><strong>Elimination</strong>&nbsp;of <strong>allergens</strong> in diet</p>\n<p><strong>Steroids </strong>(topical)</p>\n<p>&nbsp;</p>\n</td>\n<td style=\"width: 220.609375px;\">\n<p>Antacids</p>\n<p>H<sub>2</sub>&nbsp;receptor blockers</p>\n<p>Proton-pump inhibitors (PPIs)</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 47-year-old woman comes to you with progressive heartburn and difficulty in swallowing. She also describes episodes of painful blanching and bluish discoloration of her fingers and toes on exposure to cold. The following findings are noted on examination. Antibodies to which of the following are most likely to be seen in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Centromeric proteins"
      },
      {
        "id": 2,
        "text": "Histidyl-t-RNA synthetase (Jo-1)"
      },
      {
        "id": 3,
        "text": "Ribonucleoprotiens"
      },
      {
        "id": 4,
        "text": "Histones"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The symptoms of the patient in the above case scenario and the image showing <strong>calcinosis</strong> are the characteristic findings of the <strong>CREST syndrome</strong>&nbsp;or&nbsp;<strong>limited</strong>&nbsp;<strong>scleroderma</strong>.&nbsp;Patients with this condition characteristically have antibodies directed against&nbsp;<strong>centromeric proteins </strong>(anti-centromere antibodies).</p>\n<p>CREST syndrome is characterized by the following:</p>\n<ul>\n<li><strong>C</strong>alcinosis</li>\n<li><strong>R</strong>aynaud phenomenon</li>\n<li><strong>E</strong>sophageal dysmotility</li>\n<li><strong>S</strong>clerodactyly</li>\n<li><strong>T</strong>elangiectasia</li>\n</ul>\n<div class=\"page\" title=\"Page 237\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>In the esophagus, progressive <strong>atrophy</strong> and <strong>fibrous</strong> replacement of the muscularis propria leads to <strong>hypomotility</strong> and dysphagia. The lower 2/3 of the esophagus develops a <strong>rubber-hose&ndash;like</strong>&nbsp;inflexibility. The associated dysfunction of the lower esophageal sphincter gives rise to gastroesophageal reflux, Barrett metaplasia, and stricture.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/dd025414be1548498e01971d40b45763.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old man presented with blood in his vomitus. He gives a history of binge drinking followed by multiple episodes of vomiting the prior night. He is hemodynamically stable.  Which of the following is incorrect about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is due to longitudinal mucosal tears"
      },
      {
        "id": 2,
        "text": "The gastroesophageal musculature fails to relax"
      },
      {
        "id": 3,
        "text": "The tears cross the gastroesophageal junction"
      },
      {
        "id": 4,
        "text": "It requires surgical intervention"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>This clinical scenario is suggestive of a&nbsp;<strong>Mallory&ndash;Weiss tear</strong>. They require only <strong>conservative</strong> management and <strong>healing</strong>&nbsp;tends to be <strong>rapid </strong>and<strong> complete</strong>.</p>\n<p>They are <strong>longitudinal mucosal tears </strong>that may cross the gastroesophageal junction (<strong>GEJ</strong>). Forceful<strong>&nbsp;retching</strong> or vomiting along with <strong>failure</strong> of reflex <strong>relaxation</strong> of the <strong>gastroesophageal</strong> <strong>musculature</strong> results in tears involving the mucosa and submucosa. It usually occurs secondary to conditions like acute alcohol intoxication or hyperemesis gravidarum.</p>\n<p><strong>Boerhaave syndrome</strong> is a much more serious disorder characterized by <strong>transmural </strong><strong>rupture</strong> of the distal esophagus. This results in acute mediastinitis with severe chest pain, tachypnea, and shock. Such patients generally require urgent<strong> surgical</strong> intervention.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most frequent cause of esophagitis?",
    "choices": [
      {
        "id": 1,
        "text": "Pill esophagitis"
      },
      {
        "id": 2,
        "text": "Eosinophilic esophagitis"
      },
      {
        "id": 3,
        "text": "Infectious esophagitis"
      },
      {
        "id": 4,
        "text": "Reflux esophagitis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The most frequent cause of<strong>&nbsp;esophagitis </strong>is<strong>&nbsp;reflux of gastric acid</strong> into the lower esophagus.</p>\n<p>The most common cause of gastroesophageal reflux is transient lower esophageal sphincter relaxation. Reflux esophagitis leads to chronic gastroesophageal reflux disease (<strong>GERD</strong>). This can cause <strong>Barrett's</strong> <strong>esophagus</strong> and eventually can cause <strong>adenocarcinoma</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which organism can cause esophageal infections in healthy individuals?",
    "choices": [
      {
        "id": 1,
        "text": "Cytomegalovirus"
      },
      {
        "id": 2,
        "text": "Herpes-simplex virus"
      },
      {
        "id": 3,
        "text": "Candida"
      },
      {
        "id": 4,
        "text": "Aspergillus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Esophagitis</strong>&nbsp;in <strong>healthy</strong> <strong>individuals</strong> can be caused by<strong>&nbsp;</strong>the<strong>&nbsp;<em>Herpes simplex </em></strong>virus.<strong>&nbsp;</strong>However, it is relatively uncommon.</p>\n<p>In <strong>immunosuppressed</strong> individuals, infections can be caused by:</p>\n<ul>\n<li><em>Herpes simplex</em> virus&nbsp;</li>\n<li><em>Cytomegalovirus</em></li>\n<li><em>Candida</em></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Punched-out ulcers in the esophagus are caused by:",
    "choices": [
      {
        "id": 1,
        "text": "Herpes-simplex virus"
      },
      {
        "id": 2,
        "text": "Cytomegalovirus"
      },
      {
        "id": 3,
        "text": "Candida"
      },
      {
        "id": 4,
        "text": "Acid"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Note: <strong>CMV </strong>esophagitis<strong>&nbsp;</strong>causes <strong>shallow ulcerations</strong>. The biopsy is taken from the <strong>base</strong> of the ulcer and shows characteristic <strong>nuclear</strong> and <strong>cytoplasmic</strong> <strong>inclusions </strong>bodies.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5dc7ceb412fe4823a9226e9dc0bf648ax1280x1135.JPEG"
    ]
  },
  {
    "text": "A 28-year-old patient with haematemesis is found to have the following finding on upper GI endoscopy. He has traveled to Zambia several times over the past 3 years. What could be the likely cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Fascioliasis"
      },
      {
        "id": 2,
        "text": "Schistosomiasis"
      },
      {
        "id": 3,
        "text": "Ecchinococcosis"
      },
      {
        "id": 4,
        "text": "Leishmaniasis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This clinical scenario and image showing bleeding <strong>esophageal</strong> <strong>varices</strong> are suggestive of<strong>&nbsp;hepatic schistosomiasis</strong>.&nbsp;It is the&nbsp;<strong>second</strong> <strong>most</strong> <strong>common</strong> cause of varices worldwide.</p>\n<p>Liver cirrhosis, mostly in association with <strong>alcoholic liver disease</strong>, is the <strong>most common</strong> cause of varices.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/39ee2e9bee4247768445ddd2efdb3227.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "All are true about Barrett oesophagus except:",
    "choices": [
      {
        "id": 1,
        "text": "Complication of chronic GERD"
      },
      {
        "id": 2,
        "text": "Seen in 10% of  individuals with symptomatic GERD"
      },
      {
        "id": 3,
        "text": "Increases risk of squamous cell carcinoma"
      },
      {
        "id": 4,
        "text": "Intestinal metaplasia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The following images show endoscopic and microscopic images of Barrett's esophagus:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0a8052abd6cf498fb4b9aea0a3863a4fx1279x1702.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3ef92d66d9c04991bf72f929e9aa7743x512x222.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/82e3abd7a6594b2890a7ab3a72930de1x1280x1048.JPEG"
    ]
  },
  {
    "text": "A 60-year-old man with chronic dyspepsia underwent upper GI endoscopy. The biopsy findings are shown below. What is the special stain that has been used?",
    "choices": [
      {
        "id": 1,
        "text": "Periodic acid Schiff"
      },
      {
        "id": 2,
        "text": "Alcian blue"
      },
      {
        "id": 3,
        "text": "Combined Alcian blue-PAS"
      },
      {
        "id": 4,
        "text": "Mucicarmine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\"><span class=\"s1\">The given image is of <strong>Barrett's</strong> esophagus showing <strong>intestinal metaplasia</strong>. The special stain used here is <strong>Alcian blue,</strong> which stains the <strong>acid mucin</strong> present in the goblet cells.</span></p>\n<p class=\"p1\"><span class=\"s1\">The following stains are used for mucin:</span></p>\n<table style=\"height: 123px; width: 332.34375px;\">\n<tbody>\n<tr>\n<td style=\"width: 92px;\"><strong>Stain</strong></td>\n<td style=\"width: 111px;\"><strong>Type of mucin</strong></td>\n<td style=\"width: 108.34375px;\"><strong>Color stained</strong></td>\n</tr>\n<tr>\n<td style=\"width: 92px;\"><span class=\"s1\">Periodic acid Schiff (PAS)</span></td>\n<td style=\"width: 111px;\"><span class=\"s1\">Neutral mucin</span></td>\n<td style=\"width: 108.34375px;\"><span class=\"s1\">Magenta pink</span></td>\n</tr>\n<tr>\n<td style=\"width: 92px;\">Alcian blue</td>\n<td style=\"width: 111px;\">Acid mucin</td>\n<td style=\"width: 108.34375px;\">Blue</td>\n</tr>\n<tr>\n<td style=\"width: 92px;\">Combined Alcian blue-PAS</td>\n<td style=\"width: 111px;\">\n<p>Acid mucin</p>\n<p>Neutral mucin</p>\n</td>\n<td style=\"width: 108.34375px;\">\n<p>Blue</p>\n<p>Magenta pink</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 92px;\">Mucicarmine</td>\n<td style=\"width: 111px;\">Acid mucin</td>\n<td style=\"width: 108.34375px;\">Rose-red</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [
      "https://daily-rounds-staging.s3.amazonaws.com/uploads/6a25939601754c69b2c8ea95a9bdc05b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false?",
    "choices": [
      {
        "id": 1,
        "text": "The most common site of extranodal lymphoma in GIT is the esophagus"
      },
      {
        "id": 2,
        "text": "The most common benign tumour of esophagus is leimyoma"
      },
      {
        "id": 3,
        "text": "The most common esophageal cancer overall is squamous cell carcinoma"
      },
      {
        "id": 4,
        "text": "The most common esophageal cancer in Western countries is adenocarcinoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>&nbsp;The most common site of <strong>extranodal</strong> <strong>lymphoma</strong> in GIT is the&nbsp;<strong>stomach</strong>, not the esophagus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a predisposing factor for esophageal cancer?",
    "choices": [
      {
        "id": 1,
        "text": "Mediastinal fibrosis"
      },
      {
        "id": 2,
        "text": "Diverticula"
      },
      {
        "id": 3,
        "text": "Caustic alkali burn"
      },
      {
        "id": 4,
        "text": "HPV"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Mediastinal fibrosis does not&nbsp;predispose to esophageal carcinoma.&nbsp;<strong>Risk factors</strong> for <strong>esophageal carcinoma</strong> include the following:&nbsp;</p>\n<ul>\n<li>Alcohol and tobacco use</li>\n<li>Poverty</li>\n<li><strong>Caustic alkali burns</strong></li>\n<li><strong>Diverticula</strong></li>\n<li>Achalasia</li>\n<li>Tylosis</li>\n<li>Plummer&ndash;Vinson syndrome</li>\n<li>Frequent consumption of very hot beverages</li>\n<li>Radiation exposure to the mediastinum</li>\n<li>Human papillomavirus<strong> (HPV) infection&nbsp;</strong>- squamous cell carcinomas</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with recurrent gastritis has been diagnosed with Helicobacter pylori infection. Which of the following is true in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Increased risk of adenocarcinoma of esophagus"
      },
      {
        "id": 2,
        "text": "Decreased risk of adenocarcinoma of esophagus"
      },
      {
        "id": 3,
        "text": "Increased risk of squamous cell carcinoma of esophagus"
      },
      {
        "id": 4,
        "text": "Decreased risk of squamous cell carcinoma of esophagus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong><em>Helicobacter pylori</em></strong> infection is associated with&nbsp;<strong>decreased risk </strong>of esophageal <strong>adenocarcinoma</strong>.</p>\n<p>Long-standing&nbsp;<em>H. pylori</em> gastritis (chronic inflammation) causes multifocal <strong>gastric mucosal atrophy</strong>, which in turn leads to <strong>reduced</strong> parietal cell mass, <strong>acid secretion.</strong>&nbsp;This leads to&nbsp;<strong>reduced</strong> <strong>incidence</strong> of Barrett's esophagus and decreased risk of esophageal <strong>adenocarcinoma</strong>.&nbsp;</p>\n<p><em>H. pylori</em> infection, however,&nbsp;<strong>increases </strong>the<strong> risk</strong> of <strong>gastric&nbsp;adenocarcinoma.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Endoscopic and barium swallow images of a lesion in the oesophagus of a patient are as shown below. What is the expected histopathological finding?",
    "choices": [
      {
        "id": 1,
        "text": "Image 2"
      },
      {
        "id": 2,
        "text": "Image 1"
      },
      {
        "id": 3,
        "text": "Image 4"
      },
      {
        "id": 4,
        "text": "Image 3"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given&nbsp;images showing an <strong>esophageal exophytic growth</strong>&nbsp;on endoscopy and&nbsp;<strong>apple core appearance</strong>&nbsp;in the<strong> middle 1/3</strong>&nbsp;of the esophagus on barium swallow are suggestive of <strong>squamous cell carcinoma.</strong>&nbsp;The characteristic histopathological finding in this condition are <strong>nests</strong> of stratified malignant cells and&nbsp;<strong>keratin</strong> <strong>pearls</strong>, which are noted in&nbsp;image&nbsp;4.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/143903d49673443abde235721a409426.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/35dae415b8e24e1c8f65d099f6fd8238x1280x1049.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/773e24b7b9e24ef881bed2b58f99d218x1279x1048.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f03350b97f8d455da3e53b9124e9d83ax1279x1048.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b943f25f3358433583d6924c14ba9801x1279x1049.JPEG"
    ]
  }
];
        let quizName = '53 Esophagus';
        const quizFilename = '53-esophagus-9671ac3d.html';
        let hierarchy = ["Marrow", "qBank", "Pathology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>