<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>045 Bronchiectasis And Lung Abscess - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">19</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "An old woman presents with a persistent productive cough and clubbing. On auscultation, wheeze and crackles are present. There is no history of fever. Which of the following is the investigation of choice to confirm the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "HRCT"
      },
      {
        "id": 2,
        "text": "CECT"
      },
      {
        "id": 3,
        "text": "Helical CT"
      },
      {
        "id": 4,
        "text": "Spiral CT"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical scenario is suggestive of <strong>bronchiectasis. HRCT</strong> is the investigation of choice - <strong>most specific.</strong></p>\n<p>Bronchiectasis is a suppurative lung disease with <strong>abnormal</strong> and <strong>irreversible dilatation</strong> of the<strong> bronchi</strong>.&nbsp;It is an end-stage condition of various diseases (infections, congenital or autoimmune disorders) that result in the <strong>destruction</strong> of the <strong>bronchial wall</strong> and its surrounding supporting tissues.&nbsp;</p>\n<p><strong>Ried&rsquo;s classification</strong> divides bronchiectasis into 3 types based on the <strong>phenotype</strong> of the affected bronchi:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Cylindrical or tubular (<strong>most common</strong>)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Saccular or varicose</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Cystic</li>\n</ul>\n<p><strong>Traction bronchiectasis</strong> is a type of bronchiectasis seen in conditions causing <strong>extensive pulmonary fibrosis</strong> (tuberculosis, idiopathic pulmonary fibrosis). The mechanical traction due to fibrosis pulls apart the adjacent bronchi, making them distorted and abnormally dilated. There is <strong>no destruction</strong> of the bronchial wall.</p>\n<p>Clinically, they have a chronic productive cough, clubbing, crackles, and rhonchi.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old woman is admitted to the hospital with a fever and cough. She has a history of repeated chest infections for several years and coughs up yellow-green purulent sputum with some streaky hemoptysis. What could be the underlying condition based on the CT given below?",
    "choices": [
      {
        "id": 1,
        "text": "Cystic fibrosis"
      },
      {
        "id": 2,
        "text": "Tuberculosis"
      },
      {
        "id": 3,
        "text": "Amyloidosis"
      },
      {
        "id": 4,
        "text": "Lung abscess"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario and the CT showing <strong>signet ring sign</strong> is suggestive of <strong>bronchiectasis</strong>&nbsp;which can be due to <strong>cystic fibrosis</strong>.</p>\n<p>A history of <strong>repeated chest infections</strong> is an indication of cystic fibrosis and a major risk factor for the development of bronchiectasis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/723f274c00c14489a232f1638772d821.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an unlikely complication in patients with bronchiectasis?",
    "choices": [
      {
        "id": 1,
        "text": "Cor pulmonale"
      },
      {
        "id": 2,
        "text": "Amyloidosis"
      },
      {
        "id": 3,
        "text": "Lung cancer"
      },
      {
        "id": 4,
        "text": "Empyema"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Lung cancer is not a known complication of bronchiectasis.</p>\n<p><strong>Complications of bronchiectasis include:</strong></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Massive hemoptysis&nbsp;</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Empyema and lung abscess</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Respiratory failure</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Pulmonary hypertension and cor pulmonale</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Secondary amyloidosis (AA type)</li>\n</ul>\n<p><strong>Chronic</strong> and <strong>recurrent infections</strong> lead to secondary amyloidosis (AA type) and involve the <strong>kidneys</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 58-year-old white man presents with a 6-month history of productive cough, weight loss, fever, and night sweats. HRCT shows a cluster of grapes appearance. A biopsy shows features of a non-tuberculous mycobacterial infection. Cystic fibrosis is ruled out. Which of the following drugs is not to be used in the treatment regimen?",
    "choices": [
      {
        "id": 1,
        "text": "Macrolide"
      },
      {
        "id": 2,
        "text": "Ethambutol"
      },
      {
        "id": 3,
        "text": "Bronchodilators"
      },
      {
        "id": 4,
        "text": "Mucolytic dornase"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario is suggestive of <strong>bronchiectasis</strong> secondary to a non-tuberculous mycobacterial (<strong>NTM</strong>) infection.&nbsp;<strong>Mucolytic dornase</strong> is recommended routinely in <strong>c</strong><strong>ystic fibrosis (CF)-related bronchiectasis</strong>&nbsp;but not in non-CF bronchiectasis.</p>\n<p><strong>Macrolides</strong> (azithromycin or clarithromycin) combined with <strong>rifampicin</strong> and <strong>ethambutol</strong> are used in the treatment of non-CF bronchiectasis.</p>\n<p><strong>Treatment of bronchiectasis:</strong></p>\n<ol>\n<li>Antibiotic therapy: This is used to treat <strong>exacerbations&nbsp;</strong>and&nbsp;is given for <strong>10-14 days</strong>. Commonly administered antibiotics include:\n<ul>\n<li>Amoxicillin or clarithromycin: <strong>First-line</strong> drugs</li>\n<li>Ciprofloxacin: For&nbsp;<em>Pseudomonas aeruginosa</em></li>\n</ul>\n</li>\n<li>Airway clearance:\n<ul>\n<li>Postural drainage:&nbsp;This is done by gravity-assisted positioning of the patient and chest physiotherapy.</li>\n<li>Mucolytic treatment: only in cystic fibrosis patients&nbsp;\n<ul>\n<li>Normal or hypertonic saline (&ge;3%) nebulization</li>\n<li>Humidified air inhalation</li>\n<li>Drugs like N-acetylcysteine or carbocysteine</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Others:\n<ul>\n<li>Inhaled bronchodilators like long-acting &beta;2 agonists and anticholinergics</li>\n<li>Long-term oxygen therapy: In patients with chronic respiratory failure</li>\n<li>Pulmonary rehabilitation</li>\n<li>Adequate hydration</li>\n<li>Resection of a focal area of suppuration, lung transplantation: In refractory cases</li>\n</ul>\n</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A college student presents with complaints of fever, chronic productive cough, steatorrhea. There is a past history of recurrent lung infections and multiple hospitalizations with similar complaints. Which of the following is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "An autosomal-recessive disorder"
      },
      {
        "id": 2,
        "text": "Abnormality in CFTR gene leads to defective calcium transport"
      },
      {
        "id": 3,
        "text": "Most common mutation is F508 deletion"
      },
      {
        "id": 4,
        "text": "Males have infertility in adult life"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Cystic fibrosis is an <strong>autosomal recessive</strong> disorder affecting the <strong>epithelial cells</strong> of various <strong>exocrine glands</strong> of the body.&nbsp;It&nbsp;is caused by mutations in the gene coding for CFTR protein.&nbsp;The <strong>most common</strong> CFTR mutation is <strong>F508 deletion</strong>.</p>\n<p>The most prominent clinical features of cystic fibrosis are <strong>chronic respiratory diseases</strong> (fever, productive cough, recurrent lung infections) and <strong>pancreatic insufficiency </strong>(steatorrhea).</p>\n<p><strong>Male</strong> patients with cystic fibrosis usually have <strong>infertility</strong> due to congenital absence of bilateral vas deferens and defective sperm transport, resulting in <strong>azoospermia</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 17-year-old boy presents to the clinic with an acute respiratory tract infection. He has a history of asthma associated with recurrent respiratory tract infections and sinusitis. Genetic testing in childhood had revealed CFTR mutations. Which of the following is likely to be decreased in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Sweat chloride"
      },
      {
        "id": 2,
        "text": "Serum bicarbonate level"
      },
      {
        "id": 3,
        "text": "Sperm count"
      },
      {
        "id": 4,
        "text": "Immunoreactive trypsinogen"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option A: <strong>Sweat chloride</strong> levels are elevated (<strong>&ge;60 mEq/L</strong>) due to abnormalities in the CFTR protein leading to <strong>defective chloride transport</strong>.&nbsp;</p>\n<p>Option B: <strong>Serum bicarbonate</strong> levels are increased due to excessive loss of salt in the sweat resulting in&nbsp;<strong>hypochloremic alkalosis</strong>.</p>\n<p>Option D: Immunoreactive <strong>trypsinogen</strong> levels are <strong>increased&nbsp;</strong>due&nbsp;to <strong>exocrine pancreatic insufficiency</strong>.<strong>&nbsp;</strong>Measurement of these levels is a diagnostic&nbsp;<strong>screening</strong> test<strong>&nbsp;</strong>in <strong>newborns.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young boy is being evaluated for cystic fibrosis. Sweat chloride shows values of 38 and 44 mEq/L (normal<40). What is the next best test to confirm the diagnosis of cystic fibrosis?",
    "choices": [
      {
        "id": 1,
        "text": "72-hour fecal fat"
      },
      {
        "id": 2,
        "text": "Immunoreactive trypsinogen levels"
      },
      {
        "id": 3,
        "text": "DNA analysis"
      },
      {
        "id": 4,
        "text": "Trans epithelial nasal potential difference"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option A: 72-hour fecal fat is not used in the diagnosis of CF.</p>\n<p>Option B: Measuring the levels of <strong>immunoreactive</strong> <strong>trypsinogen</strong> is a\u00a0<strong>screening test\u00a0</strong>in <strong>newborns.</strong></p>\n<p>Option D: Trans epithelial nasal potential difference measurement can be used as an adjunct to sweat test, but it has <strong>limited</strong> availability and is predominantly used as a <strong>research tool.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 15-year-old boy has been having recurrent hospitalizations for infections, since 2 years of age. After a detailed evaluation, a diagnosis of Kartagener's syndrome was made. Which of the following features is not a component of the triad seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Situs inversus totalis"
      },
      {
        "id": 2,
        "text": "Chronic sinusitis"
      },
      {
        "id": 3,
        "text": "Male infertility"
      },
      {
        "id": 4,
        "text": "Bronchiectasis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Male infertility is typical in Kartagener syndrome, but not a component of the triad.</p>\n<p><strong>Kartagener&rsquo;s syndrome</strong> is <strong>primary ciliary dyskinesia</strong> characterized by the classical triad of:</p>\n<ul>\n<li>Situs inversus</li>\n<li>Chronic sinusitis</li>\n<li>Bronchiectasis</li>\n</ul>\n<p>Primary ciliary dyskinesia (also called immotile cilia syndrome) is an <strong>autosomal recessive</strong> disorder affecting <strong>ciliary motility</strong>. It occurs due to ultrastructural defects in the<strong> dynein</strong> arm of cilia.&nbsp;This causes the retention of secretions due to a failed mucociliary clearance mechanism. Clinically, this manifests as <strong>chronic sinusitis</strong> and recurrent infections that ultimately lead to <strong>bronchiectasis.</strong></p>\n<p>As ciliary function is necessary to ensure proper rotation of the developing organs in the chest and abdomen, its absence, will lead to&nbsp;<strong>situs inversus</strong> or a partial lateralizing abnormality.</p>\n<p>Male patients with this condition tend to be<strong> infertile</strong>,&nbsp;due to <strong>asthenospermia</strong> (immotile spermatozoa due to impaired sperm flagella function).&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Infertility in Kartagener\u2019s syndrome is due to which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Oligospermia"
      },
      {
        "id": 2,
        "text": "Asthenospermia"
      },
      {
        "id": 3,
        "text": "Undescended testes"
      },
      {
        "id": 4,
        "text": "Epididymis obstruction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Kartagener&rsquo;s syndrome</strong> is a type of <strong>primary ciliary dyskinesia</strong> characterized by the classical triad of</p>\n<ul>\n<li>Situs inversus</li>\n<li>Chronic sinusitis</li>\n<li>Bronchiectasis</li>\n</ul>\n<p><strong>Infertility</strong> in Kartagener&rsquo;s syndrome is due to <strong>asthenospermia</strong> (immotile spermatozoa due to impaired sperm flagella function), <strong>not azoospermia</strong> (complete absence of spermatozoa in ejaculate).</p>\n<p><strong>Primary ciliary dyskinesia</strong> (also called immotile cilia syndrome) is an <strong>autosomal recessive disorder affecting ciliary motility</strong>. It occurs due to <strong>ultrastructural defects in the dynein arm</strong> of cilia. This causes the retention of secretions due to a failed mucociliary clearance mechanism. Clinically, this manifests as <strong>chronic sinusitis</strong> and recurrent infections that ultimately lead to <strong>bronchiectasis</strong>. As ciliary function is necessary to ensure proper rotation of the developing organs in the chest and abdomen, its absence will lead to <strong>situs inversus or a partial lateralizing abnormality</strong>. Approximately half of the patients with primary ciliary dyskinesia have Kartagener syndrome.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which is the most common cause of lung abscess?",
    "choices": [
      {
        "id": 1,
        "text": "Tuberculosis"
      },
      {
        "id": 2,
        "text": "Pneumonia"
      },
      {
        "id": 3,
        "text": "Aspirated oropharyngeal secretion"
      },
      {
        "id": 4,
        "text": "Sepsis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>most common cause</strong> of <strong>lung abscess</strong> is aspirated <strong>oropharyngeal secretion</strong>.</p>\n<p>Lung abscess represents necrosis and cavitation of the lung following microbial infection. They are broadly divided into two categories:</p>\n<ol>\n<li><strong>Primary lung abscesses</strong>: usually arise from aspiration, often caused principally by anaerobic bacteria (most common)</li>\n<li><strong>Secondary lung abscesses</strong>: arise in the setting of an underlying condition, such as a post-obstructive process (e.g., a bronchial foreign body or tumor) or a systemic process (e.g., HIV infection or another immunocompromising condition)</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A bed-ridden patient with a Ryles tube tried to pull out the tube. This led to aspiration following which he developed fever with chills and cough. X-ray findings were suggestive of lung abscess. Which of the following pathogens is unlikely to have caused it?",
    "choices": [
      {
        "id": 1,
        "text": "Bacteroides"
      },
      {
        "id": 2,
        "text": "Streptococcus milleri"
      },
      {
        "id": 3,
        "text": "Microaerophilic streptococci"
      },
      {
        "id": 4,
        "text": "Staphylococcus aureus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario is suggestive of a <strong>primary lung abscess.</strong><em><strong> Staphylococcus</strong></em> is involved in the formation of<strong> secondary </strong>lung abscess, not primary.</p>\n<p><strong>Microbial pathogens causing lung abscess:</strong></p>\n<table style=\"height: 447px;\" width=\"450\">\n<tbody>\n<tr>\n<td style=\"width: 213px;\">\n<p><strong>Clinical conditions</strong></p>\n</td>\n<td style=\"width: 221px;\">\n<p><strong>Pathogens</strong></p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 213px;\">\n<p>Primary lung abscess (due to aspiration)</p>\n</td>\n<td style=\"width: 221px;\">\n<p>Anaerobes (e.g., <em>Peptostreptococcus</em> spp., <em>Prevotella</em> spp., Bacteroides spp., <em>Streptococcus milleri</em>), microaerophilic streptococci</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 213px;\">\n<p>Secondary lung abscess (due to underlying conditions)</p>\n</td>\n<td style=\"width: 221px;\">\n<p><em>Staphylococcus aureus</em>, gram-negative\u2028rods (e.g., <em>Pseudomonas aeruginosa</em>, <em>Enterobacteriaceae</em>), <em>Nocardia</em> spp., <em>Aspergillus</em> spp., <em>Legionella</em> spp., <em>Pneumocystis jirovecii</em></p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 213px;\">\n<p>Embolic lesions</p>\n</td>\n<td style=\"width: 221px;\">\n<p><em>Staphylococcus aureus</em> (often from endocarditis), <em>Fusobacterium necrophorum</em> (Lemierre&rsquo;s disease)</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 64-year-old man was admitted to the emergency department after being found unconscious due to alcohol intoxication. On physical examination, his dental hygiene was poor. Chest auscultation revealed fixed amphoric breath sounds over the right hemithorax. Which of the following lung lobes is most likely to be affected?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior upper lobe"
      },
      {
        "id": 2,
        "text": "Anterior upper lobe"
      },
      {
        "id": 3,
        "text": "Apical upper lobe"
      },
      {
        "id": 4,
        "text": "Posterior lower lobe"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario is suggestive of a primary lung abscess due to aspiration<strong>. </strong><strong>Most common</strong> lobes involved in <strong>primary lung abscess</strong> are <strong>posterior upper lobes and superior lower lobes</strong>, given the predisposition of aspirated materials to be deposited in these areas.</p>\n<p><strong>The right lung</strong> is affected <strong>more commonly</strong> than the left because the right mainstem bronchus is less angulated.</p>\n<p>In secondary abscesses, the location of the abscess may vary with the underlying cause.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man presents with persistent fever and productive cough for 6 weeks with night sweats and anemia. The following is his CXR. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Carcinoma Lung"
      },
      {
        "id": 2,
        "text": "Tuberculosis"
      },
      {
        "id": 3,
        "text": "Emphysematous bullae"
      },
      {
        "id": 4,
        "text": "Lung abscess"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario described along with the&nbsp;chest X-ray image showing<strong> air-fluid level</strong> is suggestive of a<strong>&nbsp;lung abscess</strong>.</p>\n<p>The patients usually present with complaints of fever, cough with sputum production, and chest pain. Patients with putrid lung abscesses may report foul-smelling sputum. Patients with chronic lung abscesses usually have a history of <strong>night sweats, fatigue, and anemia.</strong></p>\n<p><strong>On physical examination</strong>:</p>\n<ul>\n<li>Poor dentition/gingival disease</li>\n<li>Amphoric and/or cavernous breath sounds on lung auscultation</li>\n<li>Digital clubbing</li>\n<li>The absence of a gag reflex</li>\n</ul>\n<p><strong>CXR features of lung abscess:</strong></p>\n<ul>\n<li>A lung cavity with an air-fluid level</li>\n<li>The cavity wall is thick and irregular, and a surrounding pulmonary-infiltrate is often present</li>\n<li>Computed tomography (CT) is more sensitive than chest radiography and is used to detect small cavities</li>\n</ul>\n<p>The two x-ray images given below show thick-walled cavities with air-fluid levels on lateral and PA views respectively.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8329674ec81149899d5fd8072810c0dc.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f43b3bae31474f25a8d16af8e5e76e2ex624x1150.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/032da72a34064443be803fb65cb6905ax1280x960.PNG"
    ]
  },
  {
    "text": "A 60-year-old male patient presented with 2 weeks of productive cough, fever, and shortness of breath. A chest radiogram was done as shown below. Which of the following is the most appropriate therapy for him?",
    "choices": [
      {
        "id": 1,
        "text": "Cephalexin"
      },
      {
        "id": 2,
        "text": "Ciprofloxacin"
      },
      {
        "id": 3,
        "text": "Clindamycin"
      },
      {
        "id": 4,
        "text": "Vancomycin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the above clinical scenario, the patient most likely has a <strong>lung abscess </strong>as depicted by the radiograph<strong>. Clindamycin </strong>is the <strong>drug of choice</strong> in the treatment of lung abscesses.</p>\n<p>When there are contraindications to clindamycin, a combination of <strong>penicillin and metronidazole</strong> is likely to be as <strong>effective</strong> as clindamycin.</p>\n<p>Anaerobes of oral origin are the most common causative organism and require broad-spectrum antibiotic coverage.&nbsp;Vancomycin, ciprofloxacin, and cephalexin have no significant activity against anaerobes.</p>\n<p>Below is a chest X-ray showing a lung abscess (yellow dotted circle) with an air-fluid level (arrow).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/cefa96e10afc4421928f61cee7ffb1a1.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f5a87f32c10c49f08fae8321ce628a8fx1280x1172.JPEG"
    ]
  },
  {
    "text": "A patient with fever, productive cough, night sweats, and clubbing is diagnosed with lung abscess. Which of the following is an unlikely complication of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Bronchiectasis"
      },
      {
        "id": 2,
        "text": "Brain abscess"
      },
      {
        "id": 3,
        "text": "Lung carcinoma"
      },
      {
        "id": 4,
        "text": "Hemoptysis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Lung carcinoma is unlikely in patients with lung abscesses. Lung carcinoma may cause lung abscess (in 10-15% of cases) but lung abscess is not a premalignant condition.</p>\n<p><strong>Complications of lung abscess:</strong></p>\n<ul>\n<li>Empyema</li>\n<li>Pneumatocele</li>\n<li>Bronchopleural fistula</li>\n<li>Bronchiectasis</li>\n<li>Metastatic infections like brain abscess</li>\n<li>Life-threatening hemoptysis</li>\n<li>Massive aspiration of lung abscess contents</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common presentation of inhalational anthrax?",
    "choices": [
      {
        "id": 1,
        "text": "Atypical pneumonia"
      },
      {
        "id": 2,
        "text": "Hemorrhagic mediastinitis"
      },
      {
        "id": 3,
        "text": "Lung abscess"
      },
      {
        "id": 4,
        "text": "Broncho pulmonary pneumonia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most common presentation of inhalation anthrax is <strong>hemorrhagic mediastinitis</strong>, which is seen in 38% of the patients.</p>\n<p><strong>Inhalational anthrax</strong> also known as <strong>wool sorter&rsquo;s disease</strong> is caused by <strong><em>Bacillus anthracis</em></strong>. Infection usually occurs among workers handling contaminated animal wool, hair, and skin in textile and tanning industries.</p>\n<p>Patients present with malaise, fever, cough, shortness of breath &amp; headache. <em>B. anthracis</em> spores are phagocytosed by alveolar macrophages and transported to mediastinal lymph nodes. <strong>Hemorrhagic necrosis</strong> of the <strong>thoracic lymph nodes</strong> draining the lung results in <strong>hemorrhagic mediastinitis</strong>. <strong>Pulmonary infiltrates</strong>, <strong>mediastinal widening</strong>, and <strong>pleural effusion</strong> are other findings.</p>\n<p>Treatment of inhalation anthrax includes a combination of <strong>intravenous ciprofloxacin and clindamycin</strong> for at least <strong>14 days</strong>, <strong>antitoxins</strong> (Raxibacumab, Obiltoxaximab), <strong>anthrax immunoglobulins</strong> and <strong>steroids</strong> (if associated meningitis is present).</p>\n<p><strong>Prophylaxis</strong> with <strong>ciprofloxacin</strong> (500mg twice daily for 2 months) is recommended for anyone at high risk of inhalational exposure to anthrax spores.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a common feature of allergic bronchopulmonary aspergillosis?",
    "choices": [
      {
        "id": 1,
        "text": "Distal bronchiectasis"
      },
      {
        "id": 2,
        "text": "Cough"
      },
      {
        "id": 3,
        "text": "Wheezing"
      },
      {
        "id": 4,
        "text": "Raised serum IgE levels"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Central bronchiectasis</strong> is a typical feature of <strong>allergic bronchopulmonary aspergillosis</strong> (ABPA), <strong>not distal bronchiectasis</strong>.&nbsp;</p>\n<p>ABPA is an <strong>eosinophilic pulmonary disorder</strong> caused by a <strong>hypersensitivity</strong> reaction to the <strong>colonization</strong> of airways by the fungus<strong> <em>Aspergillus fumigatus</em></strong>. It occurs almost exclusively in patients with <strong>asthma</strong> (~2.5% of patients) or <strong>cystic fibrosis</strong> (up to 15%). In chronic cases, repeated episodes of bronchial obstruction, inflammation, and mucoid impaction can lead to bronchiectasis, fibrosis, and respiratory compromise. While <strong>central bronchiectasis</strong> is characteristic, some patients can develop <strong>chronic cavitary lesions</strong>.</p>\n<p>With the development of ABPA, asthma or cystic fibrosis typically worsens and may manifest with a new or worsening cough or an increase in sputum production or wheezing. Many patients report coughing up thick sputum casts. The presence of <strong>hyperattenuating mucus</strong> in the airways is <strong>highly specific</strong>.</p>\n<p>ABPA is diagnosed serologically, based on the presence of:<br /><strong>Serum IgE &gt; 1000 IU/ml</strong><br />Positive skin prick test or IgE levels against <em>A. fumigatus</em> extract<br />Detection of Aspergillus-specific antibodies<br /><strong>Eosinophilia &gt;500 cells/&mu;L</strong></p>\n<p>Treatment - The use of <strong>systemic glucocorticoids</strong> is indicated for ABPA, but the course should be <strong>tapered by 3-6 months</strong>. <strong>Antifungal agents</strong> like itraconazole, voriconazole, and newer azoles can be used for over 4 months to control disease activity. <strong>Monoclonal antibodies</strong> against IgE, IL-4, and IL-5 receptors can be used for <strong>severe refractory cases</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following tests is not used to diagnose a patient with suspected allergic bronchopulmonary aspergillosis?",
    "choices": [
      {
        "id": 1,
        "text": "Peripheral eosinophilia"
      },
      {
        "id": 2,
        "text": "Serum IgE > 1000 IU/ml"
      },
      {
        "id": 3,
        "text": "Positive skin prick test"
      },
      {
        "id": 4,
        "text": "Culture of Aspergillus fumigatus from sputum"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The culture of <em>Aspergillus fumigatus</em> from sputum is not a diagnostic criterion for allergic bronchopulmonary aspergillosis (ABPA).&nbsp;The sensitivity of sputum culture in ABPA is low.</p>\n<p><strong>ABPA</strong> is <strong>diagnosed serologically,</strong> based on the presence of:</p>\n<ul>\n<li>Serum IgE &gt; 1000 IU/ml.</li>\n<li>Positive skin prick test or IgE levels against <em>A. fumigatus</em> extract.</li>\n<li>Detection of Aspergillus-specific antibodies.</li>\n<li>Eosinophilia &gt;500 cells/&mu;L.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with acute myeloid leukemia underwent induction therapy. Within the next few days, he developed a cough and fever. On evaluation, HRCT showed a halo sign. Eventually, the patient deteriorated and died due to respiratory compromise. On autopsy, lung histopathology showed infarction and invasion of blood vessels by Aspergillus hyphae. Which of the following is not true about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Fungal hyphae are broad and aseptate"
      },
      {
        "id": 2,
        "text": "Yeast forms are not seen in infected tissue"
      },
      {
        "id": 3,
        "text": "Most of the patients are asymptomatic"
      },
      {
        "id": 4,
        "text": "Exposure to hay barns is a risk factor."
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario is suggestive of <strong>aspergillosis.</strong> Fungal hyphae of <em>Aspergillus</em> species are <strong>narrow, septate,</strong> and have <strong>branching at 45<sup>o</sup></strong>.&nbsp;</p>\n<p>Yeast forms of <em>Aspergillus</em> are not seen in infected tissue.</p>\n<p>Exposure to the high number of conidia that are found in <strong>construction sites, hay barns, moldy barks, and composts</strong> is a risk factor.</p>\n<p><strong>Clinical features:&nbsp;</strong></p>\n<ul>\n<li>Most of the patients are asymptomatic</li>\n<li>Fever</li>\n<li>Cough</li>\n<li>Chest discomfort</li>\n<li>Trivial hemoptysis</li>\n<li>Shortness of breath</li>\n</ul>\n<p><strong>Halo sign</strong>-on HRCT refers to a localized ground glass appearance representing an area of hemorrhagic infarction surrounding a nodule. It is seen in <strong>invasive aspergillosis,</strong> a distinct entity where there is a direct invasion of hyphae into the lung tissue.</p>\n<p>The<strong> air crescent sign</strong>&nbsp;describes the crescent of air that can be seen in invasive aspergillosis.&nbsp;It usually heralds <strong>recovery</strong> and is the result of increased granulocyte activity.</p>\n<p><strong>Monod sign</strong>&nbsp;refers to the gas that surrounds a mycetoma (most commonly an aspergilloma) in a pre-existing pulmonary cavity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '045 Bronchiectasis And Lung Abscess';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>