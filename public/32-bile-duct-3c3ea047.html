<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>32 Bile Duct - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">14</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A 35-year-old man presented with recurrent episodes of fever with chills. MRCP image is shown below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Primary sclerosing cholangitis"
      },
      {
        "id": 2,
        "text": "Caroli disease"
      },
      {
        "id": 3,
        "text": "Oriental cholangitis"
      },
      {
        "id": 4,
        "text": "Primary biliary carcinoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The common age group of primary sclerosing cholangitis is <strong>30-45 years</strong>. <strong>Men</strong> are affected twice as commonly as women. Two-thirds of these cases are associated with <strong>ulcerative colitis.&nbsp;</strong>It is also associated with <strong>Riedel&rsquo;s&nbsp;thyroiditis</strong> and<strong> retroperitoneal fibrosis.</strong>&nbsp;10&ndash;20% of patients develop <strong>cholangiocarcinoma. </strong></p>\n<p>Clinical features of a patient with PSC include pruritis, fever, chills, right upper quadrant discomfort, jaundice, and weight loss.&nbsp;</p>\n<p>Liver function tests show a cholestatic pattern with an <strong>elevation of ALP </strong>and <strong>GGT</strong> and smaller rises in the aminotransferases. Bilirubin values may be variable.</p>\n<p>Liver biopsy <strong>excludes</strong> other causes of cholestatic liver disease and defines the <strong>stage</strong> of PSC. It shows <strong>onion skin concentric periductal fibrosis</strong>. With disease progression, periportal fibrosis occurs, progressing to bridging necrosis, and eventually biliary cirrhosis.</p>\n<p>Currently, there is <strong>no known effective medical therapy.</strong>&nbsp;Surgical management involving&nbsp;<strong>resection of extrahepatic biliary tree </strong>and<strong> hepaticojejunostomy</strong>&nbsp;has shown reasonable effects. For patients with&nbsp;advanced liver disease, <strong>liver transplantation </strong>is the&nbsp;only available option.</p>\n<p>Other options:&nbsp;</p>\n<p>Option C: Oriental cholangitis, also known as<strong> recurrent pyogenic cholangitis</strong> is characterized by recurrent attacks of cholangitis due to bile stasis and stone formation. Patients between <strong>30-40 years</strong> and<strong> both sexes</strong> are equally affected. It is caused due to infections (liver flukes, E.coli, Klebsiella, Pseudomonas, and Proteus). Patients present with Charcot's triad (intermittent fever, pain, and jaundice). <strong>MRCP</strong> shows intra or extrahepatic <strong>calculi,</strong> dilatation of ducts, and strictures.&nbsp;</p>\n<p>Option D: Biliary carcinoma&nbsp; (cholangiocarcinoma) most commonly affects patients <strong>&gt;60 years</strong> and presents with fever, abdominal pain, weight loss, and features of obstructive jaundice. <strong>MRCP</strong> shows irregular <strong>narrowing</strong> of the bile duct involved by the <strong>tumor,</strong> with asymmetric upstream dilatation of the intrahepatic ducts.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/08dbd37ac2644dddbce5f384204f9914.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/615f6ae3c19f4f27a8acdddfd78aa2f3x315x307.JPEG"
    ]
  },
  {
    "text": "According to Strasberg\u2019s classification of bile duct injuries, injury to the right aberrant posterior sectoral duct with bile leak is:",
    "choices": [
      {
        "id": 1,
        "text": "Type A"
      },
      {
        "id": 2,
        "text": "Type B"
      },
      {
        "id": 3,
        "text": "Type C"
      },
      {
        "id": 4,
        "text": "Type D"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Management of bile duct injuries is shown below:&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cd7f3f35c9bd40019cf4dca22baa3ff8x1280x3846.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/01e363fe8e3344b78c45d8a2148d4b3cx1280x2262.JPEG"
    ]
  },
  {
    "text": "A patient presents with pain in the right upper quadrant on the second postoperative day following a cholecystectomy. Evaluation reveals a collection in the subhepatic space. A bile leak was suspected. Which of the following is the best investigation for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "MRCP"
      },
      {
        "id": 2,
        "text": "ERCP"
      },
      {
        "id": 3,
        "text": "HIDA"
      },
      {
        "id": 4,
        "text": "CECT"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\"><strong>Endoscopic retrograde cholangiopancreatography (ERCP)</strong> is the best investigation in a patient suspected of <strong>post-cholecystectomy biliary leaks</strong>.</p>\n<p class=\"p1\">Patients with post-cholecystectomy biliary leak usually present with fever, jaundice and abdominal pain<strong>.\u00a0</strong>\u00a0<strong>USG</strong>\u00a0is used for an\u00a0<strong>initial evaluation</strong> in such cases and can show a collection in the sub-hepatic space.\u00a0</p>\n<p class=\"p1\">The most common bile leak following cholecystectomy is from the\u00a0<strong>cystic duct.</strong>\u00a0This can be treated by placing a\u00a0<strong>biliary endoprosthesis\u00a0</strong>(stent) in the common bile duct across the origin of the cystic duct.</p>\n<p class=\"p1\">MRCP shows fluid collections arising from bile leaks but cannot differentiate these from other causes of fluid collections.</p>\n<p class=\"p1\"><strong>ERCP</strong>\u00a0is the <strong>best investigation</strong> as it has the advantage of being\u00a0both<strong>\u00a0diagnostic</strong>\u00a0and<strong> therapeutic.\u00a0</strong>\u00a0ERCP is useful post-cholecystectomy as there is a high likelihood of a retained stone and stone extraction and/or temporary stenting may be required.\u00a0</p>\n<p class=\"p1\"><strong>HIDA scan</strong> is the <strong>most sensitive</strong> investigation for biliary leakage.</p>\n<p class=\"p1\"><strong>CT</strong> scan can show focal fluid collections, ascites, biliary obstruction, hepatic atrophy, signs of secondary biliary cirrhosis and any vascular injury.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/370e42f1a826464e8e2b9a4616687662x1280x2262.JPEG"
    ]
  },
  {
    "text": "A patient underwent laparoscopic cholecystectomy and was discharged after removing the drain tube on the first postoperative day. On day three, the patient came back to the hospital and was febrile. On ultrasound examination, there was a 5 x 5 cm collection in the subhepatic space. What is the next best step?",
    "choices": [
      {
        "id": 1,
        "text": "To give oral antibiotics since the given accumulation is normal"
      },
      {
        "id": 2,
        "text": "To re-explore the wound and insert a T-tube"
      },
      {
        "id": 3,
        "text": "Insert pigtail catheter for drainage"
      },
      {
        "id": 4,
        "text": "ERCP and stenting"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical situation suggests&nbsp;a<strong> bile duct injury</strong> following laparoscopic cholecystectomy. The <strong>next best step</strong> after imaging would be to control inflammation by <strong>drainage </strong>of fluid collections by&nbsp;<strong>pigtail insertion&nbsp;</strong>and administration of broad-spectrum <strong>IV antibiotics</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4b054ae0f1fd4a04baa35c8686c0c01ax1280x2262.JPEG"
    ]
  },
  {
    "text": "Five days following a common bile duct injury resulting in a leak, a patient presents with fever and abdominal pain. What would be the next step in management?",
    "choices": [
      {
        "id": 1,
        "text": "Ultrasound-guided aspiration"
      },
      {
        "id": 2,
        "text": "Endoscopic retrograde cholangiopancreatography (ERCP) and stenting"
      },
      {
        "id": 3,
        "text": "Re-exploration and hepatojejunostomy"
      },
      {
        "id": 4,
        "text": "Re-exploration and primary repair"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the case of a <strong>common bile duct injury</strong> with a leak and a patient presenting with signs of localized peritonitis, the next step of management is an<strong> ultrasound-guided aspiration. </strong>This will be<strong>&nbsp;</strong>followed by <strong>ERCP and stenting.</strong></p>\n<p><strong>Laparoscopic cholecystectomy</strong> is the most common cause of <strong>bile duct injury</strong>. Major biliary leakage is usually seen 2 to 10 days after cholecystectomy. Affected patients typically present with:</p>\n<ul>\n<li>Fever</li>\n<li>Abdominal pain</li>\n<li>Bilious ascites</li>\n<li>Mild jaundice</li>\n<li>Leukocytosis</li>\n<li>Elevations in the serum levels of ALP and GGT.</li>\n</ul>\n<p>Management of bile duct injury:</p>\n<p>If the&nbsp;injury is identified <strong>during surgery:</strong></p>\n<ul>\n<li>Partial injury to the bile duct (&lt;3mm) - <strong>repair</strong> the injury</li>\n<li>Complete transection without loss of segment - <strong>anastomose over T-tube</strong></li>\n<li>Complete transection with loss of segment - close distal end and carry out <strong>Roux-en-Y hepaticoduodenostomy/jejunostomy</strong></li>\n</ul>\n<p>If the leak is suspected<strong> postoperatively:</strong></p>\n<p><strong>Transabdominal ultrasonography</strong> is initially performed to assess the leak.&nbsp;</p>\n<ul>\n<li>If the patient presents <strong>within 48 hours</strong> - <strong>Re-explore</strong> and repair</li>\n<li>If the patient presents <strong>after 48 hours</strong> - <strong>USG-guided aspiration </strong>or<strong> pigtail catheter </strong>insertion.</li>\n</ul>\n<p>This is followed by<strong> ERCP&nbsp;</strong>and<strong> stenting.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/15d8a67b4bd34ed5a0a335da8be86b4fx1280x2262.JPEG"
    ]
  },
  {
    "text": "Where does biliary stricture most commonly occur after laparoscopic cholecystectomy?",
    "choices": [
      {
        "id": 1,
        "text": "Common hepatic duct"
      },
      {
        "id": 2,
        "text": "Common bile duct"
      },
      {
        "id": 3,
        "text": "Right hepatic duct"
      },
      {
        "id": 4,
        "text": "Left hepatic duct"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Biliary stricture</strong>&nbsp;after <strong>laparoscopic cholecystectomy</strong> usually occurs in the <strong>common&nbsp;hepatic duct</strong>,&nbsp;distal to the confluence of the right and left&nbsp;hepatic ducts.</p>\n<p>After <strong>open cholecystectomy</strong>, biliary strictures are more common in the <strong>common bile duct</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false about hemobilia?",
    "choices": [
      {
        "id": 1,
        "text": "It is associated with Quincke's triad"
      },
      {
        "id": 2,
        "text": "Tumors are the most common cause of bleeding"
      },
      {
        "id": 3,
        "text": "Treatment involves trans-arterial embolization"
      },
      {
        "id": 4,
        "text": "Arterial angiography is the diagnostic procedure of choice"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most common cause of hemobilia is<strong> iatrogenic trauma.</strong></p>\n<div class=\"page\" title=\"Page 1498\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Hemobilia</strong> is defined as <strong>bleeding into the biliary tree</strong> from abnormal communication between a blood vessel and bile duct.</p>\n</div>\n</div>\n</div>\n</div>\n<p>Causes of hemobilia include:</p>\n<ul>\n<li>Traumatic or operative injury to the liver or bile ducts</li>\n<li>Intraductal rupture of a hepatic abscess or aneur&gamma;sm of the hepatic artery</li>\n<li>Biliary or hepatic tumor hemorrhage</li>\n<li>Mechanical complications of choledocholithiasis or hepatobiliary parasitism</li>\n<li>Diagnostic procedures, such as liver biopsy, percutaneous transhepatic cholangiography (PTC), and transhepatic biliary drainage catheter placement</li>\n<li>Vascular disorders</li>\n</ul>\n<p>Patients often present with a classic triad <strong>(Quincke's triad/Sandblom triad<em>)</em></strong> of:</p>\n<ul>\n<li>Biliary pain</li>\n<li>Obstructive jaundice</li>\n<li>Melena or occult blood in the stools</li>\n</ul>\n<p>Investigation of choice:<strong> Arterial angiography (CT angiography)</strong> is the diagnostic procedure of choice.</p>\n<div class=\"page\" title=\"Page 1498\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Management:<strong>&nbsp;</strong></p>\n<p><strong> Minor hemobilia</strong> can be managed <strong>conservatively</strong>.</p>\n<p><strong>Major hemobilia: Transarterial embolization</strong> is indicated for <strong>major hemobilia</strong> requiring blood transfusion. Ligation of the bleeding vessel may also be required.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "How will you confirm the diagnosis in a patient suspected to have bilhemia?",
    "choices": [
      {
        "id": 1,
        "text": "CT angiography"
      },
      {
        "id": 2,
        "text": "Endoscopic retrograde cholangiopancreatography"
      },
      {
        "id": 3,
        "text": "Endoscopic ultrasonography"
      },
      {
        "id": 4,
        "text": "Magnetic resonance cholangiopancreatography"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Endoscopic retrograde cholangiopancreatography (ERCP)</strong> is the best investigation for the diagnosis of <strong>bilhemia</strong>.</p>\n<p>Bilhemia is a condition in which <strong>bile flows into the bloodstream</strong> through the hepatic veins or portal vein branches. This flow occurs due to a <strong>high intrabiliary pressure</strong>, exceeding that of the venous system.</p>\n<p>The cause can be the&nbsp;<strong>erosion of&nbsp;gallstones</strong>&nbsp;into the portal vein, or accidental/iatrogenic <strong>trauma</strong>. This condition can be fatal secondary to the embolization of large amounts of bile into the lungs. Usually, bile flow is low, and the <strong>fistulas close spontaneously.</strong></p>\n<p>Its clinical features include:</p>\n<ul>\n<li>Rapidly progressive jaundice</li>\n<li>Marked direct hyperbilirubinemia, without elevation of the hepatocellular enzyme levels.</li>\n<li>Septicemia.</li>\n</ul>\n<p>Diagnosis of bilhemia is best made by <strong>ERCP</strong>.</p>\n<p>Treatment is directed at reducing the&nbsp;intrabiliary pressure through <strong>stent placement</strong> or <strong>sphincterotomy</strong>. Endovascular <strong>embolization</strong> can also be done.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Cholangiohepatitis is associated with which of the following parasites?",
    "choices": [
      {
        "id": 1,
        "text": "1, 3, and 5"
      },
      {
        "id": 2,
        "text": "1, 2, and 3"
      },
      {
        "id": 3,
        "text": "2 , 3, and 4"
      },
      {
        "id": 4,
        "text": "1, 2, and 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Cholangiohepatitis</strong> or recurrent pyogenic cholangitis&nbsp;is associated with biliary parasites such as:</p>\n<ul>\n<li>Clonorchis sinensis</li>\n<li>Opisthorchis viverrini</li>\n<li>Ascaris lumbricoides.</li>\n</ul>\n<p>It&nbsp;is&nbsp;caused by bacterial contamination of the biliary tree. Some commonly implicated organisms are&nbsp;<em>Escherichia coli</em>, Klebsiella species, Bacteroides species, or <em>Enterococcus faecalis</em>.</p>\n<p>Cholangiohepatitis is a <strong>pre-malignant</strong> condition and can result in <strong>cholangiocarcinoma</strong>.</p>\n<p><strong>Schistosoma haematobium</strong> primarily causes<strong>&nbsp;genito-urinary schistosomiasis.&nbsp;</strong></p>\n<p><strong>Paragonimus&nbsp;westermani</strong>&nbsp;(oriental lung fluke) causes a <strong>pulmonary syndrome</strong> characterized by cough, chest pain, and hemoptysis.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old man presented with complaints of weight loss, clay coloured stools, and abdominal pain. CT scan and MRCP was suggestive of cholangiocarcinoma. What is the most common site at which this occurs?",
    "choices": [
      {
        "id": 1,
        "text": "Distal third of the common bile duct"
      },
      {
        "id": 2,
        "text": "Middle third of the common bile duct"
      },
      {
        "id": 3,
        "text": "Confluence of the right and left hepatic ducts"
      },
      {
        "id": 4,
        "text": "Right hepatic duct"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><span data-preserver-spaces=\"true\">The FDA approved <strong>Pemigatinib, FGFR2 inhibitor</strong> for patients with cholangiocarcinoma that is locally advanced or metastatic, and tumors with fusion or rearrangement of fibroblast growth factor receptor 2 (FGFR2) gene.</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8a8d769abcc94f6c9d33c5449ced873ax1280x5341.JPEG"
    ]
  },
  {
    "text": "Match the following triads:",
    "choices": [
      {
        "id": 1,
        "text": "1-a, 2-c, 3-b, 4-d"
      },
      {
        "id": 2,
        "text": "1-b, 2-a, 3-d, 4-c"
      },
      {
        "id": 3,
        "text": "1-c, 2-a, 3-d, 4-b"
      },
      {
        "id": 4,
        "text": "1-c, 2-d, 3-a, 4-b"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The correct option is 1-c, 2-a, 3-d, 4-b.</p>\n<table style=\"height: 346px; width: 470px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 126.390625px; text-align: center; height: 18px;\"><strong>Triad</strong></td>\n<td style=\"width: 124.578125px; text-align: center; height: 18px;\"><strong>Condition</strong></td>\n<td style=\"width: 197.0625px; text-align: center; height: 18px;\"><strong>Components</strong></td>\n</tr>\n<tr style=\"height: 82px;\">\n<td style=\"width: 126.390625px; height: 82px;\">Saint's triad</td>\n<td style=\"width: 124.578125px; height: 82px;\">&nbsp;</td>\n<td style=\"width: 197.0625px; height: 82px;\">\n<ul>\n<li>Hiatus hernia</li>\n<li>Gallstones</li>\n<li>Colonic diverticulosis</li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 82px;\">\n<td style=\"width: 126.390625px; height: 82px;\">Sandblom triad</td>\n<td style=\"width: 124.578125px; height: 82px;\">Hemobilia</td>\n<td style=\"width: 197.0625px; height: 82px;\">\n<ul>\n<li>Malena</li>\n<li>Biliary colic</li>\n<li>Obstructive jaundice</li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 73px;\">\n<td style=\"width: 126.390625px; height: 73px;\">Charcot triad</td>\n<td style=\"width: 124.578125px; height: 73px;\">Acute cholangitis</td>\n<td style=\"width: 197.0625px; height: 73px;\">\n<ul>\n<li>Jaundice</li>\n<li>Fever</li>\n<li>Right upper quadrant pain</li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 100px;\">\n<td style=\"width: 126.390625px; height: 100px;\">Rigler's triad</td>\n<td style=\"width: 124.578125px; height: 100px;\">Gallstone ileus</td>\n<td style=\"width: 197.0625px; height: 100px;\">\n<ul>\n<li>Small bowel obstruction</li>\n<li>Pneumobilia</li>\n<li>Ectopic gallstone</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 19-year-old patient presented with right upper quadrant pain. USG and CT scans showed no evidence of gallstones. MRCP shows fusiform dilatation of the common bile duct. Identify the false statement regarding this condition.",
    "choices": [
      {
        "id": 1,
        "text": "It predisposes to malignancy"
      },
      {
        "id": 2,
        "text": "Roux-en-Y hepaticojejunostomy will be done"
      },
      {
        "id": 3,
        "text": "Seen more commonly in males"
      },
      {
        "id": 4,
        "text": "Jaundice will be the most consistent finding"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario and MRCP showing fusiform dilation of extrahepatic biliary tree point towards the diagnosis of a <strong>choledochal cyst (Type I)</strong>. Choledochal cysts are more <strong>commonly seen in females</strong>.&nbsp;</p>\n<p>A choledochal cyst is a <strong>premalignant </strong>condition leading to the development of cholangiocarcinoma<strong>.&nbsp;</strong></p>\n<p>The classic clinical triad of symptoms includes <strong>abdominal pain</strong>, <strong>jaundice</strong> (most consistent finding), and a&nbsp;<strong>mass</strong> in the abdomen.</p>\n<p>Diagnosis of choledochal cyst can be made by:</p>\n<ul>\n<li>USG (Initial investigation)</li>\n<li>MRCP (Investigation of choice)</li>\n<li>ERCP (Gold standard investigation)</li>\n<li>Endoscopic ultrasound (Most sensitive)</li>\n</ul>\n<p>Management includes <strong>effective drainage</strong> and <strong>removal of abnormal mucosa</strong> to reduce the risk of malignancy.</p>\n<table style=\"height: 254px;\" width=\"353\">\n<tbody>\n<tr>\n<td style=\"width: 168.5px;\"><strong>Type of choledochal cyst</strong></td>\n<td style=\"width: 168.5px;\"><strong>Surgical management</strong></td>\n</tr>\n<tr>\n<td style=\"width: 168.5px;\">Type I</td>\n<td style=\"width: 168.5px;\">Roux-en-Y hepaticojejunostomy</td>\n</tr>\n<tr>\n<td style=\"width: 168.5px;\">Type II</td>\n<td style=\"width: 168.5px;\">Diverticulectomy + common bile duct repair</td>\n</tr>\n<tr>\n<td style=\"width: 168.5px;\">Type III</td>\n<td style=\"width: 168.5px;\">ERCP + sphincterotomy (Only cyst in which reconstruction is not required)</td>\n</tr>\n<tr>\n<td style=\"width: 168.5px;\">Type IVa and Type V</td>\n<td style=\"width: 168.5px;\">Liver transplant</td>\n</tr>\n<tr>\n<td style=\"width: 168.5px;\">Type IVb</td>\n<td style=\"width: 168.5px;\">Kasai procedure (portoenterostomy)</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common type of choledochal cyst?",
    "choices": [
      {
        "id": 1,
        "text": "Type I"
      },
      {
        "id": 2,
        "text": "Type II"
      },
      {
        "id": 3,
        "text": "Type III"
      },
      {
        "id": 4,
        "text": "Type IV"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Type I</strong> is the most common type of choledochal cyst (75%).</p>\n<p><strong>Choledochal cysts</strong> are <strong>congenital dilations</strong> of the intra- and/or extra-hepatic biliary system.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following conditions will you perform the Kasai procedure?",
    "choices": [
      {
        "id": 1,
        "text": "Extrahepatic biliary atresia"
      },
      {
        "id": 2,
        "text": "Type 1 choledochal cyst"
      },
      {
        "id": 3,
        "text": "Caroli disease"
      },
      {
        "id": 4,
        "text": "Cholangiocarcinoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Kasai procedure</strong> (<strong>Roux-en-Y hepatoportoenterostomy</strong>) is done for <strong>extrahepatic biliary atresia.</strong>&nbsp;In the Kasai procedure, the occluded extrahepatic bile ducts are excised and a jejunal Roux loop is anastomosed to the hepatic hilum.</p>\n<p>Extrahepatic biliary atresia&nbsp;(EHBA) is defined as a partial or total <strong>absence </strong>of permeable<strong> bile duct </strong>between porta hepatis and the duodenum. It is due to <strong>inflammatory fibrosis</strong> of the biliary tree.&nbsp;It leads to obstruction to bile flow thereby causing leaking of <strong>conjugated bilirubin</strong> into the circulation.</p>\n<p>Associated anomalies include cardiac lesions, <strong>polysplenia</strong>, <strong>situs inversus</strong>, <strong>absent vena cava</strong>, and a preduodenal portal vein.</p>\n<p><strong>HIDA scan</strong>&nbsp;is the <strong>investigation of choice</strong> for EHBA. <strong>Intraoperative cholangiogram</strong> is the&nbsp;<strong>gold standard</strong> for diagnosis.</p>\n<table style=\"height: 261px; width: 496.6875px;\">\n<tbody>\n<tr style=\"height: 29.7656px;\">\n<td style=\"width: 754.6875px; text-align: center; height: 29.7656px;\" colspan=\"3\"><strong>Management of extrahepatic biliary atresia</strong></td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 104px; height: 54px;\">Type I</td>\n<td style=\"width: 295px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia restricted to the common bile duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n<td style=\"width: 355.6875px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Roux-en-Y hepaticojejunostomy</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 104px; height: 54px;\">Type II</td>\n<td style=\"width: 295px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia of the common hepatic duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n<td style=\"width: 355.6875px; height: 54px;\" rowspan=\"2\"><strong>Kasai procedure</strong> (Roux-en-Y hepatoportoenterostomy)</td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 104px; height: 54px;\">Type III</td>\n<td style=\"width: 295px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia of the right and left hepatic duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Infants</strong> with biliary atresia, who do not achieve successful drainage after Kasai's procedure, require<strong> liver transplantation</strong> within the first year of life. It is the most common reason for liver transplantation in children.</p>\n<p>Kasai procedure:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5a5dea0598624632a466b5cbb4eda70cx720x866.PNG"
    ]
  }
];
        let quizName = '32 Bile Duct';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>