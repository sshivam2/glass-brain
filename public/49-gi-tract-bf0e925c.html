<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>49 Gi Tract - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Anatomy
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">17</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following arteries does not contribute to the blood supply of the stomach?",
    "choices": [
      {
        "id": 1,
        "text": "Common hepatic artery"
      },
      {
        "id": 2,
        "text": "Splenic artery"
      },
      {
        "id": 3,
        "text": "Gastroduodenal artery"
      },
      {
        "id": 4,
        "text": "Inferior pancreaticoduodenal artery"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Clinical note:&nbsp;The presence of an <strong>abnormal, tortuous artery</strong> in the <strong>submucosa</strong> of the <strong>lesser curvature</strong> is called the <strong>Dieulafoy's lesion.</strong>&nbsp;As it is superficial, it is more vulnerable to rupture causing significant <strong>haemorrhage</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1a1bafeb2dd741d89864a110de70892ex1280x1342.JPEG"
    ]
  },
  {
    "text": "Ligation of common hepatic artery will impair blood supply in:",
    "choices": [
      {
        "id": 1,
        "text": "Right  gastric and right gastroepiploic artery"
      },
      {
        "id": 2,
        "text": "Right gastric and left gastric artery"
      },
      {
        "id": 3,
        "text": "Right gastroepiploic and short gastric vessels"
      },
      {
        "id": 4,
        "text": "Right gastric and short gastric vessels"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Ligation of the <strong>common hepatic artery</strong> will cause impairment in the blood supply through its <strong>branches</strong> i.e <strong>r</strong><strong>ight</strong> <strong>gastric</strong> artery and <strong>right gastroepiploic </strong>artery.</p>\n<p>Blood supply of the stomach:</p>\n<p>The arterial supply of the stomach is contributed exclusively by the <strong>branches</strong> of the&nbsp;<strong>celiac trunk. </strong>They are:</p>\n<ul>\n<li><strong>Left gastric artery&nbsp;</strong>- Supplies the lesser curvature of the stomach</li>\n<li><strong>Splenic artery-&nbsp;</strong>This further divides into:\n<ul>\n<li>Short gastric arteries-&nbsp;Supplies the fundus of the stomach</li>\n<li>Left gastroepiploic artery- Supplies the greater curvature of the stomach</li>\n</ul>\n</li>\n<li><strong>Common hepatic artery,&nbsp;</strong>which gives the following branches\n<ul>\n<li>Right gastric artery- Supplies the lesser curvature of the stomach</li>\n<li>Gastroduodenal artery- Right gastroepiploic artery arises from this and supplies the greater curvature of the stomach.</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ded7ec17336540f7a0214afd39c949fax1280x1342.JPEG"
    ]
  },
  {
    "text": "A patient presents with a recurrence of peptic ulcers. He had undergone vagotomy ten years ago for peptic ulcer disease. You suspect this has occurred due to the criminal nerve of Grassi being missed during the previous surgery. Which of the following gives rise to this nerve?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior vagus nerve"
      },
      {
        "id": 2,
        "text": "Anterior vagus nerve"
      },
      {
        "id": 3,
        "text": "Greater splanchnic nerve"
      },
      {
        "id": 4,
        "text": "Lesser splanchnic nerve"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The<strong> posterior vagus nerve</strong> gives rise to the <strong>criminal nerve of Grassi.</strong></p>\n<p>This nerve supplies the <strong>cardia </strong>and<strong> fundus</strong> of the stomach. It is called a&nbsp;criminal nerve<strong>&nbsp;</strong>because it is often <strong>missed during a vagotomy</strong> procedure and can result in <strong>recurrent peptic ulcer </strong>disease.</p>\n<p><strong>Nerve supply of the stomach:</strong></p>\n<p>The<strong> sympathetic supply</strong>&nbsp;arises from <strong>T5-T12 spinal segments</strong> and is distributed to the stomach via the greater and lesser splanchnic nerves and the celiac plexus. They perform the following functions:</p>\n<ul>\n<li>Vasoconstriction</li>\n<li>Constriction of the pyloric sphincter and inhibition of gastric motility</li>\n<li>Carry visceral pain sensations</li>\n</ul>\n<p>The<strong> parasympathetic supply</strong>&nbsp;arises from the right and left vagus nerves. The <strong>anterior vagal trunk</strong> is formed from the <strong>left vagus nerve</strong>, whereas the <strong>posterior vagal trunk</strong> is formed from the <strong>right vagus nerve.&nbsp;</strong>They perform the following functions:</p>\n<ul>\n<li>Secretomotor to the gastric glands</li>\n<li>Motor to the gastric musculature</li>\n<li>Relaxation of pyloric sphincter and promoting gastric emptying</li>\n<li>Carry sensations such as fullness, nausea, and probably pain.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f1d8db78aa2f44d490332e627d13b1c9x600x608.JPEG"
    ]
  },
  {
    "text": "Which of the following receives the prepyloric vein of Mayo?",
    "choices": [
      {
        "id": 1,
        "text": "Right gastroepiploic vein"
      },
      {
        "id": 2,
        "text": "Left gastroepiploic vein"
      },
      {
        "id": 3,
        "text": "Left gastric vein"
      },
      {
        "id": 4,
        "text": "Right gastric vein"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>right gastric vein</strong> receives the <strong>prepyloric vein of Mayo.</strong></p>\n<p>The prepyloric vein serves as the guidepost for the surgeons to <strong>identify</strong> the <strong>pylorus</strong> of the stomach.</p>\n<p>The common pattern of venous drainage of the stomach is as follows:</p>\n<table style=\"height: 148px; width: 471.047px;\">\n<tbody>\n<tr>\n<td style=\"width: 233px;\"><strong>Veins of the stomach</strong></td>\n<td style=\"width: 220.047px;\"><strong>Drains into</strong></td>\n</tr>\n<tr>\n<td style=\"width: 233px;\">Right gastric vein</td>\n<td style=\"width: 220.047px;\">Portal vein</td>\n</tr>\n<tr>\n<td style=\"width: 233px;\">Left gastric vein</td>\n<td style=\"width: 220.047px;\">Portal vein</td>\n</tr>\n<tr>\n<td style=\"width: 233px;\">Right gastroepiploic vein</td>\n<td style=\"width: 220.047px;\">Superior mesenteric vein</td>\n</tr>\n<tr>\n<td style=\"width: 233px;\">Left gastroepiploic vein</td>\n<td style=\"width: 220.047px;\">Splenic vein</td>\n</tr>\n<tr>\n<td style=\"width: 233px;\">Short gastric veins</td>\n<td style=\"width: 220.047px;\">Splenic vein</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/11eaa078829c423ba0e9a53ab3a22ad3x600x694.JPEG"
    ]
  },
  {
    "text": "Among the following, which is the final structure to drain lymphatics from the stomach?",
    "choices": [
      {
        "id": 1,
        "text": "Coeliac nodes"
      },
      {
        "id": 2,
        "text": "Intestinal lymph trunk"
      },
      {
        "id": 3,
        "text": "Para-aortic nodes"
      },
      {
        "id": 4,
        "text": "Lumbar lymph trunk"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Among the given options, the<strong> intestinal lymph trunk&nbsp;</strong>is the last structure to <strong>drain</strong> <strong>lymphatics</strong> from the <strong>stomach.&nbsp;</strong></p>\n<p>The intestinal lymph trunk is a major lymphatic channel in the abdomen. It <strong>receives lymphatics from</strong> the <strong>pre-aortic group</strong> of lymph nodes such as coeliac nodes, superior mesenteric nodes, and inferior mesenteric nodes. The intestinal lymph trunk finally <strong>drains into</strong> the <strong>cisterna chyli.</strong></p>\n<p>The <strong>lymphatic drainage of the stomach</strong> can be divided into <strong>four zones </strong>as shown in the image below.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c4474447f4ff4c36b8b1669da51eee48x600x545.JPEG"
    ]
  },
  {
    "text": "A 50-year-old woman presented with abdominal pain, nausea, and bilious vomiting. CT scan revealed obstruction of the third part of the duodenum by a large vessel. Which of the following blood vessels is most likely to cause the compression?",
    "choices": [
      {
        "id": 1,
        "text": "Inferior vena cava"
      },
      {
        "id": 2,
        "text": "Right gonadal vessels"
      },
      {
        "id": 3,
        "text": "Superior mesenteric artery"
      },
      {
        "id": 4,
        "text": "Abdominal aorta"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The clinical scenario is suggestive of&nbsp;superior mesenteric artery syndrome or<strong> Wilkie syndrome. </strong>In this condition, the&nbsp;third part of the <strong>duodenum</strong> is <strong>compressed by</strong> the&nbsp;<strong>superior mesenteric artery </strong>causing bowel obstruction.</p>\n<p>The mid-portion of the <strong>third part of the duodenum</strong> lies in the<strong> angle between</strong> the <strong>superior mesenteric artery&nbsp;</strong>anteriorly and the <strong>abdominal aorta</strong>&nbsp;posteriorly.</p>\n<p>Parts of the duodenum and their characteristics:</p>\n<table style=\"height: 970px; width: 848.75px;\">\n<tbody>\n<tr>\n<td style=\"width: 102px;\"><strong>Parts of the duodenum</strong></td>\n<td style=\"width: 133px;\"><strong>Extent</strong></td>\n<td style=\"width: 247px;\"><strong>Anterior relations</strong></td>\n<td style=\"width: 236.75px;\"><strong>Posterior relations</strong></td>\n</tr>\n<tr>\n<td style=\"width: 102px;\">\n<p><strong>First </strong>(5 cm)</p>\n</td>\n<td style=\"width: 133px;\">Duodenal end of pylorus to superior duodenal flexure</td>\n<td style=\"width: 247px;\">\n<p>Quadrate lobe of liver</p>\n</td>\n<td style=\"width: 236.75px;\">\n<p>Gastroduodenal artery</p>\n<p>Common bile duct</p>\n<p>Portal vein</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 102px;\"><strong>Second </strong>(8 cm)</td>\n<td style=\"width: 133px;\">Superior duodenal flexure to inferior duodenal flexure</td>\n<td style=\"width: 247px;\">\n<p>Right end of greater omentum</p>\n<p>Origin of transverse mesocolon</p>\n<p>Mesentery of upper ascending colon and hepatic flexure</p>\n</td>\n<td style=\"width: 236.75px;\">\n<p>Right psoas major</p>\n<p>Lateral edge of inferior vena cava</p>\n<p>Hilum of right kidney</p>\n<p>Right renal vessels</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 102px;\"><strong>Third </strong>(10 cm)</td>\n<td style=\"width: 133px;\">Inferior duodenal flexure to ascending portion of the fourth part of duodenum</td>\n<td style=\"width: 247px;\">\n<p>Transverse mesocolon</p>\n<p>Origin of the root of mesentery</p>\n<p>Superior mesenteric vessels</p>\n</td>\n<td style=\"width: 236.75px;\">\n<p>Right ureter</p>\n<p>Right gonadal vessels</p>\n<p>Inferior vena cava</p>\n<p>Abdominal aorta</p>\n<p>Right Psoas major</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 102px;\"><strong>Fourth </strong>(2.5 cm)</td>\n<td style=\"width: 133px;\">From the left of aorta to duodenojejunal flexure</td>\n<td style=\"width: 247px;\">\n<p>Transverse colon</p>\n<p>Transverse mesocolon</p>\n</td>\n<td style=\"width: 236.75px;\">\n<p>Left renal vessels</p>\n<p>Left gonadal vessels</p>\n<p>Abdominal aorta</p>\n<p>Left psoas major</p>\n<p>Left sympathetic trunk</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9dbb633d6f784c45b56796376eae7054x600x1200.PNG"
    ]
  },
  {
    "text": "Which of the following arteries does not supply the duodenum?",
    "choices": [
      {
        "id": 1,
        "text": "Common hepatic artery"
      },
      {
        "id": 2,
        "text": "Right gastric artery"
      },
      {
        "id": 3,
        "text": "Jejunal artery"
      },
      {
        "id": 4,
        "text": "Splenic artery"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The splenic artery does not supply the duodenum.</p>\n<p>The <strong>major vessels supplying</strong> the <strong>duodenum</strong> are:</p>\n<ul>\n<li><strong>Gastroduodenal artery -&nbsp;</strong>&nbsp;branch of the common hepatic artery</li>\n<li><strong>Superior mesenteric</strong> <strong>artery</strong>&nbsp;- anterior branch of the abdominal aorta.</li>\n</ul>\n<p>Branches of the gastroduodenal artery&nbsp;supplying the first and second parts of the duodenum and head of the pancreas are:</p>\n<ul>\n<li>Posterior superior pancreaticoduodenal artery</li>\n<li>Anterior superior pancreaticoduodenal artery</li>\n<li>Supraduodenal artery&nbsp; &nbsp; &nbsp;</li>\n<li>Retroduodenal arteries</li>\n<li>Pancreatic branches&nbsp;</li>\n</ul>\n<p>Note: The first and second parts of the duodenum also receive minor blood supply from the <strong>right gastric artery</strong> and the <strong>right gastroepiploic artery.</strong></p>\n<p>Branches of the superior mesenteric artery&nbsp;supplying the second,&nbsp;third,&nbsp;and fourth parts of the duodenum,&nbsp;and the head and uncinate process of the pancreas are:</p>\n<ul>\n<li>Inferior pancreaticoduodenal artery - anterior and posterior branches supply the second and third parts of the duodenum</li>\n<li>First jejunal artery - supply the fourth part of the duodenum</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5575a1f0c70a401e8618552cbfaf0089x1280x1317.JPEG"
    ]
  },
  {
    "text": "In which part of the intestine is the finding given in the image more prominently seen?",
    "choices": [
      {
        "id": 1,
        "text": "Ileum"
      },
      {
        "id": 2,
        "text": "Jejunum"
      },
      {
        "id": 3,
        "text": "Duodenum"
      },
      {
        "id": 4,
        "text": "Ascending colon"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows <strong>plicae circulares</strong>&nbsp;which are also known as&nbsp;<strong>valvulae conniventes. </strong>They are&nbsp;more prominent in the <strong>jejunum</strong>.</p>\n<p>Plicae circulares are the <strong>circular mucosal folds.</strong> They frequently branch and stack upon each other, giving the jejunum a <strong>characteristic feathery appearance</strong> in single <strong>contrast radiography</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/16fa14cf840d4993beb092db4177fa0d.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the correct match among the following.",
    "choices": [
      {
        "id": 1,
        "text": "Peyer's patch - mesenteric border of ileum"
      },
      {
        "id": 2,
        "text": "Meckel\u2019s diverticulum - mesenteric border of jejenum"
      },
      {
        "id": 3,
        "text": "Meckel\u2019s diverticulum - antimesenteric border of ileum"
      },
      {
        "id": 4,
        "text": "Peyer's patch - antimesenteric border of jejunum"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Meckel's diverticulum</strong> projects from the <strong>antimesenteric border</strong> of the <strong>terminal</strong> <strong>ileum</strong>. It&nbsp;is commonly located 2 feet proximal to the ileocaecal valve.</p>\n<p><strong>Peyer's patches</strong> are lymphoid aggregates present in the submucosa and are arranged longitudinally along the <strong>antimesenteric border </strong>of<strong> ileum.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2026e6c24c674525991310d3dad03044x600x684.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6658c7c6346d47f4938f775d7e8cbc22x1280x1364.JPEG"
    ]
  },
  {
    "text": "Which of the following is the longest part of the large intestine?",
    "choices": [
      {
        "id": 1,
        "text": "Transverse colon"
      },
      {
        "id": 2,
        "text": "Descending colon"
      },
      {
        "id": 3,
        "text": "Ascending colon"
      },
      {
        "id": 4,
        "text": "Sigmoid colon"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>transverse colon</strong> is the <strong>longest part</strong> of the <strong>large intestine</strong>, measuring <strong>50 cm</strong> in length on an average. It is <strong>intraperitoneal</strong> in location and suspended by the transverse mesocolon.</p>\n<p>Lengths of various parts of the large intestine are as follows:</p>\n<table style=\"width: 335px;\">\n<tbody>\n<tr>\n<td style=\"width: 160px;\">\n<p><strong>Intestinal segment</strong></p>\n</td>\n<td style=\"width: 165px;\">\n<p><strong>Approximate length</strong></p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Caecum</p>\n</td>\n<td style=\"width: 165px;\">\n<p>6 cm</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Ascending colon</p>\n</td>\n<td style=\"width: 165px;\">15 to 20 cm</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Transverse colon</p>\n</td>\n<td style=\"width: 165px;\">\n<p>50 cm</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Descending colon</p>\n</td>\n<td style=\"width: 165px;\">\n<p>25 to 30 cm</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Sigmoid colon</p>\n</td>\n<td style=\"width: 165px;\">\n<p>37.5 cm</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Rectum</p>\n</td>\n<td style=\"width: 165px;\">\n<p>15 cm</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 160px;\">\n<p>Anal canal</p>\n</td>\n<td style=\"width: 165px;\">\n<p>2 to 5 cm</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/40d35b7d14144a008b48f053ce3c1c0ex600x771.JPEG"
    ]
  },
  {
    "text": "A specimen of the large intestine is given below. In which of the following is the marked structure usually not present?",
    "choices": [
      {
        "id": 1,
        "text": "Sigmoid colon"
      },
      {
        "id": 2,
        "text": "Descending colon"
      },
      {
        "id": 3,
        "text": "Transverse colon"
      },
      {
        "id": 4,
        "text": "Caecum"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The structures marked in the image are<strong> appendices epiploicae</strong>\u00a0and they are usually <strong>absent </strong>in the<strong> caecum.</strong></p>\n<p>Appendices epiploicae are small<strong> fat-filled peritoneal pouches</strong> scattered over the surface of the large intestine. They are very <strong>abundant</strong> on the surface of the<strong> sigmoid colon</strong> and tend to be <strong>absent</strong> from\u00a0<strong>caecum, rectum, </strong>and <strong>appendix.</strong></p>\n<p>The below image shows the appendices epiploicae.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c36d888aeb544cfdb6ad76a17f596106.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/58c2d81f38154a1b8bf8a86e6af32be0x600x467.JPEG"
    ]
  },
  {
    "text": "An elderly man with atherosclerosis presented with abdominal pain and blood-stained stools.  CECT abdomen is suggestive of ischemic colitis at the splenic flexure involving the marginal artery of Drummond. What are the arteries contributing to the formation of this structure?",
    "choices": [
      {
        "id": 1,
        "text": "Right colic and left colic arteries"
      },
      {
        "id": 2,
        "text": "Ileocolic and left colic arteries"
      },
      {
        "id": 3,
        "text": "Left colic and middle colic arteries"
      },
      {
        "id": 4,
        "text": "Left colic and sigmoid arteries"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The<strong> middle </strong>and<strong> left colic arteries</strong>&nbsp;contribute to the formation of the <strong>marginal artery </strong>of<strong> Drummond </strong>at the splenic flexure.&nbsp;The<strong> splenic flexure (Griffith's point) </strong>is a<strong> watershed area </strong>of the colon which is more prone to<strong> ischemia.&nbsp;</strong></p>\n<p>The anastomotic vessel that runs in the mesentery along the inner margin of the colon is called the marginal artery of Drummond. From this artery, numerous small branches are given to the large bowel. It is formed by:</p>\n<ul>\n<li>Branches of <strong>superior mesenteric artery - </strong>middle colic, right colic, and ileocolic arteries</li>\n<li>Branches of <strong>inferior mesenteric artery - </strong>left colic, sigmoid, and superior rectal arteries</li>\n</ul>\n<p>When ischemia occurs at Griffith's point, the blood supply in this region is augmented by another arterial loop called the <strong>inner arterial arc (of Riolan).</strong> This arc connects the main trunk of the <strong>middle colic artery</strong> with the ascending branch of the<strong> left colic artery</strong>.</p>\n<p>Note: <strong>Sudeck's point</strong> is another watershed area present at the <strong>rectosigmoid junction</strong>. The <strong>sigmoid artery</strong> anastomoses with the <strong>superior rectal artery</strong> at this site.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e0e97a8c8aa3448a8c69bff4f49e06fex600x771.JPEG"
    ]
  },
  {
    "text": "A 10-year-old boy complained of nausea, anorexia and abdominal pain. On examination, tenderness was noted at McBurney's point and ilio-psoas sign was positive. You suspect inflammation of the organ shown in the image. What is its most common anatomical position?",
    "choices": [
      {
        "id": 1,
        "text": "1"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "3"
      },
      {
        "id": 4,
        "text": "4"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario points towards <strong>appendicitis</strong> and the <strong>most common position</strong> of the <strong>appendix</strong> is <strong>retrocaecal. </strong>This&nbsp;has been marked as position '2' in the image. This is because the appendix develops during the descent of the colon in embryonic life.</p>\n<p>The <strong>base</strong> of the appendix is <strong>fixed</strong> and&nbsp;depending on the <strong>direction of the tip</strong>, the <strong>positions</strong> of the appendix are as follows:</p>\n<ul>\n<li>Retrocaecal</li>\n<li>Pelvic&nbsp;</li>\n<li>Paracolic&nbsp;</li>\n<li>Subcaecal</li>\n<li>Pre ileal&nbsp;</li>\n<li>Post ileal&nbsp;</li>\n<li>Promonteric&nbsp;</li>\n</ul>\n<p>Clinical note:</p>\n<ol>\n<li><strong>Ilio-psoas sign</strong> - Pain elicited on extension of the hip, seen in <strong>retrocaecal</strong> appendicitis.</li>\n<li><strong>Obturator sign</strong> - Pain elicited on internal rotation of the hip, seen in <strong>pelvic</strong> appendicitis.</li>\n</ol>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4f929f71ea8d441ab798c79f6e36a3a4.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6409c8188a264491b6390f34f61b5d6dx600x742.JPEG"
    ]
  },
  {
    "text": "Which of the following is a content of the lateral rectal ligament?",
    "choices": [
      {
        "id": 1,
        "text": "Right superior rectal artery"
      },
      {
        "id": 2,
        "text": "Left superior rectal artery"
      },
      {
        "id": 3,
        "text": "Middle rectal artery"
      },
      {
        "id": 4,
        "text": "Inferior rectal artery"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>middle rectal artery</strong> is a content of the <strong>lateral rectal</strong> <strong>ligament.</strong></p>\n<p>The <strong>condensation of</strong> the <strong>endopelvic fascia</strong> that surrounds the middle rectal vessels is referred to as the lateral rectal ligament<strong>.&nbsp;</strong>Branches of the inferior hypogastric plexus also enter the rectum through this ligament.</p>\n<p><strong>Blood supply of the rectum:</strong></p>\n<table style=\"height: 521px;\" width=\"817\">\n<tbody>\n<tr style=\"height: 37px;\">\n<td style=\"width: 178.641px; height: 37px;\"><strong>Artery</strong></td>\n<td style=\"width: 201.188px; height: 37px;\"><strong>Branch of</strong></td>\n<td style=\"width: 221.484px; height: 37px;\"><strong>Location</strong></td>\n<td style=\"width: 187.688px; height: 37px;\"><strong>Parts supplied</strong></td>\n</tr>\n<tr style=\"height: 71px;\">\n<td style=\"width: 178.641px; height: 71px;\"><strong>Superior rectal artery</strong></td>\n<td style=\"width: 201.188px; height: 71px;\">Inferior mesenteric artery</td>\n<td style=\"width: 221.484px; height: 71px;\">Mesorectum</td>\n<td style=\"width: 187.688px; height: 71px;\">Upper two-thirds of the rectum</td>\n</tr>\n<tr style=\"height: 105px;\">\n<td style=\"width: 178.641px; height: 105px;\"><strong>Middle rectal artery</strong></td>\n<td style=\"width: 201.188px; height: 105px;\">Anterior division of the internal iliac artery or inferior vesical artery</td>\n<td style=\"width: 221.484px; height: 105px;\">Lateral rectal ligament</td>\n<td style=\"width: 187.688px; height: 105px;\">Middle third of the rectum</td>\n</tr>\n<tr style=\"height: 233.203px;\">\n<td style=\"width: 178.641px; height: 233.203px;\"><strong>Inferior rectal artery</strong></td>\n<td style=\"width: 201.188px; height: 233.203px;\">Internal pudendal artery</td>\n<td style=\"width: 221.484px; height: 233.203px;\">Ischio-rectal fossa</td>\n<td style=\"width: 187.688px; height: 233.203px;\">\n<p>Distal third of the rectum</p>\n<p>Anal canal with internal and external anal sphincters</p>\n<p>Perianal skin</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/eca9067fab894099a62207b0600ca7adx600x643.JPEG"
    ]
  },
  {
    "text": "Which of the following statements about the muscles of the anal canal is false?",
    "choices": [
      {
        "id": 1,
        "text": "Internal anal sphincter is the thickened terminal part of the inner circular muscle of large intestine"
      },
      {
        "id": 2,
        "text": "The conjoint longitudinal muscle plays an important role in the prevention of haemorrhoids"
      },
      {
        "id": 3,
        "text": "Treitz's muscle is the submucosal muscle  of the anal canal that prevents haemorrhoids"
      },
      {
        "id": 4,
        "text": "The external anal sphincter is the continuation of the outer longitudinal muscle of the rectum"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>external anal sphincter</strong> is made up of <strong>striated muscle fibres.</strong> It is not a continuation of the outer longitudinal muscle of the rectum</p>\n<p>The external anal sphincter is made up of <strong>two parts</strong> - upper(deep) and lower (subcutaneous or superficial). The<strong> pudendal nerve</strong> innervates the external anal sphincter and it is under\u00a0<strong>voluntary control.</strong></p>\n<p><strong>Muscles of the anal canal:</strong></p>\n<ul>\n<li><strong>External anal sphincter</strong></li>\n<li><strong>Internal anal sphincter:\u00a0</strong>It is the terminal thickened part of the <strong>inner circular muscle</strong> of the large intestine. It extends from the anorectal junction to the anal verge. It is innervated by the <strong>autonomic nervous system:</strong>\u00a0parasympathetic - relaxation; sympathetic - contraction.</li>\n<li><strong>Conjoint longitudinal muscle:\u00a0</strong>It lies <strong>between the internal anal sphincter</strong> and the <strong>external anal sphincter.</strong> It is the continuation of the <strong>outer</strong> <strong>longitudinal muscle</strong> of the rectum. The muscle fibres distally fan out and traverse the internal and external anal sphincter. It has a <strong>protective effect</strong> on <strong>haemorrhoids</strong>.<strong>\u00a0</strong>This muscle degenerates as age advances.</li>\n<li><strong>Treitz's muscle:\u00a0</strong>It is the <strong>submucosal muscle</strong> of the anal canal. It is attached to the conjoint longitudinal muscle by the <strong>Park's ligament.</strong> It <strong>maintains</strong> the <strong>integrity</strong> of the <strong>anal cushions</strong> and plays an important role in <strong>preventing haemorrhoids</strong>.\u00a0</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5d54eac3a35046bf88def0315997ac41x600x602.JPEG"
    ]
  },
  {
    "text": "A 60-year-old man presented with a painful mass at the anus associated with bleeding. Examination revealed external haemorrhoids. Which of the following nerves is responsible for carrying the pain sensation?",
    "choices": [
      {
        "id": 1,
        "text": "Parasympathetic fibres S2, 3, and 4"
      },
      {
        "id": 2,
        "text": "Pudendal nerve S2, 3, and 4"
      },
      {
        "id": 3,
        "text": "Sympathetic fibres L1 and 2"
      },
      {
        "id": 4,
        "text": "Least splanchnic nerve T12"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The nerve mediating <strong>pain</strong> in <strong>external haemorrhoids</strong> is&nbsp;<strong>pudendal nerve </strong>S2, 3, and 4.</p>\n<p><strong>Differences between external and internal haemorrhoids:</strong></p>\n<table style=\"height: 199px;\" width=\"819\">\n<tbody>\n<tr>\n<td style=\"width: 402.517px;\"><strong>External haemorrhoids</strong></td>\n<td style=\"width: 402.517px;\"><strong>Internal haemorrhoids</strong></td>\n</tr>\n<tr>\n<td style=\"width: 402.517px;\">Located&nbsp;distal to the dentate line</td>\n<td style=\"width: 402.517px;\">Located proximal<strong>&nbsp;</strong>to the dentate line</td>\n</tr>\n<tr>\n<td style=\"width: 402.517px;\">Innervated by the inferior rectal branch of pudendal nerve S2, 3, and 4 (somatic nerve)</td>\n<td style=\"width: 402.517px;\">Innervated by parasympathetic fibres S2, 3, and 4, and sympathetic fibres L1 and 2</td>\n</tr>\n<tr>\n<td style=\"width: 402.517px;\">Pain sensitive</td>\n<td style=\"width: 402.517px;\">Pain insensitive</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7a197dfefac7447da07c699ed24d6748x600x425.JPEG"
    ]
  },
  {
    "text": "How many transverse mucosal folds are commonly present in the rectum?",
    "choices": [
      {
        "id": 1,
        "text": "2"
      },
      {
        "id": 2,
        "text": "3"
      },
      {
        "id": 3,
        "text": "4"
      },
      {
        "id": 4,
        "text": "5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Three </strong>transverse mucosal folds (also known as <strong>Houston's valves</strong>) are commonly present in the <strong>rectum</strong>.</p>\n<p>The transverse mucosal folds are <strong>permanent</strong> and become very <strong>prominent on</strong> <strong>distension </strong>of the rectum.</p>\n<ul>\n<li>The <strong>superior transverse fold</strong>\u00a0- present at <strong>either side</strong> of the beginning of the rectum\u00a0and may occasionally encircle the entire lumen.</li>\n<li>The <strong>middle transverse fold</strong>\u00a0- <strong>largest</strong> and <strong>constant</strong> fold present above the rectal ampulla. It projects\u00a0from the <strong>anterior </strong>and<strong> right wall</strong> of the rectum.</li>\n<li>The <strong>inferior transverse fold -</strong>\u00a0<strong>most variable</strong> and\u00a0found on the<strong> left </strong>side.</li>\n</ul>\n<p>Apart from these, the rectal mucosa has <strong>several longitudinal folds,</strong> which <strong>disappear on distension</strong> of the rectum.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5fe3ebd3696a4d0799789fb72d8fbe7ax600x602.JPEG"
    ]
  }
];
        let quizName = '49 Gi Tract';
        const quizFilename = '49-gi-tract-bf0e925c.html';
        let hierarchy = ["Marrow", "qBank", "Anatomy"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>