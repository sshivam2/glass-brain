<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18 Ectopic Pregnancy - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Obstetrics & Gynecology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">19</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Arrange the following sites of ectopic pregnancy from the most common to the least common.",
    "choices": [
      {
        "id": 1,
        "text": "3>2>4>1"
      },
      {
        "id": 2,
        "text": "1>2>3>4"
      },
      {
        "id": 3,
        "text": "2>4>1>3"
      },
      {
        "id": 4,
        "text": "3>1>4>2"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The order of the most common site to the least common site in the <strong>fallopian tube</strong> for ectopic pregnancy is <strong>ampulla&gt;isthmus&gt;fimbriae&gt;interstitium.</strong></p>\n<p>An<strong> ectopic pregnancy </strong>is\u00a0any pregnancy implanted <strong>outside of the endometrial cavity. </strong></p>\n<p><strong>Extrauterine sites:\u00a0</strong>The most common site of ectopic pregnancy is the extrauterine fallopian tube.\u00a0</p>\n<ul>\n<li>Tubal - 97% (most common)\n<ul>\n<li><strong>Ampulla - 55%</strong></li>\n<li>Isthmus</li>\n<li>Infundibulum</li>\n<li>Interstitium</li>\n</ul>\n</li>\n<li>Ovarian</li>\n<li>Abdominal</li>\n</ul>\n<p><strong>Intrauterine ectopic sites:</strong></p>\n<ul>\n<li>Cervical</li>\n<li>Caesarean scar\u00a0</li>\n<li>Rudimentary horn of a bicornuate uterus</li>\n<li>Heterotopic pregnancy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following factors maximally increases the risk of tubal pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Intrauterine device"
      },
      {
        "id": 2,
        "text": "Pelvic Inflammatory disease"
      },
      {
        "id": 3,
        "text": "Prior tubal surgery"
      },
      {
        "id": 4,
        "text": "Artificial reproductive technique"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Prior tubal surgery </strong>for ectopic pregnancy<strong>&nbsp;</strong>has the <strong>highest risk</strong> of tubal pregnancy among the given options.</p>\n<p>Risk factors for ectopic pregnancy:</p>\n<ul>\n<li>Prior ectopic pregnancy</li>\n<li><strong>Prior tubal surgery</strong> for ectopic, recanalization of tube post-sterilization</li>\n<li><strong>Pelvic inflammatory disease</strong> - <strong>most common</strong> cause for ectopic pregnancy</li>\n<li>Infertility</li>\n<li>Artificial reproductive therapy</li>\n<li>Endometriosis</li>\n<li>Smoking</li>\n<li>Maternal age &gt;40 years</li>\n<li>Contraceptive methods - intrauterine device, progesterone-only pills</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The fall in which of the following hormone/s leads to endometrial sloughing in ectopic gestation?",
    "choices": [
      {
        "id": 1,
        "text": "hCG"
      },
      {
        "id": 2,
        "text": "Estrogen"
      },
      {
        "id": 3,
        "text": "Estrogen and Progesterone"
      },
      {
        "id": 4,
        "text": "Progesterone and hCG"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Endometrial sloughing in ectopic gestation is due to the fall in the levels of <strong>progesterone</strong> and <strong>hCG</strong>.</p>\n<p>During normal pregnancy, endometrium is maintained by the high levels of hCG and progesterone. In <strong>ectopic</strong> pregnancy, a fall in the levels of these hormones will cause <strong>endometrial sloughing</strong> and <strong>uterine bleeding</strong>. If the decidua is expelled as a single piece through the cervix, it is called a decidual cast.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which type of tubal pregnancy ruptures at a later stage?",
    "choices": [
      {
        "id": 1,
        "text": "Ampullary"
      },
      {
        "id": 2,
        "text": "Interstitial"
      },
      {
        "id": 3,
        "text": "Fimbrial"
      },
      {
        "id": 4,
        "text": "Isthmic"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Interstitial</strong> tubal pregnancy <strong>ruptures</strong> at a <strong>later</strong> stage i.e. at 12-16 weeks.&nbsp;This is because pregnancy at this site is closer to the uterine <strong>myometrium</strong> which provides <strong>support</strong> as pregnancy progresses.&nbsp;</p>\n<p><strong>Isthmic</strong> and <strong>ampullary</strong> pregnancies terminate by tubal <strong>rupture</strong>. However, isthmic pregnancy ruptures earlier. Ampullary and <strong>infundibular</strong> pregnancy can terminate by tubal <strong>abortion</strong> as well.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following clinical features is not seen in a patient with ruptured ectopic pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Shoulder tip pain"
      },
      {
        "id": 2,
        "text": "Decidual cast"
      },
      {
        "id": 3,
        "text": "Vertigo and syncope"
      },
      {
        "id": 4,
        "text": "Shock index of 0.7"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>A <strong>shock index</strong> of <strong>&gt;0.85</strong> is seen in a case of ruptured ectopic pregnancy. There is massive blood loss (SBP&lt;110 mmHg) sometimes leading to shock.&nbsp;</p>\n<p>The shock index is calculated as <strong>HR/systolic BP.</strong></p>\n<table style=\"width: 389px; height: 227px;\">\n<tbody>\n<tr>\n<td style=\"width: 225.578px;\"><strong>Condition</strong></td>\n<td style=\"width: 147.422px;\"><strong>Range of shock index</strong></td>\n</tr>\n<tr>\n<td style=\"width: 225.578px;\">Normal value of shock index (non-pregnant)</td>\n<td style=\"width: 147.422px;\">0.5 - 0.7</td>\n</tr>\n<tr>\n<td style=\"width: 225.578px;\">Normal value of shock index in pregnancy (i.e) obstetrical shock index</td>\n<td style=\"width: 147.422px;\">0.7 - 0.8</td>\n</tr>\n<tr>\n<td style=\"width: 225.578px;\">Significant or massive blood loss</td>\n<td style=\"width: 147.422px;\">0.9 - 1.1</td>\n</tr>\n</tbody>\n</table>\n<p>Option A:&nbsp;Sub-diaphragmatic blood irritates the <strong>phrenic nerve</strong>. This causes a <strong>referred pain</strong> at the <strong>shoulder tip</strong>. This is called as <strong>Danforth sign</strong>.</p>\n<p>Option B: The expulsion of decidua in a single piece through the cervix is called a <strong>decidual cast</strong>. This is due to the <strong>fall</strong> in the levels of <strong>&beta;</strong>&nbsp;<strong>hCG</strong> and <strong>progesterone</strong>.</p>\n<p>Option C: <strong>Vertigo</strong> and <strong>syncope</strong> are due to <strong>reflex</strong> <strong>vasomotor</strong> disturbances due to peritoneal irritation from hemoperitoneum.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman presented with complaints of amenorrhoea for 6 weeks and a history of prior ectopic pregnancy. Serial serum beta hCG levels were estimated in her. Which of the following findings will increase the suspicion of ectopic gestation in her?",
    "choices": [
      {
        "id": 1,
        "text": "Low levels with prolonged doubling time"
      },
      {
        "id": 2,
        "text": "High levels with decreased doubling time"
      },
      {
        "id": 3,
        "text": "Undetectable"
      },
      {
        "id": 4,
        "text": "Double the expected value"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Low</strong> levels of&nbsp;&beta; hCG and <strong>prolonged</strong> <strong>doubling</strong> <strong>time</strong> increase the suspicion of ectopic pregnancy.</p>\n<p>Urine pregnancy test is very sensitive and found positive in most ectopic pregnancies. Hence, serial serum &beta; hCG levels are estimated to detect ectopic pregnancy. In early normal pregnancy, the doubling time of&nbsp;&beta; hCG concentrations in plasma is 1.4 to 2 days.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented with 6 weeks of amenorrhoea and a positive UPT. TVS revealed a tubal ectopic pregnancy. Which of the following findings can be usually picked up on colour Doppler?",
    "choices": [
      {
        "id": 1,
        "text": "Enhanced blood flow pattern in the uterine artery"
      },
      {
        "id": 2,
        "text": "Arias stella reaction"
      },
      {
        "id": 3,
        "text": "Ring of fire pattern"
      },
      {
        "id": 4,
        "text": "Whirlpool sign"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option D: <strong>Whirlpool</strong> sign refers to the twisted ovarian pedicle seen on USG of&nbsp;<strong>ovarian</strong> <strong>torsion.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ab9aaa482f354649bc0471ecd6fcd79cx676x543.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b86fd6a6110e4746b945b389647b73d9x1280x1121.JPEG"
    ]
  },
  {
    "text": "A pregnant woman came for routine antenatal USG. Which of the following features is suggestive of a pseudogestational sac?",
    "choices": [
      {
        "id": 1,
        "text": "Presence of yolk sac"
      },
      {
        "id": 2,
        "text": "Intradecidual sac sign"
      },
      {
        "id": 3,
        "text": "Central location"
      },
      {
        "id": 4,
        "text": "Double decidual sign"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Central location</strong> is a feature of the <strong>pseudogestational</strong> <strong>sac</strong> seen in ectopic pregnancies.</p>\n<p>Pseudogestational sac is a collection of fluid between the endometrial layers, surrounded by a thick decidua. Its presence increases the suspicion of ectopic pregnancy.</p>\n<p>Differences between&nbsp;pseudogestational sac and true gestational sac:</p>\n<table>\n<tbody>\n<tr>\n<td><strong>Feature</strong></td>\n<td><strong>Pseudogestational sac</strong></td>\n<td><strong>True gestational sac</strong></td>\n</tr>\n<tr>\n<td>Location within the endometrial cavity</td>\n<td>Central</td>\n<td>Eccentric</td>\n</tr>\n<tr>\n<td>Shape&nbsp;</td>\n<td>Usually ovoid</td>\n<td>Usually round</td>\n</tr>\n<tr>\n<td>Fetal and yolk sac poles</td>\n<td>Absent</td>\n<td>Present</td>\n</tr>\n<tr>\n<td>Double ring sign</td>\n<td>Absent</td>\n<td>Seen</td>\n</tr>\n<tr>\n<td>Intradecidual sign</td>\n<td>Absent</td>\n<td>Seen</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with suspected tubal pregnancy underwent transvaginal ultrasound which was inconclusive. What is the next step of management?",
    "choices": [
      {
        "id": 1,
        "text": "Laparotomy"
      },
      {
        "id": 2,
        "text": "Diagnostic laparoscopy"
      },
      {
        "id": 3,
        "text": "Serum \u03b2 hCG levels"
      },
      {
        "id": 4,
        "text": "Methotrexate therapy"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the given scenario, the next step would be to confirm the tubal ectopic by measuring <strong>serum &beta; hCG</strong>. This can be used to differentiate&nbsp;<strong>tubal ectopic</strong> pregnancy from&nbsp;<strong>missed</strong> <strong>abortion</strong>&nbsp;and early <strong>intrauterine</strong> <strong>pregnancy</strong>.&nbsp;</p>\n<p>If the level is &ge;2000 IU/L, ectopic pregnancy is suspected. If the level is &lt;1500 IU/L, a repeat serum &beta; hCG is taken after 48 hours. If the levels are:</p>\n<ul>\n<li>Doubled - early intrauterine pregnancy</li>\n<li>Decreased - abortion</li>\n<li>Increased but less than doubled value - ectopic pregnancy</li>\n</ul>\n<p><strong>Investigations</strong> for <strong>ectopic</strong> pregnancy:</p>\n<ul>\n<li>Serum&nbsp;&beta; hCG&nbsp;- lower levels compared to normal pregnancy, prolonged doubling time</li>\n<li>Transvaginal ultrasound - empty uterine cavity, fluid in pouch of Douglas, adnexal mass</li>\n<li>Colour Doppler - ring of fire pattern</li>\n<li>Laparoscopy&nbsp;</li>\n<li>Dilatation and curettage - decidua identified without villi</li>\n<li>Serum progesterone&nbsp;</li>\n<li>Culdocentesis&nbsp;</li>\n</ul>\n<p><strong>Diagnostic laparoscopy</strong> may be done when the diagnosis is still uncertain after serial &beta;-hCG monitoring and repeat ultrasonography. In high-risk situations, such as a history of previous ectopic pregnancy, earlier diagnostic laparoscopy is considered.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e6c00cf3cc28489ea7ca07a67245a908x1280x2077.JPEG"
    ]
  },
  {
    "text": "A pregnant woman is diagnosed with unruptured ectopic gestation. Which of the following is not an indication for expectant management in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Initial serum beta hCG level of 200 mIU/mL"
      },
      {
        "id": 2,
        "text": "Gestational sac size of 5 cm"
      },
      {
        "id": 3,
        "text": "Asymptomatic"
      },
      {
        "id": 4,
        "text": "Absence of fetal cardiac activity"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>A gestational sac</strong> size of <strong>&lt;4 cm</strong> is an indication of <strong>expectant</strong> management.</p>\n<p><strong>Expectant management</strong> is done only in the case of <strong>unruptured tubal</strong> pregnancy. In this, observation is done till there is spontaneous resolution. It can be done but is not preferred due to prolonged follow-up and uncertainty in resolution.</p>\n<p>The <strong>indications</strong> are:\u00a0</p>\n<ul>\n<li>Initial serum\u00a0<strong>\u03b2 hCG &lt;1500 IU/L</strong></li>\n<li>Falling\u00a0serum\u00a0\u03b2 hCG levels</li>\n<li>Gestational <strong>sac size &lt;4 cm</strong></li>\n<li>No fetal cardiac activity on TVS</li>\n<li>No evidence of rupture or bleeding on TVS</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A primigravida in her first trimester came for a routine ANC. USG findings revealed an empty uterine cavity. Serum beta hCG was measured and was found to be 1700 IU/mL. All of the following drugs can be used in managing this patient except:",
    "choices": [
      {
        "id": 1,
        "text": "Potassium chloride"
      },
      {
        "id": 2,
        "text": "Methotrexate"
      },
      {
        "id": 3,
        "text": "Actinomycin"
      },
      {
        "id": 4,
        "text": "Oxytocin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Oxytocin</strong> is <strong>not used\u00a0</strong>in the management of<strong> unruptured ectopic pregnancy</strong>.</p>\n<p><strong>Indications</strong> for medical management of unruptured tubal ectopic pregnancy:</p>\n<ul>\n<li>Hemodynamically stable patient</li>\n<li>Serum \u03b2 hCG &lt;5000 IU/L</li>\n<li>Tubal diameter &lt;4 cm</li>\n<li>No fetal cardiac activity</li>\n<li>No intra-abdominal haemorrhage</li>\n</ul>\n<p><strong>Medical management</strong> of unruptured tubal ectopic:</p>\n<ul>\n<li>Direct local therapy (laparoscopy or USG guidance) -\n<ul>\n<li>Methotrexate</li>\n<li>Potassium chloride</li>\n<li>Actinomycin</li>\n<li>Hyperosmolar glucose</li>\n<li>PGF<sub>2\u03b1</sub></li>\n</ul>\n</li>\n<li>Systemic therapy - single dose of <strong>methotrexate</strong> 50 mg/m<sup>2</sup> IM</li>\n</ul>\n<p><strong>Follow-up</strong> after medical management is done by measuring the decline in serial <strong>serum\u00a0\u03b2 hCG</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with unruptured ectopic pregnancy is planned for medical management with methotrexate. What is the multi-dose protocol for this drug?",
    "choices": [
      {
        "id": 1,
        "text": "1 mg/kg on days 1, 2, 5, and 8"
      },
      {
        "id": 2,
        "text": "0.1 mg/kg on days 1, 3, 5, and 7"
      },
      {
        "id": 3,
        "text": "0.1 mg/kg on days 1, 4, 6, and 8"
      },
      {
        "id": 4,
        "text": "1 mg/kg on days 1, 3, 5, and 7"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In the\u00a0<strong>multi-dose protocol</strong>, methotrexate is given at a dose of\u00a0<strong>1 mg/kg </strong>as an<strong>\u00a0</strong>IM injection on<strong>\u00a0alternate days 1, 3, 5, and 7</strong>.</p>\n<p>This regimen is continued on alternating days until the hCG level drops by 15% over two days. Up to 4 doses may be given. Along with this, <strong>leucovorin rescue </strong>(<strong>folinic acid</strong>)\u00a0is given at <strong>0.1 mg/kg</strong>\u00a0after 24 hrs (on days 2, 4, 6, and 8) to buffer the side effects of methotrexate.</p>\n<table style=\"height: 195px;\" width=\"470\">\n<tbody>\n<tr>\n<td style=\"width: 148.688px;\"><strong>MTX Protocol</strong></td>\n<td style=\"width: 148.688px;\"><strong>Multi-dose regimen</strong></td>\n<td style=\"width: 148.711px;\"><strong>Single-dose regimen</strong></td>\n</tr>\n<tr>\n<td style=\"width: 148.688px;\"><strong>Dose</strong>\u00a0</td>\n<td style=\"width: 148.688px;\">\n<p><strong>1 mg/kg<br /></strong>(+ 0.1 mg/kg LEU)</p>\n</td>\n<td style=\"width: 148.711px;\">\n<p><strong>50 mg/m<sup>2<br /></sup></strong>(Body surface area)</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 148.688px;\"><strong>Regimen</strong></td>\n<td style=\"width: 148.688px;\">Alternate daily doses\u00a0</td>\n<td style=\"width: 148.711px;\">Day 0</td>\n</tr>\n<tr>\n<td style=\"width: 148.688px;\"><strong>hCG measurement</strong></td>\n<td style=\"width: 148.688px;\">Days 0, 1, 3, 5, 7</td>\n<td style=\"width: 148.711px;\">Days 0, 4, 7</td>\n</tr>\n<tr>\n<td style=\"width: 148.688px;\"><strong>Treatment success</strong></td>\n<td style=\"width: 148.688px;\">hCG declines &gt;<strong>15%</strong> from the <strong>previous value</strong></td>\n<td style=\"width: 148.711px;\">hCG declines &gt;<strong>15%</strong> between <strong>Day 4 and 7</strong></td>\n</tr>\n<tr>\n<td style=\"width: 148.688px;\"><strong>When to administer additional dose \u00a0</strong></td>\n<td style=\"width: 148.688px;\">2<sup>nd</sup>, 3<sup>rd</sup>\u00a0or 4<sup>th</sup>\u00a0dose to be given if hCG does not decline 15% from the previous value. Maximum 4 doses \u00a0</td>\n<td style=\"width: 148.711px;\">Second dose on <strong>Day 7</strong> if hCG does not decline 15%\u00a0</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0Note: If the decline is\u00a0<strong>\u226515%</strong>, the patient is <strong>followed up weekly</strong> till the levels fall to &lt;10 IU/L.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following must be avoided by a patient with tubal pregnancy on methotrexate?",
    "choices": [
      {
        "id": 1,
        "text": "1, 3, 5"
      },
      {
        "id": 2,
        "text": "1, 4, 5"
      },
      {
        "id": 3,
        "text": "2, 3, 5"
      },
      {
        "id": 4,
        "text": "1, 2, 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Sunlight</strong> exposure, <strong>sexual</strong> <strong>intercourse</strong> and <strong>NSAIDs</strong> must be <strong>avoided</strong> when patients are on methotrexate therapy.</p>\n<p>The following should be avoided when methotrexate therapy has been initiated for the treatment of ectopic gestation:</p>\n<ul>\n<li>Nonsteroidal anti-inflammatory drugs - can cause reduced renal blood flow and delay drug excretion</li>\n<li>Alcohol - can predispose to concurrent hepatic enzyme elevation</li>\n<li>Sunlight - may provoke methotrexate-related dermatitis</li>\n<li>Sexual intercourse - can rupture the ectopic pregnancy</li>\n<li>Phenytoin, tetracyclines, salicylates, and sulfonamides - can increase serum methotrexate levels</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old woman was brought to the casualty in a drowsy state with complaints of bleeding PV  associated with abdominal pain and a history of amenorrhoea for 8 weeks. On examination, BP was 90/60 mmHg, PR was 140 bpm, and UPT was positive. What is the next step of management?",
    "choices": [
      {
        "id": 1,
        "text": "Admit to the ICU"
      },
      {
        "id": 2,
        "text": "Resuscitation and emergency laparotomy"
      },
      {
        "id": 3,
        "text": "Suction and evacuation"
      },
      {
        "id": 4,
        "text": "FAST followed by laparoscopic salpingectomy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of <strong>ruptured ectopic</strong> pregnancy which must be immediately managed with <strong>simultaneous</strong> <strong>resuscitation</strong> and <strong>laparotomy</strong>.&nbsp;On laparotomy, <strong>salpingectomy</strong> is the definitive surgery.&nbsp;</p>\n<p>Diagnosis of ruptured ectopic pregnancy is made based on clinical features:</p>\n<ul>\n<li>Amenorrhoea for 6-8 weeks followed by bleeding PV</li>\n<li>Abdominal pain&nbsp;</li>\n<li>Hemodynamically unstable&nbsp;</li>\n<li>Urine pregnancy test - positive</li>\n</ul>\n<p>Surgical treatment of ectopic pregnancy includes&nbsp;<strong>salpingectomy or salpingostomy</strong>, performed either through laparoscopy or laparotomy.</p>\n<p>Management of suspected ruptured ectopic pregnancy consists of initial resuscitation and stabilization, followed by point-of-care ultrasound (FAST) to identify intraperitoneal free fluid and surgical exploration.&nbsp;</p>\n<p><strong>Laparotomy</strong> is done for hemodynamically unstable patients with&nbsp;ruptured ectopic pregnancies. <strong>Salpingectomy</strong> is the treatment of choice and is done&nbsp;with preservation of the ipsilateral ovary and its vascular supply.&nbsp;</p>\n<p>For patients wishing to preserve future fertility, if the <strong>contralateral fallopian tube is damaged,</strong> <strong>salpingostomy</strong> is preferred.&nbsp;However, salpingostomy may result in inadequate evacuation of the products of conception and a recurrence of symptoms. Therefore, after a patient undergoes salpingostomy, it is important check the &beta;-hCG level on a weekly basis to ensure that it reaches zero.</p>\n<p>The image given below shows a laparoscopic visualization of a tubal pregnancy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ade4711de19b4383aa47bff2bf455563x762x568.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9da06348c73d4b139727994a9e507662x1280x2077.JPEG"
    ]
  },
  {
    "text": "Match the following criteria used for the diagnosis of ectopic pregnancy:",
    "choices": [
      {
        "id": 1,
        "text": "1-A, 2-C, 3-B"
      },
      {
        "id": 2,
        "text": "2-B, 3-A, 4-C"
      },
      {
        "id": 3,
        "text": "1-B, 2-C, 4-A"
      },
      {
        "id": 4,
        "text": "1-C, 2-A, 3-B"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<table style=\"height: 160px;\" width=\"296\">\n<tbody>\n<tr>\n<td style=\"width: 140px;\"><strong>Ectopic pregnancy</strong></td>\n<td style=\"width: 140px;\"><strong>Criteria</strong></td>\n</tr>\n<tr>\n<td style=\"width: 140px;\">Abdominal</td>\n<td style=\"width: 140px;\">Studdiford</td>\n</tr>\n<tr>\n<td style=\"width: 140px;\">Cervical</td>\n<td style=\"width: 140px;\">Rubin</td>\n</tr>\n<tr>\n<td style=\"width: 140px;\">Ovarian</td>\n<td style=\"width: 140px;\">&nbsp;Spiegelberg</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Spiegelberg&rsquo;s</strong> criteria used for the diagnosis of <strong>ovarian </strong>pregnancy<strong>&nbsp;</strong>include intact ipsilateral tube, pregnancy occupying ovary connected by the utero-ovarian ligament.</p>\n<p><strong>Studdiford&rsquo;s</strong> criteria used for the diagnosis of <strong>primary abdominal</strong> pregnancy include the presence of normal bilateral tubes and pregnancy related to the peritoneal surface.</p>\n<p><strong>Rubin's</strong> criteria used for the diagnosis of <strong>cervical</strong> pregnancy includes presence of soft, enlarged cervix and closed internal os and partially opened external os.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An O-ve primigravida underwent surgery for ectopic pregnancy at 13 weeks of gestation. What will be the dose of anti-D immunoglobulin to be given to her?",
    "choices": [
      {
        "id": 1,
        "text": "300 \u03bcg"
      },
      {
        "id": 2,
        "text": "75 \u03bcg"
      },
      {
        "id": 3,
        "text": "100 \u03bcg"
      },
      {
        "id": 4,
        "text": "150 \u03bcg"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Anti-D is given at a dose of<strong> 300\u00a0\u03bcg</strong>\u00a0intramuscularly for alloimmunization after surgical management of ectopic pregnancy.</p>\n<p>The dose of anti-D in a surgically treated case of ectopic is<strong> 50 \u03bcg</strong> if gestation <strong>&lt;12 weeks</strong>. If the gestation is <strong>&gt;12 weeks</strong>, <strong>300 \u03bcg</strong> of anti-D is given intramuscularly.\u00a0</p>\n<p>Anti-D is not given when the ectopic is treated with medical methods.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old female patient (G2P0A1) with a history of FSH therapy and in vitro fertilization presented with lower abdominal pain, vomiting, and vaginal discharge. On examination, she was hemodynamically stable. Transvaginal ultrasound showed a viable intrauterine pregnancy of 8\u2009weeks associated with a heterogeneous right adnexal mass showing a positive bagel sign. What is the most appropriate management?",
    "choices": [
      {
        "id": 1,
        "text": "Methotrexate"
      },
      {
        "id": 2,
        "text": "MTP"
      },
      {
        "id": 3,
        "text": "Surgery"
      },
      {
        "id": 4,
        "text": "Expectant management"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Methotrexate is not to be given as it harms even the normal intrauterine fetus. Although potassium chloride may be injected into the sac of the ectopic, the safer method would be surgery to remove the ectopic.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d68fb43424834fb09b1f219fa3ca26b4x1280x1432.JPEG"
    ]
  },
  {
    "text": "Methotrexate was administered to a patient with unruptured ectopic pregnancy. At what serum beta hCG levels will this drug be most effective?",
    "choices": [
      {
        "id": 1,
        "text": "<7000 IU/L"
      },
      {
        "id": 2,
        "text": "<5000 IU/L"
      },
      {
        "id": 3,
        "text": "<6000 IU/L"
      },
      {
        "id": 4,
        "text": "<10000 IU/L"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Methotrexate is most effective when given at <strong>&beta; hCG levels </strong>are<strong> &lt;5000 IU/L</strong>.</p>\n<p>Methotrexate is given at a dose of <strong>50 mg/m<sup>2 </sup></strong>of body surface area. Monitoring is done by measuring&nbsp;<strong>&beta; hCG levels</strong> on days 4 and 7. If the decline is&nbsp;<strong>&ge;15% </strong>of the initial value, the patient is <strong>followed up weekly</strong> till the levels fall to &lt;10 IU/L. If the decline is <strong>&lt;15%</strong>, a <strong>2<sup>nd</sup> dose</strong> of methotrexate is given on day 7.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Studdiford\u2019s criteria is used for the diagnosis of _____________",
    "choices": [
      {
        "id": 1,
        "text": "Ovarian pregnancy"
      },
      {
        "id": 2,
        "text": "Cervical pregnancy"
      },
      {
        "id": 3,
        "text": "Tubal pregnancy"
      },
      {
        "id": 4,
        "text": "Abdominal pregnancy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Studdiford&rsquo;s criteria</strong> is used for the diagnosis of primary<strong> abdominal pregnancy.</strong></p>\n<p>Primary abdominal pregnancy is the <strong>rarest</strong> type of ectopic gestation. The conceptus implants on the <strong>peritoneal surface</strong> of the abdomen.</p>\n<p>Studdiford&rsquo;s criteria:</p>\n<ol>\n<li>The presence of normal bilateral tubes and ovaries with no evidence of recent or past pregnancy.</li>\n<li>No evidence of a uteroperitoneal fistula.</li>\n<li>The presence of pregnancy, related exclusively to the peritoneal surface, early enough to eliminate the possibility of secondary implantation</li>\n</ol>\n<p>Criteria used in the diagnosis of ectopic pregnancy are:</p>\n<ul>\n<li><strong>Cervical pregnancy</strong>: Paalman and McElin (clinical criteria); Rubin's criteria (histological criteria)</li>\n<li><strong>Ovarian pregnancy</strong>: Spiegelberg&rsquo;s criteria</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '18 Ectopic Pregnancy';
        const quizFilename = '18-ectopic-pregnancy-9fa3d2c3.html';
        let hierarchy = ["Marrow", "qBank", "Obstetrics & Gynecology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>