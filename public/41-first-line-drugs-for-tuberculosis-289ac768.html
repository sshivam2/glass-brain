<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>41 First Line Drugs For Tuberculosis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pharmacology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">21</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A 35-year-old lady presents with pulmonary TB is started on anti-tubercular therapy. What is the rationale for administering multi-drug therapy to her?",
    "choices": [
      {
        "id": 1,
        "text": "To delay development of resistance"
      },
      {
        "id": 2,
        "text": "To reduce toxicity"
      },
      {
        "id": 3,
        "text": "To broaden antimicrobial spectrum"
      },
      {
        "id": 4,
        "text": "To prevent toxin release from the organism"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The reason for administering <strong>multi-drug therapy</strong> in tuberculosis is to <strong>prevent</strong>\u00a0the <strong>development</strong> of <strong>resistance.</strong></p>\n<p><strong>Resistance</strong> to individual drugs in <em>Mycobacterium tuberculosis</em> occurs by <strong>spontaneous point mutations</strong>\u00a0that occur at a low but predictable rate (10<sup>-7 </sup>to 10<sup>-10 </sup>). Development of this drug resistance is almost invariably the<strong> result of monotherapy,\u00a0</strong>i.e., the failure of the health care provider to prescribe at least 2 drugs to which the tubercle bacilli are susceptible. Hence, multi-drug therapy is recommended for the treatment of tuberculosis.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which is the most effective drug against extracellular mycobacteria?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Rifampicin"
      },
      {
        "id": 3,
        "text": "Pyrazinamide"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most effective</strong> drug against extracellular mycobacteria is <strong>Rifampicin</strong>.&nbsp;</p>\n<p>Option A: Isoniazid and Rifampicin act against both intracellular and extracellular&nbsp;mycobacterium. But, Rifampicin&nbsp;inhibits the extracellular&nbsp;mycobacteria at much lower drug concentrations than isoniazid.</p>\n<p>Option B: Pyrazinamide acts only against <strong>intracellular</strong> mycobacterium.</p>\n<p>Option C: Ethambutol acts against only&nbsp;<strong>extracellular</strong> mycobacteria but is <strong>not as effective</strong> as rifampicin. It is a&nbsp;<strong>bacteriostatic</strong> drug.&nbsp;Fast-multiplying bacteria are highly susceptible to its action.&nbsp;</p>\n<p>Note:&nbsp;<strong>Streptomycin </strong>is primarily&nbsp;active against only the<strong>&nbsp;extracellular </strong>tubercle bacilli as its penetration into the cells is very poor.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient was diagnosed with pulmonary tuberculosis and was started on first-line antitubercular drugs. Which of the following drug acts by inhibiting the synthesis of the marked layer shown in the image?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Rifampicin"
      },
      {
        "id": 3,
        "text": "Pyrazinamide"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Isoniazid</strong> is the first-line antitubercular drug that acts by inhibiting the synthesis of&nbsp;<strong>mycolic acid</strong>.</p>\n<p><strong>Isoniazid</strong> is a first-line bactericidal drug that is used for the treatment of tuberculosis. This drug enters bacilli by <strong>passive diffusion</strong>. It then gets activated to its toxic form by the enzyme <strong>catalase-peroxidase</strong>(the enzyme encoded by the <strong>Kat gene</strong>).</p>\n<p>Normally, InhA and KasA are involved in the synthesis of mycolic acid. Upon activation, the reactive metabolite of isoniazid forms complexes with <strong>NAD</strong> that inhibit <strong>InhA</strong> and <strong>KasA</strong>. Hence, isoniazid inhibits the production of <strong>mycolic acid</strong>.</p>\n<p>The reactive isoniazid metabolite also forms complexes with <strong>NADP</strong>. This complex inhibits mycobacterial dihydrofolate reductase which results in the interruption of <strong>DNA synthesis</strong>.</p>\n<p>Side effects of isoniazid include:</p>\n<ul>\n<li><strong>Peripheral neuritis</strong> due to interference with the production of active coenzyme pyridoxal phosphate from pyridoxine. Therefore, <strong>pyridoxine 10mg/day (vitamin B6)</strong> is given prophylactically along with isoniazid to prevent neurotoxicity.</li>\n<li><strong>Hepatitis</strong> - isoniazid must be stopped at the first sign of hepatotoxicity.</li>\n<li>Rashes</li>\n<li>Anaemia</li>\n<li>Arthralgia</li>\n</ul>\n<p>Toxicity of isoniazid results in <strong>metabolic acidosis</strong>,&nbsp;<strong>seizures, and coma.</strong></p>\n<p>Other options:</p>\n<p>Option B:&nbsp;Rifampin acts by binding to <strong>DNA-dependent RNA polymerase</strong> to form a stable drug-enzyme complex. This complex suppresses RNA synthesis. Side effects of rifampin are hepatitis,<strong>&nbsp;flu-like illness, orange-red colored urine</strong>, and body secretions.</p>\n<p>&nbsp;Option C: Pyrazinamide is a prodrug, it is converted into an active metabolite<strong> pyrazinoic acid </strong>which makes the intracellular environment <strong>acidic</strong> and collapses the transmembrane proton motive force, thereby killing the bacteria. Side effects include&nbsp;<strong>hyperuricemia</strong> and hepatotoxicity.&nbsp;</p>\n<p>Option D: Ethambutol<strong> inhibits arabinose transferase III, </strong>thereby decreasing arabinogalactan biosynthesis<strong>. </strong>This results in&nbsp;disruption in&nbsp;mycobacterial cell wall synthesis.&nbsp;<strong>Optic neuritis</strong> is an important side effect of<strong> ethambutol</strong>. It results in decreased visual acuity and&nbsp;<strong>loss of red-green discrimination.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ebe55c0cc99a42b383d1f16c8023a2ff.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A study was conducted to genotype NAT2 gene polymorphisms in patients receiving ATT. Among the 300 patients genotyped, 200 were slow acetylators (group A), 70 were intermediate (group B) and 30 were fast acetylators (group C). Patients in group A are prone to develop which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Failure of therapy"
      },
      {
        "id": 2,
        "text": "Peripheral neuropathy"
      },
      {
        "id": 3,
        "text": "Hepatotoxicity"
      },
      {
        "id": 4,
        "text": "Allergic reactions"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Isoniazid,&nbsp;</strong>a key agent in the ATT,<strong>&nbsp;</strong>is metabolized primarily through<strong> N-acetylation</strong> by the genetically polymorphic N-acetyltransferase-2 <strong>(NAT2) </strong>enzyme. <strong>Slow acetylators</strong>&nbsp;(group A) of isoniazid are prone to develop <strong>peripheral neuropathy</strong>.</p>\n<p class=\"p1\">The rate of metabolism of isoniazid is determined by the genetic polymorphism of NAT2 enzyme and&nbsp;classified broadly into two groups -&nbsp;<strong>slow </strong>and<strong> fast acetylators</strong>.</p>\n<p class=\"p1\">In&nbsp;<strong>slow acetylators, </strong>the drug <strong>accumulates </strong>due to slow metabolism resulting in<strong>&nbsp;</strong>an increased risk of<strong>&nbsp;side effects, </strong>and hence they should undergo periodic monitoring. Peripheral neuropathy is a more frequent side effect of INH when compared to hepatotoxicity.</p>\n<p class=\"p1\"><strong>Fast acetylators</strong>&nbsp;metabolize the drug rapidly and <strong>show less response </strong>to standard doses and the therapy may be less effective.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Line probe assay done on sputum sample of a patient with TB revealed over-expression of InhA gene. This can lead to cross-resistance of isoniazid with which of the following drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Rifampicin"
      },
      {
        "id": 2,
        "text": "Ethionamide"
      },
      {
        "id": 3,
        "text": "Cycloserine"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Over-expression of the gene for <strong>InhA </strong>leads to <strong>cross-resistance</strong> of isoniazid (INH) with <strong>ethionamide</strong>.&nbsp;</p>\n<table style=\"height: 132px; width: 653.667px;\">\n<tbody>\n<tr style=\"height: 52.6667px;\">\n<td style=\"width: 212px; height: 52.6667px;\" colspan=\"2\"><strong>Mechanisms of INH resistance</strong></td>\n</tr>\n<tr style=\"height: 62px;\">\n<td style=\"width: 212px; height: 62px;\">Mutation of&nbsp;KatG&nbsp;</td>\n<td style=\"width: 425.667px; height: 62px;\">\n<ul>\n<li>most common&nbsp;mechanism</li>\n<li>confers a high level&nbsp;of resistance</li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 62px;\">\n<td style=\"width: 212px; height: 62px;\"><strong>Overexpression of&nbsp;InhA</strong></td>\n<td style=\"width: 425.667px; height: 62px;\">\n<ul>\n<li>confers a&nbsp;<strong>low level of resistance&nbsp;</strong></li>\n<li><strong>cross-resistance with ethionamide</strong></li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 45px;\">\n<td style=\"width: 212px; height: 45px;\">Overexpression of&nbsp;ahpC</td>\n<td style=\"width: 425.667px; height: 45px;\">\n<ul>\n<li>increases the bacterial survival under&nbsp;oxidative stress</li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 45px;\">\n<td style=\"width: 212px; height: 45px;\">Induction of efflux pumps</td>\n<td style=\"width: 425.667px; height: 45px;\">\n<ul>\n<li>cross-resistance with ethambutol</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 4-month-old boy was brought to the ER with recurrent seizures. His mother informs you that he is receiving isoniazid prophylaxis as she was diagnosed with TB during pregnancy. ABG revealed a high anion gap metabolic acidosis. What would be the mainstay of treatment?",
    "choices": [
      {
        "id": 1,
        "text": "Benzodiazepines"
      },
      {
        "id": 2,
        "text": "Barbiturates"
      },
      {
        "id": 3,
        "text": "Pyridoxine"
      },
      {
        "id": 4,
        "text": "Thiamine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of <strong>isoniazid overdose&nbsp;</strong>for which the mainstay of treatment is <strong>intravenous pyridoxine</strong>.</p>\n<p><strong>Isoniazid</strong> overdose results in decreased pyridoxine availability to neurons.&nbsp;This&nbsp;<strong>decreases</strong> the levels of <strong>GABA</strong>, which in turn lowers the seizure threshold. <strong>Benzodiazepines</strong>&nbsp;can be used to control<strong>&nbsp;seizures.</strong></p>\n<p>Prolonged treatment&nbsp;with isoniazid&nbsp;leads to the <strong>deficiency of pyridoxine</strong> which can lead to <strong>peripheral neuropathy&nbsp;</strong>and other neurological manifestations like ataxia, paresthesia, and numbness.</p>\n<p>Clinical triad of isoniazid overdose:</p>\n<ul>\n<li><span class=\"fontstyle0\"><strong>Seizures</strong> refractory to treatment with phenytoin and barbiturates</span></li>\n<li><span class=\"fontstyle0\">High anion gap metabolic acidosis (<strong>HAGMA</strong>) resistant to treatment with sodium bicarbonate</span></li>\n<li><span class=\"fontstyle0\">Coma</span></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old man undergoing treatment for TB visits your OPD for follow-up. His wife states that recently he is forgetting the names of his colleagues and neighbors, but later recollects them correctly. Which drug is implicated to cause this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ethionamide"
      },
      {
        "id": 2,
        "text": "Isoniazid"
      },
      {
        "id": 3,
        "text": "Ethambutol"
      },
      {
        "id": 4,
        "text": "Pyrazinamide"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Isoniazid </strong>is the antitubercular drug that is implicated in the causation of <strong>transient memory loss.</strong></p>\n<p><strong>Neurological toxicities</strong> like peripheral neuropathy, optic neuritis, and seizures can occur with isoniazid therapy. It is also associated with abnormalities like:</p>\n<ul>\n<li>Euphoria</li>\n<li>Transient memory loss</li>\n<li>Separation of ideas and reality</li>\n<li>Loss of self-control</li>\n<li>Florid psychosis</li>\n</ul>\n<p><strong>Pyridoxine </strong>therapy can&nbsp;<strong>prevent&nbsp;</strong>and&nbsp;<strong>reverse&nbsp;</strong>most of the neurological toxicity and mental abnormalities.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 66-year-old woman, on anti-tubercular therapy, presented with pain in the right hand and shoulder for the past 1 month. On physical examination, her wrist was swollen and her shoulder was extremely painful with a limited range of motion. Which drug is most likely associated with this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Levofloxacin"
      },
      {
        "id": 2,
        "text": "Isoniazid"
      },
      {
        "id": 3,
        "text": "Rifampin"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical presentation is suggestive of&nbsp;<strong>shoulder-hand syndrome&nbsp;</strong>which&nbsp;is associated with the use of <strong>isoniazid</strong>.</p>\n<p>This syndrome is characterized by&nbsp;<strong>painful arthropathy </strong>in the&nbsp;<strong>upper extremity joints</strong>. It can also present as&nbsp;generalized arthropathy.</p>\n<p>Other drugs&nbsp;that can cause shoulder-hand syndrome are <strong>phenobarbitone</strong> and <strong>phenytoin</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Before initiating treatment for a sputum-positive TB patient, the physician orders for Cartridge Based Nucleic Acid Amplification Test in order to test for drug resistance. Which anti-tubercular drug resistance is he checking for?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Rifampicin"
      },
      {
        "id": 3,
        "text": "Pyrazinamide"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The Cartridge Based-Nucleic Acid Amplification Test (<strong>CBNAAT</strong>) is a molecular test for tuberculosis that detects the\u00a0DNA of tubercle bacilli <strong>within 2 hours</strong> and mutations in the <strong>rpoB</strong> <strong>gene</strong> responsible for\u00a0<strong>rifampicin resistance.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following rifamycin drugs would you advise a patient to take on an empty stomach?",
    "choices": [
      {
        "id": 1,
        "text": "Rifabutin and rifapentine"
      },
      {
        "id": 2,
        "text": "Rifabutin and rifampicin"
      },
      {
        "id": 3,
        "text": "Rifampicin only"
      },
      {
        "id": 4,
        "text": "Rifapentine only"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Rifampicin </strong>should be advised to be taken on an empty stomach because<strong> f</strong><strong>ood decreases its absorption.&nbsp;</strong></p>\n<p>Rifabutin absorption is not altered by food.</p>\n<p><strong>Rifapentine</strong> absorption is enhanced by fatty food and hence it is recommended to be taken <strong>with food.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An HIV-positive patient on ART with zidovudine, lamivudine, and indinavir develops pulmonary tuberculosis. Which of the following anti-tubercular drugs should be avoided in him?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Rifampicin"
      },
      {
        "id": 3,
        "text": "Streptomycin"
      },
      {
        "id": 4,
        "text": "Ethambutol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Rifampicin </strong>should be avoided as it is a potent<strong> inducer of CYP enzymes </strong>including CYPs 1A2, 3A4, 2C9, and 2C19, which in turn\u00a0can <strong>induce </strong>the<strong> metabolism of indinavir</strong> and results in <strong>therapeutic failure of ART.</strong></p>\n<p><strong>Rifabutin\u00a0</strong>causes the <strong>least induction</strong> of cytochrome enzymes and is therefore\u00a0<strong>preferred in HIV patients</strong> who are <strong>on protease inhibitors/NNRTIs.</strong></p>\n<p>Cytochrome enzyme-inducing potency of rifamycins is: <strong>rifampicin &gt; rifapentine &gt; rifabutin.</strong></p>\n<p>Note:\u00a0</p>\n<table style=\"border-collapse: collapse; width: 44.9183%; height: 255.984px;\" border=\"1\">\n<tbody>\n<tr style=\"height: 22.3984px;\">\n<td style=\"width: 20.2543%; height: 22.3984px; text-align: center;\">Cytochrome p-450 inducers</td>\n<td style=\"width: 79.7457%; height: 22.3984px; text-align: center;\">Cytochrome p-450 inhibitors</td>\n</tr>\n<tr style=\"height: 233.586px;\">\n<td style=\"width: 20.2543%; height: 233.586px;\">\n<ul>\n<li>Barbiturates</li>\n<li>Carbamazepine</li>\n<li>Rifampin</li>\n<li>Phenytoin</li>\n<li>Aminoglutethimide</li>\n<li>Cigarette smoking</li>\n<li>Chronic alcoholism</li>\n</ul>\n</td>\n<td style=\"width: 79.7457%; height: 233.586px;\">\n<ul>\n<li>Macrolide antibiotics</li>\n<li>Azole antifungals</li>\n<li>Chloramphenicol</li>\n<li>Omeprazole</li>\n<li>Selective serotonin reuptake inhibitors (SSRIs)</li>\n<li>HIV protease inhibitors</li>\n<li>Cimetidine</li>\n<li>Ciprofloxacin</li>\n<li>Metronidazole</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following rifamycins is not used for mycobacterial infections?",
    "choices": [
      {
        "id": 1,
        "text": "Rifampicin"
      },
      {
        "id": 2,
        "text": "Rifaximin"
      },
      {
        "id": 3,
        "text": "Rifapentine"
      },
      {
        "id": 4,
        "text": "Rifabutin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Rifaximin</strong>&nbsp;is not used for mycobacterial infections. It is a<strong> synthetic </strong>rifamycin that is <strong>poorly absorbed from the GIT</strong> and is indicated in the management of GI conditions like:&nbsp;</p>\n<ul>\n<li>Traveler&rsquo;s diarrhea</li>\n<li>Irritable bowel syndrome with diarrhea</li>\n<li>Hepatic encephalopathy</li>\n</ul>\n<p>Rifamycins indicated in mycobacterial infections are&nbsp;rifampicin, rifapentine, and rifabutin.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A Gene Xpert test was conducted on the sputum sample of a patient with suspected TB. The results were positive and showed resistance to rifampicin. What is the primary mechanism of resistance against this drug?",
    "choices": [
      {
        "id": 1,
        "text": "Alteration in target enzyme"
      },
      {
        "id": 2,
        "text": "Induction of efflux pumps"
      },
      {
        "id": 3,
        "text": "Alteration in activation pathway"
      },
      {
        "id": 4,
        "text": "Drug inactivating enzymes"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Rifampicin resistance is primarily due to<strong> alteration in the target enzyme</strong>.&nbsp;</p>\n<p>Rifampicin acts by binding to the &beta; subunit of<strong> DNA-dependent RNA polymerase </strong>(rpoB) and inhibits chain formation in RNA synthesis. Rifampicin is a <strong>potent inducer </strong>of cytochrome enzymes<strong>&nbsp;</strong>CYP3A4, CYP1A2, CYP2C9, and CYP2C19. Alteration of the target enzyme (rpoB) by a mutation in the gene coding for rpoB is the primary mechanism of resistance to rifampicin.&nbsp;Gene Xpert&nbsp;identifies mutations in the<strong>&nbsp;rpoB&nbsp;gene</strong> to&nbsp;detect rifampicin resistance.</p>\n<p class=\"p1\">Efflux pump induction has also been demonstrated as a mechanism of rifampicin resistance.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following conditions can rifampicin be used?",
    "choices": [
      {
        "id": 1,
        "text": "1, 3 and 5"
      },
      {
        "id": 2,
        "text": "2 and 4 only"
      },
      {
        "id": 3,
        "text": "1, 3, 4 and 5"
      },
      {
        "id": 4,
        "text": "1, 2, 3 and 5"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Besides its anti-tubercular action, rifampicin also has certain <strong>non-tubercular uses</strong> which include:</p>\n<ul>\n<li><strong>Prophylaxis</strong> of meningococcal and<em> H. influenzae</em> meningitis</li>\n<li>Treatment of<strong> MRSA</strong>, <strong>diphtheroid</strong>, and <strong>legionella</strong> infections&nbsp;</li>\n<li>Eradication of <strong>staphylococcal nasal carrier state</strong> in patients with chronic furunculosis</li>\n<li>A combination of doxycycline and rifampicin is used as the first-line therapy for<strong> brucellosis</strong></li>\n<li>A part of the WHO regimen for standard therapy of&nbsp;both paucibacillary and multibacillary&nbsp;<strong>leprosy</strong></li>\n</ul>\n<p>Rifampicin is not used in the treatment of Nocardia species. <strong>Cotrimoxazole&nbsp;</strong>is considered the drug of choice for pleuropulmonary nocardiosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are prescribing first-line anti-tubercular therapy to a patient newly diagnosed with TB. Which of the following is incorrect about his therapy?",
    "choices": [
      {
        "id": 1,
        "text": "Red green color impairment is an early sign of ethambutol induced optic neuritis"
      },
      {
        "id": 2,
        "text": "Ethambutol accumulates in renal failure"
      },
      {
        "id": 3,
        "text": "Flu-like syndrome is usually seen if rifampicin is taken on a daily basis"
      },
      {
        "id": 4,
        "text": "Hyperuricemia is a recognised side effect of pyrazinamide"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Flu-like syndrome</strong> is usually seen when rifampicin is administered<strong> less than twice weekly </strong>(high dose)<strong>&nbsp;</strong>and it is uncommon when administered daily (lower dose)<strong>.</strong></p>\n<p>Flu-like syndrome, characterized by fevers, chills, malaise, and arthralgia is a known <strong>dose-dependent</strong> adverse effect of rifampicin therapy and tends to occur late into the patient's treatment course. It resolves with either discontinuation of rifampin or switching to a daily-dose regimen. It can often be confused with occult infections or treatment failure.&nbsp;</p>\n<p>Options A and B: Red-green colour impairment is one of the <strong>early</strong> signs of <strong>ethambutol-induced optic neuritis</strong>. Ethambutol is primarily excreted unchanged by kidneys and accumulation occurs in renal failure.&nbsp;<strong>Ethambutol</strong> does not undergo hepatic metabolism and can be&nbsp;<strong>safely</strong> prescribed for the treatment of TB in patients<strong>&nbsp;</strong>with <strong>hepatitis</strong>.</p>\n<p>Option D: <strong>Pyrazinamide</strong> interferes with urate excretion and can result in <strong>hyperuricemia</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young woman undergoing treatment for tuberculosis visits your OPD for a routine checkup. She informs you that recently she has noticed an orange-colored discoloration of her contact lenses. Which of the following drugs is most likely to be responsible for this?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Pyrazinamide"
      },
      {
        "id": 3,
        "text": "Ethambutol"
      },
      {
        "id": 4,
        "text": "Rifampicin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Rifampicin </strong>is the drug most likely to cause orange-colored discoloration of contact lenses in this case.</p>\n<p>Drugs like rifampicin and rifabutin are known to cause <strong>reddish-orange discoloration </strong>of the<strong> skin, urine, </strong>feces, saliva, sweat, and <strong>tears </strong>(which can stain the patient's <strong>contact lenses</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are planning to start treatment in a middle-aged man diagnosed with pulmonary tuberculosis. He has a history of chronic kidney disease and his current creatinine clearance is 25 mL/min. Which of the following drugs is least likely to require dose modification?",
    "choices": [
      {
        "id": 1,
        "text": "Ethambutol"
      },
      {
        "id": 2,
        "text": "Streptomycin"
      },
      {
        "id": 3,
        "text": "Rifampicin"
      },
      {
        "id": 4,
        "text": "Isoniazid"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Rifampicin&nbsp;</strong>is the<strong> least likely</strong> drug to require dose modification in renal failure patients as it&nbsp;is <strong>metabolized</strong>&nbsp;in the<strong>&nbsp;liver&nbsp;</strong>and<strong>&nbsp;</strong>primarily<strong> excreted in bile</strong>.&nbsp;</p>\n<p>In patients with renal failure, the <strong>half-life</strong> of <strong>isoniazid</strong> will be <strong>prolonged</strong>, but its adverse effects are not significantly increased. Hence dose modification is not usually done for isoniazid in clinical practice as a&nbsp;reduction in dose may render the regimen ineffective and increase the chances of resistance.</p>\n<p><strong>Ethambutol </strong>and<strong> streptomycin</strong> are primarily excreted unchanged <strong>through </strong>the<strong> renal </strong>system and need dose modification in renal failure.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Pseudojaundice is an adverse effect of which of the following drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Phenytoin"
      },
      {
        "id": 2,
        "text": "Rifabutin"
      },
      {
        "id": 3,
        "text": "Pyrazinamide"
      },
      {
        "id": 4,
        "text": "Isoniazid"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Pseudojaundice</strong> is an adverse effect of&nbsp;<strong>rifabutin</strong>. It resolves on discontinuation of the drug.</p>\n<p>Unique adverse effects of rifabutin are:</p>\n<ul>\n<li>Polymyalgia/arthralgia</li>\n<li>Pseudojaundice</li>\n<li>Anterior uveitis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Mycobacterium tuberculosis nicotinamidase is involved in the activation of which of the following antitubercular drug?",
    "choices": [
      {
        "id": 1,
        "text": "Isoniazid"
      },
      {
        "id": 2,
        "text": "Ethambutol"
      },
      {
        "id": 3,
        "text": "Pyrazinamide"
      },
      {
        "id": 4,
        "text": "Cycloserine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Mycobacterium tuberculosis<strong> nicotinamidase </strong>is&nbsp;involved in the activation of<strong> pyrazinamide.</strong></p>\n<p>Nicotinamidase which is produced by <em>M. tuberculosis </em>is&nbsp;also called <strong>pyrazinamidase</strong>. It is encoded by the <strong>pncA gene</strong> and its mutations are associated with pyrazinamide resistance. It converts pyrazinamide to active pyrazinoic acid.</p>\n<p>Pyrazinoic acid has the following actions:</p>\n<ul>\n<li>Inhibition of fatty acid synthetase type 1 leads to interference in mycolic acid synthesis</li>\n<li>Reduction of intracellular pH</li>\n<li>Disruption of membrane transport</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 47-year-old man on treatment for TB presents with complaints of severe pain and swelling in his left great toe since today morning, as shown in the image below. Which of the following drugs is most likely to cause this?",
    "choices": [
      {
        "id": 1,
        "text": "1 and 2"
      },
      {
        "id": 2,
        "text": "2, 3 and 4"
      },
      {
        "id": 3,
        "text": "2 and 4"
      },
      {
        "id": 4,
        "text": "1, 3 and 5"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical history and findings of first metatarsophalangeal joint swelling are suggestive of an <strong>acute episode of gout.</strong> Antitubercular drugs that are most likely to cause <strong>hyperuricemia</strong>&nbsp;and precipitate gout are&nbsp;<strong>pyrazinamide </strong>and<strong> ethambutol</strong>.</p>\n<p>Both pyrazinamide and ethambutol <strong>inhibit uric acid excretion</strong> in the kidney causing hyperuricemia.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9889e56dc3f147bb8d75b6bca6f81bc5.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 33-year-old woman receiving treatment for TB presents to your OPD with complaints of blurry vision and pain on movement of the left eye for the past 2 days. Examination showed Marcus Gunn pupil. Which anti-tubercular drug is most likely associated with this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ethambutol"
      },
      {
        "id": 2,
        "text": "Isoniazid"
      },
      {
        "id": 3,
        "text": "Ethionamide"
      },
      {
        "id": 4,
        "text": "Cycloserine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical features along with Marcus Gunn pupil are suggestive of <strong>optic neuritis,&nbsp;</strong>which is a dose-dependent adverse effect associated with <strong>ethambutol</strong>.</p>\n<p>Optic neuritis&nbsp;resulting in <strong>decreased visual acuity</strong> and <strong>loss of red-green discrimination</strong> is the most serious adverse effect of ethambutol.&nbsp;It can be unilateral or bilateral and usually recovers when the drug is stopped.</p>\n<p>Tests of visual acuity and red-green discrimination&nbsp;before the start of therapy and periodically thereafter are recommended.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '41 First Line Drugs For Tuberculosis';
        const quizFilename = '41-first-line-drugs-for-tuberculosis-289ac768.html';
        let hierarchy = ["Marrow", "qBank", "Pharmacology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>