<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>64 The Breast - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pathology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">30</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following lesions does not arise from the terminal duct lobular unit of the breast?",
    "choices": [
      {
        "id": 1,
        "text": "Sclerosing adenosis"
      },
      {
        "id": 2,
        "text": "Blue dome cyst"
      },
      {
        "id": 3,
        "text": "Carcinoma breast"
      },
      {
        "id": 4,
        "text": "Periductal mastitis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Periductal mastitis</strong>&nbsp;arises from the <strong>large</strong> <strong>lactiferous ducts</strong>.</p>\n<p>It is also known as <strong>squamous metaplasia</strong> of lactiferous ducts,&nbsp;recurrent subareolar abscess, or <strong>Zuska disease</strong>.</p>\n<p>The<strong> terminal duct lobular unit </strong>(TDLU) is&nbsp;the basic functional and histopathological unit of the breast. Successive branching of large ducts eventually leads to the TDLU.&nbsp;Sclerosing adenosis, blue dome cyst, and carcinoma breast&nbsp;arise from the TDLU.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following lesions arise from the large ducts of the breast?",
    "choices": [
      {
        "id": 1,
        "text": "3 and 5"
      },
      {
        "id": 2,
        "text": "1 and 5"
      },
      {
        "id": 3,
        "text": "2 and 4"
      },
      {
        "id": 4,
        "text": "1 and 3"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Duct ectasia</strong> and&nbsp;<strong>Paget's</strong> disease&nbsp;arise from the <strong>large ducts</strong> of the breast.</p>\n<p>Normal anatomy of the breast includes ducts, lobules, and stroma. Successive branching of the large ducts eventually leads to the terminal duct lobular unit.</p>\n<p><strong>Atypical hyperplasia</strong> arises from the <strong>terminal ducts</strong> and lobules, whereas,&nbsp;<strong>fibroadenoma</strong> and&nbsp;<strong>phyllodes</strong> tumors arise from the <strong>intralobular stroma</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 28-year-old lactating mother presents with pain in her left breast. On examination, you notice her nipple is erythematous and tender with a purulent exudate. Which of the following is the most common cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Pseudomonas aeruginosa"
      },
      {
        "id": 2,
        "text": "Streptococcus viridans"
      },
      {
        "id": 3,
        "text": "Streptococcus pneumoniae"
      },
      {
        "id": 4,
        "text": "Staphylococcus aureus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario is suggestive of <strong>acute mastitis. </strong>The most common cause of acute mastitis is<strong>&nbsp;<em>Staphylococcus aureus</em></strong>.</p>\n<p>Acute bacterial mastitis typically occurs during the <strong>1st month of breastfeeding </strong>(lactational breast abscess). It is caused by a local bacterial infection when the breast is most vulnerable due to cracks and fissures in the nipples.</p>\n<p>Staphylococcal acute mastitis typically results in&nbsp;<strong>localized abscesses</strong>.</p>\n<p>Option A: Breast abscess caused by <em>Pseudomonas aeruginosa</em> is uncommon, only a few cases have been documented in immunocompromised patients.</p>\n<p>Options B and C:&nbsp;Streptococcal infections tend to spread throughout the breast in the form of <strong>cellulitis</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following diseases is most strongly associated with a history of smoking?",
    "choices": [
      {
        "id": 1,
        "text": "Granulomatous mastitis"
      },
      {
        "id": 2,
        "text": "Fat necrosis"
      },
      {
        "id": 3,
        "text": "Periductal mastitis"
      },
      {
        "id": 4,
        "text": "Carcinoma breast"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Periductal mastitis</strong>&nbsp;is strongly associated with a history of <strong>smoking</strong>.&nbsp;More than 90% of the affected individuals are smokers.&nbsp;</p>\n<p>Periductal mastitis is also called recurrent subareolar abscess or squamous metaplasia of lactiferous ducts or<strong> Zuska disease</strong>. In this condition, a&nbsp;relative <strong>deficiency of vitamin A</strong> associated with smoking or toxic substances in tobacco smoke alters the differentiation of the ductal epithelium.</p>\n<p>Histologically, there is&nbsp;keratinizing<strong> squamous metaplasia </strong>of the nipple ducts. Keratin shed from these cells is trapped and plugs (<strong>keratin</strong> <strong>plug</strong>) the ductal system, causing dilation and eventually rupture of the duct. This results in keratin spillage into the surrounding periductal tissue forming a&nbsp;<strong>chronic granulomatous </strong>inflammatory response.</p>\n<p>It presents with a painful erythematous subareolar mass that clinically <strong>mimics bacterial abscess</strong>. It&nbsp;has&nbsp;a high recurrence rate.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cce8b05b5a774bb68f4c0aacbfbede00x1280x2244.JPEG"
    ]
  },
  {
    "text": "A 30-year-old woman presented with a painless palpable lump in her left breast. She had sustained a traumatic blow to her left breast 1 month back. Mammography showed a radiolucent cystic lesion with rimmed calcification. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphocytic mastopathy"
      },
      {
        "id": 2,
        "text": "Sclerosing adenosis"
      },
      {
        "id": 3,
        "text": "Fat necrosis"
      },
      {
        "id": 4,
        "text": "Hyalinized fibroadenoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Note:</strong>&nbsp;Calcifications are seen on mammography in the following conditions -</p>\n<ul>\n<li>Apo&shy;crine cysts</li>\n<li>Hyalinized fibroadenomas</li>\n<li>Sclerosing adenosis</li>\n<li>Duct ectasia&nbsp;</li>\n<li>Breast carcinoma- shows <strong>irregular densities</strong>&nbsp;and small, numerous, clustered calcification (<strong>microcalcifications</strong>).</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dc7a21d3c4f84155b98928926dd960ebx766x599.JPEG"
    ]
  },
  {
    "text": "Which of the following is a proliferative breast lesion?",
    "choices": [
      {
        "id": 1,
        "text": "Papilloma"
      },
      {
        "id": 2,
        "text": "Cysts"
      },
      {
        "id": 3,
        "text": "Mild hyperplasia"
      },
      {
        "id": 4,
        "text": "Adenosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Papillomas</strong> are classified under <strong>proliferative </strong>breast diseases<strong> without atypia</strong>.</p>\n<p>Proliferative breast lesions without atypia are not clonal and usually have <strong>no genetic changes</strong>. Thus they are predictors of risk but are not true precursors of carcinoma.</p>\n<p><strong>Benign</strong> <strong>epithelial lesions</strong> are classified into <strong>three groups</strong>, according to the subsequent risk of developing breast cancer. These are:</p>\n<div class=\"page\" title=\"Page 1052\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li>Non-proliferative breast changes</li>\n<li>Proliferative breast disease without atypia</li>\n<li>Atypical hyperplasia</li>\n</ul>\n<p>Note:<strong>&nbsp;</strong>Lobular carcinoma in situ (<strong>LCIS</strong>) has recently been classified as a&nbsp;<strong>benign</strong>&nbsp;lesion with associated risk for developing carcinoma in the future but not as a malignancy capable of metastases.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All of the following lesions are proliferative breast lesions without atypia except:",
    "choices": [
      {
        "id": 1,
        "text": "Duct ectasia"
      },
      {
        "id": 2,
        "text": "Radial scar"
      },
      {
        "id": 3,
        "text": "Sclerosing adenosis"
      },
      {
        "id": 4,
        "text": "Florid hyperplasia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Duct ectasia</strong> is a<strong> non-proliferative</strong> breast change.</p>\n<p>Radial scar, sclerosing adenosis, and florid hyperplasia belong to proliferative breast lesions without atypia.</p>\n<p>Proliferative breast lesions without atypia are not clonal and are not commonly found to have genetic changes. Thus they are predictors of risk but unlikely to be true precursors of carcinoma.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common clinical presentation seen in patients with duct papilloma?",
    "choices": [
      {
        "id": 1,
        "text": "Retraction of nipple"
      },
      {
        "id": 2,
        "text": "Painless lump"
      },
      {
        "id": 3,
        "text": "Bloody nipple discharge"
      },
      {
        "id": 4,
        "text": "Eczema and itching of nipple"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most common clinical presentation seen in patients with duct papilloma is <strong>nipple discharge</strong>.&nbsp;More than 80% of large duct papillomas produce a nipple discharge.&nbsp;</p>\n<p>Papillomas grow within a <strong>dilated duct</strong> and are composed of multiple branching <strong>fibrovascular cores</strong>. It can be serous or bloody.</p>\n<ul>\n<li><strong>Serous </strong>discharge - due to&nbsp;<strong>intermittent blockage</strong> and release of normal breast secretions or irritation of the duct by the papilloma</li>\n<li><strong>Bloody</strong> discharge - due to <strong>torsion</strong> of the stalk, causing infarction</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young man presents to your clinic with the following finding. Which of the following is not associated with this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Klinefelter syndrome"
      },
      {
        "id": 2,
        "text": "Seminoma"
      },
      {
        "id": 3,
        "text": "Sertoli cell tumor"
      },
      {
        "id": 4,
        "text": "Alcohol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image given depicts <strong>gynecomastia</strong>. Seminoma is not a cause of this condition.</p>\n<p>Gynecomastia occurs due to increased estrogenic action.&nbsp;The most<strong> common causes </strong>of gynecomastia include:&nbsp;</p>\n<ul>\n<li>Cirrhosis of the liver</li>\n<li><strong>Alcohol</strong></li>\n<li>Marijuana, heroin</li>\n<li>Antiretroviral therapy</li>\n<li>Anabolic steroids</li>\n<li><strong>Klinefelter</strong> syndrome (XXY karyotype)</li>\n<li>Functioning testicular neoplasms such as Leydig cell or <strong>Sertoli cell tumors</strong></li>\n</ul>\n<p>Microscopically, there is an increase in the&nbsp;<strong>dense collagenous connective tissue</strong>. It is associated with <strong>epithelial hyperplasia</strong> of the duct lining with characteristic tapering micro-papillae.&nbsp;Lobule formation is almost never observed.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/69b11b2abeca4296b36144a4664333b8.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A biopsy was performed on a female patient who presented with a lump in her right breast. Presence of which of the following findings is not associated with an increased risk of cancer?",
    "choices": [
      {
        "id": 1,
        "text": "Florid hyperplasia"
      },
      {
        "id": 2,
        "text": "Fibroadenoma with complex features"
      },
      {
        "id": 3,
        "text": "Sclerosing adenosis"
      },
      {
        "id": 4,
        "text": "Apocrine change"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Apocrine change</strong> does not increase<strong>&nbsp;</strong>the risk of cancer as it is a <strong>non-proliferative</strong> change.</p>\n<p>Moderate or florid hyperplasia, fibroadenoma with complex features, and sclerosing adenosis are classified under <strong>proliferative disease without atypia </strong>with a <strong>1.5- to 2-fold</strong> increased risk of carcinoma.</p>\n<p>Both breasts are at increased risk, although the risk to the ipsilateral breast may be slightly higher.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While undergoing a routine mammogram, a 45-year-old woman was found to have clusters of microcalcification in her right breast. A needle biopsy was done and revealed the following. Which of the following markers can be used to rule out invasive disease?",
    "choices": [
      {
        "id": 1,
        "text": "ER"
      },
      {
        "id": 2,
        "text": "HER2"
      },
      {
        "id": 3,
        "text": "p53"
      },
      {
        "id": 4,
        "text": "p63"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Note:<strong>&nbsp;</strong>Lobular carcinoma in situ (<strong>LCIS</strong>) has recently been classified as a&nbsp;<strong>benign</strong>&nbsp;lesion with associated risk for developing carcinoma in the future but not as a malignancy capable of metastases.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4007c1159d974bc7a4a8b7ce50dfd0be.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ccc4cedd6e2d420c84ef6301ba80d5ebx1280x963.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cd8f38e081c046c29716f0aa29ff7d37x1280x962.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/60fc5ddd85aa4e38857a3277fb3e63a0x1280x1883.JPEG"
    ]
  },
  {
    "text": "A 55-year-old woman presents with persistent soreness and itching in her right nipple. On examination, the following finding is noted. What would be the next best step in her management?",
    "choices": [
      {
        "id": 1,
        "text": "Prescribe antibiotics"
      },
      {
        "id": 2,
        "text": "Biopsy of the nipple"
      },
      {
        "id": 3,
        "text": "Prescribe cortisone cream"
      },
      {
        "id": 4,
        "text": "Observation and follow-up"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given scenario showing a red eczematous rash over the areola of the breast is suggestive of&nbsp;<strong>Paget's disease of the nipple</strong>. The next best step in management is <strong>biopsy</strong> of the nipple.</p>\n<p>Paget's disease <strong>can be mistaken for eczema,</strong> and hence, <strong>biopsy</strong> of the nipple should be the initial management of choice.&nbsp;Paget cells are readily detected by nipple biopsy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f749fa70d62444a09a90ded5f0517081.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Histopathological examination of a middle-aged woman who presented with redness and itching over the nipple of her left breast is given below. Which of the following statements is incorrect about her condition?",
    "choices": [
      {
        "id": 1,
        "text": "The cells are ER positive"
      },
      {
        "id": 2,
        "text": "Underlying carcinoma is poorly differentiated"
      },
      {
        "id": 3,
        "text": "Prognosis depends on the underlying carcinoma"
      },
      {
        "id": 4,
        "text": "The cells show overexpression of HER2"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>It presents as a unilateral<strong> erythematous </strong>eruption with a <strong>scale crust.</strong>&nbsp;A palpable mass is seen in about half the patients with this disease.</p>\n<p>The underlying carcinomas are usually <strong>poorly differentiated</strong>, ER-negative, and <strong>overexpress HER2</strong>. The <strong>prognosis</strong> of Paget's disease <strong>depends on</strong> the features of the <strong>underlying carcinoma</strong>.</p>\n<p>Paget's disease may mimic the following conditions:</p>\n<ul>\n<li><strong>Eczema</strong> (clinical appearance) - can be differentiated by the presence of malignant cells on biopsy</li>\n<li>Superficial spreading <strong>melanoma</strong> (histological appearance) -&nbsp;Paget's cells are PAS-positive and<strong> diastase resistant </strong>unlike melanoma cells&nbsp;</li>\n</ul>\n<p>Note: Paget's disease of the bone is a distinct condition that results in abnormal bone metabolism due to&nbsp;osteoclastic overactivity.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d7d6fb4afe8b40d39a78b3626298c17f.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/64572bcadadf45e7a721e9ff018f1e4fx720x578.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/acf7c2f954974629b26b3de72f6976d8x1279x1197.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a risk factor for breast cancer?",
    "choices": [
      {
        "id": 1,
        "text": "Dense breast"
      },
      {
        "id": 2,
        "text": "Post-menopausal obesity"
      },
      {
        "id": 3,
        "text": "Early pregnancy"
      },
      {
        "id": 4,
        "text": "Early menarche"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Early full-term pregnancy (younger than 20 years) is <strong>protective</strong> against breast cancer. It<strong> halves the risk</strong>&nbsp;of developing breast cancer compared to that of nulliparous women.</p>\n<p>Women with very <strong>dense breasts</strong> on <strong>mammography</strong> have a <strong>four- to six-fold</strong> higher risk of both ER-positive and ER-negative breast cancer compared to women with low density.</p>\n<p>Obese women under the age of 40 years have a decreased risk as a result of anovulatory cycles and lower progesterone levels. In contrast, <strong>postmenopausal obese women </strong>are at&nbsp;an<strong> increased risk</strong>, which is attributed to the synthesis of estrogens in fat depots.</p>\n<p><strong>Early menarche</strong>, late menopause, and nulliparity are risk factors of breast cancer due to <strong>hyperestrogenemia</strong>. Exercise and breastfeeding are protective against breast cancer.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common site of carcinoma in the breast?",
    "choices": [
      {
        "id": 1,
        "text": "Upper inner quadrant"
      },
      {
        "id": 2,
        "text": "Upper outer quadrant"
      },
      {
        "id": 3,
        "text": "Lower outer quadrant"
      },
      {
        "id": 4,
        "text": "Subareolar region"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The<strong> upper outer quadrant </strong>is the most common site of carcinoma in the breast.</p>\n<p>Approximately 50% of carcinomas are located in the upper outer quadrant, 10% in each of the remaining quadrants, and about 20% in the central or subareolar region.</p>\n<div class=\"page\" title=\"Page 20\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>A <strong>palpable mass</strong> is the most common clinical sign of <strong>invasive breast carcinoma</strong>.</p>\n<p><strong>Triple assessment</strong>&nbsp;is recommended for the diagnosis of any palpable breast lump. It includes:&nbsp;</p>\n<ul>\n<li><strong>Clinical</strong> examination</li>\n<li><strong>Radiological</strong> assessment (mammography/USG)</li>\n<li><strong>Pathological</strong> assessment (FNAC/biopsy)</li>\n</ul>\n<p><strong>Techniques of palpation</strong> for breast examination are:</p>\n<ol>\n<li>Vertical strip/lines pattern</li>\n<li>Circular pattern</li>\n<li>Wedges or radial spokes pattern</li>\n</ol>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f291e205b3a8431ea4c4b9099ed3d902x600x1384.JPEG"
    ]
  },
  {
    "text": "On which of the following chromosomes is the BRCA2 gene located?",
    "choices": [
      {
        "id": 1,
        "text": "Chromosome 13"
      },
      {
        "id": 2,
        "text": "Chromosome 11"
      },
      {
        "id": 3,
        "text": "Chromosome 17"
      },
      {
        "id": 4,
        "text": "Chromosome 12"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Single gene mutations associated with familial breast cancer can be categorized into:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">High penetrance germline mutations (&gt;4 fold increased risk) - <strong>BRCA1</strong>, <strong>BRCA2</strong>, TP53, PTEN, STK11, CDH I, PALPB2</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Moderate penetrance germline mutations (2-4 fold increased risk) - <strong>ATM</strong>, <strong>CHEK2</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Immunohistochemical testing was performed on a biopsy sample taken from a patient with breast cancer. It revealed lack of expression of ER, PR, and HER2. Which of the following genes is most commonly mutated in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "RET"
      },
      {
        "id": 2,
        "text": "MYC"
      },
      {
        "id": 3,
        "text": "TP53"
      },
      {
        "id": 4,
        "text": "PIK3CA"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given scenario is suggestive of <strong>triple-negative breast cancer</strong> (ER-negative, PR-negative, and HER2-negative). <strong>TP53</strong> is the most commonly mutated gene in triple-negative breast cancer (TNBC).</p>\n<p>Common gene mutations in the 3 major molecular types of invasive breast carcinoma are:</p>\n<table style=\"width: 492.656px;\">\n<tbody>\n<tr>\n<td style=\"width: 171px;\"><strong>Molecular Subtype</strong></td>\n<td style=\"width: 302.656px;\"><strong>Common gene mutations</strong></td>\n</tr>\n<tr>\n<td style=\"width: 171px;\">Luminal (ER+/HER2-)</td>\n<td style=\"width: 302.656px;\">\n<p>Luminal A: PIK3CA (more common), TP53</p>\n<p>Luminal B: PIK3CA (more common), TP53</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 171px;\">HER2 Positive (HER 2+)</td>\n<td style=\"width: 302.656px;\">TP53 (more common),&nbsp;PIK3CA</td>\n</tr>\n<tr>\n<td style=\"width: 171px;\">TNBC (ER-/ HER2-)</td>\n<td style=\"width: 302.656px;\">TP53 (more common),&nbsp;PIK3CA</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 44-year-old woman has been diagnosed with breast carcinoma. Immunohistochemistry staining of a tissue biopsy specimen of this patient is given below. Which of the following statements is true regarding her condition?",
    "choices": [
      {
        "id": 1,
        "text": "BRCA 1 mutation is most probable"
      },
      {
        "id": 2,
        "text": "It is not associated with tP53 mutations"
      },
      {
        "id": 3,
        "text": "Poor response to paclitaxel"
      },
      {
        "id": 4,
        "text": "Good response to trastuzumab"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Note: At least <strong>10%</strong> of luminal type A breast cancers express <strong>tp53</strong> mutations. <strong>tP53</strong> mutations are associated with <strong>triple-negative</strong> tumors as well.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7d879eb7d4604defbbddd0e5222189bd.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a5487734d1a34540b922a6d360f48c3ax720x341.JPEG"
    ]
  },
  {
    "text": "Immunohistochemistry test of a breast cancer patient was reported negative for ER and HER2. This molecular subtype includes all of the following except:",
    "choices": [
      {
        "id": 1,
        "text": "Secretory carcinoma"
      },
      {
        "id": 2,
        "text": "Spindle cell carcinoma"
      },
      {
        "id": 3,
        "text": "Adenoid cystic carcinoma"
      },
      {
        "id": 4,
        "text": "Mucinous carcinoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Carcinomas with immunohistochemistry<strong> ER and HER2/\u03bd negative</strong> are all of the above <strong>except</strong> mucinous carcinomas. Mucinous carcinomas are usually <strong>ER-positive and HER2/neu negative</strong> (luminal A type)</p>\n<p><strong>ER-negative</strong>,<strong> HER2-negative</strong> (triple-negative) molecular subtype commonly includes the following<strong>\u00a0histological subtypes</strong>:</p>\n<ul>\n<li>Medullary</li>\n<li>Adenoid cystic</li>\n<li>Secretory</li>\n<li>Metaplastic</li>\n<li>Spindle cell</li>\n<li>Squamous</li>\n<li>Matrix-producing</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Patients with all of the following conditions have ER-positive and HER2-negative tumors except:",
    "choices": [
      {
        "id": 1,
        "text": "Lobular carcinoma"
      },
      {
        "id": 2,
        "text": "Tubular carcinoma"
      },
      {
        "id": 3,
        "text": "Mucinous carcinoma"
      },
      {
        "id": 4,
        "text": "Secretory carcinoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>ER-positive</strong>, <strong>HER2-negative</strong> status on immunohistochemistry is suggestive of the\u00a0<strong>luminal type</strong> of breast carcinoma, which does not include secretory carcinoma.\u00a0</p>\n<p>The ER-positive, HER2-negative molecular subtype (<strong>luminal type</strong>) commonly includes the following histological subtypes:</p>\n<ul>\n<li>Well and poorly differentiated <strong>lobular</strong> carcinoma</li>\n<li><strong>Tubular</strong> carcinoma</li>\n<li><strong>Mucinous</strong> carcinoma</li>\n<li>Papillary carcinoma</li>\n</ul>\n<p><strong>Secretory</strong> <strong>carcinomas</strong> are usually ER-negative and Her2/neu negative (<strong>basal type</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following breast cancers most commonly presents as an occult primary carcinoma?",
    "choices": [
      {
        "id": 1,
        "text": "Micropapillary carcinoma"
      },
      {
        "id": 2,
        "text": "Mucinous carcinoma"
      },
      {
        "id": 3,
        "text": "Medullary carcinoma"
      },
      {
        "id": 4,
        "text": "Lobular carcinoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Lobular carcinoma </strong>is the most common type of breast carcinoma to present as an <strong>occult primary</strong> carcinoma.</p>\n<p>Lobular carcinoma of the breast\u00a0is seen<strong> bilaterally</strong> and with <strong>multicentricity</strong>.\u00a0<strong>Loss of E-cadherin </strong>is the <strong>hallmark</strong> of lobular carcinoma. They also have characteristic patterns of metastatic spread, often involving the peritoneum and retroperitoneum, leptomeninges (carcinomatous meningitis), gastrointestinal tract, ovaries, and uterus.</p>\n<p>The histological hallmark of lobular carcinoma is the presence of discohesive infiltrating tumor cells, often arranged in a\u00a0<strong>single Indian file</strong>\u00a0<strong>pattern</strong> or in loose clusters or sheets.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c29d7fe1ba1b4ffa921f7e1d9ed1ad43x1280x1253.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a feature of lobular breast carcinoma?",
    "choices": [
      {
        "id": 1,
        "text": "Often bilateral"
      },
      {
        "id": 2,
        "text": "Multicentricity within the same breast"
      },
      {
        "id": 3,
        "text": "Loss of E-cadherin"
      },
      {
        "id": 4,
        "text": "Extensive desmoplasia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Note: </strong>Individuals with heterozygous germline mutations in CDH1 (<strong>loss of E-cadherin</strong>) also have a greatly increased risk of <strong>gastric signet-ring cell carcinoma</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/81c745e29c1a433b85c60766411f425ex1280x1398.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/48cd7ae153ed4a4caaa68be83a1e2eb3x1280x1399.JPEG"
    ]
  },
  {
    "text": "A 53-year-old woman with breast cancer is found to have TNM staging of T4dN0M0. Which of the following statements is true regarding her condition?",
    "choices": [
      {
        "id": 1,
        "text": "There is loss of e-cadherin expression"
      },
      {
        "id": 2,
        "text": "It has a relatively favorable prognosis"
      },
      {
        "id": 3,
        "text": "There is obstruction of dermal lymphatics by neoplastic cells"
      },
      {
        "id": 4,
        "text": "History of trauma to the breast is usually present"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>T4d</strong> in the TNM staging of carcinoma breast points toward a diagnosis of <strong>inflammatory breast carcinoma</strong>.&nbsp;It&nbsp;shows extensive invasion and proliferation of tumor cells within the <strong>dermal lymphatics</strong>&nbsp;leading to&nbsp;<strong>obstruction</strong>.</p>\n<p>Inflammatory breast cancer is the <strong>most aggressive </strong>subtype of breast cancer. The hallmark of this condition is the&nbsp;<strong>overexpression&nbsp;</strong>of&nbsp;<strong>e-cadherin.&nbsp;</strong>This results in increased tumor cohesion and the formation of tumoral clumps which can result in emboli. It has a&nbsp;particularly <strong>poor prognosis</strong>.</p>\n<div class=\"page\" title=\"Page 70\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>These tumors are usually of <strong>high grade</strong>&nbsp;but do not belong to any particular molecular subtype.&nbsp;More than half (60%) are <strong>ER-negative</strong> and 40% to 50% <strong>overexpress HER2</strong>. There is no association with trauma.</p>\n<p>Due to lymphatic obstruction, it results in&nbsp;brawny induration, erythema with a raised edge, and edema called&nbsp;<strong>peau d&rsquo;orange</strong> appearance. This <strong>may</strong>&nbsp;<strong>mimic&nbsp;</strong>non-neoplastic inflammatory lesions like&nbsp;<strong>mastitis</strong>.&nbsp;A breast lump may or may not be present.&nbsp;</p>\n<p>The following image shows<strong>&nbsp;</strong>a<strong>&nbsp;</strong>peau d&rsquo;orange appearance of the right breast.</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a256683c4da546c28c6f5ed35f48c8fbx720x405.PNG"
    ]
  },
  {
    "text": "Immunohistochemistry for HER2 protein expression is performed in 3 patients with breast carcinoma, with the following results. Which of the following patients should be subjected to fluorescence in-situ hybridization?",
    "choices": [
      {
        "id": 1,
        "text": "Patient A"
      },
      {
        "id": 2,
        "text": "Patient C"
      },
      {
        "id": 3,
        "text": "Patients B and C"
      },
      {
        "id": 4,
        "text": "Patients A and C"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The following are classified as <strong>HER2-positive tumors</strong>:</p>\n<ul>\n<li>Tumors that show <strong>3+</strong> staining on IHC (here <strong>FISH</strong> is <strong>not needed</strong>).</li>\n<li>Tumors with 2+ staining on IHC, followed by HER2-gene amplification confirmed by FISH</li>\n</ul>\n<p>Once HER2-positive status is confirmed, targeted therapy against HER2 can be initiated with <strong>trastuzumab</strong> or <strong>lapatinib</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4a0f5ca3d9de45089698a89e77d04c36.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e7eadae9aaf1403399eadaa2ef3cc625x1280x1252.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4cb27d72e8614595ae8b4e0ce2a8d0dex1280x1323.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5d1f88f168044be7a084c2f861fe2a7cx1280x1322.JPEG"
    ]
  },
  {
    "text": "A middle-aged woman is diagnosed with low-grade mucinous carcinoma of the breast. IHC showed HER2 overexpression and a low Ki67 index. Which of the following would be considered as a poor prognostic factor?",
    "choices": [
      {
        "id": 1,
        "text": "Low grade"
      },
      {
        "id": 2,
        "text": "Low Ki67 index"
      },
      {
        "id": 3,
        "text": "Her2 overexpression"
      },
      {
        "id": 4,
        "text": "Mucinous carcinoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>HER2 overexpression</strong>&nbsp;in a patient with carcinoma breast is associated with <strong>poor survival</strong>.</p>\n<p>The main importance of HER2 status is as a <strong>predictor of response to agents</strong> that target this receptor.</p>\n<p>Prognostic and predictive factors in breast carcinoma:</p>\n<table style=\"height: 38px; width: 406.28125px;\">\n<tbody>\n<tr>\n<td style=\"width: 156px;\">&nbsp;</td>\n<td style=\"width: 336px;\"><strong>Good prognosis</strong></td>\n<td style=\"width: 174.28125px;\"><strong>Bad prognosis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Extent and spread</strong></td>\n<td style=\"width: 336px;\">\n<p>In situ carcinoma</p>\n</td>\n<td style=\"width: 174.28125px;\">Invasive carcinoma\n<p>Locally advanced disease</p>\n<p>Lymphovascular invasion</p>\n<p>Distant metastasis</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Size</strong></td>\n<td style=\"width: 336px;\">Size &lt;1 cm</td>\n<td style=\"width: 174.28125px;\">Size &gt;2 cm</td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Histological subtype</strong></td>\n<td style=\"width: 336px;\">\n<p>Tubular carcinoma</p>\n<p><strong>Mucinous carcinoma</strong></p>\n<p>Lobular carcinoma</p>\n<p>Papillary carcinoma</p>\n<p>Adenoid cystic carcinoma</p>\n</td>\n<td style=\"width: 174.28125px;\">\n<p>Metaplastic carcinoma</p>\n<p>Micropapillary carcinoma</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Histologic grade</strong></td>\n<td style=\"width: 336px;\"><strong>Low grade</strong></td>\n<td style=\"width: 174.28125px;\">High grade</td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Molecular subtype</strong></td>\n<td style=\"width: 336px;\">Luminal A subtype</td>\n<td style=\"width: 174.28125px;\">Her2-enriched and basal subtype</td>\n</tr>\n<tr>\n<td style=\"width: 156px;\"><strong>Proliferation rate </strong>(Ki67 index &amp; mitotic counts)</td>\n<td style=\"width: 336px;\"><strong>Low proliferation rate</strong></td>\n<td style=\"width: 174.28125px;\">High proliferation rate</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old woman on cyclosporin-A following renal transplantation developed multiple bilateral breast lumps that regressed after cessation of treatment. \u200bHer biopsy finding is shown below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Fat necrosis"
      },
      {
        "id": 2,
        "text": "Phyllodes tumour"
      },
      {
        "id": 3,
        "text": "Fibroadenoma"
      },
      {
        "id": 4,
        "text": "Sclerosing adenosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Fibroadenomas are the <strong>most common benign tumor</strong> of the female breast. Nearly 2/3 cases are associated with mutations in the\u00a0<span data-sheets-value=\"{&quot;1&quot;:2,&quot;2&quot;:&quot;Based on the update from the 10th edition of Robins, Two-thirds of fibroadenomas harbor driver mutations in MED12. The pathogenesis of the remainder is uncertain. &quot;}\" data-sheets-userformat=\"{&quot;2&quot;:829,&quot;3&quot;:{&quot;1&quot;:0},&quot;5&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;6&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;7&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;8&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;11&quot;:4,&quot;12&quot;:0}\"><strong>MED12 gene</strong>.</span></p>\n<p>They are frequently <strong>multiple</strong> and <strong>bilateral</strong> and usually occur in women <strong>&lt;30 years</strong> of age. They are solid, well-defined, highly mobile masses (also known as <strong>breast mice</strong>).</p>\n<p>Fibroadenomas can be classified into 2 types:</p>\n<ul>\n<li>Without complex features - classified as a non-proliferative condition</li>\n<li>With <strong>complex features</strong> -\u00a0\n<ul>\n<li>Associated with\u00a0<strong>cysts</strong> &gt; 0.3 cm, <strong>sclerosing adenosis</strong>, epithelial <strong>calcifications</strong>, or papillary <strong>apocrine change</strong></li>\n<li>Classified as\u00a0proliferative changes without atypia</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/85be1ad826824ed0b1929fb36fce2c70.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/59706c2784594562a658aa87182c4b16x1280x1154.JPEG"
    ]
  },
  {
    "text": "A 58-year-old woman presented with a large, rapidly growing painless breast lump. On examination, a smooth, multinodular breast lump was noticed. Microscopic examination of the core biopsy sample is shown below. Which of the following is an incorrect statement regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphatic spread is rare"
      },
      {
        "id": 2,
        "text": "Stromal cellularity is increased next to the epithelium"
      },
      {
        "id": 3,
        "text": "Absence of epithelial elements suggests malignancy"
      },
      {
        "id": 4,
        "text": "Both epithelial and stromal components can metastasize"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Phyllodes tumor is&nbsp;a fibroepithelial tumor arising from the<strong> intralobular stroma</strong>. It presents as a smooth,&nbsp;<strong>rapidly growing</strong>, multinodular, <strong>painless</strong> breast lump that is usually palpable. It most commonly presents in the 6th decade of life and is associated with:</p>\n<ul>\n<li>Gain in chromosome 1q</li>\n<li>HOXB13 overexpression</li>\n</ul>\n<p>Phyllodes tumors show&nbsp;<strong>stromal</strong> <strong>cellularity</strong> next to the epithelium (<strong>subepithelial </strong>or<strong> periepithelial&nbsp;</strong>regions). This feature helps to&nbsp;differentiate it from intracanalicular fibroadenoma.</p>\n<p>The prognosis of phyllodes tumors depends on their histological grade. Most phyllodes tumors are low grade, with limited stromal cellularity. They recur only occasionally and do not metastasize.</p>\n<p>The features of <strong>malignant</strong>&nbsp;(intermediate and high grade) phyllodes tumors are:</p>\n<ul>\n<li>Markedly increased stromal cellularity</li>\n<li>Stromal overgrowth -&nbsp;<strong>absence</strong> of <strong>epithelial elements&nbsp;</strong></li>\n<li>Nuclear atypia</li>\n<li>Increased mitosis (&gt;10/ 10 hpf)&nbsp;</li>\n<li>Highly recurrent</li>\n</ul>\n<p>Regardless of the grade,<strong> lymphatic spread</strong> is <strong>rare</strong> in phyllodes tumors. Hence, axillary lymph node dissection is contraindicated.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/572ace13db5d45b0a4fbde9d1aa20fa0.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/94b8d72885fe4266ab30e00cf6853627x1280x1153.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e634d489478f456f8c268ce427283a16x1280x1276.JPEG"
    ]
  },
  {
    "text": "What is the most common stromal malignancy in the breast?",
    "choices": [
      {
        "id": 1,
        "text": "Leiomyosarcoma"
      },
      {
        "id": 2,
        "text": "Liposarcoma"
      },
      {
        "id": 3,
        "text": "Angiosarcoma"
      },
      {
        "id": 4,
        "text": "Fibrosarcoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Angiosarcoma </strong>is the most common stromal malignancy in the breast.</p>\n<p>It arises in the <strong>interlobular stroma</strong> and accounts for &lt; 0.05% of breast malig\u00adnancies. It is a <strong>high-grade</strong> tumor with a\u00a0<strong>poor prognosis</strong>.\u00a0It can either be sporadic or occur in association with <strong>radiation therapy</strong>.\u00a0The mean age of affected individuals is <strong>35 years</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "BRCA-2 mutation does not predispose to the development of which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Renal cell carcinoma"
      },
      {
        "id": 2,
        "text": "Male breast cancer"
      },
      {
        "id": 3,
        "text": "Prostate cancer"
      },
      {
        "id": 4,
        "text": "Pancreatic cancer"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>BRCA-2 mutation</strong> does not predispose to the development of renal cell carcinoma.</p>\n<p>BRCA-2 mutation predisposes to the development of&nbsp;<strong>prostate</strong> and <strong>pancreatic</strong>&nbsp;cancer. It is also associated with an increased risk of <strong>male breast cancer</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old woman presents with a lump in the upper outer quadrant of her breast. Histopathological examination of the mass showed cells in mucin pools and faint nuclei. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Colloid carcinoma"
      },
      {
        "id": 2,
        "text": "Papillary carcinoma"
      },
      {
        "id": 3,
        "text": "Medullary carcinoma"
      },
      {
        "id": 4,
        "text": "Lobular carcinoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option D: Microscopic image of <strong>lobular carcinoma</strong> of the breast shows infiltrating small monomorphic discohesive tumor cells arranged in an&nbsp;<strong>Indian-file </strong>or <strong>single-file pattern</strong>&nbsp;is shown below.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a831220b913e403db15a907a1b52f9a8x1280x1142.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/65cca367fb6b4cb998cf9db0b09db25ax1280x1142.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/96d19a43136f49a38104a1cb77bcf09bx1280x1049.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/618a4a7601e84fe996c2ca3e543c30b8x1280x1048.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/529378204b254d588fea2cc28b5cf5fax1280x1224.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6c534f79aec54514a03858d5601eeedex1280x1253.JPEG"
    ]
  }
];
        let quizName = '64 The Breast';
        const quizFilename = '64-the-breast-7108cf93.html';
        let hierarchy = ["Marrow", "qBank", "Pathology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>