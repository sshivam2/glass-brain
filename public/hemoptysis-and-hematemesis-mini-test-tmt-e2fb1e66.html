<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hemoptysis And Hematemesis Mini Test - -Tmt - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2023-24
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "As a radiologist, you are evaluating a male patient who presented with severe hematemesis. Suspecting acute GI bleeding, you performed an endoscopy and a CT angiography, however, both tests were inconclusive. Following that, with the help of a Technetium 99m (99mTc) scintigraphy, you were able to locate the bleeding spot. What level of GI bleeding can be detected by a scintigraphic evaluation?",
    "choices": [
      {
        "id": 1,
        "text": "5 to 10 mL/min"
      },
      {
        "id": 2,
        "text": "0.05 to 0.1 mL/min"
      },
      {
        "id": 3,
        "text": "0.1 to 0.5 mL/min"
      },
      {
        "id": 4,
        "text": "1.0 to 5.0 mL/min"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A <strong>scintigraphic evaluation</strong> can detect bleeding rates up to <strong>0.1 to 0.5 mL/min.</strong></p>\n<p>Computed Tomography (CT) evaluation is performed in cases of acute gastrointestinal bleeding when <strong>endoscopy</strong> evaluation is either <strong>not clinically feasible</strong> or <strong>non-diagnostic.</strong></p>\n<p>The two CT methods used to evaluate GI bleeding specifically are <strong>CT angiography (CTA)</strong> and <strong>multiphase CT enterography.</strong></p>\n<p>CTA can be used to guide both radiological and surgical interventions. it is most useful in an <strong>emergency situation</strong> to rapidly identify a bleeding source before performing a therapeutic procedure.\u00a0<br />Multiphase CT enterography is typically used to evaluate GI bleeding in <strong>stable patients</strong> who have negative endoscopy and CTA results.</p>\n<p>If the above tests fail, a<strong>\u00a0technetium 99m (99mTc) scintigraphy</strong> may be performed which can detect bleeding rates as low as <strong>0.1 to 0.5 mL/min </strong>as compared to <strong>CT</strong> which can detect ranges from <strong>0.5 to 1.0 mL/min. </strong>(option A)</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During the calculation of Well's score in a patient with suspected DVT, the presence of hemoptysis would entail an addition of _____ to the score",
    "choices": [
      {
        "id": 1,
        "text": "2"
      },
      {
        "id": 2,
        "text": "1.5"
      },
      {
        "id": 3,
        "text": "1"
      },
      {
        "id": 4,
        "text": "3"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Hemoptysis</strong> is given a score of<strong> 1 </strong>according to the <strong>Modified Wells criteria.</strong></p>\n<div class=\"page\" title=\"Page 1957\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Modified Wells criteria for predicting pulmonary embolism:</strong></p>\n</div>\n</div>\n</div>\n</div>\n<table>\n<tbody>\n<tr>\n<td><strong>Signs/symptoms</strong></td>\n<td><strong>Score</strong></td>\n</tr>\n<tr>\n<td><strong>Clinical signs of DVT</strong></td>\n<td><strong>3</strong></td>\n</tr>\n<tr>\n<td>Diagnosis other than pulmonary embolism is less likely</td>\n<td>3</td>\n</tr>\n<tr>\n<td>Heart rate &gt;100 bpm</td>\n<td>1.5</td>\n</tr>\n<tr>\n<td>Immobilization for &gt;3 days or surgery in the last 4 weeks</td>\n<td>1.5</td>\n</tr>\n<tr>\n<td><strong>Past history of DVT/pulmonary embolism</strong></td>\n<td><strong>1.5</strong></td>\n</tr>\n<tr>\n<td><strong>Hemoptysis</strong></td>\n<td><strong>1</strong></td>\n</tr>\n<tr>\n<td>Malignancy</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>Modified Wells criteria:</p>\n<ul>\n<li>PE likely &gt;4</li>\n<li>PE unlikely &lt;or =4</li>\n</ul>\n<p>In the initial scenario, <strong>past history of DVT</strong> and positive <strong>Moses sign,</strong> which is a <strong>clinical sign seen in DVT</strong> patients, indicating calf pain/tenderness on applying direct pressure over calf muscles as shown below, the Modified Wells score will be <strong>(3+1.5= 4.5).\u00a0</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/e0c182908b084a868f2150d29fd40a58.GIF",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/151f5b72aad24a27a0eca9d7291741dax1279x1496.JPEG"
    ]
  },
  {
    "text": "Which of the following is used as a screening tool to assess the need for medical intervention in a patient with severe hematemesis?",
    "choices": [
      {
        "id": 1,
        "text": "Glasgow-Blatchford score"
      },
      {
        "id": 2,
        "text": "Rockall score"
      },
      {
        "id": 3,
        "text": "Forrest classification"
      },
      {
        "id": 4,
        "text": "Agatston score"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>Glasgow-Blatchford </strong>score is a screening tool used to assess the need for <strong>medical intervention</strong> such as a blood transfusion or endoscopic intervention in a patient with <strong>acute upper gastrointestinal (GI) bleeding</strong> like hematemesis.</p>\n<p>It incorporates the patient\u2019s blood urea, haemoglobin, blood pressure, and other clinical parameters.</p>\n<p>Other options:</p>\n<p>Option B: <strong>Rockall score</strong> uses clinical variables and findings of initial upper endoscopy to predict the risk of rebleeding and in-hospital mortality in patients with upper GI bleed.</p>\n<p>Option C: The <strong>Forrest classification</strong> is used for classifying the <strong>endoscopic</strong> appearance of <strong>bleeding peptic ulcers</strong>. It stratifies the risk of rebleeding based on observed stigmata of recent haemorrhage.</p>\n<p>Option D: <strong>Agatston score</strong> is a <strong>CT-based </strong>scoring system for reporting the severity of <strong>coronary artery calcifications.</strong> Cardiovascular mortality and the burden of atherosclerosis have been linked to the presence of coronary artery calcification.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old male patient presented with chest pain and hemoptysis following a trematode infection affecting the cystic spaces of the lungs. On further evaluation, peribronchial granulomatous lesions are seen. Which of the following trematodes is responsible for the above symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Paragonimus westermani"
      },
      {
        "id": 2,
        "text": "Clonorchis Sinensis"
      },
      {
        "id": 3,
        "text": "Fasciolopsis buski"
      },
      {
        "id": 4,
        "text": "Schistosoma mansoni"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario of a 40-year-old male patient, who presented with <strong>chest pain</strong> and <strong>hemoptysis</strong> following a trematode infection affecting the <strong>cystic spaces </strong>of the lungs with the presence of <strong>peribronchial granulomatous </strong>lesions, is suggestive of infection with <strong>Paragonimus westermani</strong> (oriental lung fluke).</p>\n<p>Adult worms of Paragonimus westermani live in the lungs as pairs in cystic spaces that communicate with bronchi. Their lifespan is up to 20 years in humans. <strong>Man</strong> is a definitive host. The first intermediate host is a <strong>freshwater snail </strong>while the second intermediate hosts are <strong>freshwater crabs and crayfishes. \u00a0</strong></p>\n<p>The infective form is <strong>metacercariae</strong> encysted in crabs and crayfish. Consumption of undercooked crabs and crayfish containing metacercaria is the mode of infection. Patients usually present with <strong>cough, chest pain,</strong> and <strong>hemoptysis.</strong> Chronic cases resemble <strong>pulmonary tuberculosis. Unembryonated eggs</strong> escape into the bronchi and are coughed up and voided in <strong>sputum</strong> or swallowed and passed in <strong>faeces.</strong></p>\n<p>The image below shows the reddish-brown <strong>egg-shaped </strong>adult worm of Paragonimus westermani.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/9349e652e39d41129d5e9cd2100216a7.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/758ada64e23c4977b7285558ab040a17x519x435.GIF"
    ]
  },
  {
    "text": "A patient diagnosed with non-small-cell lung cancer (NSCLC) was started on a monoclonal antibody that acts by inhibiting VEGF. Within a few months of using this drug, the patient developed severe, life-threatening hemoptysis. Which of the following drugs was likely to have been prescribed to the patient?",
    "choices": [
      {
        "id": 1,
        "text": "Ramucirumab"
      },
      {
        "id": 2,
        "text": "Bevacizumab"
      },
      {
        "id": 3,
        "text": "Aflibercept"
      },
      {
        "id": 4,
        "text": "Pembrolizumab"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Bevacizumab,</strong> an antibody that <strong>prevents angiogenesis</strong> by binding to the vascular endothelial growth factor <strong>(VEGF)</strong>, is associated with potentially <strong>life-threatening hemoptysis</strong> in non-small-cell lung cancer (NSCLC) patients.</p>\n<p>It is a <strong>humanized monoclonal IgG1 antibody</strong> that prevents VEGF from interacting with its receptors on the surface of <strong>endothelial cells </strong>and inhibits receptor signalling, which normally increases vascular permeability and angiogenesis.</p>\n<p>When bevacizumab is combined with <strong>paclitaxel</strong> and <strong>carboplatin</strong> for non-small cell lung cancer (NSCLC), the <strong>median survival</strong> is increased by approximately <strong>two months</strong>. A higher risk of <strong>pulmonary haemorrhage</strong> exists in patients with non-small-cell lung cancer who have <strong>cavitary lesions</strong> or who have experienced hemoptysis <strong>(\u22652.5 mL)</strong> within the last three months.</p>\n<p>Additionally, it slows the advancement of <strong>renal cell carcinoma (RCC), </strong>metastatic colorectal and ovarian cancer when combined with cytotoxic chemotherapy.\u00a0</p>\n<p>The adverse effects of bevacizumab include <strong>hypertension, thrombosis,</strong> proteinuria, and gastrointestinal perforations. Potential<strong> vascular damage</strong> and <strong>bleeding</strong> in lung cancer patients is a serious concern. Bevacizumab is <strong>contraindicated</strong> for patients with a history of <strong>hemoptysis,</strong> brain metastasis or bleeding diathesis.</p>\n<p>Other options:</p>\n<p>Option A: <strong>Ramucirumab</strong> is a human IgG1 monoclonal antibody that targets <strong>VEGFR2,</strong> preventing VEGFR ligand binding and thereby reducing ligand-induced activity in endothelial cells. It is used in combination with <strong>docetaxel</strong> to treat patients with metastatic non-small cell lung cancer (NSCLC). Adverse effects include <strong>hypertension</strong> and <strong>diarrhoea.</strong></p>\n<p>Option C: <strong>Aflibercept</strong> is a recombinant fusion protein that functions as a<strong> VEGF trap </strong>by sequestering VEGF using the VEGFR1-binding domain. It is used in treating <strong>metastatic colorectal cancer</strong></p>\n<p>Option D: <strong>Pembrolizumab</strong> is a humanized monoclonal IgG4\u03ba isotype antibody that prevents the interaction between <strong>programmed cell death protein 1</strong> <strong>(PD-1)</strong> and its ligands. It is used in the treatment of non-small cell lung cancer, either before or after chemotherapy with platinum. It is also used in the treatment of melanoma, urothelial cancer, Merkel cell carcinoma and Hodgkin lymphoma. Serious adverse events include <strong>pneumonitis, colitis</strong> and\u00a0<strong>hepatitis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Catamenial hemoptysis is seen in which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary embolism in pregnancy"
      },
      {
        "id": 2,
        "text": "Diffuse alveolar hemorrhage"
      },
      {
        "id": 3,
        "text": "Thoracic endometriosis syndrome"
      },
      {
        "id": 4,
        "text": "Pulmonary alveolar proteinosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Catamenial hemoptysis </strong>is\u00a0seen in a condition known as <strong>thoracic endometriosis syndrome (TES).</strong></p>\n<p>Thoracic endometriosis syndrome (TES) is the result of <strong>endometriosis</strong> within the <strong>lung parenchyma</strong> or on the <strong>diaphragm</strong> and <strong>pleural surfaces.</strong> This causes a variety of clinical and radiological manifestations, such as <strong>catamenial hemoptysis, catamenial pneumothorax, catamenial hemothorax </strong>and p<strong>ulmonary nodules.</strong></p>\n<p>Catamenial hemoptysis is characterised by <strong>cyclic pulmonary haemorrhage</strong> that coincides with the onset of <strong>female menstruation.</strong></p>\n<p>The mean age of presentation of thoracic endometriosis is<strong>\u00a0 35 years.</strong></p>\n<p>Three theories have been put forth to explain the mechanism of thoracic endometriosis These include <strong>coelomic metaplasia, retrograde</strong> menstruation followed by transperitoneal-trans diaphragmatic migration of endometrial tissue, and <strong>lymphatic</strong> or <strong>hematogenous</strong> embolisation from the pelvis or uterus.</p>\n<p>The gold standard for a definitive diagnosis of thoracic endometriosis is<strong> video-assisted thoracoscopic surgery (VATS).</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient was diagnosed with pseudohemoptysis. He was informed that the color of the sputum is due to a pigment produced by a microorganism. Which of the following pigments is responsible for this?",
    "choices": [
      {
        "id": 1,
        "text": "Pyocyanin"
      },
      {
        "id": 2,
        "text": "Pyorubin"
      },
      {
        "id": 3,
        "text": "Pyomelanin"
      },
      {
        "id": 4,
        "text": "Prodigiosin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Pseudohemoptysis</strong> is most commonly caused by <em><strong>Serratia marcescens</strong></em> due to the red pigment called <strong>prodigiosin.</strong></p>\n<p><strong>Serratia marcescens</strong> is a<strong> pleomorphic coccobacilli</strong>. It may grow in sputum after collection. They may mimic hemoptysis (pseudo hemoptysis) because they produce a <strong>non-diffusible</strong> red pigment called <strong>prodigiosin.</strong></p>\n<p><em>S. marcescens</em> <strong>contaminate</strong> <strong>intravenous fluids</strong>, surgical instruments, and antiseptic solutions. Therefore, they are one of the important causes of <strong>healthcare-associated</strong> infections.</p>\n<p>Other options:</p>\n<p><strong>Pyocyanin</strong>(option A) (<strong>bluish-green</strong> pigment), <strong>pyorubin</strong>(option B) (<strong>red </strong>pigment) and <strong>pyomelanin</strong>(option C) (<strong>brown </strong>pigment) are pigments produced by <strong><em>Pseudomonas</em> </strong>species.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A plague epidemic has broken out in a mountainous area. Patients complain of cough, chest pain, and hemoptysis. On examination, there was no evidence of lymph node involvement. Which of the following modes of transmission is most commonly associated with the type of plague seen in the above scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Bite of infected flea"
      },
      {
        "id": 2,
        "text": "Person to person spread"
      },
      {
        "id": 3,
        "text": "Bacteremic spread"
      },
      {
        "id": 4,
        "text": "Handling infected animals"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given scenario of a plague epidemic where patients present with respiratory symptoms like cough, chest pain, and hemoptysis with no involvement of lymph nodes is suggestive of <strong>pneumonic plague</strong>.<strong>\u00a0</strong>Pneumonic plague most commonly spreads from <strong>person to person</strong> via <strong>droplet infection.</strong>\u00a0</p>\n<p><strong>Plague</strong> is a <strong>zoonotic disease</strong> caused by <strong>Yersinia pestis.</strong> It is a gram-negative, non-motile, coccobacillus. It\u00a0occurs in <strong>3 clinical forms</strong> (in increasing order of severity): bubonic plague&lt; pneumonic plague&lt; septicemic plague</p>\n<p><strong>Bubonic plague- </strong>It<strong>\u00a0</strong>is the <strong>most common</strong> variety of the disease. It is named after the <strong>buboes </strong>meaning<strong> swollen lymph nodes,</strong>\u00a0which typically develop within a week after an<strong> infected flea bite (Xenopsylla cheopis).</strong> Other clinical features include sudden onset of fever and chills, headache, and fatigue. Bubonic plague <strong>cannot spread</strong> from person to person as the bacilli are locked up in the buboes and do not find a way or easy exit.</p>\n<p>The images below show a rat flea and bubo formation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/9a9f583f304344a094a1267310ccfd30.JPEG",
      "https://cdn1.dailyrounds.org/uploads/85d497b56f174d53bdb8cc426d2beb46.PNG"
    ]
  },
  {
    "text": "A 50-year-old man awakens in the postanesthesia care unit with paroxysms of coughing and hemoptysis following an uneventful endoscopic sinus surgery. What is the immediate step taken to manage this patient if he is conscious and alert?",
    "choices": [
      {
        "id": 1,
        "text": "Rapid-sequence induction"
      },
      {
        "id": 2,
        "text": "Raising the head end of the bed"
      },
      {
        "id": 3,
        "text": "Immediately\u00a0sedate the patient"
      },
      {
        "id": 4,
        "text": "Start on IV antihypertensive agents"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The immediate step taken to manage a conscious and alert patient experiencing cough and hemoptysis following an uneventful endoscopic sinus surgery is <strong>raising the head end of the bed.</strong></p>\n<p><strong>Bleeding</strong> after nose or throat surgery can be fatal. If the patient is <strong>awake</strong> and alert enough to cough and swallow without aspirating blood, the first priority should be to stop the bleeding as soon as possible.\u00a0Immediate measures include<strong> raising the head end of the bed </strong>to lower the arterial and venous pressures at the bleeding site.</p>\n<p>Any level of <strong>systolic hypertension</strong> should be vigorously treated with <strong>intravenous antihypertensive agents.</strong> In order to <strong>preserve airway reflexes, sedation</strong> should be <strong>avoided.</strong></p>\n<p>If the patient is <strong>not fully awake</strong>, the secretions may cause the patient to gag and cough, increasing venous pressure and worsening the bleeding. Furthermore, they may aspirate blood and other secretions. In such cases, the patient's airway should be secured immediately by an awake intubation or a <strong>rapid-sequence induction (RSI).</strong></p>\n<p>The steps of RSI are shown in the image below:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0b6f85d6eb354a269471823c03f88f1fx1280x2262.JPEG"
    ]
  },
  {
    "text": "A 45-year-old chronic alcoholic, with a history of binge drinking and multiple episodes of intense retching and vomiting, presents with hematemesis prompting suspicion of Mallory-Weiss tear. Which of the following endoscopic findings would be consistent with it?",
    "choices": [
      {
        "id": 1,
        "text": "Transmural perforation of the distal esophagus."
      },
      {
        "id": 2,
        "text": "Longitudincal mucosal tear near the gastroesophageal junction."
      },
      {
        "id": 3,
        "text": "Linear red streaks of dilated venules converging on the antrum"
      },
      {
        "id": 4,
        "text": "Aberrant vessel in the mucosa that bleeds from a mucosal defect"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario of a <strong>chronic alcoholic</strong> presenting with <strong>hematemesis</strong> following a history of <strong>binge drinking</strong> and multiple episodes of <strong>intense retching</strong> and <strong>vomiting</strong> is suggestive of <strong>Mallory-Weiss tear.</strong> It occurs due to a <strong>longitudinal mucosal tear</strong> near the <strong>gastroesophageal junction.</strong></p>\n<p>It is most commonly seen in alcoholics, following forceful vomiting, retching, coughing, or staining. The <strong>left gastric artery</strong> is the most common vessel to bleed. The investigation of choice is endoscopy.</p>\n<p>Management of Mallory Weiss tear</p>\n<ol>\n<li><strong>Conservative,</strong> as it is usually is self-limiting.</li>\n<li><strong>Endoscopic electrocoagulation</strong> or sclerosant therapy.</li>\n<li>Angiographic embolization - if endoscopy fails.</li>\n<li>High gastrotomy - if all these manoeuvres fail.</li>\n</ol>\n<p>Other options:</p>\n<p>Option A: <strong>Boerhaave syndrome</strong> is characterised by<strong> transmural perforation </strong>of the <strong>distal esophagus</strong> (while Mallory-Weiss tear is a mucosal tear). It generally occurs due to forceful vomiting against a <strong>closed glottis. </strong>It clinically presents with classical <strong>Mackler's triad</strong> of vomiting, chest pain, and subcutaneous emphysema.</p>\n<p>The lower esophagus towards the left pleural cavity is the most common perforation site. A <strong>crunching sound</strong> is heard during the auscultation of the chest <strong>(Hamman's sign)</strong> due to subcutaneous emphysema.</p>\n<p>Option C: <strong>Gastric antral vascular ectasia (GAVE) i</strong>s also known as <strong>watermelon stomach</strong> because of the collection of <strong>dilated venules</strong> that appear as <strong>linear red streaks </strong>converging on the antrum. It causes chronic occult blood loss.</p>\n<p>Endoscopy reveals longitudinal stripes of edematous erythematous mucosa that alternate with less severely injured, paler mucosa giving the appearance of watermelon.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/378902f95afd48589fcb29c274507abdx720x783.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3a86a746b09341888df90ed23c43f0e5x512x385.PNG"
    ]
  },
  {
    "text": "A patient presents with a 4-month history of persistent cough and hemoptysis. Bronchoscopy revealed a mass in the mainstem bronchus. Biopsy shows rosette-like arrangements of tumor cells with uniform round nuclei and moderate amounts of eosinophilic cytoplasm. Chromogranin staining was positive. Which of the following factors is responsible for the patient's symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Lepidic pattern of tumour spread"
      },
      {
        "id": 2,
        "text": "Collar-button lesions"
      },
      {
        "id": 3,
        "text": "Azzopardi effect"
      },
      {
        "id": 4,
        "text": "Intraluminal growth of tumour"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>In the given clinical scenario of a patient who presents with a 4-month history of <strong>persistent cough</strong> and <strong>hemoptysis</strong> with a mass in the <strong>mainstem bronchus</strong> and biopsy showing <strong>rosette-like</strong> arrangements of tumor cells with <strong>uniform round nuclei </strong>and moderate amounts of <strong>eosinophilic cytoplasm</strong> with <strong>positive chromogranin</strong> staining, points towards the diagnosis of <strong>bronchial carcinoid tumor</strong>. <strong>Intraluminal growth</strong> of the tumor is the main factor responsible for the above symptoms.</p>\n<p>Carcinoid tumors represent 1% to 5% of all lung tumors. Patients present with a <strong>persistent cough, hemoptysis,</strong> and <strong>secondary infections</strong> like bronchiectasis and emphysema due to impairment of drainage of respiratory passages.</p>\n<p>All these symptoms mainly occur due to intraluminal growth of these lesions. Other factors such as their ability to <strong>metastasize,</strong> and the ability of some lesions to produce <strong>vasoactive amines</strong> also contribute to the above symptoms.</p>\n<p>The tumor presents as <strong>finger-like</strong> or <strong>spherical polypoid masses</strong> that commonly project into the lumen of the bronchus with intact mucosa. It is mostly restricted to the mainstem bronchi whereas other lesions penetrate the bronchial wall and spread out in the peribronchial tissue, resulting in <strong>collar-button lesions.\u00a0</strong></p>\n<div class=\"page\" title=\"Page 727\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 727\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Carcinoid tumors are low-grade malignant epithelial neoplasms that are subclassified into typical and atypical carcinoids.\u00a0<strong>Typical carcinoids</strong>\u00a0have <strong>&lt;2 mitoses</strong> per 10 high-power fields (HPF) and lack necrosis;\u00a0<strong>atypical carcinoids</strong> have <strong>2-10 mitoses</strong> per 10 high-power fields and/or foci of necrosis. Atypical carcinoids also show increased pleomorphism, have more prominent nucleoli, and are more likely to grow in a disorganized fashion and invade lymphatics.</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<p><strong>Histologically</strong>, it is composed of trabecular, palisading, ribbon, or rosette-like arrangements of cells separated by a delicate fibrovascular stroma. Tumour cells have uniform round nuclei and a moderate amount of eosinophilic cytoplasm. On <strong>electron microscopy</strong>, the cells exhibit dense-core neurosecretory granules.\u00a0Immunohistochemistry is positive for serotonin, neuron-specific enolase, bombesin, and calcitonin.</p>\n<p>Other options:</p>\n<p>Option A:\u00a0<strong>Lepidic pattern </strong>of tumor spread is seen at the periphery of <strong>lung adenocarcinomas</strong> where the tumor cells tend to <strong>crawl</strong> along <strong>normal-appearing alveolar septa.</strong> They vary histologically from well-differentiated tumors with glandular elements, to papillary lesions, to solid masses with only occasional mucin-producing glands and cells.</p>\n<p>Option C:<strong> The Azzopardi effect </strong>is seen in<strong> small cell carcinoma</strong> which is described as <strong>basophilic staining</strong> of vascular walls due to coating by DNA from necrotic tumor cells. It is comprised of relatively <strong>small cells </strong>with <strong>scant cytoplasm, </strong>ill-defined cell borders, finely granular nuclear chromatin <strong>(salt and pepper pattern)</strong>, and absent or inconspicuous nucleoli.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient bitten by a snake presented with severe swelling of the limb and persistent bleeding from the bite site. He later developed haematuria, gingival bleeding and severe haematemesis. Which of the following family of snakes is responsible for the above manifestations?",
    "choices": [
      {
        "id": 1,
        "text": "Elapidae"
      },
      {
        "id": 2,
        "text": "Viperidae"
      },
      {
        "id": 3,
        "text": "Colubridae"
      },
      {
        "id": 4,
        "text": "Hydrophidae"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In the given clinical scenario of a patient bitten by a snake presenting with <strong>severe swelling</strong> of the limb and <strong>persistent bleeding</strong> from th<strong>e bite site </strong>and later developing <strong>haematuria, gingival bleeding</strong> and <strong>severe haematemesis</strong> are characteristically seen in the case of <strong>Viperidae bite.</strong></p>\n<p>Viperidae family consists of snakes that have highly developed long curved, hinged, front fangs, which are channelised in the form of a hypodermic needle. There are two sub families\u2014</p>\n<ol style=\"list-style-type: lower-alpha;\">\n<li><strong>Viperinae</strong> or true vipers: Saw-scaled Viper and Russell\u2019s Viper</li>\n<li><strong>Crotalinae</strong> or pit vipers: Rattle snakes and Asian pit vipers.</li>\n</ol>\n<p>Viperid bite produces severe local effects. <strong>Swelling</strong> begins at the bite site and quickly spreads to involve the <strong>entire</strong> <strong>limb</strong>. It is associated with pain, tenderness, and regional lymphadenopathy.\u00a0<strong>Blisters</strong> appear in and around the bite site in about <strong>12 hours</strong>, progressing to involve the <strong>entire limb</strong> later.</p>\n<p>Systemic effects mainly include <strong>haemostatic abnormalities.</strong> The first evidence of this is <strong>persistent bleeding</strong> from the bitesite. Within a few hours of the bite, <strong>haematuria</strong> may appear. Later, <strong>gingival bleeding</strong> occurs, which is followed by <strong>epistaxis,</strong> haemoptysis (rarely), and <strong>haematemesis.</strong> There is also bleeding into the anterior pituitary (causing a Sheehan-like syndrome), subarachnoid haemorrhage, and intracerebral haemorrhage.</p>\n<p>Acute renal failure occurs due to widespread microvascular fibrin deposition. <strong>Hypotension</strong> is a common symptom of all viper bites, and it is usually accompanied by tachycardia.</p>\n<p>According to a study on saw-scaled viper bites, haemorrhagic manifestations may be caused by<strong> primary pathological fibrinolysis (PPF) </strong>rather than disseminated intravascular coagulation (DIC).</p>\n<p>Certain <strong>neurotoxic effects</strong> like ptosis and generalised flaccid paralysis may also be seen in the case of Russell\u2019s viper bite.</p>\n<p>Other options :</p>\n<p>Option A: Bites of <strong>Elapidae</strong>\u00a0like Cobras,\u00a0<strong>Common</strong> <strong>Kraits</strong>, Mambas, and Coral Snakes, generally result in\u00a0<strong>neurotoxic effects</strong>\u00a0in the patient. The early symptoms usually include vomiting, hypersalivation, headache, the heaviness of the eyelids, blurred vision, tingling sensation around the mouth, hyperacusis, dizziness, and \u2018gooseflesh\u2019. Paralysis first presents with\u00a0<strong>ptosis\u00a0</strong>followed by\u00a0<strong>external ophthalmoplegia.\u00a0</strong>Later paralysis of other muscles continues with\u00a0<strong>respiratory paralysis\u00a0</strong>as the end result.</p>\n<p>Option C: <strong>Colubridae</strong> family includes <strong>harmless snakes.</strong> It includes almost 1400 species of snakes. Most of them have<strong> short immobile fang</strong>s, or <strong>enlarged solid teeth</strong> at the posterior end of the maxilla. About one-third of the Colubrid species possess rear fangs which deliver a toxic saliva delivered by a <strong>chewing motion.\u00a0</strong></p>\n<p>Option D: <strong>Hydrophidae</strong> family comprises sea snakes, which have short fixed fangs as in the case of the elapids. The snake's venom is <strong>myotoxic. </strong>Some common symptoms include headache, thirst,<strong> generalized muscle ache, </strong>stiffness, and tenderness, <strong>Trismus</strong> is an early symptom and is followed by<strong> generalized flaccid paralysis </strong>similar to elapid neurotoxicity.</p>\n<p>Myoglobin released from damaged skeletal muscles causes <strong>renal failure</strong> and <strong>myoglobinuria</strong> occurs after a bite, which manifests as the patient passing<strong> dark urine.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following disorders is assumed to be present in any paediatric case presenting with hematemesis and splenomegaly, unless proven otherwise?",
    "choices": [
      {
        "id": 1,
        "text": "Prolapse gastropathy secondary to emesis"
      },
      {
        "id": 2,
        "text": "Mallory-Weiss syndrome"
      },
      {
        "id": 3,
        "text": "Peptic ulcer"
      },
      {
        "id": 4,
        "text": "Esophageal varices"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\">A pediatric case presenting with <strong>hematemesis and splenomegaly</strong> is presumed to have <strong>esophageal variceal bleeding </strong>until proven otherwise.</p>\n<p>The <strong>upper GI endoscopy</strong> provides a <strong>definitive diagnosis</strong> and aids in <strong>predicting</strong> the <strong>risk of bleeding</strong> with an option to treat via <strong>band ligation or sclerotherapy.</strong></p>\n<p>Blood transfusions, vasoactive medications (such as octreotide), short-term antibiotic use, and endoscopy for ligation or sclerotherapy, are all important components of the management of acute variceal bleeding. When variceal bleeding is not responding to medication or endoscopic therapy, a<strong> transjugular intrahepatic portosystemic shunt</strong> should be considered.</p>\n<p><strong>Nonselective \u03b2 blockade </strong>and <strong>obliteration</strong> <strong>of</strong> <strong>varices</strong> through repeated ligation or sclerotherapy treatments are used in <strong>secondary prophylaxis</strong> to lessen bleeding recurrence.\u00a0</p>\n<p>Prolapse gastropathy secondary to emesis, Mallory-Weiss syndrome and peptic ulcer are all differential diagnoses for gastrointestinal bleeding in childhood.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presents with upper abdominal pain, hematemesis and melena following a cholecystectomy procedure. CT angiography reveals bleeding into the biliary tree from an aberrant connection between the bile duct and a blood vessel. Which of the following triads is associated with this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Charcot triad"
      },
      {
        "id": 2,
        "text": "Sandblom triad"
      },
      {
        "id": 3,
        "text": "Rigler's triad"
      },
      {
        "id": 4,
        "text": "Saint's triad"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario of a patient presenting with<strong> upper abdominal pain, hematemesis</strong> and <strong>melena</strong> due to<strong> bleeding into the biliary tree </strong>due to an <strong>aberrant connection</strong> between the<strong> bile duct</strong> and a <strong>blood vessel,</strong> points towards the diagnosis of <strong>hemobilia.</strong> Hemobilia is associated with the <strong>Sandblom triad.</strong></p>\n<p>Hemobilia is defined as bleeding into the biliary tree from abnormal communication between a blood vessel and the bile duct. Patients often present with a classic triad <strong>(Quincke's triad/Sandblom triad)</strong> of:</p>\n<ul>\n<li><strong>Biliary pain</strong></li>\n<li><strong>Obstructive jaundice</strong></li>\n<li><strong>Gastrointestinal haemorrhage (melena, hematemesis)</strong></li>\n</ul>\n<p>The <strong>most common</strong> cause of hemobilia is <strong>iatrogenic trauma</strong> to the liver and biliary tree. It can occur due to <strong>direct trauma</strong> or an arterial pseudoaneurysm following <strong>biliary tree exploration surgery, </strong>or due to injuries sustained during a <strong>cholecystectomy procedure.</strong></p>\n<p>Hemobilia caused by <strong>accidental abdominal trauma</strong> is <strong>more common</strong> with a <strong>blunt injury</strong> than a penetrating injury. Primary vascular diseases, such as aneurysms, angiodysplasia, hemangiomas and malignant tumours of the liver are rare causes of hemobilia.\u00a0</p>\n<p>Investigation of choice:<strong> Arterial angiography (CT angiography)</strong> is the diagnostic procedure of choice.</p>\n<div class=\"page\" title=\"Page 1498\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Management:<strong> </strong><strong style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\">Minor hemobilia</strong><span style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\"> can be managed </span><strong style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\">conservatively</strong><span style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;\">.</span></p>\n<p><strong>Major hemobilia: Transarterial embolization</strong> is indicated for <strong>major hemobilia</strong> requiring blood transfusion. Ligation of the bleeding vessel may also be required.</p>\n<p>Other options:</p>\n<p>Option A: <strong>Charcot triad</strong> describes <strong>acute cholangitis</strong> as clinical findings of fever, right upper abdominal pain, and jaundice.</p>\n<p>Option B: <strong>Rigler's triad </strong>seen in <strong>gallstone ileus</strong> includes small bowel obstruction, pneumobilia and ectopic gallstone</p>\n<p>Option C: <strong>Saint's triad</strong>\u00a0includes hiatus hernia, gallstones and colonic diverticulosis</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 54-year-old patient was rushed to the casualty with massive hemoptysis. Which of the following are the indications of urgent surgical intervention for massive hemoptysis?",
    "choices": [
      {
        "id": 1,
        "text": "Only 1"
      },
      {
        "id": 2,
        "text": "Only 1 and 2"
      },
      {
        "id": 3,
        "text": "1, 2 and 3"
      },
      {
        "id": 4,
        "text": "Only 1 and 3"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Indications for\u00a0urgent surgical intervention for massive hemoptysis are the presence of significant cavitatory disease,\u00a0a fungal ball, a lung abscess, and failure to control the bleeding. So, option C is the correct answer.</p>\n<p><strong>Massive hemoptysis</strong> is generally defined as the expectoration of over <strong>600 mL</strong> of blood within <strong>a 24-hour period.</strong></p>\n<p>Treatment priorities in the management of massive hemoptysis:</p>\n<ul>\n<li>Prevent asphyxiation by achieving respiratory stabilization</li>\n<li>Localize the bleeding site using flexible/ rigid bronchoscopy\u00a0</li>\n<li>Control the hemorrhage</li>\n<li>Determine the cause of bleeding</li>\n<li>Prevent a recurrence</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Hematemesis and melena are the usual presenting features of bleeding located _________",
    "choices": [
      {
        "id": 1,
        "text": "Proximal to Hepatic flexure"
      },
      {
        "id": 2,
        "text": "Proximal to Ligament of Treitz"
      },
      {
        "id": 3,
        "text": "Distal to Hepatic flexure"
      },
      {
        "id": 4,
        "text": "Distal to Ligament of Treitz"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hematemesis and melena</strong> are the usual <strong>presenting features of upper gastrointestinal bleeding</strong>. <strong>Upper\u00a0GI bleeding</strong> is derived from a <strong>source proximal</strong> to the <strong>ligament of Treitz</strong>.</p>\n<p>The <strong>ligament of Treitz</strong> is part of the duodenojejunal junction and forms the <strong>line of demarcation for gastrointestinal (GI) bleeding</strong>.</p>\n<p>Upper GI bleeding refers to bleeding proximal to the ligament of Treitz, and lower GI bleeding refers to bleeding distal to the ligament of Treitz.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0248990f12cb47a8a09f5c12c0ed6213x1280x2956.JPEG"
    ]
  },
  {
    "text": "A patient with a history of esophageal varices presents with hematemesis. What is the optimal level of hemoglobin to be maintained in this patient through blood transfusions?",
    "choices": [
      {
        "id": 1,
        "text": "7 gm/dL"
      },
      {
        "id": 2,
        "text": "6 gm/dL"
      },
      {
        "id": 3,
        "text": "9 gm/dL"
      },
      {
        "id": 4,
        "text": "8 gm/dL"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The optimal level of Hb to be maintained, in this case, is <strong>8 gm/dL.</strong></p>\n<p>The indications for blood transfusion are as follows:</p>\n<ul>\n<li><strong>Acute blood loss:</strong> To replace circulating volume and maintain oxygen delivery.</li>\n<li><strong>Perioperative anemia:</strong> To ensure adequate oxygen delivery during the perioperative phase.</li>\n<li><strong>Symptomatic chronic anemia:</strong>&nbsp;without hemorrhage or impending surgery.</li>\n</ul>\n<table style=\"height: 184px;\" width=\"504\">\n<tbody>\n<tr>\n<td style=\"width: 243px;\"><strong> Haemoglobin level (g/dL) </strong></td>\n<td style=\"width: 245px;\"><strong> Indications </strong></td>\n</tr>\n<tr>\n<td style=\"width: 243px;\">&lt;6</td>\n<td style=\"width: 245px;\">Probably will benefit from transfusion</td>\n</tr>\n<tr>\n<td style=\"width: 243px;\">6&ndash;8</td>\n<td style=\"width: 245px;\">Transfusion unlikely to be of benefit in the absence of <strong>bleeding</strong> or impending surgery</td>\n</tr>\n<tr>\n<td style=\"width: 243px;\">&gt;8</td>\n<td style=\"width: 245px;\">No indication for transfusion in the absence of other risk factors</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly man had an episode of hematemesis. The endoscopy done is given below.  What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Watermelon stomach"
      },
      {
        "id": 2,
        "text": "Bleeding esophageal varices"
      },
      {
        "id": 3,
        "text": "Menetrier\u2019s disease"
      },
      {
        "id": 4,
        "text": "Dieulafoy lesion"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical history and the&nbsp;endoscopic image of the patient&nbsp;suggest&nbsp;<strong>bleeding esophageal varices</strong>.&nbsp;</p>\n<p>Option A: <strong>Gastric antral vascular ectasia</strong> (GAVE) is also known as <strong>watermelon stomach</strong><span style=\"font-size: 14px;\">&nbsp;because of the collection of dilated venules that appear as a linear red streak converging on the antrum. It causes chronic occult blood loss.</span></p>\n<p>The following is an endoscopic image of GAVE:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a5be8e2cbec04ce2ba54fbf1bf711eae.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/378902f95afd48589fcb29c274507abdx720x783.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ff57529481584d6ebb87b62a3df4a758x720x760.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3a86a746b09341888df90ed23c43f0e5x512x385.PNG"
    ]
  },
  {
    "text": "A patient with hematemesis was brought to the Emergency. His BP was 90/60 mm of Hg and pulse was 110. A gastro-oesophageal bleed is suspected and the given tube is inserted for tamponade. Identify the tube.",
    "choices": [
      {
        "id": 1,
        "text": "Sengstaken Blakemore tube"
      },
      {
        "id": 2,
        "text": "Minnesota tube"
      },
      {
        "id": 3,
        "text": "Linton nachlas tube"
      },
      {
        "id": 4,
        "text": "Dobhoffs tube"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given tube is a Minnesota tube.</p>\n<p>Minnesota tube has <strong>4</strong> openings &ndash; 2 suction tubes and 2 inflation tubes. Suction tubes allow aspiration of both gastric and oesophageal contents.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/36d53032a14444718590f3388679ca95.PNG"
    ],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/9b3cfe1a102343d694b9bf0601dcb949x812x467.PNG"
    ]
  },
  {
    "text": "A 50-year-old patient on DOTS therapy was rushed to the casualty after having massive hemoptysis. Which of the following is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Intubation is done into the non-bleeding lung."
      },
      {
        "id": 2,
        "text": "Massive hemoptysis is defined as expectoration of over 750 mL of blood within 24-hours."
      },
      {
        "id": 3,
        "text": "Presence of significant cavitary disease is an indication for urgent surgery."
      },
      {
        "id": 4,
        "text": "Bleeding is most likely due to pulmonary artery erosion."
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Massive hemoptysis</strong> is defined as the expectoration of <strong>over 600 mL of blood within a 24-hour period. </strong>Common causes include tuberculosis, bronchiectasis,\u00a0and cancer.\u00a0It is a medical emergency.</p>\n<p>Any hemoptysis that can cause <strong>airway compromise</strong> or lead to <strong>hemodynamic collapse</strong> is called massive hemoptysis. This includes blood loss of <strong>&gt;600mL/24h</strong> or\u00a0<strong>&gt;150ml/h</strong>\u00a0which can flood the anatomical dead space of the lung.</p>\n<p>Bleeding can either be from the <strong>bronchial artery circulation</strong>\u00a0(most common) or from the <strong>pulmonary artery circulation</strong>. Bleeding from <strong>cavitary lesions</strong>\u00a0is due to <strong>pulmonary artery</strong> erosion.</p>\n<p>The <strong>chest X-ray</strong> is the first investigation followed by <strong>rigid or flexible bronchoscopy</strong>.</p>\n<p>The cause of death in massive hemoptysis is usually due to\u00a0<strong>asphyxiation</strong> (rather than blood loss itself). This is why <strong>airway stabilization</strong> by <strong>intubating into the non-bleeding lung</strong>\u00a0is the priority. After ventilation is achieved, the bleeding site should be identified using <strong>bronchoscopy</strong>. Bleeding is controlled by laser, bronchial occlusion, or arterial <strong>embolization</strong>. <strong>Surgical resection</strong> of the involved area is also done in some cases.</p>\n<div class=\"page\" title=\"Page 690\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Indications for urgent surgical intervention for massive hemoptysis:</p>\n<ul>\n<li>Presence of a fungus ball</li>\n<li>Presence of a lung abscess</li>\n<li>Presence of significant cavitary disease</li>\n<li>Failure to control the bleeding.</li>\n</ul>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = 'Hemoptysis And Hematemesis Mini Test - -Tmt';
        const quizFilename = 'hemoptysis-and-hematemesis-mini-test-tmt-e2fb1e66.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2023-24"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>