<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04 Specific Treatment Modalities - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Psychiatry
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "In which of the following conditions is the treatment modality shown below not indicated?",
    "choices": [
      {
        "id": 1,
        "text": "Increased intracranial tension"
      },
      {
        "id": 2,
        "text": "Intractable seizure disorder"
      },
      {
        "id": 3,
        "text": "Pregnancy"
      },
      {
        "id": 4,
        "text": "Neuroleptic malignant syndrome"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Increased intracranial tension is a<strong> relative contraindication</strong> for electroconvulsive therapy (ECT).</p>\n<p>ECT was introduced as a treatment modality for schizophrenia by <strong>Ugo Cerletti.&nbsp;</strong>ECT is useful in the treatment of:</p>\n<ul>\n<li><strong>Severe depression with suicidal risk</strong> (most common indication)</li>\n<li>Treatment-resistant depression</li>\n<li>Catatonia</li>\n<li>Obsessive-compulsive disorder</li>\n<li>Delirium</li>\n<li>Episodic psychoses, atypical psychoses</li>\n<li>Medical conditions such as:&nbsp;\n<ul>\n<li>Neuroleptic malignant syndrome</li>\n<li>Hypopituitarism</li>\n<li>Intractable seizure disorders</li>\n<li>The on-off phenomenon of Parkinson's disease.</li>\n</ul>\n</li>\n</ul>\n<p>ECT may also be the treatment of choice for depressed suicidal pregnant women who require treatment and cannot take medication.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a51fda3928b94859b54c42db43fb023e.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient with severe resistant depression is planned for electroconvulsive therapy. You ask the nurse to load atropine, a muscle relaxant, and an anesthetic drug as a part of pre-procedure preparation. Which of the following anesthetic agents should he load?",
    "choices": [
      {
        "id": 1,
        "text": "Ketamine"
      },
      {
        "id": 2,
        "text": "Methohexital"
      },
      {
        "id": 3,
        "text": "Propofol"
      },
      {
        "id": 4,
        "text": "Thiopental"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Methohexital</strong> is the&nbsp;<strong>most commonly used</strong> anesthetic agent for electroconvulsive therapy, because of its shorter duration of action and <strong>lower association</strong> with <strong>post-ictal arrythmias</strong>.&nbsp;Methohexital is the only anesthetic agent with no intrinsic antiepileptic property.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who is a known case of bipolar disorder with psychotic features is currently on the following medications. However, he continues to have pressured speech, flight of ideas, hallucinations, and suicidal ideations. He is planned for electroconvulsive therapy. Which of the following drugs would you stop before the procedure?",
    "choices": [
      {
        "id": 1,
        "text": "2 only"
      },
      {
        "id": 2,
        "text": "3 and 5"
      },
      {
        "id": 3,
        "text": "1, 2 and 4"
      },
      {
        "id": 4,
        "text": "1, 3, 4 and 5"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Lithium, diazepam, and bupropion should be withheld before a session of ECT.</p>\n<p><strong>Lithium</strong> combined with ECT has been shown to&nbsp;cause <strong>prolonged</strong>&nbsp;<strong>seizures&nbsp;</strong>(lasting more than 180 secs) and <strong>increased postictal delirium</strong>. Doses are withheld for 24 hours prior to treatment, allowing for washout.</p>\n<p>Medications to be withheld before ECT:</p>\n<ol>\n<li>Lithium - causes prolonged seizures and increased postictal delirium</li>\n<li>Benzodiazepines - anticonvulsant activity</li>\n<li>Clozapine - associated with late-appearing seizures</li>\n<li>Buproprion - associated with late-appearing seizures</li>\n</ol>\n<p>Medications that should not be used during ECT:</p>\n<ol>\n<li>Lidocaine - markedly increases seizure threshold</li>\n<li>Theophylline - increases the duration of seizures</li>\n<li>Reserpine - further compromises RS and CVS</li>\n</ol>\n<p>Note: Tardive seizure is a rare complication of ECT. These are seizures that occur after the completion of treatment once the patient has regained consciousness. The use of&nbsp;<strong>&beta;-lactam antibiotics</strong> and<strong> ciprofloxacin</strong>&nbsp;has been associated with <strong>tardive seizures</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are observing electroconvulsive therapy being administered to a psychiatric patient. Which of the following statements is true regarding the procedure?",
    "choices": [
      {
        "id": 1,
        "text": "An effective seizure should last for at least 2 minutes"
      },
      {
        "id": 2,
        "text": "ECT treatments are usually administered twice or thrice weekly, non consecutively"
      },
      {
        "id": 3,
        "text": "Maximum number of times ECT can be given in a patient is 6"
      },
      {
        "id": 4,
        "text": "All of the above"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>ECT consists of sessions that are scheduled&nbsp;<strong>2-3 times weekly on nonconsecutive days</strong>. Twice-weekly treatments are associated with less memory impairment than thrice-weekly treatments.</p>\n<div class=\"page\" title=\"Page 1088\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>For a seizure to be effec&shy;tive in the course of ECT, it should last <strong>at least 25 seconds.</strong></p>\n</div>\n</div>\n</div>\n<p>Treatment should<strong> continue until</strong> the patient achieves what is considered the <strong>maximal therapeutic response</strong>. The point of maximal improvement is usually thought to occur when a patient <strong>fails to continue to improve after two consecutive treatments</strong>.&nbsp;Further treatment does not yield any therapeutic benefit but increases the severity and duration of the adverse effects.</p>\n<p>If a patient does not improve after 6 to 10 sessions, bilateral placement and high-density treatment (three times the seizure threshold) should be attempted before ECT is abandoned.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following side effects of electroconvulsive therapy persists even after the treatment course ends?",
    "choices": [
      {
        "id": 1,
        "text": "Decreased anterograde memory"
      },
      {
        "id": 2,
        "text": "Errors in visual-spatial function"
      },
      {
        "id": 3,
        "text": "Diminished processing speed"
      },
      {
        "id": 4,
        "text": "Decreased retrograde memory"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>A <strong>decrease in retrograde memory</strong> is a side effect of ECT that could persist even after the treatment course ends. Retrograde memory disturbances take<strong> 1-6 months to recover.</strong></p>\n<p>Other cognitive side effects of ECT include:</p>\n<ul>\n<li>Disorientation&nbsp;</li>\n<li>Diminished processing speed&nbsp;</li>\n<li>Decreased anterograde memory</li>\n<li>Errors in visual-spatial function and word-finding</li>\n</ul>\n<p>These effects are seen immediately after a treatment session and diminish fairly quickly after the treatment course ends.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an advantage of transcranial magnetic stimulation over electroconvulsive therapy?",
    "choices": [
      {
        "id": 1,
        "text": "It is more effective than electroconvulsive therapy"
      },
      {
        "id": 2,
        "text": "Shorter treatment course"
      },
      {
        "id": 3,
        "text": "It induces seizure of shorter duration"
      },
      {
        "id": 4,
        "text": "It allows for focal stimulation of cerebral cortex"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Transcranial magnetic stimulation (TMS)</strong> is a brain stimulation method that&nbsp;allows for<strong> focal stimulation</strong> of the cerebral cortex.</p>\n<p>TMS works by inducing <strong>eddy currents</strong> in the brain cortex due to the application of rapidly changing magnetic fields. These currents bring about neuronal stimulation.</p>\n<p>Advantages of TMS over ECT:</p>\n<ul>\n<li>TMS allows for focal stimulation of brain areas</li>\n<li>It does not induce seizures, but unintended seizure is a known risk of this procedure.</li>\n</ul>\n<p>Studies have shown TMS to be less effective than ECT.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is true regarding the repetitive brain stimulation technique shown below?",
    "choices": [
      {
        "id": 1,
        "text": "It can be used as a monotherapy for schizophrenia"
      },
      {
        "id": 2,
        "text": "It can be used as a monotherapy in resistant depression"
      },
      {
        "id": 3,
        "text": "Its effects are the same as that of an MRI"
      },
      {
        "id": 4,
        "text": "It can be used as a first line treatment for depression"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Repetitive transcranial magnetic stimulation (rTMS) is approved for <strong>monotherapy in resistant depression</strong>. It uses the property of magnetic fields to induce electrical activity in the brain.&nbsp;</p>\n<p>It is different from MRI, as an <strong>MRI</strong> just <strong>observes</strong> but <strong>rTMS</strong> produces <strong>changes</strong> in the activity of the brain.&nbsp;</p>\n<p><strong>rTMS</strong> can be used <strong>in addition to antipsychotics</strong> to treat resistant <strong>schizophrenia.</strong> However, it is not used as monotherapy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1acc6e9e45fa4819b2e29e78395d4caa.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is true about deep brain stimulation?",
    "choices": [
      {
        "id": 1,
        "text": "Three tiny neurostimulators are placed under the skin of the clavicle"
      },
      {
        "id": 2,
        "text": "Done under computed tomography guidance"
      },
      {
        "id": 3,
        "text": "Reduces symptoms associated with movement disorders"
      },
      {
        "id": 4,
        "text": "Swimming skills remain intact after the procedure"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Deep brain stimulation</strong> (DBS)<strong> reduces</strong> <strong>symptoms</strong> associated with<strong> movement disorders</strong> such as Parkinson's disease. It provides a dramatic response with respect to <strong>off time</strong> and <strong>dyskinesias</strong>.</p>\n<p>However, it does not improve features that fail to respond to levodopa and does not prevent the development or progression of non-dopaminergic features such as freezing, falling, dementia, etc.</p>\n<p>It is an invasive procedure&nbsp;performed using MRI-guided stereotactic techniques in which <strong>electrodes</strong> are implanted in the brain and are connected via a <strong>subcutaneous wire</strong> to a maximum of two <strong>neurostimulators</strong> which are placed under the skin of the clavicle.</p>\n<p><strong>Impaired swimming skills</strong> surfaced as an <strong>unexpected risk</strong> of the procedure; several Parkinson's disease patients lost their ability to swim after receiving deep brain stimulation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f47e8586fce8496bb605ed918387c90ax414x600.JPEG"
    ]
  },
  {
    "text": "A patient with a severe, treatment-resistant neuropsychiatric condition is referred to the neurosurgery OPD. The surgeon proposes a burr-hole procedure where the given sites are destroyed via thermocoagulation. Which of the following conditions is the patient likely to be suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Obsessive-compulsive disorder"
      },
      {
        "id": 2,
        "text": "Mania"
      },
      {
        "id": 3,
        "text": "Alzheimer's dementia"
      },
      {
        "id": 4,
        "text": "Antisocial personality disorder"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image is that of<strong>&nbsp;anterior cingulotomy</strong> (ACING), which is a neurosurgical treatment for&nbsp;<strong>obsessive-compulsive disorder</strong>.&nbsp;Anterior cingulotomy involves creating&nbsp;bilateral lesions in the anterior cingulate cortex<strong>&nbsp;</strong>under stereotactic guidance.&nbsp;</p>\n<p><strong>Subcaudate tractotomy</strong> (capsulotomy) can also be used in the management of treatment-unresponsive OCD.</p>\n<p><strong>Prefrontal lobotomy</strong> was introduced by <strong>Egas Moniz</strong> as a method of psychosurgery for treatment-resistant mental disorders, particularly <strong>major depressive disorder </strong>and<strong> OCD.</strong></p>\n<p>Other indications for psychosurgery include:</p>\n<ul>\n<li>Chronic and <strong>incapacitating</strong>&nbsp;<strong>schizophrenia</strong> with <strong>severe depression</strong>&nbsp;not responding to all modes of treatment.</li>\n<li>Chronic and <strong>incapacitating</strong>&nbsp;<strong>anxiety disorder</strong>&nbsp;not responding to all modes of treatment.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/aa238c6f54564eb89070cdc1975b62ab.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following characteristics of a patient is favourable for using psychoanalysis as a therapy?",
    "choices": [
      {
        "id": 1,
        "text": "High frustration tolerance"
      },
      {
        "id": 2,
        "text": "Concrete thinking"
      },
      {
        "id": 3,
        "text": "Extreme dishonesty"
      },
      {
        "id": 4,
        "text": "Ongoing major upheaval in life"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>High frustration tolerance</strong> is <strong>favorable</strong> for psychoanalysis.&nbsp;Psychoanalysis involves bringing repressed memories and feelings to the surface and resolving unconscious conflicts through understanding.</p>\n<p class=\"p1\"><strong>Patient characteristics favorable for psychoanalysis:</strong></p>\n<ul>\n<li style=\"text-align: left;\">Significant suffering and a genuine wish to understand themselves.</li>\n<li style=\"text-align: left;\">Ability to withstand frustration and anxiety that might emerge during analysis.</li>\n<li style=\"text-align: left;\">A reasonable, mature superego that allows them to be honest with the analyst.&nbsp;</li>\n<li style=\"text-align: left;\">Average intelligence.</li>\n<li style=\"text-align: left;\">Psychologically minded, that is, being able to think abstractly and symbolically about the unconscious meanings of their behavior.</li>\n</ul>\n<p><strong>Patient characteristics unfavorable for psychoanalysis:</strong></p>\n<ul>\n<li>The absence of suffering and low motivation to understand.</li>\n<li>Inability to tolerate frustration and anxiety with poor impulse control.</li>\n<li>Extreme dishonesty or antisocial personality disorder.</li>\n<li>Low intelligence - inability to understand the process.</li>\n<li>Concrete thinking or the absence of psychological mindedness.</li>\n<li>Serious physical illness, an ongoing major upheaval in life like job loss or divorce.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During Ross's marriage to Emily, when the wedding officiant asked him to repeat \u201cI Ross, take thee, Emily, as my lawfully wedded wife\u201d, Ross says Rachel's name instead. Ross and Rachel have dated on multiple occasions in the past. This unconscious act of revealing his feelings can be best described by which of the following terms?",
    "choices": [
      {
        "id": 1,
        "text": "Parapraxis"
      },
      {
        "id": 2,
        "text": "Transference"
      },
      {
        "id": 3,
        "text": "Repression"
      },
      {
        "id": 4,
        "text": "Displacement"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: left;\">When a person reveals his feelings&nbsp;<strong>unconsciously</strong> by a slip of tongue, it is known as <strong>parapraxis</strong>. Freud ascribed parapraxis to unconscious motives.</p>\n<p style=\"text-align: left;\">Option B:&nbsp;<strong>Transference -&nbsp;</strong>A<strong>&nbsp;</strong>situation where&nbsp;the feelings, desires, and expectations of one person are redirected and applied to another person. Most commonly, transference occurs in a therapeutic setting, where a person in&nbsp;therapy&nbsp;<strong>unconsciously </strong>develop&nbsp;feelings towards the therapist.<br /><br />Option C: <strong>Repression -&nbsp;</strong>is a key concept of psychoanalysis, where it is understood as a defense mechanism. It ensures that what is <strong>unacceptable</strong> to the <strong>conscious mind</strong> - and would, if recalled arouse anxiety - is <strong>prevented </strong>from entering into it.<sup id=\"cite_ref-2\" class=\"reference\"></sup></p>\n<p>Option D: <strong>Displacement -</strong>&nbsp;Feelings that are connected with one person are displaced onto another person. E.g., a man who has had a bad day at the office, comes home and yells at his wife and children, is displacing his anger from the workplace onto his family.</p>\n<p><strong>Catharsis:&nbsp;</strong>The expression of ideas, thoughts, and suppressed emotions by the patient which provides a sense of relief. It is also known as&nbsp;<strong>ventilation</strong>. In catharsis, the patient <strong>reveals information voluntarily</strong> and consciously whereas, in parapraxis, patient details are revealed unconsciously, by slip of tongue.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient was referred to a psychiatrist for his neurosis. He was a witness to a road traffic accident wherein a pedestrian was overrun. He refuses to go out on the road fearing that every time he would step out he would witness an accident. What kind of maladaptive assumption does this patient display?",
    "choices": [
      {
        "id": 1,
        "text": "Selective abstraction"
      },
      {
        "id": 2,
        "text": "Catastrophising"
      },
      {
        "id": 3,
        "text": "Temporal causality"
      },
      {
        "id": 4,
        "text": "Dichotomous thinking"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The patient believes 'if it has been true in the past, it's always going to be true' which is demonstrative of&nbsp;<strong>maladaptive assumption</strong> of <strong>temporal causality.</strong></p>\n<p>Behavioral therapy techniques are used to test and change maladaptive and inaccurate cognitions. The overall purpose of such techniques is to help the patients understand the inaccuracy of their cognitive assumptions and learn new strategies and ways of dealing with issues.&nbsp;</p>\n<table style=\"height: 196px; width: 433px;\">\n<tbody>\n<tr>\n<td style=\"width: 203.694px;\"><strong>Cognitive Error</strong></td>\n<td style=\"width: 218.306px;\"><strong>Assumption</strong></td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Overgeneralizing</td>\n<td style=\"width: 218.306px;\">If it's true in one case, it applies to any case that is even slightly similar.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Selective abstraction</td>\n<td style=\"width: 218.306px;\">The only events that matter are failures, deprivation, etc. Should measure self by errors, weaknesses, etc.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Excessive responsibility (assuming<br />personal causality)</td>\n<td style=\"width: 218.306px;\">I am responsible for all bad things, failures, etc.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Assuming temporal causality (predicting<br />without sufficient evidence)</td>\n<td style=\"width: 218.306px;\">If it has been true in the past, it's always going to be true.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Self-references</td>\n<td style=\"width: 218.306px;\">I am the center of everyone's attention especially my bad performances. I am the cause of misfortunes.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Catastrophizing</td>\n<td style=\"width: 218.306px;\">Always think of the worst. It's most likely to happen to you.</td>\n</tr>\n<tr>\n<td style=\"width: 203.694px;\">Dichotomous thinking</td>\n<td style=\"width: 218.306px;\">Everything is either one extreme or another (black or white, good or bad).</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a session of cognitive-behavioral therapy, the patient reported feeling distressed about the fact that his friend did not answer his call when he had called him the previous day.  When asked what thought went through his mind at that time, he replied  \"I do not fit anywhere in this world.\" What is the next step the therapist should follow in the session?",
    "choices": [
      {
        "id": 1,
        "text": "Elicit the automatic thought"
      },
      {
        "id": 2,
        "text": "Test the validity of the maladaptive assumption the patient is making"
      },
      {
        "id": 3,
        "text": "Identify the maladaptive assumption the patient is making"
      },
      {
        "id": 4,
        "text": "Test the validity of the automatic thought"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The therapist first elicited the <strong>automatic thought</strong> the patient made, which is \"I do not fit anywhere in this world\". The <strong>next step</strong> would be to <strong>test the validity</strong> of this automatic thought.</p>\n<p>Cognitive Behavioural Therapy (CBT)<strong>&nbsp;</strong>is based on the psychological significance of the <strong>cognitive triad</strong>:</p>\n<ul>\n<li class=\"p1\">An individual's beliefs about themselves</li>\n<li class=\"p1\">Their personal world (including the people in their lives)</li>\n<li class=\"p1\">Their future.</li>\n</ul>\n<p><strong>Problematic and biased interpretations</strong> related to this cognitive triad may lead to <strong>excessive emotional distress</strong>.</p>\n<p>CBT is applied to identify these faulty ideas and beliefs, make the patient aware of the underlying assumptions that drive them, and modifying their responses to them.</p>\n<p>The three components of cognitive therapy are:&nbsp;</p>\n<ul>\n<li><strong>Didactic aspects:</strong>&nbsp;Explaining to patients the cognitive triad, schemas, and faulty logic. The therapist&nbsp;must explain all the aspects of treatment.</li>\n<li><strong>Cognitive techniques</strong>: These involve four steps-\n<ul>\n<li>Eliciting <strong>automatic thoughts&nbsp;</strong>- Asking the patient about the thought that causes the emotional reaction in them.</li>\n<li>Testing validity of the automatic thoughts</li>\n<li>Identifying the general <strong>maladaptive assumptions </strong>(a belief that is false and rationally unsupported)</li>\n<li>Testing the validity of maladaptive assumptions</li>\n</ul>\n</li>\n<li><strong>Behavioral techniques&nbsp;</strong>like relaxation techniques and desensitization to the stimulus etc.<strong><br /></strong></li>\n</ul>\n<p>CBT is used in the&nbsp;treatment of anxiety and panic disorders, depression, phobia, OCD, personality disorders, and somatoform disorders.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following patients with personality disorders is most likely to benefit from dialectical behavior therapy?",
    "choices": [
      {
        "id": 1,
        "text": "A 18-year-old with traits of criminality, impulsivity, hostility, manipulation, and disregard for others"
      },
      {
        "id": 2,
        "text": "A 20-year-old with labile emotions, dramatic speech, who is sexually provocative with attention seeking behaviours"
      },
      {
        "id": 3,
        "text": "A 22-year-old with traits of unstable mood, impulsivity, suicidality, fear of abandonment, and unstable self-image"
      },
      {
        "id": 4,
        "text": "A 24-year-old who is preoccupied with order, perfectionism, and is excessively devoted to work"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Dialectical behavior therapy</strong> is a type of psychotherapy used commonly in the management of <strong>borderline personality</strong> <strong>disorder.</strong></p>\n<p>A 22-year-old with traits of unstable mood, impulsivity, suicidality, fear of abandonment, and unstable self-image fits the description of borderline personality disorder as per DSM-5 criteria.</p>\n<p class=\"p1\">In DBT, the goal is to <strong>improve interpersonal skills</strong> and <strong>decrease self-destructive behavior</strong> using techniques involving advice, metaphor, storytelling, and confrontation, among others.</p>\n<p class=\"p1\">Option A: This describes a patient with <strong>antisocial personality disorde</strong>r.</p>\n<p class=\"p1\">Option B: This describes a patient with<strong> histrionic personality disorder.</strong></p>\n<p class=\"p1\">Option D: This describes a patient with <strong>obsessive-compulsive personality disorder.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following instances can a psychologist use systematic desensitization as a treatment option?",
    "choices": [
      {
        "id": 1,
        "text": "A 18-year-old with BMI 22, recurrent episodes of binge eating and purging for past 3 months"
      },
      {
        "id": 2,
        "text": "A 24-year-old with an irrational fear of contamination who washes her hands every 5 minutes"
      },
      {
        "id": 3,
        "text": "A 22-year-old with feelings of  worthlessness, psychomotor retardation, insomnia, fatigue, and anhedonia for 2 weeks"
      },
      {
        "id": 4,
        "text": "A 20-year-old with disorganized behavior, delusions of persecution and auditory hallucinations for 4 months"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Systematic desensitization</strong> is one of the behavioral therapy techniques for <strong>Obsessive-compulsive disorder </strong>(A 24-year-old with an irrational fear of contamination and washes hands every 5 minutes). It is also used in the treatment of <strong>phobias.</strong></p>\n<p>Systemic desensitization is based on the behavioral principle of <strong>counter-conditioning</strong>. Here, the person overcomes anxiety elicited by a situation or an object by approaching the feared situation gradually&nbsp;and<strong>&nbsp;</strong>in a relaxed state.</p>\n<p>Systematic desensitization consists of three steps:</p>\n<ul>\n<li><strong>Relaxation training -</strong>&nbsp;patients attain a state of complete relaxation and are then exposed to the stimulus that elicits the anxiety response. The negative reaction of anxiety is inhibited by the relaxed state, a process called&nbsp;<strong><span class=\"s1\">reciprocal inhibition.</span></strong></li>\n<li><strong>Hierarchy construction -</strong>&nbsp;Patients and therapists prepare a graded list (or hierarchy) of fear-provoking scenes in the order of increasing anxiety.</li>\n<li><strong>Desensitization of the stimulus -</strong>&nbsp;Patients proceed systematically through the list from the least to the most anxiety-provoking scene while in a deeply relaxed state.</li>\n</ul>\n<p>Option A: Describes a patient with <strong>bulimia nervosa.</strong></p>\n<p>Option C: Describes a patient with <strong>major depressive episode.</strong></p>\n<p>Option D: Describes a patient with <strong>schizophreniform disorder.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false?",
    "choices": [
      {
        "id": 1,
        "text": "Systematic desensitisation is based on the principle of counter conditioning and reciprocal inhibition"
      },
      {
        "id": 2,
        "text": "When flooding, the patient is exposed to the fear according to a hierarchy"
      },
      {
        "id": 3,
        "text": "In therapeutic graded exposure, relaxation training is not involved"
      },
      {
        "id": 4,
        "text": "Eye movement desensitisation is used in post traumatic stress disorder and phobias"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In&nbsp;<strong>flooding</strong>, the patient is exposed to their fear, but <strong>without any hierarchy</strong>&nbsp;i.e, there is no gradual exposure as in systematic desensitization.&nbsp;Patients learn to remain in the feared situation until they feel calm.</p>\n<p><strong>Systematic&nbsp;desensitization - </strong>employs counter conditioning and reciprocal inhibition. It is used in the treatment of <strong>OCD and phobias.</strong></p>\n<p><strong>Therapeutic graded exposure - </strong>similar to systematic desensitization,&nbsp;but there is<strong> no relaxation training.&nbsp;</strong>The treatment is carried out in a real-life context.</p>\n<p><strong>Eye movement desensitization and reprocessing (EMDR)&nbsp;</strong>- inducing saccades (quick, simultaneous movement of both eyes between two or more phases of fixation) when a person is imagining an anxiety-producing event. The saccades can yield a positive thought which decreases anxiety. It is used in <strong>PTSD and phobias.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient suffering from a phobia of contamination is asked by his therapist to follow behind him, touch every object he touches, and observe and learn from his behavior. During this process, the therapist talks calmly to the patient. The patient is told to repeat this twice daily. Name the technique applied by the therapist.",
    "choices": [
      {
        "id": 1,
        "text": "Participant modeling"
      },
      {
        "id": 2,
        "text": "Aversion therapy"
      },
      {
        "id": 3,
        "text": "Flooding"
      },
      {
        "id": 4,
        "text": "Positive reinforcement"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The patient is made to learn a new behaviour when exposed to his fear, by observation and imitation of the therapist. This therapy is called <strong>participant modeling</strong>.</p>\n<p><strong>&nbsp;Aversion therapy</strong> - This is to <strong>supress</strong> an <strong>unwanted behavior</strong> or a habit by <strong>pairing</strong> it with a negative or <strong>unpleasant stimulus</strong>. For example, an alcohol-dependent patient is made to vomit (by adding an emetic to the alcohol) every time a drink is ingested is effective in treating alcohol dependence.</p>\n<p><strong>Flooding -</strong>&nbsp;It involves repeated and prolonged exposure to fear cues of high intensity without relaxation<strong>.&nbsp;</strong>Patients learn to remain in the feared situation until they feel calm.</p>\n<div class=\"page\" title=\"Page 899\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Positive reinforcement</strong> - When a behavioral response is followed by a reward&shy;ing event.&nbsp;&nbsp;</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding the scientist who performed the famous experiment illustrated below?",
    "choices": [
      {
        "id": 1,
        "text": "He developed the concept of learning by association"
      },
      {
        "id": 2,
        "text": "He developed the theory of classical conditioning"
      },
      {
        "id": 3,
        "text": "He studied the physiology of digestion"
      },
      {
        "id": 4,
        "text": "He gave the model for operant conditioning"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p class=\"p1\">The experiment shown in the image is that of <strong>classical conditioning </strong>by\u00a0Ivan Pavlov.\u00a0The theory of <strong>operant conditioning</strong> was given by\u00a0<strong>Skinner</strong>\u00a0(not Pavlov). It\u00a0is a method of\u00a0learning\u00a0that occurs through <strong>rewards and punishments</strong> for behavior.</p>\n<p class=\"p2\">Classical conditioning is the theory of learning in which a natural response (salivation) is elicited by a conditioned or learned stimulus (bell), that was previously presented with an unconditioned stimulus (food). It is also called <strong>learning by association</strong> or respondent conditioning. He's also known for his work on the <strong>physiology of digestion</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/259735809e1c417ab48e6c65d97e1041.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9d927c604d6c4572afc3181efaad5621x1280x3468.JPEG"
    ]
  },
  {
    "text": "A child was not allowed to play because he did not finish his homework. The mother used which of the following techniques to discipline her child?",
    "choices": [
      {
        "id": 1,
        "text": "Positive punishment"
      },
      {
        "id": 2,
        "text": "Negative punishment"
      },
      {
        "id": 3,
        "text": "Positive reinforcement"
      },
      {
        "id": 4,
        "text": "Negative reinforcement"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<div class=\"ng-scope\">\n<div class=\"ng-scope\">\n<p>Types of Operant conditioning:</p>\n</div>\n</div>\n<table style=\"height: 729px; width: 430px;\">\n<tbody>\n<tr>\n<td style=\"width: 91px;\"><strong>Type</strong></td>\n<td style=\"width: 114px;\"><strong>Behavior</strong></td>\n<td style=\"width: 84.2257px;\"><strong>Stimulus</strong></td>\n<td style=\"width: 116.774px;\"><strong>Example</strong></td>\n</tr>\n<tr>\n<td style=\"width: 91px;\">Positive reinforcement</td>\n<td style=\"width: 114px;\">Good behavior increased</td>\n<td style=\"width: 84.2257px;\">\n<p>When stimulus added.</p>\n<p>&nbsp;</p>\n</td>\n<td style=\"width: 116.774px;\">When a child studies, he is given chocolate. So, now he studies every day to get the chocolate.</td>\n</tr>\n<tr>\n<td style=\"width: 91px;\">Negative reinforcement</td>\n<td style=\"width: 114px;\">Good behavior increased</td>\n<td style=\"width: 84.2257px;\">So that stimulus is avoided.</td>\n<td style=\"width: 116.774px;\">A child studies to avoid getting scolded by his mother.</td>\n</tr>\n<tr>\n<td style=\"width: 91px;\">Positive punishment</td>\n<td style=\"width: 114px;\">Bad behavior decreased</td>\n<td style=\"width: 84.2257px;\">When stimulus added.</td>\n<td style=\"width: 116.774px;\">A child was given an imposition because he did not do his homework. He does his homework sincerely now.</td>\n</tr>\n<tr>\n<td style=\"width: 91px;\">Negative punishment</td>\n<td style=\"width: 114px;\">Bad behavior decreased</td>\n<td style=\"width: 84.2257px;\">So that stimulus is removed.</td>\n<td style=\"width: 116.774px;\">A child fails to do his homework, so he is not allowed to play. Next day onwards, he does his homework every day.</td>\n</tr>\n</tbody>\n</table>\n<p class=\"ng-binding\">Note: The question is about bad behavior i.e. not doing the homework. The focus is on decreasing bad behavior, hence the answer would be punishment (positive or negative). Reinforcement (either positive or negative) applies only to good behavior.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/91debdd71967491496c3564488f46478x1280x1595.JPEG"
    ]
  },
  {
    "text": "A young man who started using cannabis has become increasingly dependant on it psychologically. He was diagnosed with cannabis use disorder and motivational enhancement therapy was started to help him. Which of the following is not a stage of this therapy?",
    "choices": [
      {
        "id": 1,
        "text": "Preparation"
      },
      {
        "id": 2,
        "text": "Contemplation"
      },
      {
        "id": 3,
        "text": "Conditioning"
      },
      {
        "id": 4,
        "text": "Maintenance"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Conditioning is not a stage of motivational enhancement therapy.</p>\n<p>The stages of motivational enhancement therapy:</p>\n<ul>\n<li><strong>Pre-contemplation</strong>&nbsp;- People are often <strong>unaware</strong> that their behavior (eg. alcohol abuse) is problematic or produces negative consequences.</li>\n<li><strong>Contemplation&nbsp;</strong>- People recognize their problem and begin to think about changing their behavior. They&nbsp;<strong>weigh the pros and cons of change</strong>. People may still feel <strong>ambivalent</strong> toward changing their behavior.</li>\n<li><strong>Preparation (Determination)&nbsp;</strong>- People have <strong>made a decision</strong> to change their habits and&nbsp;are ready to take action. People start to take small steps toward behavior change.</li>\n<li><strong>Action&nbsp;</strong>- People have recently <strong>changed their behavior</strong> and intend to keep moving forward with that behavior change</li>\n<li><strong>Maintenance</strong> - People have <strong>sustained their behavior change</strong> for a while and intend to maintain the behavior change going forward. People work to prevent relapse to earlier stages.</li>\n</ul>\n<p><strong>Termination -</strong> In this stage,&nbsp;people have <strong>no desire </strong>to return to their <strong>unhealthy behaviors</strong> and are sure they will not relapse. Since this is rarely reached, people tend to stay in the maintenance stage.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A chronic smoker who was recently diagnosed with COPD finally decided to quit smoking. He often thinks about stopping it but is reluctant due to the fear that he might become too irritable and restless without it. Which of the following options best describes the stage he is in?",
    "choices": [
      {
        "id": 1,
        "text": "Pre contemplation"
      },
      {
        "id": 2,
        "text": "Contemplation"
      },
      {
        "id": 3,
        "text": "Preparation"
      },
      {
        "id": 4,
        "text": "Consolidation"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In the given scenerio, the patient is in the&nbsp;stage of <strong>contemplation</strong>.</p>\n<p>The patient is aware that he has a problem, and he is thinking about changing his behaviour. He is <strong>weighing the pros and cons</strong> of behaviour modification. This is characteristic of the stage of <strong>contemplation</strong>.</p>\n<p>Addiction recovery usually involves the following five stages</p>\n<ul>\n<li>Precontemplation</li>\n<li>Contemplation</li>\n<li>Preparation</li>\n<li>Action</li>\n<li>Maintenance</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A chronic alcoholic who is motivated to quit drinking is prescribed disulfiram by his physician. Which of the following was employed by the physician to modify the patient's behavior?",
    "choices": [
      {
        "id": 1,
        "text": "Positive reinforcement"
      },
      {
        "id": 2,
        "text": "Systematic desensitization"
      },
      {
        "id": 3,
        "text": "Aversion therapy"
      },
      {
        "id": 4,
        "text": "Flooding"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the given scenerio <strong>aversion therapy</strong> is used.</p>\n<p><strong>Aversion</strong>: When a <strong>noxious stimulus/punishment</strong> is given after a specific behavior, the behavior is eventually inhibited. It is used in the treatment of alcohol abuse, paraphilias, opioid addicts.</p>\n<p><strong>Disulfiram</strong> is an <strong>irreversible inhibitor </strong>of both cytosolic and mitochondrial forms of<strong> aldehyde dehydrogenase</strong>. Ethanol consumption during disulfiram therapy can lead to <strong>increased</strong> concentrations of <strong>acetaldehyde</strong>. Increased acetaldehyde levels can cause flushing, pulsating headache, throbbing pain in head and neck, and other aversive reactions.</p>\n<p>Disulfiram can only be given to <strong>highly motivated individuals</strong>. It should not be administered until the person has abstained from alcohol for at least 12 hours. The disulfiram-alcohol reaction may occur as long as <strong>1 or 2 weeks</strong> after the last dose of disulfiram.</p>\n<p>Disulfiram like reaction with alcohol ingestion is also seen with the following drugs:</p>\n<ul>\n<li>Metronidazole</li>\n<li>Sulfonylureas like chlorpropamide</li>\n<li>Cephalosporins like&nbsp;cefoperazone, cefamandole.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '04 Specific Treatment Modalities';
        const quizFilename = '04-specific-treatment-modalities-727d641e.html';
        let hierarchy = ["Marrow", "qBank", "Psychiatry"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>