<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16 Esophagus - Congenital, Motility & Inflammatory Disorders - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">26</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A full-term infant with a history of polyhydramnios in utero presents with respiratory distress soon after birth. On examination, the child has frothing of saliva and the resident suspects tracheoesophageal fistula. What is the most common type of fistula likely to be present in this child?",
    "choices": [
      {
        "id": 1,
        "text": "A"
      },
      {
        "id": 2,
        "text": "B"
      },
      {
        "id": 3,
        "text": "C"
      },
      {
        "id": 4,
        "text": "D"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Type C</strong> is the commonest variety of tracheo-esophageal fistula (TEF).\u00a0</p>\n<p>A tracheoesophageal fistula is an <strong>abnormal</strong>\u00a0<strong>communication</strong> between the esophagus and trachea. Type C lesion is associated with <strong>proximal esophageal atresia </strong>and<strong> distal TEF.</strong>\u00a0The proximal blind pouch ends approximately at the distance of one or two vertebral bodies from the distal TEF.</p>\n<p>Tracheoesophageal fistula is associated with <strong>VACTERL</strong> (vertebral, anorectal, cardiac, tracheal, esophageal, renal, and limb) anomalies.\u00a0</p>\n<p>Drooling of saliva,\u00a0<strong>inability to pass a nasogastric tube</strong>\u00a0and history of polyhydramnios suggest a diagnosis of\u00a0<strong>oesophagal atresia </strong>with or without <strong>TEF.\u00a0</strong>This can be confirmed\u00a0with a chest X-ray image showing a coiled nasogastric tube in the oesophagal pouch as shown in the image below.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/677031e622ec4d5fa3e540d219efc9e6.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7db8519c0e2344059bb617a057b08ba7x279x466.JPEG"
    ]
  },
  {
    "text": "A neonate was brought by his mother with complaints of regurgitation of the feeds given to him. The nasogastric tube could not be passed to the stomach. Radiograph is shown below. The birth weight of the neonate was 2.7kg. There is no current evidence of pneumonia. What is the most suitable management in this case?",
    "choices": [
      {
        "id": 1,
        "text": "Gastrostomy under antibiotic coverage"
      },
      {
        "id": 2,
        "text": "Cameron Haight surgery"
      },
      {
        "id": 3,
        "text": "Conservative management"
      },
      {
        "id": 4,
        "text": "Flourish device placement"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above scenario along with the radiograph is suggestive of a type-E or H-type <strong>tracheoesophageal</strong> <strong>fistula&nbsp;</strong>(TEF). The management for this case would be <strong>Cameron Haight's surgery</strong>.</p>\n<p>Management of TEF is based on <strong>Waterson's criteri</strong><strong>a:</strong></p>\n<table style=\"height: 116px; width: 458px;\">\n<tbody>\n<tr>\n<td style=\"width: 83.6094px; text-align: center;\">Category</td>\n<td style=\"width: 206.391px; text-align: center;\">Weight/Comorbidities</td>\n<td style=\"width: 145px;\">&nbsp; &nbsp;Management</td>\n</tr>\n<tr>\n<td style=\"width: 83.6094px; text-align: center;\">A</td>\n<td style=\"width: 206.391px;\">Birth weight &gt; 2.5kg</td>\n<td style=\"width: 145px;\">Definitive surgery</td>\n</tr>\n<tr>\n<td style=\"width: 83.6094px; text-align: center;\">B&nbsp;</td>\n<td style=\"width: 206.391px;\">Birth weight 1.8-2.5kg or pneumonia or congenital anomaly</td>\n<td style=\"width: 145px;\">\n<p>Needs stabilization before surgery</p>\n<p>Antibiotics + Build up nutrition</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 83.6094px; text-align: center;\">C</td>\n<td style=\"width: 206.391px;\">Birth weight &lt; 1.8kg or severe pneumonia or congenital anomaly</td>\n<td style=\"width: 145px;\">\n<p>Staged repair</p>\n<p>Antibiotics + gastrostomy</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p><br />Diagnosis of TEF:<br />Confirmatory - Contrast study (Iohexol)<br />Investigation of choice for H-type - Combined tracheo-esophagoscopy</p>\n<p>Definitive surgery for:</p>\n<ul>\n<li>Types B, C, D, and E - Cameron Haight surgery</li>\n<li>Type A - Anastomosis with/without gastrostomy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/06949ca8801b49c9a6c4ca1b81cc57ac.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "What is the following image of a barium swallow suggestive of?",
    "choices": [
      {
        "id": 1,
        "text": "Achalasia cardia"
      },
      {
        "id": 2,
        "text": "Diffuse esophageal spasm (DES)"
      },
      {
        "id": 3,
        "text": "Nutcracker esophagus"
      },
      {
        "id": 4,
        "text": "Hypertensive lower esophageal sphincter"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image shows a markedly dilated esophagus and characteristic <strong>bird's beak</strong>\u00a0appearance (distal narrowing), which is suggestive of <strong>achalasia cardia.</strong></p>\n<p>Achalasia cardia is caused due to the <strong>degeneration of the neurons in the myenteric plexus</strong> of the esophagus. This degeneration results in the <strong>failure of relaxation</strong> of the<strong> lower esophageal sphincter</strong> (LES) on swallowing.</p>\n<p>The patients present with a classic triad of <strong>dysphagia</strong>, <strong>regurgitation,</strong> and <strong>weight loss</strong>. The dysphagia<strong> initially</strong> begins with<strong> liquid foods</strong> and then <strong>progresses to solid foods.</strong> As the food gets accumulated in the esophagus, patients may complain of<strong> halitosis.</strong> With further progression of the disease, the patients may develop pneumonia, lung abscess, etc.</p>\n<p>The initial diagnosis is made by barium swallow or endoscopy, which shows the presence of dilated esophagus due to the constriction of the lower esophageal sphincter (<strong>bird-beak appearance). </strong>The gold standard test to confirm achalasia cardia is <strong>esophageal manometry.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a6b3262a4cfc4d25bf749a33f4ee92f0.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "In which of the following conditions is normal peristalsis not seen?",
    "choices": [
      {
        "id": 1,
        "text": "Achalasia cardia"
      },
      {
        "id": 2,
        "text": "Diffuse esophageal spasm (DES)"
      },
      {
        "id": 3,
        "text": "Nutcracker esophagus"
      },
      {
        "id": 4,
        "text": "Hypertensive lower esophageal sphincter"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Achalasia cardia <strong>does not show\u00a0</strong>normal peristalsis.</p>\n<p>Manometric features of achalasia cardia are as follows:</p>\n<ul>\n<li>Incomplete lower esophageal sphincter relaxation</li>\n<li><strong>Aperistalsis </strong>of the esophageal body</li>\n<li><strong>Elevated LES pressure</strong></li>\n</ul>\n<p><strong>Diffuse esophageal spasm</strong> is characterized by simultaneous <strong>multi-peaked contractions of the esophagus.</strong> The contractions are spontaneous and may be of abnormally high amplitude (&gt;120 mmHg) or long duration. <strong>Intermittent normal peristalsis is seen.</strong></p>\n<p><strong>Nutcracker esophagus</strong> is characterized by<strong> high amplitude (\u2265180 mmHg) contractions</strong> with an increased mean duration. The peristaltic sequence is normal.</p>\n<p><strong>Hypertensive lower esophageal sphincter</strong> is characterized by <strong>elevated LES pressure (\u226526 mmHg).</strong> Normal peristalsis is seen in the body of the esophagus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young woman was admitted with chief complaints of dysphagia since adulthood which worsened in the last three months followed by odynophagia, nausea, and vomiting of undigested food. Her barium swallow shows features suspicious of achalasia and she is advised to undergo esophageal manometry. Which of the following will not be seen?",
    "choices": [
      {
        "id": 1,
        "text": "High LES pressure"
      },
      {
        "id": 2,
        "text": "Incomplete LES relaxation"
      },
      {
        "id": 3,
        "text": "Decreased esophageal baseline pressure"
      },
      {
        "id": 4,
        "text": "Absent peristalsis of the esophageal body"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>There is <strong>increased esophageal baseline pressure</strong> in achalasia cardia.</p>\n<p>Manometric features of achalasia cardia are as follows:</p>\n<ul>\n<li><strong>Incomplete </strong>lower esophageal sphincter (LES) relaxation</li>\n<li><strong>Absent peristalsis </strong>of the esophageal body</li>\n<li><strong>Elevated LES pressure</strong></li>\n<li><strong>Increased intraesophageal baseline</strong> pressures relative to the gastric baseline pressure</li>\n</ul>\n<p><strong>High-resolution manometry</strong> (<strong>HRM</strong>) is a gastrointestinal motility diagnostic system that measures intraluminal pressure activity in the gastrointestinal tract using a series of closely spaced pressure sensors. For a manometry system to be classified as high-resolution instead of classic, the pressure sensors must\u00a0be <strong>spaced</strong> at most <strong>1\u00a0cm apart</strong>.<sup id=\"cite_ref-1\" class=\"reference\"></sup></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is true about Chicago classification?",
    "choices": [
      {
        "id": 1,
        "text": "The classification is based on readings obtained by classic manometry"
      },
      {
        "id": 2,
        "text": "Type III is spastic achlasia"
      },
      {
        "id": 3,
        "text": "Type l achalasia exhibits panoesophageal pressurization pattern"
      },
      {
        "id": 4,
        "text": "Per oral endoscopic myotomy is the definitive treatment for type I achalasia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Type III achalasia in Chicago classification is also known as <strong>spastic achalasia</strong>.&nbsp;Achalasia cardia is a motility disorder of the esophagus in which the LES (lower esophageal sphincter)&nbsp; fails to relax due to loss of ganglion in the myenteric plexus.</p>\n<p>Chicago classification of <strong>esophageal motility</strong> divides <strong>achalasia cardia </strong>into<strong> 3 types</strong>. This classification is based on the readings obtained by <strong>high-resolution manometry </strong>(HRM).</p>\n<p>Type I achalasia cardia does not show&nbsp;pressurization pattern.</p>\n<p>Treatment options:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Pneumatic dilatation</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Laparoscopic myotomy</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">POEM (per-oral endoscopic myotomy)</li>\n</ul>\n<p>The <strong>definitive</strong> treatment for Achalasia is <strong>surgical myotomy (Hellers myotomy) + fundoplication.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 32-year-old male was diagnosed with achalasia cardia. High-resolution manometry revealed massive, simultaneous, high-pressure contractions of the distal oesophagus. According to the \u200bChicago classification, the patient has which type of achalasia?",
    "choices": [
      {
        "id": 1,
        "text": "Type II"
      },
      {
        "id": 2,
        "text": "Type I"
      },
      {
        "id": 3,
        "text": "Type IV"
      },
      {
        "id": 4,
        "text": "Type III"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given features are suggestive of <strong>type III achalasia cardia.</strong></p>\n<p><strong>Type III&nbsp;</strong>achalasia cardia is&nbsp;characterised by massive, <strong>simultaneous</strong>, <strong>high-pressure contractions</strong> of the <strong>distal esophagus.</strong>&nbsp;</p>\n<p>Achalasia cardia occurs due to the&nbsp;<strong>loss of inhibitory ganglion cells</strong>&nbsp;in the&nbsp;<strong>myenteric plexus</strong>&nbsp;of GIT. During swallowing, the food bolus normally triggers a&nbsp;<strong>primary peristaltic wave</strong>, which is responsible for carrying the bolus to the stomach, accompanied by the <strong>relaxation of the lower esophageal sphincter</strong>&nbsp;<strong>(LES)</strong>&nbsp;to allow esophageal emptying into the stomach.</p>\n<p>Achalasia is characterized by a disruption of this normal process.&nbsp;<strong>Failure of relaxation of the LES</strong>&nbsp;causes an&nbsp;<strong>elevated median integrated relaxation pressure </strong>and a complete <strong>failure of peristalsis</strong>. The esophagus becomes progressively more tortuous, leading to a <strong>megaesophagus</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old woman presented with long-standing complaints of dysphagia which was getting worse for the past 4 months. A barium swallow was performed and it showed the following finding. Which of the following is the definitive treatment of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Calcium channel blockers"
      },
      {
        "id": 2,
        "text": "Botulinum toxin injection"
      },
      {
        "id": 3,
        "text": "Pneumatic dilation"
      },
      {
        "id": 4,
        "text": "Heller myotomy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Option A:&nbsp;<strong>Calcium channel blockers</strong> can be given in the initial stages of the disease. They relieve the chest pressure that occurs around mealtimes. However, they are not permanent treatments and can be used while waiting for surgery.&nbsp;&nbsp;</p>\n<p>Option B:&nbsp;<strong>Botulinum toxin injection</strong>&nbsp;can be used as a treatment in patients who may not be candidates for surgery or dilatation. Limitations to botulinum toxin injections are that the effect is <strong>short-lived (6-12 months) </strong>and patients often require multiple treatments.</p>\n<p>Option C:&nbsp;<strong>Pneumatic dilatation </strong>of the LES has is successful in 75% of patients. It involves using a balloon to stretch the LES and improve competence. It requires multiple sessions and has a low risk of esophageal perforation.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f94073e95bf7427e951e53504a2c93e1.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/187a53652a8a47f29ef4e32f1400bfefx1280x1947.JPEG"
    ]
  },
  {
    "text": "Which of the following esophageal carcinomas is most likely to develop in patients with long-standing achalasia cardia?",
    "choices": [
      {
        "id": 1,
        "text": "Adenocarcinoma"
      },
      {
        "id": 2,
        "text": "Squamous cell carcinoma"
      },
      {
        "id": 3,
        "text": "Small cell carcinoma"
      },
      {
        "id": 4,
        "text": "Carcinoid tumor"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most common</strong> type of carcinoma associated with this condition is <strong>squamous cell carcinoma.</strong></p>\n<p><strong>Achalasia</strong> is a <strong>premalignant condition.</strong> It becomes malignant<strong>\u00a0</strong>due to long-standing, retained, undigested fermenting food in the body of the esophagus, causing mucosal irritation.</p>\n<p><strong>Adenocarcinoma</strong> may also arise in the setting of achalasia but is <strong>less</strong> <strong>common</strong> as compared to SCC.</p>\n<p><strong>Small</strong> <strong>cell</strong> <strong>carcinoma</strong> is a <strong>rare</strong> type of <strong>neuroendocrine</strong> esophageal carcinoma more common in the lower esophagus. It is <strong>very aggressive</strong> and the 5-year survival rate is 8%.\u00a0</p>\n<p><strong>Carcinoid</strong> tumors are<strong> slow-growing tumors</strong> of neuroendocrine cells that form in the\u00a0 GI tract, mainly in the rectum, small intestine, or appendix.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following conditions is peroral endoscopic myotomy done?",
    "choices": [
      {
        "id": 1,
        "text": "Achalasia cardia"
      },
      {
        "id": 2,
        "text": "Gastroesophageal reflux disease"
      },
      {
        "id": 3,
        "text": "Zenker\u2019s diverticulum"
      },
      {
        "id": 4,
        "text": "Hypertrophic pyloric stenosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Peroral endoscopic myotomy<strong> (POEM)</strong> is used in <strong>achalasia cardia.</strong></p>\n<p>Treatment options:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Pneumatic dilatation</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Laparoscopic myotomy</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>POEM </strong>(per-oral endoscopic myotomy)</li>\n</ul>\n<p>With the use of an operating endoscope, the <strong>mucosa</strong> of the esophagus is<strong> divided</strong> around the mid to the distal third, and a <strong>submucosal tunnel</strong> is <strong>created</strong>.&nbsp;</p>\n<p>Through this tunnel, the muscular layer of the distal esophagus, lower esophageal sphincter (LES), and cardia are visualized and divided, effectively performing an <strong>endoscopic myotomy</strong>.</p>\n<p>The major <strong>downside</strong> of<strong> POEM</strong> is that an effective anti-reflux valve cannot be created, exposing the patient to a 40%&ndash;50% risk of post-procedural <strong>gastroesophageal reflux disease</strong> (GERD).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e54100fb3416443fb643e920ff06e923x720x1004.GIF"
    ]
  },
  {
    "text": "A patient presented with complaints of crushing chest pain radiating to the jaw and dysphagia. It starts whenever he has ice cream and he takes sublingual nitroglycerin which provides him relief. He underwent manometry which showed simultaneous multi-peaked contractions of high amplitude (>120 mm Hg). What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Achalasia cardia"
      },
      {
        "id": 2,
        "text": "Diffuse esophageal spasm"
      },
      {
        "id": 3,
        "text": "Hypertensive lower esophageal sphincter"
      },
      {
        "id": 4,
        "text": "Nutcracker esophagus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above clinical scenario with episodes triggered by cold foods and manometric findings are suggestive of a diffuse esophageal spasm<strong> (DES).</strong></p>\n<p>Diffuse esophageal spasm is a<strong> hypermotility disorder </strong>of the esophagus. It is caused by<strong> spontaneous, abnormal contractions</strong> seen more in the <strong>distal</strong> two-thirds of the <strong>esophageal body</strong>. It is more common in women.&nbsp;</p>\n<p>Patients usually present with <strong>dysphagia</strong> and <strong>chest pain</strong>. Pathologically, there is marked hypertrophy of the circular muscles. It is often <strong>triggered</strong> by <strong>cold foods. </strong>It<strong>&nbsp;</strong>mimics symptoms of myocardial infarction and also shows improvement when sublingual nitroglycerin is administered. It causes smooth muscle relaxation of the esophagus.&nbsp;</p>\n<p>A barium swallow shows a&nbsp;<strong>corkscrew esophagus. </strong>However<strong>, manometry </strong>(high-resolution manometry is preferred)&nbsp;is the <strong>gold standard test </strong>for diagnosis.&nbsp;In <strong>classic manometry</strong>, if there are simultaneous, multi-peaked contractions of high amplitude (<strong>&gt;120 mmHg</strong>) or <strong>long duration</strong> (&gt;2.5 seconds) it is suggestive of diffuse esophageal spasm.</p>\n<p>On <strong>high-resolution manometry</strong>, a DCI (distal contractile integral) <strong>&gt;450 mmHg</strong> is suggestive of DES. The distal contractile integral (DCI) is <strong>an index of contractile vigor in high-resolution manometry, </strong>calculated as the product of amplitude, duration, and span of the distal esophageal contraction.</p>\n<p><strong>Hypertensive lower esophageal sphincter&nbsp;</strong>- It is achalasia in evolution. Shows <strong>increased LES pressure but normal peristalsis.</strong></p>\n<p><strong>Nutcracker&rsquo;s esophagus </strong>-&nbsp;It is the most common motility disorder of the esophagus. In conventional manometry,<strong>&nbsp;</strong>it shows a<strong> high-amplitude peristaltic contraction ( &gt;180mmHg)&nbsp;</strong>and<strong>&nbsp;a longer duration of contraction (&gt;7sec).</strong></p>\n<p>In high-resolution manometry, a DCI &gt; 8000mmHg is suggestive of nutcracker's esophagus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with dysphagia was evaluated with a barium swallow as given in the image. Which of the following is false regarding the management of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Calcium channel blockers and nitrates are first line therapy"
      },
      {
        "id": 2,
        "text": "Pneumatic dilatation only provides short term relief"
      },
      {
        "id": 3,
        "text": "Myotomy of only the affected segment is done"
      },
      {
        "id": 4,
        "text": "Endoscopic botulinum injection is given when medical therapy is contraindicated"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image is suggestive of <strong>diffuse esophageal spasm</strong> (DES).&nbsp;<strong>Myotomy</strong>&nbsp;involves the <strong>entire length</strong> of the <strong>affected segment</strong> along with a <strong>margin of several centimeters </strong>to the spastic region<strong> to prevent remnants of spasticity</strong>.&nbsp;</p>\n<p><strong>First-line therapy</strong> is with <strong>calcium channel blockers</strong> and <strong>nitrates</strong>. Endoscopic botulinum toxin injection and pneumatic dilation are second-line therapies. Calcium-channel antagonists, vasodilators, and endoscopic dilatation <strong>have only transient effects.</strong></p>\n<p><strong>Botulinum toxin injection</strong> is also considered an effective and low-risk procedure but for short-term <strong>symptom</strong> <strong>relief</strong>. Pneumatic dilation is targeted at the exact anatomic site of narrowing.</p>\n<p><strong>Surgical treatment </strong>includes<strong> extended myotomy </strong>of the<strong> esophageal body</strong> or peroral endoscopic myotomy. <strong>Peroral endoscopic myotomy (POEM)</strong> is a safe and effective treatment for patients, especially those who are <strong>refractory to medical therapy.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c9aa59b32e664003ba5e353a0b17d5a3.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 72-year-old female patient presented to the hospital with complaints of difficulty swallowing and generalised weakness for 4 months. Peripheral smear revealed the following and an esophagography was done as given below. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Zenkers\u2019 diverticulum"
      },
      {
        "id": 2,
        "text": "Esophageal carcinoma"
      },
      {
        "id": 3,
        "text": "Diffuse esophageal spasm"
      },
      {
        "id": 4,
        "text": "Plummer-Vinson syndrome"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above clinical scenario with microcytic hypochromic anemia and characteristic esophagogram is suggestive of <strong>Plummer-Vinson syndrome</strong>.&nbsp;</p>\n<p>Plummer-Vinson syndrome/<strong>Paterson&ndash;Kelly syndrome&nbsp;</strong>has a triad of:</p>\n<ul>\n<li>Post-cricoid webs</li>\n<li>Dysphagia</li>\n<li>Iron-deficiency anemia</li>\n</ul>\n<p>The webs are made up of <strong>fibrovascular stroma</strong> and esophageal <strong>epithelium</strong>. Glossitis, angular stomatitis, koilonychia are also associated with this condition.</p>\n<p>Laboratory investigations reveal <strong>microcytic-hypochromic blood picture </strong>and barium <strong>esophagography </strong>or esophagogastroduodenoscopy(EGD) will help detect post-cricoid webs.&nbsp;</p>\n<p>Treatment includes <strong>correcting the </strong><strong>iron-deficiency anemia</strong> which may improve dysphagia and pain. <strong>Esophageal bougies</strong> can be used during upper endoscopy <strong>to dilate</strong> the post-cricoid webs and allow normal swallowing and passage of food.</p>\n<p><strong>Complications </strong>include the&nbsp;<strong>risk of perforation</strong> during dilatation and also <strong>malignant transformation</strong> into<strong> squamous cell carcinoma.<span class=\"Apple-converted-space\">&nbsp;</span></strong></p>\n<p><span class=\"Apple-converted-space\">The image below shows endoscopic appearance of post-cricoid web.</span></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0b60c037d9784d0181bc246a5ff6447c.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e7922a8da6b6422c9b1df0ce975ca6abx468x360.JPEG"
    ]
  },
  {
    "text": "A 22-year-old male presented with intermittent dysphagia for the past 3 months.  Barium swallow showed the following characteristic appearance. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Plummer-Vinson syndrome"
      },
      {
        "id": 2,
        "text": "Schatzki\u2019s ring"
      },
      {
        "id": 3,
        "text": "Diffuse esophageal spasm"
      },
      {
        "id": 4,
        "text": "Carcinoma esophagus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Schatzki&rsquo;s ring is a <strong>benign condition</strong> wherein there is a <strong>concentric, fibrous thickening</strong> and <strong>narrowing</strong> of the gastroesophageal junction (GEJ), with squamous epithelium above and columnar cells below.&nbsp;</p>\n<p>Schatzki's ring is made up of <strong>mucosal</strong> and <strong>submucosal</strong> layers.&nbsp;It causes <strong>dysphagia</strong> and is associated with <strong>gastroesophageal reflux disorder</strong> (GERD). It&nbsp;is most commonly seen in the <strong>lower third</strong> of the<strong> esophagus.&nbsp;</strong></p>\n<p>Treatment is<strong> endoscopic dilation</strong> with <strong>antireflux therap</strong>y and repeated dilation is often necessary. Persistent strictures should always raise suspicion for malignant disease.</p>\n<p>The image below shows endoscopic appearance of the Schatzki's ring.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/775fc4b7802340a18799ff9509118cad.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a0983a2594864d30a56de4b439c92e2bx720x720.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fd47cd371ed44d39925bd59872508a46x269x300.JPEG"
    ]
  },
  {
    "text": "A 20-year-old woman presented with a 1-year history of nonprogressive dysphagia for solids with no previous similar episodes. Barium swallow revealed fixed narrowing of the esophagus at the level of the aortic arch. CT angiography revealed the following. Which anomaly is most commonly seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Aberrant right subclavian artery"
      },
      {
        "id": 2,
        "text": "Aberrant left subclavian artery"
      },
      {
        "id": 3,
        "text": "Aberrant left vertebral artery"
      },
      {
        "id": 4,
        "text": "Aberrant innominate artery"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image shows the origin of the <strong>aberrant right subclavian artery</strong> (red arrow) causing extrinsic compression of the esophagus that is suggestive of <strong>dysphagia lusoria</strong>.</p>\n<p>In dysphagia lusoria, the right subclavian artery arises as the <strong>fourth branch of the aortic arch</strong> instead of branching from the brachiocephalic artery. It then courses behind the esophagus to supply blood to the right arm. This causes <strong>pressure</strong> on the <strong>esophagus</strong> and results in dysphagia.&nbsp;</p>\n<p>It is <strong>diagnosed</strong> by <strong>CT angiography</strong>. A barium swallow shows fixed narrowing of the esophagus at the level of the aortic arch without mucosal abnormality.</p>\n<p><strong>Treatment</strong> is surgical repair either by <strong>reconstruction</strong> or <strong>ligation</strong> of the aberrant right subclavian artery.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d2fa68164bdb4ad3b7b8cf4a83a89fb7.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/72779d8f3f364add947ca2ad1bbcb433x1200x1324.JPEG"
    ]
  },
  {
    "text": "A 65-year-old man presents with halitosis and swelling in the lateral aspect of the neck. He also complained of persistent cough and regurgitation of food remnants shortly after consumption. He underwent a barium swallow which is given below. Which of the following is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is a pulsion diverticulum"
      },
      {
        "id": 2,
        "text": "Occurs in the midline posteriorly and as sac enlarges lies on the left side"
      },
      {
        "id": 3,
        "text": "Dohlman\u2019s procedure is indicated when size > 2-5 cm"
      },
      {
        "id": 4,
        "text": "Herniates through the thyropharyngeus and cricothyroid muscle"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<div class=\"page\" title=\"Page 330\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The above scenario is suggestive of a<strong> Zenker&rsquo;s diverticulum</strong>&nbsp;or pharyngeal pouch.<strong>&nbsp;</strong>It is caused due to herniation of mucosa and submucosa through the space between<strong> thyropharyngeus</strong> and <strong>cricopharyngeus.</strong> This space is known as<strong>&nbsp;</strong><strong>Killian's triangle</strong>, which is a weak area between two&nbsp;parts of the inferior constrictor in the posterior pharyngeal wall.</p>\n<p>It is a <strong>pulsion</strong> <strong>diverticulum</strong>, formed due to increased intraluminal pressure forcing mucosa and submucosa to herniate.</p>\n<p>A small Zenker&rsquo;s diverticulum &lt; 2cm is managed by diverticulectomy and cricopharyngeal myotomy.&nbsp;</p>\n<p>Large diverticulum &gt; 2-5cm is treated by <strong>endoscopic</strong> <strong>diverticulopexy</strong> (<strong>Dohlman&rsquo;s</strong> <strong>procedure</strong>) or by a diverticulectomy with cricopharyngeal myotomy.&nbsp;</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4bbb4dd9818b4163901f9eeb3a714ba3.GIF"
    ],
    "explanation_images": []
  },
  {
    "text": "Which among the following is a true esophageal diverticulum?",
    "choices": [
      {
        "id": 1,
        "text": "Zenker\u2019s diverticula"
      },
      {
        "id": 2,
        "text": "Mid esophageal diverticula"
      },
      {
        "id": 3,
        "text": "Hypopharyngeal diverticula"
      },
      {
        "id": 4,
        "text": "Epiphrenic diverticula"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Epiphrenic diverticula as 1 and 2:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0dd84c6520974a80b068b33c9ee6a265x448x600.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/15ed657c1ed64f99b1940b32d872e4f5x250x303.PNG"
    ]
  },
  {
    "text": "A man presented with complaints of chest pain and a feeling of food getting stuck in the esophagus, after a meal. He has asthma and is under treatment. PPIs were prescribed but it did not resolve the problem so a barium swallow was done and showed the following. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Eosinophilic esophagitis"
      },
      {
        "id": 2,
        "text": "Schatzki ring"
      },
      {
        "id": 3,
        "text": "Plummer-Vinson syndrome"
      },
      {
        "id": 4,
        "text": "Esophageal carcinoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>definitive diagnosis</strong> requires <strong>biopsy</strong> with a histologic finding of <strong>&gt;15&ndash;20 eosinophils</strong> per high-power field.</p>\n<p>Treatment includes <strong>oral corticosteroids</strong> and immunotherapy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/bcffe72afb6640e98a730df8578dfc0f.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4601bbc9f71240d486ac1ea787daeab4x592x472.JPEG"
    ]
  },
  {
    "text": "A 40-year-old woman was brought to the emergency department after the ingestion of a large amount of household cleaning liquid. She complained of a burning sensation in the throat and severe abdominal pain. She has a history of depression for the past 1 year. Which of the following is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It is a risk factor for esophageal carcinoma"
      },
      {
        "id": 2,
        "text": "Early endoscopic evaluation is recommended to assess the grade of mucosal injury"
      },
      {
        "id": 3,
        "text": "Prophylactic antibiotics improve the clinical outcome"
      },
      {
        "id": 4,
        "text": "Acids only cause superficial damage to the esophagus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Prophylactic antibiotics</strong> have <strong>not</strong> been <strong>shown to improve</strong> the clinical outcome of acute corrosive esophagitis and are not recommended.</p>\n<p><strong>Corrosive esophagitis </strong>is caused due to the <strong>ingestion of alkali or acid </strong>and can be accidental or from attempted suicide.\u00a0</p>\n<p>The injury caused by <strong>alkali</strong> ingestion is <strong>deeper</strong> due to the process of saponification of fats and dehydration. The <strong>injury</strong> caused <strong>by acids</strong> is <strong>more superficial</strong> because they cause coagulative necrosis with eschar formation, which prevents the deeper penetration of the acid.</p>\n<p>The <strong>acids</strong> also cause severe <strong>pylorospasm</strong> and therefore <strong>more</strong> <strong>gastric damage</strong> compared to alkali due to the accumulation of the contents in the antrum.\u00a0</p>\n<p>Severe corrosive injury may lead to esophageal perforation, bleeding, stricture, and death. It is a<strong> risk factor </strong>for <strong>esophageal carcinoma</strong>. Therefore, early endoscopic evaluation is recommended to assess mucosal injuries even if there is no signs of oral injury.</p>\n<p>Management of corrosive esophagitis:</p>\n<ul>\n<li><strong>Hemodynamic stabilization</strong> and management of patient's airway</li>\n<li><strong>Endoscopic evaluation</strong> of injuries</li>\n<li>Surgical management includes <strong>laparotomy</strong> and<br />\n<ul>\n<li><strong>Esophageal stenting</strong> and <strong>jejunostomy</strong> for limited hemorrhage and superficial ulceration</li>\n<li><strong>Esophagogastric resection</strong> and <strong>jejunostomy</strong> for extensive necrosis.</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common site for pill-induced esophagitis?",
    "choices": [
      {
        "id": 1,
        "text": "Upper esophagus"
      },
      {
        "id": 2,
        "text": "Mid-esophagus"
      },
      {
        "id": 3,
        "text": "Lower esophagus"
      },
      {
        "id": 4,
        "text": "Gastro esophageal junction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most common</strong> site for <strong>pill-induced esophagitis</strong> is in the <strong>mid esophagus </strong>near the crossing of aorta or carina. These structures externally compress the esophagus and prevent the movement of the pills.</p>\n<p><strong>Pill-induced esophagitis</strong> is caused when the <strong>pill lodges</strong> within the<strong> lumen</strong> of the esophagus. This pill causes <strong>direct damage</strong> to the <strong>mucosa.&nbsp;</strong>The <strong>risk factors</strong> for pill-induced esophagitis include <strong>poor pill-taking habits</strong>, consuming inadequate liquids, and<strong> lying down immediately</strong> after consuming the pill.&nbsp;</p>\n<p>Drugs causing esophagitis are:&nbsp;</p>\n<ul>\n<li>Doxycycline</li>\n<li>Quinidine</li>\n<li>Phenytoin</li>\n<li>NSAIDs</li>\n<li>Bisphosphonates</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Esophageal endoscopy of a patient reveals the presence of serpiginous ulcers. This finding indicates:",
    "choices": [
      {
        "id": 1,
        "text": "CMV esophagitis"
      },
      {
        "id": 2,
        "text": "Candida esophagitis"
      },
      {
        "id": 3,
        "text": "Herpetic esophagitis"
      },
      {
        "id": 4,
        "text": "Radiation esophagitis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image showing <strong>serpiginous ulcers</strong> in the otherwise normal mucosa of the <strong>distal esophagus</strong> is suggestive of <strong>cytomegaloviral esophagitis</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/33acfe1f6f36429f9abdec488cd98071x358x327.PNG"
    ]
  },
  {
    "text": "A middle-aged man presented to the emergency department with upper abdominal pain after having a heavy meal. On clinical examination, upper abdominal tenderness was noted. On chest radiography widening of the mediastinum with pneumomediastinum was seen. What is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Spontaneous perforation of esophagus"
      },
      {
        "id": 2,
        "text": "Perforation of peptic ulcer"
      },
      {
        "id": 3,
        "text": "Foreign body in esophagus"
      },
      {
        "id": 4,
        "text": "Rupture of emphysematous bulla of lung"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical scenario points to a diagnosis of <strong>spontaneous perforation</strong> of the<strong> esophagus</strong>.</p>\n<p>In a perforated peptic ulcer, patients develop sudden onset <strong>severe generalized </strong>abdominal pain, tenderness, and <strong>board-like rigidity </strong>and<strong> </strong>an<strong> erect</strong> plain chest X-ray shows <strong>gas under the diaphragm </strong>(Option B). The <strong>foreign&nbsp;body</strong> in the esophagus can be asymptomatic or may present with perforation after ingestion. The<strong> radiopaque</strong> foreign body can be seen with a&nbsp;<strong>chest X-ray</strong>&nbsp;(Option C).&nbsp;<strong> Rupture</strong> of emphysematous<strong> bullae</strong> of the lung will lead to secondary pneumothorax, which manifests as chest pain and dyspnoea. A plain <strong>chest X-ray</strong>&nbsp;shows <strong>air</strong> in the <strong>thorax</strong>, and the mediastinum is pushed to the opposite side (Option D).</p>\n<p>Spontaneous perforation of the esophagus needs immediate diagnosis and intervention due to the higher mortality associated with it. The most common site of perforation is the <strong>lower esophagus towards the left esophageal cavity.</strong></p>\n<p>Causes:&nbsp;</p>\n<ul>\n<li>Iatrogenic perforation (most common)</li>\n<li>Boerhaave's syndrome (spontaneous emetogenic perforation)</li>\n<li>Sharp foreign body&nbsp;</li>\n<li>Corrosive ingestion&nbsp;</li>\n<li>Esophageal carcinoma&nbsp;</li>\n</ul>\n<p>It usually manifests as <strong>severe pain</strong> in the <strong>chest</strong> or abdomen after a meal or after a bout of drinking, commonly associated with dyspnoea. On clinical examination, there is<strong> rigidity and tenderness</strong> in the <strong>upper abdomen.</strong>&nbsp;The diagnosis is usually confirmed by a&nbsp;<strong>chest radiograph</strong> which shows pneumomediastinum<strong>, </strong>pneumoperitoneum<strong>, </strong>and pneumothorax. Subcutaneous emphysema can be seen in Boerhaave's syndrome. Patients with sepsis will have a fever, tachycardia and tachypnea.&nbsp;</p>\n<p>Treatment includes adequate drainage, antibiotics, closure of the perforation site if possible and supportive measures.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old man was brought to the casualty with a history of severe chest pain radiating to the back and difficulty in breathing following several episodes of vomiting. PR- 110bpm and  BP- 80/50 mm of Hg. On examination, there is palpable crepitus over the chest wall. Which of the following statements is false regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Most common in lower third of esophagus"
      },
      {
        "id": 2,
        "text": "Iohexol is used as contrast agent"
      },
      {
        "id": 3,
        "text": "Cervical esophagostomy and gastrostomy is done in early presentation"
      },
      {
        "id": 4,
        "text": "Most common cause of mortality is mediastinitis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above clinical scenario points to&nbsp;<strong>Boerhaave's syndrome</strong>. <strong>Primary closure</strong> is done in <strong>stable</strong> patients presenting <strong>within 24 hrs</strong> and not cervical esophagostomy with gastrostomy.</p>\n<p>Boerhaave syndrome is the <strong>spontaneous perforation</strong> of the esophagus caused due to <strong>episodes of vomiting</strong>. During vomiting, the<strong> pressure </strong>in the esophagus<strong> rises rapidly</strong> and the esophagus <strong>ruptures</strong> at the <strong>weakest point.&nbsp;</strong>They usually have a&nbsp;history of <strong>heavy meal intake</strong>&nbsp;and<strong> alcohol</strong>&nbsp;abuse.</p>\n<p>Clinical features include <strong>Mackler's triad</strong>:</p>\n<ul>\n<li>Retching</li>\n<li>Chest pain&nbsp;</li>\n<li>Subcutaneous emphysema&nbsp;</li>\n</ul>\n<p>The diagnosis is made by contrast esophagogram(<strong>iohexol</strong>) in unstable patients or <strong>contrast-enhanced CT scan</strong>, in stable patients.</p>\n<p>Treatment includes <strong>primary closure</strong>&nbsp;within 12 hours of the injury for a <strong>better prognosis.</strong> If the patient is unstable or <strong>presents late,</strong> the <strong>perforated part </strong>is<strong> resected</strong> and <strong>cervical esophagostomy</strong> is performed. A T-tube is placed into the esophagus along with appropriately located drains and a <strong>feeding jejunostomy</strong>&nbsp;or gastrostomy<strong>&nbsp;</strong>is performed <strong>for nutrition.</strong></p>\n<p><strong>Most common&nbsp;cause</strong> of <strong>mortality</strong> in Boerhaave syndrome is<strong> mediastinitis</strong> (40% to 50%).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 47-year-old woman underwent endoscopy for the evaluation of dysphagia. After the procedure, she developed severe chest pain radiating to the back and respiratory distress. What is the initial investigation you will perform on this patient to identify the cause?",
    "choices": [
      {
        "id": 1,
        "text": "CT Chest"
      },
      {
        "id": 2,
        "text": "Contrast esophagogram"
      },
      {
        "id": 3,
        "text": "Endoscopy"
      },
      {
        "id": 4,
        "text": "Chest X-ray"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The clinical scenario is suggestive of <strong>esophageal perforation </strong>following endoscopy. The <strong>initial investigation</strong> that is performed in this condition is a&nbsp;<strong>contrast esophagogram </strong>which will show the <strong>extravasation</strong> of the contrast.</p>\n<p><strong>Water-soluble contrast</strong>&nbsp;(iohexol) should be used instead of barium contrast to<strong> prevent</strong> barium-related <strong>inflammation</strong> of the mediastinum if there is perforation.</p>\n<p>If the esophagogram is normal, <strong>contrast-enhanced CT</strong> is useful in identifying the injury. If the radiological investigations are normal and suspicion of esophageal perforation is high, then endoscopy can be performed to confirm the diagnosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following cases of esophageal perforation will you not manage surgically?",
    "choices": [
      {
        "id": 1,
        "text": "Crepitus in the neck and difficulty breathing after nasogastric tube insertion"
      },
      {
        "id": 2,
        "text": "Severe chest pain and breathing difficulty following several episodes of vomiting"
      },
      {
        "id": 3,
        "text": "Septic shock due to pyothorax and mediastinitis on left side of lower esophagus"
      },
      {
        "id": 4,
        "text": "Epigastric pain radiating to the shoulder with air under the diaphragm"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The patient with crepitus in the neck and difficulty breathing after nasogastric tube insertion most likely has<strong> perforation</strong> of the <strong>cervical esophagus</strong>. <strong>Instrumental perforations</strong> in the<strong> cervical esophagus </strong>are<strong> usually small </strong>and can nearly always be <strong>managed</strong> <strong>conservatively.</strong></p>\n<p>Esophageal perforation is mostly due to <strong>spontaneous</strong> or <strong>iatrogenic causes</strong>. <strong>Iatrogenic instrument-induced</strong> perforation is the <strong>most common</strong> cause of esophageal perforation and is most common in the<strong> cervical esophagus </strong>in the cricopharyngeal area.</p>\n<p><strong>Clinical features include pain</strong> as the most common presentation. <strong>Crepitus</strong> may be present. <strong>Hamman sign</strong>&nbsp;is heard during auscultation which is a <strong>crunching, rasping sound</strong>, synchronous with the heartbeat.</p>\n<p><strong>Investigations</strong> include:&nbsp;</p>\n<ul>\n<li>X-ray chest</li>\n<li>CT scan</li>\n<li>Esophagogram</li>\n<li>Thoracentesis</li>\n<li>Serum amylase level may be raised.</li>\n</ul>\n<p><strong>Treatment </strong>is primary closure within 24 hours of injury and conservative treatment in selected cases.</p>\n<p><strong>Complications</strong> of esophageal perforation are <strong>pneumothorax</strong> and<strong> empyema</strong> (most common in the left side of the chest and <strong>bilateral in 10% of cases</strong>).</p>\n<table cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr>\n<td colspan=\"2\" valign=\"top\">\n<p><strong>Consideration for intervention in esophageal perforation</strong></p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p><strong>Indications for non-operative management</strong></p>\n</td>\n<td valign=\"top\">\n<p><strong>Indications for operative management</strong></p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p>Small septic load</p>\n</td>\n<td valign=\"top\">\n<p><strong>Large septic load</strong></p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p>Minimal cardiovascular upset</p>\n</td>\n<td valign=\"top\">\n<p>Septic shock</p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p><strong>Confined</strong> to <strong>mediastinum</strong></p>\n</td>\n<td valign=\"top\">\n<p>Pleura breached</p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p>Perforation of<strong> cervical esophagus</strong></p>\n</td>\n<td valign=\"top\">\n<p>Perforation of the abdominal esophagus</p>\n</td>\n</tr>\n<tr>\n<td valign=\"top\">\n<p>Perforation by flexible endoscope</p>\n</td>\n<td valign=\"top\">\n<p><strong>Boerhaave&rsquo;s syndrome</strong></p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Option B: The patient with <strong>severe chest pain</strong> and <strong>breathing difficulty</strong> following <strong>several episodes of vomiting</strong> most likely has <strong>Boerhaave syndrome</strong> which affects the lower third of the esophagus and requires&nbsp;<strong>primary closure within 24 hours</strong> of the injury for a better prognosis.</p>\n<p>Option C: Patients presenting with <strong>septic shock due to an infection in the chest </strong>(pyothorax or mediastinitis)&nbsp; following an esophageal perforation require <strong>emergency surgical stenting</strong>, debridement, or drainage.&nbsp;</p>\n<p>Option D: The presence of <strong>epigastric pain radiating to the shoulders </strong>with <strong>air under the diaphragm </strong>point to a diagnosis of <strong>abdominal esophagus perforation</strong>. It requires <strong>immediate surgical intervention</strong> to restore the integrity of the esophagus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 48-year-old woman presented with dysphagia and postprandial chest pain that is relieved on loud belching. On examination, the patient had pallor. Chest radiography showed an intrathoracic gas bubble. Which of the following is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Achalasia cardia"
      },
      {
        "id": 2,
        "text": "Carcinoma esophagus"
      },
      {
        "id": 3,
        "text": "Hiatus hernia"
      },
      {
        "id": 4,
        "text": "Esophageal perforation"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above clinical scenario is suggestive of a <strong>hiatus hernia.</strong>&nbsp;<strong>Hiatus hernia</strong> is the<strong> protrusion</strong> of any <strong>abdominal structure</strong> other than the esophagus into the thoracic cavity through a widening of the hiatus of the diaphragm.</p>\n<p><strong>Type 1 -&nbsp;sliding hernia:</strong></p>\n<p><strong>Gastroesophageal junction or cardia</strong> <strong>migrates </strong>into the thoracic cavity. The <strong>length of intra abdominal esophagus is reduced</strong> leading to GERD. Most of the patients are asymptomatic. The treatment of choice in symptomatic patients is <strong>fundoplication</strong>.</p>\n<p><strong>Type 2 -&nbsp;rolling hiatus hernia:</strong></p>\n<p>Gastroesophageal junction or cardia is normal but a <strong>portion</strong> of the <strong>stomach</strong> <strong>migrates</strong> into the thoracic cavity. The <strong>length of intra</strong>&nbsp;<strong>abdominal</strong> <strong>esophagus</strong> remains the <strong>same</strong> in a true rolling hiatus hernia.</p>\n<p>Clinical features:</p>\n<ul>\n<li>Chest pain or fullness relieved on belching.</li>\n<li>Dysphagia.</li>\n<li>Longitudinal ulcers (<strong>Cameron&rsquo;s</strong> <strong>ulcer</strong>) that <strong>bleeds,</strong>&nbsp;leading to <strong>anemia.</strong></li>\n</ul>\n<p><strong>Surgical reduction </strong>of hernia and<strong> tightening of diaphragmatic crura </strong>is the <strong>best treatment </strong>modality even in asymptomatic patients<strong>&nbsp;to avoid </strong>life-threatening<strong> complications like volvulus.</strong></p>\n<p><strong>Type 3 -&nbsp;mixed hiatus hernia:</strong></p>\n<p>A combination of sliding and rolling hiatus hernia. Treatment is the same as rolling hiatus hernia.</p>\n<p><strong>Type 4 hiatus hernia:</strong></p>\n<p><strong>Other contents of GIT herniates</strong> into the thoracic cavity. Eg: Colon.</p>\n<p><strong>CT with oral contrast</strong> is the best method of <strong>diagnosis&nbsp;</strong>of hiatus hernia. It highlights gastric anatomy and also helps to identify other structures involved. Chest X-ray shows an intrathoracic <strong>gas</strong> <strong>bubble</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0cd2b673915041f98c1811f84cb86d49x1280x3037.JPEG"
    ]
  }
];
        let quizName = '16 Esophagus - Congenital, Motility & Inflammatory Disorders';
        const quizFilename = '16-esophagus-congenital-motility-inflammatory-disorders-2755f29b.html';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>