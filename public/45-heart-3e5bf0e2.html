<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>45 Heart - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Anatomy
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">33</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following represents the surface marking of the aortic valve?",
    "choices": [
      {
        "id": 1,
        "text": "Sternal end of left third costal cartilage"
      },
      {
        "id": 2,
        "text": "Sternal end of the right third costal cartilage"
      },
      {
        "id": 3,
        "text": "Beside the sternum in the left third intercostal space"
      },
      {
        "id": 4,
        "text": "Beside the sternum in right third intercostal space"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The surface marking of aortic valve is beside the sternum in the left third intercostal space.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/15adb23ae12f4ee5a92fb638fc518294x1279x1715.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/29177f86b03649999258a588ddf811b5x1279x1715.JPEG"
    ]
  },
  {
    "text": "What is the surface marking of the mitral valve?",
    "choices": [
      {
        "id": 1,
        "text": "Behind the sternum end of the left 4th costal cartilage"
      },
      {
        "id": 2,
        "text": "Behind the sternal end of the right 4th costal cartilage"
      },
      {
        "id": 3,
        "text": "Left 4th intercostal space in midclavicular line"
      },
      {
        "id": 4,
        "text": "Left 3rd intercostal space in midclavicular line"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The orifice of the <strong>mitral valve</strong> is level with the left half of the sternum <strong>opposite the left 4<sup>th</sup> costal cartilage</strong> and is represented by a line approximately 3 cm long and descending to the right.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient developed hoarseness due to left recurrent laryngeal nerve weakness. TTE revealed compression of the nerve by the enlarged base of the heart. Which of the following chambers is likely to be dilated?",
    "choices": [
      {
        "id": 1,
        "text": "Right atrium"
      },
      {
        "id": 2,
        "text": "Left atrium"
      },
      {
        "id": 3,
        "text": "Right ventricle"
      },
      {
        "id": 4,
        "text": "Left ventricle"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>base of the heart</strong> is formed mainly by the <strong>left atrium.&nbsp;</strong>Enlargement of the left atrium can cause hoarseness due to compression of the left recurrent laryngeal nerve.</p>\n<p>The<strong> base of the heart</strong> is a quadrilateral directed posteriorly. It is made of:</p>\n<ul>\n<li>The<strong> left atrium</strong> mainly</li>\n<li>Small part of the <strong>right atrium</strong></li>\n<li>Proximal parts of superior vena cava, inferior vena cava, and pulmonary veins</li>\n</ul>\n<p>The <strong>base</strong> of the heart lies at the level of&nbsp;<strong>T5-T8 vertebrae</strong> in the supine position.</p>\n<p>The <strong>apex</strong> of the heart is formed by the <strong>left ventricle </strong>in the&nbsp;5<sup>th</sup>&nbsp;intercostal space.</p>\n<p>Surfaces of the heart:</p>\n<ul>\n<li><strong>Sternocostal</strong> surface - Formed by the <strong>right atrium, right and left ventricles</strong></li>\n<li><strong>Diaphragmatic</strong> surface - Formed mainly by the<strong> left ventricle</strong></li>\n<li><strong>Left surface</strong> - Formed mainly of the&nbsp;<strong>left ventricle</strong></li>\n<li><strong>Right surface</strong> - Formed mainly of the&nbsp;<strong>right atrium</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/85afeb32a82640dd9c8597ce8b161ed6x1280x1730.JPEG"
    ]
  },
  {
    "text": "The region marked corresponds to the surface marking for which of the following structures:",
    "choices": [
      {
        "id": 1,
        "text": "Thoracic duct"
      },
      {
        "id": 2,
        "text": "Right atrium"
      },
      {
        "id": 3,
        "text": "Inferomedial bronchopulmonary segments"
      },
      {
        "id": 4,
        "text": "Hilum"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The region marked corresponds to the surface marking for the <strong>right atrium.</strong></p>\n<p>The costal margin, xiphoid process, and the mid-clavicular line are seen in this image. The examiner draws a laterally convex line that extends from a level below the 2nd costal cartilage (as clued in by the sternal angle) i.e., 3rd costal cartilage to about 3 spaces below i.e., the 6th costal cartilage. This line is about 1.2 cms lateral to the sternal edge. These suggest that the region marked corresponds to the surface marking for the&nbsp;right atrium.</p>\n<p>The projection of the cardiac borders, of an average adult, onto the anterior thoracic wall forms a trapezoid.&nbsp; This can be mapped out using the percussion method by looking for cardiac dullness.&nbsp;</p>\n<p>The varying heart borders and the corresponding surface markings are as follows:</p>\n<ul>\n<li><strong>Upper border:</strong>&nbsp;Slopes gently from the second left costal cartilage to the third right costal cartilage. It corresponds to the&nbsp;<strong>left atrium</strong>.</li>\n<li><strong>Right border:</strong> Convex to the right and runs from the third to the sixth right costal cartilages, 1&ndash;2 cm lateral to the sternal edge. It corresponds to the <strong>right atrium</strong>.</li>\n<li><strong>Inferior border or</strong>&nbsp;<strong>acute</strong> <strong>border:</strong> Runs leftwards from the 6th right costal cartilage to the cardiac apex which is located approximately 9 cm lateral to the midline, often in the left 5th intercostal space or level with the 5th or 6th rib. It corresponds to the <strong>right ventricle</strong>.</li>\n<li><strong>Left border or</strong>&nbsp;<strong>obtuse border:</strong> Convex laterally on the left. It extends superomedially from the cardiac apex to meet the second left costal cartilage about 1 cm from the left sternal edge. It corresponds to the <strong>left ventricle</strong>.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0a25b4e922df422e89b951bec83a2f7d.GIF"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/24f47e3bbcef4939aa05bcd7798596eex1280x1715.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/edb8bdd74e644d878eb22b4d331a9a8bx1280x1715.JPEG"
    ]
  },
  {
    "text": "A 30-year-old man was brought to the emergency department after a car accident. He sustained a severe injury to the anterior chest wall from the impact caused by the steering wheel. X-ray revealed fracture of the body of the sternum. Which of the following chambers of the heart is most likely to be injured?",
    "choices": [
      {
        "id": 1,
        "text": "Left atrium"
      },
      {
        "id": 2,
        "text": "Left ventricle"
      },
      {
        "id": 3,
        "text": "Right ventricle"
      },
      {
        "id": 4,
        "text": "Right atrium"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The area posterior to the sternum is occupied by the <strong>right</strong> <strong>ventricle</strong> and hence is most likely to be injured in this case.<strong>&nbsp;</strong></p>\n<p>The convex anterosuperior surface of the <strong>right ventricle</strong> makes up a large part of the <strong>sternocostal aspect</strong> of the heart, and is separated from the thoracic wall only by the pericardium.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4418217b54944c559940d3107f26100dx1200x1316.JPEG"
    ]
  },
  {
    "text": "During the post-mortem heart examination of a patient, the resident palpates a muscular ridge, which is the site of origin of pectinate muscles.\u00a0In which of the following chambers is the resident palpating this structure?",
    "choices": [
      {
        "id": 1,
        "text": "Right atrium"
      },
      {
        "id": 2,
        "text": "Left atrium"
      },
      {
        "id": 3,
        "text": "Right ventricle"
      },
      {
        "id": 4,
        "text": "Left ventricle"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The structure being palpated by the resident is&nbsp;<strong>crista terminalis.</strong> It is present in the <strong>right atrium.</strong></p>\n<p>It is a <strong>muscular ridge</strong> that runs anteriorly along the atrial wall from the opening of the superior vena cava to the opening of the inferior vena cava. It corresponds externally to <strong>sulcus terminalis.</strong> It is the site of <strong>origin of pectinate muscles</strong>.&nbsp;</p>\n<p>It divides the right atrium into a smooth posterior part and a rough anterior part. Both the vena cavae empty into the posterior smooth part.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7a0dac33ed0a46f884594b8b685c479bx600x734.JPEG"
    ]
  },
  {
    "text": "The right border of the heart is formed by which of the following structures?",
    "choices": [
      {
        "id": 1,
        "text": "Right atrium"
      },
      {
        "id": 2,
        "text": "Right ventricle"
      },
      {
        "id": 3,
        "text": "Superior vena cava"
      },
      {
        "id": 4,
        "text": "Inferior vena cava"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The<strong> right border</strong> of the heart is formed of the <strong>right atrium.</strong></p>\n<p><strong>Borders </strong>of the<strong> heart:</strong></p>\n<ul>\n<li><strong>Right </strong>border:<strong> Right atrium</strong></li>\n<li><strong>Left </strong>border:&nbsp;<strong>Left ventricle</strong> mainly and to a slight extent by left atrial appendage</li>\n<li><strong>Inferior </strong>border:&nbsp;<strong>Right ventricle</strong> mainly and a small contribution by the left ventricle</li>\n<li><strong>Upper </strong>border: <strong>Left atrium</strong>, <strong>ascending aorta,</strong> and the <strong>pulmonary trunk.&nbsp;</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a43dee0a2c3e4527aee137611b6d4f25x1280x1729.JPEG"
    ]
  },
  {
    "text": "While doing the doppler USG of a fetal heart, you note blood flow from the right atrium to the left atrium. After the delivery, the connection eventually closes. What would form the floor of this structure after it closes?",
    "choices": [
      {
        "id": 1,
        "text": "Septum primum"
      },
      {
        "id": 2,
        "text": "Septum secundum"
      },
      {
        "id": 3,
        "text": "Endocardial cushions"
      },
      {
        "id": 4,
        "text": "Tricuspid valve orifice"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The structure mentioned here is the <strong>foramen ovale</strong> through which blood passes from the right atrium to the left atrium as part of fetal circulation. It <strong>closes at delivery</strong> and later forms <strong>fossa ovalis.</strong> The <strong>floor</strong> of the fossa ovalis is formed by the <strong>septum primum.</strong></p>\n<p>Fossa ovalis is an oval-shaped depression in the<strong> septal wall of the right atrium</strong> just above the opening of inferior vena cava. Its <strong>floor</strong> is formed by the remnant of <strong>septum primum</strong>. The <strong>limbus of fossa ovalis</strong> is the prominent rim of the depression which represents the remnant of <strong>septum secundum.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/da93804ee39b4a70ad1be9689a6a5d60x600x734.JPEG"
    ]
  },
  {
    "text": "What is the location of the sinoatrial node?",
    "choices": [
      {
        "id": 1,
        "text": "2,3, and 5"
      },
      {
        "id": 2,
        "text": "1,2,3 and 4"
      },
      {
        "id": 3,
        "text": "2 and 5"
      },
      {
        "id": 4,
        "text": "1,3, and 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>sinoatrial (SA) node </strong>is located at the<strong> upper part of the crista terminalis, </strong>at the junction of the superior vena cava opening to the right atrium. This is also the junction between the parts of the right atrium derived from sinus venosus and primitive atria.&nbsp;</p>\n<p>The <strong>Atrioventricular (AV) node</strong> lies at the lower back section of the&nbsp;interatrial septum&nbsp;near the opening of the&nbsp;coronary sinus. It is located in the center of<strong>&nbsp;</strong>the <strong>Koch triangle.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A cardiologist is doing the AV node ablation procedure for AVNRT. While locating the AV node, he would look at all of the following landmarks forming its boundary except:",
    "choices": [
      {
        "id": 1,
        "text": "Tendon of Todaro"
      },
      {
        "id": 2,
        "text": "Septal leaflet of tricuspid valve"
      },
      {
        "id": 3,
        "text": "Posterior leaflet of tricuspid valve"
      },
      {
        "id": 4,
        "text": "Coronary sinus"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>AV node</strong> is present in the center of the <strong>triangle of Koch.&nbsp;</strong>The posterior&nbsp;leaflet of the tricuspid valve does not form its boundary.</p>\n<p>The triangle of Koch is found on the <strong>smooth posterior wall</strong> of the <strong>right atrium.</strong>&nbsp;It is bound by:</p>\n<ul>\n<li><strong>The coronary sinus</strong></li>\n<li><strong>Tendon of Todaro</strong></li>\n<li><strong>The septal cusp of the tricuspid valve</strong></li>\n</ul>\n<p>The triangle of Koch can be seen in the image below bound by the dashed blue lines:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0bc7549c15ed413488d5f66ae4a4ff37x1280x2012.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is false regarding the SA node?",
    "choices": [
      {
        "id": 1,
        "text": "It is located at the right border of ascending aorta"
      },
      {
        "id": 2,
        "text": "It contains specialized nodal cardiac muscle"
      },
      {
        "id": 3,
        "text": "It is supplied by the atrial branches of the right coronary artery"
      },
      {
        "id": 4,
        "text": "Action potential generated here does not have phase 1 or 2"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Sino-atrial (SA) node&nbsp;</strong>is not located at the right border of the ascending aorta.</p>\n<p>It is located at the opening of the superior vena cava into the right atrium. It is called the <strong>'pacemaker'</strong> of the heart.&nbsp;It is supplied by the atrial branches of the right coronary artery. It contains specialized nodal cardiac muscle which&nbsp;spontaneously produces an electrical impulse. The action potential of these cells does not have phase 1 or 2.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/72463b08cb6a44848f032162d449409bx800x600.GIF"
    ]
  },
  {
    "text": "A 40-year-old man underwent coronary artery bypass grafting. During the procedure, the surgeon applied a clamp to the vessel lying anterior to the transverse pericardial sinus. Identify the vessel.",
    "choices": [
      {
        "id": 1,
        "text": "Aorta"
      },
      {
        "id": 2,
        "text": "Pulmonary artery"
      },
      {
        "id": 3,
        "text": "Inferior vena cava"
      },
      {
        "id": 4,
        "text": "Superior vena cava"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<h4>Clinical significance:</h4>\n<p>During cardiac surgery, the transverse pericardial sinus allows a surgeon to isolate the pulmonary trunk and ascending aorta and apply a temporary ligature or clamp.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d63a6d649ca54933b774d66c22e8f8a5x600x767.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a09bdc3afc4f48f193770322d0b05de9x1280x1117.JPEG"
    ]
  },
  {
    "text": "How many papillary muscles are there in the left ventricle?",
    "choices": [
      {
        "id": 1,
        "text": "2"
      },
      {
        "id": 2,
        "text": "3"
      },
      {
        "id": 3,
        "text": "5"
      },
      {
        "id": 4,
        "text": "8"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The left ventricle has 2 papillary muscles.</p>\n<p>There are <strong>3 papillary muscles </strong>in the <strong>right ventricle</strong>:</p>\n<ul>\n<li>Anterior,</li>\n<li>Posterior</li>\n<li>Septal muscles</li>\n</ul>\n<p>There are <strong>2 papillary muscles</strong> in the <strong>left ventricle</strong>:</p>\n<ul>\n<li>Anterior</li>\n<li>Posterior</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What are Purkinje fibers?",
    "choices": [
      {
        "id": 1,
        "text": "Modified nerve fibers"
      },
      {
        "id": 2,
        "text": "Modified smooth muscle"
      },
      {
        "id": 3,
        "text": "Modified cardiac muscle"
      },
      {
        "id": 4,
        "text": "Fibrous tissue"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Purkinje fibers</strong> are <strong>modified cardiac muscles.</strong></p>\n<p>The Purkinje network is subendocardial and the&nbsp;<strong>muscular excitation</strong> proceeds from<strong> endocardium to epicardium</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A surgeon opens the pericardial sac anteriorly during surgery. He passes a surgical clamp through the transverse sinus. The circulation of blood in which of the following structures is stopped/diverted by his action?",
    "choices": [
      {
        "id": 1,
        "text": "Superior and inferior vena cava"
      },
      {
        "id": 2,
        "text": "Aorta and pulmonary veins"
      },
      {
        "id": 3,
        "text": "Aorta and pulmonary trunk"
      },
      {
        "id": 4,
        "text": "SVC and pulmonary veins"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>During surgery, a <strong>clamp</strong> is passed through the <strong>transverse sinus.</strong> This <strong>stops/diverts</strong> the <strong>blood</strong> flow from the <strong>aorta</strong> and <strong>pulmonary trunk.</strong>&nbsp;</p>\n<p>The transverse pericardial sinus separates the arterial end of the heart tube from the venous end. <strong>Aorta</strong> and <strong>pulmonary trunk </strong>lie <strong>anterior</strong> to the sinus and the&nbsp;<strong>superior vena cava</strong> lies <strong>posterior</strong> to it. Therefore, during surgery, a clamp passed through the transverse sinus stops or diverts the blood flow from the aorta and pulmonary trunk.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d645caaa3400442da5928013f071bf77x1280x1117.JPEG"
    ]
  },
  {
    "text": "A cardiologist while reviewing a case of MI, notes that the patient has right dominant circulation. Which of the following determines coronary dominance?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior interventricular artery"
      },
      {
        "id": 2,
        "text": "Anterior interventricular artery"
      },
      {
        "id": 3,
        "text": "Circumflex artery"
      },
      {
        "id": 4,
        "text": "Right coronary artery"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Coronary dominance </strong>is determined by the<strong> posterior interventricular artery (PIVA)</strong>.</p>\n<p>In about<strong> 65% of the population</strong>, the PIVA is given by the right coronary artery and this is called the&nbsp;<strong>right cardiac dominance</strong>.</p>\n<p>In <strong>10% of the population</strong>, it is a branch of the left coronary artery alone, called the<strong> left cardiac dominance</strong>.</p>\n<p>In the <strong>remaining 25% </strong>population, it is given by<strong> both (balanced dominance). </strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Coronary angiography of a patient revealed posterior interventricular artery branching from the circumflex artery. What would the arterial circulation in this patient be called?",
    "choices": [
      {
        "id": 1,
        "text": "Right dominant"
      },
      {
        "id": 2,
        "text": "Left dominant"
      },
      {
        "id": 3,
        "text": "Balanced dominant"
      },
      {
        "id": 4,
        "text": "Codominant"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>If the circumflex artery gives off the posterior interventricular artery, then the arterial supply is called left dominant.</p>\n<p>In 65% of the population,\u00a0 the <strong>posterior interventricular artery (PIVA)</strong> is a branch of the\u00a0<strong>right coronary artery</strong> and this is called the <strong>right dominance.</strong></p>\n<p>In 10% of the population, <strong>PIVA</strong> is given by the <strong>circumflex artery</strong> (a branch of the left coronary artery) and this is called the <strong>left dominance</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/08ff9102fdf84958ba8514969e99013ex600x508.JPEG"
    ]
  },
  {
    "text": "All of the following are true about the right coronary artery except _____",
    "choices": [
      {
        "id": 1,
        "text": "It's diameter is less than left coronary artery"
      },
      {
        "id": 2,
        "text": "It arises from the anterior aortic sinus"
      },
      {
        "id": 3,
        "text": "It gives rise to circumflex coronary branch"
      },
      {
        "id": 4,
        "text": "Right conal artery is it's first branch"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The right coronary artery does not give rise to the circumflex coronary artery.</p>\n<p>The right coronary artery <strong>arises from</strong> <strong>the anterior aortic sinus (right coronary sinus)</strong>&nbsp;of the ascending aorta. It passes anteriorly and descends vertically in the coronary sulcus between the right atrium and the right ventricle. On reaching the inferior margin, it turns posteriorly and continues in the sulcus onto the diaphragmatic surface and the base of the heart.</p>\n<p>The diameter of the right coronary artery is less than that of the left coronary artery.</p>\n<p>The <strong>right conal artery</strong> is, usually the <strong>first branch </strong>of the right coronary artery.</p>\n<p>The<strong> circumflex coronary artery </strong>is a <strong>branch of</strong> the <strong>left coronary artery </strong>and is the <strong>exclusive supplier</strong> to the <strong>right bundle branch.&nbsp;</strong></p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ebc4d663af304e4f89302b50e0f37e56x600x508.JPEG"
    ]
  },
  {
    "text": "A 55-year-old man presented with angina. Coronary angiography revealed a block in the right coronary artery. Blood supply through which of the following arteries would not be affected?",
    "choices": [
      {
        "id": 1,
        "text": "Acute marginal"
      },
      {
        "id": 2,
        "text": "Posterior interventricular artery"
      },
      {
        "id": 3,
        "text": "Artery to SA node"
      },
      {
        "id": 4,
        "text": "Circumflex artery"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>circumflex artery </strong>is a <strong>branch</strong> of the&nbsp;<strong>left coronary</strong> <strong>artery</strong>, not the right coronary artery.<strong>&nbsp;</strong>Hence, blood supply through the circumflex artery won't be affected.</p>\n<p>The branches of the right coronary artery are:</p>\n<ul>\n<li><strong>Right conal artery -</strong>&nbsp;first branch of the right coronary artery</li>\n<li><strong>Artery of the SA node&nbsp;</strong></li>\n<li><strong>Acute right marginal artery&nbsp;</strong></li>\n<li><strong>Posterior interventricular artery</strong> (in 65% population)</li>\n<li>Atrial and anterior and posterior ventricular branches</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0157f821b2d9443c80d33f5f89a709bfx600x508.JPEG"
    ]
  },
  {
    "text": "All of the following supply the marked structure except :",
    "choices": [
      {
        "id": 1,
        "text": "Right coronary artery"
      },
      {
        "id": 2,
        "text": "Anterior interventricular artery"
      },
      {
        "id": 3,
        "text": "Marginal artery"
      },
      {
        "id": 4,
        "text": "Diagonal artery"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The structure marked is the <strong>right ventricle.</strong> It is<strong> not supplied</strong> by the <strong>diagonal artery.</strong></p>\n<p>The diagonal artery is a <strong>branch of </strong>the <strong>anterior interventricular artery </strong>supplying the <strong>left ventricle. </strong>This is present in about 30-50% of the population.</p>\n<p>The right ventricle is mostly supplied by the right coronary artery and its branches such as the marginal artery.</p>\n<p>The anterior interventricular artery gives off 1-2 anterior right ventricular branches.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a8639e1f60ae42babde630f979b03b7c.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4c3ecbe52065497582c813fa67912776x600x508.JPEG"
    ]
  },
  {
    "text": "A patient underwent angioplasty with a Sirolimus-eluting stent in the anterior interventricular artery. This artery is a branch of:",
    "choices": [
      {
        "id": 1,
        "text": "Right coronary artery"
      },
      {
        "id": 2,
        "text": "Left coronary artery"
      },
      {
        "id": 3,
        "text": "Circumflex artery"
      },
      {
        "id": 4,
        "text": "Left anterior descending artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The anterior interventricular artery is a branch of the <strong>left coronary artery.</strong></p>\n<p>The left coronary artery <strong>arises from the left aortic sinus</strong> (left posterior sinus) of the ascending aorta. It passes between the pulmonary trunk and the left auricle and then runs in the coronary sulcus. It divides into its <strong>two terminal branches</strong> in the coronary sulcus. They are:</p>\n<ul>\n<li><strong>Anterior interventricular branch</strong> - also called the&nbsp;<strong>left anterior descending artery (LAD).</strong></li>\n<li><strong>Circumflex branch</strong> - It gives a <strong>left marginal artery</strong> also called the obtuse marginal artery supplying the left ventricle.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d3f53f322b3a4317a3f2ec04cc55281ax600x508.JPEG"
    ]
  },
  {
    "text": "In a patient with STEMI, nuclear stress test revealed poor blood supply to the anterior two-thirds of the interventricular septum. Which of the following blood vessels is most likely to be blocked?",
    "choices": [
      {
        "id": 1,
        "text": "Right coronary artery"
      },
      {
        "id": 2,
        "text": "Left coronary artery"
      },
      {
        "id": 3,
        "text": "Posterior interventricular artery"
      },
      {
        "id": 4,
        "text": "Circumflex artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>anterior two-thirds of the interventricular septum </strong>is supplied by the<strong> left coronary artery</strong>. Hence, this artery is most likely blocked.</p>\n<p>The <strong>right coronary artery</strong>&nbsp;distribution supplies:</p>\n<ul>\n<li><strong>Right atrium</strong></li>\n<li><strong>Right ventricle</strong> (except a small region to the right of the anterior interventricular groove)</li>\n<li>A variable part of the diaphragmatic aspect of the left ventricle</li>\n<li><strong>Posteroinferior 1/3<sup>rd</sup> of the interventricular septum</strong></li>\n<li><strong>Part of the left atrium</strong></li>\n<li>The <strong>conduction system,</strong> as far as the proximal parts of the right and left crura</li>\n</ul>\n<p>The <strong>left coronary artery</strong> distribution supplies:</p>\n<ul>\n<li><strong>Left atrium</strong></li>\n<li><strong>Left ventricle</strong></li>\n<li>A narrow strip of the right ventricle</li>\n<li>The <strong>anterior 2/3<sup>rd</sup> of the interventricular septum</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bf46e586a684439c806fd631da55dc72x600x508.JPEG"
    ]
  },
  {
    "text": "What is the arterial supply of the structure labelled in the picture with the blue dotted line?",
    "choices": [
      {
        "id": 1,
        "text": "Right coronary artery"
      },
      {
        "id": 2,
        "text": "Left coronary artery"
      },
      {
        "id": 3,
        "text": "Left anterior descending artery"
      },
      {
        "id": 4,
        "text": "Artery from the left posterior aortic sinus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image shows a <strong>triangle of Koch</strong> marked with blue dotted lines. The <strong>arterial supply</strong> to the triangle of Koch is from the <strong>right coronary artery</strong> in the majority of the population.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/090394c009244de1a16693413ddf74bd.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient with a recent MI underwent coronary angiography, which revealed a block in the anterior interventricular artery. The infarction is likely to be present in which of the following regions of the heart?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior part of interventricular septum"
      },
      {
        "id": 2,
        "text": "Anterior wall of the left ventricle"
      },
      {
        "id": 3,
        "text": "Lateral part of the heart"
      },
      {
        "id": 4,
        "text": "Inferior surface of the right ventricle"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Options A and D: The <strong>posterior interventricular artery</strong> supplies the <strong>posterior part of the interventricular septum </strong>and the <strong>inferior part of the right ventricle.</strong></p>\n<p>Option C: The left <strong>lateral surface of the heart</strong> is supplied by the <strong>circumflex artery</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7216c43973b04aeda62d73c480be480cx600x508.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a tributary of the coronary sinus?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior cardiac vein"
      },
      {
        "id": 2,
        "text": "Small cardiac vein"
      },
      {
        "id": 3,
        "text": "Anterior cardiac vein"
      },
      {
        "id": 4,
        "text": "Great cardiac vein"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Anterior cardiac vein</strong> does not open into the coronary sinus. It drains <strong>directly</strong> into the <strong>right atrium.</strong></p>\n<p><strong>Tributaries of coronary sinus</strong> include the following:</p>\n<ul>\n<li>Great cardiac vein</li>\n<li>Middle cardiac vein</li>\n<li>Small cardiac vein</li>\n<li>Posterior cardiac vein</li>\n<li>Oblique vein of the left atrium&nbsp;</li>\n</ul>\n<p><strong>Thebsian vein/venae cordis minimae, anterior cardiac veins,</strong> and the <strong>right marginal vein</strong> drain directly into the<strong> right atrium</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1e5bddf2c623467ca03d234a2b10b600x600x824.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7e3c37e4da82474d9ef8120fe15b27dcx600x820.JPEG"
    ]
  },
  {
    "text": "Where does the great cardiac vein lie?",
    "choices": [
      {
        "id": 1,
        "text": "Anterior part of the coronary sulcus"
      },
      {
        "id": 2,
        "text": "Posterior part of the right coronary sulcus"
      },
      {
        "id": 3,
        "text": "Anterior interventricular groove"
      },
      {
        "id": 4,
        "text": "Posterior interventricular groove"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The great cardiac vein lies in the anterior interventricular sulcus.</p>\n<p>The <strong>great cardiac vein</strong> begins at the cardiac apex, and <strong>ascends in</strong> the <strong>anterior interventricular groove to</strong> the <strong>atrioventricular groove</strong>, which it follows, passing to the left and posteriorly to <strong>enter the coronary sinus</strong> at its origin.</p>\n<p>The great cardiac vein <strong>accompanies</strong> the anterior interventricular artery (<strong>left anterior descending artery</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d29195cb2afc40e69801b0a3763405a0x600x824.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a3bd0bfa10754542b265785398a23d04x600x820.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is true regarding the coronary sinus?",
    "choices": [
      {
        "id": 1,
        "text": "It lies in the anterior part of coronary sulcus"
      },
      {
        "id": 2,
        "text": "It ends in the right atrium"
      },
      {
        "id": 3,
        "text": "It has venae cordis minimae as its tributaries"
      },
      {
        "id": 4,
        "text": "It develops from the right anterior cardinal vein"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Coronary sinus ends in the right atrium.&nbsp;</p>\n<p><strong>Coronary sinus</strong> develops from the <strong>left horn of the sinus venosus</strong>&nbsp;and lies in the <strong>posterior part of the atrioventricular groove. </strong>The sinus <strong>opens into the right atrium</strong> between the opening of the inferior vena cava and the right atrioventricular orifice.</p>\n<p>Venae cordis minimae drains directly into the nearest heart chamber (drains into all 4 chambers).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b9c435c8f4ae443aa327cff8486d45b8x600x824.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/69c370dbcaeb458e9f189fc0b398421cx600x820.JPEG"
    ]
  },
  {
    "text": "A 58-year-old man is undergoing coronary artery bypass grafting. The coronary angiography revealed total blockage of the posterior descending artery. While exposing this artery during the procedure, which accompanying vessel is most likely to be injured?",
    "choices": [
      {
        "id": 1,
        "text": "Great cardiac vein"
      },
      {
        "id": 2,
        "text": "Posterior vein of left ventricle"
      },
      {
        "id": 3,
        "text": "Small cardiac vein"
      },
      {
        "id": 4,
        "text": "Middle cardiac vein"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\">The </span></span><strong><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\">middle cardiac vein</span></span></strong><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\"> is present in t</span></span><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\">he </span></span><strong><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\">posterior </span></span><span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\">interventricular </span></span>groove</strong> accompanying<span class=\"TextRun SCXW192943509 BCX4\" lang=\"EN-GB\" xml:lang=\"EN-GB\" data-contrast=\"auto\"><span class=\"NormalTextRun SCXW192943509 BCX4\"> the <strong>posterior descending artery</strong>, and hence is most likely to be injured in this case.</span></span><span class=\"EOP SCXW192943509 BCX4\" data-ccp-props=\"{&quot;201341983&quot;:0,&quot;335551550&quot;:1,&quot;335551620&quot;:1,&quot;335559739&quot;:160,&quot;335559740&quot;:259}\">&nbsp;</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is wrong about the venous drainage of the heart?",
    "choices": [
      {
        "id": 1,
        "text": "Coronary sinus is guarded by the Thebesian valve"
      },
      {
        "id": 2,
        "text": "Middle cardiac vein lies in the posterior atrioventricular groove"
      },
      {
        "id": 3,
        "text": "Great cardiac vein accompanies left anterior descending artery"
      },
      {
        "id": 4,
        "text": "Venae cordis minimae open into all 4 chambers"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>middle cardiac veins lie </strong>in the <strong>posterior interventricular groove</strong> and not the posterior atrioventricular groove.</p>\n<p>Option A: The opening of the coronary sinus may be guarded by a semilunar valve of the coronary sinus,&nbsp;the&nbsp;Thebesian valve.</p>\n<p>Option C: The great cardiac vein accompanies the anterior interventricular artery (left anterior descending artery) in the anterior interventricular groove.</p>\n<div class=\"page\" title=\"Page 1424\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Option D: The venae cordis minimae /&nbsp;Thebesian veins&nbsp;open into all cardiac chambers.</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with thrombosis of the coronary sinus, which of the following cardiac veins are least likely to get dilated?",
    "choices": [
      {
        "id": 1,
        "text": "Middle cardiac vein"
      },
      {
        "id": 2,
        "text": "Small cardiac vein"
      },
      {
        "id": 3,
        "text": "Oblique cardiac vein"
      },
      {
        "id": 4,
        "text": "Anterior cardiac vein"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>anterior cardiac vein</strong> drains<strong> directly </strong>into the <strong>right atrium</strong> and not into the coronary sinus, hence, they might remain normal in coronary sinus thrombosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of these veins does not open into the sinus venarum?",
    "choices": [
      {
        "id": 1,
        "text": "Superior vena cava"
      },
      {
        "id": 2,
        "text": "Coronary sinus"
      },
      {
        "id": 3,
        "text": "Inferior vena cava"
      },
      {
        "id": 4,
        "text": "Small cardiac vein"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Small cardiac vein</strong> does not open into the sinus venarum. It opens into the <strong>coronary sinus.</strong></p>\n<p><strong>Superior vena cava</strong>, <strong>coronary sinus, </strong>and the <strong>inferior vena cava</strong>&nbsp;open into the <strong>sinus venarum</strong> or the <strong>smooth posterior part of the right atrium.&nbsp;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Sympathetic innervation of heart is by ________",
    "choices": [
      {
        "id": 1,
        "text": "T1-T3"
      },
      {
        "id": 2,
        "text": "T1-T5"
      },
      {
        "id": 3,
        "text": "T3-T7"
      },
      {
        "id": 4,
        "text": "L1-L5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The sympathetic innervation of the heart is by T1-T5.</p>\n<p>The <strong>preganglionic sympathetic nerves</strong> to the <strong>heart</strong> arise from <strong>T1-T5</strong>. Some of these synapse in the upper thoracic sympathetic ganglia and some synapse in the cervical ganglia. The postganglionic fibres from these ganglia form the sympathetic cardiac nerves and innervate the heart.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Where is cardiac ganglion situated?",
    "choices": [
      {
        "id": 1,
        "text": "Below the arch of aorta"
      },
      {
        "id": 2,
        "text": "Above the arch of aorta"
      },
      {
        "id": 3,
        "text": "Left side of ligamentum arteriosum"
      },
      {
        "id": 4,
        "text": "Posterior to ligamentum arteriosum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The cardiac ganglion of Wrisberg is present in the superficial cardiac plexus immediately <strong>below and slightly in front of the arch of aorta</strong> to the <strong>right of the ligamentum arteriosum. </strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '45 Heart';
        const quizFilename = '45-heart-3e5bf0e2.html';
        let hierarchy = ["Marrow", "qBank", "Anatomy"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>