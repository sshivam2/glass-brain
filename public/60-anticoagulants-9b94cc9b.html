<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>60 Anticoagulants - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pharmacology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">36</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A patient with sustained atrial fibrillation was given heparin cover. What is the primary mechanism of action of the drug?",
    "choices": [
      {
        "id": 1,
        "text": "Activation of thrombin"
      },
      {
        "id": 2,
        "text": "Activation of antithrombin"
      },
      {
        "id": 3,
        "text": "Inhibition of antithrombin"
      },
      {
        "id": 4,
        "text": "Direct inhibition of thrombin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\" style=\"text-align: justify;\">The primary mechanism of action of heparin is by <strong>activation of antithrombin</strong>.&nbsp;</p>\n<p class=\"p1\" style=\"text-align: justify;\">In patients with atrial fibrillation that has persisted for more than 48 hours, heparin can be used to&nbsp;<strong>reduce the risk of thrombus formation and embolization</strong>&nbsp;until the warfarin level is therapeutic or cardioversion is performed.&nbsp;</p>\n<p class=\"p1\" style=\"text-align: justify;\">Heparin,<strong>&nbsp;</strong>low molecular weight&nbsp;heparin (LMWHs), and fondaparinux&nbsp;have no intrinsic anticoagulant activity. They bind to antithrombin and accelerates the rate at which it <strong>inhibits</strong> various coagulation proteases, especially <strong>thrombin (factor IIa) </strong>and<strong>&nbsp;factor Xa</strong>.</p>\n<p class=\"p1\" style=\"text-align: justify;\">LMWH has some action against thrombin. However, fondaparinux has <strong>no action</strong> against thrombin.</p>\n<p class=\"p1\" style=\"text-align: justify;\">Antithrombin inhibits these factors by serving as a&nbsp;&ldquo;<strong>suicide substrate</strong>&rdquo;.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not true about heparin?",
    "choices": [
      {
        "id": 1,
        "text": "It is the weakest acid found in the body"
      },
      {
        "id": 2,
        "text": "It is commonly obtained from pig intestine"
      },
      {
        "id": 3,
        "text": "It acts by activation of antithrombin"
      },
      {
        "id": 4,
        "text": "It can lead to thrombocytopenia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\">Heparin is the <strong>strongest organic acid</strong> present in the body.</p>\n<p style=\"text-align: justify;\">Option B: Most commercial preparations of heparin are extracted from&nbsp;the&nbsp;<strong>porcine intestinal mucosa</strong>.</p>\n<p style=\"text-align: justify;\">Option C: Heparin acts indirectly through the <strong>activation of antithrombin</strong> and inhibition of factors IIa and Xa.</p>\n<p style=\"text-align: justify;\">Option D: Heparin use can result in<strong> thrombocytopenia</strong> due to the development of antibodies to heparin-platelet factor 4 complex.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient is receiving low dose heparin infusions after hip replacement surgery to prevent thromboembolism. Which of the following abnormalities are least likely to be expected in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Prolonged aPTT"
      },
      {
        "id": 2,
        "text": "Alopecia"
      },
      {
        "id": 3,
        "text": "Hypokalemia"
      },
      {
        "id": 4,
        "text": "Thrombocytopenia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Hypokalemia is least likely seen in this patient because <strong>heparin-induced hypoaldosteronism</strong> causes <strong>hyperkalemia</strong>.</p>\n<p><strong>aPTT is prolonged</strong> in heparin therapy and is used to <strong>monitor</strong> its anticoagulant effect.</p>\n<p>The other side-effects of heparin are (OATH):</p>\n<p style=\"padding-left: 30px;\">O - <strong>O</strong>steoporosis</p>\n<p style=\"padding-left: 30px;\">A - <strong>A</strong>lopecia (reversible)</p>\n<p style=\"padding-left: 30px;\">T - <strong>T</strong>hrombocytopenia (Heparin-Induced Thrombocytopenia - HIT)</p>\n<p style=\"padding-left: 30px;\">H - <strong>H</strong>emorrhage, <strong>H</strong>yperkalemia</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "For the action of heparin as an anticoagulant, availability of which of the following chemical substances is mandatory?",
    "choices": [
      {
        "id": 1,
        "text": "Thrombin"
      },
      {
        "id": 2,
        "text": "Plasmin"
      },
      {
        "id": 3,
        "text": "Antithrombin-III"
      },
      {
        "id": 4,
        "text": "Thrombomodulin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p style=\"text-align: justify;\"><strong> Antithrombin-III</strong> is mandatory for the action of heparin<strong>&nbsp;</strong>as an anticoagulant. <strong>Reduced antithrombin</strong> levels can lead to <strong>resistance</strong>.</p>\n<div class=\"c-article-section__content\">\n<p><strong>Heparin resistance </strong>refers to<strong> failure to&nbsp;</strong><strong>achieve a therapeutic aPTT</strong> with daily doses of heparin of 35,000 units or more.</p>\n<p>In true heparin resistance, there is an actual blunting of heparin&rsquo;s anticoagulant effect.&nbsp;This occurs due to:</p>\n<ul>\n<li><strong>Low ATIII </strong>levels (most common cause)</li>\n<li>Increased heparin-binding plasma proteins (acute phase reactants)</li>\n<li>Increased heparin clearance (e.g. due to splenomegaly in liver disease)</li>\n</ul>\n</div>\n<div class=\"c-article-section__content\">\n<p>Low ATIII levels could be due to decreased synthesis (hereditary, hepatic failure), increased consumption (DIC, MAHA, or in a bypass circuit) or increased loss (nephrotic syndrome).</p>\n<p>The <strong>dose of heparin has to be increased</strong> to achieve therapeutic&nbsp;aPTT. Severe antithrombin deficiency may require antithrombin concentrate as well.</p>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/de69baed8b1d41cdbb00c4d4e5c135e4x1279x2261.JPEG"
    ]
  },
  {
    "text": "A patient scheduled for a CABG procedure receives preoperative heparin for anticoagulation. During the surgery, the patient starts bleeding massively and there is a drop in BP. Which of the following would you use to manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Protamine sulfate"
      },
      {
        "id": 2,
        "text": "Prothrombin complex concentrate"
      },
      {
        "id": 3,
        "text": "Aminocaproic acid"
      },
      {
        "id": 4,
        "text": "Tranexamic acid"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\"><strong>Protamine sulfate </strong>is the drug used to treat life-threatening, <strong>heparin-induced bleeding</strong>.</p>\n<p style=\"text-align: justify;\">It is a mixture of basic polypeptides isolated from <strong>salmon sperm</strong>.&nbsp;It binds to acidic heparin with high affinity and neutralizes anticoagulant activity. The resultant protamine-heparin complexes are cleared. Protamine binds only to <strong>long heparin </strong>molecules (UFH). Therefore, protamine only <strong>partially reverses</strong>&nbsp;the activity of <strong>LMWH</strong> and has <strong>no effect</strong> on&nbsp;<strong>fondaparinux</strong>.&nbsp;</p>\n<p class=\"p1\" style=\"text-align: justify;\">It is most commonly used to neutralize heparin-induced anticoagulation after separation from cardiopulmonary bypass. It is also utilized in the setting of dialysis, invasive vascular procedures, and acute ischemic strokes.</p>\n<p class=\"p1\" style=\"text-align: justify;\">Note: Protamine sulfate has<strong> anticoagulant activity</strong> at <strong>higher doses</strong> and hence, only small amounts of protamine (1mg/100 units of heparin) are used for heparin-induced bleeding.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Life-threatening bleeding in a patient receiving heparin is treated immediately with a drug X that reverses its effects. Identify the type of antagonism between X and heparin.",
    "choices": [
      {
        "id": 1,
        "text": "Chemical"
      },
      {
        "id": 2,
        "text": "Physical"
      },
      {
        "id": 3,
        "text": "Physiological"
      },
      {
        "id": 4,
        "text": "Competitive"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\">The drug antagonism between heparin and protamine sulfate (Drug X) is an example of <strong>chemical antagonism</strong>.</p>\n<p style=\"text-align: justify;\">Protamine sulfate is a mixture of basic polypeptides that are positively charged. They bind to the highly acidic heparin with a strong negative charge and form protamine-heparin complexes that are cleared.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Predominant activity of low-molecular-weight heparin is seen against which clotting factor?",
    "choices": [
      {
        "id": 1,
        "text": "IIa"
      },
      {
        "id": 2,
        "text": "IXa"
      },
      {
        "id": 3,
        "text": "XIIa"
      },
      {
        "id": 4,
        "text": "Xa"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Low-molecular-weight heparin(<strong>LMWH</strong>)&nbsp;has predominant activity against&nbsp;<strong>factor Xa. </strong></p>\n<p>LMWH has an anti-factor activity against <strong>both</strong> Xa and IIa with a <strong>greater</strong> effect on Xa.&nbsp; &nbsp;<strong>&nbsp;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "LMWH is given by which route?",
    "choices": [
      {
        "id": 1,
        "text": "Intravenous"
      },
      {
        "id": 2,
        "text": "Subcutaneous"
      },
      {
        "id": 3,
        "text": "Intramuscular"
      },
      {
        "id": 4,
        "text": "Intradermal"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>LMWH</strong> is given by the&nbsp;<strong>subcutaneous</strong> route.</p>\n<p>Heparin, low molecular weight heparin (LMWH), and fondaparinux are not absorbed through GI mucosa and must be given parenterally.</p>\n<p>LMWH and fondaparinux are given <strong>subcutaneously.</strong></p>\n<p><strong>Heparin</strong> can be given through<strong>&nbsp;intravenous infusion</strong> and <strong>subcutaneous</strong> routes.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "As compared to unfractionated heparin, which of the following is true about enoxaparin?",
    "choices": [
      {
        "id": 1,
        "text": "Is absorbed more uniformly when given subcutaneously"
      },
      {
        "id": 2,
        "text": "Requires more frequent laboratory monitoring"
      },
      {
        "id": 3,
        "text": "Can be given to patients with heparin induced thrombocytopenia"
      },
      {
        "id": 4,
        "text": "Predisposes to a higher risk of osteopenia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Enoxaparin</strong> (LMWH) has a <strong>very high bioavailability</strong> and is absorbed more uniformly when compared to unfractionated heparin. Hence, it does not require frequent monitoring.</p>\n<p>LMWH can also lead to heparin-induced thrombocytopenia (HIT) and hence, it cannot be given in patients with HIT.&nbsp;</p>\n<p class=\"p1\">LMWH preparations:</p>\n<ul>\n<li class=\"p1\">Enoxaparin</li>\n<li class=\"p1\">Dalteparin</li>\n<li class=\"p1\">Tinzaparin.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which is the anticoagulant of choice for the management of cancer-associated thromboembolism?",
    "choices": [
      {
        "id": 1,
        "text": "Unfractionated Heparin"
      },
      {
        "id": 2,
        "text": "Warfarin"
      },
      {
        "id": 3,
        "text": "Low molecular weight heparin"
      },
      {
        "id": 4,
        "text": "Dabigatran"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The anticoagulant of choice for the management of<strong> cancer-associated thromboembolism</strong> is <strong>l</strong><strong>ow-molecular-weight heparin </strong>(LMWH).</p>\n<p>It is the preferred agent because of more bioavailability, lack of need for anticoagulant monitoring, and a long t1/2.&nbsp;</p>\n<p>Venous thromboembolism (including deep vein thrombosis, pulmonary embolism, and splanchnic vein thrombosis), is a frequent complication of cancer and is the second-leading cause of death in cancer patients receiving chemotherapy.</p>\n<p>Based on the results from the&nbsp;<strong>C</strong>omparison of <strong>L</strong>ow-molecular-weight&nbsp;heparin vs.&nbsp;<strong>O</strong>ral anticoagulants for long-term anticoagulation in cancer patients with venous <strong>T</strong>hromboembolism (<strong>CLOT</strong>) Trial, all recent guidelines now advise LMWH for cancer-associated thromboembolism.&nbsp;</p>\n<p>However, unfractionated heparin <strong>(UFH)</strong> can be used in patients with <strong>renal failure</strong>, and <strong>fondaparinux</strong> can be considered in patients with heparin-induced thrombocytopenia (<strong>HIT</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Fondaparinux can be best described as which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Low molecular weight heparin"
      },
      {
        "id": 2,
        "text": "Antithrombin activator"
      },
      {
        "id": 3,
        "text": "Direct thrombin inhibitor"
      },
      {
        "id": 4,
        "text": "Direct factor Xa inhibitor"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\">Fondaparinux is an <strong>antithrombin activator.</strong></p>\n<p style=\"text-align: justify;\">It is a synthetic analog of the pentasaccharide unit of heparin that<strong> binds and activates antithrombin. </strong> Activation of antithrombin causes the&nbsp;<strong>inactivation of factor Xa. </strong>So it is also described as an<strong> indirect factor Xa inhibitor.</strong></p>\n<p style=\"text-align: justify;\">It is not a direct factor Xa inhibitor. Direct factor Xa inhibitors include rivaroxaban, apixaban, and edoxaban.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 65-year-old patient has been scheduled for cardiopulmonary bypass surgery. Which is the anticoagulant of choice for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Unfractionated heparin"
      },
      {
        "id": 2,
        "text": "LMWH"
      },
      {
        "id": 3,
        "text": "Fondaparinux"
      },
      {
        "id": 4,
        "text": "Warfarin"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Unfractionated heparin</strong> is the anticoagulant of choice for patients requiring <strong>cardiopulmonary bypass.</strong></p>\n<p>Cardiopulmonary bypass circuits <strong>activate factor XII</strong> which can lead to<strong>&nbsp;clotting</strong> in the oxygenator. This process is called <strong>catheter-induced thrombosis.</strong></p>\n<p>Unfractionated heparin is better than LMWH or fondaparinux for blocking it. Also, reversal of anticoagulation using protamine sulfate is easier for UFH compared to the other heparins.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Lab reports of a 45-year-old female patient, who was recently started on heparin, showed rapidly falling platelet counts. She was suspected to have heparin-induced thrombocytopenia. What is the most common presentation seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Bleeding"
      },
      {
        "id": 2,
        "text": "Venous thrombosis"
      },
      {
        "id": 3,
        "text": "Skin necrosis"
      },
      {
        "id": 4,
        "text": "Arterial thrombosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\">The most common presentation of heparin-induced thrombocytopenia is <strong>venous thrombosis</strong>.</p>\n<p>HIT is an immune complication of heparin therapy caused by <strong>IgG</strong>&nbsp;<strong>antibodies </strong>against the<strong> heparin-platelet factor 4 complex</strong>. This results in the activation of platelets to propagate a hypercoagulable state culminating in life-threatening thrombosis.&nbsp;</p>\n<p>It is characterized by&nbsp;<strong>thrombocytopenia</strong>&nbsp;(Platelet count &lt;1,00,000/&mu;L or reduced by over 50% from pre-treatment value) and clinically presents as&nbsp;<strong>v</strong><strong>enous thrombosis</strong>&nbsp;(in the form of&nbsp;<strong>DVT</strong>&nbsp;or&nbsp;<strong>pulmonary embolism</strong>)</p>\n<p>It occurs around&nbsp;<strong>5-10 days</strong>&nbsp;after starting heparin. It is more common with UFH when compared to LMWH. It is also more common in women surgical patients.&nbsp;Arterial thrombosis (resulting in MI or stroke), as well as bilateral adrenal hemorrhage, can rarely occur.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6f8147bb533c46348feec27df0631f5ex1280x1355.JPEG"
    ]
  },
  {
    "text": "A 64-year-old man was started on heparin postoperatively for thromboprophylaxis. After a week he developed sudden difficulty in breathing. His platelet count was found to be 70,000/microliter. Which of the following is incorrect regarding the management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Heparin should be discontinued immediately"
      },
      {
        "id": 2,
        "text": "Alternative anticoagulant such as argatroban should be administered"
      },
      {
        "id": 3,
        "text": "Low molecular weight heparins should be avoided"
      },
      {
        "id": 4,
        "text": "Heparin should be replaced with warfarin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\">The patient in the above scenario has <strong>heparin-induced thrombocytopenia (HIT)</strong>. Direct thrombin inhibitors,&nbsp;such as <strong>argatroban&nbsp;</strong>is the anticoagulant of choice in HIT.</p>\n<p>Management of HIT:</p>\n<ul style=\"text-align: justify;\">\n<li class=\"p1\"><strong>Stop</strong> heparin/LMWH</li>\n<li class=\"p1\">Give an alternative anticoagulant, such as lepirudin, <strong>argatroban</strong>, bivalirudin, <strong>fondaparinux</strong> or rivaroxaban</li>\n<li class=\"p1\">Do not give platelet transfusions (it only worsens the consumptive coagulopathy)</li>\n<li class=\"p1\"><strong>Do not give warfarin</strong> until the platelet count returns to its baseline level. If warfarin was administered, give vitamin K to restore the INR to normal.</li>\n</ul>\n<p style=\"text-align: justify;\">Increased thrombin generation associated with HIT can cause consumption of protein C. <strong>Warfarin</strong> administration can <strong>further decrease protein C levels</strong> and cause <strong>skin necrosis</strong>. Therefore warfarin is avoided in HIT.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient on anticoagulant therapy presented to the casualty with an uncontrolled bleeding episode and was given IV protamine sulfate. However, the patient did not respond to the treatment. Which of the following anticoagulant agents was most likely being used by the patient?",
    "choices": [
      {
        "id": 1,
        "text": "Unfractionated heparin"
      },
      {
        "id": 2,
        "text": "Enoxaparin"
      },
      {
        "id": 3,
        "text": "Dalteparin"
      },
      {
        "id": 4,
        "text": "Fondaparinux"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\">Since <strong>no effect</strong>&nbsp;was noted with <strong>protamine sulfate</strong>, the likely anticoagulant in use must be <strong>fondaparinux</strong>.<strong>&nbsp;</strong>This is because&nbsp;protamine sulfate <strong>fails to bind</strong> the drug.&nbsp;</p>\n<p style=\"text-align: justify;\">Protamine sulfate binds tightly to <strong>heparin</strong> and <strong>neutralizes</strong> its anticoagulant effect. It&nbsp;<strong>partially reverses</strong> the anticoagulant activity of <strong>LMWH</strong>&nbsp;also. But it has no effect on fondaparinux.</p>\n<p style=\"text-align: justify;\">There is <strong>no known specific antidote</strong> approved for use in fondaparinux overdose. Fondaparinux-associated bleeding complications are managed by treatment discontinuation and search for the primary cause. Surgical hemostasis, blood replacements, fresh plasma transfusion, plasmapheresis should be considered.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A clinical trial is done to compare the safety profile of a certain direct thrombin inhibitor (drug X) with that of heparin in patients undergoing coronary angioplasty. Identify drug X.",
    "choices": [
      {
        "id": 1,
        "text": "Enoxaparin"
      },
      {
        "id": 2,
        "text": "Bivalirudin"
      },
      {
        "id": 3,
        "text": "Fondaparinux"
      },
      {
        "id": 4,
        "text": "Dalteparin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\">Among the given options, the direct thrombin inhibitor is <strong>bivalirudin</strong>.<strong>&nbsp;</strong></p>\n<p style=\"text-align: justify;\">Bivalirudin is a <strong>parenteral</strong> direct thrombin inhibitor (DTI) frequently used for anticoagulation in invasive cardiology, particularly <strong>percutaneous coronary intervention</strong> (PCI). Unlike other DTIs, it undergoes predominant <strong>non-organ elimination</strong> (proteolysis) and has the <strong>shortest half-life</strong> (approximately 25 min).</p>\n<p style=\"text-align: justify;\">It can be used in patients with, or at risk for,&nbsp;<strong>heparin-induced thrombocytopenia</strong>.</p>\n<p style=\"text-align: justify;\">Other options:</p>\n<p style=\"text-align: justify;\">Options A and D: Enoxaparin and dalteparin are low-molecular-weight-heparin (LMWH) preparations.&nbsp;</p>\n<p style=\"text-align: justify;\">Option C: Fondaparinux is a synthetic analog of the pentasaccharide unit of heparin.&nbsp;</p>\n<p style=\"text-align: justify;\">Heparins and their analogs produce anticoagulant effects indirectly by activating antithrombin-III.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The oral thrombin inhibitor which can be used for prevention of stroke in patients with non-valvular atrial fibrillation is?",
    "choices": [
      {
        "id": 1,
        "text": "Dabigatran"
      },
      {
        "id": 2,
        "text": "Ximelgatran"
      },
      {
        "id": 3,
        "text": "Lepirudin"
      },
      {
        "id": 4,
        "text": "Saxagliptin"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>oral thrombin inhibitor</strong> which can be used for the <strong>prevention of stroke</strong> in patients with <strong>non-valvular atrial fibrillation</strong> is <strong>dabigatran</strong>. However, it is contraindicated in patients with mechanical heart valves.</p>\n<p>Option B: Ximelagatran is also an oral thrombin inhibitor, but it has been discontinued due to the risk of hepatotoxicity.</p>\n<p>Option C: Lepirudin is a parenteral direct thrombin inhibitor used mainly in heparin-induced thrombocytopenia.</p>\n<p>Option D: Saxagliptin is a DPP-4 inhibitor used in the management of type 2 diabetes mellitus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is a parenteral direct thrombin inhibitor?",
    "choices": [
      {
        "id": 1,
        "text": "Apixaban"
      },
      {
        "id": 2,
        "text": "Argatroban"
      },
      {
        "id": 3,
        "text": "Dabigatran"
      },
      {
        "id": 4,
        "text": "Enoxaparin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The parenteral direct thrombin inhibitor is <strong>argatroban</strong>.</p>\n<p>Argatroban binds reversibly to thrombin and inhibits it. It is metabolized in the liver and excreted in bile, so it can be <strong>safely </strong>used in patients with <strong>renal impairment</strong>.</p>\n<p>It can be used for prophylaxis and treatment of <strong>heparin-induced thrombocytopenia (HIT)</strong>.</p>\n<p>Other parenteral direct thrombin inhibitors are their indications:&nbsp;</p>\n<ul>\n<li>Lepirudin - was indicated in HIT but is discontinued now</li>\n<li>Desirudin - indicated for thromboprophylaxis in hip replacement surgery</li>\n<li>Bivalirudin - used in procedures like coronary angioplasty or cardiopulmonary bypass surgery and HIT.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an oral factor Xa inhibitor?",
    "choices": [
      {
        "id": 1,
        "text": "Bivalirudin"
      },
      {
        "id": 2,
        "text": "Dabigatran"
      },
      {
        "id": 3,
        "text": "Rivaroxaban"
      },
      {
        "id": 4,
        "text": "Enoxaparin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Rivaroxaban </strong>is an<strong>&nbsp;oral direct factor Xa inhibitor.</strong>&nbsp;They represent a new class of oral anticoagulant drugs that <strong>do not require monitoring</strong>.</p>\n<p>This group of drugs inhibit factor Xa in the final common pathway of clotting [conversion of Prothrombin (Factor II) to thrombin (Factor IIa)]. They are given as fixed doses and have a rapid onset of action.</p>\n<p>Oral direct factor Xa inhibitors are <strong>indicated</strong> in:</p>\n<ul>\n<li>Prevention of embolic stroke in patients with atrial fibrillation (without valvular heart disease)</li>\n<li>Venous thromboembolic disease (VTE)</li>\n<li>Postoperative thromboprophylaxis in patients undergoing hip and knee arthroplasty</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient on apixaban for nonvalvular atrial fibrillation requires urgent aortic surgery for a pseudoaneurysm. Identify the decoy factor Xa used for reversal of apixaban action before the surgery.",
    "choices": [
      {
        "id": 1,
        "text": "Dornase alfa"
      },
      {
        "id": 2,
        "text": "Andexanet alfa"
      },
      {
        "id": 3,
        "text": "Idarucizumab"
      },
      {
        "id": 4,
        "text": "Protamine sulfate"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Andexanet alfa </strong>is the <strong>decoy factor Xa</strong> approved for reversal of oral Xa inhibitors. It was approved in May 2018.</p>\n<p>Option A: Dornase alfa is a recombinant human DNase 1 that is used in cystic fibrosis to reduce the viscosity of mucosal secretions.</p>\n<p>Option C: Idarucizumab is a chimeric monoclonal antibody against dabigatran. It has a higher affinity towards dabigatran than thrombin and is approved as a reversal agent for dabigatran.</p>\n<p>Option D: Protamine sulfate is an antidote for heparin overdose.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with a history of regular oral anticoagulant therapy suffers a traumatic injury. He receives idarucizumab before damage control surgery to reverse the anticoagulant effect. Identify the oral anticoagulant that was being used by the patient.",
    "choices": [
      {
        "id": 1,
        "text": "Heparin"
      },
      {
        "id": 2,
        "text": "Warfarin"
      },
      {
        "id": 3,
        "text": "Dabigatran"
      },
      {
        "id": 4,
        "text": "Rivaroxaban"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">Idarucizumab is a reversal agent for&nbsp;<strong>dabigatran</strong>. It is a humanized mouse <strong>monoclonal antibody</strong> fragment.</p>\n<p class=\"p1\">It binds <strong>irreversibly</strong> to&nbsp;dabigatran and forms a complex that is <strong>cleared by the kidneys</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs is under clinical trials and shows a reversal in the action of all direct anticoagulants?",
    "choices": [
      {
        "id": 1,
        "text": "Protamine"
      },
      {
        "id": 2,
        "text": "Idarucizumab"
      },
      {
        "id": 3,
        "text": "Andexanet alfa"
      },
      {
        "id": 4,
        "text": "Ciraparantag"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Ciraparantag</strong> is a synthetic cationic molecule that binds to all direct anticoagulants (dabigatran and other oral factor Xa inhibitors) as well as heparin and LMWH and reverses their actions. It is still <strong>under trial</strong>.&nbsp;</p>\n<p>Option A: Protamine sulfate reverses the action of heparin and LMWH.</p>\n<p>Option B: Idarucizumab is a specific antidote for dabigatran overdose.&nbsp;</p>\n<p>Option C: Andexanet alfa is a decoy for oral factor Xa inhibitors.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Coagulation profile monitoring is needed in therapy with which of the following drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Fondaparinux"
      },
      {
        "id": 2,
        "text": "Enoxaparin"
      },
      {
        "id": 3,
        "text": "Dabigatran"
      },
      {
        "id": 4,
        "text": "Lepirudin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Coagulation profile <strong>monitoring</strong> is needed for <strong>lepirudin</strong>.</p>\n<p>Lepirudin is a <strong>direct irreversible thrombin inhibitor</strong> and its most adverse reaction is bleeding. The risk of bleeding can be reduced by implementing an appropriate monitoring and dose adjustment strategy. Thus, coagulation profile monitoring is required for lepirudin.</p>\n<p>However, <strong>enoxaparin, fondaparinux, and dabigatran</strong> do not bind to endothelium or many plasma proteins and thus, the response to these drugs at the usual doses is consistent from patient to patient. Hence, monitoring is not required.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following anticoagulants can be safely used in a pregnant patient?",
    "choices": [
      {
        "id": 1,
        "text": "Heparin"
      },
      {
        "id": 2,
        "text": "Warfarin"
      },
      {
        "id": 3,
        "text": "Dicumarol"
      },
      {
        "id": 4,
        "text": "Phenindione"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\"><strong>Heparin</strong> is the anticoagulant that can be safely used in pregnancy.&nbsp;</p>\n<p class=\"p1\" style=\"text-align: justify;\"><strong>Heparin, LMWH, and fondaparinux</strong> do not cross the blood-brain barrier or placenta and hence they are the anticoagulants preferred in pregnancy.</p>\n<p style=\"text-align: justify;\">Warfarin and other vitamin K antagonists are contraindicated during pregnancy due to the risk of teratogenicity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient is on DVT prophylaxis with warfarin. It has an inhibitory action on which of the following enzymes?",
    "choices": [
      {
        "id": 1,
        "text": "Gamma glutamyl carboxylase"
      },
      {
        "id": 2,
        "text": "Vitamin K epoxide reductase"
      },
      {
        "id": 3,
        "text": "Thrombin"
      },
      {
        "id": 4,
        "text": "HMG-CoA reductase"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Warfarin</strong> directly inhibits the enzyme <strong>Vitamin K epoxide reductase</strong>.</p>\n<p>It inhibits the conversion of vitamin K epoxide to its reduced form - vitamin K hydroquinone which&nbsp;is a <strong>co-factor</strong> for the enzyme <strong>gamma-glutamyl carboxylase</strong>. This enzyme catalyzes the &gamma;-carboxylation process&nbsp;of vitamin K dependent clotting factors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/17a7c94a393c40bc84db00bbcafd63f4x1280x1234.JPEG"
    ]
  },
  {
    "text": "Which of the following is vitamin K dependent clotting factor?",
    "choices": [
      {
        "id": 1,
        "text": "Factor I"
      },
      {
        "id": 2,
        "text": "Factor VII"
      },
      {
        "id": 3,
        "text": "Factor XI"
      },
      {
        "id": 4,
        "text": "Factor XII"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Factor VII is a vitamin K dependant clotting factor.</p>\n<p>The vitamin K dependent factors:&nbsp;</p>\n<ul>\n<li>Clotting factors: Factors II, VII, IX, X</li>\n<li>Anticoagulant factors: Protein C and Protein S</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient suffering from non-valvular atrial fibrillation is prescribed warfarin tablets. Which of the following clotting factors would you expect to decline the earliest in this patient after drug administration?",
    "choices": [
      {
        "id": 1,
        "text": "Factor II"
      },
      {
        "id": 2,
        "text": "Factor VII"
      },
      {
        "id": 3,
        "text": "Factor IX"
      },
      {
        "id": 4,
        "text": "Factor X"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\"><strong>Factor VII</strong> activity <strong>declines most rapidly</strong> when warfarin is administered. It has the <strong>shortest plasma half-life</strong> among the vitamin K dependent clotting factors.</p>\n<table style=\"width: 331px;\">\n<tbody>\n<tr style=\"height: 17px;\">\n<td style=\"height: 17px; width: 129px;\">\n<p><strong>Clotting factors</strong></p>\n</td>\n<td style=\"height: 17px; width: 190px;\">\n<p><strong>Plasma half-life (hours)</strong></p>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"height: 46px; width: 129px;\">\n<p>II</p>\n</td>\n<td style=\"height: 46px; width: 190px;\">\n<p>50</p>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"height: 46px; width: 129px;\">\n<p>VII</p>\n</td>\n<td style=\"height: 46px; width: 190px;\">\n<p>6</p>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"height: 46px; width: 129px;\">\n<p>IX</p>\n</td>\n<td style=\"height: 46px; width: 190px;\">\n<p>24</p>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"height: 46px; width: 129px;\">\n<p>X</p>\n</td>\n<td style=\"height: 46px; width: 190px;\">\n<p>30</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p style=\"text-align: justify;\">Clinical importance: Because of the long half-life of the other clotting factors, especially factor II, the <strong>full anticoagulant effect</strong> of warfarin is <strong>not seen for several days</strong>. Initially, parenteral anticoagulants are used along with warfarin until the full effect of warfarin is achieved.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient receiving warfarin tablets, which enzyme primarily metabolizes the drug?",
    "choices": [
      {
        "id": 1,
        "text": "CYP2C19"
      },
      {
        "id": 2,
        "text": "CYP2C9"
      },
      {
        "id": 3,
        "text": "CYP3A4"
      },
      {
        "id": 4,
        "text": "CYP1A2"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Warfarin</strong>&nbsp;is primarily metabolized by <strong>CYP2C9</strong>.</p>\n<p>Genetic polymorphisms of CYP2C9 and drugs inhibiting or inducing CYP2C9 can result in variable response to warfarin administration.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs does not increase the risk of bleeding in patients undergoing warfarin therapy?",
    "choices": [
      {
        "id": 1,
        "text": "Cimetidine"
      },
      {
        "id": 2,
        "text": "Carbamazepine"
      },
      {
        "id": 3,
        "text": "Isoniazid"
      },
      {
        "id": 4,
        "text": "Amiodarone"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Carbamazepine does not increase the risk of bleeding in patients undergoing warfarin therapy.</p>\n<p><strong>Warfarin</strong>&nbsp;is mainly&nbsp;<strong>metabolized&nbsp;</strong>by the<strong>&nbsp;CYP2C9</strong>&nbsp;enzyme. Drugs that inhibit CYP2C9 enzyme reduce the metabolism of warfarin and thus, enhance the anticoagulant effect of warfarin and increase the risk of bleeding.</p>\n<p>Drugs causing CYP2C9 inhibition:</p>\n<ul>\n<li>Amiodarone</li>\n<li>Azole antifungals</li>\n<li>Cimetidine</li>\n<li>Clopidogrel</li>\n<li>Cotrimoxazole</li>\n<li>Disulfiram</li>\n<li>Isoniazid</li>\n<li>Metronidazole</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While prescribing warfarin, a decreased effect of the drug is expected in patients with which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Nephrotic syndrome"
      },
      {
        "id": 2,
        "text": "Hepatic impairment"
      },
      {
        "id": 3,
        "text": "Gastroenteritis on treatment with metronidazole"
      },
      {
        "id": 4,
        "text": "Congestive heart failure"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\">Decreased effect of warfarin is seen in patients with <strong>nephrotic syndrome</strong>.</p>\n<p style=\"text-align: justify;\">Warfarin is <strong>highly bound to plasma protein</strong> and in nephrotic syndrome there is proteinuria. Drugs that are bound to plasma proteins are lost in the urine. Similarly, <strong>warfarin is lost in urine</strong> in nephrotic syndrome, resulting in a decreased effect.</p>\n<p style=\"text-align: justify;\">Option C: Warfarin&nbsp;is mainly&nbsp;<strong>metabolized&nbsp;</strong>by the<strong>&nbsp;CYP2C9</strong>&nbsp;enzyme. In patients being treated with metronidazole (a CYP2C9 inhibitor), the metabolism of warfarin is decreased. Hence, the effect of warfarin is increased.</p>\n<p style=\"text-align: justify;\">Options B and D: Hepatic impairment, congestive heart failure, and hyperthyroidism lead to <strong>low concentrations of clotting factors</strong> and thus the effect of warfarin is enhanced in these conditions.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with splanchnic vein thrombosis has been started on warfarin therapy. Which of the following can be used to monitor the treatment in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Prothrombin time"
      },
      {
        "id": 2,
        "text": "Activated partial thromboplastin time"
      },
      {
        "id": 3,
        "text": "Bleeding time"
      },
      {
        "id": 4,
        "text": "Clotting time"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\"><strong>Warfarin therapy </strong>is usually <strong>monitored</strong> by measuring <strong>prothrombin time.</strong></p>\n<p style=\"text-align: justify;\">Prothrombin time is sensitive to the reduction in levels of <strong>prothrombin, factor VII, and factor X</strong>. The test is performed by adding thromboplastin, which is a reagent containing tissue factor, phospholipid and calcium to citrated plasma and determining the time to clot formation.</p>\n<p style=\"text-align: justify;\">Due to the variable sensitivity of thromboplastin, the <strong>International normalized ratio (INR)</strong> was developed to standardize the reporting of prothrombin time. In INR, the patient&rsquo;s prothrombin time is divided by mean normal prothrombin time and this ratio is multiplied by the International Sensitivity Index (ISI) of the particular thromboplastin reagent.</p>\n<p class=\"p1\" style=\"text-align: justify;\">Warfarin therapy should be monitored with INR <strong>every 3&ndash;4 weeks</strong>. The <strong>target INR is 2.0&ndash;3.0</strong>. In patients with <strong>mechanical heart valves</strong>, the target INR is <strong>2.5&ndash;3.5</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old patient admitted with atrial fibrillation was started on bisoprolol and warfarin. After 4 days of admission, she started experiencing painful ecchymoses on her right lower limb. It progressed to the condition shown in the image over the next few days. Deficiency in which of the following can lead to this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Protein C"
      },
      {
        "id": 2,
        "text": "Protein S"
      },
      {
        "id": 3,
        "text": "Either a or b"
      },
      {
        "id": 4,
        "text": "Thrombin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The clinical features and the image given are suggestive of <strong>warfarin-induced skin necrosis</strong> seen due to a congenital or acquired deficiency in either<strong> protein C or protein S.</strong></p>\n<p>Warfarin therapy in such patients leads to a rapid fall in&nbsp;protein C or protein S, which are <strong>vitamin K dependent anticoagulants</strong>. This occurs before warfarin can exert an antithrombotic effect.</p>\n<p class=\"p1\">Treatment: Warfarin should be discontinued and vitamin K (the antidote for warfarin) should be administered.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/09f2a88d8c1f4e55ade74cc116e7b99d.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 27-year-old male patient on anticoagulant therapy for his DVT started coughing up blood. He has a history of irregular warfarin intake. Workup revealed elevated INR and diffuse alveolar hemorrhage. Which of the following agents would be the best choice for immediate reversal of bleeding?",
    "choices": [
      {
        "id": 1,
        "text": "Cryoprecipitate"
      },
      {
        "id": 2,
        "text": "Fresh frozen plasma"
      },
      {
        "id": 3,
        "text": "Prothrombin complex concentrates"
      },
      {
        "id": 4,
        "text": "Vitamin K1"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Immediate or urgent reversal of <strong>warfarin-induced bleeding</strong> is best achieved by the administration of <strong>prothrombin complex concentrates</strong> (PCC).</p>\n<p>These are highly purified concentrates prepared from pooled plasma and contain&nbsp;<strong>factors II, IX, and X</strong>. Factor VII may be included or produced separately.</p>\n<p>Option D<strong>: Vitamin K1</strong>&nbsp;is the specific antidote for warfarin-induced bleeding, but it <strong>takes 6-24 hours</strong> for the clotting factors to be resynthesized and released in blood after Vitamin K administration and hence its action is delayed for several hours.&nbsp;&nbsp;</p>\n<p>Option A: Cryoprecipitate mainly contains factor VIII and fibrinogen and therefore is not suitable for warfarin-induced bleeding, as warfarin inhibits factors II,&nbsp;VII,&nbsp;IX, X.</p>\n<p>Option B: Fresh frozen plasma can also be used but prothrombin complex concentrate normalizes the INR more rapidly.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is not a fetal abnormality expected after warfarin administration to a pregnant patient?",
    "choices": [
      {
        "id": 1,
        "text": "Nasal hypoplasia"
      },
      {
        "id": 2,
        "text": "Fetal haemorrhage"
      },
      {
        "id": 3,
        "text": "Stippled epiphyses"
      },
      {
        "id": 4,
        "text": "Macrocephaly"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\">Macrocephaly is not a fetal abnormality caused&nbsp;by warfarin administered during pregnancy.</p>\n<p class=\"p1\" style=\"text-align: justify;\"><strong>Warfarin crosses the placenta</strong> and can cause fetal abnormalities which include <strong>nasal hypoplasia</strong> and <strong>stippled epiphyses</strong> leading to abnormal bone formation. <strong>Fetal or neonatal hemorrhage</strong> is also seen.</p>\n<p class=\"p1\" style=\"text-align: justify;\">The risk of embryopathy is <strong>highest</strong> with exposure in the <strong>first trimester</strong> of pregnancy. <strong>CNS abnormalities</strong> have also been reported following exposure during the <strong>second and third trimesters</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In patients with indications for warfarin usage, what is the recommended range of INR necessary for safe administration of the drug?",
    "choices": [
      {
        "id": 1,
        "text": "1.0 \u2013 1.5"
      },
      {
        "id": 2,
        "text": "2.0 \u2013 3.0"
      },
      {
        "id": 3,
        "text": "2.5 \u2013 3.5"
      },
      {
        "id": 4,
        "text": "3.5 \u2013 4.5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>INR</strong> ratio <strong>recommended</strong> for the administration of warfarin in <strong>most of the indications</strong> is in the range of <strong>2.0-3.0</strong>.</p>\n<p>Option A: The range of 1.0-1.5 is too low for beneficial effects.<br /><br />Option C: In selected patients with <strong>mechanical heart valves</strong>, the INR target is around <strong>2.5-3.5</strong>.</p>\n<p>Option D: INR &gt;3.5 can result in increased adverse effects and is not recommended for any condition.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Apixaban belongs to which of the following class of drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Antifibrinolytic"
      },
      {
        "id": 2,
        "text": "Factor Xa inhibitor"
      },
      {
        "id": 3,
        "text": "Oral direct thrombin inhibitor"
      },
      {
        "id": 4,
        "text": "Parenteral direct thrombin inhibitor"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The FDA recently approved the drug\u00a0Apixaban for a new indication. The drug is now used to reduce the risk of stroke and systemic embolism in patients with nonvalvular atrial fibrillation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '60 Anticoagulants';
        const quizFilename = '60-anticoagulants-9b94cc9b.html';
        let hierarchy = ["Marrow", "qBank", "Pharmacology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>