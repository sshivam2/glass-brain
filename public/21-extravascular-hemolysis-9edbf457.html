<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21 Extravascular Hemolysis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pathology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">28</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "The peripheral smear of a patient with chronic fatigue is shown below. This marked finding is seen in all of the conditions except",
    "choices": [
      {
        "id": 1,
        "text": "Sickle cell anemia"
      },
      {
        "id": 2,
        "text": "Hereditary spherocytosis"
      },
      {
        "id": 3,
        "text": "Paroxysmal nocturnal hemoglobinuria"
      },
      {
        "id": 4,
        "text": "Thalassemia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given peripheral smear shows<strong> Howell&ndash;Jolly bodies</strong>. They are not seen in paroxysmal nocturnal hemoglobinuria.</p>\n<p>They<strong>&nbsp;</strong>are&nbsp;small nuclear remnants seen as&nbsp;inclusions in red cells and are <strong>characteristic</strong> of<strong> asplenia</strong>.&nbsp;They are seen in the following conditions:</p>\n<ul>\n<li>Sickle cell&nbsp;anaemia - due to auto splenectomy</li>\n<li>Hereditary spherocytosis</li>\n<li>Thalassemia post-splenectomy</li>\n</ul>\n<p>The images given below show Howell&ndash;Jolly bodies in peripheral&nbsp;blood smear.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0bafaa69180342859842b864f136763e.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4d01f70eb8ec4a6cbd79347cf771d171x799x596.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/432a8af8c8dd4cc4bce045fffbfcc772x610x600.JPEG"
    ]
  },
  {
    "text": "Match the types of thalassemia with their most common mutations.",
    "choices": [
      {
        "id": 1,
        "text": "1-C, 2-A, 3-B"
      },
      {
        "id": 2,
        "text": "1-C, 2-B, 3-A"
      },
      {
        "id": 3,
        "text": "1-A, 2-B, 3-C"
      },
      {
        "id": 4,
        "text": "1-B, 2-A, 3-C"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common types of mutations causing thalassemia are:</p>\n<table style=\"height: 118px; width: 344px;\">\n<tbody>\n<tr style=\"height: 33.625px;\">\n<td style=\"width: 148px; height: 33.625px;\">Thalassemia</td>\n<td style=\"width: 180px; height: 33.625px;\">Most common mutation</td>\n</tr>\n<tr style=\"height: 21px;\">\n<td style=\"width: 148px; height: 21px;\">&beta;+ thalassemia</td>\n<td style=\"width: 180px; height: 21px;\">Splicing mutation</td>\n</tr>\n<tr style=\"height: 25px;\">\n<td style=\"width: 148px; height: 25px;\">&beta;<sup>0</sup>&nbsp;thalassemia</td>\n<td style=\"width: 180px; height: 25px;\">Terminator mutation</td>\n</tr>\n<tr style=\"height: 21px;\">\n<td style=\"width: 148px; height: 21px;\">&alpha; thalassemia</td>\n<td style=\"width: 180px; height: 21px;\">Gene deletion</td>\n</tr>\n</tbody>\n</table>\n<p>The different splicing mutations are:</p>\n<ul>\n<li>Mutations that destroy the normal RNA splice junctions - completely prevent the production of normal &beta;-globin mRNA resulting in <strong>&beta;<sup>0</sup></strong>-thalassemia</li>\n<li>Mutations that create an ectopic splice site within an intron with normal splice regions - some normal &beta;-globin mRNA is made resulting in <strong>&beta;<sup>+</sup></strong> thalassemia</li>\n</ul>\n<p>There are two subtypes of chain terminator mutations:</p>\n<ul>\n<li>New stop codon within an exon</li>\n<li>Small insertions or deletions that shift the mRNA reading frames</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which chromosome is affected in alpha-thalassemia?",
    "choices": [
      {
        "id": 1,
        "text": "16"
      },
      {
        "id": 2,
        "text": "11"
      },
      {
        "id": 3,
        "text": "6"
      },
      {
        "id": 4,
        "text": "12"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Chromosome 16</strong>&nbsp;contains an identical pair of &alpha;-globin genes which is affected in <strong>alpha-thalassemia</strong>. This condition is due to <strong>decreased synthesis</strong> of <strong>alpha chains</strong>.&nbsp;</p>\n<p>The two <strong>&beta; chains</strong> are encoded by a single &beta;-globin gene on <strong>chromosome</strong> <strong>11</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding \u03b1-thalassemia?",
    "choices": [
      {
        "id": 1,
        "text": "Free \u03b2 and \u03b3 chains are more soluble than free \u03b1 chains"
      },
      {
        "id": 2,
        "text": "\u03b2 tetramer is known as HbH"
      },
      {
        "id": 3,
        "text": "\u03b1 chains are coded by a pair of genes"
      },
      {
        "id": 4,
        "text": "Hb Barts is the most severe form"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>&alpha; chains</strong> are coded by 4 genes i.e.&nbsp;<strong>two pairs </strong>of <strong>genes</strong> located on<strong> chromosome 16.</strong></p>\n<p>Free<strong> &beta;</strong> and <strong>&gamma;</strong> chains are <strong>more soluble</strong> than free &alpha; chains. They also form more stable homotetramers. Hence, hemolysis and dyserythropoiesis in&nbsp;&alpha; thalassemia are less severe when compared to&nbsp;&beta; thalassemia.</p>\n<p>In&nbsp;<strong>HbH disease</strong>,&nbsp;excess&nbsp;&beta;-globin&nbsp;chains form <strong>&beta;4 tetramers.</strong> They are seen in&nbsp;older children with&nbsp;&alpha;-thalassemia.</p>\n<p><strong>Hydrops fetalis</strong>&nbsp;is the <strong>most severe</strong> form of &alpha;-thalassemia. It is caused by the deletion of all four &alpha;-globin genes. This leads to excess &gamma;-globin chains forming&nbsp;&gamma;-globin&nbsp;tetramers (<strong>hemoglobin Barts</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman with an obstetric score of G3P2A0L0, in a consanguinous marriage, delivered a hydropic stillborn at 32 weeks of gestation.  Further evaluation revealed the presence of Hb Barts in the fetal blood. Which of the following globin chains tetramer is found in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "\u03b14"
      },
      {
        "id": 2,
        "text": "\u03b24"
      },
      {
        "id": 3,
        "text": "\u03b34"
      },
      {
        "id": 4,
        "text": "\u03b44"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In <strong>HbH disease</strong>,&nbsp;excess<strong> &beta;-globin</strong> chains form &beta;4 tetramers. They are seen in&nbsp;older children with&nbsp;&alpha;-thalassemia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ef2a764ed38c45ab87df568361f3cecdx555x505.JPEG"
    ]
  },
  {
    "text": "A 26-year-old Chinese translator presents with fever, jaundice and splenomegaly. His Hb is 6 g% and peripheral smear with brilliant cresyl blue is given below. Which of the following globin chains would you expect to see in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "\u03b14"
      },
      {
        "id": 2,
        "text": "\u03b24"
      },
      {
        "id": 3,
        "text": "\u03b34"
      },
      {
        "id": 4,
        "text": "\u03b44"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario of <strong>extravascular hemolysis</strong>&nbsp;(jaundice and splenomegaly) and peripheral smear showing <strong>golf ball</strong> <strong>cells</strong> is suggestive of <strong>HBH disease</strong>. It is a type of <strong>&alpha; thalassemia</strong> where the HbH is composed of <strong>tetramers </strong>of<strong>&nbsp;&beta; chains </strong>(&beta;4).</p>\n<p>Hb-H disease is one type of alpha-thalassaemia with <strong>inactivation</strong> of <strong>3</strong> of the 4 <strong>alleles</strong>. It is more common in the <strong>Asian</strong> population. It usually manifests in the 1st year of life. It causes acute episodes of hemolysis when <strong>triggered</strong> by <strong>infections</strong> or oxidant <strong>drugs</strong>.</p>\n<p>The <strong>decreased &alpha; chain</strong> production leads to a relative <strong>excess</strong> of<strong> &beta; chains.</strong> This leads to the formation of <strong>HbH </strong>which has a <strong>high affinity</strong> for <strong>oxygen</strong>. Such RBCs are more prone to <strong>oxidation</strong> which causes <strong>precipitation</strong> of <strong>HbH</strong> to form <strong>golf ball inclusion</strong> bodies. This leads to increased sequestration and phagocytosis in the spleen.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a0658cc1c6e448708608017dca5d1407.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient has a HbA2 of 3% and HbF of 97%. A peripheral blood smear is taken. Which of the following blood pictures will be seen in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2 and 3"
      },
      {
        "id": 2,
        "text": "1 and 2"
      },
      {
        "id": 3,
        "text": "2 and 3"
      },
      {
        "id": 4,
        "text": "1 and 3"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The presence of <strong>HbA2 3% </strong>and<strong> HbF 97% </strong>indicates that it is a case of <strong>thalassemia major</strong>. In thalassemia major, hematological findings in image 1 showing <strong>poikilocytes</strong> and image 3 showing<strong> target cells</strong> are seen. Image 2 showing Howell Jolly bodies are seen in <strong>post-splenectomy</strong> thalassemia patients and not in this case.</p>\n<p><strong>Hematological findings</strong> in <strong>thalassemia major</strong> include the following:</p>\n<ul>\n<li>Anisopoikilocytosis</li>\n<li>Target cells (codocytes)</li>\n<li>Nucleated RBC\u2019s</li>\n<li>Dacrocytes</li>\n<li>Basophilic stippling</li>\n<li>Polychromatophilic cells</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/09914ebca8144a6386f65ddd0243551a.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/418a6034a31647d8829d5b06f1c67d05x1280x1157.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9e9ac978c6984f2bb20c51348e10e8bdx1280x1280.JPEG",
      "https://cdn1.dailyrounds.org/uploads/465c8ab170be4eed833399e831eaeaf8x345x235.PNG"
    ]
  },
  {
    "text": "Given below is the hemogram of a patient. Calculate the Mentzer index.",
    "choices": [
      {
        "id": 1,
        "text": "10"
      },
      {
        "id": 2,
        "text": "12"
      },
      {
        "id": 3,
        "text": "30"
      },
      {
        "id": 4,
        "text": "6"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">From the given hemogram, the <strong>Mentzer</strong></span></span><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\"><strong>&nbsp;index</strong>&nbsp;</span></span><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">is <strong>10</strong>. </span></span></p>\n<p><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">The formula for Mentzer index is <strong>MCV (fL) / TRBC (millions/mm<sup>3</sup>)</strong>&nbsp;i.e. 60/6 = 10</span></span></p>\n<p><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">This index is used to <strong>differentiate</strong> between <strong>i</strong></span></span><strong><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">ron-deficiency&nbsp;</span></span><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"SpellingError SCXW148009661\">anemia</span></span></strong><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">&nbsp;and <strong>beta-thalassemia trait</strong>. If the index is&nbsp;</span></span><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\"><strong>&lt;13</strong>, it is most likely to be a <strong>thalassemia</strong> trait.</span></span><span class=\"EOP SCXW148009661\" data-ccp-props=\"{&quot;201341983&quot;:0,&quot;335559739&quot;:160,&quot;335559740&quot;:259}\">&nbsp;</span></p>\n<p><span class=\"EOP SCXW148009661\" data-ccp-props=\"{&quot;201341983&quot;:0,&quot;335559739&quot;:160,&quot;335559740&quot;:259}\">Differences between iron deficiency anemia and beta-thalassemia minor (<span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">beta-thalassemia trait)</span></span> are given below.</span></p>\n<table style=\"width: 371px; height: 372px;\" border=\"0\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\"><strong>Feature&nbsp; &nbsp;</strong></td>\n<td style=\"width: 141.797px; height: 18px;\"><strong><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW148009661\">Iron-deficiency&nbsp;</span></span><span class=\"TextRun SCXW148009661\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"SpellingError SCXW148009661\">anemia</span></span></strong></td>\n<td style=\"width: 169.094px; height: 18px;\"><span class=\"EOP SCXW148009661\" data-ccp-props=\"{&quot;201341983&quot;:0,&quot;335559739&quot;:160,&quot;335559740&quot;:259}\"><strong>Beta-thalassemia minor</strong></span></td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 104px; height: 36px;\">Peripheral blood smear&nbsp;</td>\n<td style=\"width: 141.797px; height: 36px;\">Microcytic hypochromic&nbsp;</td>\n<td style=\"width: 169.094px; height: 36px;\">Microcytic&nbsp;hypochromic&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">Retic&nbsp;count&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">Low&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">Low&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">RDW&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">Wide&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">Narrow&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">TRBC&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">Low&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">High&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">Mentzer&nbsp;index&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">&gt;14&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">&lt;12&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">Serum ferritin&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">Low&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">Normal</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">Serum iron&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">Low&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">Normal&nbsp;</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 104px; height: 18px;\">TIBC&nbsp;</td>\n<td style=\"width: 141.797px; height: 18px;\">High&nbsp;</td>\n<td style=\"width: 169.094px; height: 18px;\">Normal</td>\n</tr>\n<tr style=\"height: 31px;\">\n<td style=\"width: 104px; height: 31px;\">HbA2&nbsp;</td>\n<td style=\"width: 141.797px; height: 31px;\">\n<p>2-3%</p>\n<p>(normal)</p>\n</td>\n<td style=\"width: 169.094px; height: 31px;\">&gt;3.5%&nbsp;</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The following test was performed with blood sample from a patient with anaemia. What is this test used for?",
    "choices": [
      {
        "id": 1,
        "text": "Detection of sickle cell trait"
      },
      {
        "id": 2,
        "text": "Screening of thalassemia"
      },
      {
        "id": 3,
        "text": "Confirmatory test for hereditary spherocytosis"
      },
      {
        "id": 4,
        "text": "Bedside diagnostic test for PNH"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows&nbsp;<strong>NESTROFT</strong> i.e. Naked Eye Single Tube Red cell Osmotic Fragility test.&nbsp;It is a very useful <strong>screening</strong> tool for <strong>thalassemia</strong>,&nbsp;particularly in poor&nbsp;resource settings.</p>\n<p>The principle is based on the <strong>decreased</strong> osmotic fragility of red cells in thalassemia. It is performed as follows:</p>\n<ol>\n<li>Mix EDTA blood and&nbsp;<strong>0.36% buffered saline </strong>solution.</li>\n<li>Shake the tube and leave it at room temperature for 30 minutes.</li>\n<li>Shake the tube again and immediately hold the tube in front of a piece of paper with text or lines.</li>\n</ol>\n<table style=\"height: 237px;\" width=\"268\">\n<tbody>\n<tr>\n<td style=\"width: 82.421875px;\"><strong>NESTROFT</strong></td>\n<td style=\"width: 86.953125px;\"><strong>Inference</strong></td>\n<td style=\"width: 76.625px;\"><strong>Reason</strong></td>\n</tr>\n<tr>\n<td style=\"width: 82.421875px;\">Lines visible (negative)</td>\n<td style=\"width: 86.953125px;\">Normal</td>\n<td style=\"width: 76.625px;\">Hemolysis has occurred</td>\n</tr>\n<tr>\n<td style=\"width: 82.421875px;\">Lines not seen (positive)</td>\n<td style=\"width: 86.953125px;\">Thalassemia</td>\n<td style=\"width: 76.625px;\">Stable RBC, unable to lyse</td>\n</tr>\n</tbody>\n</table>\n<p>The image given below shows the NESTROFT.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/bdb5f53824364b4586f51ac3655169d1.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6765ac0ca08c4311ae71aec4ddbce08ax360x604.PNG"
    ]
  },
  {
    "text": "A couple with a family history of thalassemia comes for genetic counselling. Their HPLC reports are given below. What is the risk of their offspring having thalassemia major?",
    "choices": [
      {
        "id": 1,
        "text": "0"
      },
      {
        "id": 2,
        "text": "25"
      },
      {
        "id": 3,
        "text": "50"
      },
      {
        "id": 4,
        "text": "75"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the given clinical scenario, the <strong>risk</strong> of their offspring having <strong>thalassemia</strong> major is <strong>0%.&nbsp;</strong></p>\n<p>From the given HPLC reports, the&nbsp;<strong>husband</strong> is <strong>normal</strong> (normal value of HbA2 is 2.5%&plusmn;0.3%) and the <strong>wife</strong> has&nbsp;<strong>&beta;&nbsp;</strong><strong>thalassemia minor</strong> (HbA2 level 4.9%). This disease is transmitted with an <strong>autosomal recessive</strong> inheritance. Hence, the&nbsp;chance of their offspring having&nbsp;full blown thalassemia is zero.&nbsp;</p>\n<p>In&nbsp;<strong>&beta;&nbsp;</strong><strong>thalassemia</strong> <strong>minor</strong>, the&nbsp;Hb&nbsp;A2 levels are increased to 4&ndash;8%. This is due to an <strong>elevated</strong> ratio of <strong>&delta; chain</strong>&nbsp;to&nbsp;&beta;<strong>&nbsp;</strong>chain synthesis.&nbsp;Hb&nbsp;F levels are&nbsp;generally normal or slightly&nbsp;increased.</p>\n<p>Note: Increased HbF (diagnostic) and normal HbA2 levels are features of thalassemia major.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 25-year old man presents with chronic anemia and gall stones. His family history is significant for a similar illness. His peripheral blood smear is given below. What is the mode of the inheritance of the given clinical condition?",
    "choices": [
      {
        "id": 1,
        "text": "Autosomal dominant"
      },
      {
        "id": 2,
        "text": "Autosomal recessive"
      },
      {
        "id": 3,
        "text": "X-linked dominant"
      },
      {
        "id": 4,
        "text": "X-linked recessive"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given peripheral smear showing&nbsp;<strong>spherocytes,&nbsp;</strong>along with the history, is suggestive of&nbsp;<strong>hereditary spherocytosis.&nbsp;</strong>Inheritance of this condition is mainly&nbsp;<strong>autosomal dominant</strong>.</p>\n<p>Hereditary spherocytosis is a structural RBC disorder making the <strong>RBCs</strong> more <strong>spheroid</strong>. The RBCs are <strong>less deformable</strong> and more vulnerable to splenic sequestration and destruction. This <strong>decreases</strong> the <strong>lifespan</strong> of RBCs.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/389a11395c43424c8d2d65d3b620d60b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "What is the most common protein deficiency associated with hereditary spherocytosis?",
    "choices": [
      {
        "id": 1,
        "text": "Spectrin"
      },
      {
        "id": 2,
        "text": "Ankyrin"
      },
      {
        "id": 3,
        "text": "Actin"
      },
      {
        "id": 4,
        "text": "Glycophorin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Note: </strong>Few one-liners on membrane skeleton -</p>\n<ul>\n<li>Most abundant integral proteins -&nbsp;<strong>glycophorin, band 3&nbsp;</strong></li>\n<li>Responsible for biconcave shape of RBC -&nbsp;<strong>spectrin</strong></li>\n<li>Most severe deficiency -&nbsp;<strong>spectrin</strong></li>\n<li>Hereditary elliptocytosis is due to deficiency of&nbsp;<strong>alpha spectrin</strong></li>\n<li>Mushroom cells appearance due to deficiency of&nbsp;<strong>band 3</strong></li>\n<li>Never involved in HS -&nbsp;<strong>glycophorin</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/421cf4d19962443a895060d99edfd3cex1280x1991.JPEG"
    ]
  },
  {
    "text": "The peripheral smear of a patient with anaemia, jaundice and splenomegaly shows pincer cells. Which protein deficiency is responsible for this finding?",
    "choices": [
      {
        "id": 1,
        "text": "\u03b1 spectrin"
      },
      {
        "id": 2,
        "text": "Ankyrin"
      },
      {
        "id": 3,
        "text": "Band 3"
      },
      {
        "id": 4,
        "text": "Band 4.1"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><span class=\"TextRun SCXW185313120\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW185313120\"><strong>Pincer cell</strong> or <strong>mushroom cell</strong></span></span><span class=\"TextRun SCXW185313120\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW185313120\">&nbsp;is seen in&nbsp;<strong>hereditary spherocytosis</strong> associated with <strong>deficiency</strong> of&nbsp;</span></span><span class=\"TextRun SCXW185313120\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW185313120\">cytoskeletal protein</span></span><strong><span class=\"TextRun SCXW185313120\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW185313120\">&nbsp;</span></span></strong><span class=\"TextRun SCXW185313120\" lang=\"EN-GB\" xml:lang=\"EN-GB\"><span class=\"NormalTextRun SCXW185313120\"><strong>band 3</strong>.</span></span><span class=\"EOP SCXW185313120\" data-ccp-props=\"{&quot;201341983&quot;:0,&quot;335559739&quot;:160,&quot;335559740&quot;:259}\">&nbsp;</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5fb5d6bef0014f4f84696858f25b4716x1280x1991.JPEG"
    ]
  },
  {
    "text": "Which of the following features would you least expect to see in a patient with hereditary spherocytosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pallor"
      },
      {
        "id": 2,
        "text": "Gallstones"
      },
      {
        "id": 3,
        "text": "Splenomegaly"
      },
      {
        "id": 4,
        "text": "Hemoglobinuria"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hemoglobinuria</strong> is not seen in hereditary spherocytosis where extravascular hemolysis occurs.\u00a0It is a feature of <strong>intravascular</strong> hemolysis. Pigment gallstones, pallor and splenomegaly can be seen in this condition.</p>\n<p><strong>Cinical features</strong> of extravascular hemolysis include:</p>\n<ul>\n<li>Anaemia</li>\n<li>Jaundice</li>\n<li>Splenomegaly</li>\n</ul>\n<p><strong>Causes </strong>of extravascular hemolysis:</p>\n<ul>\n<li>Hereditary spherocytosis</li>\n<li>Thalassemia</li>\n<li>Sickle cell anaemia</li>\n</ul>\n<p>Note: G6PD deficiency and autoimmune hemolytic anaemia can cause both intravascular and extravascular hemolysis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the life span of affected red cells in patients with hereditary spherocytosis?",
    "choices": [
      {
        "id": 1,
        "text": "10\u201320 days"
      },
      {
        "id": 2,
        "text": "20\u201330 days"
      },
      {
        "id": 3,
        "text": "30\u201360 days"
      },
      {
        "id": 4,
        "text": "60\u201390 days"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The<strong> life span</strong> of affected <strong>red cells</strong> in <strong>hereditary spherocytosis</strong> is <strong>10 to 20 days</strong>. The normal life span of RBC is 120 days.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with hereditary spherocytosis, MCHC of 38 g/dL was noted. What could be the probable reason for this finding?",
    "choices": [
      {
        "id": 1,
        "text": "Dehydration"
      },
      {
        "id": 2,
        "text": "Increased in Hb content"
      },
      {
        "id": 3,
        "text": "Compensatory erythropoiesis"
      },
      {
        "id": 4,
        "text": "Change in shape"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Increased MCHC</strong> in hereditary spherocytosis is due to <strong>dehydration</strong> caused by the <strong>loss</strong> of <strong>K+</strong> and <strong>H<sub>2</sub>O</strong>.</p>\n<p>MCHC (mean corpuscular hemoglobin concentration) is given by the formula <strong>hemoglobin / PCV </strong>(g/dL). It indicates the amount of hemoglobin per unit volume.</p>\n<p>Note:</p>\n<ul>\n<li>MCV (mean corpuscular volume) is given by the formula PCV / RBC (fL). It denotes the size of the RBCs.</li>\n<li>MCH (mean corpuscular hemoglobin) is given by the formula hemoglobin / RBC (pg). It quantifies the hemoglobin in the RBCs.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In the following osmotic fragility curve, A occurs in _________.",
    "choices": [
      {
        "id": 1,
        "text": "Beta thalassemia"
      },
      {
        "id": 2,
        "text": "Sickle-cell anaemia"
      },
      {
        "id": 3,
        "text": "Hereditary spherocytosis"
      },
      {
        "id": 4,
        "text": "Iron deficiency anaemia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Osmotic fragility curve shifts to the&nbsp;<strong data-stringify-type=\"bold\">right</strong>&nbsp;in&nbsp;<strong data-stringify-type=\"bold\">hereditary spherocytosis</strong>.</p>\n<p>In hereditary spherocytosis, the cells are&nbsp;<strong data-stringify-type=\"bold\">spherocytic</strong>&nbsp;in normal plasma (0.9% NaCl) and&nbsp;<strong data-stringify-type=\"bold\">hemolyse</strong>&nbsp;readily at&nbsp;<strong data-stringify-type=\"bold\">higher concentrations</strong>&nbsp;than normal discoid red cells do, hence shifting the curve to the&nbsp;<strong data-stringify-type=\"bold\">right</strong>.</p>\n<p>Osmotic fragility is the susceptibility of the RBC to rupture under osmotic stress. In&nbsp;<strong data-stringify-type=\"bold\">hypotonic</strong>&nbsp;solutions, RBCs&nbsp;<strong data-stringify-type=\"bold\">swell</strong>&nbsp;to become spherical and eventually&nbsp;<strong data-stringify-type=\"bold\">hemolyse</strong>. In the graph, the x-axis represents the saline concentration while the y-axis represents the percentage of red cells that have undergone hemolysis. When osmotic fragility is&nbsp;<strong data-stringify-type=\"bold\">normal</strong>, red cells begin to hemolyse at 0.5% saline, with 50% of hemolysis occuring at 0.40-0.42% saline and complete hemolysis occuring at 0.35% saline as represented in the curve.</p>\n<p>In thalassemia and sickle cell anemia on the other hand, the cells are <strong>resistant</strong> to hemolysis and don&rsquo;t hemolyse unless the concentration of saline is <strong>very low</strong>, shifting the graph to the <strong>left</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e0102ad989de48ca8b0b337a96e35e66.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/95a58cb42c2e4626a8a7dbb6c7271e89x1280x1123.JPEG"
    ]
  },
  {
    "text": "A 7-year-old girl presents with fever and jaundice for 5 days. On examination, splenomegaly is noted. Her lab reports are given below. What is the likely trigger to have caused this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Parvovirus"
      },
      {
        "id": 2,
        "text": "EBV"
      },
      {
        "id": 3,
        "text": "Plasmodium"
      },
      {
        "id": 4,
        "text": "Meningococcus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given hemogram showing <strong>pancytopenia</strong> and <strong>spherocytes</strong> in peripheral smear is suggestive of <strong>aplastic crisis</strong> in <strong>hereditary spherocytosis</strong>. It is usually triggered by <strong>parvovirus</strong> infection.</p>\n<p>Parvovirus infects and kills the red cell precursors. This creates a<strong> transient </strong>arrest of erythropoiesis i.e. <strong>aplastic crisis</strong> as the life span of RBCs are shortened. The immune response clears the virus in 1-2 weeks.</p>\n<p><strong>Blood transfusions</strong> may be necessary during <strong>acute phases</strong> of the infection. This crisis can also occur in other hemolytic anaemias.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which amino acid lies at the sixth position of the beta chain of hemoglobin?",
    "choices": [
      {
        "id": 1,
        "text": "Valine"
      },
      {
        "id": 2,
        "text": "Glutamine"
      },
      {
        "id": 3,
        "text": "Glutamate"
      },
      {
        "id": 4,
        "text": "Lysine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Glutamate</strong> lies at the <strong>6th position</strong> of the <strong>beta chain</strong> of hemoglobin.</p>\n<p><strong>Sickle-cell disease</strong> is caused by a <strong>point</strong> <strong>mutation</strong> in the sixth codon of \u03b2-globin. This leads to the <strong>replacement</strong> of a glutamate residue with a <strong>valine</strong> residue.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A blood sample is taken from a suspected case of sickle cell anaemia. Which of the following properties can be used to differentiate HbS from HbA?",
    "choices": [
      {
        "id": 1,
        "text": "Function"
      },
      {
        "id": 2,
        "text": "Stability"
      },
      {
        "id": 3,
        "text": "Affinity"
      },
      {
        "id": 4,
        "text": "Solubility"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Solubility can be used to differentiate as <strong>HbS</strong> is <strong>less soluble</strong> than <strong>HbA</strong>. The function, stability and affinity of HbS are similar to that of HbA.</p>\n<p>In <strong>HbS</strong>, <strong>glutamic acid</strong>, which is a polar amino acid, is <strong>replaced</strong> by a non-polar amino acid <strong>valine</strong> at the 6<sup>th</sup> position.&nbsp;HbS molecules have the tendency to stack into<strong> polymers</strong> when <strong>deoxygenated</strong>.&nbsp;This process converts the red cell <strong>cytosol</strong> from a free-flowing liquid into a viscous <strong>gel</strong>.&nbsp;This causes a change in the solubility of the hemoglobin.</p>\n<p>The major pathologic manifestations of decreased solubility and polymerisation of HbS are chronic hemolysis, microvascular occlusions, and tissue damage.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old man was diagnosed to have heterozygous sickle cell trait. What will be the approximate percentage of HbS in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "40%"
      },
      {
        "id": 2,
        "text": "60%"
      },
      {
        "id": 3,
        "text": "50%"
      },
      {
        "id": 4,
        "text": "30%"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In <strong>heterozygotes</strong>&nbsp;with <strong>sickle-cell trait</strong>, about <strong>40%</strong> of the hemoglobin is <strong>HbS.</strong>&nbsp;The rest of hemoglobin (60%) is HbA.</p>\n<p>Sickle cell trait is a largely asymptomatic condition characterised by heterozygosity seen for HbS (sickle hemoglobin). As only a fraction of the Hb are HbS, polymerization leading to sickling only occurs in <strong>severe and prolonged hypoxia.&nbsp;</strong>Offsprings of 2 heterozygotes have a 1 in 4 chance of having sickle cell <strong>disease</strong>.&nbsp;</p>\n<p>In HbSC heterozygotes, HbS is 50% and HbC is 50%.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Patients with which of the following combinations of beta-globin chains tend to have a more severe sickle cell disease?",
    "choices": [
      {
        "id": 1,
        "text": "HbA and HbS"
      },
      {
        "id": 2,
        "text": "HbA2 and HbS"
      },
      {
        "id": 3,
        "text": "HbS and HbC"
      },
      {
        "id": 4,
        "text": "HbS and HbF"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Among the given options, the heterozygous combination of <strong>HbS</strong> and <strong>HbC</strong> causes a more severe form of the disease. Overall severity is more in homozygous HbS.&nbsp;</p>\n<p>Severity sequence is <strong>HbSS &gt; HbSC &gt; HbSA &gt; HbSF.</strong></p>\n<p>In <strong>HbC,</strong>&nbsp;<strong>lysine</strong> is substituted for <strong>glutamate</strong> in the sixth amino acid residue of &beta;-globin. The percentage of HbS is 50% in HbSC red cells and 40% in HbAS cells. Moreover, <strong>HbSC</strong> cells tend to lose salt and water and become dehydrated, which increases the intracellular concentration of HbS. Both of these factors <strong>increase</strong> the <strong>tendency</strong> for HbS to <strong>polymerize</strong>. As a result, individuals who are compound heterozygotes for HbS and HbC, have symptomatic sickling disorder (termed HbSC disease). However, it is milder than sickle cell disease (HbSS).</p>\n<p><strong>HbF</strong> <strong>inhibits</strong> the <strong>polymerization</strong> of HbS even more than HbA. Hence, infants do not become symptomatic until they reach 5 or 6 months of age when the level of HbF normally falls.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In patients with sickle cell anaemia, which of the following factors promote sickling of RBC?",
    "choices": [
      {
        "id": 1,
        "text": "Decreased MCHC"
      },
      {
        "id": 2,
        "text": "HbF type"
      },
      {
        "id": 3,
        "text": "HbC type"
      },
      {
        "id": 4,
        "text": "High pH"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>HbC</strong>\u00a0<strong>promotes</strong> the <strong>sickling</strong> of RBC, whereas HbF opposes it.</p>\n<p>Factors that promote sickling are:</p>\n<ul>\n<li>Increased MCHC</li>\n<li>Hb C</li>\n<li>Acidic pH</li>\n<li>Hypoxia</li>\n</ul>\n<p><strong>HbF</strong> has a <strong>high affinity</strong>\u00a0for oxygen than other hemoglobins. Hence, high oxygen content prevents sickling. HbF inhibits the polymerization of HbS. So the infants do not become symptomatic until they reach 5 or 6 months of age when the level of HbF normally falls.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following reagents is used for sickling test?",
    "choices": [
      {
        "id": 1,
        "text": "Sodium thiocyanate"
      },
      {
        "id": 2,
        "text": "Sodium chloride"
      },
      {
        "id": 3,
        "text": "Sodium metabisulfite"
      },
      {
        "id": 4,
        "text": "Hydrochloric acid"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>reagent</strong> used for the <strong>sickling test</strong> is <strong>sodium metabisulfite</strong>. It is an oxygen-consuming reagent,&nbsp;which induces the sickling of red cells in the presence of HbS.&nbsp;</p>\n<p>Sickling test with sodium metabisulfite is used as a <strong>screening</strong> test for sickle cell anaemia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 12-year-old girl presents with fever and severe pain in her hands and feet. There is no history of trauma. Her lab reports reveal Hb to be 8.2 g/dL and peripheral smear as shown below. Which of the following parasitic infections is this condition protective against?",
    "choices": [
      {
        "id": 1,
        "text": "P. falciparum"
      },
      {
        "id": 2,
        "text": "P. vivax"
      },
      {
        "id": 3,
        "text": "P. ovale"
      },
      {
        "id": 4,
        "text": "Babesia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario is suggestive of&nbsp;<strong>sickle cell anaemia.</strong>&nbsp;HbS gives <strong>protection</strong> against<em> <strong>P</strong><strong>lasmodium</strong> <strong>falciparum</strong></em> malaria.&nbsp;</p>\n<p><strong>Hand-foot syndrome</strong>&nbsp;or <strong>dactylitis</strong> of bones of hands and feet is a severe acute inflammatory response seen in sickle cell anaemia.&nbsp;It is caused by <strong>vaso-occlusive</strong> episodes leading to <strong>ischemia</strong> and finally <strong>infarction</strong> of the distal portions of the <strong>extremities</strong>.</p>\n<p>Sickle cells <strong>impair</strong> the <strong>formation</strong> of membrane knobs containing a protein made by <em>P. falciparum</em> called <strong>PfEMP-1</strong>. This <strong>decreases</strong> the <strong>adherence</strong> of infected red cells to the endothelium.</p>\n<p>Individuals with <strong>sickle cell trait</strong> are significantly less likely to have severe disease or to die from malaria. It is because of the increased <strong>phagocytosis</strong> of sickled cells in the spleen, which keeps the <strong>parasite load down</strong>.&nbsp;</p>\n<p>The image given below shows sickle cells seen on peripheral smear in sickle cell anemia.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/75f848107823409a8fa03678f29426ed.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f89e37ae8f574f5e86ca447ceba81f67x1280x1151.JPEG"
    ]
  },
  {
    "text": "What happens to the severity of hemolytic anaemia in concurrent sickle cell anaemia and \u03b1-thalassemia?",
    "choices": [
      {
        "id": 1,
        "text": "Increases"
      },
      {
        "id": 2,
        "text": "Decreases"
      },
      {
        "id": 3,
        "text": "No change"
      },
      {
        "id": 4,
        "text": "Both cannot co-exist"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>concurrence</strong> of <strong>sickle cell</strong> anaemia and <strong>&alpha;-thalassemia</strong> results in <strong>less severe hemolytic anaemia</strong>.</p>\n<p><strong>Sickle cell anaemia</strong> is caused by point mutations in &beta; globin synthesis leading to <strong>defective HbS synthesis</strong>. When these RBCs release oxygen, the <strong>HbS polymerises</strong> leading to membrane distortion</p>\n<p><strong>Thalassemia</strong> is due to germline mutations causing <strong>decreased</strong> globin chain synthesis (&alpha; or&nbsp;&beta;). Since these diseases have a different pathogenesis, they <strong>can occur concurrently</strong>.</p>\n<p>In alpha-thalassemia, the <strong>concentration</strong> of <strong>hemoglobin</strong> is <strong>decreased</strong>. Therefore the <strong>concentration</strong> of <strong>HbS</strong> in sickle cell anaemia is also <strong>decreased</strong>. Since HbS molecules should be <strong>close</strong> to each other for <strong>polymerization</strong> to occur. Since there is a <strong>decreased concentration</strong> of HbS in alpha-thalassemia, the HbS molecules are <strong>far</strong> <strong>apart</strong>. So there is a <strong>decreased</strong> <strong>polymerization</strong> of HbS and therefore <strong>less severity</strong> of the disease.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 23-year-old patient with sickle cell anaemia presents with fever and malaise. IgM ELISA confirms a parvovirus B19 infection. Which of the following crises will you expect to see in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Aplastic"
      },
      {
        "id": 2,
        "text": "Sequestration"
      },
      {
        "id": 3,
        "text": "Vaso occlusion"
      },
      {
        "id": 4,
        "text": "Acute chest syndrome"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Aplastic crisis</strong> in sickle cell anaemia is caused by <strong>parvovirus B19</strong>.&nbsp;It is&nbsp;a transient arrest of erythropoiesis, usually triggered by an acute parvovirus infection. Parvovirus infects and kills red cell precursors. It occurs in sickle cell disease and other hemolytic anaemias.</p>\n<p><strong>Vaso-occlusive crises</strong> (pain crises) are episodes of <strong>hypoxic injury</strong> and <strong>infarction</strong> that cause severe pain in the affected region. The most commonly involved sites are the bones, lungs, liver, brain, spleen, and penis.&nbsp;<strong>Acute chest syndrome</strong> is a type of vaso-occlusive crisis involving the lungs. It typically presents with fever, cough, chest pain, and pulmonary infiltrates. Pulmonary inflammation may cause blood flow to become sluggish and &ldquo;spleenlike,&rdquo; leading to sickling and vaso-occlusion.&nbsp;</p>\n<p><strong>Sequestration crises</strong> occur in children with intact spleens. Massive entrapment of sickle red cells leads to rapid <strong>splenic enlargement</strong>, hypovolemia, and sometimes shock. Both sequestration crises and acute chest syndrome may be fatal and sometimes require prompt treatment with exchange transfusions.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During USG examination in a patient with hemolytic anemia, the spleen was not visualized. There is no past history of trauma or surgery. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Sickle cell anaemia"
      },
      {
        "id": 2,
        "text": "G6PD deficiency"
      },
      {
        "id": 3,
        "text": "Beta-thalassemia"
      },
      {
        "id": 4,
        "text": "Hereditary spherocytosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Non-visualisation</strong> of the <strong>spleen</strong> on routine USG is suggestive of <strong>autosplenectomy</strong>, which is seen in <strong>sickle cell anemia</strong>. Splenomegaly is seen in thalassemia and hereditary&nbsp;spherocytosis.</p>\n<p>In <strong>children</strong> with sickle cell anaemia, there is <strong>moderate</strong> <strong>splenomegaly.</strong>&nbsp;This is due to red pulp congestion caused by the entrapment of sickled red cells. As age advances, <strong>chronic erythrostasis</strong> produces hypoxic damage and infarcts. By <strong>adulthood</strong>, the spleen is reduced to a band of fibrous tissue. This process is called&nbsp;<strong>autosplenectomy</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '21 Extravascular Hemolysis';
        const quizFilename = '21-extravascular-hemolysis-9edbf457.html';
        let hierarchy = ["Marrow", "qBank", "Pathology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>