<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21 Disorders Of The Liver - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pediatrics
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A mother observed unusual redness on the palms of her young child while putting him to sleep. She brings him to your OPD and on examination, you find mild abdominal distension, splenomegaly, and pedal edema. You admit the child for further evaluation, but on the night of admission, he suddenly starts vomiting fresh blood. Which is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Mallory Weis tear"
      },
      {
        "id": 2,
        "text": "Esophageal varices"
      },
      {
        "id": 3,
        "text": "Kala azar"
      },
      {
        "id": 4,
        "text": "AML"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A child presenting with <strong>hematemesis and splenomegaly</strong> is presumed to have <strong>variceal bleeding</strong> unless proved otherwise. Bleeding from oesophagal varices is the most common presentation of portal hypertension.</p>\n<p><strong>Palmar erythema</strong>(redness of the palms) and <strong>ascites</strong> (swelling of the abdomen) are features of liver failure seen in this patient.&nbsp;</p>\n<p>Upper GI endoscopy is the preferred diagnostic test for oesophagal varices.&nbsp;</p>\n<p>The management of acute variceal bleeding-</p>\n<ul>\n<li>Attain hemodynamic stability through blood transfusion/fluids</li>\n<li>Vasoactive drugs (e.g., <strong>octreotide</strong>)</li>\n<li>Endoscopy to perform ligation or sclerotherapy</li>\n<li>Transjugular intrahepatic portosystemic shunt should be considered for variceal bleeding refractory to medical and endoscopic therapy.&nbsp; &nbsp; &nbsp;</li>\n</ul>\n<p>Secondary prophylaxis to reduce the recurrence of bleeding includes-</p>\n<ul>\n<li>Nonselective &beta; blockade (propranolol, nadolol)</li>\n<li>Obliteration of varices through serial treatment via ligation or sclerotherapy</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 10-year-old boy was brought by his mother to the ER after having a sudden episode of vomiting blood. On examination, splenomegaly is detected with engorged superficial veins around his umbilicus. Which is the investigation of choice in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Abdominal USG"
      },
      {
        "id": 2,
        "text": "Capsule endoscopy"
      },
      {
        "id": 3,
        "text": "Triphasic CT"
      },
      {
        "id": 4,
        "text": "Upper GI endoscopy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\">A child presenting with <strong>hematemesis and splenomegaly</strong> is presumed to have <strong>variceal bleeding</strong>&nbsp;and hence,&nbsp;<strong>upper GI endoscopy&nbsp;</strong>is the investigation of choice.</p>\n<p style=\"text-align: justify;\">The upper GI endoscopy provides a definitive diagnosis and an option to treat via <strong>band ligation </strong>or<strong> sclerotherapy</strong><strong>.</strong>&nbsp;</p>\n<p style=\"text-align: justify;\">Capsule endoscopy, ultrasound, CT, MRI, and elastography are not recommended because of their suboptimal accuracy compared to endoscopy. Capsule endoscopy is used to investigate an occult/obscure gastrointestinal bleed mostly suspected to be in the small intestine.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Unconjugated hyperbilirubinemia, which did not subside even after 3 weeks of birth, was observed in a neonate. On investigating, liver enzymes, PT/INR and albumin levels were normal. No hemolysis was seen on a peripheral blood smear. A drop in bilirubin level was observed within a week after treating with phenobarbital. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Rotor syndrome"
      },
      {
        "id": 2,
        "text": "Crigler Najjar type 2"
      },
      {
        "id": 3,
        "text": "Dubin Johnson syndrome"
      },
      {
        "id": 4,
        "text": "Crigler Najjar type 1"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Jaundice persisiting <strong>3 weeks after birth</strong> is suggestive of&nbsp;<strong>pathological jaundice</strong>. Among the given options,&nbsp;<strong>Crigler Najjar type</strong>&nbsp;<strong>2&nbsp;</strong>presents with&nbsp;<strong>unconjugated</strong> hyperbilirubinemia which <strong>responds</strong> to&nbsp;<strong>p</strong><strong>henobarbital therapy</strong>.<strong>&nbsp;</strong>&nbsp;</p>\n<p><strong>Dubin Johnson</strong> (option C) and <strong>Rotor&nbsp;</strong>(option A) syndromes lead to <strong>conjugated hyperbilirubinemia</strong>.&nbsp;</p>\n<p><span class=\"fontstyle0\">Crigler Najjar type 2 is an <strong>autosomal recessive</strong> disease with <strong>non-hemolytic</strong>, <strong>unconjugated</strong> hyperbilirubinemia caused by homozygous missense mutations in the enzyme UDP <strong>UGT1A1</strong>&nbsp;resulting in reduced (partial) enzymatic activity.</span></p>\n<p>The differences between Crigler-Najjar type 1 and type 2 are described in the table below:</p>\n<table>\n<tbody>\n<tr>\n<td style=\"text-align: center;\"><strong>Crigler Najjar Type 1</strong></td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\"><strong>Crigler Najjar Type 2</strong></td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">Autosomal recessive</td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\">Autosomal recessive</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">UDPGT is <strong>absent</strong></td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\">UDPGT is <strong>reduced</strong></td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">Severe unconjugated hyperbilirubinemia</td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\">Less severe</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">Pale stools</td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\">Normal-coloured stools</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">May proceed to <strong>kernicterus&nbsp;</strong>and <strong>does not</strong><strong>&nbsp;respond to phenobarbitone</strong></td>\n<td style=\"text-align: center;\">&nbsp;</td>\n<td style=\"text-align: center;\">Does not proceed to kernicterus and <strong>is responsive to phenobarbitone</strong></td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 14-year-old boy was brought to the OPD by his father who observed a yellowish tinge to his skin and eyes. He gives a history of recent onset fatigue after playing football for a few minutes and cannot stay active on the playground for a long time like before. Investigations revealed isolated conjugated hyperbilirubinemia but are normal otherwise. Liver histology revealed a black pigment. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Gilbert syndrome"
      },
      {
        "id": 2,
        "text": "Crigler-Najjar syndrome"
      },
      {
        "id": 3,
        "text": "Dubin-Johnson syndrome"
      },
      {
        "id": 4,
        "text": "Rotor syndrome"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p style=\"text-align: justify;\">The presence of fatigue, conjugated hyperbilirubinemia and black pigment on liver biopsy, termed as \"<strong>black liver\"</strong>&nbsp;is suggestive of&nbsp;<strong>Dubin&ndash;Johnson syndrome</strong>.</p>\n<p style=\"text-align: justify;\">Dubin-Johnson syndrome is an <strong>autosomal recessive</strong> inherited defect in hepatocyte secretion of bilirubin glucuronide. Disease results from absent function of <strong>multiple drug-resistant protein 2</strong>,&nbsp;an ATP dependent canalicular transporter.</p>\n<p style=\"text-align: justify;\">The most commonly reported symptoms are abdominal pain and fatigue, jaundice, dark urine, and slight enlargement of the liver.</p>\n<p style=\"text-align: justify;\">Inherited conjugated hyperbilirubinemia-</p>\n<table style=\"height: 181px;\" width=\"374\">\n<tbody>\n<tr>\n<td style=\"width: 209.875px;\"><strong>Dubin&ndash;Johnson syndrome</strong></td>\n<td style=\"width: 148.140625px;\"><strong>Rotor syndrome</strong></td>\n</tr>\n<tr>\n<td style=\"width: 209.875px;\">Autosomal recessive</td>\n<td style=\"width: 148.140625px;\">Autosomal recessive</td>\n</tr>\n<tr>\n<td style=\"width: 209.875px;\">Absent function of<strong><strong>&nbsp;multiple drug-resistant protein (</strong></strong><strong>MRP-2)</strong></td>\n<td style=\"width: 148.140625px;\">Defect in anion transport</td>\n</tr>\n<tr>\n<td style=\"width: 209.875px;\"><strong>Black liver</strong> on biopsy (due to accumulation of epinephrine metabolite)</td>\n<td style=\"width: 148.140625px;\">Black liver is not seen</td>\n</tr>\n<tr>\n<td style=\"width: 209.875px;\">Normal levels of coproporphyrin in urine</td>\n<td style=\"width: 148.140625px;\">Increased levels of coproporphyrin in urine&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 209.875px;\">Gall bladder is not visualized on oral cholecystography</td>\n<td style=\"width: 148.140625px;\">Gall bladder is visualized on oral cholecystography</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are an intern posted in the paediatrics department and a child with Dubin-Johnson syndrome is admitted to your unit. During rounds, the attending paediatrician asks you which molecular defect causes liver disease in this patient. Your answer would be",
    "choices": [
      {
        "id": 1,
        "text": "ATP7A"
      },
      {
        "id": 2,
        "text": "ATP7B"
      },
      {
        "id": 3,
        "text": "ABCC2"
      },
      {
        "id": 4,
        "text": "SERPINA 1"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p style=\"text-align: justify;\">Molecular defect causing liver disease in <strong>Dubin&ndash;Johnson syndrome</strong>&nbsp;is<strong> ABCC2</strong> (codes for canalicular protein with ATP-binding cassette), it leads to the mutation of <strong>multiple drug-resistant protein 2 (MRP2) receptor</strong>. Hence, there is&nbsp;a defect in the&nbsp;transfer of conjugated bilirubin from the&nbsp;liver to bile in Dubin&ndash;Johnson syndrome.</p>\n<p>Important diseases and their molecular defects:</p>\n<table style=\"width: 293px;\">\n<tbody>\n<tr>\n<td style=\"width: 111px; text-align: center;\">ATP7A&nbsp;</td>\n<td style=\"width: 170px; text-align: center;\">Menke&rsquo;s&nbsp;disease&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 111px; text-align: center;\">ATP7B&nbsp;</td>\n<td style=\"width: 170px; text-align: center;\">Wilson disease&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 111px; text-align: center;\">CFTR&nbsp;</td>\n<td style=\"width: 170px; text-align: center;\">Cystic fibrosis&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 111px; text-align: center;\">SERPINA 1&nbsp;</td>\n<td style=\"width: 170px; text-align: center;\">&alpha;-1 antitrypsin deficiency&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 111px; text-align: center;\">ABCC2&nbsp;(MRP2 protein defect)&nbsp;</td>\n<td style=\"width: 170px; text-align: center;\">Dubin&nbsp;Johnson syndrome&nbsp;</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All are true about transient familial neonatal hyperbilirubinemia, except:",
    "choices": [
      {
        "id": 1,
        "text": "Increased unconjugated bilirubin"
      },
      {
        "id": 2,
        "text": "Occurs due to maternal antibody against fetal UGT1A1"
      },
      {
        "id": 3,
        "text": "It is also known as Lucey Driscoll syndrome"
      },
      {
        "id": 4,
        "text": "Stop breast feeding when jaundice sets in"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p style=\"text-align: justify;\"><strong>Lucey Driscoll syndrome</strong> or <strong>transient familial neonatal hyperbilirubinemia</strong> is a self-limiting condition and there is <strong>no need to stop breastfeeding. </strong></p>\n<p style=\"text-align: justify;\"><strong>Lucey Driscoll syndrome</strong>&nbsp;is an autosomal recessive metabolic disorder affecting enzymes involved in <strong>bilirubin metabolism</strong>. It causes transient familial neonatal unconjugated hyperbilirubinemia and <strong>jaundice</strong> occurs during the <strong>first 4 days of life</strong>. It is due to <strong>maternal antibodies</strong> against <strong>fetal UGT1A1</strong>&nbsp;(UDP glucuronosyltransferase family 1 member A1).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Lately, a teacher observed that an anxious young girl had started drooling saliva from her mouth while listening in the classroom. She had also developed a deterioration in her handwriting while taking down notes. Her mother was informed and she brought her child to your clinic. On examination, she had tremors and mild hepatomegaly. A slit-lamp examination was done and showed the following picture. The right statement about this disease is -",
    "choices": [
      {
        "id": 1,
        "text": "It is autosomal dominant."
      },
      {
        "id": 2,
        "text": "Serum ceruplasmin levels are high."
      },
      {
        "id": 3,
        "text": "Coombs-positive hemolytic anaemia may be present."
      },
      {
        "id": 4,
        "text": "Patient can be treated with triethylenetetramine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The image shows the <strong>Kayser-Fleischer ring</strong>, which is characteristic of <strong>Wilson's disease</strong>. It is an <strong>autosomal recessive</strong> disorder, characterised by <strong>low serum ceruloplasmin</strong> levels. <strong>Coomb's negative hemolytic anemia</strong> may be present. The patient can be treated with <strong>triethylenetetramine</strong> also known as <strong>trientine</strong>.</p>\n<p>Wilson&rsquo;s disease is caused due to a&nbsp;<strong>loss-of-function mutation</strong>&nbsp;in the&nbsp;<strong>ATP7B</strong>&nbsp;gene on&nbsp;<strong>Chr.13q</strong>. The gene encodes a copper transporting ATPase (ATP7B) which has 2 functions:</p>\n<ul>\n<li aria-level=\"1\">Maintains copper in bound form by binding copper to apoceruloplasmin</li>\n<li aria-level=\"1\">Helps excrete free copper in bile.</li>\n</ul>\n<p>Thus, an ATP7B deficiency leads to&nbsp;<strong>excess deposition of free copper</strong>&nbsp;within tissues.</p>\n<table style=\"width: 572.969px;\">\n<tbody>\n<tr>\n<td style=\"width: 141px;\"><strong>Lab markers</strong></td>\n<td style=\"width: 122px;\"><strong>Change in Wilson's disease</strong></td>\n<td style=\"width: 289.969px;\"><strong>Reason</strong></td>\n</tr>\n<tr>\n<td style=\"width: 141px;\">Serum ceruloplasmin</td>\n<td style=\"width: 122px;\">&darr;&darr;</td>\n<td style=\"width: 289.969px;\">ATP7B deficiency results in reduced bound copper</td>\n</tr>\n<tr>\n<td style=\"width: 141px;\">24h urinary copper</td>\n<td style=\"width: 122px;\">&uarr;&uarr;</td>\n<td style=\"width: 289.969px;\">Excess free copper excreted in urine</td>\n</tr>\n<tr>\n<td style=\"width: 141px;\">Total serum copper</td>\n<td style=\"width: 122px;\">&darr;</td>\n<td style=\"width: 289.969px;\">Due to marked reduction in ceruloplasmin</td>\n</tr>\n</tbody>\n</table>\n<p>The drugs used in the management of Wilson's disease include:</p>\n<ul>\n<li>Chelating agents as first-line drugs\n<ul>\n<li><strong>D-penicillamine</strong></li>\n<li><strong>Trientine&nbsp;</strong>or&nbsp;triethylenetetramine</li>\n</ul>\n</li>\n<li>Elemental&nbsp;<strong>zinc</strong>&nbsp;as maintenance therapy.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f4958c7582ad4ddbb7614dd1d63f1f1d.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A mother observed deterioration in her young child's academic performance and loss of interest in everyday activities for the last few weeks. She has also lost the ability to play catch with her brother and complains of muscle weakness. There is mild hepatomegaly noted on examination. Her serum ceruloplasmin levels were reduced. All of the following manifestations can occur in a patient with this disease except?",
    "choices": [
      {
        "id": 1,
        "text": "Sparse depigmented hair"
      },
      {
        "id": 2,
        "text": "Shrinkage of liver"
      },
      {
        "id": 3,
        "text": "Ascites and portal hypertension"
      },
      {
        "id": 4,
        "text": "Renal Fanconi syndrome"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p style=\"text-align: justify;\">The presence of <strong>reduced ceruloplasmin</strong> levels, <strong>motor incoordination,</strong> and <strong>hepatomegaly</strong> suggest the patient is suffering from <strong>Wilson\u2019s disease.\u00a0</strong><strong>Sparse depigmented hair</strong> is <strong>not</strong> a feature of Wilson's disease. It is a feature of <strong>Menke's disease.</strong></p>\n<p style=\"text-align: left;\">Wilson's disease is caused due to a mutation in the <strong>ATP7B gene</strong> that leads to\u00a0<strong>excess deposition of free copper</strong>\u00a0within tissues.</p>\n<p style=\"text-align: left;\">It has the following clinical features:</p>\n<table>\n<tbody>\n<tr>\n<td><strong>System</strong></td>\n<td><strong>Clinical features</strong></td>\n</tr>\n<tr>\n<td>Hepatic<br />(most common)</td>\n<td>\n<p>Jaundice<br />Abdominal pain<br />Hepatomegaly<br />Fatigue<br />Ascites<br />Variceal bleed<br />Coagulation defects</p>\n</td>\n</tr>\n<tr>\n<td>Neurological</td>\n<td>Dysarthria<br />Dystonia<br />Parkinsonism<br />Subcortical dementia<br />Depression<br />Wing beating tremors<br />Decreased scholastic performance</td>\n</tr>\n<tr>\n<td>Ophthalmic</td>\n<td>Kayser-Fleischer (KF) rings<br />Sunflower cataract</td>\n</tr>\n<tr>\n<td>Others</td>\n<td>Hemolytic anemia (Coombs negative)<br />Acute pancreatitis<br />Fanconi's syndrome<br />Hyperparathyroidism<br />Cardiomyopathy<br />Spontaneous abortions<br />Infertility</td>\n</tr>\n</tbody>\n</table>\n<p>Note: Wilson's disease may also present as cirrhosis and hepatic failure, where shrinkage of liver occurs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In Wilson Disease, hepatic copper content usually exceeds____ \u03bcg/g dry weight.",
    "choices": [
      {
        "id": 1,
        "text": "150"
      },
      {
        "id": 2,
        "text": "250"
      },
      {
        "id": 3,
        "text": "350"
      },
      {
        "id": 4,
        "text": "450"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In Wilson disease, <strong>hepatic copper content</strong> usually exceeds<strong> 250 &mu;g/g </strong>dry weight.</p>\n<p><strong>Hepatic copper accumulation </strong>is the<strong> hallmark </strong>of Wilson disease.&nbsp;It is measured using neutron activation analysis/atomic absorption spectrometry.&nbsp;&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A male infant was born to a mother with chronic hepatitis B infection. The infant is suspected to have been exposed at the time of delivery. At 4 months, which of the following viral markers signifies ongoing viral replication in the infant?",
    "choices": [
      {
        "id": 1,
        "text": "Anti-HBs"
      },
      {
        "id": 2,
        "text": "Anti-HBc"
      },
      {
        "id": 3,
        "text": "HBe Ag"
      },
      {
        "id": 4,
        "text": "HBs Ag"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>HBeAg</strong> signifies the ongoing viral replication in case of hepatitis B infection.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 9-year-old boy was brought to the OPD by his mother with a history of fatigue and myalgia for a few days, associated with rashes that started a week before it. On examination, coppery-red coloured skin lesions were seen on the face and limbs including palms and soles. His serology was positive for HBsAg. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Erythema infectiosum"
      },
      {
        "id": 2,
        "text": "Gianotti- Crosti syndrome"
      },
      {
        "id": 3,
        "text": "Henoch schonlein purpura"
      },
      {
        "id": 4,
        "text": "Erythema multiformae"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\">The coppery-red colored papules along with a <strong>positive HBsAg</strong> are suggestive of <strong>Gianotti-Crosti syndrome</strong>, also known as papular acrodermatitis.</p>\n<p style=\"text-align: justify;\">It is an immunologic reaction to viral infections. The most common associations are Epstein-Barr virus,<strong>&nbsp;hepatitis B virus</strong>, Coxsackievirus A16, and parainfluenza virus, as well as with many childhood immunizations.</p>\n<p style=\"text-align: justify;\">Skin lesions are monomorphic, firm, coppery red papules sized 1-10 mm. They occur in crops and may become profuse and coalesce into plaques, forming a symmetric eruption on the face, ears, buttocks, and limbs, including the palms and soles. The trunk, scalp, and mucous membrane are relatively spared.</p>\n<p style=\"text-align: justify;\">The image given below shows the coppery red papules seen in Gianotti-Crosti syndrome.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d3d198ab8f874b66b23876ab97587128x603x438.JPEG"
    ]
  },
  {
    "text": "Which of the following drugs are not used in the treatment of hepatitis B?",
    "choices": [
      {
        "id": 1,
        "text": "Interferon \u03b12b"
      },
      {
        "id": 2,
        "text": "Lamivudine"
      },
      {
        "id": 3,
        "text": "Adefovir"
      },
      {
        "id": 4,
        "text": "Ribavirin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Ribavirin</strong> is a drug used in the treatment of <strong>hepatitis C</strong>,\u00a0not hepatitis B.</p>\n<p>Indications for starting antiviral therapy in chronic hepatitis B are:</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Patients without cirrhosis</li>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"2\">HBeAg + with HBV DNA &gt;20,000 IU/mL and ALT level &gt;2 times the upper limit of normal</li>\n<li style=\"font-weight: 400;\" aria-level=\"2\">HBeAg -ve with HBV DNA &gt;2000 IU/mL and ALT level &gt;2 times the upper limit of normal</li>\n</ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Patients with compensated cirrhosis and an HBV DNA &gt;2000 IU/mL</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Patients developing acute liver failure or decompensated cirrhosis.</li>\n</ul>\n<p>Drugs used in the treatment of hepatitis B are:</p>\n<ul>\n<li>First-line treatment: Entecavir or tenofovir\u00a0</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Other drugs:\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Pegylated interferon-alpha</strong>\u00a0</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Telbivudine</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Lamivudine</strong></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Adefovir</strong></li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young child developed sudden bouts of vomiting and was brought to the ER.  Her condition rapidly worsened as she developed seizures. She had a history of influenza infection one week ago. The patient's liver biopsy will show ______.",
    "choices": [
      {
        "id": 1,
        "text": "Non-alcoholic steatohepatitis (NASH)"
      },
      {
        "id": 2,
        "text": "Centri zonal hemorrhagic necrosis"
      },
      {
        "id": 3,
        "text": "Marked microvesicular steatotis"
      },
      {
        "id": 4,
        "text": "Ring granuloma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Severe vomiting in a 5-year-old child, rapidly worsening to seizures, with a history of viral infection (influenza) is suggestive of <strong>Reye's syndrome.</strong> Hence, liver biopsy will show<strong> marked microvesicular steatosis</strong>.</p>\n<p>Reye's syndrome&nbsp;is a secondary mitochondrial hepatopathy. It is precipitated due to</p>\n<ul>\n<li>Viral infection (<strong>influenza, adenovirus, herpes, </strong>coxsackievirus A, Epstein&ndash;Barr virus)</li>\n<li><strong>Salicylate</strong> or antiemetic use</li>\n<li>Inborn error of metabolism such as <strong>single enzyme defects of &szlig; oxidation.</strong></li>\n<li>Toxins</li>\n</ul>\n<p>There is an acute onset of vomiting and encephalopathy, rapidly progressing to seizures, coma,&nbsp;and death. There is<strong> no jaundice</strong>.</p>\n<p>Investigations</p>\n<ul>\n<li>&uarr; ALT and AST</li>\n<li>&uarr; Ammonia</li>\n<li>normal bilirubin</li>\n<li>Hypoglycemia</li>\n<li>PT prolonged</li>\n<li>INR increased</li>\n<li>Liver biopsy: marked microvesicular steatosis. Necrosis is not seen.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 12-year old girl was rushed to the ER by her parents due to hematemesis. They gave a history of weakness and fatigue for the last few weeks. On examination, the patient had spider telangiectasias and mild palmar erythema. Liver function tests showed the following results- AST-1100IU/L, serum bilirubin- 8mg/dl, albumin- decreased, globulin- elevated, PT- prolonged along with Anti-Nuclear Antibody positive. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Type 1 autoimmune hepatitis"
      },
      {
        "id": 2,
        "text": "SLE"
      },
      {
        "id": 3,
        "text": "Type 2 autoimmune hepatitis"
      },
      {
        "id": 4,
        "text": "Hepatitis C"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The symptoms of liver failure and portal hypertension along with a positive anti-nuclear antibody<strong>(ANA)</strong> is suggestive of Type 1 autoimmune hepatitis. It is associated with-&nbsp;</p>\n<ul>\n<li>Elevated serum aminotransaminase concentrations.</li>\n<li>Liver-associated serum autoantibodies<strong>.</strong></li>\n<li>Hypergammaglobulinemia.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 2-week-old low-birth-weight neonate presents with jaundice. Stools are pale/clay coloured. Liver biopsy shows loss of architecture. The most likely diagnosis is_______.",
    "choices": [
      {
        "id": 1,
        "text": "Neonatal hepatitis"
      },
      {
        "id": 2,
        "text": "Extrahepatic biliary atresia"
      },
      {
        "id": 3,
        "text": "Wilson disease"
      },
      {
        "id": 4,
        "text": "Hereditary hemochromatosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Neonatal jaundice in a low-birth-weight (LBW) neonate with consistently pale/clay coloured stools with liver biopsy finding of loss of architecture is suggestive of <strong>neonatal hepatitis</strong>.</p>\n<p>Wilson disease and hereditary hemochromatosis will not present with jaundice in the neonatal stage. Hence, they can be excluded.&nbsp;Injury to liver cells can present the clinical and histologic picture of &ldquo;neonatal hepatitis.&rdquo;</p>\n<p>Differentiation between Neonatal hepatitis and EHBA</p>\n<table>\n<tbody>\n<tr>\n<td>&nbsp;</td>\n<td><strong>Neonatal hepatitis&nbsp;</strong></td>\n<td><strong>Extrahepatic biliary atresia (EHBA)&nbsp;</strong></td>\n</tr>\n<tr>\n<td style=\"text-align: center;\"><strong>Definition</strong></td>\n<td style=\"text-align: left;\">\n<p>It implies intrahepatic cholestasis which includes</p>\n<ul>\n<li>Hepatic injury due to metabolic, viral, or idiopathic causes</li>\n<li>Intrahepatic bile duct injury</li>\n</ul>\n</td>\n<td style=\"text-align: left;\">\n<ul>\n<li>Obliteration of&nbsp;the entire extrahepatic biliary tree at or above the porta hepatis(85% cases) OR</li>\n<li>distal segmental bile duct obliteration with patent<br />extrahepatic ducts up to the porta hepatis(uncommon)</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\"><strong>Clinical features&nbsp;</strong></td>\n<td style=\"text-align: center;\">\n<p>Family history is present</p>\n<p>Premature or LBW baby</p>\n<p>Clay-coloured stools&nbsp;</p>\n</td>\n<td style=\"text-align: center;\">\n<p>Family history absent</p>\n<p>Normal appearance, without looking sick</p>\n<p>Persistent acholic&nbsp;stools&nbsp;</p>\n</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\"><strong>Investigations</strong></td>\n<td style=\"text-align: center;\">Liver biopsy: Loss of liver architecture&nbsp;</td>\n<td style=\"text-align: center;\">\n<p>HIDA scan: screening test&nbsp;</p>\n<p>USG:&nbsp;triangular cord sign&nbsp;</p>\n<p>Liver biopsy: bile duct proliferation&nbsp;</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A mother is concerned about her 3-week-old baby having yellowish discolouration of skin and eyes. On examination, the baby is chubby and playful. Stools are pale in color. Further evaluation with USG shows triangular cord sign and liver biopsy shows bile duct proliferation. The most likely diagnosis is ______.",
    "choices": [
      {
        "id": 1,
        "text": "Neonatal hepatitis"
      },
      {
        "id": 2,
        "text": "Hallervorden Spatz disease"
      },
      {
        "id": 3,
        "text": "Wilson disease"
      },
      {
        "id": 4,
        "text": "Extrahepatic biliary atresia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Neonatal jaundice in a neonate <strong>without a sick-looking appearance and&nbsp;with</strong> <strong>acholic stools,&nbsp;</strong>USG showing <strong>triangular cord sign,</strong> and liver biopsy showing<strong> bile duct proliferation</strong>&nbsp;is&nbsp;suggestive of biliary obstruction, which may be seen in <strong>biliary atresia</strong>.</p>\n<p>Wilson disease and Hallervorden Spatz disease (neurodegeneration with iron accumulation in the brain) do not present with jaundice in the neonatal stage. Hence, they can be excluded.</p>\n<p>Differentiation between neonatal hepatitis and EHBA</p>\n<table style=\"width: 364px;\">\n<tbody>\n<tr style=\"height: 36px;\">\n<td style=\"width: 147px; height: 36px;\"><strong>Neonatal hepatitis&nbsp;</strong></td>\n<td style=\"width: 176px; height: 36px;\"><strong>Extrahepatic biliary atresia (EHBA)&nbsp;</strong></td>\n</tr>\n<tr style=\"height: 204px;\">\n<td style=\"width: 147px; height: 204px;\">\n<p>It implies intrahepatic cholestasis which includes:</p>\n<p>Hepatic injury due to metabolic, viral, or idiopathic cause</p>\n<p>Intrahepatic bile duct injury</p>\n</td>\n<td style=\"width: 176px; height: 204px;\">\n<p>Obliteration of&nbsp;the entire extrahepatic biliary tree at or above the porta hepatis(85% cases)&nbsp; OR</p>\n<p>Distal segmental bile duct obliteration with patent<br />extrahepatic ducts up to the porta hepatis (uncommon)</p>\n</td>\n</tr>\n<tr style=\"height: 38px;\">\n<td style=\"width: 323px; height: 38px;\" colspan=\"2\">&nbsp;<strong>Clinical features&nbsp;</strong></td>\n</tr>\n<tr style=\"height: 146px;\">\n<td style=\"width: 147px; height: 146px;\">\n<p>Family history is present</p>\n<p>Premature or LBW baby</p>\n<p>Pigmented stools&nbsp;</p>\n</td>\n<td style=\"width: 176px; height: 146px;\">\n<p>Family history absent</p>\n<p>Normal appearance, without looking sick</p>\n<p>Persistent acholic&nbsp;stools&nbsp;</p>\n</td>\n</tr>\n<tr style=\"height: 11px;\">\n<td style=\"width: 323px; height: 11px;\" colspan=\"2\">\n<p><strong>Investigations</strong></p>\n</td>\n</tr>\n<tr style=\"height: 128px;\">\n<td style=\"width: 147px; height: 128px;\">Liver biopsy: Loss of liver architecture&nbsp;</td>\n<td style=\"width: 176px; height: 128px;\">\n<p>USG:&nbsp;triangular cord sign</p>\n<p>HIDA scan: screening test&nbsp;</p>\n<p>Liver biopsy: bile duct proliferation&nbsp;</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Liver biospy:</strong></p>\n<ul>\n<li>Biliary atresia is characterized by proliferation&nbsp;of the bile ductule, presence of bile plugs, and portal or perilobular edema and fibrosis, with the&nbsp;<strong>basic hepatic lobular architecture intact</strong>.</li>\n<li>In neonatal hepatitis, there is severe, diffuse hepatocellular disease, with<strong>&nbsp;distortion of lobular architecture</strong>, marked infiltration of inflammatory cells, and focal hepatocellular necrosis.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A mother leaves her 3-year-old son unattended for 20 mins and later finds him holding a blue coloured empty strip of tablets with a few tablets scattered on the floor. A few hours later he is rushed to the ER with nausea and vomiting.  As an intern taking the history, you suspect accidental ingestion of paracetamol tablets. The pattern of liver injury you would expect in this case is",
    "choices": [
      {
        "id": 1,
        "text": "Cholestasis"
      },
      {
        "id": 2,
        "text": "Centrilobular necrosis"
      },
      {
        "id": 3,
        "text": "Microvesicular steatosis"
      },
      {
        "id": 4,
        "text": "Fibrosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The pattern of liver injury caused by paracetamol (acetaminophen) is <strong>centrilobular necrosis</strong>.</p>\n<p>Acetaminophen toxicity results from the formation of a highly reactive intermediate metabolite, N -acetyl-p -benzoquinone imine (<strong>NAPQI</strong>). In therapeutic use, only about 5% is metabolized by the hepatic <strong>cytochrome P450</strong> enzyme CYP2E1 to NAPQI, which is then immediately joined with glutathione to form a nontoxic mercapturic acid conjugate.</p>\n<p>In overdose, glutathione stores are overwhelmed, and free NAPQI is able to combine with hepatic macromolecules to produce <strong>hepatocellular necrosis</strong>. Single acute toxic dose of APAP is generally considered to be <strong>&gt;200 mg/kg</strong> in children.&nbsp;</p>\n<p>Patterns of hepatic drug injury:</p>\n<table>\n<tbody>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\"><strong>Disease&nbsp;</strong></td>\n<td style=\"width: 192px; text-align: center; height: 15px;\"><strong>Drug&nbsp;</strong></td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\"><strong>Centrilobular&nbsp;necrosis&nbsp;</strong></td>\n<td style=\"width: 192px; text-align: center; height: 15px;\"><strong>Acetaminophen,</strong>&nbsp;Halothane&nbsp;</td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\"><strong>Microvesicular&nbsp;steatosis&nbsp;</strong></td>\n<td style=\"width: 192px; text-align: center; height: 15px;\"><strong>Valproic&nbsp;acid&nbsp;</strong></td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\">Acute hepatitis&nbsp;</td>\n<td style=\"width: 192px; text-align: center; height: 15px;\">Isoniazid&nbsp;</td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\"><strong>Fibrosis&nbsp;</strong></td>\n<td style=\"width: 192px; text-align: center; height: 15px;\"><strong>Methotrexate&nbsp;</strong></td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\"><strong>Cholestasis&nbsp;</strong></td>\n<td style=\"width: 192px; text-align: center; height: 15px;\">Chlorpromazine,&nbsp;<strong>Erythromycin,&nbsp;</strong>Estrogen&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 136px; text-align: center;\">Veno&nbsp;occlusive disease&nbsp;</td>\n<td style=\"width: 192px; text-align: center;\">Busulphan, Cyclophosphamide&nbsp;</td>\n</tr>\n<tr style=\"height: 33px;\">\n<td style=\"width: 136px; text-align: center; height: 33px;\">Portal and hepatic vein thrombosis&nbsp;</td>\n<td style=\"width: 192px; text-align: center; height: 33px;\">Estrogen, Androgen&nbsp;</td>\n</tr>\n<tr style=\"height: 15px;\">\n<td style=\"width: 136px; text-align: center; height: 15px;\">Biliary sludge&nbsp;</td>\n<td style=\"width: 192px; text-align: center; height: 15px;\">Ceftriaxone&nbsp;</td>\n</tr>\n<tr style=\"height: 33px;\">\n<td style=\"width: 136px; text-align: center; height: 33px;\">Hepatic adenoma/hepatocellular carcinoma&nbsp;</td>\n<td style=\"width: 192px; text-align: center; height: 33px;\">Oral contraceptive pills, Anabolic steroids&nbsp;</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are examining a young child who presented to the ER with a high fever and abdominal pain. The patient winces on abdominal palpation of the right upper quadrant. USG showed hydrops of the gallbladder. All of the following conditions are associated with hydrops of the gallbladder except\n__________.",
    "choices": [
      {
        "id": 1,
        "text": "Group A streptococcal pharyngitis"
      },
      {
        "id": 2,
        "text": "Kawasaki disease"
      },
      {
        "id": 3,
        "text": "Total parenteral nutrition"
      },
      {
        "id": 4,
        "text": "Cystic fibrosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Hydrops of the&nbsp;gallbladder is<strong> not</strong> associated with<strong>&nbsp;cystic fibrosis</strong>.</p>\n<p>Hydrops of gallbladder is the acute acalculous <strong>non-inflammatory</strong> distension of the gallbladder, which occurs in infants and children. It is characterized by the absence of calculi, bacterial infections or congenital anomalies of the biliary system.</p>\n<p>Hydrops is distinguished from acalculous cholecystitis by the absence of a significant inflammatory process and a generally <strong>benign prognosis</strong>.</p>\n<p>Conditions associated with hydrops of GB:</p>\n<ul>\n<li>Infections: <strong>Streptococcal pharyngitis</strong>, staphylococcal infection, ascariasis, leptospirosis, typhoid fever,&nbsp;and viral hepatitis</li>\n<li><strong>Kawasaki disease </strong></li>\n<li><strong>Total parenteral nutrition, prolonged fasting</strong></li>\n<li>Sickle cell crisis, thalassemia</li>\n<li>Sepsis</li>\n<li>Mesenteric adenitis, necrotizing enterocolitis</li>\n</ul>\n<p>Note: In cystic fibrosis&nbsp;cholelithiasis, cholecystitis, micro gallbladder is seen.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The commonest indication for liver transplantation in children is ______",
    "choices": [
      {
        "id": 1,
        "text": "Alagille syndrome"
      },
      {
        "id": 2,
        "text": "Biliary atresia"
      },
      {
        "id": 3,
        "text": "Caroli disease"
      },
      {
        "id": 4,
        "text": "Hepatcellular carcinoma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Biliary atresia</strong> is the <strong>most common</strong> indication for<strong> liver transplantation in children</strong>.</p>\n<p>Extrahepatic biliary atresia&nbsp;(EHBA) is defined as a partial or total <strong>absence </strong>of permeable<strong> bile duct </strong>between the porta hepatis and the duodenum. It is due to <strong>inflammatory fibrosis</strong> of the biliary tree.&nbsp;It leads to obstruction to bile flow thereby causing the leaking of <strong>conjugated bilirubin</strong> into the circulation.</p>\n<p>Infants have symptoms of <strong>jaundice</strong>,<strong> pale stools</strong>, and <strong>dark urine</strong> right after birth. In advanced disease, infants present with failure to thrive, hepatomegaly, and ascites due to liver cirrhosis.</p>\n<p><strong>HIDA scan</strong>&nbsp;is the <strong>investigation of choice</strong> for extrahepatic biliary atresia. An<strong> intraoperative cholangiogram </strong>is a gold standard investigation for diagnosis.</p>\n<table style=\"height: 261px; width: 379.417px;\">\n<tbody>\n<tr style=\"height: 29.7656px;\">\n<td style=\"width: 587.417px; text-align: center; height: 29.7656px;\" colspan=\"3\"><strong>Management of extrahepatic biliary atresia</strong></td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 87px; height: 54px;\">Type I</td>\n<td style=\"width: 226px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia restricted to the common bile duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n<td style=\"width: 274.417px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Roux-en-Y hepaticojejunostomy</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 87px; height: 54px;\">Type II</td>\n<td style=\"width: 226px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia of the common hepatic duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n<td style=\"width: 274.417px; height: 54px;\" rowspan=\"2\"><strong>Kasai procedure</strong> (Roux-en-Y hepatoportoenterostomy)</td>\n</tr>\n<tr style=\"height: 54px;\">\n<td style=\"width: 87px; height: 54px;\">Type III</td>\n<td style=\"width: 226px; height: 54px;\">\n<div class=\"page\" title=\"Page 1217\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Atresia of the right and left hepatic duct</p>\n</div>\n</div>\n</div>\n</div>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Children with biliary atresia, who do not achieve successful drainage after hepatoportoenterostomy (<strong>Kasai's procedure</strong>), require liver transplantation within the first year of life.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young boy was admitted with complaints of fever and abdominal pain for 2 days. ESR and CRP were elevated and CT Abdomen obtained was as shown in the picture. Which of the following is not a common feature in the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "Hepatomegaly"
      },
      {
        "id": 2,
        "text": "Hypoalbuminemia"
      },
      {
        "id": 3,
        "text": "Jaundice"
      },
      {
        "id": 4,
        "text": "Leukocytosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The symptoms of fever and abdominal pain and a hypodense lesion on the CT are suggestive of a Liver abscess in this patient.&nbsp;</p>\n<p>Signs and symptoms of a liver abscess include fever, chills, night sweats, malaise, nausea, hepatomegaly, as well as&nbsp;pain and tenderness in the right upper quadrant. They also show elevated inflammatory markers, hypoalbuminemia and leukocytosis. However, <strong>jaundice is uncommon</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b5b1e5f058654445ac28e5ed9783bc00.PNG"
    ],
    "explanation_images": []
  }
];
        let quizName = '21 Disorders Of The Liver';
        const quizFilename = '21-disorders-of-the-liver-a309e060.html';
        let hierarchy = ["Marrow", "qBank", "Pediatrics"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>