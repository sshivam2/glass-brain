<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26 Synthetic Opioids - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pharmacology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">26</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following opioids has maximum plasma protein binding capacity?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Sufentanil"
      },
      {
        "id": 3,
        "text": "Fentanyl"
      },
      {
        "id": 4,
        "text": "Pethidine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Sufentanil&nbsp;</strong>has maximum plasma protein binding capacity.&nbsp;</p>\n<p>More than 90% of sufentanil is bound to <strong>alpha</strong> <strong>acid</strong> <strong>glycoprotein</strong> in plasma.</p>\n<p>Plasma protein binding capacity of opioids:</p>\n<ul>\n<li>Sufentanil: 90%</li>\n<li>Fentanyl: 80-85%</li>\n<li>Pethidine (meperidine): 65-75%</li>\n<li>Morphine: 36%</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is the most potent opioid analgesic?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Sufentanil"
      },
      {
        "id": 3,
        "text": "Remifentanil"
      },
      {
        "id": 4,
        "text": "Morphine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Sufentanil</strong> is the <strong>most</strong> <strong>potent</strong>&nbsp;opioid. It is 1000 times more potent than morphine.</p>\n<p>On the other hand, fentanyl is around 100 times more potent than morphine.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following has the most rapid analgesic action?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Remifentanil"
      },
      {
        "id": 3,
        "text": "Sufentanil"
      },
      {
        "id": 4,
        "text": "Meperidine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most rapid</strong> analgesic action is achieved by <strong>remifentanil</strong>.</p>\n<p>Analgesic action (peak) is achieved <strong>within 1 to 1.5 min</strong> following intravenous administration.</p>\n<p>Analgesic action-<strong>&nbsp;duration </strong>for peak action:</p>\n<ul>\n<li>Remifentanil: 1 to 1.5 min</li>\n<li>Fentanyl: 5 min</li>\n<li>Sufentanil: 5 min</li>\n<li>Meperidine: 15 min</li>\n</ul>\n<p>The <strong>rapid onset</strong> of action and the <strong>rapid recovery</strong> (within 15 min) owing to metabolism by <strong>plasma esterases</strong> of remifentanil make it an ideal analgesic for short painful procedures.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man with liver metastasis and altered LFT is posted for a surgery. What would be the opioid of choice in him?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Alfentanil"
      },
      {
        "id": 3,
        "text": "Sufentanil"
      },
      {
        "id": 4,
        "text": "Remifentanil"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Opioid of choice in patients with compromised hepatic function is <strong>remifentanil.</strong></p>\n<p>Remifentanil is hydrolyzed by <strong>plasma </strong>and <strong>tissue esterases</strong> and hence its metabolism is independent of hepatic function.</p>\n<p>Other opioids like fentanyl, alfentanil, and sufentanil are metabolized by the liver.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 48-year-old woman with CKD is scheduled for a surgery. Her serum creatinine is 2.4mg/dL and eGFR is 13. Which of the following opioids can be safely used in her?",
    "choices": [
      {
        "id": 1,
        "text": "Pethidine"
      },
      {
        "id": 2,
        "text": "Remifentanil"
      },
      {
        "id": 3,
        "text": "Alfentanil"
      },
      {
        "id": 4,
        "text": "Morphine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given lab values in a CKD patient are suggestive of renal failure and<strong> remifentanil</strong> can be safely used in renal failure patients.</p>\n<p>Remifentanil is hydrolyzed by <strong>plasma</strong> and <strong>tissue esterases</strong>. The pharmacokinetics and the pharmacodynamics of remifentanil are not altered by renal dysfunction.</p>\n<p>Option A: Pethidine is metabolized to norpethidine, accumulation of which can lead to CNS excitatory effects (<strong>seizures</strong>).</p>\n<p>Option C: High levels of alfentanil can lead to prolonged action.</p>\n<p>Option D: Morphine is metabolized to&nbsp;morphine-6-glucuronide which can accumulate leading to <strong>respiratory depression.</strong></p>\n<p><strong>Note:</strong>&nbsp;Fentanyl clearance is not altered by renal failure but its plasma protein binding is decreased which can alter the concentration of the free drug. Hence, fentanyl is the second drug of choice after remifentanil.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who underwent an intra-abdominal surgery is about to receive intraspinal opioid injection for analgesia. Which of the following drugs should not be used for this purpose?",
    "choices": [
      {
        "id": 1,
        "text": "Sufentanyl"
      },
      {
        "id": 2,
        "text": "Alfentanyl"
      },
      {
        "id": 3,
        "text": "Fentanyl"
      },
      {
        "id": 4,
        "text": "Remifentanil"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Remifentanil</strong> should not be used&nbsp;for intraspinal injection.</p>\n<p>Remifentanil&nbsp;is formulated in combination with<strong> glycine.&nbsp;</strong>Glycine acts as an <strong>inhibitory</strong> neurotransmitter in the spinal dorsal horn that causes a reversible <strong>motor weakness</strong> when it is injected intrathecally.</p>\n<p>For this reason, remifentanil is <strong>not approved </strong>for <strong>spinal </strong>or <strong>epidural </strong>use.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the shortest acting opioid?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Remifentanil"
      },
      {
        "id": 3,
        "text": "Alfentanil"
      },
      {
        "id": 4,
        "text": "Sufentanil"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The shortest acting opioid is&nbsp;<strong>remifentanil</strong> with t<sub>1/2</sub>&nbsp;of 8-20 minutes.</p>\n<p>The rapid metabolism by&nbsp;<strong>tissue esterases</strong> and rapid clearance results in its ultra short-acting nature.</p>\n<p>Remifentanil has the <strong>fastest onset</strong> of action and <strong>recovery</strong>, making it the opioid of choice in <strong>daycare surgery.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is not included in neuroleptic anesthesia?",
    "choices": [
      {
        "id": 1,
        "text": "Nitrous oxide"
      },
      {
        "id": 2,
        "text": "Propofol"
      },
      {
        "id": 3,
        "text": "Droperidol"
      },
      {
        "id": 4,
        "text": "Fentanyl"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Propofol </strong>is <strong>not</strong> included in neuroleptic anesthesia.</p>\n<p>Neuroleptic <strong>anesthesia </strong>includes<strong>&nbsp;fentanyl</strong>, <strong>droperidol</strong>,&nbsp;and<strong>&nbsp;nitrous oxide.</strong></p>\n<p>Neuroleptic <strong>analgesia </strong>includes<strong>&nbsp;fentanyl&nbsp;</strong>and<strong>&nbsp;droperidol.</strong></p>\n<p>Neuroleptic anesthesia is characterized by analgesia, the&nbsp;absence of clinically apparent motor activity, suppression of autonomic reflexes, maintenance of cardiovascular stability, and amnesia.</p>\n<p><strong>QT</strong> interval <strong>prolongation</strong> and <strong>torsades</strong> <strong>de pointes</strong> due to droperidol have made this technique <strong>obsolete</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are planning to use a transdermal patch for one of your patients who require around-the-clock opioids for his cancer pain.  Which of the following drugs will you prescribe?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Remifentanyl"
      },
      {
        "id": 3,
        "text": "Sufentanyl"
      },
      {
        "id": 4,
        "text": "Alfentanyl"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Fentanyl is available as a <strong>transdermal patch </strong>and can be prescribed to this patient. It is mainly used for chronic pain.</p>\n<p>Various routes of administration of fentanyl are: intravenous, epidural, spinal, transdermal&nbsp;therapeutic system (transdermal patch and transdermal iontophoresis), oral (buccal tablets, films, lozenges).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the drug of choice for rescue analgesia?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Codeine"
      },
      {
        "id": 3,
        "text": "Oxycodone"
      },
      {
        "id": 4,
        "text": "Fentanyl"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Fentanyl</strong> is the drug of choice for providing <strong>rescue</strong> <strong>analgesia</strong>.</p>\n<p>Rescue analgesia involves the use of medications to minimize post-operative pain. Mild pain can be controlled with oral analgesics but severe pain requires opioids like fentanyl.</p>\n<p>Fentanyl is preferred over morphine or oxycodone due to its rapid onset of action, lesser incidence of postoperative nausea, vomiting, and other adverse effects.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old man was posted for bronchoscopy under procedural sedation. After the administration of anesthetic drugs, he developed chest wall rigidity and ineffective spontaneous ventilation. Attempts at manual ventilation were unsuccessful due to the non-compliant chest wall. The opioid that is most commonly associated with this condition is?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Fentanyl"
      },
      {
        "id": 3,
        "text": "Pethidine"
      },
      {
        "id": 4,
        "text": "Tramadol"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Chest wall rigidity and ineffective ventilation is a classic presentation of '<strong>wooden chest syndrome</strong>'. This opioid-induced muscle rigidity is most commonly associated with the use of lipophilic opioids such as&nbsp;<strong>fentanyl</strong> and its congeners (alfentanil, sufentanil, and remifentanil).</p>\n<p>Risk factors for wooden chest syndrome:</p>\n<ul>\n<li>Rapid administration of a large dose of fentanyl</li>\n<li>Concomitant&nbsp;use of nitrous oxide</li>\n<li>Old age</li>\n</ul>\n<p>The clinical presentation can vary from mild hoarseness to chest wall rigidity severe enough to prevent adequate bag-and-mask ventilation.</p>\n<p>Management of wooden chest syndrome:</p>\n<ul>\n<li>Discontinuation of the opioid</li>\n<li>Replacement of the opioid with a non-lipophilic version (such as hydromorphone or morphine) for analgesia</li>\n<li>Consider <strong>naloxone</strong> for reversal (you do not want to reverse analgesia on an intubated patient unless absolutely necessary)</li>\n<li>Addition of a <strong>non-depolarizing neuromuscular blocker</strong> for paralysis</li>\n<li>Supportive ventilatory care</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Upon recovering from anesthesia, a patient started feeling cold accompanied by shivering. Which is the opioid indicated to treat this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Meperidine"
      },
      {
        "id": 3,
        "text": "Methylmorphine"
      },
      {
        "id": 4,
        "text": "Methadone"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Meperidine</strong> is commonly indicated for <strong>post</strong>-<strong>anesthetic</strong> <strong>shivering</strong>.</p>\n<p>It prevents post-anesthetic shivering by <strong>lowering</strong> the <strong>temperature</strong> <strong>threshold</strong> at which shivering is triggered by the hypothalamus.</p>\n<p>A single dose of 12.5 to 35mg meperidine (pethidine) is effective in the treatment of postanesthetic shivering.&nbsp;</p>\n<p>Infusion-related chills and rigors associated with amphotericin B, aldesleukin, trastuzumab, and alemtuzumab are also managed with meperidine in combination with other agents.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old housewife with diabetic nephropathy and receiving dialysis weekly comes to your clinic with an accidental burn on her left hand. On examination, 2nd-degree burns are seen. Which of the following opioids should not be prescribed to her for analgesia?",
    "choices": [
      {
        "id": 1,
        "text": "Pethidine"
      },
      {
        "id": 2,
        "text": "Methadone"
      },
      {
        "id": 3,
        "text": "Fentanyl"
      },
      {
        "id": 4,
        "text": "Alfentanil"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Pethidine</strong> (meperidine) should not be prescribed to her as it is contraindicated in patients with&nbsp;<strong>renal</strong> <strong>failure</strong>.</p>\n<p>In renal failure, there is an&nbsp;<strong>accumulation</strong> of its metabolite <strong>norpethidine</strong> which causes <strong>excitatory syndrome</strong> consisting of hallucinations, tremors, muscle twitches, and convulsions.&nbsp;Therefore, pethidine is avoided in renal failure patients.</p>\n<p>Methadone, alfentanil, and fentanyl primarily undergo <strong>hepatic metabolism.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman was administered an intravenous opioid for managing postoperative pain. Within 5 minutes, she started developing severe redness and pruritus along the distribution of the vein into which the drug was injected. Which of the following drugs would be responsible for this?",
    "choices": [
      {
        "id": 1,
        "text": "Meperidine"
      },
      {
        "id": 2,
        "text": "Alfentanil"
      },
      {
        "id": 3,
        "text": "Remifentanil"
      },
      {
        "id": 4,
        "text": "Fentanyl"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical findings are suggestive of <strong>histamine release</strong>, which is <strong>common </strong>with the use of <strong>meperidine</strong> (pethidine) due to <strong>mast cell activation</strong>.&nbsp;</p>\n<p><strong>Codeine, morphine,</strong> and <strong>hydromorphone</strong> are also associated with histamine release.</p>\n<p>Fentanyl, alfentanil, and remifentanil <strong>do not</strong> lead to histamine release.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 16-year-old boy received an intravenous opioid for analgesia. A few minutes later, his heart rate decreased from 72/min to 58/min. Which among the following drugs is least likely to be associated with this finding?",
    "choices": [
      {
        "id": 1,
        "text": "Fentanyl"
      },
      {
        "id": 2,
        "text": "Sufentanyl"
      },
      {
        "id": 3,
        "text": "Alfentanyl"
      },
      {
        "id": 4,
        "text": "Meperidine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Meperidine (pethidine) is least likely to be associated with bradycardia.</p>\n<p>Intravenous <strong>meperidine</strong> <strong>produces tachycardia</strong>&nbsp;as it has a structure similar to <strong>atropine.</strong>&nbsp;Unlike other opioids, meperidine causes <strong>mydriasis</strong> due to its anticholinergic effect.</p>\n<p><strong>Pentazocine,</strong> which is<strong>&nbsp;</strong>an opioid agonist-antagonist, also produces tachycardia, hypertension, and mydriasis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following opioids has local anesthetic property?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Methadone"
      },
      {
        "id": 3,
        "text": "Pethidine"
      },
      {
        "id": 4,
        "text": "Codeine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The opioid with local anesthetic property is <strong>pethidine (meperidine),</strong>&nbsp;which is especially seen after <strong>intrathecal</strong> administration.</p>\n<p>Intrathecal pethidine can provide spinal anesthesia for endoscopic urological procedures and surgery of the lower limb, perineum, and lower abdomen including cesarean section.</p>\n<p>However, due to <strong>low potency</strong> and systemic <strong>opioid side effects</strong>, it is usually not used for this purpose.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Apart from mu-opioid receptors, on which other receptor does tramadol act?",
    "choices": [
      {
        "id": 1,
        "text": "Anticholinergic"
      },
      {
        "id": 2,
        "text": "5HT1a inhibition"
      },
      {
        "id": 3,
        "text": "Serotonergic and norepinephrine reuptake inhibition"
      },
      {
        "id": 4,
        "text": "Antihistaminic"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Tramadol <strong>inhibits</strong> the <strong>reuptake</strong> of <strong>serotonin</strong> and <strong>norepinephrine</strong>, apart from its action on the mu-opioid receptor.</p>\n<p>It is a <strong>synthetic</strong> codeine analog that is a<strong> mu-</strong>opioid receptor <strong>agonist</strong>.</p>\n<p>Tramadol is a<strong>&nbsp;centrally </strong>acting <strong>analgesic&nbsp;</strong>used in the treatment of <strong>mild </strong>to <strong>moderate </strong>pain<strong>.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding tramadol?",
    "choices": [
      {
        "id": 1,
        "text": "Safe in epileptics"
      },
      {
        "id": 2,
        "text": "Less potent than morphine"
      },
      {
        "id": 3,
        "text": "Less respiratory depression"
      },
      {
        "id": 4,
        "text": "Synthetic analogue of codeine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Tramadol is <strong>contraindicated</strong> <strong>in epileptics</strong>.</p>\n<p>Tramadol is <strong>epileptogenic </strong>and can cause seizures in predisposed individuals and in those taking medications like monoamine oxidase inhibitors and neuroleptic drugs.</p>\n<p>It is a <strong>synthetic analogue</strong> of <strong>codeine</strong>&nbsp;and a weak opioid&nbsp;agonist with&nbsp;1/6000 affinity for&nbsp;&micro; receptors as that of morphine.</p>\n<p>Apart from opioid&nbsp;action, it also inhibits the&nbsp;<strong>reuptake of 5HT and NE.</strong> Due to&nbsp;non-opioid receptor-mediated actions, it produces <strong>less respiratory depression</strong> and less constipation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 24-year-old woman requires an intranasal opioid spray for her migraine. Which of the following would you prescribe her?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Buprenorphine"
      },
      {
        "id": 3,
        "text": "Butorphanol"
      },
      {
        "id": 4,
        "text": "Methadone"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Butorphanol</strong> is a synthetic opioid available as a <strong>nasal</strong> <strong>spray</strong> for use in <strong>migraine</strong> headaches and painful conditions.</p>\n<p>It is used parenterally as an analgesic for moderate to severe pain or as an adjunct to general anesthesia.</p>\n<p>Opioids available for <strong>intranasal </strong>administration are<strong> butorphanol</strong> and <strong>fentanyl.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old man, on treatment with fluoxetine for depression, was started on an opioid for severe neuropathic pain. A few days later he had an episode of syncope and was brought to the casualty.  ECG taken is given below, with QTc = 477 ms. Which of the following drugs is most likely the cause?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Meperidine"
      },
      {
        "id": 3,
        "text": "Methadone"
      },
      {
        "id": 4,
        "text": "Propoxyphene"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given ECG findings show&nbsp;<strong>QT</strong> <strong>prolongation</strong>&nbsp;which is associated primarily with the use of <strong>methadone</strong>.</p>\n<p>In the ECG&nbsp;<strong>QTc</strong>(corrected QT interval= QT/&radic;RR) is&nbsp;<strong>477ms</strong>.&nbsp;Normal QTc is about 440ms. Values of<strong>&nbsp;more than</strong>&nbsp;<strong>440ms </strong>in <strong>males</strong>&nbsp;and&nbsp;<strong>460ms </strong>in <strong>females</strong>&nbsp;are considered to be <strong>prolonged</strong>. QT prolongation can&nbsp;present as <strong>syncope</strong>&nbsp;or cardiac arrest.</p>\n<p>Methadone has <strong>additive</strong> action with agents known to cause QT prolongation. Serious cardiac arrhythmias including <strong>torsades</strong> <strong>de</strong> <strong>pointes</strong> have been noted with methadone use.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/20ff55bf95d84c80806011b3296ed557.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding methadone?",
    "choices": [
      {
        "id": 1,
        "text": "Long acting mu receptor agonist"
      },
      {
        "id": 2,
        "text": "Used for chronic pain relief"
      },
      {
        "id": 3,
        "text": "Rapidly absorbed from GIT and appears in plasma within 30 min of oral administration"
      },
      {
        "id": 4,
        "text": "Onset of analgesia is 30-60 min after parenteral and 1-2 h after oral administration"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Methadone&rsquo;s <strong>onset</strong> of analgesia is <strong>10-20 minutes</strong> <strong>after</strong> the <strong>parenteral</strong> <strong>route</strong>, and <strong>30-60 minutes</strong> <strong>after</strong> the <strong>oral</strong> <strong>route</strong> of administration.</p>\n<p>Option A: Methadone is a long-acting mu receptor agonist with a plasma half-life of 15-40 hours.</p>\n<p>Option B: It is an analgesic and used for chronic pain relief.</p>\n<p>Option C: Absorption from GIT is rapid and appears in plasma within 30 minutes and reaches peak concentrations at around 4 hours.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young man is scheduled for laparoscopic cholecystectomy. His medical history is significant for depression and he is on monoamine oxidase inhibitors for the same. Which of the following opioids can be safely administered to him?",
    "choices": [
      {
        "id": 1,
        "text": "Tramadol"
      },
      {
        "id": 2,
        "text": "Meperidine"
      },
      {
        "id": 3,
        "text": "Dextromethorphan"
      },
      {
        "id": 4,
        "text": "Morphine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Morphine</strong>&nbsp;can be safely administered as it does not inhibit the neuronal reuptake of serotonin and hence <strong>does not trigger serotonin syndrome</strong> in patients on MAO inhibitors.</p>\n<div class=\"page\" title=\"Page 1054\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Phenylpiperidine series of opioids such as<strong>&nbsp;meperidine, tramadol, dextromethorphan,</strong> and<strong>&nbsp;methadone inhibit</strong>&nbsp;the neuronal <strong>reuptake of serotonin</strong> leading to serotonergic overactivity. This can cause <strong>serotonin syndrome</strong> in patients receiving monoamine oxidase inhibitors.</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman sustained multiple fractures in a motorcycle accident. Her physician prescribed an oral opioid for analgesia which is a partial agonist at mu and a full agonist at kappa receptors. Identify the drug given.",
    "choices": [
      {
        "id": 1,
        "text": "Pentazocine"
      },
      {
        "id": 2,
        "text": "Buprenorphine"
      },
      {
        "id": 3,
        "text": "Tramadol"
      },
      {
        "id": 4,
        "text": "Fentanyl"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Pentazocine</strong> is a <strong>partial</strong> <strong>agonist</strong> at <strong>mu</strong> and a <strong>full</strong> <strong>agonist</strong> at <strong>kappa</strong> receptors.</p>\n<p><strong>Analgesia</strong> produced by pentazocine is predominantly mediated by the\u00a0<strong>\u03ba</strong> receptor.</p>\n<p>Pentazocine is a <strong>mixed agonist-antagonist</strong> opioid agent. It is a <strong>full agonist</strong> at the <strong>\u03ba</strong> receptor and a partial agonist or weak antagonist at the \u00b5 receptor.</p>\n<p><strong>Buprenorphine</strong> is a partial agonist at mu receptors but an\u00a0antagonist at kappa receptors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A cancer patient is dependent on morphine for pain management. His physician decides to switch him to buprenorphine. Due to which property he chooses this new drug?",
    "choices": [
      {
        "id": 1,
        "text": "Partial agonism at mu receptor"
      },
      {
        "id": 2,
        "text": "Partial agonism at kappa receptor"
      },
      {
        "id": 3,
        "text": "Partial antagonism at mu receptor"
      },
      {
        "id": 4,
        "text": "Partial antagonism at kappa receptor"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Buprenorphine is a&nbsp;<strong>partial agonist</strong> at the&nbsp;<strong>mu</strong> receptor with a lower intrinsic activity compared to morphine and hence does not produce withdrawal symptoms in patients with morphine dependence.</p>\n<p>Buprenorphine is a <strong>synthetic</strong> thebaine congener and also acts as an <strong>antagonist</strong> at&nbsp;<strong>kappa</strong> receptor.&nbsp;</p>\n<p>It is more potent than morphine at mu receptor but with <strong>lower intrinsic activity</strong> and ceiling effect. Due to lower intrinsic activity, it has <strong>no</strong> <strong>withdrawal</strong> symptoms and can be used <span class=\"fontstyle0\">in the treatment of <strong>morphine</strong> <strong>dependence</strong>.</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly man with bone metastasis is receiving intravenous opioids for pain management. Which of the following drugs can be safely administered to him without a risk of developing respiratory depression?",
    "choices": [
      {
        "id": 1,
        "text": "Morphine"
      },
      {
        "id": 2,
        "text": "Buprenorphine"
      },
      {
        "id": 3,
        "text": "Fentanyl"
      },
      {
        "id": 4,
        "text": "Alfentanyl"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Buprenorphine </strong>can be safely administered to this patient because of its&nbsp;<strong>ceiling effect</strong> on respiratory depression.</p>\n<p><strong>C</strong><strong>eiling effect&nbsp;</strong>is defined as no further increase in the effect of the drug with a further increment in dose, once the ceiling level is reached.</p>\n<p>Opioid <strong>agonist-antagonist</strong> compounds produce respiratory depression (and analgesia) with a ceiling effect which means increasing the dose further does not produce any further respiratory depression and may actually result in increased ventilation (due to the predominance of antagonist actions).</p>\n<p>Other drugs that show the ceiling effect are:</p>\n<ul>\n<li><strong>Butorphanol</strong></li>\n<li><strong>Nalbuphine</strong></li>\n<li><strong>Pentazocine.</strong></li>\n</ul>\n<p>Respiratory depression with morphine, fentanyl &amp; alfentanyl does&nbsp;<strong>not</strong>&nbsp;have a ceiling effect because they are pure opioid agonists. As the dose increases, respiratory depression also increases progressing to respiratory arrest.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6a7fd0f1f0f942db96ce078817067e02x1280x1195.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is false?",
    "choices": [
      {
        "id": 1,
        "text": "Naltrexone is an antagonist at \u00b5 receptor"
      },
      {
        "id": 2,
        "text": "Meperidine is a pure agonist at \u00b5 receptor"
      },
      {
        "id": 3,
        "text": "Nalbuphine is an agonist at k receptor"
      },
      {
        "id": 4,
        "text": "Butorphanol is an antagonist at k receptor"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Butorphanol</strong> is an <strong>agonist </strong>at <strong>&kappa; </strong>receptor. It may be a <strong>partial agonist </strong>or <strong>antagonist </strong>at <strong>&micro; </strong>receptor<strong>.</strong></p>\n<p>Pentazocine, butorphanol, buprenorphine, meptazinol, nalorphine, <strong>nalbuphine</strong>, and dezocine are mixed<strong> agonist-antagonist opioids.</strong></p>\n<p>All opioid agonist-antagonists are &micro; antagonists and k agonists, except buprenorphine, pentazocine, and dezocine.&nbsp;<strong>Buprenorphine, pentazocine,&nbsp;</strong>and <strong>dezocine </strong>are<strong> partial agonists </strong>at the <strong>&mu; </strong><strong>receptor.</strong></p>\n<p>Option A: Naltrexone is a pure antagonist at &micro;, k, and &delta; receptors.</p>\n<p>Option B: Meperidine is a pure agonist of both &mu; and &kappa; receptors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '26 Synthetic Opioids';
        const quizFilename = '26-synthetic-opioids-3bfafab7.html';
        let hierarchy = ["Marrow", "qBank", "Pharmacology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>