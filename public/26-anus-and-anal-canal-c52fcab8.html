<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26 Anus And Anal Canal - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following statements is false regarding the anatomy of the anal canal below the pectinate line?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphatic drainage is to inguinal nodes"
      },
      {
        "id": 2,
        "text": "Innervation is by the inferior rectal nerves"
      },
      {
        "id": 3,
        "text": "Venous drainage is into the systemic circulation"
      },
      {
        "id": 4,
        "text": "Tumors are more likely to be adenocarcinoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Adenocarcinoma </strong>is more likely to be seen<strong> above the pectinate line.</strong>&nbsp;Tumors <strong>below the pectinate line </strong>are more likely to be<strong> squamous cell carcinoma.<span class=\"Apple-converted-space\">&nbsp;</span></strong></p>\n<p>The pectinate line is at the junction of the<strong> upper two-thirds </strong>and the<strong> lower one-third</strong> of the<strong> anal canal</strong>. Developmentally, it represents the <strong>hindgut&ndash;proctodeum</strong> junction. The part of the anal canal <strong>above</strong> this line developed <strong>from the hindgut</strong> and&nbsp;the part <strong>below</strong> developed&nbsp;<strong>from the proctodeum.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a26a876a4f444c18993c0aaa3d78c0e2x1280x1446.JPEG"
    ]
  },
  {
    "text": "Which of the following are not true regarding external hemorrhoids?",
    "choices": [
      {
        "id": 1,
        "text": "Only 5"
      },
      {
        "id": 2,
        "text": "2, 3 & 4"
      },
      {
        "id": 3,
        "text": "3,& 5"
      },
      {
        "id": 4,
        "text": "1, 2, & 4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>External hemorrhoids are <strong>painful</strong>,<strong> self-curing</strong>\u00a0and covered by <strong>squamous</strong> epithelium.\u00a0The branches of the superior rectal vein, located at <strong>3, 7, and 11 o\u2019clock positions</strong> in the anal canal are common sites for<strong> internal hemorrhoids.\u00a0Banding </strong>is preferred for<strong> internal hemorrhoids.\u00a0</strong></p>\n<p>Hemorrhoids are <strong>cushions</strong> <strong>of submucosal tissue </strong>containing venules, arterioles, smooth muscle fibres, and elastic connective tissue. They\u00a0can be classified according to their location into <strong>2 types</strong>:</p>\n<ul>\n<li>Internal Hemorrhoids\u00a0</li>\n<li>External Hemorrhoids</li>\n</ul>\n<p>Note:\u00a0Repeated thrombosis leads to\u00a0a\u00a0semi-ripe<strong> black currant appearance </strong>of<strong> external hemorrhoids.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f96ca5c1e01b40be88229820bfc9f3adx1280x1348.JPEG"
    ]
  },
  {
    "text": "Which of the following will you not consider as a differential in a patient presenting with anorectal pain?",
    "choices": [
      {
        "id": 1,
        "text": "Anal fissure"
      },
      {
        "id": 2,
        "text": "Anal cancer"
      },
      {
        "id": 3,
        "text": "Internal hemorrhoids"
      },
      {
        "id": 4,
        "text": "Proctalgia fugax"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Internal</strong> hemorrhoids are <strong>painless</strong>.</p>\n<p><strong>Causes of anorectal pain:</strong></p>\n<ol>\n<li><strong>External hemorrhoids</strong></li>\n<li><strong>Anal fissure</strong></li>\n<li><strong>Proctalgia fugax</strong></li>\n<li>Levator ani syndrome</li>\n<li>Fistula in ano/anal abscess</li>\n<li>Inflammatory bowel disease</li>\n<li>Coccydynia</li>\n<li>Prostatitis</li>\n<li><strong>Carcinoma anus/lower rectum</strong></li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old male patient presented to the OPD with complaints of painless bleeding during defecation. On examination, a pinkish mass appears at the anal orifice when the patient is asked to strain. It reduces spontaneously when the patient relaxes. What will be the grade of this hemorrhoid?",
    "choices": [
      {
        "id": 1,
        "text": "First-degree"
      },
      {
        "id": 2,
        "text": "Second-degree"
      },
      {
        "id": 3,
        "text": "Third-degree"
      },
      {
        "id": 4,
        "text": "Fourth-degree"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Prolapse with spontaneous reduction is suggestive of <strong>second-degree hemorrhoids.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A man presented with bleeding per rectum which he noticed after passing stools for the past 2 weeks. On straining, a reddish mass as shown in the image was seen protruding out of the anal canal. It did not reduce spontaneously and had to be manually reduced. What is the grade of hemorrhoids in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Fourth degree"
      },
      {
        "id": 2,
        "text": "Second degree"
      },
      {
        "id": 3,
        "text": "Third degree"
      },
      {
        "id": 4,
        "text": "First degree"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the given scenario, as the prolapsed haemorrhoids required manual reduction, it is suggestive of<strong> third-degree&nbsp;haemorrhoids.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/91c9c201e0764b2b85398d5f5e2dd451.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "In patients with which of the following conditions can injection sclerotherapy be ideally used?",
    "choices": [
      {
        "id": 1,
        "text": "Only 3"
      },
      {
        "id": 2,
        "text": "2 & 4"
      },
      {
        "id": 3,
        "text": "1, 4, & 5"
      },
      {
        "id": 4,
        "text": "2, 3, & 5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Injection sclerotherapy</strong> is ideal for the treatment of <strong>first</strong> and <strong>second-degree</strong> hemorrhoids (bleeding or spontaneously reducing hemorrhoids).</p>\n<p><strong>1 to 3 mL</strong> of a sclerosing solution (phenol in olive oil, sodium morrhuate, or quinine urea) is injected into the <strong>submucosa of each hemorrhoid</strong>.\u00a0Complications of sclerotherapy include infection and fibrosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 48-year-old man presents to the clinic with severe anorectal pain during and after defecation. The pain was present for 6 months but has increased in severity over the past 1 day. Examination finding is shown below. A per-rectal examination could not be performed due to pain. How will you manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Analgesics and sitz bath"
      },
      {
        "id": 2,
        "text": "Evacuation under local anaesthesia"
      },
      {
        "id": 3,
        "text": "Ferguson hemorrhoidectomy"
      },
      {
        "id": 4,
        "text": "Sclerotherapy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Closed hemorrhoidectomy</strong>&nbsp;- The hemorrhoid is excised with the overlying mucosa. The hemorrhoid is dissected from the underlying sphincter and the mucus defect is then closed. This technique is associated with higher chances of recurrence. This procedure is however quick to perform and less painful. The image below describes the procedure.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d91f8b1954204a7990969273bac0a6de.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b2afeb17bbb2438aa1aab41f7898f179x1280x2559.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bb252f0b762d4733880faea873a1ff43x1280x3049.JPEG"
    ]
  },
  {
    "text": "What is the most common complication following hemorrhoidectomy?",
    "choices": [
      {
        "id": 1,
        "text": "Urinary retention"
      },
      {
        "id": 2,
        "text": "Fecal incontinence"
      },
      {
        "id": 3,
        "text": "Infection"
      },
      {
        "id": 4,
        "text": "Delayed hemorrhage"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Urinary retention</strong> is the most common complication following hemorrhoidectomy.</p>\n<p>Conventional hemorrhoidectomy(open or closed technique), is considered to be an extremely painful procedure. Dysfunction of the detrusor muscle or the trigone in response to pain or distention of the anal canal or perineum has been postulated as the cause of urinary retention post hemorrhoidectomy.&nbsp;</p>\n<p>Other complications include:</p>\n<ul>\n<li class=\"p1\">Fecal incontinence</li>\n<li class=\"p1\">Infection</li>\n<li class=\"p1\">Delayed hemorrhage</li>\n<li class=\"p1\">Stricture</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old man came with complaints of chronic constipation,  blood-streaked stools, and pain during defecation for 2 months. On examination, a sentinel tag was noted at the anal orifice. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Fistula in ano"
      },
      {
        "id": 2,
        "text": "Anal fissure"
      },
      {
        "id": 3,
        "text": "Hemorrhoids"
      },
      {
        "id": 4,
        "text": "Anal carcinoma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In the given scenario, the presence of a sentinel tag is suggestive of <strong>chronic</strong>&nbsp;<strong>anal fissure</strong>.</p>\n<p>An anal fissure is a linear or oval-shaped tear in the anal canal starting just below the dentate line extending to the anal verge. It can be acute or chronic.&nbsp;</p>\n<p>Chronic anal fissures last for more than 6-8 weeks, and are frequently associated with a <strong>triad</strong> of findings:</p>\n<ol>\n<li><strong>Sentinel tag</strong></li>\n<li>Hypertrophied <strong>anal papillae</strong> at the upper end of the fissure in the anal canal</li>\n<li>Deep canoe-shaped <strong>ulcer</strong></li>\n</ol>\n<p>Acute fissures are shallow tears in the anoderm. They are associated with:</p>\n<ol>\n<li>Anal pain</li>\n<li>Spasm</li>\n<li>Bleeding with defecation</li>\n</ol>\n<p>The below image shows features of a chronic anal fissure</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dfa156857def420485162942518bd227x1280x1479.JPEG"
    ]
  },
  {
    "text": "Which of the following is the most common location of anal fissures?",
    "choices": [
      {
        "id": 1,
        "text": "Anterior midline"
      },
      {
        "id": 2,
        "text": "Posterior midline"
      },
      {
        "id": 3,
        "text": "Right lateral"
      },
      {
        "id": 4,
        "text": "Left lateral"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Over <strong>90% </strong>of fissures are located in the<strong> posterior midline</strong>, with the rest being located in the anterior midline of the anal canal.&nbsp;</p>\n<p>The main hypothesis is that the posterior midline area may have decreased blood flow due to the configuration of the blood vessels of the anus.&nbsp;Also, the spasm of the internal anal sphincter may cause further reduction of the blood flow to the posterior anal canal.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the procedure of choice in a patient with chronic anal fissure?",
    "choices": [
      {
        "id": 1,
        "text": "Milligan-Morgan procedure"
      },
      {
        "id": 2,
        "text": "Lateral internal sphincterotomy"
      },
      {
        "id": 3,
        "text": "Transanal resection"
      },
      {
        "id": 4,
        "text": "Altemeier's procedure"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Lateral internal sphincterotomy</strong> is the procedure of choice for chronic anal fissures.</p>\n<p><strong>Surgical therapy</strong> has traditionally been recommended for <strong>chronic anal fissures</strong> that have failed medical therapy.&nbsp;The aim of this procedure is to decrease the spasms of the internal sphincter by dividing a portion of the muscle.&nbsp;Approximately 30% of the muscle sphincter fibers are divided laterally using an open or closed technique.</p>\n<p>The <strong>initial treatment</strong> of anal fissures includes:</p>\n<ol>\n<li>Frequent sitz baths</li>\n<li>Analgesics</li>\n<li>Stool softeners</li>\n<li>High-fiber diet</li>\n</ol>\n<p>If conservative management with dietary changes and laxatives fail, other options including <strong>topical analgesics</strong> such as 2% lidocaine jelly, topical nifedipine, topical nitroglycerin, or a combination of topical nifedipine and lidocaine can be attempted.</p>\n<p>Option A: <strong>Miligan-Morgan</strong> procedure is an open hemorrhoidectomy</p>\n<p>Option C: <strong>Transanal resection</strong> is&nbsp;used to remove early-stage rectal cancers in the lower rectum</p>\n<p>Option D: <strong>Altermeier's procedure</strong> is used for rectal prolapse</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which type of anal fistula is seen in this image?",
    "choices": [
      {
        "id": 1,
        "text": "Intersphincteric"
      },
      {
        "id": 2,
        "text": "Trans-sphincteric"
      },
      {
        "id": 3,
        "text": "Supra-sphincteric"
      },
      {
        "id": 4,
        "text": "Extra-sphincteric"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the given image, the fistula traverses the internal sphincter and tracks down the space between the internal and external anal sphincters. Hence, it is an&nbsp;<strong>inter-sphincteric </strong>type of <strong>anal fistula</strong>. It&nbsp;is the <strong>most common</strong>&nbsp;anal fistula.</p>\n<p>A <strong>fistula-in-ano</strong> is an epithelial-lined tract connecting the anal canal to the perianal skin.&nbsp;Patients usually complain&nbsp;of intermittent purulent discharge and pain. Anal fistulas can be simplex or complex fistulas.</p>\n<ol>\n<li><strong>Simple fistulas</strong>-&nbsp;include a single tract, subcutaneous tract, and those that involve less than 30% of the external sphincter. They are easier to treat, and have lower chances of recurrence.&nbsp;</li>\n<li><strong>Complex fistulas</strong>-&nbsp;include fistulas involving more than 30% of the external sphincter, with multiple tracts, recurrent fistulas, and those associated with other predisposing factors, such as Crohn disease and radiation treatment.</li>\n</ol>\n<p>Fistulas can also be classified into<strong> high or low-lying fistulas</strong>, based on their location with respect to the<strong> puborectalis</strong> muscle.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/21c6fe5c49b14eaba13842776e167b3b.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2f336c43047b407aa79d37f70cd109c8x1280x1456.JPEG"
    ]
  },
  {
    "text": "A 40-year-old male patient presents to the clinic with a history of discharge from the perianal region for the past 1 week. On examination, an external opening was seen at 2 o'clock position around the anal orifice. On per rectal examination, an opening was palpable at 3 o'clock position at the dentate line. What is the gold standard investigation for assessing this patient?",
    "choices": [
      {
        "id": 1,
        "text": "CT"
      },
      {
        "id": 2,
        "text": "MRI"
      },
      {
        "id": 3,
        "text": "Endoanal USG"
      },
      {
        "id": 4,
        "text": "X-ray fistulogram"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given scenario is suggestive of<strong>&nbsp;</strong>an<strong> anal fistula. </strong>Magnetic resonance imaging <strong>(MRI)</strong> is the gold standard investigation for fistula imaging. It&nbsp;helps to identify the secondary extensions of the track, which when missed may cause persistence of the fistula.</p>\n<p>Investigations available for fistula-in-ano are:</p>\n<ul>\n<li>Fistulogram</li>\n<li>Endoanal ultrasound</li>\n<li><strong>MRI</strong></li>\n<li>Computed tomography (CT) scan</li>\n<li>Endocoil MRI</li>\n<li>Hydrogen peroxide&ndash;enhanced 3-D endoanal ultrasonography</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented with serous discharge from an opening located in the perianal region. On examination, the location of the external opening was at 8\u2019O clock position. According to Goodsall's rule at what position from the dentate line will the internal opening be palpated in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "8'O clock"
      },
      {
        "id": 2,
        "text": "4'O clock"
      },
      {
        "id": 3,
        "text": "1'O clock"
      },
      {
        "id": 4,
        "text": "6'O clock"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given case scenario is suggestive of<strong> fistula-in-ano</strong> with external opening at 8&rsquo;O clock position which implies that the external opening of the fistula is lying posterior to the midline.&nbsp;According to the <strong>Goodsall rule</strong>, fistulas with an external opening posteriorly track in a curvilinear fashion to the posterior midline. Hence, the fistulous tract opens internally at a <strong>6&rsquo;O clock</strong> position.</p>\n<p>A fistula-in-ano is an abnormal&nbsp;hollow tract or cavity that is lined with granulation tissue and that connects a primary opening inside the anal canal to a secondary opening in the perianal skin.</p>\n<p><strong>Goodsall&rsquo;s rule:</strong></p>\n<ul>\n<li>Fistulas with an external opening <strong>anteriorly</strong> connect to the internal opening by a short, <strong>radial tract</strong>.</li>\n<li>Fistulas with an external opening <strong>posteriorly</strong> track in a <strong>curvilinear fashio</strong>n to the posterior midline.</li>\n</ul>\n<p>However, <strong>exceptions</strong> to this rule often occur. Fistulas with an <strong>anterior</strong> external opening <strong>greater than 3 cm</strong> from the anal margin usually track to the <strong>posterior midline</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fe4ca95939104307a4b92d21dcacde75x1280x1602.JPEG"
    ]
  },
  {
    "text": "A known case of Crohn's disease presented to the clinic with a history of discharge from the anal region for the past 2 weeks. The patient underwent drainage of an ischiorectal abscess 2 months back. Clinical examination and imaging reveal the presence of a supra-sphincteric perianal fistula. How will you manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Seton's technique"
      },
      {
        "id": 2,
        "text": "Fistulotomy"
      },
      {
        "id": 3,
        "text": "Lateral internal sphincterotomy"
      },
      {
        "id": 4,
        "text": "Simple fistulectomy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option B: <strong>Fistulotomy</strong> involves&nbsp;opening the fistula tract and possibly dividing the sphincter muscle. It is very effective for simple fistulas with minimal sphincter involvement.&nbsp;</p>\n<p>Option C: <strong>Lateral internal sphincterotomy</strong> is a technique used for chronic anal fissures.</p>\n<p>Option D: In <strong>fistulectomy</strong>, the fistulous tract is cut out completely.</p>\n<p>Other surgeries for fistula in-ano include:</p>\n<ol>\n<li><strong>Endorectal advancement flap</strong>-&nbsp;involves closure of the internal opening of the tract, debridement of the tract, and mobilization of anorectal mucosa to cover the defect. It is usually done for complex fistulas.&nbsp;</li>\n<li><strong>LIFT</strong>- Ligation of the intersphincteric fistula tract&nbsp;involves identification of the internal opening with suture ligation of the intersphincteric portion of the fistula. The tract and infected gland are then excised and the wound is debrided with curettage. It can be done for both simple and complex fistulas.</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/367fb8f439874726aa6deeb73c09e476x1280x1469.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f3b183347fe3455e9e3d1fb1a6ba16bax720x720.GIF"
    ]
  },
  {
    "text": "Which of the following is the most common cause of anorectal suppuration?",
    "choices": [
      {
        "id": 1,
        "text": "Cryptoglandular infection"
      },
      {
        "id": 2,
        "text": "Crohn\u2019s disease"
      },
      {
        "id": 3,
        "text": "Tuberculosis"
      },
      {
        "id": 4,
        "text": "Malignancy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common cause of anorectal suppuration is <strong>nonspecific cryptoglandular infection.</strong></p>\n<p><strong>Anorectal abscess</strong>&nbsp;originates from an infection arising in the cryptoglandular epithelium lining the anal canal.&nbsp;The increased incidence of ischio-rectal fossa infection is due to <strong>p</strong><strong>oor blood supply</strong>.</p>\n<p>It&nbsp;may also be caused by other reasons such as:&nbsp;</p>\n<ol>\n<li>Crohn's disease</li>\n<li>Trauma</li>\n<li>Immunodeficiency resulting from human immunodeficiency virus (HIV) infection or malignancy (both hematologic and anorectal cancer)</li>\n<li>Tuberculosis</li>\n<li>Hidradenitis suppurativa</li>\n</ol>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most common type of anorectal abscess?",
    "choices": [
      {
        "id": 1,
        "text": "Sub-mucous"
      },
      {
        "id": 2,
        "text": "Pelvirectal"
      },
      {
        "id": 3,
        "text": "Perianal"
      },
      {
        "id": 4,
        "text": "Ischiorectal"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A <strong>perianal abscess </strong>is the most common&nbsp;type of anorectal abscess.<strong>&nbsp;</strong></p>\n<p><strong>Anorectal abscess&nbsp;</strong>refers to a collection of pus in the anal or rectal region.&nbsp;More commonly seen in <strong>men.&nbsp;</strong>There are <strong>four types</strong> of anorectal abscesses:</p>\n<ol>\n<li><strong>Peri-anal</strong> (most common)</li>\n<li>Ischio-rectal&nbsp;</li>\n<li>Inter-sphincteric</li>\n<li>Supra-levator</li>\n</ol>\n<p><strong>Treatment</strong>: Drainage of pus + Antibiotics</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/239a28a63ad743d2a5eb0582895d31f8x1280x1359.JPEG"
    ]
  },
  {
    "text": "A jeep driver presented with a swelling in the natal cleft, with pain, difficulty in sitting, and occasional purulent discharge from the area. Examination finding is shown below. Which of the following is not true regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Recurrence is common"
      },
      {
        "id": 2,
        "text": "Hair follicles are seen in the wall of sinus"
      },
      {
        "id": 3,
        "text": "Hirsute habitus is a risk factor"
      },
      {
        "id": 4,
        "text": "Commonly seen between the ages of 15 and 40 years"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given condition is a <strong>pilonidal sinus</strong>. Hair follicles have almost <strong>never </strong>been demonstrated in the walls of the sinus. The hair projecting from the sinus is dead hair, with its pointed ends directed towards the blind end of the sinus.</p>\n<p>Pilonidal sinus disease is a disease of the inter-gluteal region, characterized by the formation of a <strong>sinus&nbsp;in the cleft of the buttocks</strong>. It&nbsp;is more common in<strong> males </strong>between<strong> 15-40 years </strong>of age.</p>\n<p>Risk factors include:</p>\n<ol>\n<li><strong>Male</strong> sex</li>\n<li>Family history</li>\n<li>Being overweight or <strong>obese</strong></li>\n<li>Trauma or irritation to the perianal region</li>\n<li>Occupations involving sitting for long periods- <strong>jeep/lorry drivers</strong></li>\n<li><strong>Hirsute habitus&nbsp;</strong>- thick body hair</li>\n<li>Poor hygiene</li>\n</ol>\n<p>Sites involved<strong>:</strong></p>\n<ol>\n<li><strong>Natal cleft</strong> (most commonly)</li>\n<li>Interdigital cleft</li>\n<li>Face</li>\n<li>Axilla</li>\n</ol>\n<p>Buttock <strong>friction</strong> and <strong>shearing forces</strong> in these areas allow broken hairs&nbsp;to&nbsp;enter the skin and&nbsp;create a <strong>subcutaneous, chronically infected</strong> midline track. An infected hair follicle can also form such a track. Secondary tracks can arise as openings, lined with granulation tissue and discharge.</p>\n<p>Clinical features:</p>\n<ul>\n<li>Intermittent <strong>pain, swelling</strong>, and <strong>discharge</strong> at the base of the spine</li>\n<li><strong>Abscess - </strong>due to a&nbsp;foreign-body-type reaction&nbsp;</li>\n</ul>\n<p>Treatment</p>\n<ul>\n<li>Conservative treatment: Strict hygiene and regular shaving of hair in the area.</li>\n<li>Abscess:\n<ul>\n<li>Rest, baths, local antiseptic dressings, and broad-spectrum antibiotics.</li>\n<li>If refractory to the above treatment- drainage with thorough curettage of granulation tissue and hair.</li>\n</ul>\n</li>\n<li>Surgical techniques:&nbsp;<strong>Bascom&rsquo;s</strong>, Karydaki's procedures are for chronic pilonidal disease.</li>\n</ul>\n<p><strong>Recurrence </strong>is common even after adequate excision of the tract.</p>",
    "explanation_video": "",
    "question_images": [
      "https://upload.wikimedia.org/wikipedia/commons/1/1a/SinusPilonidalis.jpg"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not used in the treatment of pilonidal sinus diseases?",
    "choices": [
      {
        "id": 1,
        "text": "Only 5"
      },
      {
        "id": 2,
        "text": "1 & 4"
      },
      {
        "id": 3,
        "text": "2,3 & 5"
      },
      {
        "id": 4,
        "text": "1, 2 & 4"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Surgical approaches <strong>parallel to the natal cleft</strong>, and not along the natal cleft are preferred, to reduce chances of recurrence.&nbsp;</p>\n<p>Pilonidal sinus disease treatment includes non-surgical and surgical approaches. The <strong>non-surgical approach</strong> includes conservative treatment with proper hygiene and regular shaving of hair in the area.&nbsp;</p>\n<p>In case of an<strong> abscess-&nbsp;</strong>adequate rest, baths, local antiseptic dressings, and broad-spectrum antibiotics are advised.</p>\n<p><strong>Surgical approaches for the management of pilonidal sinus disease include</strong>:</p>\n<ol>\n<li><strong>Incision and drainage</strong>- for pilonidal abscess refractory to medical treatment</li>\n<li><strong>Bascom's procedure</strong>- is a&nbsp;cleft lift procedure in which hair follicles parallel to the natal cleft are removed under local anesthesia</li>\n<li><strong>Karydakis procedure</strong>-&nbsp;an ovoid area of pathologic tissue is excised parallel to the natal cleft and a fasciocutaneous flap is mobilized to cover the defect</li>\n<li><strong>Limberg/ rhomboid flap</strong>-&nbsp;excises the pilonidal disease in a rhomboid shape and rotates a fasciocutaneous flap for wound closure</li>\n<li>Others-&nbsp;VY advancement flaps, and<strong> Z-plasty</strong></li>\n</ol>\n<p>The given image shows a<strong>&nbsp;Limberg/rhomboid flap </strong>done in pilonidal sinus surgery:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/14868fc43126417db084b8e0c9bd5e22x720x495.JPEG"
    ]
  },
  {
    "text": "An elderly female presented with severe persisting per rectal itching for the past 1 year, despite standard topical therapy. On examination, irregular eczematous lesions were seen at the anal orifice. Biopsy of the lesion revealed large vacuolated cells containing mucin. Which of the following is it likely to be?",
    "choices": [
      {
        "id": 1,
        "text": "Squamous cell carcinoma in situ"
      },
      {
        "id": 2,
        "text": "Basal cell carcinoma"
      },
      {
        "id": 3,
        "text": "Intra-epithelial adenocarcinoma"
      },
      {
        "id": 4,
        "text": "Marginal anal cell carcinoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The<strong>&nbsp;</strong>given history and presence of large vacuolated cells (Paget cells) on biopsy is suggestive of <strong>Paget's disease</strong> of the anal canal. It<strong>&nbsp;</strong>is a rare<strong> intraepithelial adenocarcinoma</strong>.&nbsp;</p>\n<p>Paget&rsquo;s disease is most commonly seen in areas with a high density of <strong>apocrine sweat glands,</strong><strong>&nbsp;in elderly females. </strong>These can develop into an invasive cancer of the underlying apocrine glands.</p>\n<p>Clinical features include <strong>intractable itching</strong>, burning, bleeding per rectally. 10% of the patients are asymptomatic. On examination,&nbsp;eczematous, well-demarcated plaque, with occasional ulceration and scaling can be seen.</p>\n<p>On histology presence of<strong>&nbsp;Paget cells</strong> (large, vacuolated cells with mucin) confirms the diagnosis.&nbsp;</p>\n<p><strong>Treatment</strong>:</p>\n<ul>\n<li>Treatment of choice- <strong>complete excision</strong></li>\n<li>Limited, noninvasive disease-<strong>wide&nbsp;local excision</strong> and closure of the defect with primary sutures or with V-Y advancement flaps</li>\n<li><strong>Invasive component-</strong>&nbsp;radical resection with abdominoperineal resection (APR)</li>\n<li>Medically unfit for surgery - topical 5-FU, imiquimod, cryotherapy, or argon beam laser therapy</li>\n<li><strong>Recurrence</strong>- re-excision (as long as the disease remains noninvasive)</li>\n</ul>\n<p>Note:<strong>&nbsp;</strong>Most common site of extra-mammary Paget&rsquo;s disease &ndash; <strong>anogenital region</strong> &gt; axilla &gt; eyelid.&nbsp;Perianal Paget&rsquo;s disease is usually associated with underlying visceral malignancy, most commonly <strong>colorectal adenocarcinoma</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is true regarding squamous cell carcinoma of the anal canal?",
    "choices": [
      {
        "id": 1,
        "text": "Proctoscopy is the investigation of choice"
      },
      {
        "id": 2,
        "text": "Commonly metastasises to spine"
      },
      {
        "id": 3,
        "text": "Most common presentation is ano-rectal pain"
      },
      {
        "id": 4,
        "text": "Most common type of anal canal carcinoma"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Squamous cell carcinoma </strong>(SCC) is the most common anal canal carcinoma.&nbsp;SCC &gt; Basal cell carcinoma &gt;Melanoma</p>\n<p>The median age at diagnosis for SCC is<strong> 60 years</strong>. Patients most commonly present with <strong>bleeding per rectum. </strong>Commonly&nbsp;metastasizes to the&nbsp;<strong>liver&nbsp;</strong>and <strong>lungs. </strong>The most&nbsp;common site of lymph node metastasis is to&nbsp;<strong>inguinal lymph nodes.&nbsp;</strong></p>\n<p><strong>Risk Factors:</strong></p>\n<ul>\n<li>Human papillomavirus (HPV) (types 16, 18, 31, 33)&nbsp;infection&nbsp;</li>\n<li>Human immunodeficiency virus (HIV) or immunosuppression</li>\n<li>Smoking</li>\n<li>Anal receptive intercourse</li>\n<li>Sexual promiscuity</li>\n<li>Anal intraepithelial neoplasia</li>\n<li>History of vulvar or cervical cancer</li>\n</ul>\n<p><strong>Diagnosis</strong><strong>: </strong></p>\n<ul>\n<li><strong>Proctoscopy </strong><strong>with biopsy-</strong>&nbsp;investigation of choice&nbsp;</li>\n<li>MRI- for local staging&nbsp;</li>\n<li>CT scan- to evaluate for distant metastasis</li>\n</ul>\n<p><strong>Treatment : </strong></p>\n<ul>\n<li><strong>Nigro regimen- </strong>chemoradiation is the <strong>treatment of choice</strong></li>\n<li>If any <strong>residual tumor</strong> is left behind after chemoradiation, <strong>abdominoperineal resection</strong> (APR) is performed</li>\n</ul>\n<table>\n<tbody>\n<tr>\n<td>\n<p><strong>8th AJCC: TNM Classification of Carcinoma of the Anal Canal and Anal Margin </strong></p>\n</td>\n</tr>\n<tr>\n<td>\n<p>Primary Tumor:</p>\n</td>\n</tr>\n<tr>\n<td>\n<ul>\n<li>Tis - high-grade squamous intraepithelial lesion</li>\n<li>T1 - 2 cm or less</li>\n<li>T2 - &gt;2 - 5 cm</li>\n<li>T3 - &gt;5 cm</li>\n<li>T4 - invades adjacent organ, e.g. vagina, urethra, bladder. (invasion of the rectal wall, perirectal skin, subcutaneous tissue, or sphincter muscle is not included as T4).</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>Regional Nodes:</td>\n</tr>\n<tr>\n<td>\n<p>Regional lymph nodes include mesorectal, inguinal (superficial, deep), superior rectal (hemorrhoidal), external iliac, and internal iliac (hypogastric) groups.</p>\n<ul>\n<li>N0 - no regional lymph node metastases</li>\n<li>N1a - inguinal, mesorectal, or internal iliac lymph nodes</li>\n<li>N1b - external iliac nodes</li>\n<li>N1c - external iliac nodes + N1a</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>\n<p>Distant Metastases:</p>\n</td>\n</tr>\n<tr>\n<td>\n<ul>\n<li>M0 - no</li>\n<li>M1 - yes</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>\n<p>Stage grouping:</p>\n</td>\n</tr>\n<tr>\n<td>\n<ul>\n<li>0 - Tis</li>\n<li>I - T1 N0</li>\n<li>IIA - T2 N0</li>\n<li>IIB - T3 N0</li>\n<li>IIIA - T1-2 N1</li>\n<li>IIIB - T4 N0</li>\n<li>IIIC - T3-4 N1</li>\n<li>IV - M1</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old man with bleeding per rectum is suspected to have squamous cell carcinoma of the anal canal. What is the treatment of choice for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Abdominoperineal resection"
      },
      {
        "id": 2,
        "text": "Nigro regimen"
      },
      {
        "id": 3,
        "text": "Wide local excision"
      },
      {
        "id": 4,
        "text": "Surgical excision with CO2 laser treatment"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Treatment of choice for squamous cell carcinoma of the anal canal is <strong>Nigro regimen/ chemoradiation.</strong></p>\n<p>A combination of <strong>5-fluorouracil (5-FU) </strong>with<strong> mitomycin C/ cisplatin</strong> is followed by <strong>external beam radiation</strong> to the <strong>pelvis</strong> with a minimum dose of <strong>45 Gy.&nbsp;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is true about melanoma of the anal canal?",
    "choices": [
      {
        "id": 1,
        "text": "Wide local excision is done for tumors with sphincter involvement"
      },
      {
        "id": 2,
        "text": "Staged by depth or thickness of melanoma lesion"
      },
      {
        "id": 3,
        "text": "More common in males"
      },
      {
        "id": 4,
        "text": "Good 5-year survival rates"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Anorectal melanoma is <strong>staged by the depth </strong>or <strong>thickness </strong>of the lesion.</p>\n<p><strong>Anal canal melanoma</strong> is more common in <strong>females. </strong>The tumor appears as&nbsp;small and polypoidal or large and ulcerating.&nbsp;Clinical features include:</p>\n<ol>\n<li>Anorectal bleeding, itching, pain, mass</li>\n<li>Tenesmus, and changes in bowel habits</li>\n<li>Mesorectal lymph node metastases</li>\n<li>Inguinal lymphadenopathy&nbsp;</li>\n<li>Distant spread- to bones, lungs, and liver</li>\n</ol>\n<p>Diagnosis is frequently made <strong>following hemorrhoidectomy </strong>or <strong>local excision </strong>of the perianal mass.</p>\n<p><strong>Treatment:</strong></p>\n<ul>\n<li>Tumors <strong>without anal sphincter</strong> involvement- <strong>wide local excision</strong> with negative margins</li>\n<li>Large tumors <strong>invading sphincters</strong>- <strong>palliative APR&nbsp;</strong></li>\n</ul>\n<p>Regardless of stage, <strong>5-year survival rates </strong>for anorectal melanoma are <strong>very poor</strong>, averaging at about <strong>6%</strong>.&nbsp;The <strong>median survival time </strong>following diagnosis is <strong>12&ndash;18 months</strong>.</p>\n<p>Note: Most common sites&nbsp;of melanoma are&nbsp;skin &gt;eye &gt; anorectal region</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '26 Anus And Anal Canal';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>