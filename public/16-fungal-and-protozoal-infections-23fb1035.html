<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16 Fungal And Protozoal Infections - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Dermatology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">29</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A patient presented with itchy depigmented scaly macules on his upper back for 5 days. KOH mount shows the following appearance. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pityriasis alba"
      },
      {
        "id": 2,
        "text": "Pityriasis versicolor"
      },
      {
        "id": 3,
        "text": "Tinea corporis"
      },
      {
        "id": 4,
        "text": "Candidiasis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario with '<strong>spaghetti</strong> and&nbsp;<strong>meatballs</strong>'&nbsp;appearance on the KOH mount is suggestive of <strong>pityriasis</strong> <strong>versicolor</strong>.&nbsp;</p>\n<p>It is a mild, chronic infection of the skin most commonly caused by the lipophilic fungus&nbsp;<strong><em>Malassezia globosa</em>. </strong>It&nbsp;may also be caused by<em> M. furfur</em> and <em>M. sympodialis</em>.</p>\n<p>The KOH mount reveals fungal <strong>hyphae</strong> that are short and thick (like spaghetti or banana) and a large number of variously sized <strong>spores</strong> (like meatballs or grapes) referred to as 'spaghetti &amp; meatballs' or 'bananas &amp; grapes'.</p>\n<p>Option A: Pityriasis alba is&nbsp;not a fungal infection, associated with eczema.</p>\n<p>Option C: In tinea corporis infection, microconidia and macroconidia are seen under a KOH mount.</p>\n<p>Option D: In candidiasis, spores and pseudohyphae of candida are seen in the KOH mount.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4473d7f35d784eaf869749de232e35c9.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old construction worker presented with a non-pruritic lesion for 4 weeks. KOH mount of the epidermal scrapings showed brown, branched, closely septate hyphae and elongated budding cells. What is the most likely causative organism?",
    "choices": [
      {
        "id": 1,
        "text": "Hortaea werneckii"
      },
      {
        "id": 2,
        "text": "Malassezia globosa"
      },
      {
        "id": 3,
        "text": "Fusarium"
      },
      {
        "id": 4,
        "text": "Piedraia hortae"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option B: <em>Malassezia globosa</em> causes tinea versicolor.</p>\n<p>Option C: Fusarium causes mycotoxicosis.</p>\n<p>Option D: <em>Piedraia hortae</em> causes black piedra.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/77dfd5ebc9bd44d391b9f3c68c4dcb43.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/51ecc10ebc774974b4974b1d38629945x512x396.PNG"
    ]
  },
  {
    "text": "A 24-year-old woman presents with the following lesions over the chest. Identify the incorrect statement about the infection.",
    "choices": [
      {
        "id": 1,
        "text": "Topical terbinafine is the first-line treatment"
      },
      {
        "id": 2,
        "text": "Besnier's sign is seen in this condition"
      },
      {
        "id": 3,
        "text": "Wood's lamp examination shows blue-green fluorescence"
      },
      {
        "id": 4,
        "text": "Recurrence is common even after complete treatment"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image shows multiple <strong>hypopigmented</strong>&nbsp;<strong>macules</strong> and <strong>patches</strong>&nbsp;with fine scales (branny/furfuraceous) suggestive of <strong>tinea</strong> <strong>versicolor</strong> (pityriasis versicolor).</p>\n<p>Hypopigmentation is due to <strong>azelaic</strong> <strong>acid</strong> produced by Malassezia species that causes competitive inhibition of tyrosinase and a direct <strong>cytotoxic</strong> effect on hyperactive <strong>melanocytes</strong>.</p>\n<p>Under Wood's lamp examination, lesions show a <strong>pale</strong> <strong>yellow</strong> <strong>fluorescence</strong>.&nbsp;&nbsp;</p>\n<p><strong>Besnier's</strong> <strong>sign</strong> (coup d'ongle sign or scratch sign or stroke of the nail): When the fine scales are not visible, an important diagnostic clue may be the <strong>loosening</strong> of barely perceptible scales with a fingernail, which is called the scratch sign.&nbsp;The most commonly affected site is the <strong>upper</strong> <strong>trunk</strong>.</p>\n<p><strong>Relapse</strong> is very common.</p>\n<p>First-line treatment:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Topical <strong>azoles</strong> twice daily for 2&ndash;3 weeks&nbsp;</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Terbinafine</strong> <strong>1% cream</strong> twice daily for 2&ndash;3 weeks</li>\n<li class=\"li1\">Ketoconazole shampoo twice weekly for 2-3 weeks</li>\n<li class=\"li1\">2.5% selenium shampoo alternative days for 2-3 weeks</li>\n</ul>\n<p>&nbsp;Second-line treatment: Oral <strong>itraconazole</strong>, 200 mg daily for 5 days</p>\n<p>The image below shows the&nbsp;pale yellow fluorescence of Tinea versicolor under Wood's lamp.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/dabc7a46e24e4e688d4d115aba6373dd.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/89ab8171873745edb8769edb267149bbx1280x960.JPEG"
    ]
  },
  {
    "text": "Which of the following organisms causes hard black nodules over scalp hair?",
    "choices": [
      {
        "id": 1,
        "text": "Piedraia hortae"
      },
      {
        "id": 2,
        "text": "Trichosporon beigelii"
      },
      {
        "id": 3,
        "text": "Corynebacterium tenuis"
      },
      {
        "id": 4,
        "text": "Trichophyton tonsurans"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>\u00a0</p>\n<p>The images given below show white piedra. Superficial, soft, white, grey, or brown nodules can be seen.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8323ecb07ee94d15ad856bd9cc1524c9x576x376.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ab3cb2fd444a48eb95404c75ded391e8x512x358.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c6c7cbc5fd3542d19544b4e1b4a61b05x507x355.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0e6da2bf1e504b8bb3fa17895b0b980bx1280x1280.JPEG"
    ]
  },
  {
    "text": "A 65-year-old male comes with complaints of an intensely pruritic lesion that started 6 days back. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Tinea corporis"
      },
      {
        "id": 2,
        "text": "Pityriasis rubra pilaris"
      },
      {
        "id": 3,
        "text": "Pityriasis versicolor"
      },
      {
        "id": 4,
        "text": "Piedra"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image showing a single, <strong>intensely</strong> <strong>pruritic</strong>&nbsp;lesion with sharp margins and central resolution is suggestive of <strong>tinea</strong> <strong>corporis.</strong></p>\n<p>Central resolution is a frequent but not exclusive finding. Multiple lesions may be present.</p>\n<p>Option B: Pityriasis rubra pilaris is<strong>&nbsp;</strong>a salmon-red dry scaly plaque with a nutmeg grater appearance.</p>\n<p>Option C: Pityriasis versicolor presents as hypo or hyperpigmented macules with fine scaling.</p>\n<p>Option D: Piedra has&nbsp;black or white nodules present superficially on the hair shaft.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/430426e0c49147fa924a77ddfc49211e.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which layer of the epidermis is primarily infected by dermatophytes?",
    "choices": [
      {
        "id": 1,
        "text": "Stratum corneum"
      },
      {
        "id": 2,
        "text": "Stratum granulosum"
      },
      {
        "id": 3,
        "text": "Stratum basale"
      },
      {
        "id": 4,
        "text": "Stratum spinosum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Dermatophytes </strong>infect and survive only in the <strong>dead keratin layers</strong> of skin (<strong>stratum corneum</strong>), hair and nails as they are <strong>keratinophillic</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 23 year old patient presents with lesions in the groin as shown in the image below. Which of the following cannot be a cause of these lesions?",
    "choices": [
      {
        "id": 1,
        "text": "Trichophyton"
      },
      {
        "id": 2,
        "text": "Microsporum"
      },
      {
        "id": 3,
        "text": "Aspergillus"
      },
      {
        "id": 4,
        "text": "Epidermophyton"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shows a <strong>well-circumscribed</strong>, <strong>annular plaque</strong> in the <strong>groin</strong> region which is characteristic of <strong>tinea cruris</strong>. Tinea cruris is a <strong>dermatophytosis.</strong> <em>Trichophyton</em><strong>, </strong><em>Microsporum</em> and <em>Epidermophyton</em><strong>&nbsp;</strong>are dermatophytes whereas <strong>Aspergillus</strong> is not.</p>\n<p>Dermatophytes include 3 genera:&nbsp;</p>\n<ol>\n<li style=\"font-weight: 400;\"><strong>Trichophyton</strong> species infect <strong>s</strong><strong>kin,</strong> <strong>hair, and nails </strong>and include<strong>&nbsp;</strong><em>T. rubrum, T. mentagrophytes, T. tonsurans, T. schoenleinii, and T. violaceum</em>.</li>\n<li style=\"font-weight: 400;\"><strong>Microsporum</strong> contains <em>M. gypseum, M. canis</em>, and <em>M. nanum</em>. These infect only hair and skin (<strong>n</strong><strong>ot nails</strong>).</li>\n<li style=\"font-weight: 400;\">Floccosum is the <strong>only species</strong> in the genus <strong>Epidermophyton</strong>, It infects only skin and nails (<strong>n</strong><strong>ot hair</strong>).</li>\n</ol>\n<p><em><strong>Aspergillus</strong> spp.</em> produce <strong>large necrotic lesions</strong> like<strong> ecthyma gangrenosum</strong>, and sometimes small papules and cold abscesses.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/deac5b1d364e4f808e021639d745eb4c.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Shown below is the trichogram of a patient suffering from tinea capitis. Which of the following fungi is implicated here?",
    "choices": [
      {
        "id": 1,
        "text": "Microsporum ferrugineum"
      },
      {
        "id": 2,
        "text": "Trichophyton tonsurans"
      },
      {
        "id": 3,
        "text": "Trichophyton canis"
      },
      {
        "id": 4,
        "text": "Microsporum audouinii"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above image shows\u00a0numerous <strong>fungal spores </strong>with<strong>in</strong> the hair <strong>shaft</strong> suggestive of <strong>endothrix</strong> type of tinea capitis, which is caused by\u00a0<em><strong>Trichophyton tonsurans.</strong></em></p>\n<p>Tinea capitis is of <strong>four</strong>\u00a0types:\u00a0</p>\n<table style=\"height: 322px; width: 425px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 143.609px; text-align: center; height: 18px;\"><strong>Type of Infection\u00a0</strong></td>\n<td style=\"width: 265.391px; text-align: center; height: 18px;\"><strong>Causative fungus\u00a0</strong></td>\n</tr>\n<tr style=\"height: 118px;\">\n<td style=\"width: 143.609px; height: 118px;\">Endothrix (infection inside shaft)</td>\n<td style=\"width: 265.391px; height: 118px;\">\n<ul>\n<li><em>Trichophyton tonsurans</em></li>\n<li><em>T.violaceum</em></li>\n<li><em>T. schoenleinii</em></li>\n<li><em> T.yaoundei</em></li>\n<li><em>T. soudanense</em></li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 100px;\">\n<td style=\"width: 143.609px; height: 100px;\">Ectothrix (infection outside shaft)</td>\n<td style=\"width: 265.391px; height: 100px;\">\n<ul>\n<li><em>Microsporum audouinii</em></li>\n<li><em> M.canis</em></li>\n<li><em>M.equinum</em></li>\n<li><em>M.ferrugineum</em></li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"width: 143.609px; height: 46px;\">Favus\u00a0</td>\n<td style=\"width: 265.391px; height: 46px;\">\n<ul>\n<li><em>T. schoenleinii</em></li>\n</ul>\n</td>\n</tr>\n<tr style=\"height: 41px;\">\n<td style=\"width: 143.609px; height: 41px;\">Kerion\u00a0</td>\n<td style=\"width: 265.391px; height: 41px;\">\n<ul>\n<li><em>T. verrucosum</em></li>\n<li><em>T. mentagrophytes</em></li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0072cff054cf47f5a01e96245f2e00ef.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/eabd81c9185648e8bf8b3eeae46ec992x235x180.PNG"
    ]
  },
  {
    "text": "A 32-year-old cattle farmer presents with a painful lesion of the scalp for 2 weeks. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Favus"
      },
      {
        "id": 2,
        "text": "Ectothrix"
      },
      {
        "id": 3,
        "text": "Kerion"
      },
      {
        "id": 4,
        "text": "Endothrix"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image shows an <strong>inflammatory</strong> <strong>mass</strong> with <strong>thick</strong> <strong>crusting</strong> and <strong>matting</strong> of hair which is suggestive of a&nbsp;<strong>kerion</strong>.</p>\n<p>Kerion is a severe inflammatory type of <strong>tinea</strong> <strong>capitis. </strong>The most common causative organisms of kerion are<em><strong> T. verrucosum </strong></em>and<em><strong> T. mentagrophytes. </strong></em>In severe cases, there may be pus along with <strong>sinus</strong> formation.&nbsp;</p>\n<p>Option A:&nbsp;Favus is characterized by the presence of yellowish, cup\u2010shaped crusts known as scutula that develop around hair follicles.</p>\n<p>Option B:&nbsp;Ectothrix is a mild inflammatory type in which dull grey coated broken hairs are seen.</p>\n<p>Option D:&nbsp;Endothrix is a non-inflammatory type in which black dots form around swollen hair shafts.&nbsp;</p>\n<p>Note: Scarring alopecia is seen in favus and kerion while non-scarring alopecia is seen in ectothrix and endothrix.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/615deb2ac97a490b8da36030b20ba023.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/185ea7962ecf4181ada58ede013360d6x1280x1094.950634696756.JPEG"
    ]
  },
  {
    "text": "A 10-year-old child presents with hair loss. The hair loss is patchy as shown in the image below. Black dots are noted in areas of hair loss. Which of the following types of tinea is this child suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Ectothrix"
      },
      {
        "id": 2,
        "text": "Endothrix"
      },
      {
        "id": 3,
        "text": "Kerion"
      },
      {
        "id": 4,
        "text": "Favus"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Treatment:</p>\n<ul>\n<li><strong>Terbinafine</strong>: &lt;10 Kg- 62.5 mg; 10-20 kg - 125 mg; &gt;20 kg- 250 mg, all given daily for 4 weeks.</li>\n<li><strong>Itraconazole</strong>: 2-4 mg/kg/day for 4-6 weeks.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/cc130d289f8a478fa129b68057ef6273.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/40c409e84f94408ea1e0cab7b67251c8x512x358.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/68e052bb23854f379756ffbe59c16609x720x462.JPEG"
    ]
  },
  {
    "text": "Which of the following is associated with tinea incognito?",
    "choices": [
      {
        "id": 1,
        "text": "Trichophyton tonsurans"
      },
      {
        "id": 2,
        "text": "Corticosteroids"
      },
      {
        "id": 3,
        "text": "Antimycotic drugs"
      },
      {
        "id": 4,
        "text": "Microsporum canis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Tinea incognito</strong> is an <strong>atypical</strong> clinical lesion of tinea, usually produced by incorrect treatment of fungal infection with a <strong>topical corticosteroid</strong>.</p>\n<p>Steroids<strong> suppress inflammation</strong> without eliminating the fungus; so the typically raised margin is diminished, <strong>scaling is lost</strong> and inflammation reduces. Hence, diagnosis becomes difficult.</p>\n<p>Pharmacological <strong>treatment</strong> of fungal <strong>tinea</strong> infection depends on the extent of the disease.</p>\n<p><strong>Localized disease:<br /></strong></p>\n<ul>\n<li>Topical terbinafine twice daily for 2 weeks</li>\n<li>Topical azole once or twice daily for 2&ndash;4 weeks</li>\n</ul>\n<p><strong>Widespread disease:&nbsp;<br /></strong></p>\n<ul>\n<li>First-line - oral terbinafine 250 mg/day 2&ndash;3 weeks or oral itraconazole 100 mg/day 2&ndash;4 weeks</li>\n<li>Second-line - oral griseofulvin 1 g/day for 4 weeks</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A college student presents to the dermatology OPD with a pruritic lesion on his left foot for 5 days. Which is the most common causative organism for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Trichophyton rubrum"
      },
      {
        "id": 2,
        "text": "Trichophyton tonsurans"
      },
      {
        "id": 3,
        "text": "Epidermophyton floccosum"
      },
      {
        "id": 4,
        "text": "Trichophyton interdigitale"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image shows a scaly pruritic lesion of <strong>tinea</strong> <strong>pedis</strong> or <strong>ringworm</strong> of foot is most commonly caused by&nbsp;<em><strong>Trichophyton rubrum</strong></em> infections (70%) followed by <em>Trichophyton interdigitale</em>&nbsp;infections (15%), <em>Epidermophyton floccosum</em>&nbsp;infections (&lt;10%), and mixed infections (5%).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d3539a45f7f248adbe918593647fb8f5.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/554cc575be3c4986b105ae2ccc650eecx1280x922.5387870239774.JPEG"
    ]
  },
  {
    "text": "Which of the following is known as Dhobi\u2019s itch?",
    "choices": [
      {
        "id": 1,
        "text": "Tinea corporis"
      },
      {
        "id": 2,
        "text": "Tinea cruris"
      },
      {
        "id": 3,
        "text": "Tinea barbae"
      },
      {
        "id": 4,
        "text": "Tinea capitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Dhobi's itch/tinea cruris</strong> is an infection of the <strong>groin</strong> by a species of <strong>dermatophyte</strong>.&nbsp;It is commonly known as ringworm of the groin&nbsp;or&nbsp;eczema marginatum<strong>.</strong></p>\n<p><em>T. rubrum</em> is the main cause; however, <em>T. Interdigitale</em> and <em>E. floccosum</em> also account for some cases.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An 11-year-old child presented with a pruritic lesion as shown. Which of the following is the drug of choice for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Terbinafine"
      },
      {
        "id": 2,
        "text": "Griseofulvin"
      },
      {
        "id": 3,
        "text": "Fluconazole"
      },
      {
        "id": 4,
        "text": "Selenium sulphide shampoo"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows a scaly pruritic lesion affecting the scalp hair, suggestive of <strong>tinea</strong> <strong>capitis.&nbsp;</strong>The drug of choice treatment for <strong>children</strong> in whom the cause of tinea capitis is unclear is <strong>g</strong><strong>riseofulvin</strong>.&nbsp;<strong>Terbinafine</strong> is the <strong>alternate</strong> first-line drug for adults.</p>\n<p>Option A: Oral terbinafine is also used in the treatment of<em> T. tonsurans</em> tinea capitis in children, but usually used in adults.</p>\n<p>Option C:&nbsp;Fluconazole is more effective in the treatment of <em>M. canis</em> compared to terbinafine.</p>\n<p>Option D:&nbsp;Selenium sulphide has only a supportive role in the treatment of tinea capitis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/28ed60484bfc4c11934a1c7c52875bd2.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "What test is used to diagnose the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "Gram\u2019s stain"
      },
      {
        "id": 2,
        "text": "KOH mount"
      },
      {
        "id": 3,
        "text": "Tissue smear"
      },
      {
        "id": 4,
        "text": "Wood\u2019s lamp"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above image is suggestive of <strong>tinea</strong> <strong>faciei,&nbsp;</strong>a&nbsp;<strong>dermatophyte</strong> infection of the <strong>glabrous</strong> <strong>skin</strong> of the <strong>face</strong> (the mustache and beard areas of the adult male are excluded). It is diagnosed by <strong>KOH</strong> <strong>mount</strong>.&nbsp;</p>\n<p><em>Trichophyton mentagrophytes</em> and <em>T.rubrum</em> predominate, but <em>T.tonsurans, M. audouinii, </em>and<em> M. canis</em> are also common causes.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fa4771426bc648a79cf55e5a5e86a4c3.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3b34ee62a4304d2095b8106d0b39aa70x1280x1151.8194640338504.JPEG"
    ]
  },
  {
    "text": "A 33-year-old man presented with a circular, pruritic and scaly lesion on his trunk. A lactophenol cotton blue mount of the scrapings from the lesion showed the following. What is the most probable causative organism?",
    "choices": [
      {
        "id": 1,
        "text": "Trichophyton"
      },
      {
        "id": 2,
        "text": "Microsporum"
      },
      {
        "id": 3,
        "text": "Epidermophyton"
      },
      {
        "id": 4,
        "text": "Any of the above"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above scenario is suggestive of <strong>tinea</strong> <strong>corporis</strong> and the slide showing&nbsp;<strong>smooth-walled club-shaped macroconidia</strong>&nbsp;with <strong>absent microconidia</strong>&nbsp;is indicative of <strong>Epidermophyton</strong> species.</p>\n<p>Epidermophyton species infects skin and nails but <strong>not the hair</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fe49bc99c2f6429abca2bb3a4770f4fb.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient who was diagnosed with kerion now presents with new-onset vesicular eruptions on his fingers. Which of the following is incorrect regarding these lesions?",
    "choices": [
      {
        "id": 1,
        "text": "Lesions are extremely pruritic and maybe tender"
      },
      {
        "id": 2,
        "text": "It is a form of allergic response"
      },
      {
        "id": 3,
        "text": "Responds well to topical corticosteroids"
      },
      {
        "id": 4,
        "text": "Dermatophytes can't be demonstrated from this lesion"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above scenario describes a <strong>dermatophytid</strong>&nbsp;(-id) reaction,&nbsp;a&nbsp;<strong>systemic reaction</strong> to <strong>fungal</strong> <strong>antigens</strong>&nbsp;during the <strong>infection</strong> or <strong>therapy.</strong></p>\n<p>An id reaction can be seen on the <strong>hands</strong> and sides of the <strong>fingers,&nbsp;</strong>but&nbsp;fungi cannot be demonstrated in these lesions.</p>\n<p>The reactions may be vesicular, lichenoid, papulosquamous, or pustular. The lesions are extremely <strong>pruritic</strong> and <strong>tender</strong>. The onset can be accompanied by fever, anorexia, generalized adenopathy, spleen enlargement, and leukocytosis.</p>\n<p>Although the eruptions are usually <strong>refractory</strong> to topical <strong>corticosteroids</strong>, they typically clear rapidly after treatment of the fungal infection. Secondary <strong>bacterial</strong> infections may occur.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Tinea unguium is a dermatophyte infection of ______.",
    "choices": [
      {
        "id": 1,
        "text": "Nail fold"
      },
      {
        "id": 2,
        "text": "Nail plate"
      },
      {
        "id": 3,
        "text": "Periungual region"
      },
      {
        "id": 4,
        "text": "Cuticle"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Tinea</strong> <strong>unguium</strong> is a dermatophytic infection of the&nbsp;<strong>nail</strong> <strong>plate</strong>.&nbsp;Onychomycosis is a broad term for all fungal nail infections.&nbsp;</p>\n<p><em>Trichophyton rubrum</em> accounts for most cases.</p>\n<p>It presents with <strong>yellowish</strong> discoloration, which spreads proximally as a streak in the nail. Later, <strong>subungual hyperkeratosis</strong> becomes prominent and spreads until the entire nail is affected. Gradually, the entire nail becomes <strong>brittle</strong> and <strong>separated</strong> from its bed as a result of the piling up of subungual keratin.</p>\n<p><strong>Six</strong> distinct <strong>patterns</strong> of tinea unguium have been described.</p>\n<ol>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Distal and lateral subungual onychomycosis (DLSO) (most common)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Superficial onychomycosis (SO)</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Proximal subungual onychomycosis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Endonyx onychomycosis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Totally dystrophic onychomycosis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Mixed onychomycosis</li>\n</ol>\n<p>Diagnosis is made by <strong>KOH</strong> mount examination of <strong>clippings</strong> or curettings that include dystrophic subungual debris.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1be5b17dd6da4c499c2c653ba6e3c573x1280x940.592383638928.JPEG"
    ]
  },
  {
    "text": "What is the correct treatment regimen for the condition shown?",
    "choices": [
      {
        "id": 1,
        "text": "Oral griseofulvin for 3 weeks"
      },
      {
        "id": 2,
        "text": "Oral griseofulvin for 6 weeks"
      },
      {
        "id": 3,
        "text": "Oral terbinafine for 12 weeks"
      },
      {
        "id": 4,
        "text": "Oral terbinafine for 24 weeks"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image shows&nbsp;<strong>onychomycosis</strong> of <strong>toenails. </strong>The first-line treatment is oral <strong>terbinafine</strong> 250mg/day for <strong>12</strong> <strong>weeks</strong>.</p>\n<p>Treatment of onychomycosis:</p>\n<table style=\"height: 174px; width: 503px;\">\n<tbody>\n<tr>\n<td style=\"width: 82px;\">&nbsp;</td>\n<td style=\"width: 153.75px; text-align: center;\"><strong>Oral terbinafine&nbsp;</strong></td>\n<td style=\"width: 244.25px; text-align: center;\"><strong>Oral itraconazole&nbsp;</strong></td>\n</tr>\n<tr>\n<td style=\"width: 82px; text-align: center;\"><strong>Finger nails&nbsp;</strong></td>\n<td style=\"width: 153.75px;\">\n<p>250mg/day for 6 weeks&nbsp;</p>\n</td>\n<td style=\"width: 244.25px;\">\n<p>400mg/day for 1week, repeated every month for 2-3months&nbsp;</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 82px; text-align: center;\"><strong>Toe nails&nbsp;</strong></td>\n<td style=\"width: 153.75px;\">\n<p>250mg/day for 12 weeks&nbsp;</p>\n</td>\n<td style=\"width: 244.25px;\">\n<p>400mg/day for 1week,&nbsp; repeated every month for 3-4 months&nbsp;</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Second-line drug: Oral <strong>griseofulvin</strong> dose 1 g/day for 4&ndash;8 months (longer for toenails).</p>\n<p><strong>Topical treatment</strong> with <strong>amorolfine</strong> or<strong> ciclopirox olamine</strong> can be used in <strong>mild</strong> infecti<strong>ons</strong> affecting the distal nail plate only or non\u2010linear superficial onychomycosis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5a0e617e2fc043a8bf468f875e5a08f5.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is correct with respect to Perl\u00e8che?",
    "choices": [
      {
        "id": 1,
        "text": "Inflammation around the nail involving the nail folds"
      },
      {
        "id": 2,
        "text": "White creamy patch over tongue"
      },
      {
        "id": 3,
        "text": "Cobbled appearance of tongue"
      },
      {
        "id": 4,
        "text": "Soreness and cracking at the angles of the mouth"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Soreness</strong> and <strong>cracking</strong> at the <strong>angles</strong> of the mouth are seen in <strong>Perl&egrave;che</strong>. It is considered as an <strong>intertrigo</strong> where&nbsp;<strong>candida</strong> is the most common organism implicated.</p>\n<p>It is also called <strong>angular</strong> <strong>stomatitis</strong>. It is a type of <strong>oral</strong> <strong>mucosal</strong> <strong>candidiasis</strong>. Nutritional status and mechanical factors (e.g. the depth of the fold), the presence of moisture from persistent salivation or licking the lips also contribute to stomatitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3eda3cb312e84e9083f4d4341184c6fax1280x1097.6586741889987.JPEG"
    ]
  },
  {
    "text": "Which type of oral mucosal candidiasis does not present with a white patch?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic atrophic candidiasis"
      },
      {
        "id": 2,
        "text": "Chronic hyperplastic candidiasis"
      },
      {
        "id": 3,
        "text": "Chronic pseudomembranous candidiasis"
      },
      {
        "id": 4,
        "text": "Acute pseudomembranous candidiasis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Chronic atrophic candidiasis</strong> presents with a <strong>red patch</strong>, not white.</p>\n<p>Candidiasis of the oral mucosal membranes is of the following types:</p>\n<table style=\"height: 532px;\" width=\"581\">\n<tbody>\n<tr>\n<td style=\"width: 264.578px; text-align: center;\"><strong>Type of Candidiasis</strong></td>\n<td style=\"width: 300.422px; text-align: center;\"><strong>Description</strong>&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">\n<p>Acute pseudomembranous candidiasis /</p>\n<p>Oral thrush /&nbsp;</p>\n<p>Chronic pseudomembranous candidiasis&nbsp;</p>\n</td>\n<td style=\"width: 300.422px;\">\n<p>Sharply defined patch of creamy, crumbly, curd\u2010like, white pseudomembrane</p>\n<p>Has an underlying erythematous base</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">Acute erythematous candidiasis&nbsp;</td>\n<td style=\"width: 300.422px;\">\n<p>Denuded, atrophic,&nbsp;erythematous mucous membranes</p>\n<p>Most common- dorsum of<br /> the tongue&nbsp;</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">\n<p>Chronic erythematous candidiasis /</p>\n<p>Chronic atrophic candidiasis /&nbsp;</p>\n<p>Denture stomatitis</p>\n</td>\n<td style=\"width: 300.422px;\">\n<p>Affected areas&nbsp;show a variable bright red or dusky erythema</p>\n<p>Fairly sharply defined at the margin of the denture</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">\n<p>Chronic plaque\u2010like candidiasis /&nbsp;</p>\n<p>Chronic hyperplastic candidiasis /</p>\n<p>Candida leukoplakia</p>\n</td>\n<td style=\"width: 300.422px;\">\n<p>Very persistent, firm, irregular, white plaques occur in the mouth</p>\n<p>Commonly on the cheek or tongue&nbsp;</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">Chronic nodular candidiasis</td>\n<td style=\"width: 300.422px;\">Tongue has a cobbled appearance</td>\n</tr>\n<tr>\n<td style=\"width: 264.578px;\">Angular cheilitis/Angular stomatitis/&nbsp;Perl&egrave;che</td>\n<td style=\"width: 300.422px;\">Soreness at the angles of the mouth extending outwards in the<br /> folds of the facial skin</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Image:</strong> Chronic Atrophic Candidiasis</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/746352dea2c34d7c9de18625907d92bex968x607.PNG"
    ]
  },
  {
    "text": "A 32-year-old man presents with reddish-pink, non-scaly, itchy and moist patches in his left armpit. Small, superficial, white pustules are observed adjacent to the patches. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Candidal Balanitis"
      },
      {
        "id": 2,
        "text": "Candidal Intertrigo"
      },
      {
        "id": 3,
        "text": "Oropharyneal candidiasis"
      },
      {
        "id": 4,
        "text": "Candidal Paronychia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The erythematous, <strong>non-scaly</strong> moist patches with tiny, superficial, white <strong>pustular</strong> <strong>satellite lesions</strong> are suggestive of <strong>candidal</strong> <strong>intertrigo</strong>.</p>\n<p>Sites of infection:</p>\n<ul>\n<li>Between genital folds and groins</li>\n<li>Armpits</li>\n<li>Between the buttocks</li>\n<li>Inframammary fold (large and pendulous breasts)</li>\n<li>Under overhanging abdominal folds</li>\n<li>Umbilicus.</li>\n<li>Web spaces of&nbsp;toes, fingers</li>\n</ul>\n<p>Marked <strong>maceration</strong> with a thick, white, horny layer is usually prominent.&nbsp;<strong>Soreness</strong> and <strong>itching</strong> are present.</p>\n<p>The disease usually spreads beyond the area of contact, developing lesions with irregular edges and subcorneal pustules rupturing to give tiny erosions which lead to peeling of the stratum corneum.&nbsp;</p>\n<p>Psoriasis, tinea corporis, and pityriasis rotunda have scaly lesions.</p>\n<p>The image below shows candidial intertrigo.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3412c7ce2c1e4fe39f7b7c8ace280908x379x379.JPEG"
    ]
  },
  {
    "text": "A patient presents with the following lesion. Which is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Oriental sore"
      },
      {
        "id": 2,
        "text": "Lupus vulgaris"
      },
      {
        "id": 3,
        "text": "Chromoblastomycosis"
      },
      {
        "id": 4,
        "text": "Kerion"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image shows the <strong>volcano</strong> <strong>sign</strong> seen in <strong>O</strong><strong>riental</strong> <strong>sore</strong>.</p>\n<p>The lesion starts as a small non-tender <strong>papule</strong>, which enlarges in size and <strong>ulcerates</strong> in the centre. The border of the <strong>crusted ulcer</strong> often has an <strong>erythematous</strong> <strong>rim</strong> and is called a &ldquo;volcano sign.&rdquo;</p>\n<p>It is also called <strong>cutaneous</strong> <strong>leishmaniasis</strong> or old world leishmaniasis, Kandahar sore, Lahore sore, or Delhi boil.</p>\n<p>Causative organisms:</p>\n<ul>\n<li>Old world leishmaniasis:&nbsp;<em>L. donovani, L.major,&nbsp;</em>and<em> L.tropica</em></li>\n<li>New world leishmaniasis:&nbsp;<em>L. mexicana </em>complex and<em> L. braziliensis </em>complex</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/760d6d0170c04b90997ac5c9a168c174.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old farmer presents with firm, painless nodules with purulent discharge on his left foot for 10 days. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Sporotrichosis"
      },
      {
        "id": 2,
        "text": "Chromoblastomycosis"
      },
      {
        "id": 3,
        "text": "Mycetoma"
      },
      {
        "id": 4,
        "text": "Oriental sores"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image shows <strong>nodular</strong> lesions that have broken down to form <strong>draining</strong> <strong>sinuses</strong> with purulent discharge which is suggestive of <strong>mycetoma</strong>.</p>\n<p>The nodules are <strong>painless</strong> and with time form papules and pustules which break down to form draining sinuses, with the discharge of <strong>granules</strong>. It is caused by various types of <strong>fungi</strong> (eumycetoma) or <strong>filamentous</strong> <strong>bacteria</strong> (actinomycetes).&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/696988de17084f45808f5618a6e1b913.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3e306dbf207a49cda26acdbe0d366550x1280x1711.4809590973202.JPEG"
    ]
  },
  {
    "text": "A patient presents with multiple hypertrophic plaques on his left leg for 6 months. History reveals that the lesions started as warty papules and progressed to the current state. On examination, several satellite lesions noted. Skin biopsy from the lesion is shown below. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Chromoblastomycosis"
      },
      {
        "id": 2,
        "text": "Sporotrichosis"
      },
      {
        "id": 3,
        "text": "Phaeohyphomycosis"
      },
      {
        "id": 4,
        "text": "Mycetoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image shows <strong>Medlar</strong> <strong>bodies</strong> that are suggestive of <strong>chromoblastomycosis</strong>.</p>\n<p>Medlar bodies are <strong>golden</strong>-<strong>brown</strong>, <strong>thick</strong>\u2010<strong>walled</strong> muriform or <strong>sclerotic</strong> cells in <strong>abscesses.&nbsp;</strong>They may also be found within&nbsp;<strong>giant cells. </strong></p>\n<p>Chromoblastomycosis is a chronic infection of the <strong>skin</strong> and <strong>subcutaneous tissue</strong> which is caused by <strong>pigmented</strong> <strong>fungi</strong> (Phialophora and Fonsecaea species). The lesions start as <strong>warty</strong> papules, slowly enlarge to form a hypertrophic <strong>plaque</strong> progressing to large hyperkeratotic masses over months to years<strong>. Satellite</strong> <strong>lesions</strong> are produced by <strong>scratching</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d4976ce21f6b47d9823733ac5f81890e.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient presents with the following lesions. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Lichen planus"
      },
      {
        "id": 2,
        "text": "Sporotrichosis"
      },
      {
        "id": 3,
        "text": "Chromoblastomycosis"
      },
      {
        "id": 4,
        "text": "Tinea circinata"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Option A:&nbsp;<strong>Lichen planus</strong>- Purple polygonal, flat-topped papules are seen.</p>\n<p>Option C: <strong>Chromoblastomycosis</strong>- &nbsp;multiple hypertrophic plaques are seen.</p>\n<p>Option D: <strong>Tinea</strong> <strong>circinata</strong>- circular, scaly lesions with central clearing are seen.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ae99c77cb7974c0ca331471ef7853f87.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6fcf12136f56431d94ddb7d8b780d75ax1280x1725.0211565585332.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a157fa2a90644048972f3b13de15d962x720x1065.PNG"
    ]
  },
  {
    "text": "Which of the following is the vector of Chiclero ulcer?",
    "choices": [
      {
        "id": 1,
        "text": "Phlebotomus"
      },
      {
        "id": 2,
        "text": "Lutzomyia"
      },
      {
        "id": 3,
        "text": "Reduviid"
      },
      {
        "id": 4,
        "text": "Trombiculid"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Option A: Phlebotomus sandfly is the vector for old-world leishmaniasis.</p>\n<p>Option C: Reduviid bug is the vector for Chagas disease.</p>\n<p>Option D: Trombiculid mite is the vector for scrub typhus.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f45df25c317f460b9486c7af3ffcd6dbx1280x2012.0733427362482.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4eba9a5a44124147b32acd6115b34706x650x650.JPEG"
    ]
  },
  {
    "text": "A 20-year-old man from Jaipur presented with an erythematous nodule on the cheek with central crusting. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Systemic lupus erythematosus"
      },
      {
        "id": 2,
        "text": "Lupus vulgaris"
      },
      {
        "id": 3,
        "text": "Chilblain"
      },
      {
        "id": 4,
        "text": "Cutaneous leishmaniasis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above scenario is suggestive of <strong>cutaneous</strong> <strong>leishmaniasis</strong>.</p>\n<p>The classical lesion in cutaneous leishmaniasis is characterized by <strong>erythematous nodule/plaque</strong> which then <strong>ulcerates</strong> and becomes <strong>crusted.</strong> Diascopy usually reveals<strong>&nbsp;'apple jelly nodules'</strong>.</p>\n<p>Note:&nbsp;'Apple jelly nodules' on diascopy are seen in both cutaneous leishmaniasis and lupus vulgaris. The skin lesion in cutaneous leishmaniasis shows central crusting, whereas in lupus vulgaris it shows central scarring.</p>\n<p>The image shows apple jelly nodule seen on diascopy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0af6a5d1747747c09160d9dd6032fbb4x513x381.PNG"
    ]
  },
  {
    "text": "A 36-year-old male patient from Bihar comes with complaints of hypopigmented macules over the trunk and face. The nerves and sensations are found to be normal and there is no visible scaling. The patient gives a history of prolonged fever 2 years back for which he was treated. What is the drug of choice for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Multidrug therapy for leprosy"
      },
      {
        "id": 2,
        "text": "Amphotericin B deoxycholate"
      },
      {
        "id": 3,
        "text": "Sodium stibogluconate"
      },
      {
        "id": 4,
        "text": "Miltefosine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The case scenario suggests a diagnosis of <strong>post-kala-azar dermal leishmaniasis</strong>.&nbsp;The drug of choice for this condition is <strong>miltefosine</strong>.&nbsp;</p>\n<p><strong>Approach to the case:&nbsp;</strong></p>\n<p>The patient hails from a kala-azar endemic zone&mdash;Bihar. The rash appears <strong>1-2 years after</strong> a history of prolonged fever, which suggests&nbsp;<strong>visceral leishmaniasis.&nbsp;</strong>There are 2 other differentials&mdash;leprosy and tinea versicolor.&nbsp;</p>\n<ul>\n<li>The presence of hypopigmented macules over the trunk and face, suggests a differential of leprosy, but the nerves and sensations are normal, hence ruling it out.</li>\n<li>There is no scaling visible in the lesions, ruling out tinea versicolor.&nbsp;</li>\n</ul>\n<p>In kala-azar, after a variable period of years or months, <strong>diffuse nodulation begins</strong> to develop in these macules. The rash is <strong>progressive</strong> over many years and seldom heals spontaneously. As it may persist for up to 20 years, these patients may act as a <strong>chronic reservoir</strong> of infection.</p>\n<p>The image below shows post-kala-azar cutaneous leishmaniasis.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c444e1bfdcba4b52bf2413c5443557cfx1280x1092.2425952045135.JPEG"
    ]
  }
];
        let quizName = '16 Fungal And Protozoal Infections';
        const quizFilename = '16-fungal-and-protozoal-infections-23fb1035.html';
        let hierarchy = ["Marrow", "qBank", "Dermatology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>