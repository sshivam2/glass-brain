<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>09 Fractures Of Femur - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Orthopedics
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following factors increases the risk of femoral neck fractures?",
    "choices": [
      {
        "id": 1,
        "text": "Hypoparathyroidism"
      },
      {
        "id": 2,
        "text": "Proton pump inhibitors"
      },
      {
        "id": 3,
        "text": "Hypertension"
      },
      {
        "id": 4,
        "text": "Increased levels of physical activity"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The use of <strong>proton pump inhibitors</strong> is a <strong>risk factor</strong> for femoral neck fractures.&nbsp;</p>\n<p>Femoral neck fracture is a type of intracapsular hip fracture. Common <strong>risk factors</strong> for <strong>hip fractures</strong> include:</p>\n<ul>\n<li>Increasing age</li>\n<li>Female sex</li>\n<li>White population of Europe and North America</li>\n<li>Smoking</li>\n<li>Decreased level of physical activity</li>\n</ul>\n<p><strong>Comorbidities</strong> that can cause hip fractures are:</p>\n<ul>\n<li>HIV</li>\n<li>Celiac disease</li>\n<li>Diabetes mellitus</li>\n<li>Hypo and hyperthyroidism</li>\n<li>Primary hyperparathyroidism</li>\n<li>Chronic kidney and liver disease</li>\n</ul>\n<p><strong>Drugs</strong> that can cause hip fractures are:</p>\n<ul>\n<li>Corticosteroids</li>\n<li><strong>Proton pump inhibitors</strong></li>\n<li>Antipsychotic medication</li>\n<li>Aromatase inhibitors</li>\n<li>Gonadotropin-releasing hormone inhibitors</li>\n<li>Long-acting progesterone-only pills</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following classifications is not used for neck of femur fractures?",
    "choices": [
      {
        "id": 1,
        "text": "Pauwels classification"
      },
      {
        "id": 2,
        "text": "Garden classification"
      },
      {
        "id": 3,
        "text": "Delbet classification"
      },
      {
        "id": 4,
        "text": "Neer's classification"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>\u00a0</p>\n<p><strong>Delbet</strong> classification\u00a0is used for\u00a0hip fractures in <strong>children</strong>. They are grouped into four types based on their location as follows:</p>\n<ul>\n<li>Type I -\u00a0Transepiphyseal fracture</li>\n<li>Type II -\u00a0Transcervical fracture</li>\n<li>Type III -\u00a0Cervicotrochanteric fracture</li>\n<li>Type IV - Intertrochanteric fracture</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/63ccdd80d6ff4792845182859da590b6x1280x1149.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dd0847be7c4f48088e5b1be0f8ae8d18x1280x1586.JPEG"
    ]
  },
  {
    "text": "The X-ray of a patient with femoral neck fracture showed that all 3 sets of trabeculae were out of alignment. Which Garden's stage of fracture shows this finding?",
    "choices": [
      {
        "id": 1,
        "text": "Stage I"
      },
      {
        "id": 2,
        "text": "Stage II"
      },
      {
        "id": 3,
        "text": "Stage III"
      },
      {
        "id": 4,
        "text": "Stage IV"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In <strong>Garden's\u00a0stage III</strong>\u00a0fracture neck of femur, all the <strong>3</strong> sets of <strong>trabeculae</strong> are <strong>out of alignment.</strong></p>\n<p>Garden classification of fracture neck of femur is based on the degree of displacement.</p>\n<ul>\n<li class=\"p1\">Stage I - incomplete fracture line and femoral head is in slight valgus</li>\n<li class=\"p1\">Stage II - complete fracture line and non-displaced</li>\n<li class=\"p1\">Stage\u00a0III - complete fracture line and partially displaced</li>\n<li class=\"p1\">Stage IV - complete fracture line and completely displaced\u00a0</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dd0847be7c4f48088e5b1be0f8ae8d18x1280x1586.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is true regarding Pauwel's classification of neck of femur fractures?",
    "choices": [
      {
        "id": 1,
        "text": "Pauwel's angle is directly proportional to stability"
      },
      {
        "id": 2,
        "text": "Type 2 fracture makes an angle of 60 degrees"
      },
      {
        "id": 3,
        "text": "Plane of reference is the horizontal plane"
      },
      {
        "id": 4,
        "text": "Pauwel's angle is formed by fracture line with inter-trochanteric line"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>When the Pauwel's angle is <strong>small</strong>, compressive forces act at the fracture ends and hence the fracture is <strong>stable</strong>. As Pauwel's angle increases, the fracture line becomes more vertical and the shearing forces act on the fractured ends. Hence, at <strong>higher angles</strong> the fracture becomes <strong>unstable</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a297351cb96743b4b98c95abcb36c7fbx1280x1149.JPEG"
    ]
  },
  {
    "text": "An elderly patient slipped in the bathroom and sustained injury over the left hip. The radiograph is shown below. His attitude of the leg will be:",
    "choices": [
      {
        "id": 1,
        "text": "Shortened and abducted"
      },
      {
        "id": 2,
        "text": "Lengthened and internally rotated"
      },
      {
        "id": 3,
        "text": "Shortened and externally rotated"
      },
      {
        "id": 4,
        "text": "Flexed, adducted and internally rotated"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The history of fall and hip injury in an elderly patient along with the radiological findings of a broken Shenton's line is suggestive of a<strong>&nbsp;neck of femur fracture.&nbsp;</strong>In this condition, the attitude of the leg will be <strong>shortened </strong>and<strong> externally rotated </strong>and movements of the hip joint will be painful.</p>\n<p><strong>A plain</strong>&nbsp;<strong>radiograph</strong> may show the following features:</p>\n<ul>\n<li>Fracture line in the neck of femur</li>\n<li>External rotation of the femur with the lesser trochanter appearing more prominent</li>\n<li>Displacement of the greater trochanter</li>\n<li>Break in the trabecular stream</li>\n<li>Break in Shenton's line</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/49f2c42b7d6d4a24b655b430415fe243.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/53e9673a803e46d7aaea91bcdbbb267fx1280x1010.JPEG"
    ]
  },
  {
    "text": "A 70-year-old lady, a known case of chronic osteoarthritis of the hip, has a trivial fall while climbing the stairs. Her right lower limb is in slight external rotation. X-ray pelvis is shown below. What is the next step of management?",
    "choices": [
      {
        "id": 1,
        "text": "Open reduction and internal fixation"
      },
      {
        "id": 2,
        "text": "Closed reduction and internal fixation"
      },
      {
        "id": 3,
        "text": "Hemi-arthroplasty"
      },
      {
        "id": 4,
        "text": "Total arthroplasty"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given scenario and X-ray are suggestive of right-sided <strong>fracture neck of femur</strong>, Garden stage IV. Since the patient is <strong>&gt;65 years</strong> with <strong>existing arthritis</strong>, the best choice of treatment is&nbsp;<strong>total hip arthroplasty. </strong></p>\n<p>In the absence of arthritis, fracture neck of femur in patients &gt;65 years, is treated by hemiarthroplasty.</p>\n<p>The image given below shows <strong>total hip arthroplasty</strong> done for fracture neck of femur.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f7719780fd434719aafa97795cca3aeb.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9b46b1d4b6364c6e94fd7d5f22ebb297x716x452.PNG"
    ]
  },
  {
    "text": "Which of the following is most commonly used for internal fixation of fracture of femoral neck in young adults?",
    "choices": [
      {
        "id": 1,
        "text": "Cannulated cancellous screws"
      },
      {
        "id": 2,
        "text": "Dynamic hip screw"
      },
      {
        "id": 3,
        "text": "Austin Moore implant"
      },
      {
        "id": 4,
        "text": "Herbert screw"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option C:<strong> Austin Moore's</strong>&nbsp;implant is an older implant used in <strong>unipolar hemiarthroplasty</strong>.&nbsp;</p>\n<p>Option D:&nbsp;<strong>Herbert screw</strong> is used in bridging a <strong>scaphoid fracture.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cd680622d80b49a09837bd5a7caad30cx152x176.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ffdced4066b84af3b0120b9c3cde23b7x907x1197.JPEG"
    ]
  },
  {
    "text": "A 55-year-old woman presents with complaints of right-sided hip pain and restriction of movements of the right lower limb for 3 weeks. She had a history of trivial trauma 3 weeks ago. X-ray reveals an impacted fracture neck of the right femur. What is the next step of management?",
    "choices": [
      {
        "id": 1,
        "text": "ORIF with fibular bone graft"
      },
      {
        "id": 2,
        "text": "McMurray's osteotomy"
      },
      {
        "id": 3,
        "text": "Evaluate further with MRI"
      },
      {
        "id": 4,
        "text": "Hemiarthroplasty"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In the given clinical scenario with a <strong>3-week old</strong> femoral head <strong>fracture,</strong> the next step will be to do&nbsp;an <strong>MRI hip. </strong>This is to evaluate the <strong>femoral head</strong>&nbsp;for&nbsp;<strong>compromise</strong> in the <strong>blood supply</strong>.</p>\n<p>Treatment of the femoral head fracture depends on the findings seen on an MRI:</p>\n<ul>\n<li>Femoral head shows <strong>compromised blood supply </strong>-&nbsp;reduction with<strong>&nbsp;fibular bone graft</strong> or muscle pedicle graft</li>\n<li>Femoral head shows signs of <strong>osteonecrosis </strong>and&nbsp;acetabulum is normal -&nbsp;<strong>hemiarthroplasty</strong>&nbsp;</li>\n<li>Femoral head is normal but the fracture is nearly <strong>vertical </strong>(can develop to non-union) -&nbsp;<strong>osteotomy</strong>&nbsp;</li>\n</ul>\n<p>The image given below shows osteonecrosis of the femoral head seen on an MRI.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f41b65211c3a47bd9a580e052780b606x1022x764.PNG"
    ]
  },
  {
    "text": "A 56-year-old man came to OPD with a 1-month-old fracture neck of femur. X-ray revealed Pauwel's angle to be 70\u00b0. MRI showed a normal femoral head. What is the next step in management?",
    "choices": [
      {
        "id": 1,
        "text": "Open reduction and internal fixation"
      },
      {
        "id": 2,
        "text": "Mc Murray's osteotomy"
      },
      {
        "id": 3,
        "text": "Hemi-arthroplasty"
      },
      {
        "id": 4,
        "text": "Total hip arthroplasty"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of a 1-month-old <strong>Pauwel's type III</strong> fracture (&gt;50&deg;), which is nearly vertical and has an increased chance of <strong>non-union</strong>. Hence, the best management would be to compress the fractured ends by&nbsp;<strong>Mc Murray's osteotomy&nbsp;</strong>and<strong> internal fixation</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding McMurray's osteotomy?",
    "choices": [
      {
        "id": 1,
        "text": "It is an oblique osteotomy in the inter-trochanteric region"
      },
      {
        "id": 2,
        "text": "It involves lateral displacement and adduction of the distal fragment"
      },
      {
        "id": 3,
        "text": "The line of weight bearing after the osteotomy passes from the head to the distal fragment"
      },
      {
        "id": 4,
        "text": "It converts shearing stress to compressive forces"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In <strong>McMurray's osteotomy</strong>, the distal fragment is displaced <strong>medially </strong>and is <strong>abducted</strong>.&nbsp;This converts shearing stresses at the fracture site to compressive forces&nbsp;promoting faster healing.&nbsp;</p>\n<p>McMurray's osteotomy is an oblique osteotomy directed medially upwards at the <strong>inter-trochanteric region</strong>. It is based on the <strong>biomechanical </strong>principle. After the medial displacement of the femur, the <strong>weight-bearing line</strong> passes from the head to the distal fragment. It, therefore, <strong>bypasses</strong> the <strong>fracture site</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/524a9cb5225c4a14845c988167877499x1279x1149.JPEG"
    ]
  },
  {
    "text": "A 35-year-old woman with a history of ORIF for femoral neck fracture came for post-operative follow up after 7 months. She is unable to bear weight on the operated side. Her X-ray showed no evidence of healing. Which of the following is not a probable cause for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Improper immobilization"
      },
      {
        "id": 2,
        "text": "Avascularity of the femoral head"
      },
      {
        "id": 3,
        "text": "Interference of synovial fluid"
      },
      {
        "id": 4,
        "text": "Hypertrophy of cambium layer of periosteum"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario is suggestive of <strong>non-union</strong> of <strong>femoral neck fracture</strong> after ORIF, as there is no evidence of healing 6-12 months post-operatively. <strong>Lack</strong> of <strong>cambium layer</strong> in the periosteum of neck of femur is one of the causes of non-union.</p>\n<p><strong>Causes</strong> for <strong>non-union</strong> in the neck of femur&nbsp;fracture are as follows:</p>\n<ul>\n<li>Inadequate blood supply of femoral head</li>\n<li>Since the fracture is intra-articular, the synovial fluid interferes with fracture healing.</li>\n<li>Lack of the cambium layer of periosteum, which produces the callus</li>\n<li>Inadequate reduction and poor internal fixation</li>\n<li>Improper immobilization</li>\n</ul>\n<p>The image given below shows (a) non-union of neck of femur fracture, (b) osteotomy to correct the non-union, (c) 5 months post-osteotomy with healed fracture.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c7c2bfb47e0d4469a189ea11827e154ax1128x632.PNG"
    ]
  },
  {
    "text": "Which of the following is false about the condition shown in the image below?",
    "choices": [
      {
        "id": 1,
        "text": "Malunion can happen if this condition is not treated"
      },
      {
        "id": 2,
        "text": "The patient may be able to walk"
      },
      {
        "id": 3,
        "text": "Avascular necrosis is the most common complication"
      },
      {
        "id": 4,
        "text": "Shortening of limb is less than 1 inch"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The radiograph shows a&nbsp;<strong>fracture neck</strong> of the <strong>femur.&nbsp;Non-union</strong> is a complication of this fracture, not malunion.&nbsp;</p>\n<p><strong>Malunion</strong> is a complication of <strong>inter-trochanteric</strong> fractures.</p>\n<p><strong>Complications</strong> of fracture neck of the femur are:</p>\n<ul>\n<li>Avascular necrosis (most common)</li>\n<li>Non-union</li>\n<li>Osteonecrosis of the femoral head may lead to <strong>secondary osteoarthritis</strong> after many years</li>\n</ul>\n<p>Option B: In impacted fracture neck of femur, the patient may be able to walk.</p>\n<p>Option D: Shortening of the limb is less than 1 inch in fracture neck of femur.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3298c7ad3959403896098e117dcd4eea.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false about avascular necrosis?",
    "choices": [
      {
        "id": 1,
        "text": "It can be diagnosed on X-ray only after 4 years"
      },
      {
        "id": 2,
        "text": "It can also occur in united fracture neck of femur"
      },
      {
        "id": 3,
        "text": "Subcapital type has worse prognosis"
      },
      {
        "id": 4,
        "text": "Patients with sickle cell disease are at an increased risk"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Avascular necrosis</strong> is a late complication of fracture neck of the femur, which can be diagnosed on <strong>X-ray</strong> only after a few months to&nbsp;<strong>2 years </strong>after&nbsp;the injury. Hence, MRI is the best investigation for diagnosis.</p>\n<p>The amount of vascular damage produced at the time of fracture determines the probability of the development of osteonecrosis. In addition to this, the <strong>blood</strong> <strong>supply</strong> to the <strong>femoral head</strong> may also be <strong>disrupted</strong> during <strong>internal fixation</strong>. Hence, avascular necrosis can also occur in united femur fractures.</p>\n<p>More <strong>proximally</strong> the fracture is located, <strong>worse</strong> is the <strong>prognosis</strong>. Hence, sub-capital fractures have the worst prognosis.</p>\n<p>Patients with sickle cell disease are at an increased risk for developing avascular necrosis of the femoral head.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old man is brought to the casualty with a history of RTA. His left lower limb is shortened by 2 inches. The attitude of the leg is extension and externally rotated, with the lateral border of the foot touching the bed. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Inter-trochanteric fracture femur"
      },
      {
        "id": 2,
        "text": "Fracture neck of femur"
      },
      {
        "id": 3,
        "text": "Femoral shaft fracture"
      },
      {
        "id": 4,
        "text": "Anterior dislocation of hip"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario with the limb<strong> shortening &gt;1 inch</strong> and pronounced<strong>&nbsp;external rotation</strong>&nbsp;is suggestive of <strong>inter-trochanteric fracture </strong>of the<strong> femur</strong><strong>.</strong></p>\n<p>Differences between fracture neck of femur and inter-trochanteric fractures:</p>\n<table style=\"height: 289px; width: 630px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Feature</td>\n<td style=\"width: 257.984px; height: 18px;\">Fracture neck of femur</td>\n<td style=\"width: 251.016px; height: 18px;\">Inter-trochanteric fracture</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Age</td>\n<td style=\"width: 257.984px; height: 18px;\">More than 50 years</td>\n<td style=\"width: 251.016px; height: 18px;\">More than 60 years</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Sex</td>\n<td style=\"width: 257.984px; height: 18px;\">Common in females</td>\n<td style=\"width: 251.016px; height: 18px;\">Common in males</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Injury</td>\n<td style=\"width: 257.984px; height: 18px;\">Trivial</td>\n<td style=\"width: 251.016px; height: 18px;\">Significant</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Ability to walk</td>\n<td style=\"width: 257.984px; height: 18px;\">May walk</td>\n<td style=\"width: 251.016px; height: 18px;\">Unable to walk</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Pain</td>\n<td style=\"width: 257.984px; height: 18px;\">Mild</td>\n<td style=\"width: 251.016px; height: 18px;\">Severe</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Swelling</td>\n<td style=\"width: 257.984px; height: 18px;\">Nil</td>\n<td style=\"width: 251.016px; height: 18px;\">Severe</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Ecchymosis</td>\n<td style=\"width: 257.984px; height: 18px;\">Nil</td>\n<td style=\"width: 251.016px; height: 18px;\">Present</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Tenderness</td>\n<td style=\"width: 257.984px; height: 18px;\">In Scarpa's triangle</td>\n<td style=\"width: 251.016px; height: 18px;\">On the greater trochanter</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">External rotation deformity</td>\n<td style=\"width: 257.984px; height: 18px;\">Less than 45 degrees</td>\n<td style=\"width: 251.016px; height: 18px;\">More than 45 degrees (Lateral border of foot touches the bed)</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Shortening</td>\n<td style=\"width: 257.984px; height: 18px;\">Less than 1 inch</td>\n<td style=\"width: 251.016px; height: 18px;\">More than 1 inch</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Treatment</td>\n<td style=\"width: 257.984px; height: 18px;\">Internal fixation always</td>\n<td style=\"width: 251.016px; height: 18px;\">Can be managed in traction</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 99px; height: 18px;\">Complications</td>\n<td style=\"width: 257.984px; height: 18px;\">Avascular necrosis and Non-union</td>\n<td style=\"width: 251.016px; height: 18px;\">Malunion</td>\n</tr>\n</tbody>\n</table>\n<p>Option B: In <strong>fracture neck of femur,&nbsp;</strong>the limb is in&nbsp;<strong>slight</strong>&nbsp;<strong>external rotation</strong> and <strong>shortening </strong>is<strong> &lt;1 inch.</strong></p>\n<p>Option C: In<strong> femoral shaft fractures</strong>, the limb is <strong>shortened</strong> with displaced proximal and distal fragments.</p>\n<p>Option D: In <strong>anterior dislocation</strong> of the hip, the limb is <strong>externally rotated</strong>. There may be a&nbsp;<strong>true lengthening</strong> of the limb with the femoral head palpable in the groin.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 69-year-old woman sustains an injury to the left hip after falling sideways on the floor. She is unable to move the left leg.  X-ray is given below. What is the best treatment for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Proximal femoral nail"
      },
      {
        "id": 2,
        "text": "McMurray's osteotomy"
      },
      {
        "id": 3,
        "text": "Total hip arthroplasty"
      },
      {
        "id": 4,
        "text": "Plaster in abduction and internal rotation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The intertrochanteric fractures of the femur can be treated by:</p>\n<ul>\n<li>Internal fixation with:\n<ul>\n<li>Intramedullary implants - proximal femoral nail and&nbsp;gamma nail</li>\n<li>Extramedullary implants - dynamic hip screw</li>\n</ul>\n</li>\n<li>Traction:\n<ul>\n<li>Russell's traction</li>\n<li>Thomas splint</li>\n</ul>\n</li>\n</ul>\n<p>Compared to the dynamic hip screw, the intramedullary fixation with proximal femoral nails have smaller incisions, decreased blood loss, decreased femoral neck shortening and decreased risk of infection.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7d6b7ecf983e45c5836170328e45af38.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d233a221e53f412cb046e25ea1a000edx426x354.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/23cee45afd4a428ba7e9a712f311a52cx1280x2056.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9fdf8be397fa469b94ec2c3dc0b23eaex1279x1265.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/608f83ef64a842e291c47428dcc7e35fx1279x1542.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dc3dc534cb61491d800e3eb6bbd5d098x1280x2018.JPEG"
    ]
  },
  {
    "text": "A 68-year-old lady comes with a history of fall and right-sided hip pain for 1 week. On examination, her right limb is shortened and externally rotated. Her X-ray shows no significant findings. What is your next step?",
    "choices": [
      {
        "id": 1,
        "text": "Send the patient home with analgesics for pain"
      },
      {
        "id": 2,
        "text": "Technetium bone scan within the next 24 hours"
      },
      {
        "id": 3,
        "text": "Order an MRI of the hip joint"
      },
      {
        "id": 4,
        "text": "Immobilise the limb and observe"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario is suggestive of <strong>occult neck of femur fracture</strong>, as the <strong>X-ray</strong> is <strong>normal</strong> but the <strong>attitude</strong> of the leg is <strong>abnormal</strong>. In such cases,&nbsp;<strong>MRI</strong> is the imaging study of choice.&nbsp;</p>\n<p>Both CT and MRI can detect the presence of fracture neck of femur. However, MRI can demonstrate the presence of <strong>soft tissue problems</strong> that can cause hip pain. It also does not expose the patient to radiation. Hence, <strong>MRI</strong> is <strong>preferred</strong> over CT&nbsp;in the diagnosis of occult femoral neck fractures.</p>\n<p>Technetium bone scan is an older method to detect occult fractures. They are less specific and may not show the presence of fracture if performed within 48-72 hours and in osteopenic bones.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young patient was brought to the casualty following a road traffic accident. The radiograph of the limb showed a fracture in the mid-shaft of the femur. What will be the direction of displacement of the distal fragment?",
    "choices": [
      {
        "id": 1,
        "text": "Abducted"
      },
      {
        "id": 2,
        "text": "Adducted"
      },
      {
        "id": 3,
        "text": "Flexed and externally rotated"
      },
      {
        "id": 4,
        "text": "Flexed and internally rotated"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<table style=\"height: 140px; width: 487.793px;\">\n<tbody>\n<tr>\n<td style=\"width: 468.793px;\" colspan=\"3\"><strong>Displacement of fracture fragments in the fracture shaft of femur</strong></td>\n</tr>\n<tr>\n<td style=\"width: 163px;\"><strong>Site of fracture</strong></td>\n<td style=\"width: 164px;\"><strong>Displacement of the proximal segment</strong></td>\n<td style=\"width: 141.793px;\"><strong>Displacement of distal fragment</strong></td>\n</tr>\n<tr>\n<td style=\"width: 163px;\">Proximal femoral shaft fractures</td>\n<td style=\"width: 164px;\">Flexed, abducted and externally rotated</td>\n<td style=\"width: 141.793px;\">Adducted</td>\n</tr>\n<tr>\n<td style=\"width: 163px;\">Mid-shaft femoral fractures</td>\n<td style=\"width: 164px;\">Flexed and externally rotated with minimal abduction</td>\n<td style=\"width: 141.793px;\">Adducted</td>\n</tr>\n<tr>\n<td style=\"width: 163px;\">Distal femoral shaft fractures</td>\n<td style=\"width: 164px;\">Adducted</td>\n<td style=\"width: 141.793px;\">Tilted by gastrocnemius pull</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dc7d9dd874c04af6b6a7b6773ab09f68x1280x1430.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9a9f7e4aadcb466999f6b46f96b76049x512x671.PNG"
    ]
  },
  {
    "text": "In which of the following conditions is maximum shortening of lower limb seen?",
    "choices": [
      {
        "id": 1,
        "text": "Inter-trochanteric fracture femur"
      },
      {
        "id": 2,
        "text": "Fracture neck of femur"
      },
      {
        "id": 3,
        "text": "Fracture shaft of femur"
      },
      {
        "id": 4,
        "text": "Transcervical fracture femur"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>From the given options, <strong>maximum shortening</strong> of the lower limb is seen in<strong>\u00a0</strong>the<strong> Inter-trochanteric fracture femur.</strong></p>\n<p>Overall, the maximum shortening of lower limbs is seen in <strong>posterior dislocation </strong>of the<strong> hip</strong> followed by Inter-trochanteric fracture femur.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 24-year old patient was brought to the emergency department after he lost control of his bike and hit a car while texting and driving. On examination, the patient had right thigh tenderness and deformity. The radiograph showed the following findings. What is the preferred method of treatment in the following scenario?",
    "choices": [
      {
        "id": 1,
        "text": "Locking compression plate"
      },
      {
        "id": 2,
        "text": "Intramedullary nail"
      },
      {
        "id": 3,
        "text": "External fixation with K wire"
      },
      {
        "id": 4,
        "text": "Traction with Thomas splint"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above radiograph shows a <strong>fracture</strong> in the <strong>shaft of femur</strong> with the displacement of fractured ends. The preferred method of treatment in this condition is an <strong>intramedullary nail</strong> with <strong>locking screws</strong>.</p>\n<p>Option A: <strong>Plating</strong> can be done in cases of <strong>comminuted</strong> fractures.</p>\n<p>Option C:<strong> External fixation </strong>is preferred in the treatment of severe <strong>open</strong> <strong>injuries</strong>, or when there is a severe bone loss that may require a bone graft.</p>\n<p>Option D: <strong>Thomas splint</strong> is used in the <strong>emergency</strong> treatment of shaft of femur fracture and some supracondylar fractures.</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 The main indications for traction are:\u00a0</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (1) fractures in children\u00a0</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (2) contraindications to anaesthesia or surgery\u00a0</p>\n<p>\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (3) lack of suitable skill or facilities for internal fixation</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/38bc31b39f6a47fb84d21ae61f77aa95.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A  9-year-old girl was run over by a car and was admitted to the hospital with obvious swelling and deformity of the left thigh. Her X-ray showed the following findings. What will be the preferred treatment in the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "Gallow's traction"
      },
      {
        "id": 2,
        "text": "Locked intramedullary nailing"
      },
      {
        "id": 3,
        "text": "Elastic intramedullary nailing"
      },
      {
        "id": 4,
        "text": "Spica casting"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The preferred treatment in children of ages<strong> 5-10 years</strong> with <strong>fracture shaft </strong>of the<strong> femur</strong> is <strong>elastic intramedullary nailing.</strong></p>\n<p>The image given below shows fracture shaft of femur treated with elastic intramedullary nailing.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f8b300ebca624ecda37ea7247b6a5d03.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b5ecab51e0a84a849359854b23e45032x512x142.PNG"
    ]
  },
  {
    "text": "A patient was admitted to ICU 48 hours after the fracture of the femur. The saturation of oxygen in the rebreathing unit was 100% but his Spo2 remained 60%. The patient was in a state of confusion. Chest radiograph showed lung fields to be clear. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary embolism"
      },
      {
        "id": 2,
        "text": "Fat embolism"
      },
      {
        "id": 3,
        "text": "ARDS"
      },
      {
        "id": 4,
        "text": "Occult pneumothorax"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In this clinical scenario, the presence of <strong>reduced SpO2</strong> and <strong>altered mental status</strong> in a patient presenting<strong> within 72 hours</strong> following a <strong>long bone fracture</strong> suggests the diagnosis of a <strong>fat embolism</strong>.</p>\n<p>Fat embolism is caused by the fat globules originating from the <strong>bone marrow</strong>&nbsp;following<strong>&nbsp;the fracture </strong>of <strong>long bones.</strong>&nbsp;Clinical features of fat embolism are usually seen <strong>within 72 hours</strong>. They include&nbsp;<strong>tachycardia, fever, breathlessness</strong>, <strong>petechiae,</strong><strong>&nbsp;confusion,</strong>and<strong> restlessness.&nbsp;Gurd's criteria</strong> is used for the diagnosis of fat embolism syndrome.</p>\n<p>There is no specific diagnostic test for fat embolism. However,<strong> urine analysis</strong> to detect <strong>fat globules</strong> and monitoring of blood pO2 levels are conducted.</p>\n<p>The management of fat embolism primarily involves supportive care, including <strong>oxygen therapy </strong>and<strong> prompt stabilization of long-bone fractures.</strong></p>\n<p>Option A: Pulmonary embolism most commonly occurs as a result of thrombi from <strong>deep vein thrombosis</strong> of the leg.&nbsp;</p>\n<p>Option C: Acute respiratory distress syndrome is diagnosed using the <strong>Berlin's criteria</strong>. <strong>All four</strong> of the following conditions must be met:</p>\n<ul>\n<li>It develops <strong>within 1 week</strong> of clinical insult or worsening respiratory symptoms.</li>\n<li>Chest radiograph shows <strong>bilateral opacities </strong>consistent with pulmonary edema. These opacities are not fully explained by effusions, lobar or lung collapse, or nodules.</li>\n<li>The edema is <strong>not</strong> due to <strong>cardiac failure</strong>, or <strong>fluid overload</strong>.</li>\n<li>There is <strong>impaired oxygenation</strong>.&nbsp;The ratio of arterial oxygen partial pressure to the fraction of inspired oxygen (<strong>PaO<sub>2</sub>/FiO<sub>2</sub></strong>) is <strong>&le; 300 mmHg</strong>&nbsp;as assessed on&nbsp;5 cm H<sub>2</sub>O of positive end-expiratory pressure (PEEP).</li>\n</ul>\n<p>Option D: Occult pneumothorax is a condition that is not suspected on the basis of the symptoms or plain radiography, but is detected with <strong>CT imaging</strong>. It usually follows a thoracic injury.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is considered a minor criterion for diagnosing fat embolism?",
    "choices": [
      {
        "id": 1,
        "text": "Subconjunctival petechiae"
      },
      {
        "id": 2,
        "text": "Fat globules in sputum"
      },
      {
        "id": 3,
        "text": "FiO2 < 0.4"
      },
      {
        "id": 4,
        "text": "CNS depression"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Fat globules </strong>in sputum is a <strong>minor criterion</strong> for diagnosing <strong>fat embolism</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '09 Fractures Of Femur';
        let hierarchy = ["Marrow", "qBank", "Orthopedics"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>