<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17 Amyloidosis And Graft Rejection - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pathology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which among the following best describes an amyloid?",
    "choices": [
      {
        "id": 1,
        "text": "Colloid"
      },
      {
        "id": 2,
        "text": "Lipoprotein"
      },
      {
        "id": 3,
        "text": "Proteoglycan"
      },
      {
        "id": 4,
        "text": "Intermediate filament"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Amyloid</strong> can be best described as a&nbsp;<strong>proteoglycan.</strong></p>\n<p><strong>Amyloidosis</strong> refers to the&nbsp;<strong>extracellular deposition</strong>&nbsp;of<strong> fibrillar proteins.&nbsp;</strong></p>\n<p>Abnormal fibrils are produced by the aggregation of misfolded proteins. The fibrillar deposits bind a wide variety of <strong>proteoglycans</strong> and <strong>glycosaminoglycans&nbsp;</strong>(heparan sulfate and dermatan sulfate), and plasma proteins (serum amyloid P component).</p>\n<p>The abundant charged sugar groups in these adsorbed proteins give the deposits staining characteristics that resemble starch <strong>(amylose).&nbsp;</strong>Therefore, these deposits are called amyloid.</p>\n<p>Amyloid appears as an <strong>amorphous, eosinophilic, hyaline, extracellular </strong>substance.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with reactive systemic amyloidosis, which of the following proteins are likely to get deposited in the tissues?",
    "choices": [
      {
        "id": 1,
        "text": "A\u03b2"
      },
      {
        "id": 2,
        "text": "AL"
      },
      {
        "id": 3,
        "text": "AA"
      },
      {
        "id": 4,
        "text": "APrP"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>There is the deposition of <strong>AA proteins </strong>in <strong>reactive systemic amyloidosis</strong> (secondary amyloidosis).</p>\n<p>In <strong>inflammatory </strong>states, there is&nbsp;a release of <strong>IL-1</strong> and<strong> IL-6,</strong>&nbsp;which act on the liver cells. The liver increases the production of <strong>SAA </strong>(serum amyloid-associated)<strong> proteins</strong>&nbsp;which circulate bound to<strong> high-density lipoproteins</strong>. This gives rise to<strong> AA proteins</strong>, which get <strong>deposited in tissues</strong> causing reactive systemic amyloidosis or secondary amyloidosis.</p>\n<p>The most common <strong>sites</strong> are the&nbsp;<strong>kidney</strong> and <strong>heart.</strong></p>\n<p>It is usually seen secondary to:</p>\n<ul>\n<li>Rheumatoid arthritis (most common)</li>\n<li>Tuberculosis</li>\n<li>Bronchiectasis</li>\n<li>Chronic osteomyelitis</li>\n<li>Inflammatory bowel disease</li>\n<li>Ankylosing spondylitis</li>\n<li>Malignancies - renal cell cancer,&nbsp;Hodgkin&rsquo;s lymphoma</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of reactive amyloidosis worldwide?",
    "choices": [
      {
        "id": 1,
        "text": "Rheumatoid arthritis"
      },
      {
        "id": 2,
        "text": "Multiple myeloma"
      },
      {
        "id": 3,
        "text": "Crohn's disease"
      },
      {
        "id": 4,
        "text": "Diabetes mellitus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>most common cause</strong> of <strong>reactive&nbsp;amyloidosis</strong> worldwide is&nbsp;<strong>rheumatoid arthritis.</strong></p>\n<p>Amyloidosis is reported to occur in 3% of patients with rheumatoid arthritis and is clinically significant in one-half of those affected.</p>\n<p>Conditions associated with reactive systemic (<strong>secondary</strong>) <strong>amyloidosis</strong>:</p>\n<ul>\n<li>Rheumatoid arthritis (most common)</li>\n<li>Ankylosing spondylitis</li>\n<li>Inflammatory bowel disease (Crohn's disease and ulcerative colitis)</li>\n<li>Tuberculosis&nbsp;</li>\n<li>Bronchiectasis</li>\n<li>Chronic osteomyelitis</li>\n<li>Malignancies - renal cell cancer,&nbsp;Hodgkin&rsquo;s lymphoma</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly woman is brought with worsening memory for the past 3 years. Recently, she has been unable to carry out her daily chores and frequently gets lost in the neighborhood. There is no history of personality changes, rigidity, or gait disturbances. MRI brain shows temporal lobe atrophy. Which of the following deposits is likely to be seen in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "A\u03b22m amyloid"
      },
      {
        "id": 2,
        "text": "A\u03b2 amyloid"
      },
      {
        "id": 3,
        "text": "ATTR amyloid"
      },
      {
        "id": 4,
        "text": "AIAPP amyloid"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario is suggestive of&nbsp;<strong>Alzheimer's</strong> disease.&nbsp;<strong>A&beta;</strong>&nbsp;<strong>amyloid</strong>&nbsp;deposition is seen in this condition.</p>\n<p>A&beta;&nbsp;constitutes the core of <strong>cerebral plaques</strong>&nbsp;found in <strong>Alzheimer's disease.&nbsp;</strong>It also gets deposited in the walls of cerebral blood vessels.&nbsp;The A&beta; protein is derived by proteolysis from a much larger transmembrane glycoprotein, called <strong>amyloid precursor protein</strong> (APP).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A diabetic patient with chronic kidney disease has been undergoing hemodialysis for the past 4 years. Deposition of which of the following is likely in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "\u03b11 microglobulin"
      },
      {
        "id": 2,
        "text": "\u03b22 microglobulin"
      },
      {
        "id": 3,
        "text": "\u03b12 macroglobulin"
      },
      {
        "id": 4,
        "text": "\u03b3 globulin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Patients on <strong>long-term hemodialysis</strong> for renal failure can develop <strong>amyloidosis</strong> as a result of the&nbsp;<strong>deposition</strong> of<strong> &beta;2-microglobulin</strong>.</p>\n<p>This protein is present in high concentrations in the serum of persons with renal disease.&nbsp;The protein is retained in the circulation because it cannot be filtered through the dialysis membranes.</p>\n<p>It gets deposited in the <strong>synovium, joints,</strong> and <strong>tendon sheaths.</strong> When this deposition takes place in the carpal ligament of the wrist, it leads to the development of&nbsp;<strong>carpal tunnel syndrome.</strong></p>\n<p>With new dialysis filters, the incidence of this complication has decreased substantially.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which type of amyloidosis is caused by the mutation of the transthyretin protein?",
    "choices": [
      {
        "id": 1,
        "text": "Familial Mediterranean fever"
      },
      {
        "id": 2,
        "text": "Familial amyloidotic polyneuropathy"
      },
      {
        "id": 3,
        "text": "Systemic senile amyloidosis"
      },
      {
        "id": 4,
        "text": "Reactive systemic amyloidosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Familial amyloidotic polyneuropathy&nbsp;</strong>(FAP) is&nbsp;associated&nbsp;with the deposition of&nbsp;<strong>mutant transthyretin</strong> protein (TTR).<strong>&nbsp;</strong></p>\n<p>FAP is an <strong>autosomal dominant</strong>&nbsp;condition. The deposition occurs as <strong>amyloid</strong> <strong>fibrils</strong> in peripheral and autonomic nerves. Mutated TTR is prone to misfolding and aggregation, and shows resistance to proteolysis.</p>\n<p><strong>Systemic senile amyloidosis </strong>(amyloid of aging) refers to the systemic deposition of <strong>normal TTR&nbsp;</strong>amyloid in elderly patients. Symptomatic patients present with restrictive cardiomyopathy and arrhythmias. Another rare form affecting&nbsp;predominantly the heart results from the deposition of a mutant form of TTR.</p>\n<p><strong>Familial Mediterranean fever</strong> (FMF) is an&nbsp;<strong>autosomal-recessive&nbsp;</strong>condition seen in individuals of Mediterranean descent (Armenian, Sephardic Jewish, and Arabic). The affected gene encodes a protein called <strong>pyrin,&nbsp;</strong>which is involved in cytokine production. The <strong>amyloid</strong> fibril proteins in this condition are made up of <strong>AA proteins.&nbsp;</strong>It presents with attacks of fever and serositis.&nbsp;</p>\n<p><strong>Isolated atrial amyloidosis&nbsp;</strong>is associated with AANP (atrial natriuretic peptide) amyloid deposition</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Who among the following patients is at increased risk for developing amyloidosis?",
    "choices": [
      {
        "id": 1,
        "text": "A patient with maturity-onset diabetes of the young"
      },
      {
        "id": 2,
        "text": "A 15-year-old diabetic boy who is on insulin therapy"
      },
      {
        "id": 3,
        "text": "A 50-year-old diabetic patient with insulin resistance"
      },
      {
        "id": 4,
        "text": "A patient with autosomal dominant non-insulin dependent form of diabetes"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Older individuals with insulin resistance are likely to have&nbsp;<strong>type 2</strong>&nbsp;<strong>diabetes mellitus</strong>. These patients are at <strong>increased risk</strong> of developing&nbsp;<strong>amyloidosis</strong>.<strong>&nbsp;</strong></p>\n<p>Microscopic deposits of localized amyloid may be found in certain conditions such as:</p>\n<ul>\n<li><strong>Medullary carcinoma</strong> of the thyroid gland</li>\n<li>Islet tumors of the pancreas</li>\n<li><strong>Pheochromocytomas</strong></li>\n<li>Undifferentiated <strong>carcinomas</strong> of the <strong>stomach</strong></li>\n<li>Islets of Langerhans in individuals with <strong>type 2 diabetes mellitus</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged woman presents with thyroid swelling. The histological examination of the swelling is shown below. What type of amyloid deposits are seen in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "A Cal"
      },
      {
        "id": 2,
        "text": "A\u03b22m"
      },
      {
        "id": 3,
        "text": "AL"
      },
      {
        "id": 4,
        "text": "A\u03b2"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Microscopic deposits of <strong>localized</strong> <strong>amyloid</strong> may be found in certain conditions such as:</p>\n<ul>\n<li><strong>Medullary carcinoma</strong> of the thyroid gland</li>\n<li>Islet tumors of the pancreas</li>\n<li><strong>Pheochromocytomas</strong></li>\n<li>Undifferentiated <strong>carcinomas</strong> of the <strong>stomach</strong></li>\n<li>Islets of Langerhans in individuals with <strong>type 2 diabetes mellitus</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/78b138cfc2d34f9d8f1c817638a23c2d.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6577164b622f423b80a57a1138ceffeex1280x1050.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/daaf0899043c4cd2bf648aae2e7d2fb5x1280x1050.JPEG"
    ]
  },
  {
    "text": "Which of the following is the most common organ involved in AL amyloidosis?",
    "choices": [
      {
        "id": 1,
        "text": "Cardiac tissue"
      },
      {
        "id": 2,
        "text": "Renal tissue"
      },
      {
        "id": 3,
        "text": "Splenic tissue"
      },
      {
        "id": 4,
        "text": "Hepatic tissue"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most common</strong> organ involved in AL amyloidosis is <strong>renal tissue</strong> (Kidneys). They are affected in 70&ndash;80% of patients with <strong>amyloidosis.</strong></p>\n<p><strong>Heart</strong> is the <strong>second most commonly</strong> affected organ (50&ndash;60%), and cardiac involvement is the <strong>leading cause</strong> of <strong>death</strong> from <strong>AL amyloidosis.</strong>&nbsp;</p>\n<p>Renal amyloidosis usually manifests as proteinuria, often in the nephrotic range, and is associated with hypoalbuminemia, secondary hypercholesterolemia, hypertriglyceridemia, and&nbsp;edema or anasarca.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4d53e868970141db984b159701708b15x1280x1060.JPEG"
    ]
  },
  {
    "text": "A bone marrow examination is being planned for a patient with AL amyloidosis. Which of the following is likely to be seen?",
    "choices": [
      {
        "id": 1,
        "text": "Plasmacytosis"
      },
      {
        "id": 2,
        "text": "Dry tap"
      },
      {
        "id": 3,
        "text": "Fibrosis"
      },
      {
        "id": 4,
        "text": "Granulomatous reaction"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Bone marrow</strong>&nbsp;examination in<strong> AL amyloidosis</strong> shows <strong>plasmacytosis.</strong></p>\n<p>The AL&nbsp;type of amyloid or <strong>primary amyloidosis</strong> is associated with immunocyte dyscrasias like<strong> multiple myeloma </strong>or other<strong> B cell neoplasms</strong>. The tumor cells in multiple myeloma secrete light chains of the immunoglobulins of either<strong>&nbsp;the lambda or kappa</strong> type, which get deposited in the tissues as amyloid.</p>\n<p>The chemical nature of the amyloid is AL (<strong>A </strong>for <strong>amyloid</strong> and<strong> L </strong>for <strong>light chain</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In lardaceous spleen, deposition of amyloid occurs in which of the following sites?",
    "choices": [
      {
        "id": 1,
        "text": "Sinusoids of red pulp"
      },
      {
        "id": 2,
        "text": "White pulp"
      },
      {
        "id": 3,
        "text": "Splenic follicles"
      },
      {
        "id": 4,
        "text": "Splenic capsule"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Lardaceous spleen</strong> is due to the deposition of amyloid in <strong>sinusoids</strong> of the&nbsp;<strong>red pulp.</strong></p>\n<p><strong>Sago spleen&nbsp;</strong>is due to the deposition of amyloid in splenic&nbsp;<strong>follicles (white pulp).</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Match the following.",
    "choices": [
      {
        "id": 1,
        "text": "1-b,  2-c, 3-a, 4-d"
      },
      {
        "id": 2,
        "text": "1-a,  2-d, 3-b, 4-c"
      },
      {
        "id": 3,
        "text": "1-c,  2-a, 3-d, 4-b"
      },
      {
        "id": 4,
        "text": "1-d,  2-b, 3-c, 4-a"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The correct match is:</p>\n<table style=\"height: 164px; width: 382px;\">\n<tbody>\n<tr style=\"height: 25px;\">\n<td style=\"width: 224.547px; text-align: center; height: 25px;\"><strong>Condition</strong></td>\n<td style=\"width: 141.453px; text-align: center; height: 25px;\"><strong>Amyloid protein</strong></td>\n</tr>\n<tr style=\"height: 25px;\">\n<td style=\"width: 224.547px; height: 25px;\">Familial Mediterranean fever</td>\n<td style=\"width: 141.453px; height: 25px;\">AA</td>\n</tr>\n<tr style=\"height: 25px;\">\n<td style=\"width: 224.547px; height: 25px;\">Alzheimer's disease</td>\n<td style=\"width: 141.453px; height: 25px;\">A&beta;</td>\n</tr>\n<tr style=\"height: 25px;\">\n<td style=\"width: 224.547px; height: 25px;\">Systemic senile amyloidosis</td>\n<td style=\"width: 141.453px; height: 25px;\">ATTR</td>\n</tr>\n<tr style=\"height: 20px;\">\n<td style=\"width: 224.547px; height: 20px;\">Hemodialysis-associated amyloidosis</td>\n<td style=\"width: 141.453px; height: 20px;\">A&beta;2m</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with suspected systemic amyloidosis, which of the following is the initial investigation of choice?",
    "choices": [
      {
        "id": 1,
        "text": "Kidney biopsy"
      },
      {
        "id": 2,
        "text": "Abdominal fat staining"
      },
      {
        "id": 3,
        "text": "Bone marrow aspiration"
      },
      {
        "id": 4,
        "text": "Rectal biopsy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In suspected <strong>systemic amyloidosis,</strong> the initial investigation of choice is&nbsp;<strong>abdominal fat aspirate staining.</strong></p>\n<p><strong>Diagnosis</strong> of amyloidosis involves the following:</p>\n<ul>\n<li><strong>Localized</strong> amyloidosis - biopsy the organ involved. e.g., kidney</li>\n<li><strong>Systemic</strong> amyloidosis - deposits can be found in any tissue of the body\n<ul>\n<li>Initial test - <strong>non-invasive</strong> test on easily accessible tissue (eg:&nbsp;<strong>abdominal fat</strong>) which is positive in &gt;80% of cases</li>\n<li>If this is <strong>negative</strong>&nbsp;- more <strong>invasive biopsies</strong> of the kidney, heart, lung or GI tract (rectal biopsy)&nbsp;</li>\n</ul>\n</li>\n<li><strong>Suspected AL</strong> amyloidosis - serum and urine <strong>electrophoresis</strong> and immunoelectrophoresis&nbsp;</li>\n</ul>\n<p>The <strong>histological examination</strong> of the biopsy material is the commonest <strong>confirmatory</strong> method for the diagnosis in a suspected case of amyloidosis. <span data-preserver-spaces=\"true\">The next best step is to determine the <strong>type</strong> of <strong>precursor protein</strong> by&nbsp;</span><strong><span data-preserver-spaces=\"true\">immunohistochemistry</span></strong><span data-preserver-spaces=\"true\">, immunoelectron microscopy, or extraction and biochemical analysis employing mass spectrometry.</span></p>\n<p><strong>Scintigraphy</strong> with <strong>radiolabeled </strong>serum amyloid P component is a rapid and specific test, which gives the extent of the disease. It can be used to follow up on patients undergoing treatment.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A kidney biopsy sample is obtained from a patient with high suspicion of amyloidosis. All of the following can be used to stain this sample, except:",
    "choices": [
      {
        "id": 1,
        "text": "Thioflavin"
      },
      {
        "id": 2,
        "text": "Crystal violet"
      },
      {
        "id": 3,
        "text": "Iodine"
      },
      {
        "id": 4,
        "text": "Sudan black"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Sudan Black</strong> is used for staining<strong> lipids,&nbsp;</strong>not amyloid.</p>\n<p>Staining for<strong> amyloid:</strong></p>\n<ul>\n<li><strong>Congo red</strong>&nbsp;- most widely used&nbsp;and specific&nbsp;</li>\n<li><strong>Iodine</strong> staining -\n<ul>\n<li>Used <strong>for unfixed specimens</strong> or histological sections</li>\n<li>Amyloid stains <strong>mahogany brown</strong> and <strong>turns</strong> <strong>violet&nbsp;</strong>on adding sulfuric acid</li>\n</ul>\n</li>\n<li><strong>Thioflavin T </strong>and<strong> S</strong>&nbsp;-\n<ul>\n<li>Secondary immunofluorescence with ultraviolet light</li>\n<li>Thioflavin T is useful for demonstrating the&nbsp;juxtaglomerular apparatus of the kidney</li>\n</ul>\n</li>\n<li>Metachromatic stains (<strong>crystal violet</strong> and methyl violet) -&nbsp;<strong>rose-pink</strong> appearance.</li>\n<li>Periodic-acid Schiff (<strong>PAS</strong>)<strong> positive</strong></li>\n</ul>\n<p>The image given below shows the amyloid appearance on congo red under plain microscopy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/07bfaaf781bc40048c283f4613e412a1x1280x1078.JPEG"
    ]
  },
  {
    "text": "A pathologist is examining a sample from a patient with amyloidosis. Which of the following is false about the specimen's appearance?",
    "choices": [
      {
        "id": 1,
        "text": "Pink-red color on Congo-red staining"
      },
      {
        "id": 2,
        "text": "Rose pink appearance under crystal violet stain"
      },
      {
        "id": 3,
        "text": "Apple-green birefringence under light microscopy"
      },
      {
        "id": 4,
        "text": "Mahogany brown color on iodine staining"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<ul>\n<li><strong>Electron</strong> microscopy -<strong>&nbsp;</strong>continuous, nonbranching fibrils with a diameter of approximately 7.5 to 10 nm</li>\n<li>X-ray <strong>crystallography</strong> and infrared <strong>spectroscopy</strong> -&nbsp;Characteristic cross-&beta;-pleated sheet conformation.</li>\n</ul>\n<p>It appears <strong>mahogany brown</strong> on <strong>iodine</strong> staining and <strong>rose-pink</strong> on staining with <strong>crystal violet.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c830681cfff74d1ea88558d3c6f69e70x1280x1078.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/daea5316aae14b58bd2ef2d0c79acb00x800x573.PNG"
    ]
  },
  {
    "text": "Which of the following is not directly involved in graft rejection?",
    "choices": [
      {
        "id": 1,
        "text": "T-Cells"
      },
      {
        "id": 2,
        "text": "Antibodies"
      },
      {
        "id": 3,
        "text": "Macrophages"
      },
      {
        "id": 4,
        "text": "NK cells"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Macrophages present foreign graft antigens to the T-cells but are not directly involved in <strong>graft rejection</strong>.</p>\n<p>Graft rejection<strong>&nbsp;</strong>is both <strong>humoral</strong> and <strong>cell-mediated</strong> in nature. It&nbsp;is a process in which <strong>T-cells</strong> and <strong>antibodies</strong> produced against graft antigens react against tissue grafts and destroy it.</p>\n<p>The major antigenic differences that result in the <strong>rejection</strong> of transplants are differences in <strong>HLA alleles</strong>. The <strong>recipient</strong> <strong>T-cells</strong> are involved in the&nbsp;<strong>recognition </strong>of&nbsp;the <strong>donor MHC</strong> molecules and mount an immune response. Depending on the antigen-presenting cells (APCs) that are involved in T-cell activation, there are 2 pathways:</p>\n<ul>\n<li>Direct pathway of allorecognition - MHC antigens are presented by the <strong>APCs</strong> in the <strong>graft</strong></li>\n<li>Indirect pathway of allorecognition -&nbsp;MHC antigens are presented by&nbsp;the <strong>recipient&rsquo;s</strong> <strong>own</strong> <strong>APCs</strong> (e.g., macrophages)</li>\n</ul>\n<p>The <strong>early activation</strong> of <strong>NK cells</strong> kill allogeneic target cells directly or via antibody-dependent cellular cytotoxicity and release various chemokines and immunomodulatory cytokines.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A man is receiving a matched blood group kidney allograft. While closing the abdomen, the surgeon notices a sudden color change to pale-white in the transplanted kidney. He decides to remove it. Which of the following is responsible for graft rejection in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Preformed antibodies in the recipient"
      },
      {
        "id": 2,
        "text": "Cytotoxic T lymphocyte\u2013mediated injury"
      },
      {
        "id": 3,
        "text": "Tubulointerstitial inflammation due to antibodies"
      },
      {
        "id": 4,
        "text": "Donor antibodies causing endotheliitis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario within minutes of transplant is suggestive of <strong>hyperacute rejection</strong> and is due to <strong>preformed antibodies</strong>&nbsp;from the <strong>recipient.</strong>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient underwent kidney transplantation due to severe diabetic nephropathy. A few months later, he presented with fever, malaise, and flank pain. During evaluation, oliguria and an acute rise in creatinine levels were observed. A biopsy of the kidney showed endotheliitis. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Acute cell-mediated graft rejection"
      },
      {
        "id": 2,
        "text": "Acute antibody mediated graft rejection"
      },
      {
        "id": 3,
        "text": "Chronic graft rejection"
      },
      {
        "id": 4,
        "text": "Graft vs host disease"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Immunosuppressive therapy</strong>&nbsp;aims to prevent and reduce acute rejection by blocking the activation of alloreactive T cells. In the absence of humoral rejection, patients respond well to immunosuppressive therapy.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In patients with acute graft-versus-host disease, which of the following organs is least likely to be involved?",
    "choices": [
      {
        "id": 1,
        "text": "Skin"
      },
      {
        "id": 2,
        "text": "GIT"
      },
      {
        "id": 3,
        "text": "Liver"
      },
      {
        "id": 4,
        "text": "Lung"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The lung is least likely to get affected in <strong>acute graft-versus-host disease</strong>&nbsp;(GVHD).</p>\n<p>GVHD&nbsp;occurs when immunologically competent cells or their precursors are transplanted into immunologically crippled recipients. The transferred cells recognize alloantigens in the host and attack host tissues.</p>\n<p>It is seen <strong>most commonly</strong> in the setting of hematopoietic stem cell (<strong>HSC</strong>) <strong>transplantation.</strong>&nbsp;Rarely, it may occur following transplantation of solid organs rich in lymphoid cells (e.g., the liver) or transfusion of <strong>unirradiated blood.</strong>&nbsp;</p>\n<p>It is of two types, acute and chronic.</p>\n<p><strong>Acute GVHD&nbsp;</strong>develops within <strong>days to weeks</strong><strong>.&nbsp;</strong>There is the involvement of the <strong>immune system</strong> and <strong>epithelium</strong>&nbsp;of the skin, liver, and intestines. It presents with:</p>\n<ul>\n<li>Generalized rash</li>\n<li>Jaundice</li>\n<li>Bloody diarrhea due to mucosal ulceration</li>\n<li>Non-infectious pulmonary infiltrates (rarely), the outcome is generally poor</li>\n</ul>\n<p><strong>Chronic GVHD&nbsp;</strong>may follow the acute syndrome or occur insidiously. It presents with:</p>\n<ul>\n<li>Skin -&nbsp;extensive<strong> cutaneous injury,</strong> with the destruction of skin appendages and dermal fibrosis (may resemble <strong>systemic sclerosis)</strong></li>\n<li>Liver<strong> - chronic liver disease,</strong> manifested as cholestatic jaundice</li>\n<li>GIT - <strong>esophageal strictures</strong></li>\n<li><strong>Immune system</strong> involvement - involution of the thymus and depletion of lymphocytes</li>\n</ul>\n<p>GVHD is <strong>mediated by T lymphocytes</strong> contained in the transplanted <strong>donor cells.&nbsp;</strong>Therefore,&nbsp;depletion of donor T cells before transfusion virtually eliminates the disease.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Graft from identical twin is called:",
    "choices": [
      {
        "id": 1,
        "text": "Allograft"
      },
      {
        "id": 2,
        "text": "Autograft"
      },
      {
        "id": 3,
        "text": "Isograft"
      },
      {
        "id": 4,
        "text": "Xenograft"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A graft from an<strong> identical twin</strong> is called an&nbsp;<strong>isograft</strong>.</p>\n<p><strong>Isograft</strong> is defined as an organ or tissue that is taken from a donor and is transplanted to a recipient who has the <strong>same genetic constitution</strong> as the donor. For example, graft between<strong> identical twins.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '17 Amyloidosis And Graft Rejection';
        let hierarchy = ["Marrow", "qBank", "Pathology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>