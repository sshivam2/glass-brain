<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33 Fibroid - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Obstetrics & Gynecology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">26</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following statements is false about fibroids?",
    "choices": [
      {
        "id": 1,
        "text": "More common in Asians than African-Americans"
      },
      {
        "id": 2,
        "text": "Smoking is a protective factor"
      },
      {
        "id": 3,
        "text": "More common in nulliparous women"
      },
      {
        "id": 4,
        "text": "Does not usually increase in size during pregnancy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Fibroids</strong> are more common in <strong>African-American</strong> women.</p>\n<p>Uterine fibroids are benign, smooth muscle tumors present in the uterine musculature. They are most commonly seen during <strong>reproductive years</strong>.&nbsp;Estrogen and progesterone promote the development of fibroids.</p>\n<p>Option B: <strong>Hypoestrogenism</strong> occurs in <strong>smokers,</strong> therefore smoking is <strong>protective</strong> for fibroids.</p>\n<p>Option C: Estrogen exposure is increased in nulliparous women, therefore fibroids are more common. <strong>Increased parity</strong> is <strong>protective</strong> for fibroids.</p>\n<p>Option D: Most fibroids do not increase in size during <strong>pregnancy.</strong> Pregnancy can have an <strong>unpredictable effect</strong> on fibroids based on individual genetic and environmental factors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following genes is not associated with leiomyomas?",
    "choices": [
      {
        "id": 1,
        "text": "MED12"
      },
      {
        "id": 2,
        "text": "HMGA2"
      },
      {
        "id": 3,
        "text": "COL4A5-A6"
      },
      {
        "id": 4,
        "text": "MLH1"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>MLH1 gene</strong> is not associated with leiomyomas. Its mutation leads to<strong> endometrial carcinoma</strong>.</p>\n<p><strong>MED12</strong> and <strong>HMGA2</strong>&nbsp;are the most common genes associated with <strong>leiomyomas</strong>. Other genes involved are <strong>COL4A5-A6</strong> and the gene for<strong> fumarate hydratase</strong> (FH). FH gene mutation leads to hereditary leiomyomatosis and renal cell cancer (HLRCC) syndrome.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Leiomyomas create a hyperestrogenic state by all of these mechanisms except:",
    "choices": [
      {
        "id": 1,
        "text": "Cells contain a greater density of estrogen receptors"
      },
      {
        "id": 2,
        "text": "Metabolise androgens to estrogen"
      },
      {
        "id": 3,
        "text": "Have higher levels of cytochrome P450 aromatase"
      },
      {
        "id": 4,
        "text": "Maximally convert estradiol to estrone"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Leiomyomas&nbsp;<strong>convert less estradiol</strong> to the weaker estrone.</p>\n<p>Leiomyomas create a <strong>hyperestrogenic environment</strong>, which is a<strong> requisite for</strong> their <strong>growth</strong> and maintenance. The hyperestrogenic environment is created by the following mechanisms:&nbsp;</p>\n<ul>\n<li>Compared to normal myometrium, leiomyoma cells contain a greater density of estrogen receptors, which results in greater estradiol binding.</li>\n<li>These tumors convert less estradiol to the weaker estrone.</li>\n<li>There are higher levels of cytochrome P450 aromatase in leiomyomas compared with normal myocytes. This specific enzyme catalyzes the conversion of androgens to estrogen.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Initially, all fibroids are ____.",
    "choices": [
      {
        "id": 1,
        "text": "Intramural"
      },
      {
        "id": 2,
        "text": "Submucosal"
      },
      {
        "id": 3,
        "text": "Subserous"
      },
      {
        "id": 4,
        "text": "Cervical"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Initially, all fibroids are <strong>intramural</strong>. Fibroids develop <strong>in the myometrium</strong>, as intramural/interstitial and then&nbsp;branch out to form the other types.</p>\n<p><strong>Classification of fibroids</strong> based on anatomical location:</p>\n<ul>\n<li>Body (corporeal) fibroids-\n<ul>\n<li>Interstitial/<strong>intramural</strong> fibroids: They are the <strong>most common</strong> (75%).&nbsp;</li>\n<li><strong>Subserosal</strong> fibroids: They are the <strong>least common</strong> (10%). Interstitial fibroids grow outwards to form subserous fibroids and are covered by the peritoneum. These include wandering or <strong>parasitic fibroids</strong> and broad ligament fibroids.</li>\n<li><strong>Submucous</strong> fibroids: Interstitial fibroid grows inwards towards the uterine cavity. It is the&nbsp;<strong>most symptomatic</strong> type.</li>\n</ul>\n</li>\n<li>Cervical fibroids&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c2804e97c79d4f5b9079343806cf4153x1280x1415.JPEG"
    ]
  },
  {
    "text": "A 55-year-old lady comes with abnormal uterine bleeding. A hysterectomy was performed and the following specimen was retrieved. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Leiomyoma"
      },
      {
        "id": 2,
        "text": "Endometrial carcinoma"
      },
      {
        "id": 3,
        "text": "Endometrial polyp"
      },
      {
        "id": 4,
        "text": "Adenomyosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Sub-mucous fibroids are the most symptomatic type and intra-mural fibroids are the most common type of uterine fibroids.</p>\n<p>Other options:</p>\n<p>Option B: Endometrial cancer&nbsp;presents as a <strong>polypoid</strong> mass protruding into the uterine cavity or as a <strong>diffuse thickening</strong> of the endometrium. The cut surface may appear <strong>white</strong> to <strong>yellow</strong> and may show <strong>areas</strong> of <strong>necrosis</strong> or <strong>hemorrhage.</strong></p>\n<p>Option C: Endometrial polyps are usually small and may be single or multiple. Grossly, they appear as soft, <strong>red to pink</strong>, often <strong>pedunculated</strong> (attached by a stalk) masses <strong>protruding</strong> into the uterine <strong>cavity.&nbsp;</strong>It presents with <strong>heavy cyclic</strong> or<strong> intermenstrual bleeding</strong>, or without complaints as an<strong> incidental</strong> finding on imaging.&nbsp;<strong>Estrogen</strong> and<strong> progesterone </strong>have been implicated in the <strong>growth</strong> of endometrial<strong> polyps</strong>, and higher receptor levels are seen compared with the normal endometrium.</p>\n<p>Option D: In Adenomyosis (Endometriosis interna),&nbsp;the uterus may appear <strong>bulky</strong> and symmetrically&nbsp;<strong>enlarged.</strong> On the cut section, the myometrium may appear <strong>thickened</strong> and may show tiny <strong>cystic</strong> spaces filled with <strong>old blood</strong> (chocolate cysts). The preferred treatment is hysterectomy. Localised excision or levonorgestrel IUCD is tried in younger women.</p>\n<p>The image below shows both the gross and histologic appearances of adenomyosis:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/be7abfd8ec1740d6bba3fefd5efbc24b.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c9c5a24cfd6545e49fd479455b302edcx1280x1415.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/25e1ad9b1ba54dbfb796a7ee6617e471x1280x1698.PNG"
    ]
  },
  {
    "text": "Which of the following symptoms would you not expect in a patient diagnosed with uterine fibroids?",
    "choices": [
      {
        "id": 1,
        "text": "1 and 2"
      },
      {
        "id": 2,
        "text": "2 and 3"
      },
      {
        "id": 3,
        "text": "2, 4 and 5"
      },
      {
        "id": 4,
        "text": "1, 3 and 5"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Menouria and hypomenorrhea are not seen in patients with uterine fibroids.<strong> Menouria</strong> occurs due to\u00a0<strong>vesicouterine fistulas</strong>. <strong>Hypomenorrhea</strong> is seen in <strong>Asherman's</strong> syndrome and due to <strong>OCP</strong> use.</p>\n<p><strong>Fibroids</strong> present with the following<strong> clinical features</strong>:</p>\n<ul>\n<li>Menstrual symptoms such as:\n<ul>\n<li>Menstrual irregularities -\u00a0heavy menstrual bleeding/<strong>menorrhagia</strong> which is the <strong>most common</strong> symptom, polymenorrhoea, and intermenstrual bleeding (<strong>metrorrhagia</strong>)</li>\n<li><strong>Dysmenorrhea</strong></li>\n<li>Postmenopausal bleeding</li>\n</ul>\n</li>\n<li>Abdominal pain</li>\n<li>Abdominal distension, mass abdomen</li>\n<li>Vaginal discharge</li>\n<li>Infertility\u00a0</li>\n<li>Recurrent abortions\u00a0</li>\n<li>Pressure symptoms such as:\n<ul>\n<li>Urinary retention</li>\n<li>Increased frequency of urination</li>\n<li>Constipation</li>\n</ul>\n</li>\n<li>Broad ligament fibroids can cause compression of the ureter leading to hydronephrosis or hydroureter.</li>\n</ul>\n<div class=\"ng-scope\">\n<div class=\"ng-scope\">\n<p>\u00a0</p>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented with intermenstrual bleeding for the past 6 months. Which of the following types of fibroid is usually associated with this symptom?",
    "choices": [
      {
        "id": 1,
        "text": "Interstitial"
      },
      {
        "id": 2,
        "text": "Subserosal"
      },
      {
        "id": 3,
        "text": "Submucous"
      },
      {
        "id": 4,
        "text": "Cervical"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Intermenstrual bleeding is common with <strong>submucous fibroids. </strong>Metrorrhagia or&nbsp;<strong>intermenstrual bleeding</strong>&nbsp;refers to bleeding that occurs during the middle of the menstrual cycle.</p>\n<p>Metrorrhagia in a woman <strong>over 40 years</strong> warrants a&nbsp;<strong>dilatation and curettage </strong>procedure<strong>&nbsp;</strong>to rule out endometrial cancer.&nbsp;This is associated with fibroids in 3% of cases.</p>\n<p><strong>Polymenorrhoea </strong>in a patient with fibroids occurs when she has <strong>polycystic ovaries</strong> or pelvic inflammatory disease (<strong>PID</strong>).</p>\n<p><strong>Progressive menorrhagia&nbsp;</strong>is seen&nbsp;in<strong> intramural</strong> and<strong> submucous</strong> myoma due to increased vascularity, endometrial hyperplasia, and an enlarged uterine cavity.</p>\n<p>Note: Further the distance of the fibroid from the cavity, lesser is the possibility of menorrhagia. For this reason, subserous and pedunculated fibroids do not cause menorrhagia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 46-year-old woman presented with heavy menstrual bleeding and dysmenorrhea. You suspect a diagnosis of submucous uterine fibroids. Which of the following investigations will help you confirm this?",
    "choices": [
      {
        "id": 1,
        "text": "2 and 3"
      },
      {
        "id": 2,
        "text": "1, 2 and 3"
      },
      {
        "id": 3,
        "text": "4 and 5"
      },
      {
        "id": 4,
        "text": "1, 2 and 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>&nbsp;</p>\n<p>The image given below shows <strong>hysteroscopic view</strong> of a <strong>submucous fibroid</strong>:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/742bfb1eeda44120b645d4f34b8f62f2x550x497.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8af0257787374ac4a546cce476c0fbe5x550x513.PNG"
    ]
  },
  {
    "text": "An adnexal mass seen on ultrasound in a 38-year-old woman was diagnosed to be a secondary broad ligament fibroid. Which of the following is true about the same?",
    "choices": [
      {
        "id": 1,
        "text": "It arises from the broad ligament"
      },
      {
        "id": 2,
        "text": "The uterine vessels always lie medial to it"
      },
      {
        "id": 3,
        "text": "The ureter always lies lateral to it"
      },
      {
        "id": 4,
        "text": "It is also known as true broad ligament fibroid"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>ureter</strong> and uterine vessels lie <strong>lateral</strong> to a secondary broad ligament fibroid.</p>\n<p>There are <strong>2 types of broad ligament fibroids</strong>:</p>\n<p><strong>Primary</strong>&nbsp;broad ligament fibroid:</p>\n<ul>\n<li>It is also known as <strong>true </strong>broad ligament fibroid.</li>\n<li>The <strong>arise from</strong>:\n<ul>\n<li>Uterosacral ligament</li>\n<li>Round ligament</li>\n<li>Tissues in the <strong>broad ligament</strong></li>\n</ul>\n</li>\n<li>Relations:\n<ul>\n<li>The <strong>uterine vessels</strong> lie <strong>medial</strong> to it.</li>\n<li>The ureter is usually beneath the fibroid. However, it can be present anywhere in relation to it.</li>\n</ul>\n</li>\n</ul>\n<p><strong>Secondary</strong>&nbsp;broad ligament fibroid:</p>\n<ul>\n<li>It is also known as <strong>false&nbsp;</strong>broad ligament fibroid.</li>\n<li>They <strong>arise from</strong> the lateral wall of the <strong>uterus</strong> or <strong>cervix,</strong> but grow laterally, between the two layers of the broad ligament.</li>\n<li>Relations - the <strong>uterine vessels</strong> and ureter lie <strong>lateral</strong> to it.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is incorrect about fibroids?",
    "choices": [
      {
        "id": 1,
        "text": "Calcification begins at the centre"
      },
      {
        "id": 2,
        "text": "Hyaline degeneration begins at the centre"
      },
      {
        "id": 3,
        "text": "Centre is least vascular"
      },
      {
        "id": 4,
        "text": "Pseudocapsule is present"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The below image shows the histological appearance of fibroids.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/98dda6d88f154d28adfc1ac6d6edfddex1280x747.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ffdca55995ca4676bad16b42b292cdc1x720x542.JPEG"
    ]
  },
  {
    "text": "A patient with a history of miscarriage underwent a myomectomy. The specimen is shown below. Where does the degenerative change shown here begin from?",
    "choices": [
      {
        "id": 1,
        "text": "Centre"
      },
      {
        "id": 2,
        "text": "Periphery"
      },
      {
        "id": 3,
        "text": "Subcapsular area"
      },
      {
        "id": 4,
        "text": "Extracapsular area"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given specimen shows <strong>red degeneration</strong> of fibroid. Degeneration is most likely to start from the <strong>centre</strong> of the fibroid.&nbsp;</p>\n<p>In a fibroid, centre of the tumor is the <strong>least vascular</strong> part and hence degeneration is more common here. The only exception is&nbsp;<strong>calcareous</strong> degeneration where phosphates and carbonates of lime are deposited in the <strong>periphery</strong> along the course of the vessels.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/8d5c702feea74e3e9a81b2f5b496a70f.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 44-year-old woman presenting with acute abdominal pain had previously been diagnosed with uterine fibroids. Which of the following complications is most unlikely to have occurred here?",
    "choices": [
      {
        "id": 1,
        "text": "Hemorrhage into the fibroid"
      },
      {
        "id": 2,
        "text": "Hyaline degeneration"
      },
      {
        "id": 3,
        "text": "Red degeneration"
      },
      {
        "id": 4,
        "text": "Sarcomatous change"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hyaline degeneration</strong> of fibroids is unlikely here as it is <strong>usually painless</strong> and presents as an abdominal mass causing distension and heaviness.</p>\n<p><strong>Acute pain in fibroids</strong> is seen in the case of:&nbsp;</p>\n<ul>\n<li>Fibroid torsion</li>\n<li>Hemorrhage into the fibroid</li>\n<li>Red degeneration</li>\n<li>Sarcomatous change - seen in postmenopausal women.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A primigravida presented with severe abdominal pain and fever at 28 weeks of gestation. Ultrasound reveals a healthy fetus in utero and a large submucosal fibroid with multiple, hyperechoic areas within. Blood investigations reveal leukocytosis and a raised ESR. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Red degeneration of fibroid"
      },
      {
        "id": 2,
        "text": "Torsion of fibroid"
      },
      {
        "id": 3,
        "text": "Infection of fibroid"
      },
      {
        "id": 4,
        "text": "Sarcomatous change"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option B: <strong>Torsion</strong> of subserous pedunculated fibroid presents with severe pain abdomen, but <strong>fever</strong> and<strong> leukocytosis</strong> are <strong>absent</strong>.</p>\n<p>Option C: <strong>Infection</strong> is more common in<strong> puerperium</strong> and presents with blood-stained vaginal discharge.</p>\n<p>Option D: <strong>Sarcomatous</strong> changes occur very rarely, and are unlikely in patients &lt;40 years of age. They are more commonly seen in <strong>post-menopausal</strong> women.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/21c2ef86922947c4ad0400ef52062a7ex605x269.JPEG"
    ]
  },
  {
    "text": "A 34-year old woman with a history of fibroids presented with 1.5 months of amenorrhea. UPT is positive. Which of the following complications will you not expect in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Uterine inversion"
      },
      {
        "id": 2,
        "text": "Red degeneration"
      },
      {
        "id": 3,
        "text": "Postpartum hemorrhage"
      },
      {
        "id": 4,
        "text": "Fetal malformations"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Fetal malformations have not been recorded to occur due to fibroids.&nbsp;</p>\n<p><strong>Pregnancy complications&nbsp;due to fibroids</strong> are:</p>\n<ul>\n<li>Increased risk of abortion or miscarriage</li>\n<li>Preterm labor</li>\n<li>Abnormal presentation</li>\n<li><strong>Fibroid degeneration </strong>(Red degenaration)</li>\n<li>Accidental hemorrhage</li>\n<li>Dystocic labor</li>\n<li><strong>Postpartum hemorrhage</strong></li>\n<li>Puerperal sepsis</li>\n<li><strong>Uterine inversion</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following changes are not seen in fibroids?",
    "choices": [
      {
        "id": 1,
        "text": "Necrosis"
      },
      {
        "id": 2,
        "text": "Squamous metaplasia"
      },
      {
        "id": 3,
        "text": "Atrophy"
      },
      {
        "id": 4,
        "text": "Sarcomatous changes"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Squamous metaplasia is not seen in fibroid.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "CT pelvis of a woman with fibroids is shown below. Which type of degeneration is seen here?",
    "choices": [
      {
        "id": 1,
        "text": "Hyaline degeneration"
      },
      {
        "id": 2,
        "text": "Cystic degeneration"
      },
      {
        "id": 3,
        "text": "Calcific degeneration"
      },
      {
        "id": 4,
        "text": "Hemorrhagic degeneration"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image shows&nbsp;<strong>womb-stone appearance</strong> on CT, suggestive of&nbsp;<strong>calcific degeneration</strong>&nbsp;of fibroid.</p>\n<p>These are also called calcareous myomas and are seen in&nbsp;<strong>old patients</strong> with <strong>long-standing myomas</strong>. This occurs due to the deposition calcium&nbsp;<strong>phosphates</strong> and calcium&nbsp;<strong>carbonates</strong>&nbsp;in the <strong>periphery</strong> of the fibroid, along the course of the vessels. It is easily visualized on radiography.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1f0670c7154143fbae2dc3e59a16e49c.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "What is the least common secondary change seen in fibroids?",
    "choices": [
      {
        "id": 1,
        "text": "Hemorrhage into fibroid"
      },
      {
        "id": 2,
        "text": "Sarcomatous change"
      },
      {
        "id": 3,
        "text": "Atrophy"
      },
      {
        "id": 4,
        "text": "Necrosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Sarcomatous change</strong> is the<strong> least common</strong> secondary change in fibroids. Its incidence is <strong>&lt;0.5%.&nbsp;</strong></p>\n<p>Sarcomatous change leads to the development of malignant leiomyosarcomas. This is seen in <strong>postmenopausal</strong> women and is rare in women &lt;40 years of age.&nbsp;<strong>Intramural</strong> and <strong>submucous</strong> tumors have a <strong>higher potential</strong> for sarcomatous change than subserous tumors.</p>\n<p>Its <strong>gross appearance</strong> is described as follows:</p>\n<ul>\n<li>Soft consistency</li>\n<li>Yellowish-grey</li>\n<li>Hemorrhagic spots seen&nbsp;</li>\n</ul>\n<p><strong>Radiology</strong> shows <strong>dark, irregular areas</strong>&nbsp;and <strong>air levels</strong> within the fibroid. These are indicative of sarcomatous change.</p>\n<p>The image given below shows the CT appearance of a large fibroid that has undergone sarcomatous change. The image on the right shows a fluid level within the tumor.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/71f80d3c9eb14716b4aa70b00d661addx606x282.JPEG"
    ]
  },
  {
    "text": "A 46-year-old woman presents with a lower abdominal mass for the past 2 years. She had undergone uterine artery embolisation for fibroids 5 years ago. Ultrasound showed a homogeneous mass near the uterine fundus. On exploratory laparotomy,  the mass was observed to be attached to the greater omentum and it was excised. Histopathology of the mass is shown below. What is your diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pedunculated fibroid"
      },
      {
        "id": 2,
        "text": "Parasitic fibroid"
      },
      {
        "id": 3,
        "text": "Leiomyosarcoma"
      },
      {
        "id": 4,
        "text": "Disseminated intraperitoneal leiomyomatosis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given case scenario is suggestive of a<strong> parasitic fibroid.</strong>&nbsp; The given histopathological image shows&nbsp;<strong>interlacing </strong>bundles of uniform&nbsp;<strong>spindle-shaped smooth muscle</strong>&nbsp;cells with blunted nuclei that are characteristic of a fibroid.</p>\n<p>A parasitic fibroid or a wandering fibroid gets<strong>&nbsp;cut off</strong> <strong>from</strong> its <strong>uterine origin</strong> and derives its blood supply from the vessels of the organ it is attached to. Thus, it can continue to grow in spite of uterine artery embolisation. It is managed by complete resection.</p>\n<p>Option A: <strong>Pedunculated fibroids</strong> have a pedicle with which they're <strong>attached</strong> to the <strong>myometrium</strong>.&nbsp;</p>\n<p>Option C: <strong>Leiomyosarcoma</strong> commonly presents in postmenopausal women with <strong>sudden increase</strong> in size and postmenopausal bleeding. It would show <strong>nuclear atypia</strong> on histology.</p>\n<p>Option D:&nbsp;<strong>Disseminated intraperitoneal leiomyomatosis</strong>&nbsp;involves<strong> large areas</strong> of <strong>sub peritoneal</strong> surfaces. It is seen during pregnancy and while on oral contraceptives.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/81f7fe55dbf94bf591753d711ee3e68e.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A pregnant woman with a fibroid uterus develops severe acute pain abdomen at 28 weeks of gestation. There is no history of fever and the WBC count is 8000 cells/mL.  The most likely diagnosis is:",
    "choices": [
      {
        "id": 1,
        "text": "Red degeneration of fibroid"
      },
      {
        "id": 2,
        "text": "Preterm labour"
      },
      {
        "id": 3,
        "text": "Torsion of fibroid"
      },
      {
        "id": 4,
        "text": "None of the above"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given scenario of <strong>severe acute abdominal pain</strong> <strong>without fever/leucocytosis</strong> in a pregnant woman with a fibroid is suggestive of <strong>fibroid torsion.</strong></p>\n<p>The incidence of fibroid in pregnancy is about 1 in 1,000. Due to increased vascularity in pregnancy, the fibroid increases in size and becomes softer. <strong>The torsion</strong> is seen in the <strong>subserous pedunculated fibroid</strong> where the venous return is blocked at its site of attachment in the uterus. This leads to severe acute abdominal pain. Due to the complication being more local than systemic, <strong>fever or leucocytosis </strong>are generally<strong> not seen</strong>.</p>\n<p>A transvaginal ultrasonogram is immediately done to detect the position and size of the fibroid, which is followed by <strong>laparotomic</strong> <strong>myomectomy</strong> as a part of emergency surgical management.&nbsp;</p>\n<p>Other options:</p>\n<p>Option A: <strong>Red degeneration of fibroid</strong> is seen commonly in the <strong>second</strong> <strong>half</strong> of pregnancy or puerperium. It is due to a <strong>hemorrhagic</strong> <strong>infarction</strong> of the tissue and typically presents as <strong>acute</strong> <strong>focal</strong> <strong>abdominal</strong> <strong>pain</strong> with <strong>fever</strong> and <strong>leucocytosis</strong>. Treatment is usually conservative with bed rest, analgesics, and sedatives.</p>\n<p>Option B: <strong>Preterm</strong> <strong>labor</strong> is where the labor starts before 37 completed weeks. It is characterized by true labor pain. The abdominal pain is <strong>slowly increasing in intensity and duration</strong> and is also accompanied by <strong>show</strong> (expulsion of the cervical mucus plug). There are <strong>intervals</strong> between <strong>episodes</strong> of contractions where the patient <strong>doesn't complain of abdominal pain</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A primigravida at 24 weeks presents to you for a routine antenatal checkup. On ultrasound, you incidentally note the presence of two 3x3cm submucosal fibroids. How will you manage this case?",
    "choices": [
      {
        "id": 1,
        "text": "Emergency laparoscopy"
      },
      {
        "id": 2,
        "text": "Myomectomy"
      },
      {
        "id": 3,
        "text": "Cesarean section at 37 weeks"
      },
      {
        "id": 4,
        "text": "Conservative management"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given case scenario is suggestive of an <strong>uncomplicated fibroid</strong> <strong>during</strong> <strong>pregnancy.</strong>\u00a0These are <strong>managed conservatively</strong>.\u00a0</p>\n<p><strong>Surgery</strong> is only indicated in the case of a pedunculated fibroid undergoes <strong>torsion.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old woman presented with menorrhagia and increased frequency of micturition. Ultrasound abdomen shows the following picture. Which of the following drugs is not used in the management of her condition?",
    "choices": [
      {
        "id": 1,
        "text": "Mifepristone"
      },
      {
        "id": 2,
        "text": "Goserelin"
      },
      {
        "id": 3,
        "text": "Cetrorelix"
      },
      {
        "id": 4,
        "text": "Misoprostol"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given case scenario and&nbsp;ultrasound image showing a <strong>well-defined</strong>, <strong>heterogeneous</strong> <strong>hypoechoic</strong> mass are suggestive of a uterine <strong>fibroid.</strong>&nbsp;Misoprostol does not help to reduce the size of the fibroid and so is not recommended for its management.&nbsp;</p>\n<p><strong>Medical management</strong> <strong>of fibroids</strong> helps to <strong>reduce</strong> their <strong>size</strong>. The drugs used in therapy are as follows:</p>\n<ul>\n<li>Antiprogesterone &ndash; <strong>Mifepristone </strong>/ RU-486</li>\n<li>GnRH analogs\n<ul>\n<li>Agonists &ndash; <strong>goserelin,</strong> leuprorelin, nafarelin, buserelin</li>\n<li>Antagonists &ndash; <strong>cetrorelix,</strong> ganirelix</li>\n</ul>\n</li>\n<li>Levonorgestrel releasing intrauterine system</li>\n<li>Selective progesterone receptor modulator (SPRM) &ndash; Asoprisnil</li>\n<li>Danazol&nbsp;- usually not used due to androgenic side effects.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/09cc1629393645aca408f9881d34379a.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient diagnosed with leiomyoma was prescribed an intranasal spray to manage her disease. Which of the following drugs is it unlikely to contain?",
    "choices": [
      {
        "id": 1,
        "text": "Leuprolide"
      },
      {
        "id": 2,
        "text": "Histrelin"
      },
      {
        "id": 3,
        "text": "Nafarelin"
      },
      {
        "id": 4,
        "text": "Buserelin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The nasal spray is unlikely to contain\u00a0<strong>histrelin,</strong> as it is only available as a <strong>subcutaneous implant.\u00a0</strong></p>\n<p>GnRH analogues are used to treat leiomyomas. <strong>Intranasal</strong> preparations are available for <strong>leuprolide, nafarelin,</strong> and <strong>buserelin.</strong> However, leuprolide has maximal action as an intramuscular injection.\u00a0</p>\n<p><strong>GnRH analogue therapy</strong> <strong>in fibroids</strong> is given as follows:</p>\n<ul>\n<li>Leuprolide acetate (Lupron) - given intramuscularly. It is also available as an intranasal spray, but isn't commonly used.\u00a0</li>\n<li>Goserelin (Zoladex) - subcutaneous depot implant</li>\n<li>Triptorelin (Trelstar) IM injection</li>\n<li>Nafarelin and buserelin - given as intranasal sprays bd\u00a0</li>\n<li>Histrelin - available as subcutaneous implants.\u00a0</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A pregnant woman was diagnosed with red degeneration of fibroid at 26 weeks of gestation. What is the next step in her management?",
    "choices": [
      {
        "id": 1,
        "text": "Laparotomy"
      },
      {
        "id": 2,
        "text": "Termination of pregnancy"
      },
      {
        "id": 3,
        "text": "Fibroid removal during Caesarean section"
      },
      {
        "id": 4,
        "text": "Analgesics"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Red degeneration</strong>\u00a0of fibroid is managed conservatively with <strong>bed rest</strong> and <strong>analgesics.</strong></p>\n<p>It is most common during\u00a0the\u00a0<strong>second trimester\u00a0</strong>of pregnancy.\u00a0Red degeneration presents with acute\u00a0<strong>abdominal pain,</strong>\u00a0fever and, vomiting. Investigations reveal leukocytosis and a raised ESR. On radiology, the\u00a0<strong>hemorrhagic areas</strong>\u00a0appear\u00a0<strong>hyperechoic</strong>\u00a0within the fibroid.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 32-year-old woman presented with anemia due to heavy menstrual bleeding in spite of medical management of fibroids. She was posted for a myomectomy as she wanted to have children in the future. Which of the following is not an indication for this procedure?",
    "choices": [
      {
        "id": 1,
        "text": "Recurrent pregnancy loss"
      },
      {
        "id": 2,
        "text": "Associated infertility"
      },
      {
        "id": 3,
        "text": "Red degeneration"
      },
      {
        "id": 4,
        "text": "Pressure symptoms"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Red degeneration</strong> is not an indication of myomectomy. It is <strong>conservatively managed</strong>.&nbsp;</p>\n<div class=\"page\" title=\"Page 414\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Myomectomy</strong> is <strong>indicated</strong> in the following:</p>\n<ul>\n<li>Symptoms compromising the quality of life such as:\n<ul>\n<li>Heavy menstrual <strong>bleeding</strong>, causing anemia&nbsp;</li>\n<li>Pelvic <strong>pain</strong></li>\n<li><strong>Urinary</strong> <strong>symptoms</strong> and ureteric obstruction.</li>\n</ul>\n</li>\n<li>The patient is unwilling for hysterectomy&nbsp;</li>\n<li>The patient wishes to preserve <strong>childbearing</strong> function&nbsp;</li>\n<li>Fibroids causing <strong>infertility</strong>&nbsp;</li>\n</ul>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following modalities is not used for the treatment of leiomyomas?",
    "choices": [
      {
        "id": 1,
        "text": "Uterine artery embolisation"
      },
      {
        "id": 2,
        "text": "Magnetic resonance guided focused ultrasound"
      },
      {
        "id": 3,
        "text": "Ultrasound guided transcervical metroplasty"
      },
      {
        "id": 4,
        "text": "Nd:YAG laser myolysis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>&nbsp;</p>\n<p><strong>Magnetic Resonance guided Focused Ultrasound </strong>(MRgFUS)<strong>&nbsp;</strong>is also called MR-guided high-intensity focused ultrasound (MR-HIFU).</p>\n<p><strong>Ultrasound </strong>energy is focused to <strong>heat</strong> and incite <strong>coagulative necrosis</strong> in selected myomas. <strong>Concurrent MR</strong> imaging enables <strong>precise targeting</strong> and provides real-time tissue temperature feedback to limit surrounding thermal injury.</p>\n<p>The given image shows MRgFUS.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2d7070304e2f468086b56856678b7453x1280x2026.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/60eb81598d954442b2457ed6e29aba65x600x546.JPEG"
    ]
  },
  {
    "text": "The following procedure was planned for a patient with uterine fibroids. Which of the following statements is false about this procedure?",
    "choices": [
      {
        "id": 1,
        "text": "Can be done in nulliparous women"
      },
      {
        "id": 2,
        "text": "Ovarian failure is one of the complications"
      },
      {
        "id": 3,
        "text": "PVA particles are used"
      },
      {
        "id": 4,
        "text": "Done under radiological guidance"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows <strong>uterine artery embolization</strong> (UAE). UAE<strong>&nbsp;</strong>cannot be done in nulliparous women&nbsp;as embolization of ovarian vessels can cause <strong>ovarian failure</strong> and <strong>premature menopause.</strong></p>\n<p>Under local sedation, bilateral UAE is ap&shy;proached through percutaneous femoral catheterization. Embolization is done by releasing polyvinyl alcohol (PVA), gel foam particles or metal coils into the uterine artery.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d5c296cbf083435f836fa5e3857f937c.JPEG"
    ],
    "explanation_images": []
  }
];
        let quizName = '33 Fibroid';
        const quizFilename = '33-fibroid-804dba28.html';
        let hierarchy = ["Marrow", "qBank", "Obstetrics & Gynecology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>