<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19 Non Syphilitic Sexually Transmitted Diseases - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Dermatology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "The microscopic examination of a sample obtained from a genital ulcer is shown below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Granuloma inguinale"
      },
      {
        "id": 2,
        "text": "Gonorrhoea"
      },
      {
        "id": 3,
        "text": "Chancroid"
      },
      {
        "id": 4,
        "text": "Lymphogranuloma venerum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option D: In LGV, an increased number of <strong>polymorphonuclear leukocytes</strong> are noted on microscopy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b0d07339d2b14a1c9b631ba1df9ea7c6.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e79a4b90109d441fa7f3e5bfa5036982x720x474.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d57ae7fb10c34d62bd5166a6b3927081x720x705.JPEG"
    ]
  },
  {
    "text": "A 30-year-old man presents with the following painless and foul-smelling ulcer. On examination, there is no lymphadenopathy. What is the causative organism?",
    "choices": [
      {
        "id": 1,
        "text": "Treponema pallidum"
      },
      {
        "id": 2,
        "text": "Hemophilus ducreyi"
      },
      {
        "id": 3,
        "text": "Herpes simplex virus - 2"
      },
      {
        "id": 4,
        "text": "Klebsiella granulomatis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical picture of a painless, beefy red, foul-smelling ulcer with no lymphadenopathy points to a diagnosis of <strong>granuloma inguinale</strong>. It is caused by <strong><em>Calymmatobacterium granulomatis</em> </strong>also known as <strong><em>Klebsiella granulomatis</em>.</strong></p>\n<p>The&nbsp;<strong>incubation</strong>&nbsp;period varies from<strong>&nbsp;8-80 days</strong>, the average being<strong>&nbsp;50 days</strong>.</p>\n<p>Four types of lesions have been described in this condition:</p>\n<ul>\n<li><strong>Ulcerogranulomatous -</strong>&nbsp;<strong>most common</strong>&nbsp;type with&nbsp;<strong>painless beefy red</strong>&nbsp;ulcers<strong>.&nbsp;</strong>They are also highly&nbsp;<strong>vascular&nbsp;</strong>and&nbsp;<strong>bleed</strong>&nbsp;on touch.</li>\n<li><strong>Hypertrophic -</strong>&nbsp;usually with a raised irregular edge</li>\n<li><strong>Necrotic -</strong>&nbsp;offensive smelling ulcer that causes tissue destruction</li>\n<li><strong>Sclerotic</strong>&nbsp;or&nbsp;<strong>cicatricial -</strong>&nbsp;with fibrous or scar tissue</li>\n</ul>\n<p>Primary lesions can occur on genital and extragenital sites. Untreated genital ulcers are followed by genital&nbsp;<strong>disfigurement&nbsp;</strong>and have the potential for&nbsp;<strong>malignant change.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/04f6c106116e4736a9f30e9ac699f83f.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man presents with a genital ulcer, as shown below. Microscopy of a sample from the lesion shows Donovan bodies. Which of the following is false about this disease?",
    "choices": [
      {
        "id": 1,
        "text": "Primary ulcer heals without scarring"
      },
      {
        "id": 2,
        "text": "It has an incubation period of 8 to 80 days"
      },
      {
        "id": 3,
        "text": "It has the potential for malignant transformation"
      },
      {
        "id": 4,
        "text": "Caused by Calymmatobacterium granulomatis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Donovan bodies </strong>are characteristic of <strong>donovanosis</strong> or<strong> granuloma inguinale</strong>. The primary ulcer, if left untreated, heals spontaneously with <strong>scarring</strong> or persists and <strong>spreads</strong>.</p>\n<p>Granuloma inguinale is a sexually transmitted infection caused by <strong><em>Calymmatobacterium</em> <em>granulomatis</em></strong>&nbsp;/&nbsp;<em>Kl</em><em>e</em><em>bsiel</em><em>la</em><em> granulomatis.</em> The <strong>incubation</strong> period varies from<strong> 8-80 days</strong>, the average being<strong> 50 days</strong>.</p>\n<p>Four types of lesions have been described in this condition:</p>\n<ul>\n<li><strong>Ulcerogranulomatous -</strong>&nbsp;<strong>most common</strong> type with <strong>painless beefy red</strong> ulcers<strong>. </strong>They are also highly <strong>vascular&nbsp;</strong>and <strong>bleed</strong> on touch.</li>\n<li><strong>Hypertrophic -</strong>&nbsp;usually with a raised irregular edge</li>\n<li><strong>Necrotic -</strong>&nbsp;offensive smelling ulcer that causes tissue destruction</li>\n<li><strong>Sclerotic</strong> or <strong>cicatricial -</strong>&nbsp;with fibrous or scar tissue</li>\n</ul>\n<p>Primary lesions can occur on genital and extragenital sites. Untreated genital ulcers are followed by genital <strong>disfigurement </strong>and have the potential for <strong>malignant change.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/64ed62867da5410c90bd788071613bfd.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a275b71510bf448b824dacd142b98b65x1280x1198.758815232722.JPEG"
    ]
  },
  {
    "text": "A 35-year old man with a history of high-risk sexual behavior presents with the following painless penile ulcer. It bleeds on touch and there are no enlarged lymph nodes. What initial treatment will you prescribe for him?",
    "choices": [
      {
        "id": 1,
        "text": "Azithromycin 1g daily for 3 days"
      },
      {
        "id": 2,
        "text": "Azithromycin 500 mg daily for 3 weeks"
      },
      {
        "id": 3,
        "text": "Doxycycline 100 mg BD for 5 days"
      },
      {
        "id": 4,
        "text": "Doxycycline 100 mg BD for 2 weeks"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This man with a painless, vascular ulcer and no lymphadenopathy has <strong>granuloma inguinale</strong>. The first-line treatment is <strong>azithromycin</strong> 1 g orally once weekly or 500 mg daily for <strong>3 weeks</strong>.</p>\n<p>In this condition,<strong> prolonged antibiotic therapy</strong> is required. Antibiotics must be given for<strong> 3-6 weeks</strong> and until the ulcer has <strong>completely healed</strong>. The second-line drugs are as follows:&nbsp;</p>\n<ul>\n<li><strong>Doxycycline</strong> 100 mg orally BD</li>\n<li><strong>Erythromycin</strong> base 500 mg orally QID</li>\n<li><strong>Trimethoprim-sulfamethoxazole</strong> 160 mg/800 mg orally BD</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e430c11e374744f48ad4f512ffad98b7.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following presents with pseudobubo?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphogranuloma venerum"
      },
      {
        "id": 2,
        "text": "Syphilis"
      },
      {
        "id": 3,
        "text": "Donovanosis"
      },
      {
        "id": 4,
        "text": "Chancroid"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Pseudobubo</strong> is a feature of <strong>donovanosis</strong>.</p>\n<p>It refers to <strong>granulomatous lesions </strong>that may extend into <strong>subcutaneous</strong> <strong>tissue </strong>and mimic lymphadenopathy. The presence of these lesions both above and below the inguinal ligament results in a <strong>pseudo-groove sign, </strong>similar to the groove sign of Greenblatt seen in lymphogranuloma venereum.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with vaginal discharge has the following finding on examination. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Gonococcal cervicitis"
      },
      {
        "id": 2,
        "text": "Trichomoniasis"
      },
      {
        "id": 3,
        "text": "Chlamydial cervicitis"
      },
      {
        "id": 4,
        "text": "Granuloma inguinale"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows <strong>colpitis macularis</strong> or <strong>strawberry cervix</strong>, which is a characteristic finding of <strong>trichomoniasis</strong>. It results from microscopic, <strong>punctate hemorrhages</strong> of the cervix.</p>\n<p>It is caused by <strong><em>Trichomonas vaginalis</em></strong> and is one of the most common causes of vaginal discharge. It is transmitted by <strong>sexual intercourse, </strong>with an incubation period of<strong> 4&ndash;21</strong> days.</p>\n<p>In <strong>females</strong>, it characteristically causes a <strong>copious, frothy, yellow-green discharge</strong> with <strong>pH &gt; 4.5</strong>, along with vaginal soreness and urinary frequency. <strong>Males</strong> can be asymptomatic or develop <strong>non-specific urethritis</strong>.</p>\n<p>Diagnosis in females is usually easily confirmed by the presence of <strong>motile organisms</strong> on a <strong>wet film. </strong>Culture in <strong>Feinberg&ndash;Whittington medium</strong> is the most reliable method but is not routinely done.</p>\n<p>Standard treatment is <strong>metronidazole 2g PO single dose</strong>. Regardless of treatment given, patients should <strong>avoid sexual contact for 7 days</strong> since the last antibiotic dose.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7fb03f86b8de4473885e7d6e9bdca296.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "As a PHC medical officer, you see a 25-year-old man, who has come with painful lesions as shown below. On further probing, he tells you that he had vesicles on his penis 2 days back and that he is allergic to penicillin. On examination, he has bilateral tender lymphadenopathy. Which kit will you use to treat him?",
    "choices": [
      {
        "id": 1,
        "text": "Green kit"
      },
      {
        "id": 2,
        "text": "Red kit"
      },
      {
        "id": 3,
        "text": "Blue kit"
      },
      {
        "id": 4,
        "text": "White kit"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The clinical picture of<strong> multiple, grouped painful ulcers </strong>with<strong> tender lymphadenopathy </strong>in this patient points to a diagnosis of <strong>herpes genitalis </strong>infection by HSV-2. It is treated with a&nbsp;<strong>red kit</strong>.</p>\n<p>The red kit or kit 5 is meant for genital ulcer disease - herpetic<strong>. </strong>It contains <strong>acyclovir 400 mg </strong>tablets to be taken<strong> TDS </strong>for<strong> 7 days</strong>.</p>\n<p><strong>Chancroid</strong> is a close differential diagnosis, which presents with <strong>multiple, soft painful ulcers </strong>and unilateral<strong> tender lymphadenopathy</strong>. However, vesicles are not seen in chancroid and the ulcers are <strong>deeper</strong> with ragged <strong>undermined edges</strong>.</p>\n<p>History of drug allergy to penicillin is relevant only when the patient presents with the primary chancre of syphilis. In such a case, they would need to be treated with a blue kit instead of a white kit.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f138461ac4b24529922880d4f3eabe4b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "While being counseled for a sexually transmitted infection, a man is informed that his asymptomatic partner does not need to be treated. Which of the following kits will he be treated with?",
    "choices": [
      {
        "id": 1,
        "text": "Grey kit"
      },
      {
        "id": 2,
        "text": "Blue kit"
      },
      {
        "id": 3,
        "text": "Red kit"
      },
      {
        "id": 4,
        "text": "Black kit"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>red kit</strong> is used for the treatment of<strong> herpetic</strong> genital ulcer disease, in which treatment of <strong>asymptomatic</strong> partners is <strong>not required</strong>.</p>\n<p>Option A: <strong>Grey</strong> kit used in men for <strong>urethral</strong> <strong>discharge</strong> and <strong>scrotal</strong> <strong>swelling</strong> requires <strong>all</strong> <strong>recent</strong> partners to be treated. But, when used for <strong>cervical discharge</strong> in women, only <strong>symptomatic male</strong> partners need to be treated.</p>\n<p>Option B: <strong>Blue</strong> kit is used for <strong>non-herpetic</strong> genital ulcer disease when the patient is allergic to penicillin. All partners in the last <strong>3 months</strong> must be treated.</p>\n<p>Option D: <strong>Black</strong> kit is used for inguinal <strong>buboes</strong>. All partners in the last <strong>3 weeks</strong> must be treated.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 28-year-old male presents with painful deep ulcers on his penis as shown below. He also has painful unilateral lymphadenopathy. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Chancroid"
      },
      {
        "id": 2,
        "text": "Herpes genitalis"
      },
      {
        "id": 3,
        "text": "Lymphogranuloma venerum"
      },
      {
        "id": 4,
        "text": "Granuloma inguinale"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This patient with painful, deep ulcers with tender lymphadenopathy has<strong> chancroid. </strong>It is caused by<strong> <em>Haemophilus ducreyi</em>.</strong></p>\n<p>The incubation period is <strong>3-10 days</strong>. The primary lesion begins as a painful papule that undergoes central necrosis to form <strong>painful</strong>, <strong>non-indurated</strong> ulcers with <strong>undermined</strong> edges. <strong>Kissing ulcers</strong> due to autoinoculation may also be present.</p>\n<p>It is associated with <strong>painful</strong> <strong>lymphadenopathy</strong>, which later progresses to form suppurating <strong>buboes</strong> and <strong>sinuses</strong>.</p>\n<p>Option B: HSV-2 infection presents with multiple vesicles, which develop into shallow ulcers, along with painful lymphadenopathy.</p>\n<p>Option C: LGV presents with a painless or painful ulcer later followed by painful lymphadenopathy. The incubation period is 3-30 days.</p>\n<p>Option D: Granuloma inguinale or donovanosis presents with a painless papule that forms a beefy red ulcer with no lymphadenopathy. The incubation&nbsp;period is 8-80 days (average 50 days).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3ff8bdf1256e458a886cc62cafa68779.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A young man presents with the following painful, soft ulcer, 4 days after unprotected sexual intercourse. Which of the following will you choose as initial treatment for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Ceftriaxone 500 mg IM stat"
      },
      {
        "id": 2,
        "text": "Ciprofloxacin 500 mg BD for 4 days"
      },
      {
        "id": 3,
        "text": "Erythromycin 500 mg QID for 7 days"
      },
      {
        "id": 4,
        "text": "Azithromycin 1g oral stat"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>This clinical scenario is suggestive of&nbsp;<strong>chancroid</strong>. First-line treatment is <strong>azithromycin</strong> <strong>1g</strong> <strong>orally</strong> as a single dose or <strong>ceftriaxone</strong> <strong>250 mg IM </strong>as&nbsp;a single dose.</p>\n<p>The second-line options for chancroid are as follows:</p>\n<ul>\n<li>\n<p>Ciprofloxacin 500 mg orally twice a day for 3 days &nbsp;(OR)</p>\n</li>\n<li>\n<p>Erythromycin base 500 mg orally four times a day for 7 days</p>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d06e7a4358c04f03bcb0c4e7744fea84.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old man develops thick yellowish discharge from his urethra 2 weeks after an unprotected sexual encounter. Which of the following is the recommended diagnostic test?",
    "choices": [
      {
        "id": 1,
        "text": "Culture and sensitivity"
      },
      {
        "id": 2,
        "text": "Nucleic acid amplification test"
      },
      {
        "id": 3,
        "text": "Enzyme Linked Immunosorbent Assay"
      },
      {
        "id": 4,
        "text": "Microscopy showing inclusion bodies"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Chlamydial urethritis</strong> is the likely diagnosis in this patient as it has an incubation period of <strong>1-3 weeks</strong>.<strong> Nucleic acid amplification test </strong>(NAAT) is the only diagnostic test recommended for detecting <em>Chlamydia</em>.</p>\n<p>The samples used are:</p>\n<ul>\n<li><strong>Men</strong> -&nbsp;first void urine&nbsp;</li>\n<li><strong>Women</strong> - vaginal or endocervical swabs</li>\n</ul>\n<p><strong>NAAT</strong> can only detect <em>Chlamydia</em> species, but <strong>cannot differentiate</strong> between <strong>LGV</strong> and <strong>non-LGV</strong> types. <strong>Genotyping</strong> of <em>Chlamydia</em>\u2010positive samples is needed to <strong>specifically</strong> diagnose LGV infection.</p>\n<p>Serology, cell culture, and microscopy have no role in routine screening or diagnosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 29-year-old primigravida is diagnosed with chlamydial cervicitis. What is the drug of choice?",
    "choices": [
      {
        "id": 1,
        "text": "Doxycycline"
      },
      {
        "id": 2,
        "text": "Ceftriaxone"
      },
      {
        "id": 3,
        "text": "Azithromycin"
      },
      {
        "id": 4,
        "text": "Amoxicillin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A<strong> single dose </strong>of<strong> azithromycin 1g </strong>is the drug of choice in pregnant women with <strong>uncomplicated chlamydial infection</strong>.&nbsp;</p>\n<p>The drug of choice for chlamydia infection in <strong>adults</strong> and <strong>adolescents</strong> is <strong>doxycycline</strong>&nbsp;100 mg orally BD for 7 days. It is <strong>contraindicated</strong> in <strong>pregnancy.</strong></p>\n<p>Alternative regimens are:&nbsp;</p>\n<ul>\n<li>Azithromycin 1g orally, single dose&nbsp;</li>\n<li>Levofloxacin 500mg OD for 7 days</li>\n</ul>\n<p>Azithromycin is preferred due to its greater <strong>effectiveness</strong> and <strong>lower cost</strong>.&nbsp;</p>\n<p>Option A: Doxycycline is contraindicated in pregnancy as it causes depression of bone growth and enamel hypoplasia in the fetus.</p>\n<p>Option B: Ceftriaxone is used for the treatment of gonococcal infections.</p>\n<p>Option D: Amoxicillin is used as an alternative regimen as it is less effective.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 20-year-old man presents with burning pain on passing urine. He reluctantly admits that he had unprotected sexual intercourse 3 days ago. The following examination findings are seen. Which of the following is the likely causative organism?",
    "choices": [
      {
        "id": 1,
        "text": "Chlamydia trachomatis"
      },
      {
        "id": 2,
        "text": "Mycoplasma genitalium"
      },
      {
        "id": 3,
        "text": "Trichomonas vaginalis"
      },
      {
        "id": 4,
        "text": "Neisseria gonorrhoeae"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The symptoms of this patient occurring 3 days after unprotected sex point to urethritis caused by <strong><em>Neisseria gonorrhoeae</em>,</strong> as its <strong>incubation</strong> <strong>period</strong> is <strong>1-5 days.</strong></p>\n<p>The most common presentation of gonococcal infection in <strong>men</strong> is <strong>acute</strong> <strong>urethritis</strong> with <strong>dysuria </strong>and profuse <strong>purulent&nbsp;</strong><strong>discharge</strong>. Pharyngeal and rectal infections can also occur depending on the type of sexual contact.</p>\n<p>The primary site of infection in<strong> women </strong>is the <strong>cervix</strong> but the urethra, rectum, and pharynx may be involved. Symptoms include excessive <strong>vaginal</strong> <strong>discharge</strong>, <strong>dysuria</strong>, deep dyspareunia, <strong>postcoital</strong> and <strong>intermenstrual</strong> <strong>bleeding</strong>.</p>\n<p>The most common cause of<strong> non-gonococcal urethritis</strong> (NGU) is <strong><em>Chlamydia</em></strong>, which has an incubation period of&nbsp;<strong>1-3 weeks</strong>. It usually presents with dysuria alone, but mucopurulent discharge can occur. Other causes of NGU are <strong><em>Mycoplasma genitalium</em></strong> and <strong><em>Trichomonas vaginalis</em></strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/00f33ad11df2478486bb8f8c7d9b95a6.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old IV drug abuser with high-grade fever and chills is found to have a new-onset murmur. Blood culture is positive for Neisseria gonorrhoeae. Which of the following statements is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "It occurs as a result of direct spread by ascending infections"
      },
      {
        "id": 2,
        "text": "Classic presentation is with a dermatitis\u2013arthritis syndrome"
      },
      {
        "id": 3,
        "text": "Skin lesions are small, tender and maculopapular"
      },
      {
        "id": 4,
        "text": "Systemic lupus erythematosus and HIV infection are risk factors"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Joint</strong> or<strong> tendon pain</strong> is the most common accompanying feature. <strong>Tenosynovitis</strong> often affects the hands and fingers. 1/3rd of the patients may proceed to <strong>suppurative arthritis</strong>, most commonly of the knee.</p>\n<p>Other manifestations like endocarditis, pericarditis, osteomyelitis, and meningitis are extremely rare.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ba8fc549fef94ecc81d934aff58eaa98x1280x1170.7757404795486.JPEG"
    ]
  },
  {
    "text": "A 27-year-old commercial sex worker comes to the OPD with the following finding. What is the causative organism?",
    "choices": [
      {
        "id": 1,
        "text": "Chlamydia trachomatis L1-L3"
      },
      {
        "id": 2,
        "text": "Haemophilus ducreyi"
      },
      {
        "id": 3,
        "text": "Chlamydia trachomatis D-K"
      },
      {
        "id": 4,
        "text": "Klebsiella granulomatis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This image shows the pathognomonic <strong>groove sign of Greenblatt, </strong>which&nbsp;is suggestive of <strong>lymphogranuloma</strong> <strong>venereum</strong>. It is caused by <strong><em>Chlamydia trachomatis</em> serovars L1-L3</strong>. &nbsp;</p>\n<p>Groove sign is seen in \u2153 of the cases. It refers to the depression between the enlarged femoral and inguinal lymph nodes on either side of the inguinal ligament.&nbsp;</p>\n<p>Option B: <em>H. ducreyi</em> causes chancroid.</p>\n<p>Option C: <em>C. trachomatis</em> D-K causes non-gonococcal urethritis.</p>\n<p>Option D: <em>K. granulomatis</em> causes granuloma inguinale.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/79b653be99c84de2857be891a107b773.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old thin-built man presents with urethritis. Gram-staining of the purulent discharge is seen in the following image. What is the treatment of choice for this infection?",
    "choices": [
      {
        "id": 1,
        "text": "Ceftriaxone 250 mg IM + Azithromycin 1g PO stat"
      },
      {
        "id": 2,
        "text": "Ceftriaxone 500 mg IM in a single dose"
      },
      {
        "id": 3,
        "text": "Ceftriaxone 500 mg IM +  Doxycycline 100 mg BD for 7 days"
      },
      {
        "id": 4,
        "text": "Azithromycin 1g PO stat + Doxycycline 100 mg BD for 7 days"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>This clinical scenario along with the microscopic findings of <strong>Gram\u2010negative intracellular diplococci </strong>indicates infection with <strong><em>Neisseria gonorrhoeae</em></strong>. As it has not been confirmed by NAAT testing, this patient must also be treated for <strong>concurrent chlamydial infection.</strong></p>\n<p>Single-agent therapy with <strong>ceftriaxone</strong> is preferred for the treatment of gonococcal infections. According to <strong>CDC guidelines (2021)</strong>, treatment of uncomplicated gonococcal infections is as follows:</p>\n<ul>\n<li>Weight &lt;150 kg &ndash; Ceftriaxone 500 mg intramuscular (IM) in a single dose</li>\n<li>Weight &ge;150 kg &ndash; Ceftriaxone 1 g IM in a single dose</li>\n</ul>\n<p>The doses of ceftriaxone are higher than the previous guidelines as the gonococcal minimum inhibitory concentrations (MICs) are rising worldwide. The British BASHH guidelines also recommend a high dose of 1g.</p>\n<p>Concurrent <strong>chlamydial</strong> infection must also be treated unless it has been excluded by <strong>molecular testing</strong>. First-line drug administered is:</p>\n<ul>\n<li>Oral <strong>doxycycline</strong> <strong>100 mg BD </strong>for 7 days&nbsp;</li>\n</ul>\n<p><strong>Partner treatment</strong> is also required.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/64d6a57858ba42dfbce6fdda44e11f46.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A man is referred to the STI clinic with the following painful finding. He gives a history of a small painless ulcer on his penis 5 weeks ago, which resolved on its own. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Chancroid"
      },
      {
        "id": 2,
        "text": "Syphilis"
      },
      {
        "id": 3,
        "text": "Lymphogranuloma venerum"
      },
      {
        "id": 4,
        "text": "Granuloma inguinale"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shows <strong>bilateral painful masses</strong> of lymph nodes called <strong>buboes</strong>, that occurred in this patient following a painless genital ulcer. This is typically seen in <strong>lymphogranuloma venereum</strong>. &nbsp;</p>\n<p>The incubation period of this condition is <strong>3-30 days</strong>. It occurs in three stages.&nbsp;</p>\n<p><strong>Primary</strong> stage: Begins with painless papules or ulcers at the site of inoculation, which may go unnoticed. The classical <strong>ulcer</strong> is <strong>single</strong>, shallow, <strong>non-indurated,</strong> and may be <strong>painful or painless</strong>. The common site is the coronal sulcus in men and the posterior vaginal wall in women. It heals without scarring.&nbsp;</p>\n<p><strong>Secondary</strong> stage: Develops <strong>2-6 weeks</strong> later and presents as <strong>tender</strong> femoral and/ or inguinal <strong>lymphadenopathy</strong>. The nodes may coalesce to form <strong>buboes</strong> or abscesses, which later rupture to form <strong>fistulae</strong> and <strong>sinus</strong> tracts.&nbsp;</p>\n<p><strong>Tertiary</strong> stage: Occurs several years later and is characterized by <strong>lymphatic obstruction</strong> and disfiguring conditions such as <strong>elephantiasis</strong> and <strong>esthiomene</strong>.</p>\n<p>Option A:<strong> Chancroid </strong>presents with<strong>&nbsp;</strong>multiple <strong>painful</strong>&nbsp;<strong>ulcers</strong> with painful lymphadenopathy. The incubation period 3-10 days.</p>\n<p>Option B: <strong>Syphilis </strong>presents with painless indurated ulcers with <strong>painless</strong> <strong>lymphadenopathy</strong><strong>. </strong>The incubation period is 9-90 days.</p>\n<p>Option D:<strong> Granuloma inguinale </strong>presents as a painless beefy red ulcer with<strong> no lymphadenopathy. </strong>The<strong>&nbsp;</strong>incubation period is 8-80 days (average 50 days).</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b4ea42a2b4774afe94bd0d598caa22a3.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A woman brings her 50-year-old mother to a PHC with disfiguration of her genitalia as shown below. She says that it has been present for many years but her mother had refused to seek treatment. The PHC medical officer decides to refer the lady to a venereologist. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Lymphogranuloma venerum"
      },
      {
        "id": 2,
        "text": "Chancroid"
      },
      {
        "id": 3,
        "text": "Granuloma inguinale"
      },
      {
        "id": 4,
        "text": "Syphilis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows&nbsp;<strong>esthiomene</strong>, a feature of <strong>lymphogranuloma</strong> <strong>venereum</strong>.&nbsp;</p>\n<p>In the tertiary stage of LGV, there is <strong>lymphatic obstruction</strong> due to <strong>chronic inflammation</strong> and <strong>fibrosis</strong>. This results in genital lymphoedema and inflammation which causes ulceration and chronic granulomatous fibrosis, resulting in esthiomene in women and <strong>elephantiasis</strong> in <strong>men</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/3bafe3c3d14b45e78bda47c888af4838.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/93f359dfae694883a8c07775d84e97f5x1280x1491.2270803949225.JPEG"
    ]
  },
  {
    "text": "A 50-year-old man was referred to a urologist for the following finding. Which of the following would not have caused this?",
    "choices": [
      {
        "id": 1,
        "text": "Donovanosis"
      },
      {
        "id": 2,
        "text": "Lymphogranuloma venereum"
      },
      {
        "id": 3,
        "text": "Gonococcal urethritis"
      },
      {
        "id": 4,
        "text": "Penile tuberculosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The deformity shown in the above image depicts a <strong>penis</strong> that is <strong>twisted</strong> along its <strong>long axis</strong>, which is called <strong>saxophone penis</strong>. It is a late complication of<strong> lymphogranuloma venereum</strong>, <strong>penile tuberculosis,</strong> and <strong>primary</strong> <strong>lymphedema</strong>.&nbsp;It does not occur in donovanosis.&nbsp;</p>\n<p>It occurs as a complication of long-standing <strong>inflammation</strong>, which causes <strong>fibrosis</strong> of lymphatics and connective tissue. The dorsal surface of the penis has a <strong>poor blood supply</strong> compared to the ventral surface and undergoes more fibrosis. This leads to a <strong>dorsal bend</strong> of the penis.&nbsp;</p>\n<p><strong>Gonococcal urethritis</strong> can lead to periurethral abscesses, which result in urethral strictures. In males, this may cause a saxophone penis deformity.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0ed9878e6d084c89a1b5813147f74000.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a feature of the Amsel criteria?",
    "choices": [
      {
        "id": 1,
        "text": "Homogenous thin greyish discharge"
      },
      {
        "id": 2,
        "text": "Vaginal pH less than 4.5"
      },
      {
        "id": 3,
        "text": "Amine odour after adding 10% KOH"
      },
      {
        "id": 4,
        "text": "Epithelial cells studded with coccobacilli"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Bacterial vaginosis is caused by a <strong>reduction</strong> in <strong>lactobacilli</strong>, and an <strong>increase</strong> in <strong>anaerobic</strong> organisms such as <em>Gardnerella&nbsp;vaginalis, Mycoplasma hominis&nbsp;</em>and <em>Prevotella </em>species.</p>\n<p><strong>Nugent scoring system</strong> is highly <strong>sensitive</strong> and is considered the <strong>gold standard </strong>for bacterial vaginosis. It is calculated using <strong>Gram-stained smear </strong>findings and observing the number of lactobacilli and morphology of anaerobes. High scores of&nbsp; 7&ndash;10 indicate bacterial vaginosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6c7288d7f2c6442cb3008adbb3c65698x1280x981.9054340155258.JPEG"
    ]
  }
];
        let quizName = '19 Non Syphilitic Sexually Transmitted Diseases';
        const quizFilename = '19-non-syphilitic-sexually-transmitted-diseases-045a3dce.html';
        let hierarchy = ["Marrow", "qBank", "Dermatology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>