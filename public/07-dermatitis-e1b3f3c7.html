<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07 Dermatitis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Dermatology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "An asthmatic child presents with intensely pruritic lesions. He has no other symptoms. What is the most likely diagnosis from the given options?",
    "choices": [
      {
        "id": 1,
        "text": "Scabies"
      },
      {
        "id": 2,
        "text": "Staphylococcal infection"
      },
      {
        "id": 3,
        "text": "Pityriasis alba"
      },
      {
        "id": 4,
        "text": "Eczema"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above image showing&nbsp;<strong>e</strong><strong>rythematous, scaly lesions</strong>&nbsp;having a&nbsp;<strong>flexural</strong>&nbsp;distribution<strong>&nbsp;</strong>with the given scenario&nbsp;is suggestive of <strong>eczema</strong>.</p>\n<p>Eczema<strong>&nbsp;</strong>is&nbsp;<strong>inflammation</strong>&nbsp;of the <strong>skin</strong> seen in a variety of skin conditions</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/910a9fc5fab34e8f9c6598e83045673c.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the incorrect statement regarding eczema.",
    "choices": [
      {
        "id": 1,
        "text": "All eczema is dermatitis, but not all dermatitis is eczema"
      },
      {
        "id": 2,
        "text": "Pruritus is a hallmark clinical feature"
      },
      {
        "id": 3,
        "text": "Spongiosis is characteristic histopathological feature of chronic eczema"
      },
      {
        "id": 4,
        "text": "Acute eczematic eruption is typically oedematous, vesicular and may be exudative"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image below shows eczema.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9a7dd4eae23a4cd2b458188876fd8e4dx1280x1262.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/985754c8845c4a34a3935750cd01cb2fx1280x1058.JPEG"
    ]
  },
  {
    "text": "A 27-year-old male presents with a well-demarcated, coin-shaped erythematous plaque on his left shin. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Atopic eczema"
      },
      {
        "id": 2,
        "text": "Nummular eczema"
      },
      {
        "id": 3,
        "text": "Pompholyx"
      },
      {
        "id": 4,
        "text": "Asteatotic eczema"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above scenario is suggestive of <strong>nummular dermatitis </strong>or nummular<strong> eczema</strong>.</p>\n<p>The diagnostic lesion of nummular dermatitis is a well-demarcated <strong>coin-shaped erythematous plaque</strong> with vesicles surrounding it. Later <strong>central clearing </strong>(resolution) and <strong>peripheral extension</strong> lead to <strong>annular </strong>or<strong> ring-shaped lesions.&nbsp;</strong>Initially, it is red and pruritic but later, it becomes more scaly and less exudative.&nbsp;</p>\n<p><strong>Common locations</strong> involved&nbsp;are:&nbsp;</p>\n<ul>\n<li>Trunk</li>\n<li>Extensor surfaces of extremities:&nbsp;\n<ul>\n<li>Men - Pretibial areas</li>\n<li>Women - Dorsal aspects of hand</li>\n</ul>\n</li>\n</ul>\n<p>The image below shows nummular dermatitis.<strong>&nbsp;</strong>Note the typical shape and demarcation of the lesion.<strong>&nbsp;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/74abca58ce964b8f97d011a37b5a2b2fx720x865.PNG"
    ]
  },
  {
    "text": "A 5-year-old child is brought to the OPD with a hypopigmented, finely scaly patch on her face. There is a history of atopy in the family.  What is the clinical diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Leprosy"
      },
      {
        "id": 2,
        "text": "Pityriasis versicolor"
      },
      {
        "id": 3,
        "text": "Pityriasis alba"
      },
      {
        "id": 4,
        "text": "Atopic eczema"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option A: In leprosy,&nbsp;the hypopigmented patch is often associated with atrophy, loss of sensation, and loss of sweating. The lesion is not scaly.</p>\n<p>Option B:&nbsp;In pityriasis versicolor<strong>&nbsp;</strong>the hypopigmented macules are perifollicular in distribution.&nbsp;Fine, powdery branny scaling is present. Scratch sign positive. No relation to atopy.</p>\n<p>Option D: Atopic eczema is<strong>&nbsp;</strong>characterized by itchy papules, hypopigmentation is not a feature.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/78b0096dbf3645fb8d7f5d59336c8a3ax1280x983.JPEG"
    ]
  },
  {
    "text": "A 15-year-old girl presents with itchy lesions on her arm as shown. Her family history is positive for asthma. What could be the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Seborrhoeic dermatitis"
      },
      {
        "id": 2,
        "text": "Atopic dermatitis"
      },
      {
        "id": 3,
        "text": "Allergic contact dermatitis"
      },
      {
        "id": 4,
        "text": "Erysipelas"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Option D: <strong>Erysipelas</strong> is a bacterial skin infection caused by <strong>Streptococcus pyogenes (Group A Streptococcus)</strong> characterized by raised, erythematous sharply demarcated rapidly spreading skin lesions, along with <strong>systemic symptoms</strong> like fever and chills. The skin may also have a <strong>peau d'orange</strong> or orange peel-like appearance.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/f68eb180d4cd44c1992455407106b29b.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/05ae708d8168418c85c36995c7340358x1280x960.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6ebc687310f342eb903cfc11bb43f880x1024x768.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/79408dcccbd6408682befd2506f07856x675x900.JPEG"
    ]
  },
  {
    "text": "The UK refinement of Hanifin and Rajka criteria is used in the diagnosis of which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Atopic dermatitis"
      },
      {
        "id": 2,
        "text": "Nummular eczema"
      },
      {
        "id": 3,
        "text": "Eczema herpeticum"
      },
      {
        "id": 4,
        "text": "Contact dermatitis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>UK refinement of Hanifin and Rajka criteria</strong> is used in the diagnosis of <strong>atopic dermatitis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An infant is brought to the dermatology clinic with the following lesions. Which is the incorrect statement regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Pruritus is the hallmark"
      },
      {
        "id": 2,
        "text": "Dennie Morgan fold can be found under lower eyelid"
      },
      {
        "id": 3,
        "text": "It has an extensor distribution in the adults"
      },
      {
        "id": 4,
        "text": "Allergic shiners may be present"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image is suggestive of infantile&nbsp;<strong>atopic eczema</strong>/dermatitis. It has a <strong>flexural distribution&nbsp;</strong>in&nbsp;<strong>adult type </strong>and<strong> extensor distribution </strong>in <strong>infantile type.</strong></p>\n<p><strong>Clinical features</strong> include:</p>\n<ul>\n<li>Rash-&nbsp;erythematous, itchy papules/papulovesicles&nbsp;</li>\n<li>Excoriations</li>\n<li>Lichenified skin</li>\n<li>Dennie Morgan fold&nbsp;- under lower eyelid.&nbsp;</li>\n<li>Allergic shiners&nbsp;-&nbsp;periorbital pigmentation&nbsp;</li>\n<li>Allergic salute&nbsp;- horizontal groove on dorsum of nasal bridge.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e5132da5bbb04e8cbc76117a9f7e68e9.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cd293f61d78b46d4813e50090df34d6dx1280x2281.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/59ecc59d422b432ab7e8323e8444f948x1280x1190.JPEG"
    ]
  },
  {
    "text": "Which is the first site of involvement in infantile atopic eczema?",
    "choices": [
      {
        "id": 1,
        "text": "Extensor aspect of knee"
      },
      {
        "id": 2,
        "text": "Flexures"
      },
      {
        "id": 3,
        "text": "Face"
      },
      {
        "id": 4,
        "text": "Extensor aspect of elbow"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The first site of involvement in <strong>infants</strong> with <strong>atopic eczema</strong> is the<strong> face.</strong></p>\n<p>Atopic eczema can be divided into <strong>3 phases</strong>:</p>\n<ol>\n<li>Infantile</li>\n<li>Childhood</li>\n<li>Adult</li>\n</ol>\n<p><strong>Infantile</strong> phase - Discrete or confluent <strong>oedematous papules associated</strong> with<strong> erythema</strong>. The papules are <strong>intensely itchy&nbsp;</strong>and may become exudative and crusted as a result of rubbing. <strong>Secondary infection</strong> and <strong>lymphadenopathy</strong> are common.</p>\n<p><strong>Childhood</strong>&nbsp;phase - starts at 18 to 24 months. Papules tend to be replaced by<strong> lichenification</strong>. The sides of the neck may show a striking <strong>reticulate pigmentation</strong>, sometimes referred to as <strong>atopic dirty neck</strong>.&nbsp;</p>\n<p><strong>Adult</strong> phase<strong> - </strong>Essentially similar to that in later childhood, with lichenification, especially of the <strong>flexures </strong>and<strong> hands</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/36f83230e7ad417bb6c5212a58510dd8x1280x1540.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1bb715e9a9724dd3bd0c55f4c7b497dax1280x2281.JPEG"
    ]
  },
  {
    "text": "Choose the correct statement with respect to Hertoghe's sign.",
    "choices": [
      {
        "id": 1,
        "text": "Loss of lateral eyebrows"
      },
      {
        "id": 2,
        "text": "Anterior subcapsular cataract"
      },
      {
        "id": 3,
        "text": "Transverse crease across the bridge of the nose"
      },
      {
        "id": 4,
        "text": "Fold under lower eyelids"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Hertoghe's sign</strong> or Queen Anne's sign is&nbsp;defined as<strong> loss</strong> of<strong> lateral one third</strong> of<strong> eye-brows</strong> (superciliary madarosis).</p>\n<p>It is seen in various conditions such as:</p>\n<ul>\n<li>Hypothyroidism</li>\n<li>Lepromatous leprosy</li>\n<li>Atopic dermatitis</li>\n<li>Trichotillomania</li>\n<li>Alopecia areata</li>\n</ul>\n<p>&nbsp;Option B: <strong>Anterior subcapsular cataract</strong>- shield-shaped cataract seen in atopic dermatitis.</p>\n<p>Option C: <strong>Transverse crease across the bridge of the nose- </strong>allergic salute.</p>\n<p>Option D: <strong>Folds of skin under lower eyelids-&nbsp;</strong>Dennie-Morgan folds seen in atopic dermatitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/82fb7e70276544658356fd9fe8847a4cx1280x1640.JPEG"
    ]
  },
  {
    "text": "A 20-year-old girl who is a known case of atopic dermatitis presents with multiple, pruritic pustular lesions for 5 days. Which of the following organism is commonly responsible for her condition?",
    "choices": [
      {
        "id": 1,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 2,
        "text": "Herpes simplex virus"
      },
      {
        "id": 3,
        "text": "Streptococcus pyogenes"
      },
      {
        "id": 4,
        "text": "Dermatophytes"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above image showing <strong>pustular</strong> lesions with heavy <strong>crusting</strong> in a patient with <strong>atopic dermatitis</strong> is suggestive of staphylococcal infection.&nbsp;<em><strong>Staphylococcus aureus</strong></em> is the most common organism to cause <strong>secondary infections</strong> in the lesions of atopic dermatitis.</p>\n<p>However, human papillomavirus\u2010induced warts, fungal infections, and viruses (such as HSV, vaccinia, coxsackie A, and the poxvirus of molluscum contagiosum) are also frequent pathogens.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/64b89a27ac3d4ce59a4ce1362b2a52ec.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 4-month-old infant was brought to the OPD with the following lesions on his scalp. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Atopic dermatitis"
      },
      {
        "id": 2,
        "text": "Seborrheic dermatitis"
      },
      {
        "id": 3,
        "text": "Berloque dermatitis"
      },
      {
        "id": 4,
        "text": "Nummular dermatitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows\u00a0<strong>flaky, white</strong> to <strong>yellowish greasy</strong> scales\u00a0on\u00a0the scalp, suggestive of\u00a0<strong>infantile seborrheic dermatitis.\u00a0</strong></p>\n<p>It\u00a0is a common, <strong>inflammatory</strong> skin condition that causes the formation of flaky, white to yellowish greasy scales\u00a0on\u00a0<strong>oily areas</strong>\u00a0such as the scalp, forehead, nose, or inside the ear.\u00a0<strong>Cradle cap</strong>\u00a0is the term used when it\u00a0affects the scalp of infants.\u00a0</p>\n<p>It commonly <strong>appears</strong>\u00a0around\u00a0<strong>3\u00a0months</strong>\u00a0of age. It is rare after\u00a08 months.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/72b93fe79d144e438b3314e999940ae0.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 28-year-old lifeguard presents to the dermatology clinic with a mildly pruritic lesion as shown for 8 days. History reveals excessive use of perfumes. Which of the following can be the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Tinea corporis"
      },
      {
        "id": 2,
        "text": "Dermatitis herpetiformis"
      },
      {
        "id": 3,
        "text": "Berloque dermatitis"
      },
      {
        "id": 4,
        "text": "Seborrheic dermatitis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image shows a <strong>deep\u2010brown pigmented</strong> lesion in the right <strong>underarm</strong> likely to have formed from the trickle of the droplets of <strong>perfume</strong> applied on the skin. This is suggestive of\u00a0<strong>Berloque dermatitis.</strong></p>\n<p>The <strong>skin</strong> <strong>pigmentation</strong>\u00a0occurs due to an <strong>acute phototoxic reaction</strong> to perfumes\u00a0containing <strong>bergamot oil</strong> (bergapten) which potentiates UV\u2010stimulated <strong>melanogenesis.</strong>\u00a0A<strong> hot</strong>\u00a0and<strong> humid</strong>\u00a0climate along with exposure to\u00a0<strong>UV light\u00a0</strong>increases the risk of developing this condition.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0193cb2862ff4d5aa46166fea0ecac8f.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient presents to the dermatology clinic complaining that a birthmark that was asymptomatic has now become pruritic with the following appearance. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic superficial scaly dermatitis"
      },
      {
        "id": 2,
        "text": "Nummular dermatitis"
      },
      {
        "id": 3,
        "text": "Melanoma"
      },
      {
        "id": 4,
        "text": "Halo dermatitis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above image shows an&nbsp;<strong>eczematous ring</strong>&nbsp;surrounding a <strong>melanocytic naevus</strong>&nbsp;(birthmark),&nbsp;suggestive of <strong>halo dermatitis</strong>.&nbsp;</p>\n<p>It is also known as <strong>Meyerson nevus</strong>. Histology shows a benign naevus surrounded by a dermal lymphocytic and eosinophilic infiltrate, with acanthosis, spongiosis, and parakeratosis.</p>\n<p>The condition usually <strong>resolves spontaneously</strong> within few months <strong>without</strong><strong>&nbsp;involution</strong> of the nevus.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7081e820af1b4651a9a370c285223363.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A patient presents with the following intensely pruritic lesions that started 2 years back. History reveals that the lesions are more severe in winters and relatively milder in summers. Choose the incorrect statement regarding this condition.",
    "choices": [
      {
        "id": 1,
        "text": "Cimetidine can cause this condition"
      },
      {
        "id": 2,
        "text": "It is also known as eczema craquel\u00e9"
      },
      {
        "id": 3,
        "text": "Children are most commonly affected"
      },
      {
        "id": 4,
        "text": "It may occur due to zinc deficiency"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above image showing dry<strong>, scaly eczematous lesions </strong>with a characteristic<strong> crazy-paving pattern </strong>(<strong>ecz&eacute;ma craquel&eacute;</strong>)&nbsp;is suggestive of <strong>asteatotic</strong> <strong>eczema.&nbsp;</strong>It&nbsp;usually develops in the&nbsp;<strong>elderly,&nbsp;</strong>not in children.</p>\n<p>It&nbsp;affects the<strong> legs, arms, </strong>and<strong> hands</strong> of&nbsp;elderly people in the context of <strong>very dry skin</strong>. The condition is usually chronic, relapsing each <strong>winter</strong> and clearing in the summer, but eventually becoming permanent.&nbsp;</p>\n<p>&nbsp;It may be a presenting sign of <strong>myxoedema</strong>. It can also be due to <strong>zinc deficiency</strong>.</p>\n<p><strong>Drugs</strong> implicated include:</p>\n<ul>\n<li>Diuretics</li>\n<li>Cimetidine</li>\n<li>Topical corticosteroids</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fd8a8ed52aef47b08cfb086f7e15a39e.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of the condition shown below?",
    "choices": [
      {
        "id": 1,
        "text": "Psoriasis"
      },
      {
        "id": 2,
        "text": "Eczema"
      },
      {
        "id": 3,
        "text": "Drugs"
      },
      {
        "id": 4,
        "text": "Cutaneous lymphoma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above image is suggestive of <strong>erythroderma</strong>&nbsp;which is an&nbsp;<strong>inflammatory skin disease</strong> affecting <strong>&gt;90%</strong> of<strong> body surface.</strong></p>\n<p>The <strong>most common causes</strong> of erythroderma in <strong>decreasing order</strong> of frequency are:</p>\n<ul>\n<li>Eczema&nbsp;(40%)</li>\n<li>Psoriasis&nbsp;</li>\n<li>Lymphoma and leukemias&nbsp;</li>\n<li>Drugs - phenylbutazone, phenytoin, carbamazepine, gold salts, lithium, cimetidine</li>\n</ul>\n<p>Note: If the option was between atopic dermatitis and psoriasis always choose <strong>psoriasis</strong> because the latter is the single most common cause of erythroderma whereas atopic dermatitis is one of the subtypes of eczema.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5be785a63a9f45d1870a3db067ede8b7.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a complication of erythroderma?",
    "choices": [
      {
        "id": 1,
        "text": "High output cardiac failure"
      },
      {
        "id": 2,
        "text": "Hypoalbuminemia"
      },
      {
        "id": 3,
        "text": "Respiratory infections"
      },
      {
        "id": 4,
        "text": "Hyperthermia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hypothermia</strong> is seen as a complication of erythroderma due to <strong>increased skin perfusion</strong>.&nbsp;There is no hyperthermia.</p>\n<p>The main complications of erythroderma are <strong>hemodynamic</strong> and <strong>metabolic</strong> disturbances.</p>\n<p>Option A: <strong>Increased</strong> skin <strong>perfusion</strong> results in high\u2010output <strong>cardiac failure.</strong>&nbsp;Fluid loss by transpiration may lead to hypovolemia.&nbsp;</p>\n<p>Option B: <strong>Hypoalbuminaemia</strong> is due to increased protein loss from <strong>exfoliated scales.</strong>&nbsp;</p>\n<p>Option C:&nbsp;Cutaneous, subcutaneous,&nbsp;and respiratory infections are common and <strong>pneumonia</strong> remains the <strong>commonest cause</strong> of <strong>death.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The following are true about the condition given in the image except:",
    "choices": [
      {
        "id": 1,
        "text": "More common in people with history of atopy"
      },
      {
        "id": 2,
        "text": "Sago grain vesicles seen on palms and sides of hand"
      },
      {
        "id": 3,
        "text": "They are painful but not pruritic"
      },
      {
        "id": 4,
        "text": "Topical corticosteroids can be used for this condition"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image is that of<strong> pompholyx</strong>, a distinct type of <strong>h</strong><strong>and eczema</strong>. It shows <strong>confluent vesicles</strong> that are&nbsp;<strong>painful</strong> and<strong> pruritic</strong>.</p>\n<p>It is also called <strong>vesicular</strong> eczema of palms and soles. This gives a<strong> sago grain</strong> or <strong>tapioca vesicle</strong> appearance.</p>\n<p><strong>Predisposing factors: </strong></p>\n<ul>\n<li>Atopy</li>\n<li>Naturally dry skin</li>\n<li>Allergic or irritant dermatitis -&nbsp;chromate, epoxy glues, and rubber</li>\n<li>Filaggrin gene mutations&nbsp;are&nbsp;predisposing factors</li>\n</ul>\n<p><strong>Treatment:</strong></p>\n<ul>\n<li><strong>First-line -&nbsp;</strong>Hand care advice, irritant, and allergen avoidance</li>\n<li><strong>Second-line - </strong>topical corticosteroids</li>\n<li><strong>Third line:</strong>\n<ul>\n<li>Alitretinoin</li>\n<li>PUVA</li>\n<li>Azathioprine</li>\n<li>Ciclosporin</li>\n<li>Methotrexate</li>\n</ul>\n</li>\n</ul>\n<p>The image below shows pompholyx.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4f1838108ee0408fa0f9b0e3b59eaa6b.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0d8ec6b043bb4f40ae2329cdf90ce526x942x707.JPEG"
    ]
  },
  {
    "text": "Which is the most common metal to cause allergic contact dermatitis?",
    "choices": [
      {
        "id": 1,
        "text": "Chromium"
      },
      {
        "id": 2,
        "text": "Nickel"
      },
      {
        "id": 3,
        "text": "Silver"
      },
      {
        "id": 4,
        "text": "Copper"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Nickel</strong> is the<strong> most frequent </strong>contact<strong> allergen</strong> for <strong>contact dermatitis.</strong> Most of its salts (nickel chloride, nickel sulfate) are readily <strong>soluble</strong> in water and<strong> sweat</strong> and have strong sensitizing properties.&nbsp;</p>\n<p>It is more<strong> common </strong>in<strong>&nbsp;women</strong> than in men. <strong>Jewelry</strong> and <strong>metal</strong> components of clothing are the usual sources of nickel in prolonged contact with the skin.&nbsp;</p>\n<p>Allergic contact dermatitis is an inflammatory reaction to a substance (allergen) that causes an eruption only in those individuals <strong>previously</strong> <strong>sensitized</strong> by the same molecule. It is a <strong>delayed-type</strong>&nbsp;of <strong>hypersensitivity</strong> (type IV).</p>\n<p>Substances causing allergic contact dermatitis:&nbsp;</p>\n<ul>\n<li>Chromium</li>\n<li>Palladium</li>\n<li>Gold</li>\n<li>Vegetable matter</li>\n<li>PPD in hair dye</li>\n</ul>\n<p>The diagnosis is made by a&nbsp;<strong>patch test</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old domestic help presents to the dermatology clinic with intensely pruritic lesions for 3 days. History reveals that the lesions started to develop after she recently changed the cleaning detergent. Choose the incorrect statement with respect to the likely diagnosis.",
    "choices": [
      {
        "id": 1,
        "text": "Sensitisation is not required"
      },
      {
        "id": 2,
        "text": "It can occur in anyone without predisposing factors"
      },
      {
        "id": 3,
        "text": "It is a Type-IV delayed hypersensitivity reaction"
      },
      {
        "id": 4,
        "text": "Due to direct toxic effects of a strong chemical"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above scenario is suggestive of <strong>irritant contact dermatitis</strong>&nbsp;which is the cutaneous response to the <strong>physical/toxic effects</strong> of a wide range of environmental exposures. It is<strong> not an immunologically</strong> mediated reaction.</p>\n<p>Irritant contact dermatitis is also called <strong>wear</strong> and<strong> tear</strong>&nbsp;<strong>dermatitis.</strong> Examples include <strong>h</strong><strong>ousewives eczema</strong> due to soaps and detergents and wetwork, napkin or diaper rash.<strong>&nbsp;</strong></p>\n<p>Treatment includes avoidance of irritants, personal protection, and <strong>'barrier creams'</strong><strong>.</strong></p>\n<table style=\"height: 185px; width: 518px; float: left;\">\n<tbody>\n<tr style=\"height: 2px;\">\n<td style=\"width: 246.031px; height: 2px; text-align: center;\"><strong>Irritant contact dermatitis</strong></td>\n<td style=\"width: 255.969px; height: 2px; text-align: center;\"><strong>Allergic contact dermatitis</strong></td>\n</tr>\n<tr style=\"height: 70px;\">\n<td style=\"width: 246.031px; height: 70px;\">Not an immunologically mediated reaction</td>\n<td style=\"width: 255.969px; height: 70px;\">Immunologically mediated&nbsp;reaction (type-IV delayed hypersensitivity)</td>\n</tr>\n<tr style=\"height: 67px;\">\n<td style=\"width: 246.031px; height: 67px;\">It can occur in anyone without predisposing factors</td>\n<td style=\"width: 255.969px; height: 67px;\">It only occurs in those individuals with a history of atopy</td>\n</tr>\n<tr style=\"height: 60px;\">\n<td style=\"width: 246.031px; height: 60px;\">Sensitization is not required&nbsp;</td>\n<td style=\"width: 255.969px; height: 60px;\">Sensitization phase required</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/21d5aa6ae6f345729a5b5ba2109011b2.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old male presents with itchy papules over the face, neck, and V area of the chest for the last 3 years which are exacerbated in summers and improved in winters. What test can be done to confirm the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "IgE levels"
      },
      {
        "id": 2,
        "text": "Skin biopsy"
      },
      {
        "id": 3,
        "text": "Prick Test"
      },
      {
        "id": 4,
        "text": "Photopatch Test"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given history points towards the diagnosis of <strong>p</strong><strong>hotoallergic contact dermatitis</strong>. <strong>Photopatch test</strong> is used to diagnose this condition.</p>\n<p>It is a <strong>delayed-type IV hypersensitivity</strong> reaction with a predilection for photo exposed&nbsp;sites&nbsp;with <strong>well\u2010demarcated margins</strong> where the skin is covered by clothing (at the collar and &lsquo;V&rsquo; of the neck, on the backs of the hands, and on the ankles). It spares the skin behind the earlobe (<strong>Wilkinson&rsquo;s triangle</strong>) since it is a photo-protected site.</p>\n<p><strong>Photopatch test:</strong>&nbsp;The standard patch test units are applied in two sets (on either side of the spine) and kept covered. One set of patches is removed and exposed to UVA. After irradiation, the other set of patches are also removed and both the sites are covered again for 48 hours. A <strong>positive reaction</strong> on the <strong>irradiated side</strong> only is an indication of photoallergy</p>\n<p>The image below shows a photopatch test showing reaction after exposure to UVA only.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ef04b197a4c24a58abdf6d4e585cc730x462x249.PNG"
    ]
  },
  {
    "text": "What is the gold standard diagnostic test for airborne contact dermatitis?",
    "choices": [
      {
        "id": 1,
        "text": "Radioallergosorbent assay"
      },
      {
        "id": 2,
        "text": "Patch test"
      },
      {
        "id": 3,
        "text": "Serum IgE assay"
      },
      {
        "id": 4,
        "text": "Serum eosinophil count"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>gold standard</strong> test for <strong>airborne contact dermatitis</strong> is a <strong>patch test.</strong></p>\n<p>Patch testing is done to document sensitivity to a specific antigen. Patch test antigens comprising suspected allergens are applied to the patient&rsquo;s back and covered for 48 hours. After the patch is removed, the area is examined for<strong>&nbsp;delayed type</strong>&nbsp;of<strong>&nbsp;hypersensitivity.</strong></p>\n<p>The image below shows a patch test.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0fb7c483b6704a37b47a851cc3b5af74x766x473.PNG"
    ]
  },
  {
    "text": "All of the following are causes of erythroderma except  _______",
    "choices": [
      {
        "id": 1,
        "text": "Pityriasis Rosea"
      },
      {
        "id": 2,
        "text": "Psoriasis"
      },
      {
        "id": 3,
        "text": "Seborrheic Dermatitis"
      },
      {
        "id": 4,
        "text": "Cutaneous Lymphoma"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Pityriasis rosea</strong> is not a cause of erythroderma.</p>\n<p>The most common causes of erythroderma in <strong>decreasing order</strong> of frequency are:</p>\n<ul>\n<li>Eczema of various subtypes including <strong>seborrheic dermatitis</strong></li>\n<li><strong>Psoriasis&nbsp;</strong></li>\n<li><strong>Lymphoma</strong> and leukemia</li>\n<li>Drugs - phenylbutazone, phenytoin, carbamazepine, gold salts, lithium, cimetidine</li>\n<li>Hereditary disorders - ichthyosiform erythroderma, pityriasis rubra pilaris</li>\n<li>Pemphigus foliaceus</li>\n<li>Other skin diseases - lichen planus, dermatophytosis, crusted scabies, dermatomyositis<br /><br /></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Atopic dermatosis"
      },
      {
        "id": 2,
        "text": "Adenoma sebaceum"
      },
      {
        "id": 3,
        "text": "Rosacea"
      },
      {
        "id": 4,
        "text": "Ichthyosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image shows <strong>atopic dermatosis.</strong></p>\n<p>Atopic dermatosis is a <strong>relapsing inflammatory skin disorder</strong> that is common in infancy and presents differently in different age groups. It is characterized by <strong>pruritus</strong> leading to<strong> lichenification. </strong></p>\n<p>Clinical features:</p>\n<ul style=\"list-style-type: disc;\">\n<li><strong>Infants -&nbsp;</strong>The lesions most frequently start on the face, and then, the <strong>extensor aspect</strong> of the knees and elbows are involved.</li>\n<li><strong>Children:</strong> Dry, scaly, pruritic, excoriated papules and plaques in the flexural areas and neck.</li>\n<li><strong>Adults:</strong> Lichenification and dry, fissured skin in a <strong>flexural distribution. </strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/394c9ad685af4d53a81d862fbeae869b.JPEG"
    ],
    "explanation_images": []
  }
];
        let quizName = '07 Dermatitis';
        const quizFilename = '07-dermatitis-e1b3f3c7.html';
        let hierarchy = ["Marrow", "qBank", "Dermatology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>