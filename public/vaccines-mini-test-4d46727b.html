<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaccines Mini Test - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2024-25
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Identify the correct statement about the information obtained from the vaccine vial monitor 14 (VVM14) shown in the image below.",
    "choices": [
      {
        "id": 1,
        "text": "It takes 14 days for the inner square to become darker than outer circle"
      },
      {
        "id": 2,
        "text": "It takes 14 days for the inner square and outer circle to reach the same color"
      },
      {
        "id": 3,
        "text": "The vaccine can be used for 14 days after the inner square and outer circle reach the same color"
      },
      {
        "id": 4,
        "text": "The vaccine can be used for 14 days after the outer circle color  becomes darker"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<div class=\"page\" title=\"Page 129\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The correct statement is option 2.</p>\n<p>The given scenario mentions<strong>&nbsp;VVM 14 </strong>(vaccine vial monitor 14), where <strong>14</strong> indicates the&nbsp;<strong>VVM number</strong>. It&nbsp;is the <strong>time in days</strong>&nbsp;for the <strong>inner square </strong>to reach the<strong> color of the outer circle </strong>when the vial is exposed to a constant temperature of 37&deg;C. This color change signifies the&nbsp;<strong>discard point</strong>&nbsp;of the vial.</p>\n</div>\n</div>\n</div>\n<p><strong>Vaccine Vial Monitors (VVM)</strong>&nbsp;are heat-sensitive indicators that are routinely used to monitor vaccine viability as the vaccine vial moves across the supply chain. It&nbsp;records&nbsp;<strong>cumulative heat exposure</strong>&nbsp;through a&nbsp;<strong>gradual change in color</strong>.</p>\n<p>There are currently 4 types of VVMs, they are chosen to match the <strong>heat sensitivity</strong> of the vaccines based on the VVM number.&nbsp;</p>\n<ul>\n<li>VVM 30: High Stability</li>\n<li>VVM 14: Medium Stability</li>\n<li>VVM 7: Moderate Stability</li>\n<li>VVM 2: Least Stable</li>\n</ul>\n<p>If the color of the<strong>&nbsp;inner square </strong>is the<strong> same </strong>or is<strong> darker than the outer</strong>&nbsp;circle, it indicates that the vaccine has been exposed to high temperatures and should be&nbsp;<strong>discarded.</strong></p>\n<p>Purpose of VVMs:</p>\n<ul>\n<li>Ensures that vaccines <strong>damaged by heat</strong> are not administered</li>\n<li>Decision on which vaccines to be kept after a <strong>cold chain break</strong> occurs, minimizing unnecessary vaccine wastage</li>\n<li>Decision on which <strong>vaccine</strong> is<strong> to be used first</strong>. Vaccines showing significant heat exposure should be used before those that show lower heat exposure, even if their expiry date is longer</li>\n</ul>\n<div class=\"page\" title=\"Page 129\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 129\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>There are two different locations for VVMs :</p>\n<ul>\n<li><strong>On the label</strong> of the vaccine: The vaccine vial, once opened, can be kept for subsequent immunization sessions for <strong>up to 28 days</strong>, regardless of the formulation of the product</li>\n<li>In a location <strong>other than on the label</strong> (e.g., cap or neck of ampoule): The vaccine vial, once opened should be discarded at the end of the immunization session or <strong>within six hours of opening</strong>, whichever comes first, regardless of the formulation of the product</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/379a129517164991916eee55809230e8.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Adjuvant used in DPT is:",
    "choices": [
      {
        "id": 1,
        "text": "Silica"
      },
      {
        "id": 2,
        "text": "Magnesium"
      },
      {
        "id": 3,
        "text": "Manganese"
      },
      {
        "id": 4,
        "text": "Aluminium"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Adsorbed DPT vaccine has <strong>aluminium phosphate or hydroxide</strong> as the mineral carrier or adjuvant, which is the most advocated preparation for immunization in infants.</p>\n<p>DPT vaccine is a combined vaccine against <strong>diphtheria, pertussis</strong>, and <strong>tetanus</strong>. It should be stored at<strong> 2 to 8 degree Celsius</strong>.</p>\n<p>Three doses are usually given for primary immunization,<strong>\u00a0intramuscularly, </strong>at 4 weeks apart.\u00a0<strong>Boosters</strong> are given at 1 \u00bd to 2 years and then at 5 to 6 years. <strong>Fever and mild local reactions</strong> are common post-immunization.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young American is planning an international trip to India. He asks his family doctor about the yellow fever vaccination for his infant. From what age is the yellow fever vaccination certificate mandatory?",
    "choices": [
      {
        "id": 1,
        "text": "\u2265 2 months"
      },
      {
        "id": 2,
        "text": "\u2265 9 months"
      },
      {
        "id": 3,
        "text": "\u2265 2 years"
      },
      {
        "id": 4,
        "text": "\u2265 5 years"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>yellow fever vaccination certificate</strong> is mandatory for infants&nbsp;<strong>&ge;9 months</strong>.</p>\n<p>A yellow fever vaccination certificate is mandatory for travellers coming from<strong>&nbsp;endemic areas</strong>&nbsp;like&nbsp;<strong>America</strong> and African countries to India. A <strong>live attenuated</strong>,&nbsp;<strong>17D strain </strong>vaccine<strong>&nbsp;</strong>is administered <strong>subcutaneously</strong> to the populations at risk.&nbsp;</p>\n<p>The vaccination must be given at an&nbsp;officially designated centre, and the certificate must be&nbsp;validated with the official stamp of the Indian Ministry of Health. Its validity begins after <strong>10 days</strong> from the <strong>date </strong>of<strong> vaccination</strong>. It is valid only if it is met with the standards of the model prescribed under international health regulations.</p>\n<p>The validity was for 10 years before, but now it is extended to <strong>lifelong</strong> after the introduction of the amendment in the World Health Assembly. If there is <strong>no certificate</strong> available, the traveller is advised to<strong> quarantine </strong>for <strong>6 days</strong> starting from the day they left the infected area.&nbsp;</p>\n<p>Yellow fever is a <strong>zoonotic disease</strong> caused by an <em><strong>A</strong><strong>rbovirus </strong></em>called<em><strong>&nbsp;F</strong><strong><em>lavivirus</em> fibricus.&nbsp;</strong></em>It is transmitted to man through the <strong>Aedes mosquito</strong>. The incubation period is <strong>6 days</strong>. Clinical features are similar to hemorrhagic fevers which include jaundice, epistaxis, and melena with severe hepatic and renal involvement.&nbsp;</p>\n<p><strong>India</strong> is a yellow fever <strong>receptive area. </strong>It is called so because we do not have yellow fever in India but conditions will allow its development if it is introduced. The virus reaches India through travellers from the infected areas and from mosquitoes that arrive through ships and aircraft from infected areas.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "According to WHO recommendations, which of the following statements is incorrect with respect to handling vaccine diluents?",
    "choices": [
      {
        "id": 1,
        "text": "Vaccine diluent containing an active substance should not be frozen"
      },
      {
        "id": 2,
        "text": "Vaccine diluent cannot be replaced with distilled water for injection"
      },
      {
        "id": 3,
        "text": "Diluent used to reconstitute an oral vaccine can be injected"
      },
      {
        "id": 4,
        "text": "Vaccine diluent cannot be replaced with a different diluent to the one specified"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>According to the WHO recommendations, the <strong>diluent</strong> used to reconstitute an<strong> oral vaccine</strong> should <strong>never</strong> be <strong>injected</strong>. Diluents for oral vaccines tend to be of significantly large volumes per dose and are not formulated for injection. These diluents may not have sterility characteristics and constituents appropriate for sterile injection. To avoid serious injury to the recipient, neither oral vaccines nor their assigned diluents should ever be injected.</p>\n<p>WHO recommendations on handling vaccine diluents :</p>\n<ul>\n<li>\u00a0Never reconstitute a vaccine with a different diluent to the one specified by the manufacturer.</li>\n<li>\u00a0Never replace a vaccine diluent with water for injection</li>\n<li>\u00a0Never inject an oral vaccine or a diluent used to reconstitute an oral vaccine\u00a0 \u00a0</li>\n<li>\u00a0Never freeze a vaccine diluent containing an active substance\u00a0</li>\n<li>\u00a0Never use a reconstituted vaccine if foreign particulate matter is observed.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 7-week-old child presented with abdominal pain and red currant jelly stools. The mother gives a history of vaccination to the child 1 week prior. A barium enema is done, and the image is given below. Which of the following vaccine is likely to be responsible for this adverse effect?",
    "choices": [
      {
        "id": 1,
        "text": "Rotavirus vaccine"
      },
      {
        "id": 2,
        "text": "Pentavalent vaccine"
      },
      {
        "id": 3,
        "text": "Pneumococcal conjugate vaccine"
      },
      {
        "id": 4,
        "text": "Oral Polio vaccine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"ng-star-inserted\">\n<div class=\"table-responsive font-weight-light answer-scroll ng-star-inserted\">\n<p>The clinical scenario of<strong>\u00a0abdominal pain, red currant jelly stool\u00a0</strong>along with barium enema showing the <strong>claw sign</strong>\u00a0is suggestive of <strong>intussusception.\u00a0</strong>The mother gives a history of vaccination at 6 weeks of age and the <strong>Rotavirus vaccine</strong> is associated with a risk of developing <strong>intussusception, </strong>usually <strong>within a week</strong> <strong>after the first or second dose.</strong></p>\n<p>Intussusception occurs when a portion of the bowel is<strong>\u00a0telescoped</strong>\u00a0into an adjacent segment.<strong>\u00a0</strong>It can be seen in infants during the weaning period following the introduction of new food, vaccination, or upper respiratory tract infection. The currently approved <strong>rotavirus vaccines</strong> are associated with a very minimal risk of intussusception. An area of enlarged submucosal <strong>Peyer's patch</strong> acts as a lead point for intussusception.</p>\n<p>Some <strong>lead points</strong> in children are <strong>Meckel's diverticulum,</strong>\u00a0intestinal polyp, inflamed appendix, submucosal hemorrhage seen in <strong>Henoch-Schonlein purpura</strong>, and intestinal duplication cysts. Patients present with <strong>cramping abdominal pain</strong>, palpable <strong>sausage-shaped abdominal mass</strong>, vomiting, and passage of <strong>red currant jelly stools</strong>. <strong>Diagnosis</strong> is confirmed by <strong>abdominal ultrasound </strong>which shows<strong> the t</strong><strong>arget sign/bull's eye sign </strong>(shown below)<strong>\u00a0</strong>and<strong> pseudo kidney</strong><strong>\u00a0sign</strong> (seen longitudinally).</p>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c903dc979355418eaf9fb3b833293406.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d81d8af7dc2c42c1847e0212ef827ddfx720x598.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/322a6381b6a84dfd93a2fda7c2454257x1144x1136.PNG"
    ]
  },
  {
    "text": "A child is brought to the clinic for the flu vaccine and you recommend the trivalent influenza vaccine. This vaccine contains all the following strains, except ____.",
    "choices": [
      {
        "id": 1,
        "text": "H1N1"
      },
      {
        "id": 2,
        "text": "H3N2"
      },
      {
        "id": 3,
        "text": "H2N1"
      },
      {
        "id": 4,
        "text": "Influenza subtype B"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The influenza vaccine does not contain<strong>\u00a0</strong>the<strong> H2N1 strain.</strong></p>\n<p>The trivalent and quadrivalent influenza vaccines are intended to protect against 3 and 4 flu viruses, respectively: influenza A viruses,\u00a0<strong>H1N1 and H3N2</strong>, and <strong>one or two influenza B</strong> viruses.</p>\n<p>They can either be a killed vaccine or live attenuated vaccines.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old female diagnosed with ITP is scheduled for elective splenectomy. Which of the following combination of vaccines is appropriate in this patient to prevent OPSI?",
    "choices": [
      {
        "id": 1,
        "text": "1 and 4"
      },
      {
        "id": 2,
        "text": "1, 3, and 4"
      },
      {
        "id": 3,
        "text": "2 and 4"
      },
      {
        "id": 4,
        "text": "2 and 3"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In adults, <strong>pneumococcal polysaccharide</strong> vaccine 23 (PPV-23), <strong>meningococcal</strong> <strong>C</strong> vaccine, and <strong>H.influenza B </strong>(Hib) vaccine are given to prevent overwhelming post-splenectomy infection (OPSI).</p>\n<p>PCV-13 vaccine can also be used in adults &gt; 65 years as well as in immunocompromised individuals &lt; 65 years (as recommended by the CDC).\u00a0</p>\n<p><strong>Heptavalent pneumococcal</strong> vaccine (PCV7) is useful in immunogenesis, in <strong>children</strong> &lt; 2 years of age.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a vaccination drive, a 36-year-old pregnant woman with an obstetric score of G4P3L2 comes to get vaccinated. Which of the following vaccines are contraindicated in this woman?",
    "choices": [
      {
        "id": 1,
        "text": "1, 3, 5"
      },
      {
        "id": 2,
        "text": "1, 3, 4"
      },
      {
        "id": 3,
        "text": "2, 3, 4"
      },
      {
        "id": 4,
        "text": "2, 4, 5"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Among the given options, <strong>varicella vaccine, rubella vaccine, </strong>and<strong> zoster vaccine</strong> cannot be administered to this patient as they are live vaccines, which are contraindicated in pregnant women.</p>\n<p>The live vaccines are contraindicated in pregnancy unless the risk of infection exceeds the risk of harm to the fetus.</p>\n<p><strong>Contraindications for live vaccines</strong>:</p>\n<ul>\n<li>Immune deficiency diseases</li>\n<li>Suppressed immune responses as a result of&nbsp;\n<ul>\n<li>Leukaemia</li>\n<li>Lymphoma</li>\n<li>Malignancies</li>\n<li>Corticosteroid therapy</li>\n<li>Treatment with alkylating agents and antimetabolic agents&nbsp;</li>\n<li>Therapeutic radiation</li>\n</ul>\n</li>\n<li>Pregnancy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with Wilm's tumor undergoes renal transplantation. He is currently on corticosteroid therapy to prevent organ rejection. All of the following vaccinations could be given to this patient except?",
    "choices": [
      {
        "id": 1,
        "text": "Diphtheria-pertussis-tetanus (DPT)"
      },
      {
        "id": 2,
        "text": "Hepatitis B vaccine"
      },
      {
        "id": 3,
        "text": "Intra-nasal Influenza vaccine"
      },
      {
        "id": 4,
        "text": "Inactivated polio vaccine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Intra-nasal/ nasal spray influenza</strong> vaccine is a<strong> live attenuated vaccine,</strong> therefore it is<strong>&nbsp;contraindicated</strong> in this patient as he is<strong> immunosuppressed.</strong></p>\n<p>Live vaccines are prepared from live or wild <strong>attenuated</strong> organisms. They are repeatedly passed through tissue cultures or chick embryos in the laboratory. With this, they lose their ability to induce full-blown infection in an individual but <strong>retain</strong> their <strong>immunogenicity</strong>. It should not be administered to patients with <strong>immunodeficiency</strong> diseases, lymphoma, leukemia, or other malignancies. It is also not recommended in individuals on treatment with <strong>corticosteroids</strong>, antimetabolites, and alkylating agents. Unless the risk of infection exceeds the risk of harm, it is contraindicated in <strong>pregnancy</strong>.</p>\n<p><strong>Intramuscular influenza</strong> vaccine is an<strong> inactivated</strong> vaccine, which can be given in the immunocompromised.</p>\n<p>Other options:</p>\n<p>Option A: <strong>Diptheria-pertussis-tetanus</strong> (DPT) vaccine is a combination&nbsp;<strong>toxoid </strong>vaccine. The toxins produced by diphtheria and tetanus bacilli are detoxicated and used to prepare the vaccine. They are highly <strong>efficacious</strong> and <strong>safe</strong>. The<strong> killed</strong> whole organism is used for the pertussis component.&nbsp;</p>\n<p>Option B: <strong>Hepatitis B vaccine</strong> is a <strong>recombinant</strong> vaccine. It is produced by inserting a viral gene segment into a yeast cell. It does not contain viral DNA and will <strong>not</strong> produce an <strong>infection</strong>.</p>\n<p>Option D: <strong>Inactivated polio vaccine</strong> is a <strong>killed</strong> vaccine. As the organism cannot grow in a vaccinated individual, it can be given to an immunodeficient individual.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following vaccines is composed of OKA strain?",
    "choices": [
      {
        "id": 1,
        "text": "Rubella"
      },
      {
        "id": 2,
        "text": "Varicella"
      },
      {
        "id": 3,
        "text": "Japanese encephalitis"
      },
      {
        "id": 4,
        "text": "Measles"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Varicella</strong> vaccine is composed of <strong>live attenuated OKA strain.</strong></p>\n<p>Other options:&nbsp;</p>\n<p>Option A - Live attenuated <strong>RA 27/3 strain</strong> is used for the <strong>rubella vaccine.</strong></p>\n<p>Option C - Live attenuated&nbsp;<strong>SA 14-14-2</strong>&nbsp;strain is used for the <strong>JE vaccine</strong>&nbsp;(Japanese encephalitis) which is based on a stable neuro-attenuated strain of the JE virus.</p>\n<p>Option D - The&nbsp;<strong>Edmonston-Zagreb measles strain </strong>is used for&nbsp;the live attenuated <strong>measles vaccine</strong> used in India.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a measles epidemic in the community, a 6-month-old child was vaccinated for measles. What is the correct schedule to be followed for the immunization regarding measles for this child now?",
    "choices": [
      {
        "id": 1,
        "text": "The child should be given a second dose as soon as she reaches 9 months of age"
      },
      {
        "id": 2,
        "text": "The child should be given a second dose after 2 weeks of last dose"
      },
      {
        "id": 3,
        "text": "The child should be given a second dose after 6 weeks of last dose"
      },
      {
        "id": 4,
        "text": "The child should be given the second dose of measles at 12 months of age"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>An infant immunized between 6-9 months should receive a second dose as soon as the child reaches 9 months of age.</p>\n<p>While the scheduled age of receiving the measles vaccine is at 9 months, it can be lowered to 6 months during a measles epidemic in the community.</p>\n<p>For infants immunized between 6 months to 9 months of age, a second dose should be administered as soon as the child reaches the age of 9 months, <strong>provided that 4 weeks have elapsed since the last dose.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 14-week-old child is brought to your clinic for a routine checkup. Which of the following vaccines should be administered as per National Immunization Schedule?",
    "choices": [
      {
        "id": 1,
        "text": "OPV-4"
      },
      {
        "id": 2,
        "text": "PPV-2"
      },
      {
        "id": 3,
        "text": "fIPV-2"
      },
      {
        "id": 4,
        "text": "RVV-2"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>This child of 14 weeks should receive <strong>2nd dose </strong>of <strong>fractional-dose inactivated polio vaccine </strong>(fIPV-2).</p>\n<div class=\"page\" title=\"Page 231\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 198\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>WHO recommends that all countries using only OPV should add at least one dose of IPV to the national schedule.&nbsp;In order to ensure that all eligible infants receive IPV, a&nbsp;dose-sparing strategy was used to match the supply and demand. This strategy used one-fifth of the IM dose given intradermally.</p>\n</div>\n</div>\n</div>\n<p><strong>2 doses </strong>of<strong> fIPV </strong>given<strong> intradermally</strong> at the&nbsp;<strong>6th</strong> and<strong> 14th weeks</strong> provide higher seroconversion rates than a single full dose of IPV given intramuscularly at 14 weeks.&nbsp;</p>\n</div>\n</div>\n</div>\n<p>The comparison between IPV and fIPV is shown below:</p>\n<table style=\"height: 106px; width: 323.531px;\">\n<tbody>\n<tr style=\"height: 48px;\">\n<td style=\"width: 75px; height: 48px;\">&nbsp;</td>\n<td style=\"width: 95px; height: 48px;\"><strong>IPV</strong></td>\n<td style=\"width: 125.531px; height: 48px;\"><strong>Fractional-dose IPV (fIPV)</strong></td>\n</tr>\n<tr style=\"height: 42px;\">\n<td style=\"width: 75px; height: 42px;\">Dose</td>\n<td style=\"width: 95px; height: 42px;\">0.5 mL</td>\n<td style=\"width: 125.531px; height: 42px;\">0.1 mL</td>\n</tr>\n<tr style=\"height: 55px;\">\n<td style=\"width: 75px; height: 55px;\">Schedule</td>\n<td style=\"width: 95px; height: 55px;\">1 dose:14 weeks</td>\n<td style=\"width: 125.531px; height: 55px;\">2 doses:6 and 14 weeks</td>\n</tr>\n<tr style=\"height: 49px;\">\n<td style=\"width: 75px; height: 49px;\">Route</td>\n<td style=\"width: 95px; height: 49px;\">Intra-muscular</td>\n<td style=\"width: 125.531px; height: 49px;\">Intradermal</td>\n</tr>\n<tr style=\"height: 38.75px;\">\n<td style=\"width: 75px; height: 38.75px;\">Site</td>\n<td style=\"width: 95px; height: 38.75px;\">Thigh</td>\n<td style=\"width: 125.531px; height: 38.75px;\">Upper arm</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following vaccine is most sensitive to heat?",
    "choices": [
      {
        "id": 1,
        "text": "Japanese encephalitis vaccine"
      },
      {
        "id": 2,
        "text": "Measles vaccine"
      },
      {
        "id": 3,
        "text": "Oral polio vaccine"
      },
      {
        "id": 4,
        "text": "Pentavalent vaccine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Oral Polio Vaccine\u00a0</strong>is the <strong>most</strong>\u00a0<strong>heat-sensitive</strong>\u00a0vaccine.<strong>\u00a0</strong>Hence, it is kept in the\u00a0<strong>lower zone\u00a0</strong>of the Ice Lined Refrigerator.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A child was brought to the primary health center for vaccination. The parents informed the medical officer that the child had a history of egg allergy. Which of the following vaccines can not be given to the child?",
    "choices": [
      {
        "id": 1,
        "text": "1 and 4"
      },
      {
        "id": 2,
        "text": "2 and 5"
      },
      {
        "id": 3,
        "text": "1 and 2"
      },
      {
        "id": 4,
        "text": "3 and 4"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the given clinical scenario, <strong>yellow fever</strong> and<strong> influenza vaccines</strong> cannot be given to a child who has an<strong> egg allergy.</strong></p>\n<p><strong>Yellow fever</strong> and <strong>influenza vaccines</strong> are prepared in <strong>hen's egg tissues.</strong> Hence, they cannot be given to a patient with a history of anaphylactic reactions following egg ingestion.&nbsp;However, vaccine viruses propagated in chicken fibroblast cells like measles or MMR vaccines can be given.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 9-month-old baby is brought by his mother for vaccination. The concept of conjugate and polysaccharide vaccines is explained to her.  Which of the following is incorrect regarding conjugate vaccines?",
    "choices": [
      {
        "id": 1,
        "text": "They are not effective in children below 2 years of age"
      },
      {
        "id": 2,
        "text": "They produce strong immunity"
      },
      {
        "id": 3,
        "text": "They are sero-specific"
      },
      {
        "id": 4,
        "text": "They act via T-cell dependent mechanism"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option 1 is the incorrect statement.<strong> Conjugate vaccines</strong> are <strong>effective</strong> in children <strong>below 2 years of age</strong>.\u00a0</p>\n<p>Antigens in polysaccharide vaccines produce antibodies via a T-cell-independent mechanism. Children under 2 years of age <strong>do not</strong> respond well to such antigens. A <strong>stronger immune response</strong> and\u00a0<strong>immune memory</strong> in young children can be elicited if these polysaccharide antigens are chemically linked or conjugated to a protein that is recognized by T-cells. As conjugate vaccines are serotype-specific, multivalent formulations are required to achieve protection against multiple serotypes. Examples are pneumococcal and meningococcal vaccines.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A mother brings her 9-month-old baby to the immunization clinic. The baby is scheduled to receive the booster dose of his Pneumococcal conjugate vaccine (PCV 13). Which of the following statements are true about the vaccine in question?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2 and 4"
      },
      {
        "id": 2,
        "text": "1, 2, and 3"
      },
      {
        "id": 3,
        "text": "1 and 3 only"
      },
      {
        "id": 4,
        "text": "2 and 3 only"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Statements <strong>1, 2, and 4</strong> are <strong>true</strong>.</p>\n<p>Pneumococcal vaccines include:</p>\n<ul>\n<li>Pneumococcal <strong>conjugate</strong> vaccines (<strong>PCV</strong>): 10-valent (<strong>PCV10</strong>) and 13-valent (<strong>PCV13</strong>)</li>\n<li>Pneumococcal <strong>polysaccharide</strong> vaccine (<strong>PPSV</strong>): 23-valent polysaccharide vaccine (<strong>PPSV23</strong>)</li>\n</ul>\n<p>The <strong>Pneumococcal conjugate vaccine (PCV)</strong> <strong>13</strong>: It&nbsp;includes purified capsular polysaccharides of 13 serotypes of&nbsp;<em>Streptococcus pneumoniae</em>&nbsp;conjugated to a nontoxic variant of diphtheria toxin. Both PCV10 and PCV13 are preservative-free and their <strong>recommended storage temperature</strong> is <strong>2-8&deg;C</strong>. The vaccine <strong>must not</strong> be <strong>frozen</strong>.</p>\n<div class=\"page\" title=\"Page 194\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>WHO recommends <strong>3 primary doses</strong> or <strong>2 primary doses</strong> plus <strong>one booster</strong> of the PCV vaccine. In India, 2 primary doses at 6 and 14 weeks and 1 booster is given at 9-12 months.</p>\n<p><strong>Mild reactions</strong> like erythema and tenderness may occur, but systemic reactions are not known to occur. <strong>Revaccination</strong> is <strong>not recommended</strong> for those who had an <strong>anaphylactic reaction</strong> to the initial dose.</p>\n<div class=\"page\" title=\"Page 194\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Regardless of the presence of underlying medical conditions (e.g., children with HIV infection, sickle cell disease, or who are otherwise immunocompromised), PCV should be given according to the national schedule. PCV is <strong>safe</strong> and <strong>well-tolerated</strong> among <strong>HIV-infected</strong> children. Children with <strong>HIV</strong> infection require a <strong>booster</strong> dose to sustain protection.</p>\n<p>When primary immunization is initiated with one of these vaccines, it is recommended that the remaining doses are administered with the same product. WHO recommends the inclusion of PCVs in childhood immunization programs worldwide.&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<p><strong>Pneumococcal polysaccharide vaccine -</strong> PPSV23: It contains polysaccharide antigen from 23 types of pneumococcal bacteria and<strong>&nbsp;</strong>is&nbsp;available for <strong>adults</strong> and <strong>children over 2 years</strong> of age. Children under 2 years of age and immunocompromised individuals do not respond well to the vaccine. It is recommended for <strong>selected</strong> groups such as:</p>\n<ul>\n<li>Post splenectomy</li>\n<li>Sickle-cell disease</li>\n<li>Chronic diseases of heart, lung, liver, or kidney</li>\n<li>Generalized malignancies</li>\n<li>Organ transplants</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "As a medical officer at a primary health center, you are training the staff to arrange different vaccines in ice-lined refrigerators (ILRs). What will be your advice for oral polio vaccine (OPV)?",
    "choices": [
      {
        "id": 1,
        "text": "Keep it in the upper zone as it is heat sensitive."
      },
      {
        "id": 2,
        "text": "Keep it in the upper zone as it is freeze sensitive."
      },
      {
        "id": 3,
        "text": "Keep it in the lower zone as it is heat sensitive."
      },
      {
        "id": 4,
        "text": "Keep it in the lower zone as it is freeze sensitive."
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>OPV\u00a0</strong>is\u00a0<strong>heat sensitive</strong>;<strong>\u00a0</strong>hence, it is kept in the\u00a0<strong>lower zone\u00a0</strong>of ILR.</p>\n<p>ILRs are the main method of <strong>vaccine storage</strong> in district and sub-district vaccine stores (PHCs). They are an important part of the cold chain, and they maintain a temperature of <strong>2 to 8 \u00b0C</strong> for the storage of vaccines. <br /><br />They have different temperature zones for different vaccines.\u00a0The<strong> upper zone </strong>in the ILR<strong>\u00a0</strong>is for<strong> freeze-sensitive vaccines</strong> like cholera vaccine, hepatitis B vaccine, and rotavirus vaccine (liquid), while the <strong>lower zone</strong> is for<strong> heat-sensitive vaccines</strong> like <strong>OPV and</strong>\u00a0measles vaccine.</p>\n<p>All vaccines are kept in the basket provided with ILR. Vaccines like OPV, BCG, measles, and JE can be kept at the bottom of the basket while, DPT, TT, Hep B, IPV, and pentavalent vaccines and diluents are kept in the upper part of the basket.\u00a0</p>\n<p>Note: In the sub-district stores, OPV is kept in ILR, whereas in higher-level vaccine stores, it is kept in deep freezer (<strong>DF</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 23-year-old man presents to your PHC with a Category III dog bite. But, Rabies Immunoglobulin (RIG) is not available at your center. How would you manage the patient?",
    "choices": [
      {
        "id": 1,
        "text": "Administer 1st dose of vaccine and refer to higher center for administration of RIG"
      },
      {
        "id": 2,
        "text": "Skip RIG as there is no use in administering it after the first dose of vaccine is administered"
      },
      {
        "id": 3,
        "text": "Withhold vaccine till RIG becomes available as RIG should be administered prior to first dose of vaccine"
      },
      {
        "id": 4,
        "text": "Withhold vaccine till RIG becomes available as they should be administered simultaneously"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Administer 1st dose of vaccine</strong> and <strong>refer</strong> to higher center <strong>for</strong> administration of <strong>Rabies Immunoglobulin.</strong></p>\n<p>Rabies immunoglobulin (RIG) is <strong>passive immunization</strong>.&nbsp;It is administered <strong>only once</strong>, preferably <strong>within 24 hours </strong>of the exposure, i.e., on day 0 of the anti-rabies vaccine (ARV). If RIG was not given with the ARV 1st dose, it can be <strong>given up to the 7th day</strong> after the first dose of ARV. It is not given after 7 days of receiving the 1st dose of ARV.</p>\n<p>The dose is <strong>20 IU/kg</strong> body weight for <strong>human rabies immunoglobulin&nbsp;</strong>(HRIG) and for <strong>equine rabies immunoglobulin </strong>(ERIG), the dose is<strong> 40 IU/kg</strong> body weight.&nbsp;When HRIG is not available, ERIG can be used. They are potent, safe, and less expensive.&nbsp;</p>\n<p>The entire RIG dose or as much as anatomically possible should be <strong>infiltrated into the wound</strong> <strong>or as close as possible</strong>. If it is likely that there are additional small wounds, the remaining RIG should be given IM as close as possible to the site of wound or exposure.</p>\n<p>All patients with&nbsp;<strong>category III</strong> exposures should be given RIG. This includes</p>\n<ul>\n<li>single/multiple transdermal bites/scratches,</li>\n<li>licks on broken skin,</li>\n<li>contamination of mucous membranes with saliva,</li>\n<li>contact with bats.</li>\n</ul>\n<p>In immunocompromised patients, RIG should be given to both category II and III exposures.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A child presents with seizures and infantile spasms to the pediatric outpatient. Her mother gives a history of DPT vaccination 2 days back. Under which of the following categories would you classify this adverse effect following immunization?",
    "choices": [
      {
        "id": 1,
        "text": "Vaccine quality defect\u2013related reaction"
      },
      {
        "id": 2,
        "text": "Vaccine product\u2013related reaction"
      },
      {
        "id": 3,
        "text": "Immunization error\u2013related reaction"
      },
      {
        "id": 4,
        "text": "Immunization anxiety\u2013related reaction"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The occurrence of <strong>seizures</strong> and <strong>infantile</strong> <strong>spasms</strong> following the administration of the <strong>DPT</strong>&nbsp;vaccine is classified as a&nbsp;<strong>vaccine product&ndash;related reaction.</strong></p>\n<p><strong>Adverse effects following immunization</strong> (AEFI) are defined as any untoward medical occurrence which follows immunization and which does not necessarily have a causal relationship with the usage of the vaccine. It can present as an unfavorable or unintended sign, abnormal laboratory finding, symptom, or disease.</p>\n<p>In the given scenario, the onset of a <strong>seizure</strong> and <strong>infantile spasms</strong> are known side effects due to the <strong>inherent</strong> property of the <strong>pertussis</strong> <strong>component</strong> of the DPT vaccine. Hence, they are classified as <strong>vaccine product-related reaction AEFI.</strong></p>\n<p><strong>Revised cause-specific categorization of AEFI</strong> as given by the WHO:</p>\n<p>1.<strong> Vaccine product&ndash;related reaction&nbsp;</strong>-&nbsp;AEFI is caused or precipitated by a vaccine due to one or more of the <strong>inherent properties </strong>of the vaccine product.</p>\n<p>2. <strong>Vaccine quality defect&ndash;related reaction&nbsp;</strong>-&nbsp;AEFI is caused or precipitated by a vaccine that is due to one or more <strong>quality defects</strong> of the vaccine product, including its administration device as provided by the manufacturer. Example -<strong>&nbsp;failure by the manufacturer</strong> to completely inactivate a lot of inactivated polio vaccines leading to cases of paralytic polio (Option A)</p>\n<p>3. <strong>Immunization error&ndash;related reaction&nbsp;</strong>-&nbsp;AEFI is caused by<strong> inappropriate vaccine handling</strong>, prescribing, or administration and thus is <strong>preventable</strong>. Example- the transmission of infection by a contaminated multidose vial (Option C)</p>\n<p>4.<strong> Immunization anxiety&ndash;related reaction&nbsp;</strong>-&nbsp;An AEFI arising from <strong>anxiety</strong> about the immunization. Example - vasovagal syncope in an adolescent during/following vaccination (Option D)</p>\n<p>5. <strong>Coincidental event&nbsp;</strong>-&nbsp;AEFI is caused by something other than the vaccine product, immunization error, or immunization anxiety. Example -&nbsp;a fever occurring at the same time as the vaccination (temporal association), but is, in fact, caused by another disease such as malaria</p>\n<p>Vaccine product-related reactions and vaccine quality defect-related reactions are together known as <strong>vaccine reactions</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the two vaccines given below enlisted in the National Immunisation Schedule have the same route of administration?",
    "choices": [
      {
        "id": 1,
        "text": "Rabies vaccine & fIPV"
      },
      {
        "id": 2,
        "text": "BCG & fIPV"
      },
      {
        "id": 3,
        "text": "BCG & JE-1"
      },
      {
        "id": 4,
        "text": "fIPV & Hepatitis B"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>BCG and fIPV are both administered 0.1 ml <strong>intradermally</strong> in the left and right upper arm respectively according to the National Immunisation schedule.</p>\n<p>Earlier IPV was given as single dose of 0.5 ml intramuscular (IM) injection in thigh at 14 weeks. Now, <strong>two fractionated doses of IPV </strong>(fIPV) of 0.1 ml given intradermally at <strong>6 and 14 weeks</strong> which produces better <strong>immunogenicity</strong> than the previous one.\u00a0</p>\n<p>Other options:</p>\n<p>Option A: <strong>Rabies</strong> can be given intra dermally but however it is not included in the National Immunisation Schedule. Hence not the right answer.</p>\n<p>Option C:<strong> JE- 1</strong> and <strong>measles</strong> vaccines are administered <strong>subcutaneously</strong>.</p>\n<p>Option D:\u00a0 <strong>Hepatitis B</strong> is given <strong>intramuscularly</strong> immediately after birth or within 24 hours of birth.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = 'Vaccines Mini Test';
        const quizFilename = 'vaccines-mini-test-4d46727b.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2024-25"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>