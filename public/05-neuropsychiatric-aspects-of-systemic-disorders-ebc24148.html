<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05 Neuropsychiatric Aspects Of Systemic Disorders - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Psychiatry
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">14</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A cortically blind man who firmly believed his vision was normal despite evidence to the contrary was referred to the psychiatry OPD. On further evaluation, the patient also appeared to employ confabulation quite frequently. Which of the following conditions is this patient most likely suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Korsakoff syndrome"
      },
      {
        "id": 2,
        "text": "Wernicke\u2019s encephalopathy"
      },
      {
        "id": 3,
        "text": "Anton syndrome"
      },
      {
        "id": 4,
        "text": "Psychogenic amnesia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong> Anton syndrome </strong>is characterized by <strong>cortical blindness </strong>with<strong>&nbsp;confabulation.</strong></p>\n<p>Confabulation refers to the unconscious filling of gaps in memory&nbsp;with inaccurate, fabricated, and often implausible information.&nbsp;</p>\n<p>Anton syndrome occurs due to occipital lobe damage. Here, the patient denies loss of vision (known as visual anosognosia) and defends it by confabulation even when there is obvious evidence of visual loss and cortical blindness.&nbsp;</p>\n<p>Other causes of confabulation:</p>\n<ul>\n<li style=\"font-weight: 400;\">&nbsp;&nbsp;Wernicke&rsquo;s Korsakoff syndrome&nbsp;</li>\n<li style=\"font-weight: 400;\">&nbsp;&nbsp;Traumatic brain injury</li>\n</ul>\n<p><strong>Korsakoff syndrome</strong> is characterized by predominant <strong>anterograde amnesia</strong> and some retrograde amnesia. <strong>Confabulation</strong> is present in order to cover the memory deficit.</p>\n<p><strong>Wernicke's encephalopathy</strong> is characterized by confusion, ophthalmoplegia, and ataxia.</p>\n<p><strong>Psychogenic amnesia</strong> does not present with confabulation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a feature of Korsakoff syndrome?",
    "choices": [
      {
        "id": 1,
        "text": "Impaired long term memory"
      },
      {
        "id": 2,
        "text": "Anterograde amnesia"
      },
      {
        "id": 3,
        "text": "Confabulation"
      },
      {
        "id": 4,
        "text": "Retrograde amnesia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Long-term memory is <strong>normal</strong> in Korsakoff syndrome. In Korsakoff syndrome,&nbsp;<strong>immediate recall is impaired</strong> but long-term memory is preserved.&nbsp;</p>\n<p>Korsakoff syndrome is a type of <strong>diencephalic amnesia</strong>, caused by <strong>chronic thiamine deficiency</strong> and alcohol abuse.</p>\n<p>Clinically, subjects with Korsakoff syndrome present with the following:</p>\n<ul>\n<li><strong>Severe</strong>&nbsp;<strong>anterograde amnesia - </strong>striking inability to form new memories&nbsp;</li>\n<li>Impaired mental syndrome (especially recent memory)</li>\n<li>Present with <strong>confabulation</strong>, as an attempt to cover the memory deficit</li>\n<li>Retrograde amnesia is less severe, but <strong>present</strong>.</li>\n<li>Implicit learning (e.g., learning procedures) are <strong>preserved</strong></li>\n<li>Overall intact intelligence</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old man was brought to the casualty after being found lying on the street, muttering to himself, and cursing at bystanders. His MMSE score was 20. Physical examination findings are shown below. After admission, it is known that he has severe diarrhea and vomiting. Which of the following is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Myxedema madness"
      },
      {
        "id": 2,
        "text": "Vitamin B3 deficiency"
      },
      {
        "id": 3,
        "text": "Acute intermittent porphyria"
      },
      {
        "id": 4,
        "text": "Thiamine deficiency"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The symptoms of <strong>dementia&nbsp;</strong>(MMSE score of 20),&nbsp;<strong>diarrhea,&nbsp;</strong>and<strong> dermatitis</strong>&nbsp;in sun-exposed areas like the forehead, neck (Casal's necklace),&nbsp;and hands&nbsp;are seen in <strong>vitamin B3</strong> (niacin) <strong>deficiency</strong> also known as <strong>pellagra.&nbsp;</strong></p>\n<p>The neuropsychiatric symptoms of pellagra include apathy, irritability, insomnia, depression, and delirium.</p>\n<p>Option A: <strong>Myxedema madness&nbsp;</strong>is a rare presentation of hypothyroidism characterized by depression, hypomania, and schizophrenia. Diarrhoea and vomiting are usually not seen.</p>\n<p>Option C: <strong>Acute intermittent porphyria</strong> is characterized by periodic abdominal pain, peripheral neuropathy, psychotic features, tachycardia. There is <strong>no photosensitivity</strong> in acute intermittent porphyria.</p>\n<p>Option D: <strong>Thiamine deficiency</strong> can cause <strong>Wernicke&rsquo;s</strong> encephalopathy which manifests as an acute neuropsychiatric syndrome characterized by <strong>nystagmus, ophthalmoplegia</strong>, mental status changes, and <strong>unsteadiness</strong> of stance and gait, or can cause <strong>Korsakoff</strong> syndrome which manifests as a chronic amnestic syndrome&nbsp;characterized by severe anterograde amnesia and confabulation.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/12d8ff394cf348f39156814c1e438193.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 20-year-old woman with no family history of psychiatric illness was referred to psychiatry OPD from neurology for management of acute psychiatric disturbances. She had the following finding on slit-lamp examination and her 24-hour urinary copper was found to be elevated. Which of the following is a true statement regarding neuropsychiatric manifestations of this disease?",
    "choices": [
      {
        "id": 1,
        "text": "Unsteadiness of gait and incoordination are the most common manifestation"
      },
      {
        "id": 2,
        "text": "Wing beating tremors are a characteristic feature"
      },
      {
        "id": 3,
        "text": "The degree of depression correlates with the degree of neurological impairment"
      },
      {
        "id": 4,
        "text": "The most common form of progression is the choreatic form"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In the majority of the cases, neuropsychiatric manifestations follow hepatic manifestations. It is due to the deposition of free copper in the <strong>basal ganglia</strong> (bilateral degeneration) and cortex. The features include:</p>\n<ul>\n<li><strong>Dysarthria</strong> (most common): Irregular word spacing, hypophonic or spastic speech.</li>\n<li><strong>Dystonia</strong>: Vacuous smile i.e mask-like face with an open mouth.</li>\n<li><strong>Parkinsonism: </strong>Bradykinesia, postural instability, rigidity.</li>\n<li>Subcortical dementia: Slow mental processing, memory loss.</li>\n<li>Psychiatric symptoms: Loss of emotional control, depression, hyperactivity.</li>\n<li>Decreased scholastic performance: Deterioration in handwriting, clumsiness.</li>\n<li>Autonomic symptoms: Excessive sweating and salivation, sexual dysfunction.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/75ab9fa5697e44e392c5502783cf6c35.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/67b552c6a0ad4357adc9c3591fa45536x720x576.GIF"
    ]
  },
  {
    "text": "A patient presents with mental confusion, visual and auditory hallucinations, perceived changes of body shape, swelling of the tongue and a fear of impending death after he was treated for primary chancre of syphilis with an intramuscular injection. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Adjustment reaction"
      },
      {
        "id": 2,
        "text": "Undiagnosed psychosis"
      },
      {
        "id": 3,
        "text": "Jarisch-Herxheimer reaction"
      },
      {
        "id": 4,
        "text": "Hoigne syndrome"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The development of\u00a0<strong>acute psychotic symptoms</strong>\u00a0after intramuscular administration of penicillin G points to a diagnosis of\u00a0<strong>Hoigne syndrome. </strong>It may also be seen after benzathine administration also.\u00a0</p>\n<p>Hoigne syndrome:</p>\n<ul>\n<li><strong>Acute psychotic symptoms</strong>\u00a0are seen such as\u00a0mental confusion, visual and auditory hallucinations, and perceived changes of body shape.</li>\n<li>The patient may also present with swelling of the tongue and a fear of impending death.</li>\n<li>These are usually <strong>embolic</strong> toxic\u00a0reactions, possibly due to <strong>vascular occlusion</strong> by large crystals of the penicillin salts.\u00a0</li>\n<li>It is due to a\u00a0pseudoanaphylactic or <strong>pseudoallergic\u00a0reaction</strong>, not\u00a0penicillin allergy.</li>\n</ul>\n<p>A\u00a0<strong>Jarisch\u2013Herxheimer reaction</strong>\u00a0is a\u00a0transient clinical phenomenon that occurs in patients infected with spirochetes like syphilis, leptospirosis, Lyme disease, and relapsing fever, who are treated with antibiotics. The reaction occurs within 24 hours of antibiotic\u00a0therapy.\u00a0It generally manifests as fever, chills, rigors, nausea and vomiting, headache, tachycardia, hypotension, hyperventilation, flushing, myalgia, and exacerbation of skin lesions. It is an acute,\u00a0self-limiting condition.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is false regarding AIDS dementia complex?",
    "choices": [
      {
        "id": 1,
        "text": "Microglial nodules with multinucleated giant cells are seen on brain biopsy"
      },
      {
        "id": 2,
        "text": "It is considered as an AIDS-defining illness"
      },
      {
        "id": 3,
        "text": "Losing track of conversations in mid sentence is a late feature"
      },
      {
        "id": 4,
        "text": "It is the most severe form of HIV associated neurocognitive disorders"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Cognitive impairment</strong> is the <strong>earliest</strong> presenting symptom in the&nbsp;<strong>AIDS dementia complex </strong>(HIV encephalopathy), which is the most severe form of HIV-associated neurocognitive disorders.</p>\n<p>Patients most often <strong>lose track</strong> of actions and conversations in<strong> mid-sentence</strong>, have difficulty attending to more complex tasks at work or at home. They need to make detailed lists of the day's activities and processing unrelated or complex thoughts becomes slower.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A chronic alcoholic who hadn\u2019t consumed alcohol for the past 3 days was brought to the emergency department. He had features of disorientation, poor attention span, and agitation. On examination, he had fever, tachycardia, and diaphoresis. Identify the condition.",
    "choices": [
      {
        "id": 1,
        "text": "Korsakoff psychosis"
      },
      {
        "id": 2,
        "text": "Wernicke\u2019s encephalopathy"
      },
      {
        "id": 3,
        "text": "Delirium tremens"
      },
      {
        "id": 4,
        "text": "Alcohol-induced dementia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario of disorientation with features of autonomic hyperactivity (tachycardia, diaphoresis, fever) in a patient who stopped alcohol 3 days back is suggestive of <strong>delirium tremens.</strong></p>\n<p>Delirium tremens is the most severe alcohol withdrawal syndrome.\u00a0It occurs usually within <strong>3</strong><strong>-4 days</strong> of alcohol withdrawal.</p>\n<p>Characteristic features are:</p>\n<ul>\n<li>Clouding of consciousness with <strong>disorientation </strong>to time and place</li>\n<li>Poor attention and <strong>distractibility</strong></li>\n<li><strong>Visual hallucination</strong> and<strong> illusions</strong> which are often vivid and frightening</li>\n<li>Autonomic disturbances like<strong> tachycardia, fever, </strong>hypertension, sweating, and pupillary dilatation</li>\n<li>Psychomotor agitation and ataxia</li>\n</ul>\n<p><strong>Benzodiazepines\u00a0</strong>such as<strong>\u00a0chlordiazepoxide and lorazepam\u00a0</strong>are used in the treatment and prevention of delirium tremens.</p>\n<div class=\"page\" title=\"Page 650\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Option A: <strong>Korsakoffs</strong> psychosis is characterized by impaired mental abilities (especially recent memory) and <strong>anterograde amnesia</strong> in an alert and responsive patient. The patient may have symptoms of <strong>confabulation.</strong></p>\n<p>Option B: <strong>Wernicke's</strong> encephalopathy is characterized by <strong>ataxia</strong> (affecting primarily the gait), vestibular dysfunction, confusion, and <strong>ocular motility abnormalities.</strong></p>\n<p>Option D:<strong>\u00a0Alcohol-induced dementia</strong> is characterized by the development of <strong>multiple</strong>\u00a0<strong>cognitive deficits</strong>\u00a0(e.g., memory problems, language impairment, and an inability to perform complex motor tasks) that are judged to be a direct consequence of alcohol use. This\u00a0<strong>persists beyond</strong> the usual <strong>duration of</strong> alcohol intoxication or <strong>acute withdrawal</strong>.</p>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 7-year-old-child abruptly developed symptoms suggestive of obsessive-compulsive disorder and Tourette syndrome. PANDAS, a pediatric neuropsychiatric disorder, is suspected. Which of the following organism is associated with this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 2,
        "text": "Streptococcus pneumoniae"
      },
      {
        "id": 3,
        "text": "Streptococcus pyogenes"
      },
      {
        "id": 4,
        "text": "Staphylococcus epidermidis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>PANDAS is associated with <strong><em>Streptococcus pyogenes</em> </strong>infection.</p>\n<p><strong>PANDAS&nbsp;</strong>stands for<strong>&nbsp;P</strong>ediatric <strong>A</strong>utoimmune <strong>N</strong>europsychiatric <strong>D</strong>isorders <strong>A</strong>ssociated with <strong>S</strong>treptococcal infections.</p>\n<p>The symptoms occur usually <strong>abruptly</strong> and can include the following:</p>\n<ul>\n<li>Obsessive-compulsive disorder (OCD)</li>\n<li>Tic disorder</li>\n<li>Gilles de la Tourette syndrome (coprolalia and tics)</li>\n</ul>\n<p>In addition to these symptoms, children may become moody or irritable, experience anxiety attacks, or show concerns about separating from parents or loved ones. It has been hypothesized that&nbsp;in response to group A &beta;-hemolytic streptococcal infection,&nbsp;<strong>autoimmune antibodies</strong>&nbsp;are produced, which&nbsp;cross-react with <strong>brain tissue&nbsp;(molecular mimicry)</strong>, leading to neuropsychiatric manifestations.</p>\n<p>Note:&nbsp;Non-infectious manifestations of streptococcal infection include:</p>\n<ul>\n<li>Rheumatic Heart Disease</li>\n<li>Glomerulonephritis</li>\n<li>PANDAS</li>\n<li>Guttate Psoriasis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient was brought to the emergency room. He appears psychotic and is extremely agitated, screaming and thrashing things around. He is crying and has a running nose. He complains of severe unbearable pain around his right eye and temple for the last two hours, which is not responsive to NSAIDs. The last time he had such a headache was a year back. Which of the following conditions could he be suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Somatic delusion"
      },
      {
        "id": 2,
        "text": "Cluster headache"
      },
      {
        "id": 3,
        "text": "Migraine"
      },
      {
        "id": 4,
        "text": "Paroxysmal hemicrania"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above clinical scenario of severe unilateral headache associated with autonomic changes (rhinorrhea, lacrimation) is suggestive of <strong>cluster headache</strong>, which is a type of <strong>trigeminal autonomic cephalalgias</strong> (a group of primary headache disorders). The pain can be so intense that the <strong>patient may appear to be psychotic</strong> because of the screaming and thrashing associated with the pain.</p>\n<p>Characteristic features of cluster headache:</p>\n<ul>\n<li>Unilateral, deep&nbsp;retro-orbital excruciating pain.</li>\n<li><strong>Frequent intense attacks</strong> (often several per day) over a 1 to 2 month period, separated by headache-free intervals for as long as 1 or 2 years.</li>\n<li>Associated <strong>ipsilateral</strong>&nbsp;<strong>cranial autonomic symptoms</strong> (conjunctival injection, aural fullness, rhinorrhea, or nasal congestion) or cranial sympathetic activation(ptosis).</li>\n<li><strong>Patients</strong> tend to <strong>move about</strong> during attacks, rocking, or rubbing their heads for relief; some may even become aggressive during attacks. This is in sharp contrast to patients with <strong>migraines,</strong> who prefer to <strong>remain motionless</strong> during attacks.</li>\n</ul>\n<p>Note:<strong>&nbsp;</strong>Trigeminal autonomic cephalalgias (TAC) are a group of primary headache disorders that are characterized by strictly unilateral trigeminal distribution pain associated with ipsilateral cranial autonomic symptoms, and include:</p>\n<ul>\n<li>Cluster headache</li>\n<li><strong>SUNCT</strong> (<strong>s</strong>hort-lasting <strong>u</strong>nilateral <strong>n</strong>euralgiform headache attacks with <strong>c</strong>onjunctival injection and<strong> t</strong>earing) / <strong>SUNA</strong> (<strong>s</strong>hort-lasting <strong>u</strong>nilateral <strong>n</strong>euralgiform headache attacks with cranial <strong>a</strong>utonomic symptoms)</li>\n<li>Paroxysmal hemicrania (PH)</li>\n<li>Hemicrania continua</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 34-year-old woman with a suspected psychiatric disorder was started on medication, but there was no improvement. She was eventually referred to a higher center, where a detailed workup revealed Addison\u2019s disease. Treatment with glucocorticoids resulted in rapid resolution of both her psychiatric and physical symptoms. What must have been that initial condition suspected in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Depression"
      },
      {
        "id": 2,
        "text": "Generalised Anxiety disorder"
      },
      {
        "id": 3,
        "text": "Bipolar disorder"
      },
      {
        "id": 4,
        "text": "Panic disorder"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Addison's disease&nbsp;</strong>presents most similarly to <strong>depression.&nbsp;</strong>Apathy, social withdrawal, impaired sleep, decreased concentration, and prominent fatigue is frequently seen which is usually mistaken for depression.</p>\n<p>Following infection, trauma or surgery, a patient with previously unrecognized Addison's disease may suffer from an Addisonian crisis with a presentation of either shock or hypoglycemia. This is a medical emergency requiring urgent medical referral.</p>\n<table style=\"height: 94px; width: 740.399px;\">\n<tbody>\n<tr>\n<td style=\"width: 324px;\"><strong>Endocrinopathy</strong></td>\n<td style=\"width: 511.399px;\"><strong>Differential psychiatric diagnosis</strong></td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Addison's disease</td>\n<td style=\"width: 511.399px;\">Depression</td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Hyperthyroidism</td>\n<td style=\"width: 511.399px;\">Mood disorder, panic disorder, generalized anxiety disorder</td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Hypothyroidism</td>\n<td style=\"width: 511.399px;\"><strong>Depression</strong>, hypomania, delusions, schizophrenia (myxedema madness).</td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Hypoparathyroidism</td>\n<td style=\"width: 511.399px;\"><strong>Delirium</strong> is the most common.</td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Hyperparathyroidism</td>\n<td style=\"width: 511.399px;\">Depression, anxiety, <strong>paranoid delusions</strong>. Tetrad of \"bones, stones, moans and psychic groans\".</td>\n</tr>\n<tr>\n<td style=\"width: 324px;\">Hypoglycemia</td>\n<td style=\"width: 511.399px;\">Anxiety, depersonalization, derealisation, aggressive behavior, amnesia.</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old woman, brought in by her husband, presented with complaints of short-term memory loss and weight gain for the last 4 months, despite a loss of appetite. She thought that her husband wished to harm her and also felt agitated by all the small animals she kept seeing in her room. You order tests related to thyroid disorders. Which of the following findings would you expect to see in the report?",
    "choices": [
      {
        "id": 1,
        "text": "Increased tri-iodothyronine (T3) levels"
      },
      {
        "id": 2,
        "text": "Increased titre of antibodies to thyroid stimulating hormone receptors"
      },
      {
        "id": 3,
        "text": "Increased anti-thyroid peroxidase titre"
      },
      {
        "id": 4,
        "text": "Decreased thyroid stimulating hormone levels"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The patient complains of neuropsychiatric symptoms, memory disturbances, along with weight gain despite a loss of appetite. Thus, she has symptoms of <strong>hypothyroidism</strong>. <strong>Increased anti-thyroid peroxidase</strong> titer is found in <strong>Hashimoto encephalopathy</strong>, which is consistent with her symptoms.</p>\n<p>On the other hand, antibodies to TSH receptors (Grave's disease), decreased TSH, and elevated T3 levels are found in hyperthyroid conditions.</p>\n<p><strong>Hashimoto encephalopathy (HE)</strong>, also described as steroid-responsive encephalopathy associated with autoimmune thyroiditis (SREAT), is an uncommon autoimmune encephalopathy of unknown etiology. It is associated with high titers of serum antithyroid (usually anti-thyroid peroxidase &plusmn; anti-thyroglobulin) antibodies.</p>\n<p>HE is <strong>more common</strong> in<strong> women,</strong> with a mean age of onset between 45 and 50 years.</p>\n<p>The clinical picture is one of <strong>encephalopathy with progressive cognitive decline</strong>&nbsp;which may be relapsing and remitting. Neuropsychiatric features include agitation and restlessness, apathy, social isolation. <strong>Visual hallucinations</strong>&nbsp;and <strong>delusions </strong>are commonly seen.&nbsp;</p>\n<p><strong>Anti-thyroid peroxidase </strong>levels are very high<strong> (&gt;1,000 IU/L)</strong> when associated with neuropsychiatric symptoms of Hashimoto's thyroiditis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman complains that her 5-year old child has become very indifferent towards her. He attempts to squeeze his genitals and is always stuffing his mouth with food and objects like knives and toys.  Which of these syndromes could her child be suffering from?",
    "choices": [
      {
        "id": 1,
        "text": "Medial hypothalamic disease"
      },
      {
        "id": 2,
        "text": "Kleine Levin syndrome"
      },
      {
        "id": 3,
        "text": "Kluver Bucy syndrome"
      },
      {
        "id": 4,
        "text": "Charcot Willbrand disease"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario of a 5-year boy who mouths non-food items (<strong>hyperorality</strong>/hyperphagia), constantly squeezes genitals (<strong>hypersexuality</strong>), indifferent to parents is suggestive of <strong>Kluver-Bucy syndrome.</strong></p>\n<p style=\"text-align: left;\">Kluver Bucy syndrome&nbsp;is characterized by&nbsp;hyperorality,&nbsp;hyperphagia,&nbsp;hypersexuality,&nbsp;hypermetamorphosis&nbsp;(constantly shifting attention). It is due to <strong>damage</strong> to the <strong>temporal lobe and amygdala</strong>, which leads to an inability to access memory and emotional connections.</p>\n<p>Option A: In <strong>medial hypothalamic disease</strong>, there is an increase in eating behavior, marked by a <strong>lack of satiety</strong> and resultant obesity.</p>\n<p>Option B: <strong>Kleine&ndash;Levin&nbsp;syndrome, </strong>also known as sleeping beauty syndrome, is a rare sleep disorder characterized by persistent episodic <strong>hypersomnia</strong>, hyperphagia, and hypersexuality with cognitive or mood changes.</p>\n<p>Option D:<strong> Charcot Willbrand disease</strong> leads to loss of visual imagery with <strong>occipitotemporal damage</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old woman has a history of urinating in public without having any remorse for it. She also has difficulty in getting motivated and has mild memory deficits. Which of the following lobes may be affected?",
    "choices": [
      {
        "id": 1,
        "text": "Parietal"
      },
      {
        "id": 2,
        "text": "Occipital"
      },
      {
        "id": 3,
        "text": "Frontal"
      },
      {
        "id": 4,
        "text": "Temporal"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>frontal lobe</strong> is affected in this patient. The woman has difficulty in getting motivated, memory deficits, and urinary incontinence.</p>\n<p>Frontal lobe injury is commonly due to trauma, infarcts, tumors, lobotomy, multiple sclerosis, or Pick's disease. The following features may be seen in a patient with frontal lobe injury:&nbsp;</p>\n<ul>\n<li>Impaired executive functions such as motivation, attention, and sequencing of actions</li>\n<li>Aphasia, apraxia, constructional apraxia, neglect, and memory deficits</li>\n<li>Urinary incontinence and fecal incontinence is commonly seen</li>\n<li>Changes in personality</li>\n<li>Apathetic indifference and impulsive behavior.</li>\n</ul>\n<p>&nbsp;Note:&nbsp;Frontal lobe pathology may become apparent only under unstructured, stressful, real-life situations and are difficult to detect using Intelligence scales, as IQ mostly requires parietal lobe activation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 48-year-old male presents to the ER with confusion and shaking of the entire body. He has a history of excessive alcohol consumption. What is the cause of delirium tremens in an alcoholic?",
    "choices": [
      {
        "id": 1,
        "text": "Acute infection"
      },
      {
        "id": 2,
        "text": "Fatty liver"
      },
      {
        "id": 3,
        "text": "Gradual withdrawal of alcohol"
      },
      {
        "id": 4,
        "text": "Small doses of regular consumption of alcohol"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Among the given options, <strong>acute infection</strong>&nbsp;can be a cause of <strong>delirium tremens</strong> in an alcoholic patient.</p>\n<div class=\"page\" title=\"Page 649\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Physical illness e.g., <strong>hepatitis</strong> or <strong>pancreatitis</strong> predisposes to the syndrome; a person in good physical health rarely has delirium tremens during alcohol withdrawal.</p>\n<div class=\"page\" title=\"Page 649\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The syndrome usually develops on the third day of admission. A patient admitted for an unrelated condition may unexpectedly have an episode of delirium, which is the first sign of a previously undiagnosed alcohol-related disorder.</p>\n<div class=\"page\" title=\"Page 649\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Episodes of delirium tremens usually begin at the age of&nbsp;30-40 years, after&nbsp;5 to 15 years of heavy drinking, and are typical&nbsp;after a <strong>binge.</strong>&nbsp;Gradual withdrawal of alcohol does not cause delirium tremens. However, <strong>sudden withdrawal</strong> can cause it.</p>\n<p>Treatment of alcohol withdrawal:&nbsp;</p>\n<ul>\n<li style=\"font-weight: 400;\">For patients showing <strong>withdrawal</strong> symptoms,<strong> chlordiazepoxide</strong> 25-50 mg every 2-4 hours can be administered orally.&nbsp;</li>\n<li style=\"font-weight: 400;\">For patients with <strong>delirium tremens</strong>, <strong>50-100 mg of chlordiazepoxide</strong> should be administered every 4 hours.&nbsp;</li>\n<li style=\"font-weight: 400;\">If oral administration of drugs is not possible, <strong>intravenous lorazepam</strong> can be tried.</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '05 Neuropsychiatric Aspects Of Systemic Disorders';
        const quizFilename = '05-neuropsychiatric-aspects-of-systemic-disorders-ebc24148.html';
        let hierarchy = ["Marrow", "qBank", "Psychiatry"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>