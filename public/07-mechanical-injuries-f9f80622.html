<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07 Mechanical Injuries - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Forensic Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Identify the injury in the image below.",
    "choices": [
      {
        "id": 1,
        "text": "Abrasion"
      },
      {
        "id": 2,
        "text": "Laceration"
      },
      {
        "id": 3,
        "text": "Bruise"
      },
      {
        "id": 4,
        "text": "Imprint"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows an&nbsp;<strong>abrasion.</strong></p>\n<p>An abrasion is the <strong>most superficial</strong> of injuries. It&nbsp;does not penetrate the full thickness of the epidermis.</p>\n<p>A&nbsp;<strong>pure abrasion </strong>does<strong> not bleed</strong>, as blood vessels are confined to the dermis. However, the <strong>dermal papillae</strong> are <strong>corrugated</strong> in nature. Thus, many <strong>abrasions</strong> enter the <strong>dermis</strong> and <strong>bleeding</strong> commonly occurs.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/02d3cfb85cef4f7ba977aec11597ff99.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "An abrasion involves which of the following layers of the skin?",
    "choices": [
      {
        "id": 1,
        "text": "Partial thickness of epidermis"
      },
      {
        "id": 2,
        "text": "Full thickness of epidermis"
      },
      {
        "id": 3,
        "text": "Epidermis + superficial dermis"
      },
      {
        "id": 4,
        "text": "Epidermis + dermis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>An <strong>abrasion</strong> is the most superficial of injuries and is one that <strong>does not penetrate </strong>the <strong>full thickness</strong> of the<strong> epidermis</strong>.</p>\n<p>Thus the <strong>pure abrasion does not bleed</strong>, as blood vessels are confined to the dermis. The dermal papillae are corrugated in nature. Therefore, many abrasions enter the dermis, and bleeding commonly occurs.</p>\n<p>Abrasions are commonly known as\u00a0grazes or scratches.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In an abrasion caused by tangential force, which of the following indicates the direction of said force?",
    "choices": [
      {
        "id": 1,
        "text": "Fishtailing of the wound"
      },
      {
        "id": 2,
        "text": "Epidermal tags"
      },
      {
        "id": 3,
        "text": "Tailing of the wound"
      },
      {
        "id": 4,
        "text": "Crushed hair follicles"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\">Option A:<strong>&nbsp;Fishtailing</strong> is the <strong>shape</strong> of the stab wound caused by a <strong>single-edged</strong> weapon.</p>\n<p class=\"p1\">Option C:<strong>&nbsp;Tailing</strong> of the wound indicates the direction of injury in <strong>incised</strong> wounds.&nbsp;</p>\n<p class=\"p1\">Option D:<strong>&nbsp;Crushed</strong> hair <strong>follicles</strong> are seen at the edge of the wound in a<strong> laceration</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/989402d538d14bf5b77d1d0465300199x1280x610.PNG"
    ]
  },
  {
    "text": "Abrasions are noted on the body of a person who was found dead at his home. Which of the following indicates that these might be produced after death?",
    "choices": [
      {
        "id": 1,
        "text": "Vital reaction positive"
      },
      {
        "id": 2,
        "text": "Congestion seen"
      },
      {
        "id": 3,
        "text": "Present over bony prominences"
      },
      {
        "id": 4,
        "text": "Bright reddish brown in color"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Abrasions</strong>&nbsp;present over<strong> bony prominences</strong> indicate that they might be produced<strong> after death</strong>. Antemortem abrasions may be located anywhere.&nbsp;</p>\n<p>Difference between antemortem and postmortem wounds:</p>\n<table style=\"width: 375px;\">\n<tbody>\n<tr style=\"height: 45px;\">\n<td style=\"width: 72px; height: 45px;\">Trait</td>\n<td style=\"width: 131.25px; height: 45px;\"><strong>Antemortem wounds &nbsp;</strong></td>\n<td style=\"width: 158.75px; height: 45px;\"><strong>Postmortem wounds</strong></td>\n</tr>\n<tr style=\"height: 45px;\">\n<td style=\"width: 72px; height: 45px;\">Site</td>\n<td style=\"width: 131.25px; height: 45px;\">Anywhere on the body</td>\n<td style=\"width: 158.75px; height: 45px;\">Usually over bony prominences &nbsp;</td>\n</tr>\n<tr style=\"height: 59px;\">\n<td style=\"width: 72px; height: 59px;\">Colour</td>\n<td style=\"width: 131.25px; height: 59px;\">Bright reddish brown</td>\n<td style=\"width: 158.75px; height: 59px;\">Yellowish, translucent, Parchment like&nbsp;</td>\n</tr>\n<tr style=\"height: 41px;\">\n<td style=\"width: 72px; height: 41px;\">Exudation</td>\n<td style=\"width: 131.25px; height: 41px;\">More</td>\n<td style=\"width: 158.75px; height: 41px;\">Less&nbsp;</td>\n</tr>\n<tr style=\"height: 78px;\">\n<td style=\"width: 72px; height: 78px;\">Microscopic</td>\n<td style=\"width: 131.25px; height: 78px;\">Intravital reaction and congestion seen</td>\n<td style=\"width: 158.75px; height: 78px;\">\n<p>No intravital reaction and congestion&nbsp;</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is falsely matched?",
    "choices": [
      {
        "id": 1,
        "text": "Antemortem wound - positive vital reaction"
      },
      {
        "id": 2,
        "text": "Antemortem wound - negative vital reaction"
      },
      {
        "id": 3,
        "text": "Postmortem wound - negative vital reaction"
      },
      {
        "id": 4,
        "text": "Postmortem wound - no vital reaction"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Postmortem wounds</strong> show <strong>no/absent vital reaction</strong> because no enzyme activity will be found in a wound sustained after death. This is <strong>not</strong> the same as a negative vital reaction as it is indicative of decreased enzymatic activity and is seen in antemortem wounds.</p>\n<p>Vital reactions are local tissue reactions at the site of tissue damage<strong>.</strong>\u00a0Only <strong>antemortem wounds</strong> show <strong>vital reactions</strong> as cells are active at the time of wound infliction. The vital reactions of an antemortem wound are of two zones:\u00a0</p>\n<ul>\n<li><strong>Negative</strong> vital reaction (<strong>decrease</strong> in <strong>enzymatic activity</strong> of wound): It occurs in the <strong>central necrotic area,</strong> close to the edge of the wound\u00a0where there is irreversible damage to tissues.\u00a0</li>\n<li><strong>Positive</strong> vital reaction (<strong>increase</strong> in <strong>enzymatic activity</strong> of wound): It occurs just outside the necrotic area of the wound in order to salvage damaged (but not irreversibly damaged) tissues.</li>\n</ul>\n<p>Difference between antemortem and postmortem wounds:</p>\n<table style=\"height: 269px;\" width=\"377\">\n<tbody>\n<tr>\n<td style=\"width: 80.3594px;\">Trait</td>\n<td style=\"width: 138.516px;\"><strong>Antemortem wounds \u00a0</strong></td>\n<td style=\"width: 136.125px;\"><strong>Postmortem wounds</strong></td>\n</tr>\n<tr>\n<td style=\"width: 80.3594px;\">Site</td>\n<td style=\"width: 138.516px;\">Anywhere on the body</td>\n<td style=\"width: 136.125px;\">Usually over bony prominences \u00a0</td>\n</tr>\n<tr>\n<td style=\"width: 80.3594px;\">Colour</td>\n<td style=\"width: 138.516px;\">Bright reddish brown</td>\n<td style=\"width: 136.125px;\">Yellowish, translucent, Parchment like\u00a0</td>\n</tr>\n<tr>\n<td style=\"width: 80.3594px;\">Exudation</td>\n<td style=\"width: 138.516px;\">More</td>\n<td style=\"width: 136.125px;\">Less\u00a0</td>\n</tr>\n<tr>\n<td style=\"width: 80.3594px;\">Microscopic</td>\n<td style=\"width: 138.516px;\">Intravital reaction and congestion seen</td>\n<td style=\"width: 136.125px;\">\n<p>No intravital reaction and congestion\u00a0</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8606920587c1439d90b3f3e6972483a1x1280x1177.JPEG"
    ]
  },
  {
    "text": "Which of the following statements regarding a bruise is false?",
    "choices": [
      {
        "id": 1,
        "text": "They lie underneath an intact epidermis"
      },
      {
        "id": 2,
        "text": "They are caused due to capillary bleeding"
      },
      {
        "id": 3,
        "text": "Blood commonly collects in the subcutaneous layer"
      },
      {
        "id": 4,
        "text": "It may become visible 1-2 days after the traumatic incident"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Contusions/bruises</strong> are caused by <strong>damage</strong> to <strong>veins, venules</strong> and <strong>small arteries</strong>. Capillary bleeding would not be visible to the naked eye.</p>\n<p>A pure bruise lies beneath an <strong>intact epidermis.</strong>\u00a0There is an extravascular collection of blood that has leaked from blood vessels damaged by mechanical impact.</p>\n<p>The usual <strong>bruise</strong> from a blunt impact is <strong>situated</strong> in the <strong>subcutaneous tissues</strong>, often in the fat layer. <strong>Obese</strong> people tend to<strong> bruise</strong> more <strong>easily</strong> due to the<strong> greater</strong> volume of <strong>subcutaneous</strong> tissue.</p>\n<p><strong>Delayed bruising</strong> refers to bruises that become more prominent with the passage of <strong>hours or days</strong>. This is caused by the percolation of blood from deeper tissues upwards towards the epidermis. It is also partly due to continued bleeding from the ruptured vessels.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following sites is more prone to bruising with blunt trauma?",
    "choices": [
      {
        "id": 1,
        "text": "Shins"
      },
      {
        "id": 2,
        "text": "Abdomen"
      },
      {
        "id": 3,
        "text": "Buttocks"
      },
      {
        "id": 4,
        "text": "Arms"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The <strong>shins</strong> are particularly prone to <strong>bruising</strong> with <strong>blunt trauma.</strong></p>\n<p><strong>Resilient areas</strong>, such as the <strong>abdominal wall</strong> and <strong>buttocks</strong>, bruise less with a given impact.&nbsp;The head, chest, and shins are more prone to bruising. This is because these regions have underlying bone and less subcutaneous tissue.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The police brought a victim of alleged domestic violence with a big bruise for evaluation. She claimed that it was inflicted by her husband three days ago after which he had gone out of town. Which of the following is correct while determining the age of this injury?",
    "choices": [
      {
        "id": 1,
        "text": "Histological examination is the most reliable method"
      },
      {
        "id": 2,
        "text": "The appearance of green colour is the most significant change"
      },
      {
        "id": 3,
        "text": "Perl's reaction is the most useful criterion"
      },
      {
        "id": 4,
        "text": "Bright yellow colour indicates that it is less than 18 hours old"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>most useful</strong> criterion for <strong>dating</strong> a <strong>bruise</strong> is <strong>Perl's reaction </strong>for detecting&nbsp;<strong>haemosiderin.&nbsp;</strong>It becomes <strong>positive</strong> about <strong>24&ndash;90 hours</strong> after infliction. Sometimes, there can be an earlier appearance, even down to 12 hours.</p>\n<p>Color changes in a bruise cannot be reliably used to estimate the age of a bruise. The <strong>most significant</strong> change is the appearance of a <strong>yellow color.</strong>&nbsp;This <strong>indicates</strong> that the bruise is <strong>more than 18 hours</strong> old.</p>\n<p>Histological examination is unreliable in the accurate dating of bruises.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A bruise on the upper arm of an alleged victim of the assault has the following appearance. What is the age of the injury based on colour of this bruise?",
    "choices": [
      {
        "id": 1,
        "text": "2 weeks old"
      },
      {
        "id": 2,
        "text": "1-3 days old"
      },
      {
        "id": 3,
        "text": "7-12 days old"
      },
      {
        "id": 4,
        "text": "4-5 days old"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The <strong>bruise</strong> in the given image has a <strong>yellow appearance</strong> which is attributed to the presence of <strong>bilirubin</strong>. This finding makes the bruise about\u00a0<strong>7-12\u00a0</strong><strong>days old.</strong></p>\n<p>Bruises are mechanical injuries that are characterized by the extravasation of blood into subcutaneous or subepithelial tissue spaces. The continuity of the overlying skin is preserved. These injuries are typical consequences of <strong>blunt force trauma.</strong>\u00a0</p>\n<p>The extravasated blood serves as a sign of inflammation to attract macrophages, which degrade the hemoglobin into various compounds (hemosiderin, haematoidin, and bilirubin). This gives rise to shifting color changes that begin at the wound's periphery and migrate towards the center as time goes on.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/99a3d78688e247549538f1d3b9e1effb.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not true about ectopic contusions?",
    "choices": [
      {
        "id": 1,
        "text": "Bruising on the neck may indicate a jaw fracture"
      },
      {
        "id": 2,
        "text": "Bruising at the nape of the neck indicates fracture of the posterior cranial fossa"
      },
      {
        "id": 3,
        "text": "A black eye may be from fracture of the anterior cranial fossa"
      },
      {
        "id": 4,
        "text": "Bruising behind the ear indicates fracture of the middle cranial fossa"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<ul>\n<li>Bruising on the neck may indicate a jaw fracture.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8babad4ef7b74db698c947c02efef0abx1280x960.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/aa6dd8ed3b92443ab9a115b8a513003dx720x743.JPEG"
    ]
  },
  {
    "text": "You are asked to conduct an autopsy of a person who was found dead at his home. You notice the given findings on the body. Which test can be used to differentiate this from antemortem bruising?",
    "choices": [
      {
        "id": 1,
        "text": "Gettler's test"
      },
      {
        "id": 2,
        "text": "Incision test"
      },
      {
        "id": 3,
        "text": "Precipitin test"
      },
      {
        "id": 4,
        "text": "Breslau's test"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows <strong>postmortem hypostasis</strong>. The classic test used to differentiate a bruise from hypostasis is the<strong> incision test.&nbsp;</strong></p>\n<p>The suspected area is incised to see if the underlying blood is <strong>intravascular (hypostasis)</strong> or infiltrating the tissues <strong>outside</strong> the <strong>vessels (contusion)</strong>.</p>\n<p>Option A:<strong>&nbsp;Gettler's chloride test</strong>&nbsp;is used to<strong> differentiate </strong>between<strong> freshwater </strong>and<strong> saltwater drowning. </strong>It is not widely used now.&nbsp;</p>\n<p>Option C:<strong>&nbsp;</strong>In<strong>&nbsp;</strong>the<strong> precipitin test, </strong>a&nbsp;specific antiserum is made to react with the seminal fluid, blood, or saliva. A positive test will confirm human origin.</p>\n<p>Option D:&nbsp;<strong>Breslau's second life test</strong>&nbsp;is done to determine whether a child was born alive or not.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e2796dd52a7f42e5b5a5ca3b05f5b333.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "The autopsy of a victim reveals similar findings seen in the given image. Which of the following would have caused this injury?",
    "choices": [
      {
        "id": 1,
        "text": "Road traffic accident"
      },
      {
        "id": 2,
        "text": "Iron rod"
      },
      {
        "id": 3,
        "text": "Serrated knife"
      },
      {
        "id": 4,
        "text": "Double edged knife"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows <strong>'tram-line' bruising. </strong>It&nbsp;would have most likely been produced by a <strong>stick</strong> or an<strong>&nbsp;iron rod</strong>.&nbsp;</p>\n<p>It occurs when the skin surface is struck by a rod or rectangular sectioned object. The weapon sinks into the skin on impact. This causes the <strong>edges</strong> to drag the skin downwards and the<strong> traction, tears</strong> the <strong>marginal blood vessels</strong>. The <strong>centre compresses</strong> the skin. This causes little or no damage to the vessels in the absence of underlying bone.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ed9262f23dca4d01a668dd2d9d669232.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0994e7aaec1444cdb7f8125ec8427bdex600x439.JPEG"
    ]
  },
  {
    "text": "Which of the following tissues is most resistant to knife penetration?",
    "choices": [
      {
        "id": 1,
        "text": "Muscle"
      },
      {
        "id": 2,
        "text": "Subcutaneous tissue"
      },
      {
        "id": 3,
        "text": "Uncalcified cartilage"
      },
      {
        "id": 4,
        "text": "Skin"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The tissue <strong>most resistant</strong> to knife penetration is the <strong>skin</strong>, apart from <strong>bone</strong> or <strong>calcified cartilage</strong>.</p>\n<p>When a knife-point impacts against the skin, the latter dimples, and resists. The tension developed in the stretched skin appears to act as an elastic reservoir and when the threshold of resistance is exceeded, penetration suddenly occurs.&nbsp;</p>\n<p>Muscle offers little resistance to penetration.<strong> Uncalcified cartilage </strong>and<strong> subcutaneous tissue</strong>&nbsp;are <strong>easily penetrated</strong> by a sharp knife.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An assault victim is rushed to the emergency department with a stab wound. You observe that the wound is wedge-shaped. Which weapon would have most likely produced this wound?",
    "choices": [
      {
        "id": 1,
        "text": "Single-edged knife"
      },
      {
        "id": 2,
        "text": "Serrated knife"
      },
      {
        "id": 3,
        "text": "Double-edged knife"
      },
      {
        "id": 4,
        "text": "Screwdriver"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A <strong>wedge-shaped</strong> wound is produced by a <strong>single-edged knife</strong>. A <strong>double-edged</strong> knife produces an <strong>elliptical wound</strong>.</p>\n<p>The image given below shows the types of wounds produced by different weapons:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e08de029bdc843b3bdfc9a806892f2dcx1280x3765.JPEG"
    ]
  },
  {
    "text": "In a case of suspected stabbing, you are trying to identify the murder weapon using the wound characteristics. All of the following factors might lead to a false interpretation except:",
    "choices": [
      {
        "id": 1,
        "text": "If the knife tapers beyond the point to which it was driven into the wound"
      },
      {
        "id": 2,
        "text": "If the knife was driven up to the hilt into the wound"
      },
      {
        "id": 3,
        "text": "If the weapon was moved after insertion"
      },
      {
        "id": 4,
        "text": "If the wound is parallel to the Langer lines"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Option C: If the <strong>weapon</strong> is <strong>moved</strong> after insertion, it distorts wound characteristics.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f238318dc8d444d1935191779aa3fd53x1280x1182.JPEG"
    ]
  },
  {
    "text": "What type of injury is scalping?",
    "choices": [
      {
        "id": 1,
        "text": "Contusion"
      },
      {
        "id": 2,
        "text": "Abrasion"
      },
      {
        "id": 3,
        "text": "Incised wound"
      },
      {
        "id": 4,
        "text": "Laceration"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Scalping</strong> is a type of <strong>laceration</strong>. Here, a large area of skin and subcutaneous tissue is rolled off the scalp.&nbsp;</p>\n<p>These lesions could be caused by the traction of hair being trapped in machinery. This was formerly a common industrial accident. 'Hairnets' were worn by women factory workers to prevent this.</p>\n<p><strong>Flaying&nbsp;</strong>is also a type of laceration, caused by shearing force. This is where a large area of skin and subcutaneous tissue is rolled off a limb.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following findings in a patient suggests an incised wound, rather than a split laceration?",
    "choices": [
      {
        "id": 1,
        "text": "Sharp linear injury in underlying bone"
      },
      {
        "id": 2,
        "text": "Hairs crossing the wound"
      },
      {
        "id": 3,
        "text": "Tissue strands across the interior of the wound"
      },
      {
        "id": 4,
        "text": "Bruising around margin of the wound."
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Note:\u00a0Lacerations are also commonly known as cuts or tears.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/03b732b327144025b7ca49c278280593x1280x1280.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/93e1af89549f493db0d50410c49f69a4x800x600.JPEG"
    ]
  },
  {
    "text": "You notice tearing of the skin at the ends of a laceration on a victim. What is this finding known as?",
    "choices": [
      {
        "id": 1,
        "text": "Sparrow's foot"
      },
      {
        "id": 2,
        "text": "Wedging"
      },
      {
        "id": 3,
        "text": "Fish tails"
      },
      {
        "id": 4,
        "text": "Swallow tails"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Option A:&nbsp;<strong>Sparrow's foot</strong> marks are seen in <strong>windshield injuries</strong> in car accidents.</p>\n<p>Option B: Wedge-shaped injuries are seen in stabbing with a single-edged weapon.</p>\n<p>Option C:&nbsp;<strong>Fish-tails:&nbsp;</strong>These may be seen in stab wounds where the skin splits at the corner.&nbsp;</p>\n<p>The image below shows fish-tail in a stab wound.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/74d573cdd7b54d749042fd2e83dff549x600x782.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bd214cbaeac34488925354fc1a25541ex549x397.PNG"
    ]
  },
  {
    "text": "You are examining the body of a patient who was found dead at his house. Multiple linear incised wounds are noted on the ulnar border of the forearm. What are these suggestive of?",
    "choices": [
      {
        "id": 1,
        "text": "Defence wounds"
      },
      {
        "id": 2,
        "text": "Self-mutilation"
      },
      {
        "id": 3,
        "text": "Tentative cuts"
      },
      {
        "id": 4,
        "text": "Hesitation wounds"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In the given scenario, multiple linear incised <strong>wounds</strong> on the inner side (<strong>ulnar</strong> border) of the forearm are most likely to be&nbsp;<strong>defence wounds.</strong>&nbsp;</p>\n<p>They are sustained when a victim is trying to protect himself from attacks (homicide). The attack may be by fists, feet, and blunt or sharp instruments.&nbsp;</p>\n<p>In case of a <strong>blunt instrument</strong>, fist or feet:</p>\n<ul>\n<li><strong>Bruises</strong> are most common along with abrasions</li>\n<li>Commonly on the <strong>extensor </strong>and<strong> ulnar aspect </strong>of the <strong>forearms</strong>, wrists, back of the hand, and knuckles</li>\n<li>May be seen on <strong>thighs&nbsp;</strong>due to&nbsp;an attempt to protect genitals</li>\n</ul>\n<p>In the case of a <strong>sharp instrument</strong>:</p>\n<ul>\n<li>Seen on the <strong>ulnar</strong> side of the <strong>forearm</strong>, wrist, hand, and fingers</li>\n<li>Cuts on the <strong>flexures</strong> of <strong>phalanges</strong>&nbsp;occur if the <strong>victim</strong> tries to <strong>seize</strong> the <strong>weapon</strong></li>\n</ul>\n<p><strong>Firearm injury:</strong></p>\n<ul>\n<li>Arms may be used to shield the trunk or head from the blast</li>\n<li>An entrance and an exit wound in the upper arm may be seen</li>\n<li>The missile may then re-penetrate the trunk</li>\n</ul>\n<p>Options C and D: <strong>Tentative</strong> cuts or <strong>hesitation</strong> wounds are self-inflicted wounds made while <strong>attempting</strong> to commit <strong>suicide</strong>.They are usually on the radial side of the forearm.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "When is leucocyte infiltration into wounds seen?",
    "choices": [
      {
        "id": 1,
        "text": "0-4 hours"
      },
      {
        "id": 2,
        "text": "4-12 hours"
      },
      {
        "id": 3,
        "text": "12-24 hours"
      },
      {
        "id": 4,
        "text": "1-3 days"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Leucocyte infiltration</strong> in wounds is seen at<strong> 4-12 hours.&nbsp;</strong></p>\n<p>Histological changes in wounds</p>\n<table style=\"height: 402px; width: 621px;\">\n<tbody>\n<tr style=\"height: 35.5625px;\">\n<td style=\"width: 173px; height: 35.5625px;\"><strong>Time after injury</strong></td>\n<td style=\"width: 434px; height: 35.5625px;\"><strong>Histological changes</strong></td>\n</tr>\n<tr style=\"height: 110px;\">\n<td style=\"width: 173px; height: 110px;\">30 minutes-4 hours</td>\n<td style=\"width: 434px; height: 110px;\">\n<p>Margination of leucocytes in blood vessels</p>\n<p>Mast cells lose their granules</p>\n<p>Fibrin appears in the wound</p>\n</td>\n</tr>\n<tr style=\"height: 110px;\">\n<td style=\"width: 173px; height: 110px;\">4-12 hours</td>\n<td style=\"width: 434px; height: 110px;\">\n<p>Leucocyte infilitration (mostly polymorphs)</p>\n<p>Tissue edema</p>\n<p>Start of epithelial regeneration</p>\n</td>\n</tr>\n<tr style=\"height: 78px;\">\n<td style=\"width: 173px; height: 78px;\">12-24 hours</td>\n<td style=\"width: 434px; height: 78px;\">\n<p>Mononuclear leukocytes increase</p>\n<p>Epidermis begins to spread across the wound</p>\n</td>\n</tr>\n<tr style=\"height: 78px;\">\n<td style=\"width: 173px; height: 78px;\">24-72 hours</td>\n<td style=\"width: 434px; height: 78px;\">\n<p>Leukocyte infiltration reaches a peak at 48 hours</p>\n<p>Granulation tissue appears</p>\n</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 173px; height: 18px;\">3-6 days</td>\n<td style=\"width: 434px; height: 18px;\">Collagen formation</td>\n</tr>\n<tr style=\"height: 110px;\">\n<td style=\"width: 173px; height: 110px;\">10-15 days</td>\n<td style=\"width: 434px; height: 110px;\">\n<p>Collagen reaction subsides</p>\n<p>Vascularity decrease</p>\n<p>Cell population drops</p>\n</td>\n</tr>\n<tr style=\"height: 46px;\">\n<td style=\"width: 173px; height: 46px;\">2 weeks - several months</td>\n<td style=\"width: 434px; height: 46px;\">\n<p>Consolidation of healing tissue</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '07 Mechanical Injuries';
        const quizFilename = '07-mechanical-injuries-f9f80622.html';
        let hierarchy = ["Marrow", "qBank", "Forensic Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>