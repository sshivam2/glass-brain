<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>07  Blood Supply Lower Limb - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        DAMS / DQB / Anatomy
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">17</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "id": 50000,
    "choices": [
      {
        "id": 200000,
        "text": "IVC"
      },
      {
        "id": 200001,
        "text": "Cephalic"
      },
      {
        "id": 200002,
        "text": "Basilic"
      },
      {
        "id": 200003,
        "text": "Great saphenous"
      }
    ],
    "text": "The longest vein in the human body is-",
    "unique_key": "Q3258412",
    "question_audio": null,
    "question_video": null,
    "map_id": 34347011,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Great saphenous. Explanation for Correct Answer: The great saphenous vein is the longest vein in the human body. It runs along the length of the lower limb, from the medial side of the foot, up the leg, and into the thigh, eventually draining into the femoral vein. Its length, which spans from the foot to the groin, makes it the longest vein in the human body. Explanation for Incorrect Answers: (A) IVC (Inferior Vena Cava): While the IVC is a large vein, it is not the longest vein. The IVC is responsible for returning deoxygenated blood from the lower half of the body to the heart, but its length is significantly shorter compared to the great saphenous vein. (B) Cephalic vein: The cephalic vein is a prominent vein in the upper limb, typically found along the lateral aspect of the forearm and arm. While it is a well-known vein in venous access procedures, it is much shorter than the great saphenous vein. (C) Basilic vein: The basilic vein is another large vein in the upper limb, located on the medial side of the arm. Like the cephalic vein, it is shorter than the great saphenous vein and does not span the length of the lower limb.",
    "correct_choice_id": 200003,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/31197881697987860/31197881697987860.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/31197881697987860/31197881697987860.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50001,
    "choices": [
      {
        "id": 200004,
        "text": "At apex of femoral triangle"
      },
      {
        "id": 200005,
        "text": "At the hiatus in adductor magnus"
      },
      {
        "id": 200006,
        "text": "Within the adductor canal"
      },
      {
        "id": 200007,
        "text": "None of the above"
      }
    ],
    "text": "Where does superficial femoral artery becomes the popliteal artery:",
    "unique_key": "Q2440017",
    "question_audio": null,
    "question_video": null,
    "map_id": 34367970,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) At the hiatus in adductor magnus. Explanation for Correct Answer: The superficial femoral artery becomes the popliteal artery at the hiatus in adductor magnus, which is an opening in the adductor magnus muscle. This hiatus allows the artery to pass from the anterior thigh into the posterior compartment of the leg, where it is then referred to as the popliteal artery. This transition occurs just above the knee joint, making option (B) the correct answer. Explanation for Incorrect Answers: (A) At apex of femoral triangle: The apex of the femoral triangle is where the femoral artery begins, but it does not mark the transition into the popliteal artery. The femoral artery continues down the thigh before it passes through the hiatus in adductor magnus to become the popliteal artery, making this option incorrect. (C) Within the adductor canal: The adductor canal (also known as Hunter's canal) is a passage in the middle third of the thigh through which the femoral artery and other structures pass. However, the femoral artery does not change to the popliteal artery within the adductor canal. It is only at the hiatus in adductor magnus that this transition happens, so this option is incorrect. (D) None of the above:",
    "correct_choice_id": 200005,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/39207381697984173/39207381697984173.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/39207381697984173/39207381697984173.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50002,
    "choices": [
      {
        "id": 200008,
        "text": "Internal urethral sphincter"
      },
      {
        "id": 200009,
        "text": "External urethral sphincter"
      },
      {
        "id": 200010,
        "text": "Pubovaginalis"
      },
      {
        "id": 200011,
        "text": "Bulbospongiosus"
      }
    ],
    "text": "Vaginal sphincter is formed by all except -",
    "unique_key": "Q3043346",
    "question_audio": null,
    "question_video": null,
    "map_id": 34303827,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Internal urethral sphincter The vaginal sphincter refers to a group of muscles that help control the opening and closing of the vaginal canal. The internal urethral sphincter is located around the internal urethral orifice, and it primarily functions to control the passage of urine from the bladder. It is not directly involved in the formation of the vaginal sphincter. Therefore, it does not contribute to the sphincter mechanism around the vagina, making it the correct answer in this context. Incorrect Responses: (B) External urethral sphincter The external urethral sphincter is part of the pelvic floor muscles and encircles the urethra. Although its primary role is to control urinary flow, it also plays a role in the vaginal sphincter mechanism, especially in maintaining continence and assisting with pelvic floor support. It is a significant muscle that contributes to the control around the vaginal opening. Hence, this is incorrect as it is part of the vaginal sphincter. (C) Pubovaginalis The pubovaginalis is a part of the pelvic floor muscles that forms a supportive sling around the vagina. It is a component of the levator ani muscle group and plays a crucial role in supporting the vagina and assisting in the vaginal sphincter mechanism. This muscle is directly involved in controlling the opening and closing of the vaginal canal. Therefore, this option is incorrect. (D) Bulbospongiosus The bulbospongiosus muscle is another important component of the pelvic floor that contributes to the vaginal sphincter. It surrounds the vaginal orifice and plays a role in closing the vagina, particularly during activities like sexual intercourse and childbirth. It is also involved in the contraction of the perineal muscles that support the vagina.",
    "correct_choice_id": 200008,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/72726961697975537/72726961697975537.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/72726961697975537/72726961697975537.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50003,
    "choices": [
      {
        "id": 200012,
        "text": "Starts as a continuation of lateral marginal vein"
      },
      {
        "id": 200013,
        "text": "Ends in femoral vein"
      },
      {
        "id": 200014,
        "text": "Accompanied by sural nerve"
      },
      {
        "id": 200015,
        "text": "Ascends 2.5-3cm behind tibial malleolus"
      }
    ],
    "text": "True about the anatomy of great saphenous vein",
    "unique_key": "Q8473287",
    "question_audio": null,
    "question_video": null,
    "map_id": 34738268,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Ends in femoral vein. Explanation for the Correct Answer: The great saphenous vein is the longest vein in the body and it ends in the femoral vein at the saphenous hiatus, located in the upper thigh near the groin. It drains the blood from the medial side of the lower limb and ascends along the medial aspect of the leg and thigh. The vein is an important superficial vein of the lower limb that helps to return blood to the heart from the lower extremities. Explanation for Incorrect Answers: A. Starts as a continuation of lateral marginal vein: This statement is incorrect. The great saphenous vein does not start as a continuation of the lateral marginal vein. Instead, it begins at the dorsal venous arch of the foot, on the medial side, and ascends along the medial aspect of the leg. C. Accompanied by sural nerve: This statement is incorrect. The great saphenous vein is not accompanied by the sural nerve. The sural nerve runs alongside the small saphenous vein, which is a separate vein from the great saphenous vein. The great saphenous vein is accompanied by the saphenous nerve. D. Ascends 2.5-3cm behind tibial malleolus: This statement is incorrect. The great saphenous vein ascends in front of the medial malleolus, not behind it. It passes superficially along the medial side of the lower leg, just anterior to the medial malleolus, and does not pass behind it.",
    "correct_choice_id": 200013,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/49174601697988287/49174601697988287.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/49174601697988287/49174601697988287.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50004,
    "choices": [
      {
        "id": 200016,
        "text": "Axillary space"
      },
      {
        "id": 200017,
        "text": "Triangular space"
      },
      {
        "id": 200018,
        "text": "Quadrangular space"
      },
      {
        "id": 200019,
        "text": "Subdeltoid bursa"
      },
      {
        "id": 200020,
        "text": "Infraspinatous fossa"
      }
    ],
    "text": "A patient is brought in the emergency room who has received a stab wound in the right side of the chest below and medial to the coracoid process of the scapula. A severed artery was found deep at this location. After initial stabilization, you start repairing with one of senior surgeon. You make an incision through the skin and subcutaneous tissue just below the clavicle, then cut the clavicular head of the pectoralis major muscle and retract it downward. Next you get a partially severed muscle running downward and medially from the coracoid process. You divide the remaining fibers of the muscle and retracts it downward. This exposes a bloody fat-filled space full of vessels and nerves. Which space or cavity was opened when the muscles were reflected?",
    "unique_key": "Q3326463",
    "question_audio": null,
    "question_video": null,
    "map_id": 34687537,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Deep to Pectoralis minor lies Axillary artery. Space described here is axillary space.",
    "correct_choice_id": 200016,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/19138351698325480/19138351698325480.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/19138351698325480/19138351698325480.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50005,
    "choices": [
      {
        "id": 200021,
        "text": "Common fibular n."
      },
      {
        "id": 200022,
        "text": "Lesser saphenous v."
      },
      {
        "id": 200023,
        "text": "Popliteal a."
      },
      {
        "id": 200024,
        "text": "Popliteal v."
      },
      {
        "id": 200025,
        "text": "Tibial n."
      }
    ],
    "text": "When the femur is fractured, the broken distal end often turns posteriorly to enter the popliteal fossa due to muscle traction. Because of its position deepest in the fossa, which structure is most vulnerable to laceration?",
    "unique_key": "Q8274460",
    "question_audio": null,
    "question_video": null,
    "map_id": 34287226,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Popliteal artery lies deepest in the fossa.<p><img src=\"https://d2enu63wt1sf3u.cloudfront.net/ckfinder/files/QID%205529(1).jpg\" alt=\"Solution Image\"></p>",
    "correct_choice_id": 200023,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/48172631698326133/48172631698326133.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/48172631698326133/48172631698326133.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50006,
    "choices": [
      {
        "id": 200026,
        "text": "Fibular artery"
      },
      {
        "id": 200027,
        "text": "Anterior tibial artery"
      },
      {
        "id": 200028,
        "text": "Posterior tibial artery"
      },
      {
        "id": 200029,
        "text": "Popliteal artery"
      },
      {
        "id": 200030,
        "text": "Medial plantar artery"
      }
    ],
    "text": "In an accident, an instrument pierces the mid-calf of a person. A major artery is lacerated in the posterior leg, and you notice that the sole of his foot is cold and pale. The dorsum of the foot is warm and normally colored. The artery that seems to be injured is the:",
    "unique_key": "Q9957828",
    "question_audio": null,
    "question_video": null,
    "map_id": 34243620,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Sole is supplied by plantar arteries which are branches of post. Tibial artery.",
    "correct_choice_id": 200028,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/57315331698326297/57315331698326297.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/57315331698326297/57315331698326297.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50007,
    "choices": [
      {
        "id": 200031,
        "text": "Posterior tibial artery"
      },
      {
        "id": 200032,
        "text": "Peroneal artery"
      },
      {
        "id": 200033,
        "text": "Anterior tibial artery"
      },
      {
        "id": 200034,
        "text": "Dorsalis pedis artery"
      }
    ],
    "text": "Behind medial malleolus and in front of Achilles tendon, which artery is palpated",
    "unique_key": "Q2229733",
    "question_audio": null,
    "question_video": null,
    "map_id": 34421022,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Option A-Posterior tibial artery is palpated behind medial malleolus and in front of Achilles tendon. Option B-Peroneal artery is difficult to palpate. Option C-Anterior tibial artery is palpated anteriorly between two malleoli. Option D-Dorsalis pedis artery is palpated just lateral to extensor hallucis longus tendon.",
    "correct_choice_id": 200031,
    "solution_audio": null,
    "solution_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/43764191725256664/43764191725256664.m3u8",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "https://d2enu63wt1sf3u.cloudfront.net/dqb_vod/43764191725256664/43764191725256664.m3u8",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50008,
    "choices": [
      {
        "id": 200035,
        "text": "Anterior tibial artery"
      },
      {
        "id": 200036,
        "text": "Popliteal artery"
      },
      {
        "id": 200037,
        "text": "Posterior tibial artery"
      },
      {
        "id": 200038,
        "text": "Arcuate artery"
      }
    ],
    "text": "The peroneal artery is a branch of which artery -",
    "unique_key": "Q6667214",
    "question_audio": null,
    "question_video": null,
    "map_id": 34910055,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Posterior tibial artery. The peroneal artery (also called the fibular artery) is a significant branch of the posterior tibial artery. It arises in the posterior compartment of the leg, near the upper part of the tibia and fibula. The peroneal artery runs parallel to the fibula, supplying blood to the lateral and posterior compartments of the leg, as well as the fibula itself. It terminates by forming branches that contribute to the vascular network around the ankle and foot. Its origin and function are critical in ensuring proper perfusion of the lower leg. Incorrect Options: (A) Anterior tibial artery This is incorrect because the anterior tibial artery is a separate branch of the popliteal artery and supplies the anterior compartment of the leg. While it is also important for leg perfusion, it does not give rise to the peroneal artery. (B) Popliteal artery This is incorrect because the popliteal artery is the main artery behind the knee and is the direct continuation of the femoral artery. It divides into two branches: the anterior tibial artery and the posterior tibial artery. The peroneal artery is not a direct branch of the popliteal artery but arises from the posterior tibial artery. (D) Arcuate artery This is incorrect because the arcuate artery is found in the dorsum of the foot. It is a branch of the dorsalis pedis artery and has no connection with the origin of the peroneal artery.",
    "correct_choice_id": 200037,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50009,
    "choices": [
      {
        "id": 200039,
        "text": "Medial marginal vein"
      },
      {
        "id": 200040,
        "text": "Lateral marginal vein"
      },
      {
        "id": 200041,
        "text": "Dorsal venous arch"
      },
      {
        "id": 200042,
        "text": "Tibial vein"
      }
    ],
    "text": "Short saphenous vein is the continuation of-",
    "unique_key": "Q9704341",
    "question_audio": null,
    "question_video": null,
    "map_id": 34987883,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Lateral marginal vein. The short saphenous vein is a superficial vein of the lower limb. It originates as the continuation of the lateral marginal vein of the foot, which itself arises from the dorsal venous arch. The short saphenous vein courses upward behind the lateral malleolus, ascends along the posterior aspect of the calf, and drains into the popliteal vein in the popliteal fossa. Its anatomical origin from the lateral marginal vein is significant as it defines the vein\u2019s course and drainage pattern. Reasons for Incorrect Options: A. Medial marginal vein: The medial marginal vein is on the medial side of the foot and is the origin of the great saphenous vein, not the short saphenous vein. The great saphenous vein ascends along the medial aspect of the leg and thigh to drain into the femoral vein. C. Dorsal venous arch: While the dorsal venous arch contributes to the formation of both the lateral and medial marginal veins, it does not directly continue as the short saphenous vein. Instead, the lateral marginal vein, which originates from the dorsal venous arch, serves as the direct precursor to the short saphenous vein. D. Tibial vein: The tibial veins are deep veins of the leg and are unrelated to the origin of the short saphenous vein, which is a superficial vein. The tibial veins primarily accompany the anterior and posterior tibial arteries.",
    "correct_choice_id": 200040,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50010,
    "choices": [
      {
        "id": 200043,
        "text": "Superficial circumflex iliac artery"
      },
      {
        "id": 200044,
        "text": "Obturator artery"
      },
      {
        "id": 200045,
        "text": "Branches from the medial and lateral circumflex femoral arteries"
      },
      {
        "id": 200046,
        "text": "Deep external pudendal artery and Inferior gluteal artery"
      }
    ],
    "text": "In the adult, the chief arterial supply to the head of the femur is from the-",
    "unique_key": "Q2580481",
    "question_audio": null,
    "question_video": null,
    "map_id": 34182034,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (C) Branches from the medial and lateral circumflex femoral arteries. The primary arterial supply to the head of the femur in adults comes from the retinacular branches of the medial and lateral circumflex femoral arteries, which are branches of the deep femoral artery (profunda femoris). Of these, the medial circumflex femoral artery is the most significant, as it gives rise to branches that enter the femoral head through the neck and supply the majority of its vascularization. The lateral circumflex femoral artery contributes to the vascular supply but plays a lesser role compared to the medial circumflex femoral artery. This blood supply is crucial for maintaining the health of the femoral head and preventing avascular necrosis, particularly in cases of femoral neck fractures. Reasons for Incorrect Options: A. Superficial circumflex iliac artery: This artery supplies the superficial structures of the lower abdominal wall and the inguinal region. It does not contribute to the vascularization of the femoral head, as its distribution is too superficial and peripheral. B. Obturator artery: The obturator artery does contribute to the blood supply of the femoral head through its acetabular branch (artery of the ligamentum teres), but its role is minor in adults. In children, this artery plays a more significant role in femoral head vascularization due to the underdeveloped contribution from the circumflex femoral arteries. However, in adults, it is insufficient to sustain the femoral head on its own. D. Deep external pudendal artery: This artery supplies the external genitalia and perineum. It does not have any anatomical or functional connection to the femoral head and its vascularization.",
    "correct_choice_id": 200045,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50011,
    "choices": [
      {
        "id": 200047,
        "text": "Nutrient artery"
      },
      {
        "id": 200048,
        "text": "Medial circumflex artery"
      },
      {
        "id": 200049,
        "text": "Artery of the ligamentum teres"
      },
      {
        "id": 200050,
        "text": "Obturator artery"
      }
    ],
    "text": "In children, the head of femur is supplied by all of the following arteries except -",
    "unique_key": "Q9547198",
    "question_audio": null,
    "question_video": null,
    "map_id": 34972531,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Nutrient artery. In children, the head of the femur receives its blood supply from several sources, but the nutrient artery does not contribute to the femoral head's vascularization. The nutrient artery primarily supplies the diaphysis (shaft) of long bones, not the epiphysis (the head of the femur). In children, the femoral head has a rich blood supply through the medial circumflex artery, the artery of the ligamentum teres, and in some cases, the obturator artery, but the nutrient artery does not play a significant role in this vascular network. Reasons for Incorrect Options: B. Medial circumflex artery: The medial circumflex artery is one of the main blood supplies to the femoral head in children. It gives off branches that enter the neck of the femur and provide crucial blood flow to the epiphysis of the femoral head. This artery plays a critical role in maintaining the health of the femoral head, particularly during childhood. C. Artery of the ligamentum teres: The artery of the ligamentum teres (also known as the femoral branch of the obturator artery) is an important vascular supply in children. It travels through the ligamentum teres and provides blood to the femoral head, although its contribution decreases with age. This artery is crucial for the early development of the femoral head's blood supply. D. Obturator artery: The obturator artery can contribute to the blood supply of the femoral head, particularly through its branch, the artery of the ligamentum teres. In some cases, the obturator artery may play a more prominent role in femoral head vascularization, especially during childhood.",
    "correct_choice_id": 200047,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50012,
    "choices": [
      {
        "id": 200051,
        "text": "Internal iliac artery"
      },
      {
        "id": 200052,
        "text": "External iliac artery"
      },
      {
        "id": 200053,
        "text": "Obturator artery"
      },
      {
        "id": 200054,
        "text": "Inferior epigastric artery"
      }
    ],
    "text": "Abnormal obturator artery is a branch of-",
    "unique_key": "Q4323031",
    "question_audio": null,
    "question_video": null,
    "map_id": 34941004,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (D) Inferior epigastric artery. An abnormal obturator artery can sometimes arise from the inferior epigastric artery, which is a branch of the external iliac artery. This variation occurs in a small percentage of individuals and is known as an \"aberrant\" or \"abnormal\" obturator artery. In this case, the obturator artery arises from the inferior epigastric artery instead of its usual origin from the internal iliac artery. This anatomical variation is important to recognize during pelvic surgeries, as it can affect the vascularization of the pelvis and potentially complicate procedures in the region. Reasons for Incorrect Options: A. Internal iliac artery: The internal iliac artery is the usual origin of the obturator artery in most individuals. It gives rise to the obturator artery, which supplies the pelvis, medial thigh, and hip joint. This is the typical and most common anatomical pathway, so this option is incorrect in the context of an abnormal obturator artery. B. External iliac artery: The external iliac artery gives rise to branches such as the femoral artery, but it does not typically give rise to the obturator artery. The obturator artery, in its normal anatomical course, originates from the internal iliac artery, not the external iliac artery. C. Obturator artery: The obturator artery is the vessel itself, not the origin. This option is incorrect because the obturator artery is the structure being described and not the vessel from which it arises. The abnormal obturator artery is still the same artery but has an unusual origin.",
    "correct_choice_id": 200054,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50013,
    "choices": [
      {
        "id": 200055,
        "text": "Lateral circumflex femoral artery"
      },
      {
        "id": 200056,
        "text": "Medial circumflex femoral artery"
      },
      {
        "id": 200057,
        "text": "Profunda femoris artery"
      },
      {
        "id": 200058,
        "text": "External femoral artery"
      }
    ],
    "text": "Arterial supply to the head and neck of femur is -",
    "unique_key": "Q9407033",
    "question_audio": null,
    "question_video": null,
    "map_id": 34239252,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (B) Medial circumflex femoral artery. Explanation for the Correct Answer: The medial circumflex femoral artery plays the primary role in supplying blood to the head and neck of the femur. It is a branch of the deep femoral artery (profunda femoris) and provides the main blood supply to the femoral head, particularly through its ascending and transverse branches. This blood supply is crucial for maintaining the viability of the femoral head, especially in the context of hip fractures or conditions that may affect circulation. Explanation for Incorrect Answers: A. Lateral circumflex femoral artery: The lateral circumflex femoral artery primarily supplies the anterior and lateral muscles of the thigh and does not play a major role in supplying the femoral head and neck. It has some contributions to the hip joint but is not the primary artery for this region. C. Profunda femoris artery: The profunda femoris artery (or deep femoral artery) is the main source of blood to the thigh muscles and branches into the medial and lateral circumflex femoral arteries. While the profunda femoris artery contributes to the vascularization of the femoral head via its branches, it is the medial circumflex femoral artery that is directly responsible for the blood supply to the femoral head and neck. D. External femoral artery: The external femoral artery is not a standard term. You may be referring to the femoral artery, which is the main artery supplying blood to the lower limb. However, it does not directly supply the femoral head and neck. Its branches, such as the profunda femoris, provide the necessary blood supply to this region.",
    "correct_choice_id": 200056,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50014,
    "choices": [
      {
        "id": 200059,
        "text": "Profunda femoris artery"
      },
      {
        "id": 200060,
        "text": "Femoral artery"
      },
      {
        "id": 200061,
        "text": "Popliteal artery"
      },
      {
        "id": 200062,
        "text": "Middle circumflex femoral artery"
      }
    ],
    "text": "The nutrient artery to the femur is",
    "unique_key": "Q3530619",
    "question_audio": null,
    "question_video": null,
    "map_id": 34280980,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Profunda femoris artery. Explanation for the Correct Answer: The nutrient artery to the femur is primarily supplied by the profunda femoris artery (also known as the deep femoral artery). The profunda femoris is a major branch of the femoral artery and gives off branches that supply the femur, including the nutrient artery, which penetrates the bone and provides essential blood supply for the bone\u2019s health and growth. This nutrient artery is especially crucial for the femoral shaft and is considered the main source of its blood supply. Explanation for Incorrect Answers: B. Femoral artery: While the femoral artery is the main artery supplying the lower limb, it does not directly provide the nutrient artery to the femur. The profunda femoris artery, a branch of the femoral artery, is responsible for that. C. Popliteal artery: The popliteal artery supplies blood to the knee joint and posterior compartment of the leg, but it does not provide the nutrient artery to the femur. D. Middle circumflex femoral artery: The middle circumflex femoral artery supplies blood to the hip joint and surrounding structures, but it does not provide the nutrient artery to the femur. The nutrient artery to the femur comes from the profunda femoris artery.",
    "correct_choice_id": 200059,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50015,
    "choices": [
      {
        "id": 200063,
        "text": "Peroneal artery"
      },
      {
        "id": 200064,
        "text": "Anterior tibial artery"
      },
      {
        "id": 200065,
        "text": "Posterior tibial artery"
      },
      {
        "id": 200066,
        "text": "Popliteal artery"
      }
    ],
    "text": "Nutrient artery arises to fibula from-",
    "unique_key": "Q1783379",
    "question_audio": null,
    "question_video": null,
    "map_id": 34269524,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Peroneal artery. Explanation for the Correct Answer: The nutrient artery to the fibula arises from the peroneal artery (also known as the fibular artery). The peroneal artery is a branch of the posterior tibial artery and runs along the lateral side of the leg, supplying blood to the fibula and surrounding structures. The nutrient artery from the peroneal artery penetrates the fibula, providing it with essential blood supply for bone health and growth. Explanation for Incorrect Answers: B. Anterior tibial artery: The anterior tibial artery supplies the anterior compartment of the leg, including the muscles and tissues in the front of the leg. It does not provide the nutrient artery to the fibula. C. Posterior tibial artery: The posterior tibial artery supplies the posterior compartment of the leg, but it is the peroneal artery (a branch of the posterior tibial artery) that provides the nutrient artery to the fibula, not the posterior tibial artery directly. D. Popliteal artery: The popliteal artery is the continuation of the femoral artery in the popliteal fossa and supplies the knee joint and surrounding muscles. It does not give off the nutrient artery to the fibula.",
    "correct_choice_id": 200063,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "id": 50016,
    "choices": [
      {
        "id": 200067,
        "text": "Anterior to the medial malleolus"
      },
      {
        "id": 200068,
        "text": "Posterior to the medial malleolus"
      },
      {
        "id": 200069,
        "text": "Anterior to the lateral malleolus"
      },
      {
        "id": 200070,
        "text": "Posterior to the lateral malleolus"
      }
    ],
    "text": "Course of the great saphenous vein lies in what relation to the malleoli?",
    "unique_key": "Q9359502",
    "question_audio": null,
    "question_video": null,
    "map_id": 34087644,
    "difficulty_level": "intermediate",
    "subjects_id": [],
    "solution": "Correct Answer (A) Anterior to the medial malleolus. Explanation for the Correct Answer: The great saphenous vein is the longest vein in the body and runs along the medial side of the lower limb. Its course is typically anterior to the medial malleolus (the bony prominence on the inner side of the ankle). The vein begins in the foot, ascends along the medial side of the leg, and eventually drains into the femoral vein at the groin. As it passes the ankle, it crosses in front of the medial malleolus before continuing up the leg. Explanation for Incorrect Answers: B. Posterior to the medial malleolus: The great saphenous vein does not pass behind the medial malleolus. It is anterior to it, as described above. C. Anterior to the lateral malleolus: The great saphenous vein is located medially along the leg, so it does not pass near the lateral malleolus, which is located on the outer side of the ankle. D. Posterior to the lateral malleolus: As with option C, the great saphenous vein does not pass near the lateral malleolus and is not located behind it.",
    "correct_choice_id": 200067,
    "solution_audio": null,
    "solution_video": "",
    "audio_explanation_heading": null,
    "video_explanation_heading": null,
    "solution_media_position": "bottom",
    "tags": [],
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '07  Blood Supply Lower Limb';
        const quizFilename = '07-blood-supply-lower-limb-f466b3de.html';
        let hierarchy = ["DAMS", "DQB", "Anatomy"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on navigation
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>