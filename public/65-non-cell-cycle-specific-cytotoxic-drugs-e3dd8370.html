<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>65 Non Cell Cycle Specific Cytotoxic Drugs - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Pharmacology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">29</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is more likely to be susceptible to alkylation with a bifunctional alkylating agent?",
    "choices": [
      {
        "id": 1,
        "text": "N3 of guanine"
      },
      {
        "id": 2,
        "text": "N1 of adenosine"
      },
      {
        "id": 3,
        "text": "N3 of adenosine"
      },
      {
        "id": 4,
        "text": "N7 of guanine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The <strong>N7 atom</strong> of <strong>guanine</strong> is particularly susceptible to&nbsp;alkylation with bifunctional alkylating agents. It leads to the formation of a <strong>covalent bond</strong> with bifunctional alkylating agents and represents the key target in nucleic acids for alkylating agents. Alkylation results in<strong> cross-linking/abnormal base pairing of DNA</strong> which inhibits DNA replication.</p>\n<p>Other sites that can be involved are:</p>\n<ul>\n<li>N1 and N3 of adenosine&nbsp;</li>\n<li>N3 of cytosine&nbsp;</li>\n<li>O6 of guanine&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a study on the cytotoxic effects of alkylating agents, you observe that cyclophosphamide has a higher cytotoxic effect compared to procarbazine. Which property of cyclophosphamide is the reason for this?",
    "choices": [
      {
        "id": 1,
        "text": "Cross-linking of DNA"
      },
      {
        "id": 2,
        "text": "Methylation of DNA"
      },
      {
        "id": 3,
        "text": "Additional inhibition of topoisomerase I"
      },
      {
        "id": 4,
        "text": "Additional inhibition of topoisomerase II"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Cyclophosphamide (nitrogen mustard) is a<strong> bifunctional alkylating agent</strong> and it results in <strong>cross-linking of DNA</strong> that causes a major disruption in nucleic acid function and increased <strong>cytotoxicity.</strong>&nbsp;</p>\n<p>Procarbazine is a monofunctional alkylating agent.</p>\n<p>Differences between bifunctional and monofunctional alkylating agents are:</p>\n<table style=\"width: 389px; height: 387px;\">\n<tbody>\n<tr style=\"height: 0.53125px;\">\n<td style=\"width: 172.21875px; height: 0.53125px;\">\n<p style=\"text-align: center;\"><strong>Bifunctional alkylating agents</strong></p>\n</td>\n<td style=\"width: 200.796875px; height: 0.53125px; text-align: center;\"><strong>Monofunctional alkylating &nbsp;agents</strong></td>\n</tr>\n<tr style=\"height: 81px;\">\n<td style=\"width: 172.21875px; height: 81px;\">Usually transfers ethyl group to DNA resulting in cross-linking</td>\n<td style=\"width: 200.796875px; height: 81px;\">Usually transfers a methyl group resulting in simple methylation. No cross-linking of DNA</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 172.21875px; height: 17px;\">\n<p>Higher cytotoxicity because of cross-linking results in a greater threat to cellular survival</p>\n</td>\n<td style=\"width: 200.796875px; height: 17px;\">\n<p>Higher carcinogenesis risk as simple methylation can be bypassed by DNA polymerases resulting in permanent modification of DNA sequence</p>\n</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is not an alkylating agent?",
    "choices": [
      {
        "id": 1,
        "text": "Carmustine"
      },
      {
        "id": 2,
        "text": "Melphalan"
      },
      {
        "id": 3,
        "text": "Chlorambucil"
      },
      {
        "id": 4,
        "text": "5-Flourouracil"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>5-Flourouracil</strong> is a pyrimidine analogue and is an <strong>antimetabolite</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a nitrogen mustard?",
    "choices": [
      {
        "id": 1,
        "text": "Mechlorethamine"
      },
      {
        "id": 2,
        "text": "Melphalan"
      },
      {
        "id": 3,
        "text": "Cyclophosphamide"
      },
      {
        "id": 4,
        "text": "Carmustine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Carmustine</strong> belongs to the <strong>nitrosourea</strong> class of alkylating agents.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Temozolomide is used as a first-line agent for the management of which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Anaplastic astrocytoma"
      },
      {
        "id": 2,
        "text": "Glioblastoma multiforme"
      },
      {
        "id": 3,
        "text": "Acoustic neuroma"
      },
      {
        "id": 4,
        "text": "Craniopharyngioma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: left;\"><strong>Temozolomide</strong> is used as a first-line agent for the management of <strong>glioblastoma multiforme</strong>. It is used for&nbsp;newly diagnosed cases along with radiotherapy and also used for maintenance therapy.</p>\n<p style=\"text-align: left;\">Temozolomide belongs to the triazene group of alkylating agents and is administered orally. The oral bioavailability of temozolomide is nearly 100%.</p>\n<p style=\"text-align: left;\">In anaplastic astrocytoma, refractory cases with disease progression are treated with a regimen containing nitrosourea and procarbazine.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient is diagnosed with astrocytoma. Which of the following drugs crosses the blood brain barrier and hence can be used for the treatment of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Cisplatin"
      },
      {
        "id": 2,
        "text": "Lomustine"
      },
      {
        "id": 3,
        "text": "Vincristine"
      },
      {
        "id": 4,
        "text": "Vinblastine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Lomustine</strong> can cross the blood-brain barrier and is used in the management of brain tumours like astrocytoma.</p>\n<p><strong>Nitrosoureas</strong> like lomustine and carmustine are&nbsp;<strong>highly lipophilic</strong>&nbsp;drugs and can easily<strong> cross the blood-brain barrier.</strong>&nbsp;Hence, they are indicated in the management of brain tumors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs is not an anthracycline antibiotic?",
    "choices": [
      {
        "id": 1,
        "text": "Doxorubicin"
      },
      {
        "id": 2,
        "text": "Dactinomycin"
      },
      {
        "id": 3,
        "text": "Mitoxantrone"
      },
      {
        "id": 4,
        "text": "Epirubicin"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Dactinomycin or actinomycin D is an <strong>actinomycin</strong> and not an anthracycline antibiotic.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Topical mitomycin C is used in which of the following patients?",
    "choices": [
      {
        "id": 1,
        "text": "A patient with Sturge-Weber syndrome"
      },
      {
        "id": 2,
        "text": "A patient with laryngotracheal stenosis"
      },
      {
        "id": 3,
        "text": "A patient undergoing endoscopic treatment of angiofibroma"
      },
      {
        "id": 4,
        "text": "A patient with hand-foot syndrome"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Topical mitomycin C is used in <strong>laryngotracheal stenosis</strong>.</p>\n<p>Mitomycin C is an antitumor antibiotic that inhibits cell division, protein synthesis and fibroblast proliferation. Topical mitomycin C has been shown to cause symptomatic improvement when applied to patients with laryngotracheal stenosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with superficial bladder carcinoma is being treated with a drug by intravesical therapy. Identify this drug.",
    "choices": [
      {
        "id": 1,
        "text": "Actinomycin"
      },
      {
        "id": 2,
        "text": "Mitomycin"
      },
      {
        "id": 3,
        "text": "Cisplatin"
      },
      {
        "id": 4,
        "text": "Vincristine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Mitomycin C</strong> is used in the treatment of superficial transitional cell carcinoma by intravesical instillation. It is also used in upper gastrointestinal cancers (e.g. esophageal carcinoma), anal cancers, and breast cancers.</p>\n<p>Topical mitomycin C is used in:</p>\n<ul>\n<li>Superficial bladder cancer</li>\n<li>Intraperitoneal tumors</li>\n<li>Strabismus surgery to reduce scarring</li>\n<li>To prevent tracheal and esophageal stenosis</li>\n<li>Post nasal surgery synechae formation</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient was diagnosed with acute promyelocytic leukemia and chemotherapy was initiated. The patient achieved complete remission. However, after a few months molecular relapse was detected. Which of the following drugs would be highly effective in this case?",
    "choices": [
      {
        "id": 1,
        "text": "Tretinoin"
      },
      {
        "id": 2,
        "text": "Arsenic trioxide"
      },
      {
        "id": 3,
        "text": "Idarubicin"
      },
      {
        "id": 4,
        "text": "Cytarabine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Arsenic trioxide</strong> (ATO) is highly effective in <strong>relapsed or refractory</strong> acute promyelocytic leukemia (APL). It acts by enhancing reactive oxygen free radical generation in APL cells.</p>\n<p>Tretinoin and idarubicin (anthracycline) are usually first-line agents for acute promyelocytic leukemia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with osteosarcoma was initiated on chemotherapy. After a few days, he developed dysuria and hematuria. Which group of drugs among the following is most likely to have caused this complication?",
    "choices": [
      {
        "id": 1,
        "text": "Alkylating agents"
      },
      {
        "id": 2,
        "text": "Antimetabolites"
      },
      {
        "id": 3,
        "text": "Mitotic inhibitors"
      },
      {
        "id": 4,
        "text": "Topoisomerase inhibitors"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This scenario depicts haemorrhagic cystitis and the possible cause could be <strong>alkylating agents</strong> like <strong>ifosfamide</strong>.&nbsp;</p>\n<p>Chemotherapeutic agents used for the treatment of osteosarcoma include ifosfamide, which is one of the commonest drugs causing haemorrhagic cystitis.</p>\n<p>Ifosfamide is a nitrogen mustard and belongs to the alkylating agents.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Hemorrhagic cystitis is a characteristic side effect of which of the following drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Melphalan"
      },
      {
        "id": 2,
        "text": "Busalfan"
      },
      {
        "id": 3,
        "text": "Cyclophosphamide"
      },
      {
        "id": 4,
        "text": "Procarbazine"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Hemorrhagic cystitis is a characteristic side effect of <strong>cyclophosphamide</strong>.&nbsp;The metabolite responsible for hemorrhagic cystitis is <strong>acrolein</strong>. This can be decreased by vigorous hydration and by the use of <strong>mercapto ethane sulfonic acid (mesna).</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 62-year-old woman with breast carcinoma is started on cyclophosphamide. What is the rationale behind using sodium 2-mercaptoethanesulfonate along with this drug?",
    "choices": [
      {
        "id": 1,
        "text": "Increase absorption"
      },
      {
        "id": 2,
        "text": "Decrease excretion"
      },
      {
        "id": 3,
        "text": "Ameliorate hemorrhagic cystitis"
      },
      {
        "id": 4,
        "text": "Decrease metabolism"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Sodium 2-mercaptoethanesulfonate (MESNA) is given along with cyclophosphamide to <strong>reduce</strong> the incidence of <strong>hemorrhagic cystitis</strong>. &nbsp; &nbsp;</p>\n<p>MESNA concentrates in the bladder where acrolein accumulates after administration of cyclophosphamide and ifosfamide. It&nbsp;forms a conjugate with acrolein and other urotoxic metabolites.&nbsp;<sup id=\"cite_ref-Thurston_2007_7-1\" class=\"reference\"></sup>This conjugation reaction inactivates the urotoxic compounds to harmless metabolites which are excreted in the urine.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements about ifosfamide is false?",
    "choices": [
      {
        "id": 1,
        "text": "Metabolised by cytochrome P450 enzymes"
      },
      {
        "id": 2,
        "text": "Less neurotoxic than cyclophosphamide"
      },
      {
        "id": 3,
        "text": "Chloroacetaldehyde is the metabolite of ifosfamide"
      },
      {
        "id": 4,
        "text": "It is a nitrogen mustard"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Ifosfamide</strong> is <strong>more\u00a0neurotoxic</strong> than cyclophosphamide. It causes greater platelet suppression, nephrotoxicity, and urothelial damage when compared to cyclophosphamide.</p>\n<p>Ifosfamide is a nitrogen mustard (alkylating agent). It is metabolized by hydroxylation by cytochrome P450 enzymes.\u00a0Chloroacetaldehyde is a metabolite of ifosfamide that is responsible for severe neurological adverse effects.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 67 year old woman with a malignant lump in the breast who is undergoing chemotherapy, presents with shortness of breath, tachycardia and hypertension. ECG shows ST and T wave changes. Which among the following drugs could have led to this?",
    "choices": [
      {
        "id": 1,
        "text": "Doxorubicin"
      },
      {
        "id": 2,
        "text": "Mitomycin-C"
      },
      {
        "id": 3,
        "text": "Bleomycin"
      },
      {
        "id": 4,
        "text": "Actinomycin-D"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This scenario depicts Doxorubicin induced <strong>cardiotoxicity</strong>. It is a unique adverse effect of <strong>doxorubicin</strong>. It is an anthracycline group of anticancer antibiotics.</p>\n<p>Doxorubicin-induced cardiomyopathy takes two forms:</p>\n<ul>\n<li><strong>Acute:</strong>&nbsp;pericarditis-myocarditis syndrome,&nbsp;arrhythmias, ST and T wave changes in ECG.</li>\n<li><strong>Chronic:</strong> dilated cardiomyopathy.</li>\n</ul>\n<p>Note:<strong>&nbsp;Dexrazoxane</strong> is a cardioprotective iron-chelating agent that is indicated for use along with high dose doxorubicin to avoid cardiotoxicity.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 54-year-old man is diagnosed with Kaposi sarcoma. You are planning to start chemotherapy with doxorubicin, which can cause cardiotoxicity. Which of the following drugs would you prescribe to prevent this?",
    "choices": [
      {
        "id": 1,
        "text": "Leucovorin"
      },
      {
        "id": 2,
        "text": "Mesna"
      },
      {
        "id": 3,
        "text": "Dexrazoxane"
      },
      {
        "id": 4,
        "text": "Dexamethasone"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Dexrazoxane</strong> is a <strong>cardioprotective</strong> iron-chelating agent that is indicated for use along with high dose doxorubicin to avoid cardiotoxicity. The exact cardioprotective mechanism of dexrazoxane is unknown and it appears not to compromise with anticancer activity of doxorubicin.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Least cardiotoxicity is seen with which of the following anthracycline antibiotic?",
    "choices": [
      {
        "id": 1,
        "text": "Doxorubicin"
      },
      {
        "id": 2,
        "text": "Daunorubicin"
      },
      {
        "id": 3,
        "text": "Idarubicin"
      },
      {
        "id": 4,
        "text": "Epirubicin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Idarubicin</strong> has <strong>least cardiotoxicity</strong> when compared to other anthracyclines.</p>\n<p>It is approved for use in <strong>acute myeloid leukemia</strong> along with cytarabine.&nbsp;Doxorubicin, daunorubicin and epirubicin share similar cardiotoxicity profile.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "While reviewing the drug chart of a patient undergoing radiotherapy, which of the following drugs would require a dose adjustment to prevent radiation toxicity?",
    "choices": [
      {
        "id": 1,
        "text": "Vincristine"
      },
      {
        "id": 2,
        "text": "Doxorubicin"
      },
      {
        "id": 3,
        "text": "Cyclophosphamide"
      },
      {
        "id": 4,
        "text": "6-mercaptopurine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Doxorubicin</strong> requires <strong>dose adjustment</strong> during or after radiotherapy in order to <strong>prevent radiation toxicity.</strong></p>\n<p>Anthracyclines like doxorubicin&nbsp;can result in a <strong>radiation recall reaction,</strong>&nbsp;where erythema and desquamation of skin are observed at sites of previous radiation injury.&nbsp;The risk of <strong>cardiotoxicity</strong> also increases with previous irradiation.&nbsp;Therefore, careful monitoring and dosage adjustments are required for doxorubicin.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient is undergoing chemotherapy for glioblastoma multiforme. You notice that his serial blood investigations reveal sustained neutropenia. Which of the following drugs could have caused this?",
    "choices": [
      {
        "id": 1,
        "text": "Carmustine"
      },
      {
        "id": 2,
        "text": "Cisplatin"
      },
      {
        "id": 3,
        "text": "Vinblastine"
      },
      {
        "id": 4,
        "text": "Cyclophosphamide"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Sustained neutropenia is seen&nbsp;with <strong>nitrosoureas</strong>. Nitrosoureas like <strong>carmustine</strong> and <strong>lomustine</strong> cause profound and delayed<strong> myelosuppression </strong>with recovery 4-6 weeks after a single dose.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with Hodgkin\u2019s disease on chemotherapy with an alkylating agent develops behavioral disturbances and experiences sedation. He presented to the emergency room with a disulfiram-like reaction. What is the drug being described here?",
    "choices": [
      {
        "id": 1,
        "text": "Dacarbazine"
      },
      {
        "id": 2,
        "text": "Procarbazine"
      },
      {
        "id": 3,
        "text": "Carmustine"
      },
      {
        "id": 4,
        "text": "Lomustine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most likely alkylating agent being described here is <strong>procarbazine</strong>. It is associated with behavioural disturbances and sedation. Concomitant CNS depressants should be avoided.</p>\n<p>Procarbazine is a<strong> weak MAO inhibitor</strong> and can potentiate tyramine and catecholamines action.\u00a0It also has<strong> disulfiram-like actions</strong> and alcohol should be avoided.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50 year old man who presented with dysphagia was diagnosed with esophageal carcinoma and underwent multiple cycles of chemotherapy. During the cycles, he had developed tingling and numbness in the lower limbs and the symptoms progressed even after cessation of the cycles. Which drug could have led to this?",
    "choices": [
      {
        "id": 1,
        "text": "Cisplatin"
      },
      {
        "id": 2,
        "text": "Paclitaxel"
      },
      {
        "id": 3,
        "text": "Mitomycin"
      },
      {
        "id": 4,
        "text": "Vincristine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The scenario depicts <strong>coasting effect neuropathy</strong>, which is seen with <strong>cisplatin</strong>.</p>\n<p>The coasting effect means the progression of <strong>symptoms</strong> even <strong>after</strong> the <strong>cessation</strong> of the drug. <strong>Neurotoxicity</strong> is usually dependent on the cumulative dose of anticancer drugs. The severity of neuropathy increases with the duration of treatment and progression stops once drug treatment is completed.&nbsp;</p>\n<p><strong>Platinum compounds</strong> are an exception, where <strong>sensory loss progresses</strong> for several months <strong>after cessation of treatment</strong>. The coasting effect is more common with cisplatin and oxaliplatin than with carboplatin.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 65 year old man who was diagnosed with small cell carcinoma of the lung had undergone chemotherapy about 5 years ago. Now he presents with features suggestive of AML. Which of the following drugs could have caused this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Vinblastine"
      },
      {
        "id": 2,
        "text": "Paclitaxel"
      },
      {
        "id": 3,
        "text": "Cisplatin"
      },
      {
        "id": 4,
        "text": "Bleomycin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The scenario is suggestive of&nbsp;<strong>secondary leukemia</strong> which is associated with <strong>c</strong><strong>isplatin</strong>. Cisplatin is a platinum-containing anticancer agent that forms DNA adduct. It is associated with the development of AML usually more than 4 years after treatment.</p>\n<p>Procarbazine, a methylhydralazine (alkylating agent), is most commonly associated with the development of leukemias with a 5-10% risk of acute leukemia in patients treated with the MOPP regimen.</p>\n<p>Cisplatin produces responses in cancers of the bladder, head and neck, cervix, and endometrium; all forms of carcinoma of the lung; anal and rectal carcinomas; and neoplasms of childhood.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who was diagnosed with gastric carcinoma is undergoing chemotherapy. His serum creatinine levels are rising and you suspect renal tubular damage caused by one of his chemotherapeutic drugs. Which drug could it be?",
    "choices": [
      {
        "id": 1,
        "text": "Cisplatin"
      },
      {
        "id": 2,
        "text": "Streptozocin"
      },
      {
        "id": 3,
        "text": "Methysergide"
      },
      {
        "id": 4,
        "text": "Cyclophosphamide"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given scenario is suggesstive of <strong>nephrotoxicity</strong> and it is one of the dose-limiting toxicity of <strong>cisplatin</strong> therapy. Cisplatin achieves a high concentration in nephrons. Both direct toxicity and inflammation are responsible for nephrotoxicity.&nbsp;A high concentration of chloride stabilizes cisplatin and reduces nephrotoxicity. Therefore,<strong> chloride diuresis</strong> is used to reduce nephrotoxicity.</p>\n<p>Option B - Streptozotocin use can result in diabetes mellitus due to the destruction of beta cells of the pancreas.</p>\n<p>Option C - Methysergide use is associated with retroperitoneal fibrosis.</p>\n<p>Option D - Cyclophosphamide causes hemorrhagic cystitis as one of its characteristic side effect.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is a highly emetogenic anticancer drug?",
    "choices": [
      {
        "id": 1,
        "text": "Paclitaxel"
      },
      {
        "id": 2,
        "text": "Vincristine"
      },
      {
        "id": 3,
        "text": "Cisplatin"
      },
      {
        "id": 4,
        "text": "5-Fluorouracil"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Cisplatin</strong> is a highly emetogenic anticancer drug.&nbsp;Cisplatin causes marked nausea and vomiting in almost all cases and is usually administered along with anti-emetic regimens.</p>\n<p>This can usually be controlled with 5HT3 receptor antagonists, neurokinin (NK1) receptor antagonists (e.g., aprepitant), and high-dose corticosteroids.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who is undergoing chemotherapy for testicular cancer, now presents with dyspnea and dry cough. Investigations suggest pulmonary fibrosis. This condition is commonly  associated with which of the following drugs?",
    "choices": [
      {
        "id": 1,
        "text": "Bleomycin"
      },
      {
        "id": 2,
        "text": "Cisplatin"
      },
      {
        "id": 3,
        "text": "Methotrexate"
      },
      {
        "id": 4,
        "text": "Actinomycin D"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Note: Few case reports of methotrexate causing pulmonary fibrosis are reported. The association is still uncertain as the underlying disease process like RA can also contribute to fibrosis.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient who is undergoing chemotherapy, now presents with weight gain, ascites, hepatomegaly and hyperbilirubinemia. You suspect sinusoidal obstruction syndrome. Which drug is the most common cause of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ifosfamide"
      },
      {
        "id": 2,
        "text": "Cyclophosphamide"
      },
      {
        "id": 3,
        "text": "Bleomycin"
      },
      {
        "id": 4,
        "text": "Busulfan"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Sinusoidal obstruction syndrome&nbsp;</strong>is most commonly associated with <strong>high-dose busulfan</strong>.&nbsp;Incidence increases when coadministered with CYP inhibitors.</p>\n<p>Sinusoidal obstruction syndrome, previously known as veno-occlusive hepatic disease (VOD), involves primary hepatic sinusoidal injury that progresses to diffuse hepatocyte involvement and panvasculitis. This leads to multi-organ failure, and can be life-threatening.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient undergoing chemotherapy was brought to the ER with seizures. He is diagnosed with cerebrovascular accident which you suspect to be due to a drug-induced hypercoagulable state. Which of the following drugs is implicated?",
    "choices": [
      {
        "id": 1,
        "text": "5-FU"
      },
      {
        "id": 2,
        "text": "L-asparaginase"
      },
      {
        "id": 3,
        "text": "Melphalan"
      },
      {
        "id": 4,
        "text": "Carmustine"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>L-asparaginase</strong> causes a <strong>hypercoagulable state</strong>. It is an enzyme and toxicity results due to the inhibition of protein synthesis in normal tissues.</p>\n<p>Side effects of&nbsp;L-asparaginase:</p>\n<ul>\n<li>Thrombosis and increased coagulation - physiological anticlotting factors are impaired</li>\n<li>Hemorrhage and bleeding - clotting factors are impaired</li>\n<li>Hyperglycemia - insulin deficiency.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following drugs causes flagellate pigmentation?",
    "choices": [
      {
        "id": 1,
        "text": "Bleomycin"
      },
      {
        "id": 2,
        "text": "Doxorubicin"
      },
      {
        "id": 3,
        "text": "Vincristine"
      },
      {
        "id": 4,
        "text": "Minocycline"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><span class=\"TextRun SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\"><strong>Flagellate hyperpigmentation/flagellate erythema</strong>&nbsp;</span></span><span class=\"TextRun SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\">is</span></span><span class=\"TextRun SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\">&nbsp;a characteristic cutaneous reaction to treatment with <strong>b</strong></span></span><strong><span class=\"TextRun Underlined SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\">leomycin</span></span></strong><span class=\"TextRun SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\">.&nbsp;</span></span></p>\n<p><span class=\"TextRun SCXW81824019\" lang=\"EN-US\" xml:lang=\"EN-US\"><span class=\"NormalTextRun SCXW81824019\">Clinical features include <strong>multiple linear streaks</strong> (erythematous or hyperpigmented) <strong>at sites of trauma and generalized pruritus</strong>.</span></span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/378bdd93332c47f1ac9b787f8fc79dccx512x140.PNG"
    ]
  },
  {
    "text": "Which of the following drugs cause carcinoma bladder?",
    "choices": [
      {
        "id": 1,
        "text": "Cyclophosphamide"
      },
      {
        "id": 2,
        "text": "Cisplatin"
      },
      {
        "id": 3,
        "text": "Taxane"
      },
      {
        "id": 4,
        "text": "Tamoxifen"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The only chemotherapeutic agent that has been proven to cause bladder cancer is <strong>cyclophosphamide</strong>.</p>\n<p>The risk of the bladder cancer formation is linearly related to the duration and intensity of cyclophosphamide treatment, supporting a causative role. <strong>Phosphoramide mustard</strong> is the primary <strong>mutagenic metabolite</strong> that causes bladder cancer in patients exposed to cyclophosphamide.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '65 Non Cell Cycle Specific Cytotoxic Drugs';
        const quizFilename = '65-non-cell-cycle-specific-cytotoxic-drugs-e3dd8370.html';
        let hierarchy = ["Marrow", "qBank", "Pharmacology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>