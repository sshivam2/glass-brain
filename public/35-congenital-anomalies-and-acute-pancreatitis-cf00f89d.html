<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>35 Congenital Anomalies And Acute Pancreatitis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Surgery
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "What is the most common congenital anomaly of the pancreas?",
    "choices": [
      {
        "id": 1,
        "text": "Annular pancreas"
      },
      {
        "id": 2,
        "text": "Pancreas divisum"
      },
      {
        "id": 3,
        "text": "Sphincter of Oddi dysfunction"
      },
      {
        "id": 4,
        "text": "Agenesis of pancreas"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Pancreas divisum</strong> is the most common congenital anomaly of the pancreas.</p>\n<p>During embryogenesis, the developing pancreatic ducts usually fuse in such a way that most of the dorsal duct drains into the proximal part of the ventral duct.&nbsp;The proximal portion of the dorsal duct usually persists as an accessory duct.</p>\n<p>In about 10% of the population, there is a <strong>failure of fusion of the dorsal and ventral pancreatic buds</strong> leading to a condition called <strong>pancreatic divisum</strong>&nbsp;(pancreas divisum). Pancreatic drainage is accomplished mainly through the accessory papilla.</p>\n<p>Since most of the pancreatic exocrine secretions exit through the dorsal duct, the pancreas divisum can lead to a&nbsp;partial obstruction&nbsp;due to the&nbsp;small minor papilla, leading to the development of&nbsp;<strong>relapsing acute or chronic pancreatitis</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/90adffa91c7e4b2ab9d53433f17a18d2x600x2543.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is false regarding the management of pancreatic divisum?",
    "choices": [
      {
        "id": 1,
        "text": "Sphincteroplasty is done"
      },
      {
        "id": 2,
        "text": "Pancreatojejunostomy is also known as Puestow's procedure"
      },
      {
        "id": 3,
        "text": "Endoscopic sphincterotomy relieves the symptoms"
      },
      {
        "id": 4,
        "text": "ERCP is more advantageous than MRCP for the diagnosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The diagnosis of pancreatic divisum can also be made by <strong>EUS, or ERCP,</strong> augmented by injection of <strong>secretin</strong> if necessary.</p>\n<p><strong>Endoscopic sphincterotomy</strong> and <strong>stenting</strong> of the minor papilla relieve the symptoms. Surgical intervention&nbsp;may involve&nbsp;<strong>sphincteroplasty</strong>, pancreatojejunostomy (<strong>Puestow procedure</strong>), or even <strong>resection</strong> of the pancreatic head.</p>\n<p>The image given below shows an MRCP done for a case of pancreatic divisum.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/62364bbddd7f49c383e4f1343fffa1d1x970x905.PNG"
    ]
  },
  {
    "text": "A 9-year-old girl was referred to the OPD with a chronic history of early satiety and recurrent non-bilious vomiting after heavy meals. Barium meal revealed a diffusely narrowed second portion of the duodenum, suggesting extrinsic compression. Which of the following statements is false regarding the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "It is associated with failure of complete rotation of the ventral bud"
      },
      {
        "id": 2,
        "text": "Can be associated with classic double bubble sign on radiograph"
      },
      {
        "id": 3,
        "text": "Duodenoduodenostomy is the treatment of choice"
      },
      {
        "id": 4,
        "text": "MRCP is the gold standard investigation"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>It is most often seen in association with congenital<strong> duodenal atresia</strong> and is, therefore, more prevalent in children with <strong>Down&rsquo;s</strong> <strong>syndrome</strong>.</p>\n<p>Duodenal obstruction typically causes non-projectile, <strong>non-bilious vomiting</strong> in neonates.&nbsp;</p>\n<p>Plain abdominal radiographs may demonstrate the classic <strong>double bubble sign</strong>. But it is <strong>non-specific</strong> for the annular pancreas. Despite many advances in diagnostic techniques such as CT scan, endoscopic ultrasound (EUS), MRCP, and ERCP, the <strong>gold standard test</strong> for diagnosing AP remains to be <strong>laparotomy</strong>. It involves a thorough gross examination of the duodenum and the head of the pancreas.</p>\n<p>The&nbsp;treatment&nbsp;for an annular pancreas is a duodenal bypass procedure (<strong>duodenoduodenostomy</strong>).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3b209d9670aa477aaa2af9d57e38ce68x1280x1465.JPEG"
    ]
  },
  {
    "text": "A 40-year-old chronic alcoholic presents with sudden onset abdominal pain in the epigastric region radiating to the back. The pain relieves on leaning forwards.  X-ray abdomen shows no gas under the diaphragm. Elevated amylase levels and total WBC count are seen. Which of the following signs are likely to be present in this condition?",
    "choices": [
      {
        "id": 1,
        "text": "1, 2 and 3"
      },
      {
        "id": 2,
        "text": "1, 3 and 5"
      },
      {
        "id": 3,
        "text": "2, 4 and 5"
      },
      {
        "id": 4,
        "text": "2, 3 and 4"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The clinical scenario is suggestive of acute pancreatitis.<strong> Rovsing sign and Aaron sign</strong> are seen in <strong>acute appendicitis.</strong></p>\n<p><strong>Rovsing sign</strong>: Pain in the right lower quadrant during palpation of the left lower quadrant.\u00a0</p>\n<p><strong>Aaron sign</strong>: Pain or pressure in the epigastrium or anterior chest with firm pressure applied to McBurney\u2019s point.</p>\n<p>In <strong>severe acute pancreatitis</strong>, the injured pancreas releases pancreatic enzymes that cause fat necrosis and inflammation, occasionally resulting in <strong>peri-pancreatic bleeding</strong>.\u00a0The resulting fluid collection can travel via an anatomical defect of the transversalis fascia. This accumulates at various sites and shows discoloration of the skin.</p>\n<p><strong>Cullen's sign:</strong> If the blood diffuses from the retroperitoneum along with the gastrohepatic and falciform ligaments to the umbilicus, it results in <strong>bluish discoloration around the\u00a0umbilicus</strong></p>\n<p><strong>Grey Turner sign:</strong>\u00a0If the blood diffuses from the posterior pararenal space to the lateral edge of the quadratus lumborum muscle, it results in <strong>bluish discoloration of the\u00a0flanks</strong></p>\n<p><strong>Fox sign</strong>: Pooling of retroperitoneal hemorrhage at the inguinal ligament shows <strong>discoloration</strong>\u00a0<strong>below the inguinal ligament</strong></p>\n<p><strong>Bryant sign: </strong>Pooling of blood at the <strong>scrotum</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of acute pancreatitis?",
    "choices": [
      {
        "id": 1,
        "text": "Alcohol"
      },
      {
        "id": 2,
        "text": "Gallstones"
      },
      {
        "id": 3,
        "text": "Autoimmune"
      },
      {
        "id": 4,
        "text": "Iatrogenic"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most common cause of acute pancreatitis is the presence of&nbsp;<strong>gallstones</strong>&nbsp;(50-70%).&nbsp;The second most common cause is&nbsp;<strong>alcohol abuse&nbsp;</strong>(25%).</p>\n<p>Causes of acute pancreatitis: (Mnemonic: I GET SMASHED)</p>\n<ul>\n<li>I &ndash; Idiopathic</li>\n<li>G &ndash; Gallstones</li>\n<li>E &ndash; Ethanol</li>\n<li>T &ndash; Trauma</li>\n<li>S &ndash; Steroids</li>\n<li>M &ndash; Mumps, malignancy (pancreatic cancer)</li>\n<li>A &ndash; Autoimmune</li>\n<li>S &ndash; Scorpion sting</li>\n<li>H &ndash; Hypercalcemia, hypertriglyceridemia (Usually more than 1000 mg/dL)</li>\n<li>E &ndash; Endoscopic retrograde cholangiopancreatography (ERCP)</li>\n<li>D &ndash; Drugs</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presenting with acute abdomen was found to have elevated serum amylase levels. Which of the following should be part of your differential diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "1, 3, 4"
      },
      {
        "id": 2,
        "text": "1 and 5"
      },
      {
        "id": 3,
        "text": "2, 3, 4"
      },
      {
        "id": 4,
        "text": "1, 2, 3, 4, 5"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>All the above conditions should be part of the differential diagnosis in patients with <strong>acute abdominal pain</strong> and <strong>elevated serum amylase levels.</strong></p>\n<p>Conditions associated with <strong>elevated serum amylase levels:</strong></p>\n<ul>\n<li>Burns</li>\n<li>Pregnancy</li>\n<li>Pancreatitis</li>\n<li><strong>Cholecystitis</strong></li>\n<li><strong>Diabetic ketoacidosis</strong></li>\n<li><strong>Ruptured ectopic pregnancy</strong></li>\n<li><strong>Aortic aneurysm</strong></li>\n<li>Renal failure</li>\n<li>Renal transplantation</li>\n<li>Chronic liver disease</li>\n<li><strong>Intestinal obstruction</strong></li>\n<li>Drugs like morphine</li>\n<li>Salivary gland involvement: mumps, calculus, maxillofacial surgery</li>\n<li>Tumors of the lungs, esophagus, breast, or ovary (LEBO)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All of the following derangements can be expected in a patient with acute pancreatitis except:",
    "choices": [
      {
        "id": 1,
        "text": "Hypoalbuminemia"
      },
      {
        "id": 2,
        "text": "Hyperglycemia"
      },
      {
        "id": 3,
        "text": "Hypercalcemia"
      },
      {
        "id": 4,
        "text": "Azotemia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Acute pancreatitis </strong>causes<strong> hypocalcemia,</strong>&nbsp;not hypercalcemia.</p>\n<p>The <strong>pancreatic enzymes</strong> cause <strong>autodigestion of the mesenteric fat</strong> leading to the release of free fatty acids. These free fatty acids combine with calcium to form calcium salts, causing low levels of circulating calcium.</p>\n<p>Hypercalcemia may cause acute pancreatitis. Hypocalcemia is a complication of acute pancreatitis.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not used to assess the severity of acute pancreatitis?",
    "choices": [
      {
        "id": 1,
        "text": "HAPS score"
      },
      {
        "id": 2,
        "text": "Ranson's criteria"
      },
      {
        "id": 3,
        "text": "Modified Glasgow criteria"
      },
      {
        "id": 4,
        "text": "Alvarado scoring"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Alvarado scoring</strong> is used in <strong>acute appendicitis</strong>, not acute pancreatitis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All of the following parameters will be included in the assessment of acute pancreatitis using Ranson's criteria, except:",
    "choices": [
      {
        "id": 1,
        "text": "Age > 55 years"
      },
      {
        "id": 2,
        "text": "Serum LDH level > 250 IU/L"
      },
      {
        "id": 3,
        "text": "Blood glucose level > 200 mg/dL"
      },
      {
        "id": 4,
        "text": "WBC > 16000 cells/mm3"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Serum lactate dehydrogenase (LDH) &gt; 350 IU/L</strong> is included in <strong>Ranson&rsquo;s criteria</strong>, not 250 IU/L.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Revised atlanta classification is used for assessing severity of:",
    "choices": [
      {
        "id": 1,
        "text": "Pancreatic fistula"
      },
      {
        "id": 2,
        "text": "Acute pancreatitis"
      },
      {
        "id": 3,
        "text": "Chronic pancreatitis"
      },
      {
        "id": 4,
        "text": "Calcification of pancreatic duct"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Revised atlanta classification</strong> is used for assessing the <strong>severity of acute pancreatitis.</strong></p>\n<p>Revised atlanta classification:</p>\n<p>Mild Acute Pancreatitis</p>\n<ul>\n<li>No organ failure</li>\n<li>No local or systemic complications</li>\n</ul>\n<p>Moderately Severe Acute Pancreatitis</p>\n<ul>\n<li>Transient organ failure (&lt;48 hours) and/or</li>\n<li>Local or systemic complications without persistent organ failure</li>\n</ul>\n<p>Severe Acute Pancreatitis</p>\n<ul>\n<li>Persistent organ failure (&gt;48 hours) &ndash; Single organ or multiorgan</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A gasless abdomen is seen in:",
    "choices": [
      {
        "id": 1,
        "text": "Ulcerative colitis"
      },
      {
        "id": 2,
        "text": "Intussusception"
      },
      {
        "id": 3,
        "text": "Acute pancreatitis"
      },
      {
        "id": 4,
        "text": "Crohn\u2019s disease"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A <strong>gasless abdomen</strong> is an X-ray feature that can be seen in<strong> acute pancreatitis</strong>. Patients with<strong> </strong>acute pancreatitis can have significant vomiting and diarrhea that may produce a gasless abdomen.</p>\n<p>Common causes of gasless abdomen include:</p>\n<ul>\n<li>High obstruction: gastric outlet obstruction, congenital atresia</li>\n<li>Small bowel obstruction\u00a0</li>\n<li>Bowel ischemia</li>\n<li>Ascites</li>\n<li>Acute pancreatitis</li>\n<li>Gastroenteritis</li>\n<li>Large abdominal mass - due to displacement</li>\n<li>Post-surgery following total colectomy, esophagogastrectomy, gastrectomy, and low anterior resection</li>\n<li>A paucity of small bowel gas may be a normal finding in some adults</li>\n</ul>\n<p>Note: In intussusception, an X-ray shows small bowel obstruction, a mass, and a <strong>paucity of gas in the right iliac fossa</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young man presents to the emergency department with complaints of severe abdominal pain and 3 episodes of vomiting in the past 9 hours. He says that the pain radiates to the back and is partially relieved by bending forwards. The abdominal radiograph of the patient is given below. What is the sign that is seen in the radiograph?",
    "choices": [
      {
        "id": 1,
        "text": "Sentinel loop sign"
      },
      {
        "id": 2,
        "text": "Colon cut-off sign"
      },
      {
        "id": 3,
        "text": "Renal halo sign"
      },
      {
        "id": 4,
        "text": "Obliteration of psoas shadow"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows the&nbsp;<strong>colon cut-off sign</strong>, which is seen in <strong>acute pancreatitis</strong>.</p>\n<p>The colon cut-off sign refers to the <strong>abrupt termination of the gas filling of the colon</strong> on the left side. The inflammation of acute pancreatitis may extend to the phrenicocolic ligament via the transverse mesocolon. This causes&nbsp;<strong>functional spasm</strong> of the splenic flexure resulting in the colon cut-off sign.</p>\n<p>All the other options mentioned above are also seen in acute pancreatitis.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/2e76756728454a8d8738c3d94a08804c.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is false regarding usage of the contrast-enhanced CT scan in cases of acute pancreatitis?",
    "choices": [
      {
        "id": 1,
        "text": "It is the investigation of choice"
      },
      {
        "id": 2,
        "text": "It should be done within 72 hours from the onset of symptoms"
      },
      {
        "id": 3,
        "text": "Balthazar criteria is used to stage the severity of pancreatitis detected on CT scan"
      },
      {
        "id": 4,
        "text": "Signs of sepsis is an indication for CT scan"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>&nbsp;</p>\n<p>The <strong>severity of pancreatitis</strong> detected on CT scan is staged according to the <strong>Balthazar criteria.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4c53506ac49744869c4168d8b056895dx672x600.JPEG"
    ]
  },
  {
    "text": "A patient with acute pancreatitis underwent a contrast-enhanced CT scan of the abdomen. CT scan shows diffuse enlargement of the pancreas without necrosis. What will be the CT severity index of the patient?",
    "choices": [
      {
        "id": 1,
        "text": "3"
      },
      {
        "id": 2,
        "text": "1"
      },
      {
        "id": 3,
        "text": "4"
      },
      {
        "id": 4,
        "text": "2"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><span style=\"font-size: 12pt;\">The <strong>CT severity index (CTSI) </strong>of this patient will be <strong>1</strong>.</span></p>\n<p><span style=\"font-size: 12pt;\">The CT severity index for <strong>grading of acute pancreatitis</strong> is\u00a0</span><span style=\"font-size: 12pt;\">determined as the sum of two scores:</span></p>\n<ul>\n<li><span style=\"font-size: 12pt;\"><strong>Balthazar score</strong>: grading of pancreatitis\u00a0</span></li>\n<li><span style=\"font-size: 12pt;\"><strong>Necrosis score</strong>: grading of the extent of pancreatic necrosis</span></li>\n</ul>\n<p><span style=\"font-size: 12pt;\">The Balthazar score for\u00a0diffuse enlargement of the pancreas is 1. Since there is no necrosis, the necrosis score of the patient is zero. Hence the CTSI of this patient is 1.</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "When will you use the SOFA score in a patient with acute pancreatitis?",
    "choices": [
      {
        "id": 1,
        "text": "To assess organ failure"
      },
      {
        "id": 2,
        "text": "To assess the need for surgery"
      },
      {
        "id": 3,
        "text": "In cases of pancreatic abscess formation"
      },
      {
        "id": 4,
        "text": "To assess the length of hospital stay"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>The Sequential Organ Failure Assessment (SOFA) score</strong>&nbsp;is used to<strong> assess organ failure</strong>&nbsp;in acute pancreatitis.<strong>&nbsp;</strong>The three organ systems most frequently involved are the cardiovascular, respiratory, and renal systems. <strong>Multiple organ failures</strong> are said to exist when <strong>2&nbsp;or more organs register 2 or more points</strong> on these scoring systems.</p>\n<p><strong>qSOFA</strong> score (quickSOFA) is a bedside prompt that may <strong>identify patients</strong> with suspected infection who are at greater risk for a <strong>poor outcome outside the intensive care unit (ICU). </strong>It uses three criteria, assigning one point each for</p>\n<ul>\n<li>Low blood pressure (SBP&le;100 mmHg)</li>\n<li>High respiratory rate (&ge;22 breaths per min)</li>\n<li>Altered mentation (Glasgow coma scale, &lt;15)</li>\n</ul>\n<p>The score ranges from 0 to 3 points. The presence of <strong>2 or more qSOFA points</strong> is a simple prompt to identify infected patients outside the ICU who are likely to develop sepsis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 35-year-old man presented with a 1-day history of sudden onset of severe abdominal pain with radiation to the back. He gives a history of binge drinking on the night prior to his symptom onset. He is hemodynamically stable and there is no sign of organ impairment. His serum amylase level is 500 U/L ( normal: 23\u201385 U/L) and lipase level is 1100 U/L (normal: 10-140 U/L). Which of the following is false regarding the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "CECT abdomen is almost always necessary to establish the diagnosis"
      },
      {
        "id": 2,
        "text": "CT should be performed 72 hours after the onset of symptoms to assess complications"
      },
      {
        "id": 3,
        "text": "Modified marshall scoring system can be used to assess the severity of organ failure"
      },
      {
        "id": 4,
        "text": "Early initiation of enteral nutrition is beneficial for overall improvement of prognosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given clinical scenario with characteristic lab findings is suggestive of <strong>acute pancreatitis</strong>.<strong> CECT</strong> abdomen is <strong>not always necessary</strong> to diagnose acute pancreatitis.&nbsp;<br />According to the revised Atlanta classification, acute pancreatitis is clinically defined by at least the first two of three features:</p>\n<ol>\n<li><strong>abdominal pain</strong> suggestive of pancreatitis (epigastric pain often radiating to the back),</li>\n<li>serum <strong>amylase</strong> and <strong>lipase</strong> levels<strong> &ge; 3 times normal</strong> (imaging is to be used if the elevated values are less than 3 times normal); and</li>\n<li><strong>characteristic imaging findings</strong> on CT, magnetic resonance (MR) imaging, or transabdominal ultrasonographic (US) studies.&nbsp;&nbsp;&nbsp;</li>\n</ol>\n<p>&nbsp;If acute pancreatitis is diagnosed on the basis of the first two criteria with no systemic sign of severe systemic inflammatory response syndrome or persistent organ failure, contrast material&ndash;enhanced CT may not be necessary for determining patient care.</p>\n<p>Option B: The optimal time for performance of <strong>contrast-enhanced CT</strong> imaging in cases of acute pancreatitis is <strong>more than 72 hours</strong> from the <strong>onset of symptoms</strong>. In the first 72 hours, CT may <strong>underestimate</strong> the extent of necrosis. Indications of CT scan in pancreatitis are</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Diagnostic uncertainty</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">In patients with severe acute pancreatitis, to distinguish interstitial from necrotizing pancreatitis</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">In patients with organ failure, <strong>signs of sepsis</strong> or progressive clinical deterioration</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">When a <strong>localized complication</strong> is suspected, such as fluid collection, pseudocyst, or a pseudoaneurysm</li>\n</ul>\n<p>Option C: For <strong>severe acute pancreatitis</strong> with systemic inflammatory response syndrome and possible <strong>organ impairment</strong>, the <strong>modified marshall scoring</strong> can be used to assess the severity of organ failure. It includes respiratory, cardiovascular, and renal systems scores. A score of more than 2 for any organs indicates organ failure. Revised Atlanta classification recommends the modified Marshall scoring system as the<strong> main tool</strong> in determining organ failure.</p>\n<p>Option D: Current evidence confirms that the administration of <strong>enteral nutrition</strong> is <strong>beneficial</strong> for the treatment of severe acute pancreatitis. Enteral feeding reduces mortality, infectious complications, and multiorgan failure. In terms of the timing of enteral nutritional support, relatively<strong> early administration</strong> within <strong>48 or 72 h</strong> of hospital admission is suggested.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with pancreatitis is likely to develop all of the following vascular complications, except:",
    "choices": [
      {
        "id": 1,
        "text": "Splenic vein thrombosis"
      },
      {
        "id": 2,
        "text": "Splenic artery aneurysm"
      },
      {
        "id": 3,
        "text": "Gastroduodenal artery aneurysm"
      },
      {
        "id": 4,
        "text": "Mesenteric artery thrombosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Mesenteric artery thrombosis is unlikely in patients with acute pancreatitis.</p>\n<p>The most common vascular complication following acute pancreatitis is <strong>arterial pseudoaneurysm.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A chronic alcoholic presented with complaints of progressive abdominal distension. His past history is significant for acute pancreatitis which was managed by supportive care. USG abdomen showed peri-pancreatic ascitic fluid collection. A large volume paracentesis (LVP) was performed. Which of the following statements is false about this condition?",
    "choices": [
      {
        "id": 1,
        "text": "The ascitic fluid will be low in protein."
      },
      {
        "id": 2,
        "text": "Amylase levels in the fluid are raised."
      },
      {
        "id": 3,
        "text": "Somatostatin will help in decreasing secretion."
      },
      {
        "id": 4,
        "text": "Paracentesis shows turbid fluid."
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given scenario is suggestive of <strong>pancreatic ascites.</strong>&nbsp;The pancreatic ascitic fluid is rich in enzymes, and <strong>not low in protein.</strong></p>\n<p>Pancreatic ascites occurs due to the <strong>disruption of the pancreatic duct. </strong>It presents with significant <strong>abdominal distention</strong>, with free intra-abdominal fluid.</p>\n<p><strong>Diagnostic paracentesis</strong> typically demonstrates <strong>turbid fluid</strong> with&nbsp;<strong>elevated amylase and lipase levels.</strong></p>\n<p>Treatment involves <strong>suppression of pancreatic secretion</strong>&nbsp;by parenteral or nasojejunal feeding and administration of <strong>octreotide/somatostatin</strong>. <strong>Abdomi&shy;nal drainage</strong> combined with the endoscopic placement of a pancreatic stent across the disruption is done.</p>\n<p>If the above steps fail, surgical treatment consisting of <strong>distal pancreatic resection</strong> and <strong>closure of the proxi&shy;mal stump</strong> is done.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A young lady presents with acute epigastric pain and vomiting. She also gives a history of pain and swelling over the right parotid gland for 3 days. USG abdomen reveals peripancreatic ascitic fluid collection. Which of the following is not true about the fluid collection?",
    "choices": [
      {
        "id": 1,
        "text": "It is not associated with fibrous wall"
      },
      {
        "id": 2,
        "text": "The most common vessel involved is the splenic artery"
      },
      {
        "id": 3,
        "text": "Most resolve spontaneously."
      },
      {
        "id": 4,
        "text": "Associated with hemosuccus pancreaticus."
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario is suggestive of <strong>acute pancreatitis</strong> caused due to <strong>mumps</strong>.&nbsp;<strong>Hemosuccus pancreaticus</strong>&nbsp;in acute pancreatitis is <strong>not associated with ascites</strong>.</p>\n<p>Hemosuccus pancreaticus is due to the&nbsp;<strong>erosion of the wall of the pancreatic pseudocyst</strong> into the splenic artery forming a direct communication. It presents with abdominal pain and upper gastrointestinal (GI) bleeding, without ascites.</p>\n<p>In contrast to pseudocysts and cystic neoplasias of the pancreas, fluid collections are <strong>not surrounded or encased by epithelium or fibrotic capsules.</strong></p>\n<p><strong>Diagnostic paracentesis</strong>&nbsp;typically demonstrates&nbsp;<strong>turbid fluid</strong>&nbsp;with&nbsp;<strong>elevated amylase and lipase levels.</strong></p>\n<p>Most fluid collections will be <strong>spontaneously reabsorbed</strong> by the peritoneum. Treatment involves&nbsp;<strong>suppression of pancreatic secretion</strong>&nbsp;by parenteral or nasojejunal feeding and administration of&nbsp;<strong>octreotide/somatostatin</strong>.&nbsp;<strong>Abdomi&shy;nal drainage</strong>&nbsp;combined with the endoscopic placement of a pancreatic stent across the disruption is done.</p>\n<p>If the above steps fail, surgical treatment consisting of&nbsp;<strong>distal pancreatic resection</strong>&nbsp;and&nbsp;<strong>closure of the proxi&shy;mal stump</strong>&nbsp;is done.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with acute pancreatitis was admitted following binge drinking. 7-days post-admission, he complains of fever with chills and rigor. Blood investigation shows a WBC count of 21,450. CT scan reveals the presence of extraluminal gas in the pancreatic tissue. How will you manage this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Cystogastrostomy"
      },
      {
        "id": 2,
        "text": "Cystojejunostomy"
      },
      {
        "id": 3,
        "text": "Percutaneous catheter drainage"
      },
      {
        "id": 4,
        "text": "IV antibiotics alone"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical scenario with a history of pancreatitis, elevated WBC, and CT scan findings are suggestive of <strong>pancreatic abscess. </strong>It is treated by <strong>percutaneous drainage.</strong></p>\n<p>A pancreatic abscess is a circumscribed intra-abdominal collection of pus, usually in proximity to the pancreas. It may be an acute fluid collection or walled-off <strong>necrosis<strong><strong>&nbsp;</strong></strong></strong>that has become <strong>infected</strong>.</p>\n<p>Clinical features include:</p>\n<ul>\n<li>Fever with chills</li>\n<li>Elevated white blood cell count</li>\n<li>Abdominal pain</li>\n</ul>\n<p><strong>Contrast-enhanced CT scan</strong> and <strong>MRI</strong> are both options for the assessment of pancreatic necrosis and abscesses. On imaging, the presence of <strong>extraluminal gas</strong> in the pancreatic and/or peripancreatic tissues is consistent with an underlying infection.</p>\n<article class=\"single-article\"></article>\n<p>Treatment is by <strong>percutaneous drainage with the widest possible drains</strong> placed under imaging guidance, along with appropriate antibiotics and supportive care.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following will not be part of the management plan of patients with infected pancreatic necrosis?",
    "choices": [
      {
        "id": 1,
        "text": "Conservative management with IV antibiotics"
      },
      {
        "id": 2,
        "text": "Percutaneous drainage"
      },
      {
        "id": 3,
        "text": "Pancreatic necrosectomy"
      },
      {
        "id": 4,
        "text": "CT guided aspiration"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Infected pancreatic necrosis <strong>should not be managed conservatively with antibiotics alone</strong> because of the high risk of multiorgan failure and death.</p>\n<p>CT scan has to be performed in patients with severe acute pancreatitis, organ failure, sepsis, and in patients with clinical deterioration despite the treatment:</p>\n<ul>\n<li>If the CT scan shows the presence of <strong>sterile</strong> pancreatic necrosis <strong>medical management</strong> is recommended.</li>\n<li>If the CT scan shows the presence of necrosis with <strong>evidence of infection</strong>, then ultrasound or <strong>CT-guided aspiration</strong> of the fluid has to be done and the fluid is sent for staining and culture.&nbsp;</li>\n</ul>\n<p><strong>Infected pancreatic necrosis</strong> is treated by the administration of <strong>intravenous antibiotics</strong> (preferably <strong>carbapenems)</strong> and <strong>percutaneous drainage</strong> of the infected fluid. <strong>Pancreatic necrosectomy</strong> is be considered in the patients if the clinical condition worsens despite percutaneous drainage.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Regarding the revised Atlanta classification for morphologic stages of acute pancreatitis, which of the following is not true?",
    "choices": [
      {
        "id": 1,
        "text": "Acute necrotic collection is non-encapsulated necrosis within 4 weeks of onset"
      },
      {
        "id": 2,
        "text": "Acute peripancreatic fluid collection can be seen in interstitial edematous pancreatitis"
      },
      {
        "id": 3,
        "text": "Pancreatic pseudocyst can be seen in necrotizing pancreatitis"
      },
      {
        "id": 4,
        "text": "Collection that contains non-liquefied material is more likely to become infected"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Pancreatic pseudocyst is seen as a sequela of <strong>interstitial edematous pancreatitis</strong>, which is a <strong>non-necrotic collection</strong>. Necrotizing pancreatitis usually leads to acute necrotic collection (ANC) and walled-off necrosis (on encapsulation of ANC).</p>\n<p>Based on the revised Atlanta classification, peripancreatic fluid and their collections can be classified into <strong>4 different types</strong> based on their morphology and time of presentation.</p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">IEP - Interstitial Edematous Pancreatitis\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>APFC </strong>-&nbsp;Acute Peripancreatic Fluid Collection:<br />Non-necrotic fluid collection presenting within 4 weeks</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>Pancreatic pseudocyst:&nbsp;<br /></strong>Non-necrotic fluid collection when it undergoes encapsulation (after 4 weeks)</li>\n</ul>\n</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Necrotising Pancreatitis\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>ANC </strong>- Acute Necrotic Collection: <br />Necrotic fluid collection presenting within 4 weeks</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><strong>WON </strong>- Walled-Off Necrosis: <br />Necrotic fluid collection when it undergoes encapsulation (after 4 weeks)</li>\n</ul>\n</li>\n</ul>\n<table style=\"width: 492px;\">\n<tbody>\n<tr>\n<td style=\"width: 150px;\">Duration since onset</td>\n<td style=\"width: 164.141px; text-align: center;\">IEP</td>\n<td style=\"width: 149.859px;\">Necrotizing pancreatitis</td>\n</tr>\n<tr>\n<td style=\"width: 150px;\">&lt;4 weeks after onset<br />(not encapsulated)</td>\n<td style=\"width: 164.141px; text-align: center;\"><strong>APFC</strong></td>\n<td style=\"width: 149.859px; text-align: center;\"><strong>ANC</strong></td>\n</tr>\n<tr>\n<td style=\"text-align: center; width: 464px;\" colspan=\"3\">&dArr;<br />Undergoes encapsulation<br />&dArr;</td>\n</tr>\n<tr>\n<td style=\"width: 150px;\">&ge;4 weeks after onset <br />(encapsulated)</td>\n<td style=\"width: 164.141px;\"><strong>Pancreatic pseudocyst</strong></td>\n<td style=\"width: 149.859px; text-align: center;\"><strong>WON</strong></td>\n</tr>\n</tbody>\n</table>\n<p>ANC, APFC, WON, and pancreatic pseudocysts can be <strong>infected</strong> or<strong> non-infected</strong>. Collections that contain <strong>non-liquefied material</strong> or show the <strong>presence of gas</strong>, are more likely to be <strong>infected. </strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 12-year-old girl was rushed to the casualty after she was injured by a bicycle\u2019s handlebar in the abdomen. She complains of severe epigastric pain. On examination, bruises are seen in the epigastrium. Her CT scan is given below. Which of the following statements is false about her condition?",
    "choices": [
      {
        "id": 1,
        "text": "Damage control surgery is done."
      },
      {
        "id": 2,
        "text": "Distal pancreatectomy will be the definitive management."
      },
      {
        "id": 3,
        "text": "Surgery is indicated if the main pancreatic duct is disrupted."
      },
      {
        "id": 4,
        "text": "Amylase levels are highly sensitive"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical scenario with a <strong>handlebar injury</strong> and the CT scan showing <strong>transection of the body of the pancreas</strong> are suggestive <strong>pancreatic injury</strong>. Plasma <strong>amylase levels are not sensitive</strong> in pancreatic <strong>injuries.</strong></p>\n<p>The most common mechanism of pancreatic injury in <strong>children</strong> is <strong>blunt</strong> trauma (because of the decreased amount of fat and incomplete protection of the rib cage). In\u00a0<strong>adults, penetrating injuries </strong>are the most common cause. Involvement of <strong>other organs</strong> is also likely to be seen.\u00a0</p>\n<p>Direct compression of the epigastrium against the vertebral column and a blunt object (handlebar) is typically seen after bicycle injuries. The most common segment of the pancreas affected is the body.\u00a0</p>\n<p>Patients usually present with <strong>epigastric pain</strong>. In some cases, a delayed presentation may be due to leakage of pancreatic fluids.</p>\n<p>The modality of choice is the <strong>CT scan of the abdomen.\u00a0</strong>If there is doubt about duct disruption, an urgent <strong>ERCP</strong> or <strong>MRCP</strong> should be done.</p>\n<p>Surgery is indicated if the <strong>main pancreatic duct</strong> is disrupted. A <strong>damage control procedure</strong> with packing and drainage should be performed initially and the patient referred for definitive surgery after stabilization.\u00a0</p>\n<p>Definitive management includes:</p>\n<div class=\"page\" title=\"Page 1241\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 1241\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li><strong>Distal pancreatectomy</strong> -\u00a0If the body or tail is involved</li>\n<li><strong>External drainage </strong>-\u00a0If the head of the pancreas is involved\u00a0</li>\n<li><strong>Pancreatoduodenectomy</strong>\u00a0- If the pancreatic head and duodenum is involved</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/45b9797d68024966bf056d31bfad5207.PNG"
    ],
    "explanation_images": []
  }
];
        let quizName = '35 Congenital Anomalies And Acute Pancreatitis';
        const quizFilename = '35-congenital-anomalies-and-acute-pancreatitis-cf00f89d.html';
        let hierarchy = ["Marrow", "qBank", "Surgery"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>