<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>074 Ischemic Stroke - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">26</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Ischemia occurs in the brain when the cerebral blood flow falls below _____.",
    "choices": [
      {
        "id": 1,
        "text": "40 mL/100 g/min"
      },
      {
        "id": 2,
        "text": "20 mL/100 g/min"
      },
      {
        "id": 3,
        "text": "30 mL/100 g/min"
      },
      {
        "id": 4,
        "text": "50 mL/100 g/min"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A decrease in the cerebral blood flow <strong>below 20 mL/100 g/min </strong>causes<strong>&nbsp;reversible ischemia</strong>.</p>\n<p>If this state is prolonged for several hours to days, it can lead to infarction. A decrease in CBF to 0 causes the death of the brain tissue within 4&ndash;10 min.</p>\n<p><strong>Normal </strong>cerebral blood flow (CBF) in an adult brain at rest is <strong>50&ndash;55 mL/100 g/min.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented with acute onset of weakness of the left arm which resolved completely in 10 days. He is known to have mitral stenosis, hypertension and dyslipidemia.  What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Transient ischemic attack"
      },
      {
        "id": 2,
        "text": "Embolic  stroke"
      },
      {
        "id": 3,
        "text": "Hemorrhagic stroke"
      },
      {
        "id": 4,
        "text": "Thrombotic stroke"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This patient with mitral stenosis and acute onset weakness of the left arm is most likely to have had an <strong>embolic&nbsp;stroke</strong>, which is a type of ischemic stroke.&nbsp;Embolic strokes tend to occur suddenly with maximum neurologic deficit present at onset.</p>\n<p><strong>Mitral stenosis</strong> is known to cause <strong>atrial fibrillation</strong> and is a common cause of cardioembolic stroke.</p>\n<p>Transient ischemic attack&nbsp;<strong>(TIA)</strong>&nbsp;is a <strong>temporary</strong>, <strong>focal</strong> neurological deficit of sudden onset (stroke-like symptoms) lasting for <strong>less than 24 hours. </strong>This occurs due to<strong>&nbsp;</strong>focal ischemia of the brain, retina or cochlea. Most TIAs last for less than 1 hour to a few minutes.</p>\n<p>There is a high <strong>risk</strong> of developing an <strong>ischemic stroke&nbsp;after a TIA</strong>, especially for the first 3 months following a TIA.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presented with right-sided hemiparesis that completely resolved in 4-6 hours. What score will you use to determine the risk of a future stroke in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "CHADS2-VASc"
      },
      {
        "id": 2,
        "text": "CURB-65"
      },
      {
        "id": 3,
        "text": "ABCD2"
      },
      {
        "id": 4,
        "text": "APACHE II"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>This patient's clinical features are suggestive of a <strong>transient ischemic attack</strong>. The <strong>risk</strong> of <strong>stroke</strong> <strong>following TIAs</strong> is determined by the&nbsp;<strong>ABCD<span style=\"font-size: 11.6667px;\">2</span>&nbsp;score</strong>. &nbsp;</p>\n<p><strong>CHADS2-VASc</strong> score is used to determine the risk of stroke in a patient with <strong>atrial fibrillation</strong>.</p>\n<p><strong>CURB-65</strong> is a scoring system used to predict <strong>mortality</strong> in patients with <strong>community-acquired pneumonia</strong>.</p>\n<p><strong>APACHE II</strong> is a scoring system used to predict<strong> ICU mortality</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 67-year-old patient with hypertension, diabetes, and asthma is found to have an irregularly irregular pulse during a routine physical examination. ECG findings are shown below. How is the risk of stroke determined in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "CHA2DS2-VASC"
      },
      {
        "id": 2,
        "text": "NIH Stroke Score"
      },
      {
        "id": 3,
        "text": "ABCD2"
      },
      {
        "id": 4,
        "text": "Modified GCS"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given scenario along with the ECG findings are suggestive of <strong>atrial fibrillation</strong>. The risk of stroke in this condition is determined by <strong>CHA<sub>2</sub>DS<sub>2</sub>-VASC&nbsp;score</strong>.&nbsp; &nbsp;</p>\n<p>The ECG show irregular QRS complexes of normal morphology and absent P waves.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/2f4640dee0ed46a08a4f3b808b55a1c7.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 73-year-old woman who was brought to the ER with hemiparesis was found to have a lacunar infarction. What causes this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Emboli in small vessels"
      },
      {
        "id": 2,
        "text": "Thrombosis in large vessels"
      },
      {
        "id": 3,
        "text": "Lipohyalinosis of penetrating arteries"
      },
      {
        "id": 4,
        "text": "Hemorrhagic stroke"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Lacunar infarcts,</strong> also called <strong>small vessel stroke,</strong> refer to infarction following <strong>atherothrombotic </strong>or<strong> lipohyalinotic occlusion</strong> of small penetrating arteries in the brain. These penetrating arteries arise&nbsp;from the stem of the middle cerebral artery, circle of Willis, and basilar and vertebral arteries.</p>\n<p>The principal risk factors are <strong>hypertension</strong> and <strong>old</strong>&nbsp;<strong>age</strong>.</p>\n<p>The image below shows two lacunar infarctions on a CT.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/95785abcfd0640b980cba1bd6173502cx446x539.JPEG"
    ]
  },
  {
    "text": "Which of the following is not caused by a lacunar stroke?",
    "choices": [
      {
        "id": 1,
        "text": "Pure motor hemiparesis"
      },
      {
        "id": 2,
        "text": "Pure sensory stroke"
      },
      {
        "id": 3,
        "text": "Ataxic hemiparesis"
      },
      {
        "id": 4,
        "text": "Crural monoplegia with urinary incontinence"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The ACA is divided into two segments:</p>\n<ul>\n<li>The pre-communal (A1) circle of Willis, or stem, which connects the internal carotid artery to the anterior communicating artery</li>\n<li>The post-communal (A2) segment distal to the anterior communicating artery</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b126036efc8344fda3964b90cc21af3ex1280x1284.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a242be93074f44e487601de68714f028x1280x1564.JPEG"
    ]
  },
  {
    "text": "A patient is diagnosed with an ischaemic stroke. His son says that he holds the comb incorrectly while combing his hair. During the evaluation, he was unable to button his shirt when requested. The lesion is most likely to be in which lobe?",
    "choices": [
      {
        "id": 1,
        "text": "Dominant frontal lobe"
      },
      {
        "id": 2,
        "text": "Dominant parietal lobe"
      },
      {
        "id": 3,
        "text": "Non-dominant frontal lobe"
      },
      {
        "id": 4,
        "text": "Non-dominant parietal lobe"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given scenario where the patient is unable to perform learned skilled movements\u00a0is suggestive of <strong>apraxia</strong>. The lesion is likely to be in the <strong>dominant</strong>\u00a0<strong>parietal lobe</strong> as apraxia is a feature of a lesion in this area.</p>\n<p>The features of <strong>dominant parietal lobe lesions</strong> are as follows:</p>\n<ul>\n<li>Apraxia - inability to perform learned skilled movements</li>\n<li>Acalculia -\u00a0difficulty performing simple mathematical tasks</li>\n<li>Alexia -\u00a0inability to recognize or read written words or letters</li>\n<li>Agnosia - inability\u00a0to recognize and identify objects, persons, or sounds</li>\n<li>Dysphasia -\u00a0language disorder marked by deficiency in the generation of speech and its comprehension</li>\n<li>Contralateral inferior homonymous quadrantanopia</li>\n<li>Gerstmann syndrome (acalculia, dysgraphia, finger agnosia, right-left confusion)</li>\n</ul>\n<p>Features of <strong>non-dominant parietal lobe lesions</strong> include:</p>\n<ul>\n<li>Spatial disorientation</li>\n<li>Constructional apraxia</li>\n<li>Contralateral inferior homonymous quadrantanopia</li>\n<li>Contralateral hemineglect.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following features is not likely to be seen in a patient with a temporal lobe lesion?",
    "choices": [
      {
        "id": 1,
        "text": "Neglect"
      },
      {
        "id": 2,
        "text": "Superior quadrantanopia"
      },
      {
        "id": 3,
        "text": "Auditory hallucinations"
      },
      {
        "id": 4,
        "text": "Poor memory"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Neglect</strong> is not a feature of temporal lobe lesion. It&nbsp;is a feature of a <strong>non-dominant</strong>&nbsp;<strong>parietal lobe</strong> lesion.</p>\n<p>Features of <strong>dominant temporal lobe lesions</strong>:</p>\n<ul>\n<li>Complex hallucinations - visual, auditory or olfactory</li>\n<li>Memory impairment</li>\n<li>Complex partial seizures</li>\n<li>Wernicke&rsquo;s aphasia</li>\n<li>Contralateral superior quadrantanopia</li>\n</ul>\n<p>Features of <strong>non-dominant temporal lobe lesions</strong>:</p>\n<ul>\n<li>Poor non-verbal memory</li>\n<li>Loss of musical skills</li>\n<li>Complex hallucinations</li>\n<li>Contralateral superior quadrantanopia.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 43-year-old man is brought to the hospital due to extremely aggressive behaviour towards his family. His family members also say that he has become forgetful and has developed urinary incontinence. Which of the following lobes is likely to be involved in his disease process?",
    "choices": [
      {
        "id": 1,
        "text": "Frontal lobe"
      },
      {
        "id": 2,
        "text": "Dominant parietal lobe"
      },
      {
        "id": 3,
        "text": "Temporal lobe"
      },
      {
        "id": 4,
        "text": "Non-dominant parietal lobe"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Antisocial behavior, urinary incontinence, and impaired memory in this patient are suggestive of <strong>frontal lobe involvement.</strong></p>\n<p>Features of frontal lobe lesions:</p>\n<ul>\n<li>Disinhibition</li>\n<li>Lack of initiative</li>\n<li>Antisocial behavior</li>\n<li>Impaired memory</li>\n<li>Incontinence</li>\n<li>Grasp reflexes</li>\n<li>Anosmia.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In the sagittal section of the brain given below if the coloured area is affected, which of the following is not seen?",
    "choices": [
      {
        "id": 1,
        "text": "Urinary incontinence"
      },
      {
        "id": 2,
        "text": "Gait abnormality"
      },
      {
        "id": 3,
        "text": "Perianal anesthesia"
      },
      {
        "id": 4,
        "text": "Fecal incontinence"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Paracentral lobule (PCL)</strong> is the continuation of the <strong>precentral</strong> and <strong>postcentral</strong> <strong>gyri</strong> of the superolateral surface into the medial surface of cerebral hemisphere. It controls the motor and sensory innervations of the contralateral lower extremity. It is also responsible for cortical control of micturition and defecation.</p>\n<p>The anterior two-thirds of PCL belong to <strong>Brodmann area 4,</strong> it reflects the primary motor cortex for the muscles of contralateral leg, foot, and perineum,it is functionally important in control of bladder and anal sphincters. Therefore, it's called the cortical center of defecation and micturition.</p>\n<p>The posterior third of the PCL contains 3,2 and 1, it reflects the primary somatosensory representation of the leg and foot.</p>\n<p>The <strong>A2 segment</strong> of the <strong>anterior cerebral artery</strong> supplies the <strong>paracentral lobule. </strong>Lesions in the paracentral lobule lead to:</p>\n<ul>\n<li>Weakness and loss of sensation in contralateral lower limb</li>\n<li>Urinary incontinence</li>\n<li>Fecal incontinence.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/db04684e345449d1b3e3bcaf0e79f7df.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which type of aphasia is seen in the lesions of the posterior part of the superior temporal gyrus?",
    "choices": [
      {
        "id": 1,
        "text": "Fluent"
      },
      {
        "id": 2,
        "text": "Non fluent"
      },
      {
        "id": 3,
        "text": "Anomic"
      },
      {
        "id": 4,
        "text": "Conduction"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Lesions of the <strong>posterior part </strong>of the <strong>superior temporal gyrus </strong>cause <strong>Wernicke&rsquo;s </strong>or <strong>Fluent aphasia</strong> due to the involvement of the Wernicke's area. The speech is full of <strong>jargon</strong> and <strong>neologisms</strong> that make little sense <strong>(area no 22).&nbsp;</strong></p>\n<p><strong>Broca's</strong> (Option B) or <strong>motor/non-fluent aphasia</strong> is seen in lesions of the inferior frontal gyrus which contains the motor speech area. Speech is non-fluent and interrupted, with a paucity of functional words.</p>\n<p>Comprehension of written language and the ability to name objects are compromised in <strong>anomic aphasia</strong> (Option C). This aphasia is caused by damage to the angular gyrus that disrupts visual information processing and transmission to the Wernicke area.</p>\n<p><strong>Conduction aphasia </strong>(Option D) is seen in lesions of the arcuate fasciculus, the bundle of nerve fibers connecting the Wernicke and Broca's areas. Repetition of words is impaired and paraphasias are observed, though not as much as in Wernicke aphasia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 60-year-old patient with atrial fibrillation complains of sudden onset weakness of the right lower limb, with urinary and faecal incontinence. MRI shows an ischaemic stroke involving the left anterior cerebral artery. Which of the following features would you not expect to see in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Ataxia"
      },
      {
        "id": 2,
        "text": "Prosopagnosia"
      },
      {
        "id": 3,
        "text": "Abulia"
      },
      {
        "id": 4,
        "text": "Paratonic rigidity"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Prosopagnosia</strong>, also called <strong>face blindness</strong>, is the inability to recognize faces including one's own image. This occurs due to occipitotemporal lobe damage, seen in <strong>posterior cerebral artery (PCA) </strong>strokes involving cortical branch occlusion. <br />It is not seen in anterior cerebral artery strokes.\u00a0</p>\n<p>The anterior cerebral artery (ACA) supplies parts of the frontal lobe, corpus callosum, paracentral lobule, and other deeper structures.</p>\n<p>Signs and symptoms of <strong>ACA occlusion</strong> and structures involved:</p>\n<ul>\n<li><strong>Urinary incontinence, fecal incontinence</strong></li>\n<li>Paratonic rigidity</li>\n<li>Abulia (Akinetic mutism), lack of spontaneity, slowness</li>\n<li>Gait impairment</li>\n<li><strong>Paralysis of contralateral foot and leg</strong></li>\n<li>Paresis of the contralateral arm</li>\n<li>Cortical sensory loss over the contralateral lower limb</li>\n<li>Dyspraxia of left limbs, tactile aphasia in left limbs.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Infarction of area of distribution of which of the following arteries is most likely to be seen in a patient with hemiplegia?",
    "choices": [
      {
        "id": 1,
        "text": "Vertebral artery"
      },
      {
        "id": 2,
        "text": "Middle cerebral artery"
      },
      {
        "id": 3,
        "text": "Anterior spinal artery"
      },
      {
        "id": 4,
        "text": "Posterior cerebral artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hemiplegia</strong> is most commonly associated with infarction of the area of distribution of <strong>middle cerebral artery</strong>.</p>\n<p>Middle cerebral artery supplies the <strong>motor cortex</strong> responsible for sending the output to the motor neurons. Infarction in this territory leads to hemiplegia.</p>\n<p>Infarction of area of distribution of vertebral, anterior spinal and posterior cerebral arteries can also lead to hemiplegia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b63f43cf3df54aef8cfda110e6eed161x1024x999.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a5a9740ac933421b956062949550cfefx1024x999.JPEG"
    ]
  },
  {
    "text": "Which of the following features is not expected to be seen in a patient with a right middle cerebral artery infarct?",
    "choices": [
      {
        "id": 1,
        "text": "Aphasia"
      },
      {
        "id": 2,
        "text": "Hemiparesis"
      },
      {
        "id": 3,
        "text": "Facial weakness"
      },
      {
        "id": 4,
        "text": "Dysarthria"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Aphasia is not a feature of right middle cerebral artery infarct (MCA).</p>\n<p><strong>Aphasia</strong> occurs when there is damage to the <strong>dominant hemisphere</strong>, i.e., <strong>left hemisphere</strong>. The dominant hemisphere contains the <strong>language network</strong> which includes Broca&rsquo;s area, Wernicke&rsquo;s area, their interconnections and connections with frontal, parietal and temporal areas.</p>\n<p>The MCA originates from the internal carotid artery. The stem of the MCA is referred to as the <strong>M1</strong> segment. It gives rise to cortical and penetrating/lenticulostriate branches.</p>\n<p><strong>MCA stem occlusion</strong> leads to :</p>\n<ul>\n<li>Contralateral hemiplegia</li>\n<li>Hemianesthesia</li>\n<li>Homonymous hemianopia</li>\n<li>Global aphasia (dominant hemisphere)</li>\n<li>Anosognosia, constructional apraxia, neglect (non-dominant hemisphere)</li>\n</ul>\n<p>Occlusion of the <strong>lenticulostriate</strong> branches of MCA (<strong>lacunar stroke</strong>) may affect the <strong>genu</strong> of the internal capsule. This can lead to <strong>dysarthria </strong>with <strong>contralateral&nbsp;clumsy hand</strong> (fine motor weakness).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Visual field examination of a 52-year-old stroke patient reveals the finding shown in the image. During examination, you notice that he is not able to comprehend your instructions and sometimes gives irrelevant replies. What is the likely site of arterial occlusion?",
    "choices": [
      {
        "id": 1,
        "text": "Left MCA stem"
      },
      {
        "id": 2,
        "text": "Right M1 segment of MCA"
      },
      {
        "id": 3,
        "text": "Left M2 segment of MCA \u2013 inferior division"
      },
      {
        "id": 4,
        "text": "Right M2 segment of MCA \u2013 superior division"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given scenario is suggestive of <strong>homonymous right superior quadrantanopia&nbsp;</strong>(pie in the sky appearance)&nbsp;and <strong>sensory aphasia</strong>. These are seen in occlusion of the <strong>inferior</strong> division of the <strong>opposite</strong> side middle cerebral artery (<strong>MCA</strong>).</p>\n<p>Parts of the middle cerebral artery:</p>\n<ul>\n<li>The MCA originates from the internal carotid artery. The stem of the MCA is referred to as the <strong>M1</strong> segment.</li>\n<li>In the Sylvian fissure, the MCA divides into <strong>superior and inferior divisions</strong>. These branches are referred to as the <strong>M2 segments</strong> of the MCA.</li>\n</ul>\n<p>Occlusion of the following sites and their effects are given below:</p>\n<ul>\n<li><strong>MCA stem (M1)&nbsp;</strong>- leads to contralateral <strong>hemiplegia,</strong> hemianesthesia and homonymous hemianopia amongst other features</li>\n<li><strong>Superior </strong>division of <strong>MCA (M2)&nbsp;</strong>on the<strong> dominant </strong>side&nbsp;- leads to motor aphasia <strong>(Broca's)</strong> and facio-brachial weakness</li>\n<li><strong>Inferior </strong>division of <strong>MCA (M2)</strong> on the <strong>dominant </strong>side&nbsp;- leads to sensory aphasia <strong>(Wernicke's)</strong> and contralateral superior quadrantanopia</li>\n</ul>\n<p>The following image of coronal section of cerebral hemisphere shows the segments of MCA:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/dbb8e1346c494dc4bd451fb94e494330.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cc07443b750e427d88b54f64f1128e4bx1280x1649.JPEG"
    ]
  },
  {
    "text": "A patient is found to have Wernicke\u2019s aphasia without motor involvement. Where is the infarct likely to be?",
    "choices": [
      {
        "id": 1,
        "text": "ACA territory of the right hemisphere"
      },
      {
        "id": 2,
        "text": "ACA territory of the left hemisphere"
      },
      {
        "id": 3,
        "text": "MCA territory of the right hemisphere"
      },
      {
        "id": 4,
        "text": "MCA territory of the left hemisphere"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The presence of Wernicke&rsquo;s aphasia without motor involvement suggests an infarct in the <strong>MCA territory of the left (dominant) hemisphere</strong>.</p>\n<p><strong>Wernicke&rsquo;s area</strong> is located in the <strong>superior temporal gyrus</strong> in the <strong>dominant</strong> hemisphere&nbsp;(mostly the <strong>left</strong> side). This area is supplied by the <strong>inferior division</strong> of <strong>MCA.&nbsp;</strong></p>\n<p><strong>MCA</strong> divides into <strong>superior</strong> and <strong>inferior</strong> divisions in the Sylvian fissure. These branches are referred to as the <strong>M2</strong> segments of MCA.</p>\n<ul>\n<li>The superior division - supplies the frontal and the superior parietal cortex.</li>\n<li>The inferior division - supplies the inferior parietal and temporal cortex.</li>\n</ul>\n<p>An infarct in the territory of the <strong>inferior division</strong> of <strong>MCA</strong> in the <strong>dominant </strong>hemisphere causes <strong>Wernicke&rsquo;s aphasia without weakness</strong>.&nbsp;As the frontal cortex (containing the motor area) is supplied by the superior division and is not affected, weakness is not observed.</p>\n<p>An infarct in the <strong>inferior division</strong> of <strong>MCA</strong> of the <strong>non-dominant </strong>hemisphere (mostly the right side) causes <strong>hemineglect without weakness</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not a feature of an anterior choroidal artery lesion?",
    "choices": [
      {
        "id": 1,
        "text": "Aphasia"
      },
      {
        "id": 2,
        "text": "Contralateral hemiplegia"
      },
      {
        "id": 3,
        "text": "Hemianesthesia"
      },
      {
        "id": 4,
        "text": "Homonymous hemianopia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Aphasia</strong> (dominant hemisphere), <strong>constructional apraxia</strong> and <strong>neglect</strong> (non-dominant hemisphere) are seen in <strong>MCA stem occlusion</strong>. These features are absent in anterior choroidal artery occlusion.</p>\n<p>Features common to both <strong>MCA</strong> and <strong>anterior choroidal artery occlusion</strong> include:</p>\n<ul>\n<li>Contralateral hemiplegia</li>\n<li>Hemianaesthesia</li>\n<li>Homonymous hemianopia.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A man is rushed to the ER after losing control of his car and crashing into a tree. Examination findings are given below. What is the most likely cause for his presentation?",
    "choices": [
      {
        "id": 1,
        "text": "Spinal cord trauma"
      },
      {
        "id": 2,
        "text": "Morphine poisoning"
      },
      {
        "id": 3,
        "text": "Pontine hemorrhage"
      },
      {
        "id": 4,
        "text": "Ponto-medullary laceration"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given scenario is suggestive of&nbsp;<strong>pontine haemorrhage</strong>. Clinical features of pontine haemorrhage are:</p>\n<ul>\n<li>Deep coma</li>\n<li><strong>Quadriparesis</strong> and multiple cranial nerve dysfunction</li>\n<li>Decerebrate rigidity</li>\n<li><strong>Pin-point pupils</strong></li>\n<li>Hyperpnea, <strong>hyperpyrexia, severe hypertension</strong>, and hyperhidrosis</li>\n</ul>\n<p>Option A: The presence of hyperpyrexia and pin-point pupils rule out the possibility of spinal cord trauma.</p>\n<p>Option B: Morphine poisoning is a differential diagnosis for pin-point pupils. But it leads to slower respiratory rate, not tachypnea.</p>\n<p>Option D: In ponto-medullary laceration, medullary involvement would cause respiratory depression, leading to apnea. But here tachypnea is noted.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient presents with left-sided facial paralysis and left-sided limb weakness for the past 1 hour. Her blood pressure is 160/100 mm Hg and her CT appears normal. What would be the next step of management?",
    "choices": [
      {
        "id": 1,
        "text": "Nothing, since CT was normal"
      },
      {
        "id": 2,
        "text": "Start on aspirin + clopidogrel"
      },
      {
        "id": 3,
        "text": "Intravenous thrombolysis"
      },
      {
        "id": 4,
        "text": "Advice BP control"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sudden onset hemiparesis</strong> with apparently normal CT indicates<strong> ischemic stroke</strong> in this patient.<strong> Intravenous thrombolysis</strong>(alteplase 0.9 mg/kg ) should be immediately administered to patients with ischemic stroke who arrive in the window period i.e., within 3-4.5 hours of symptom onset.</p>\n<p><strong>Aspirin + clopidogrel</strong>(Option B) is used in secondary prevention of stroke and also to prevent stroke following TIA.</p>\n<p><strong> Transient ischemic attacks</strong> (TIAs) refer to episodes of stroke symptoms that have a brief duration, the standard definition of duration is &lt;24 h, but most TIAs <strong>last &lt;1 hr</strong>. TIAs may arise from <strong>emboli</strong> to the brain or from in situ <strong>thrombosis</strong> of an intracranial vessel. With a TIA, the occluded blood vessel reopens and neurologic function is restored. If a relevant brain infarction is identified on brain imaging, the clinical entity is now classified as <strong>stroke</strong> regardless of the duration of symptoms.</p>\n<p>The risk of stroke following a transient ischemic attack (TIA) is approximately 10-15% in the first three months, majorly in the first two days. A reliable estimation of this risk can be obtained using the <strong>ABCD2 score</strong>.&nbsp;<br /><br />Other options:&nbsp;</p>\n<p>Option A: If CT is normal it only rules out <strong>hemorrhagic stroke</strong> and changes of ischemic stroke usually take time to appear on NCCT.</p>\n<p>Option D: BP control is done when <strong>BP exceeds 220/120 mmHg</strong>, if there is malignant hypertension or concomitant myocardial ischemia, or if blood pressure is &gt;185/110 mmHg and thrombolytic therapy is anticipated.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Thrombolysis is contraindicated in which of the following patients with ischaemic stroke?",
    "choices": [
      {
        "id": 1,
        "text": "Patients 1, 2 and 4"
      },
      {
        "id": 2,
        "text": "Patient 2 only"
      },
      {
        "id": 3,
        "text": "Patients 3 and 5"
      },
      {
        "id": 4,
        "text": "Patient 3 and 4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A sustained blood pressure <strong>&gt; 185/110 mmHg</strong> and <strong>recent myocardial infarction</strong>&nbsp;are <strong>contraindications</strong> for initiating thrombolysis in ischemic stroke.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with acute ischemic stroke requires IV thrombolysis. His symptoms had begun at 6:30 PM and he was brought to the hospital by 7:00 PM. For this treatment to be beneficial for the patient, it should be administered within what time?",
    "choices": [
      {
        "id": 1,
        "text": "7:30 PM"
      },
      {
        "id": 2,
        "text": "9:00 PM"
      },
      {
        "id": 3,
        "text": "10:30 PM"
      },
      {
        "id": 4,
        "text": "11:00 PM"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>IV thrombolysis</strong> in acute ischemic stroke has been proven to be beneficial up to&nbsp;<strong>4.5 hours</strong> after the <strong>onset of symptoms</strong> according to&nbsp;European Cooperative Acute Stroke Study (ECASS) III.</p>\n<p>According to MoHFW (India), thrombolysis is to be carried out within 4.5 hours of symptom onset.</p>\n<p>IV tPA should be administered to all eligible acute stroke patients within 3 hours of last known normal and to a more selective group of eligible acute stroke patients (based on ECASS III exclusion criteria) within 4.5 hours of last known normal.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following features of stroke need not be treated?",
    "choices": [
      {
        "id": 1,
        "text": "Dysphagia"
      },
      {
        "id": 2,
        "text": "Spasticity"
      },
      {
        "id": 3,
        "text": "Fever"
      },
      {
        "id": 4,
        "text": "Neglect"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Neglect</strong> is a feature of stroke that <strong>need not be treated</strong>. Although neglect indicates a poor prognosis, most patients recover without any treatment in 1-6 months.</p>\n<p><strong>Dysphagia</strong>(Option A) poses a high risk of <strong>aspiration</strong> and hence can't be left untreated. <strong>Spasticity</strong>(Option B) can be treated with baclofen, tizanidine. Untreated, it creates a <strong>psychosocial impact</strong> on the patient. <strong>Fever</strong>(Option C) is deleterious in stroke patients and must be treated.</p>\n<p><strong>Neglect</strong>&nbsp;can arise from injury to <strong>cortical-limbic-reticular network</strong>, that directs attention and integrates the localization and identification of a stimulus. Neglect is&nbsp; associated with poor&nbsp;scores and slower recovery, but severe neglect is rare beyond 6 months.&nbsp;<strong>Recovery</strong> is <strong>rapid</strong> in the first 2 weeks, regardless of the side of stroke. By 3 months, patients might have some residual visual neglect.&nbsp;The choice of an intervention depends on the mechanism of neglect, the patient can be treated for an underaroused right hemisphere which has difficulty processing sensory inputs.&nbsp;</p>\n<p><strong>Neurogenic dysphagia</strong> is an important cause of <strong>pulmonary infection</strong> in any patient with stroke, motor neuron disease, even transient dysphagia can lead to malnutrition, dehydration, aspiration pneumonia, and airway obstruction with asphyxia, it increases the risk of death and institutionalization.&nbsp;Early placement of&nbsp; nasogastric tube to feed patients after stroke has improved nutrition and reduced deaths.</p>\n<p><strong>Spasticity&nbsp;</strong>is seen in less than 20% of stroke patients. Patients with bilateral weakness from hypoxic injury are likely to have signs of spasticity.&nbsp;Exaggerated cutaneous and autonomic reflexes and involuntary spasms are disabling problems associated with spasticity. Physical modalities like slow stretching movements and daily passive exercises will reduce symptoms of spasticity and risk of contractures. Baclofen, tizanidine, and clonidine are used in reducing clonus and extensor spasms.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A woman on oral contraceptive pills presents with a headache for 2 days and paraparesis. What could be the most likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior reversible encephalopathy syndrome"
      },
      {
        "id": 2,
        "text": "Cerebral venous thrombosis"
      },
      {
        "id": 3,
        "text": "Complicated migraine"
      },
      {
        "id": 4,
        "text": "Subarachnoid hemorrhage"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The presence of <strong>headache</strong> and <strong>paraparesis</strong> in this patient with a history of <strong>oral contraceptive use</strong> is suggestive of <strong>cerebral venous thrombosis</strong>.</p>\n<p>Cerebral venous thrombosis is commonly seen in <strong>hypercoagulable states</strong> such as:</p>\n<ul>\n<li>Oral contraceptive pill use</li>\n<li>Pregnancy and puerperium</li>\n<li>Inflammatory bowel disease</li>\n<li>Dehydration</li>\n<li>Intracranial infections.</li>\n</ul>\n<p>It presents with:</p>\n<ul>\n<li><strong>Headache</strong>&nbsp;(most common)</li>\n<li>Seizures</li>\n<li>Intracranial Hypertension</li>\n<li>Focal neurological Deficits</li>\n<li>Altered Mental status</li>\n</ul>\n<p><strong>MR venography&nbsp;</strong>is used for diagnosis.</p>\n<p>The below image shows the <strong>empty delta sign</strong> seen on CECT or MRI with contrast in patients with <strong>sagittal sinus thrombosis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f4365e3dc86d42f1b7955a90873634cex743x900.JPEG"
    ]
  },
  {
    "text": "What is the treatment of choice for a patient diagnosed with sagittal sinus thrombosis?",
    "choices": [
      {
        "id": 1,
        "text": "Aspirin"
      },
      {
        "id": 2,
        "text": "Heparin"
      },
      {
        "id": 3,
        "text": "Warfarin"
      },
      {
        "id": 4,
        "text": "rtPA"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>IV heparin</strong> is the <strong>drug of choice</strong> in <strong>cerebral venous thrombosis</strong>. It prevents further thrombosis and reduces venous hypertension and ischemia.&nbsp;</p>\n<p><strong>Anticoagulation</strong> is often <strong>continued</strong> indefinitely if <strong>thrombophilia</strong> is diagnosed.</p>\n<p>If there is no underlying hypercoagulable state, treatment with vitamin K antagonists (VKAs) for 3&ndash;6 months may be initiated and then converted to aspirin, depending on the degree of resolution of the venous sinus thrombus.&nbsp;</p>\n<p>Treatment of CVT:</p>\n<ul>\n<li>Acute treatment - IV Heparin or LMWH</li>\n<li>Maintenance therapy:\n<ul>\n<li>Warfarin for at least 3 months</li>\n<li>In pregnant women with a history of CVT - anticoagulation with LMWH throughout pregnancy and till 8 weeks postpartum.</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old patient presents with headache and weakness of the right side of the body. He has difficulty in speaking also. Angiography shows a puff of smoke appearance. Which of the following statements regarding this disease is false?",
    "choices": [
      {
        "id": 1,
        "text": "It is an occlusive disease involving large intracranial arteries"
      },
      {
        "id": 2,
        "text": "Vascular inflammation is absent"
      },
      {
        "id": 3,
        "text": "Dawson\u2019s fingers are the characteristic imaging finding"
      },
      {
        "id": 4,
        "text": "Rich collateral circulation is present"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Note: As this is a chronic condition, the lenticulostriate arteries develop a rich collateral circulation around the occlusive lesion. This is seen as a '<strong>puff of smoke'</strong>&nbsp;(moyamoya in Japanese) on <strong>X-ray angiography</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e5e0a94a4dd44e1c97e0fcc91bb61c7ex1279x1211.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c4c082b8ead4cab8f5bb3df228a844dx392x485.JPEG"
    ]
  },
  {
    "text": "Which among the following is not a component of CHA2DS2-VASc score?",
    "choices": [
      {
        "id": 1,
        "text": "Age > 60 years"
      },
      {
        "id": 2,
        "text": "Hypertension"
      },
      {
        "id": 3,
        "text": "Diabetes"
      },
      {
        "id": 4,
        "text": "Transient ischemic attack"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Age &gt; 60 years is not a component of the CHADS2-VASc score.\u00a0Age &gt; 75years and age group 65-75 yrs are the two age criteria considered in the score.</p>\n<p>The <strong>CHA2DS2-VASc score</strong> is used to assess the <strong>risk of stroke</strong> in patients who have atrial fibrillation. Anticoagulation therapy is given when the score is\u00a0\u22652. Patients with a score of 1 may also be considered for anticoagulation therapy.</p>\n<p>Anticoagulation therapy is given for all the patients of AF having mitral stenosis, hypertrophic cardiomyopathy, or a history of stroke.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '074 Ischemic Stroke';
        const quizFilename = '074-ischemic-stroke-3e7e9cd0.html';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>