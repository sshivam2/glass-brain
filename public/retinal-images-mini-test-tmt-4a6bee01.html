<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retinal Images Mini Test - -Tmt - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2023-24
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "A patient with a history of decreased vision was evaluated with fundus fluorescein angiography. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Sickle-cell retinopathy"
      },
      {
        "id": 2,
        "text": "Hypertensive retinopathy"
      },
      {
        "id": 3,
        "text": "Bird shot choroidopathy"
      },
      {
        "id": 4,
        "text": "Diabetic retinopathy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given image depicts <strong>neovascularization</strong>, which is the\u00a0hallmark of <strong>p</strong><strong>roliferative diabetic retinopathy.</strong></p>\n<p>Dye can be seen leaking through abnormal neovascular fronds. Both\u00a0neovascularization of the disc (NVD), as well as neovascularization elsewhere (NVE i.e., 2 DD away from the optic disc margin),\u00a0are seen.</p>\n<p>The treatment available for proliferative diabetic retinopathy is <strong>photocoagulation of the ischaemic areas</strong> to reduce the metabolic demand and decrease or prevent the release of vasoproliferative factors.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/bffad181166f45bab7a2fbb58eb0e408.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 58-year-old man after his retirement party came with the complaint of sudden painless loss of vision in his left eye for the past 2 hours. The fundoscopic examination picture shows a Hollenhorst plaque as in the image given below.  What is the composition of this plaque?",
    "choices": [
      {
        "id": 1,
        "text": "Cholesterol"
      },
      {
        "id": 2,
        "text": "Fibrin-platelet aggregate"
      },
      {
        "id": 3,
        "text": "Amyloid"
      },
      {
        "id": 4,
        "text": "Calcific particles"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A <strong>Hollenhorst plaque</strong> is composed of <strong>cholesterol</strong>. The clinical scenario of <strong>sudden painless loss of vision</strong> with the presence of a <strong>Hollenhorst plaque</strong> is suggestive of <strong>central retinal artery occlusion</strong> <strong>(CRAO)</strong>.</p>\n<p>On fundus examination, it gives an appearance of a refractile <strong>yellow-white color</strong> substance in the retinal vessels.</p>\n<p>Retinal artery occlusion can occur due to emboli from the carotids, atherosclerosis-related thrombosis, retinal arteritis, raised intraocular pressure, etc. Emboli are the most common cause. They may be:</p>\n<ul>\n<li><strong>Cholestrol emboli</strong> or <strong>Hollenhorst plaque</strong>- at retinal vessel bifurcation, from carotid artery atheromas</li>\n<li>Calcium emboli from cardiac valves</li>\n<li>Platelet fibrin emboli from carotid atheromas</li>\n</ul>\n<p>Patients present with sudden painless loss of vision and may have a past history of transient visual loss (amaurosis fugax). On examination, visual acuity is diminished, and the pupillary reflex is lost. On funduscopy, the following findings are seen:</p>\n<ul>\n<li>Narrowed retinal arteries and veins</li>\n<li>Milky white appearance of the retina due to edema</li>\n<li><strong>Cherry red spot </strong>at\u00a0the center of the macula</li>\n<li>Cattle trucking or segmentation of blood column in the retinal veins</li>\n</ul>\n<p>CRAO is treated with immediate lowering of intraocular pressure, intermittent ocular massage, iv mannitol, and iv acetazolamide. Vasodilators like nitroglycerine and oral isosorbide dinitrate are helpful. Steroids for arteritis, fibrinolytic therapy, and laser photodiruption of the embolus may be done.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/bb485e982fad40bb89bfb58f9b9d7a37.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 65-year-old  female patient presented with progressive painless loss of vision. A fundus picture of the patient is given below. What could be the probable finding?",
    "choices": [
      {
        "id": 1,
        "text": "Cotton wool spots"
      },
      {
        "id": 2,
        "text": "Hard exudates"
      },
      {
        "id": 3,
        "text": "Roth spots"
      },
      {
        "id": 4,
        "text": "Cherry red spots"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above fundal image shows small, discrete yellowish, waxy areas with crenated margins that are suggestive of <strong>hard exudates,&nbsp;</strong>seen in <strong>diabetic retinopathy</strong>.</p>\n<p><strong>Hard exudates</strong>&nbsp;are leaked&nbsp;<strong>lipoproteins</strong>&nbsp;and lipid-filled macrophages that form due to chronic localized edema.&nbsp;They are commonly seen in the macular area and occur in the&nbsp;outer plexiform layer of the retina<strong>.&nbsp;</strong></p>\n<p>Other common causes of hard exudates include&nbsp;hypertensive retinopathy, Coats&rsquo; disease, and circinate retinopathy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fbc245793c64420ab759ed68e60a8d9a.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/46e1eb03df464d8e9f178858a1e4101bx512x399.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b720aa7740064fdab026787bb0ce5157x720x583.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c2a0bc67a9084a18b37e00227a94f505x720x538.JPEG"
    ]
  },
  {
    "text": "A 28-year-old man presented with worsening night blindness for the last few years. On further questioning, he reveals that he has been having increasing difficulty doing daily activities like reading and walking without bumping into objects. His fundoscopy findings are shown below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Retinitis pigmentosa"
      },
      {
        "id": 2,
        "text": "Vitamin A deficiency"
      },
      {
        "id": 3,
        "text": "Retinal detachment"
      },
      {
        "id": 4,
        "text": "Acquired syphilis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This patient with a clinical picture of <strong>worsening night blindness</strong>, <strong>difficulty</strong> in <strong>walking</strong> and reading, with fundoscopic features (<strong>bone spicule </strong>changes, retinal atrophy, and a peripheral ring of <strong>depigmentation</strong>) is likely to have <strong>retinitis pigmentosa</strong>.</p>\n<p>Retinitis pigmentosa is&nbsp;<strong>retinal dystrophy</strong> that results in <strong>retinal rod </strong>and<strong> cone degeneration</strong>. It can be <strong>inherited</strong> (autosomal dominant, autosomal recessive, or X-linked recessive) or <strong>acquired</strong> due to sporadic mutation in the rhodopsin gene.&nbsp;</p>\n<p>Patients present with <strong>worsening night blindness</strong>. However, patients do not often notice night blindness and may present after much disease progression. They also develop <strong>tunnel vision,&nbsp;</strong>which manifests as difficulty performing activities of daily living such as reading, walking, and driving.&nbsp;</p>\n<p>Ocular examination reveals&nbsp;<strong>normal visual activity</strong> and <strong>central vision</strong> (though central vision will be involved later in disease progression). Fundoscopy shows bilateral, mid-peripheral intraretinal perivascular '<strong>bone-spicule</strong>' changes and <strong>atrophy</strong> of the retinal pigment epithelium. There is severe <strong>peripheral pigmentation</strong>, arteriolar narrowing, and <strong>pallor</strong> of the disc.&nbsp;</p>\n<p>Retinitis pigmentosa can lead to <strong>posterior subcapsular cataracts</strong>, open-angle <strong>glaucoma</strong>, keratoconus, and posterior <strong>vitreous detachment</strong> as possible complications.&nbsp;</p>\n<p>There is no specific treatment for retinitis pigmentosa. Some interventions that may help include the following:&nbsp;</p>\n<ul>\n<li><strong>Regular follow-up</strong> to assess vision and provide low-vision aid, rehabilitation, and social services</li>\n<li>Cataract surgery</li>\n<li>'Nanometer controlled' <strong>sunglasses</strong> as light protective strategies for outdoor and indoor use</li>\n<li>Avoidance of retinotoxic medications</li>\n</ul>\n<p>Other options:</p>\n<p>Option B: <strong>Vitamin A deficiency</strong> would lead to <strong>xerophthalmia</strong>. This also has night blindness and loss of vision. However, retinal involvement would be characterized by yellowish, peripheral dots in advanced cases.&nbsp;</p>\n<p>Option C: <strong>Retinal detachment</strong> occurs when there is a <strong>separation</strong> between the neuroepithelium and pigment epithelium of the retina. This can occur due to trauma, neoplasm, or fluid accumulation. It is characterized by light flashes, floaters, and a <strong>'curtain' obscuring the vision. </strong>Ophthalmoscopy features depend on the stage. Early stages may not be apparent other than color changes, but later stages may show folds that oscillate on eye movement, grey depressions, and bright summits.&nbsp;</p>\n<p>The image given below shows a shifting fluid sign in exudative retinal detachment.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/54666d1699de41e88a343ecad945b843.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8091d575750f4aad89be9ff3a94061abx1280x2442.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2d93cfd9ef59485596f52465b85b3408x720x535.JPEG"
    ]
  },
  {
    "text": "A  post-cataract surgery patient came with complaints of blurring of vision for the past 2 weeks. His cataract surgery was done 3 months back. His optical coherence tomography (OCT) image is given below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Cystoid macular edema"
      },
      {
        "id": 2,
        "text": "Macular hole"
      },
      {
        "id": 3,
        "text": "Central serous retinopathy"
      },
      {
        "id": 4,
        "text": "Senile macular degeneration"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical scenario of a\u00a0<strong>post-cataract surgery</strong> patient presenting with a blurring of vision and an\u00a0OCT image showing <strong>intraretinal cystoid spaces</strong>\u00a0is suggestive of\u00a0<strong>cystoid macular edema</strong> (CME).</p>\n<p>Common causes of CME include previous <strong>cataract surgery</strong>, uveitis, central retinal vein occlusions, <strong>diabetic retinopathy</strong>, retinitis pigmentosa, and retinopathy of prematurity, and topical <strong>prostaglandins</strong>. Cystoid macular edema in post-cataract surgery patients is termed as <strong>Irvine-Gass</strong> syndrome.\u00a0</p>\n<p>In CME, OCT shows foveal depression, <strong>intraretinal cystoid spaces</strong>, and retinal thickening.</p>\n<p>CME occurs due to a break in the <strong>inner and outer blood-retinal barrier</strong>. Due to retinal vessel leak fluid or exudate comes out and forms cystic space in the central retina. Mostly it gets <strong>accumulated</strong> in the <strong>outer plexiform</strong> (Henle's layer) and <strong>inner nuclear layers</strong> of the retina.\u00a0</p>\n<p>On fundoscopy, the multiple cystoid oval spaces in CME appear as a\u00a0 <strong>\"honeycomb appearance\"</strong>.</p>\n<p>In Fundus fluorescein angiography fluid accumulation in outer plexiform, layer shows a characteristic\u00a0<strong>flower petal pattern</strong> (<strong>petaloid appearance</strong>) as shown below:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/29c7e52da981464eba28abdeb9fc0f9f.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/75f339fe6bc94e2eb96be8fd4804c332x204x136.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/07394bd891a14ccc920a99f2a2b06eb9x338x106.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1abc1b9b97c648928ab85cd932d22189x800x502.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6eb066eba435403f93d482edd84137b8x259x157.PNG"
    ]
  },
  {
    "text": "During an ophthalmoscopic examination of a patient in bright light, you notice a finding similar to that of 'A' in the given image. The same patient is made to sit in a dark room and a subsequent examination reveals you a fundus similar to that of 'B'. What is the possible diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Oguchi's disease"
      },
      {
        "id": 2,
        "text": "Fundus albipunctatus"
      },
      {
        "id": 3,
        "text": "Fundus flavimaculatus"
      },
      {
        "id": 4,
        "text": "Retinitis pigmentosa"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows a comparison in the fundus appearances <strong>(\"A\" shows golden yellow colour of the fundus in a light-adapted state; \"B\" shows normal-appearing funds after prolonged dark adaptation of 3 to 4 hours).\u00a0</strong>The fundus has an unusual golden yellow colour in the light-adapted state, which\u00a0becomes normal after prolonged dark adaptation is called<strong> Mizuo or Mizuo\u2013Nakamura phenomenon.\u00a0</strong></p>\n<p><strong>Mizuo phenomenon</strong> is seen in\u00a0<strong>Oguchi's disease.\u00a0</strong></p>\n<p><strong>Oguchi's disease\u00a0</strong>is a type of<strong>\u00a0congenital stationary night blindness</strong> with<strong> abnormal fundus.\u00a0</strong><strong>Rod</strong> <strong>function</strong> is <strong>absent</strong>\u00a0even after <strong>30 minutes</strong> of <strong>dark adaptation </strong>(normal dark adaptation time is 20\u201330 mins)\u00a0but recovers to a near-normal level after a long period of dark adaptation (4 hours).</p>\n<p><strong>Congenital stationary night blindness</strong> refers to a group of disorders characterised by<strong> infantile-onset nyctalopia</strong> but <strong>non-progressive retinal dysfunction.</strong></p>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/db036b2610bd4a5a8368841cbf27fc9e.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "In which of the following conditions do you see a 'headlight-in-fog' appearance, as seen below?",
    "choices": [
      {
        "id": 1,
        "text": "Posterior staphyloma"
      },
      {
        "id": 2,
        "text": "Fundal coloboma"
      },
      {
        "id": 3,
        "text": "Congenital rubella"
      },
      {
        "id": 4,
        "text": "Toxoplasmosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The \"<strong>headlight-in-fog'</strong>&nbsp;appearance is seen in <strong>toxoplasmosis.&nbsp;</strong></p>\n<p>Toxoplasmosis is a parasitic infestation due to <strong><em>Toxoplasma gondii</em></strong><em>.&nbsp;</em>It primarily affects the central nervous system and retina. In humans, it occurs as congenital, acquired, or recurrent.</p>\n<p><strong>Toxoplasmosis</strong>&nbsp;has a <strong>variable presentation</strong>.&nbsp;Congenital toxoplasmosis is acquired by the transplacental route. Infants are usually born with inactive disease.&nbsp;<strong>Iridocyclitis</strong>&nbsp;can be granulomatous or non-granulomatous. There is focal superficial necrotizing retinochoroiditis along with vitritis, which gives the '<strong>headlight-in-fog' appearance</strong>&nbsp;as in the image in question.<strong>&nbsp;</strong>Fundoscopy shows deep retinitis and papillitis with granulomas.&nbsp;</p>\n<p><strong>Old choroid</strong>&nbsp;lesions of toxoplasmosis are <strong>punched-out lesions with pigmented borders</strong>&nbsp;as in the image below<strong>.</strong>&nbsp;<strong>Bilateral healed punched-out</strong> chorioretinal lesions in the <strong>macular</strong> area are usually seen. In acquired toxoplasmosis, punched-out lesions similar to congenital toxoplasmosis are seen. In addition, punctate outer retinal toxoplasmosis (PORT) may also be seen.&nbsp;</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1255430567934a5bb15a1cb46b3bafef.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/96b3261505f24644ad2ef07e66c2d03dx662x661.PNG"
    ]
  },
  {
    "text": "On routine examination of a neonate, the left eye was smaller in size and had a white pupillary reflex. The fundoscopy image is given below. What is the most probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Retinoblastoma"
      },
      {
        "id": 2,
        "text": "Coats disease"
      },
      {
        "id": 3,
        "text": "Persistent fetal vasculature"
      },
      {
        "id": 4,
        "text": "Retinal detachment"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The probable diagnosis is&nbsp;<strong>persistent fetal vasculature.</strong></p>\n<p>The points in the clinical vingette pointing to this diagnosis are:&nbsp;</p>\n<ul>\n<li><strong>White pupillary reflex</strong> in the left eye (unilateral leukocoria)</li>\n<li>Smaller size of the left eye (microphthalmos) and&nbsp;</li>\n<li>Fundoscopy image showing&nbsp;a leash of vascularized fibrous tissue extending from the back of the lens to the optic nerve head</li>\n</ul>\n<p><strong>Persistent fetal vasculature </strong>was earlier<strong>&nbsp;</strong>known as <strong><span class=\"topic-highlight\">persistent hyperplastic primary vitreous</span></strong><span class=\"topic-highlight\">. It&nbsp;</span><span class=\"topic-highlight\">is</span><strong><span class=\"topic-highlight\">&nbsp;</span></strong><span class=\"topic-highlight\">the </span><strong><span class=\"topic-highlight\">f</span></strong><strong>ailure</strong> of<strong> primary vitreous </strong>and<strong> hyaloid vasculature</strong> to<strong> regress</strong>. This&nbsp;eventually leads to contraction and opacification combined with the <strong>hypoplasia</strong> of&nbsp;the<strong> posterior portion</strong> of the <strong>vascular meshwork.</strong></p>\n<p>It is<strong> u</strong><strong>nilateral</strong> in most of the cases. It is bilateral in cases that are associated with Trisomy 13, trisomy 22, Norries disease, and Walkers Warburg syndrome.&nbsp;</p>\n<section id=\"B9780323049597500086-cesec16\">\n<p>Clinical Findings&nbsp;include:</p>\n</section>\n<section id=\"B9780323049597500086-cesec17\">\n<ol>\n<li><strong>Leukocoria</strong></li>\n<li><strong>Microphthalmia&nbsp;</strong></li>\n<li>Shallow anterior chamber&nbsp;</li>\n<li>Retrolental cataract&nbsp;</li>\n<li>Esotropia&nbsp;</li>\n<li>Angle-closure glaucoma&nbsp;</li>\n<li>Dilated iris vessels&nbsp;</li>\n<li>Persistent hyaloid artery&nbsp;</li>\n<li>Vitreous hemorrhage</li>\n<li>Tractional retinal detachment&nbsp;</li>\n</ol>\n</section>\n<section id=\"B9780323049597500086-cesec18\">\n<figure class=\"inline-figure\"></figure>\n</section>\n<section id=\"B9780323049597500086-cesec21\">\n<p>Investigations:</p>\n<ul>\n<li><strong>CT scan of orbit</strong> to evaluate for the <strong>presence of calcification</strong>, which is present in <strong>retinoblastoma</strong> but <strong>absent in persistent fetal vasculature.&nbsp;</strong></li>\n<li><strong>B-scan ultrasonography</strong> to evaluate for retinal detachment when a cataract limits the view to the retina.</li>\n</ul>\n<p>Treatment is done by <strong>p</strong><strong>ars plana lensectomy</strong> and<strong> vitrectomy</strong> to remove the retrolental fibrovascular membrane to prevent angle-closure glaucoma, followed by aggressive amblyopia therapy</p>\n<p>Image below shows the falciform fold of detached dysplastic retina encircling the persistent hyaloid artery that extends from the optic nerve head to the retrolental mass.</p>\n</section>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d792da21430c4252b43698f7e5078394.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b52b1bc88c1545c98f7a90dfe916f5dax455x512.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5940155894d34dc1913e4eab2a422080x276x229.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fad04458c486488188f43b24740f289bx492x512.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ee830c451e5043e0b7fef0086d4e51e5x1280x2442.JPEG"
    ]
  },
  {
    "text": "A 50-year-old man came to the OPD with blurred vision. His fundus examination was done. The fundus appearance is as shown in the image given below. This appearance is seen in which of the following condition?",
    "choices": [
      {
        "id": 1,
        "text": "Diabetic retinopathy"
      },
      {
        "id": 2,
        "text": "Glaucoma"
      },
      {
        "id": 3,
        "text": "Retinal detachment"
      },
      {
        "id": 4,
        "text": "ARMD"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario and the fundal image showing laminar dot sign is suggestive of\u00a0<strong>Glaucoma.</strong></p>\n<p><strong>Laminar dot sign</strong>\u00a0is an\u00a0<strong>advanced</strong>\u00a0<strong>glaucomatous</strong>\u00a0change in the\u00a0<strong>optic disc.\u00a0</strong>It is because the\u00a0<strong>pores in the lamina cribrosa are slit-shaped</strong>\u00a0and are\u00a0<strong>visible as grey dots</strong>\u00a0due to thinning of neuroretinal rim in these patients.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/092a499b22824292904b0c9af1127fb5.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2488328cedb946db8426aa42f774f503x600x402.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1a4009604fe34ec3938b17a3f40a512bx441x324.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1917fd6069314dad90ad88506f957ee4x720x649.JPEG"
    ]
  },
  {
    "text": "A 60-year-old female presented with acute loss of vision and metamorphopsia. There is a history of the positive scotoma. Fundal changes are given below. What will be the fundus fluorescein angiography finding?",
    "choices": [
      {
        "id": 1,
        "text": "Ink blot appearance"
      },
      {
        "id": 2,
        "text": "Petaloid appearance"
      },
      {
        "id": 3,
        "text": "Stars in the sky appearance"
      },
      {
        "id": 4,
        "text": "Dual circulation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above clinical scenario and the fundal image depicting <strong>focal fundal detachment</strong> are suggestive of <strong>central serous retinopathy. </strong>An enlarging <strong>inkblot pattern</strong> or smoke stack pattern is seen in FFA.</p>\n<p>Central serous retinopathy refers to the <strong>spontaneous serous detachment</strong> of the <strong>neurosensory retina</strong> in the <strong>macular</strong> region.\u00a0Recent studies implicate\u00a0an abnormal choroidal circulation as the cause of CSR.\u00a0</p>\n<p>Clinical features:</p>\n<ul>\n<li>Retinal detachment - <strong>Sudden painless</strong> loss\u00a0of vision</li>\n<li>Relative positive scotoma</li>\n<li>Micropsia</li>\n<li>Metamorphopsia</li>\n</ul>\n<p>Investigations:</p>\n<ul>\n<li>Ophthalmoscopy - circular ring reflex present and\u00a0<strong>foveal</strong> reflex <strong>absent</strong></li>\n<li>FFA - enlarging inkblot pattern\u00a0or\u00a0<strong>smoke stack</strong> pattern</li>\n</ul>\n<p><strong>Spontaneous resolution</strong> is seen in most cases and hence <strong>observation</strong> is enough.\u00a0<strong>Steroids\u00a0</strong>are\u00a0<strong>contraindicated</strong>. The disease is usually self-limiting but may recur.</p>\n<p>The image depicts fundus fluorescein angiography (FFA), showing an enlarging\u00a0<strong>ink-blot pattern/enlarging dot sign</strong>, which is seen\u00a0in\u00a0<strong>central serous retinopathy (CSR)</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/46446120cbcd4b1eaa97131b56b5e5a2.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/cf71fca6a66a4916be96b5d82c78e4c9x720x564.PNG"
    ]
  },
  {
    "text": "A 65-year-old female patient with a history of chronic arthritis on treatment came with complaints of defective vision in both eyes. On examination, vision in RE = 6/12, LE = 6/18, IOP = 18 mmHg in both eyes, the anterior segment was normal, fundus examination and fundus fluorescein angiography (FFA) findings given in the figure. What is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Choroiditis"
      },
      {
        "id": 2,
        "text": "Chloroquine toxicity"
      },
      {
        "id": 3,
        "text": "Steroid-induced glaucoma"
      },
      {
        "id": 4,
        "text": "Macular edema"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical viginette of <strong>female</strong> patient on treatment for chronic arthritis which is most likely the drug <strong>chloroquine</strong> given for <strong>rheumatoid arthritis</strong>, now presenting with <strong>decreased visual acuity</strong>, fundoscopy with a typical <strong>bull's eye sign</strong> and Fundus fluroscein angiography showing <strong>increased fluroscence</strong> in the macular area is suggestive of <strong>chloroquine toxicity</strong>.</p>\n<p><strong>Chloroquine</strong> and it's derivative <strong>hydroxychloroquine</strong> (HCQ) are <strong>antimalarial</strong> drugs which is also used to treat connective tissue disorders such as <strong>Rheumatoid arthritis</strong>, Systemic Lupus Erythematosus (<strong>SLE)</strong> and Discoid Lupus.</p>\n<div class=\"page\" title=\"Page 880\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The maximum dose allowed for <strong>chloroquine</strong> is <strong>6 mg/kg</strong> in 24 hours while for <strong>hydroxychloroquine</strong> it is <strong>4.5 mg/kg. </strong>Hydroxychloroquine has a lower risk of ocular toxicity and hence is percived to be a safer drug but with weaker anti-inflammatory effect.</p>\n</div>\n</div>\n</div>\n</div>\n<p>Manifestations of <strong>Chloroquine toxicity</strong>:</p>\n<ul>\n<li><strong>Reversible</strong> on stopping the drug:<strong>&nbsp;difficulty in night vision</strong>, blurring of vision, diplopia, <strong>keratopathy</strong></li>\n<li>Central and paracentral <strong>scotomas</strong></li>\n<li><strong>Earliest fundus</strong> findings: <strong>blunting of foveal reflex</strong>, irregularity in the macular pigmentation.</li>\n<li><strong>Advanced</strong> stages: '<strong>Bull's eye maculopathy' </strong>where the<strong>&nbsp;</strong>central irregular pigmentation may become surrounded by a concentric zone of hypopigmentation</li>\n<li><strong>End-stage</strong> appearance includes bullseye maculopathy, <strong>pigmentary degeneration of retina</strong>&nbsp;and bone spicule formation, vascular attenuation, and <strong>optic atropy</strong>.</li>\n</ul>\n<div class=\"page\" title=\"Page 849\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Screening</strong> should include a <strong>baseline examination</strong> for all patients before starting these drugs followed by&nbsp;<strong>annual screening</strong> starting <strong>after 5 years</strong> of use.</p>\n<p><strong>Pre-existing maculopathy</strong> is considered a <strong>contraindication</strong>&nbsp;to treatment with chloroquine and HCQ because underlying abnormalities may mask early toxicity.</p>\n<div class=\"page\" title=\"Page 849\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Screening examinations include visual acuity testing, dilated fundus examination, spectral-domain optical coherence tomography (SD-OCT) testing, and functional assessment with Humphrey test.</p>\n<p>Various causes of <strong>Bull's eye maculopathy</strong> are:</p>\n<ol>\n<li><strong>Chloroquine and HCQ toxicity</strong></li>\n<li><strong>Cone-Rod dystrophy</strong></li>\n<li>Advanced stargardt's disease</li>\n<li>Clofazimine retinopathy</li>\n</ol>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b75678189d82477c85b6bdd95dd46016.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A resident notes the following fundus picture in a patient referred to the ophthalmology OPD with visual complaints. What does it suggest?",
    "choices": [
      {
        "id": 1,
        "text": "Retinal detachment"
      },
      {
        "id": 2,
        "text": "Papilledema"
      },
      {
        "id": 3,
        "text": "Primary optic atrophy"
      },
      {
        "id": 4,
        "text": "Secondary optic atrophy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The fundoscopic image shows <strong>dilated veins</strong> with a&nbsp;<strong>blurred disc margin</strong>&nbsp;which is suggestive of <strong>papilledema</strong>.</p>\n<p><strong>Ophthalmoscopic features of papilledema</strong>:</p>\n<ul>\n<li><strong>Early-stage:</strong>\n<ul>\n<li><strong>Obscuration</strong> of the disc margins <strong>(</strong><strong>nasal margins first) </strong></li>\n<li><strong>Absence</strong> of <strong>spontaneous venous pulsation</strong> at the disc</li>\n<li><strong>Mild hyperemia</strong> of the disc</li>\n<li>The blurring of the&nbsp;peripapillary nerve fiber layer</li>\n</ul>\n</li>\n<li><strong>Established papilledema:</strong>\n<ul>\n<li>The disc appears to be enlarged and elevated (<strong>mushroom</strong> or <strong>dome-shaped)</strong></li>\n<li><strong>Macular fan </strong>appears</li>\n<li><strong>Paton&rsquo;s lines-</strong>&nbsp;circumferential <strong>greyish white folds</strong> may develop due to the&nbsp;separation of nerve fibers</li>\n<li>Visual fields show <strong>enlargement of the blind spot</strong></li>\n<li>Veins become <strong>tortuous</strong> and engorged</li>\n<li>Multiple <strong>cotton-wool spots</strong> and superficial hemorrhages</li>\n</ul>\n</li>\n<li><strong>Chronic or long-standing (vintage) papilledema:</strong>\n<ul>\n<li>The optic disc gives the&nbsp;appearance of the <strong>dome of a champagne cork</strong></li>\n<li>Small drusen-like crystalline deposits (<strong>corpora amylacea</strong>) may appear on the disc surface</li>\n</ul>\n</li>\n<li><strong>Atrophic stage:</strong>\n<ul>\n<li><strong>Secondary</strong> optic atrophy</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/56401db6a71c4b93909f7439a51f7d5b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A woman comes to the ophthalmology OPD because of having vision difficulties for the last 3 months. On fundoscopic examination, the following findings are seen. Which of the following is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Hypertensive retinopathy"
      },
      {
        "id": 2,
        "text": "Diabetic retinopathy"
      },
      {
        "id": 3,
        "text": "Pathological myopia"
      },
      {
        "id": 4,
        "text": "Sarcoidosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shows a fundus typical of <strong>pathological myopia </strong>due to the\u00a0<strong>stretching </strong>of the<strong> retina</strong>.</p>\n<p>The <strong>tigroid appearance</strong> or <strong>tessellated appearance</strong> of the fundus can be appreciated. As the eye enlarges, the retinal pigment epithelium becomes thinner, resulting in:</p>\n<ul>\n<li>A tessellated (checkered) appearance of the fundus</li>\n<li><strong>Increased </strong>visibility of the<strong> choroidal vasculature</strong></li>\n</ul>\n<p>Other features of the myopic fundus are as follows:</p>\n<ul>\n<li><strong>Lacquer cracks\u00a0</strong>are spontaneous <strong>ruptures </strong>of the elastic lamina of <strong>Bruch\u2019s membrane.\u00a0</strong>It appears yellowish-white. it is usually located in the <strong>posterior pole.</strong></li>\n<li><strong>Annular gray shadow</strong> around the optic disc</li>\n<li>Lattice degeneration</li>\n<li><strong>Foster Fuchs spots</strong></li>\n<li><strong>Cystoid degeneration</strong></li>\n<li>Total retinal atrophy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4ca948472ab54da3be05a9d1767d3c5f.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/481fa15d54024862ba156641e8065226x1280x1301.JPEG"
    ]
  },
  {
    "text": "A 69-year-old man who is a chronic smoker, hypertensive, and has a BMI of 35 kg/m2 complains of diminished vision in the right eye. His visual acuity is 6/36 BE and the anterior segment appears normal. His fundus is as shown below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Diabetic retinopathy"
      },
      {
        "id": 2,
        "text": "Age related dry macular degeneration"
      },
      {
        "id": 3,
        "text": "Hypertensive retinopathy"
      },
      {
        "id": 4,
        "text": "Age related wet macular degeneration"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The clinical scenario along with the image which shows <strong>drusen </strong>(druplets)\u00a0are a feature of <strong>dry</strong> or <strong>non-exudative age-related macular degeneration (ARMD</strong>).\u00a0</p>\n<p>Drusen are the <strong>earliest visible clinical signs</strong> of ARMD. They are composed of lipid, amyloid, complement factors, and associated cellular components.</p>\n<p>There are\u00a0two types of ARMD:</p>\n<ul>\n<li><strong>Dry </strong>(non-exudative, non-neovascular)<strong> ARMD</strong> is the <strong>most common</strong> form, comprising around <strong>90%</strong> of the diagnosed cases. Initially characterized by macular <strong>Drusens,</strong> which later progress to <strong>geographical atrophy.\u00a0</strong>Geographic atrophy (GA) is the <strong>advanced stage</strong> of dry ARMD. Antioxidants like the AREDS2 supplements have proven effective.</li>\n<li><strong>Wet </strong>(exudative, neovascular)<strong> ARMD</strong> is much <strong>less common</strong> than the dry type, but it is associated with <strong>more rapid progression</strong> to advanced sight loss.</li>\n</ul>\n<p><strong>Clinical classification:</strong></p>\n<table style=\"width: 408px;\" border=\"1\">\n<tbody>\n<tr style=\"height: 114px;\">\n<td style=\"text-align: center; width: 142px; height: 114px;\"><strong>Category</strong></td>\n<td style=\"text-align: center; width: 252px; height: 114px;\">\n<p><strong>Definition</strong></p>\n<p>(based on the presence of lesions<strong> within two disc diameters</strong>\u00a0of the fovea in either eye)</p>\n</td>\n</tr>\n<tr style=\"height: 47px;\">\n<td style=\"width: 142px; height: 47px;\"><strong>No apparent</strong><br /><strong>age-related</strong>\u00a0changes</td>\n<td style=\"width: 252px; height: 47px;\"><strong>No drusen</strong><br />No AMD pigmentary abnormalities</td>\n</tr>\n<tr style=\"height: 50px;\">\n<td style=\"width: 142px; height: 50px;\"><strong>Normal age-related</strong><br /><strong>changes</strong></td>\n<td style=\"width: 252px; height: 50px;\"><strong>Only drusen</strong><br />No AMD pigmentary abnormalities</td>\n</tr>\n<tr style=\"height: 77px;\">\n<td style=\"width: 142px; height: 77px;\"><strong>Early</strong> ARMD</td>\n<td style=\"width: 252px; height: 77px;\"><strong>Medium Drusen</strong> (&gt;63 \u03bcm but &lt;125 \u03bcm)<br />No AMD pigmentary abnormalities</td>\n</tr>\n<tr style=\"height: 72px;\">\n<td style=\"width: 142px; height: 72px;\"><strong>Intermediate</strong> ARMD</td>\n<td style=\"width: 252px; height: 72px;\"><strong>Large Drusen</strong> (&gt;125 \u03bcm)<br />Any ARMD pigmentary<br />abnormalities</td>\n</tr>\n<tr style=\"height: 47px;\">\n<td style=\"width: 142px; height: 47px;\"><strong>Late</strong> ARMD</td>\n<td style=\"width: 252px; height: 47px;\"><strong>Neovascular ARMD</strong> and/or<br />any <strong>geographic atrophy</strong></td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9c8350cdef454633ba4fd9c025f111ac.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which stage of ROP  is shown in the image?",
    "choices": [
      {
        "id": 1,
        "text": "Stage 3"
      },
      {
        "id": 2,
        "text": "Stage 1"
      },
      {
        "id": 3,
        "text": "Stage 2"
      },
      {
        "id": 4,
        "text": "Stage 4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Image shows<strong> intraretinal ridge formation</strong> and it corresponds to <strong>stage 2 of ROP.</strong></p>\n<ul>\n<li>Retinopathy of prematurity (ROP), previously known as retrolental fibroplasia, is a disease of the eye that affects <strong>prematurely born babies.</strong></li>\n<li>ROP can be mild and may resolve spontaneously, but may lead to blindness in serious cases. As such, all <strong>premature babies</strong> are at risk for ROP, and <strong>very low birth weight</strong> is an additional risk factor.</li>\n<li>Both<strong> oxygen toxicity and relative hypoxia</strong> can contribute to the development of ROP.</li>\n<li><strong>Location<br /></strong>Concentric zones centered on the optic disc are described.\n<ul style=\"list-style-type: disc;\">\n<li><strong>Zone I</strong> is bounded by an imaginary circle, the radius of which is twice the distance from the disc to the center of the macula.\u00a0</li>\n<li><strong>Zone II</strong> extends concentrically from the edge of zone I; its radius extends from the center of the disc to the nasal ora serrata.</li>\n<li><strong>Zone III</strong> consists of a residual temporal crescent anterior to zone II</li>\n</ul>\n</li>\n<li><strong>Stages of ROP:</strong><br />\n<ul>\n<li>Stage 1: Demarcation line</li>\n<li>Stage 2: Intraretinal ridge formation</li>\n<li>Stage 3: Neovascularization</li>\n<li>Stage 4: Subtotal retinal detachment</li>\n<li>Stage 5: Total retinal detachment</li>\n</ul>\n</li>\n<li><strong>\"Plus\" disease</strong> signifies a <strong>tendency to progression</strong> and is characterized by the\u00a0<strong>dilatation</strong> and <strong>tortuosity</strong> of <strong>blood vessels\u00a0</strong>involving at least <strong>two quadrants</strong> of the <strong>posterior fundus.</strong>\u00a0</li>\n<li><strong>Aggressive posterior (\"rush\" disease, AP-ROP)</strong> is uncommon but if untreated usually <strong>progresses</strong> to <strong>stage</strong> <strong>5,</strong> sometimes within a few days. It is characterized by its <strong>posterior location, prominence</strong> of <strong>plus disease,</strong> and ill-defined nature of the retinopathy.</li>\n<li><strong>Screening</strong>\n<ul style=\"list-style-type: disc;\">\n<li>First ROP screening should be done at\u00a0<strong>4 weeks</strong> if the gestational age is 28\u201334 weeks or birth weight is &lt;2000 g.</li>\n<li>First ROP screening should be done at 3 weeks if gestational age is &lt;28 weeks or birth weight is &lt;1200 g.</li>\n</ul>\n</li>\n<li><strong>Treatment</strong>\n<ul style=\"list-style-type: circle;\">\n<li><strong>Type</strong> <strong>1</strong>. Treatment is now <strong>recommended within 48 hours</strong> for type 1 disease. It is\u00a0done by laser photocoagulation of peripheral avascular retina.</li>\n<li><strong>Type 2</strong>\u00a0disease requires <strong>observation for progression.</strong></li>\n<li><strong>Intravitreal anti-vascular endothelial growth factor (VEGF)</strong> agents, e.g., <strong>bevacizumab\u00a0</strong>(only for AP-ROP)</li>\n<li><strong>Laser ablation of</strong>\u00a0the avascular peripheral retina</li>\n<li><strong>Pars plana vitrectomy </strong>for tractional retinal detachment not involving the macula <strong>(stage 4A)<br /><br /></strong></li>\n</ul>\n</li>\n<li><strong>Type 1 ROP<br /></strong>1) Zone I ROP with plus disease<br />2) Zone I, no plus, stage 3 ROP<br />3) Zone II with plus, stage 2 or 3 ROP</li>\n</ul>\n<p><strong>Note:</strong> Non-type 1 ROP is labelled type 2 ROP</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/486e636967794d20bf7b00d56f644c5e.JPEG"
    ],
    "explanation_images": [
      "https://cdn1.dailyrounds.org/uploads/b3fce632ad544799812fb59b01263f37x300x292.JPEG",
      "https://cdn1.dailyrounds.org/uploads/048657815dc94a06936feb152908e23cx494x371.JPEG",
      "https://cdn1.dailyrounds.org/uploads/d0343a8a1d104002a3bef0179ed838a1x494x371.JPEG"
    ]
  },
  {
    "text": "A patient presents to the ophthalmology OPD with a sudden, severe diminution of vision in his right eye. Relative afferent pupillary defect is present. What is the probable diagnosis in this patient with the fundoscopic findings shown below?",
    "choices": [
      {
        "id": 1,
        "text": "Non-ischaemic central retinal vein occlusion"
      },
      {
        "id": 2,
        "text": "Ischaemic central retinal vein occlusion"
      },
      {
        "id": 3,
        "text": "Branched retinal vein occlusion"
      },
      {
        "id": 4,
        "text": "Central retinal artery occlusion"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most probable diagnosis in this patient is <strong>ischaemic central retinal vein occlusion</strong>.</p>\n<p>The clinical vignette of a patient developing sudden, severe painless diminution of vision, with relative afferent pupillary defect and funduscopy of the eye showing massive retinal haemorrhages giving a\u00a0<strong>splashed tomato appearance</strong>, are all suggestive of <strong>ischaemic</strong>\u00a0<strong>central retinal vein occlusion (CRVO).</strong></p>\n<div class=\"page\" title=\"Page 286\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Other features of ischaemic CRVO on fundoscopy include numerous cotton wool spots - usually more than 6 to 10, disc showing oedema and hyperaemia, and the macular area is full of haemorrhages and is severely oedematous.</p>\n<p>In later stages, the fundus shows marked sheathing around veins, with collaterals and neovascularization seen around and at the disc or periphery respectively.<br />Macula shows marked pigmentary changes and chronic cystoid oedema.</p>\n<div class=\"page\" title=\"Page 286\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The complications include Rubeosis iridis, i.e. neovascularisation of iris and neovascular glaucoma occurs within 3 months and this is also called \"90 days glaucoma\".</p>\n<p>Vitreous haemorrhage and proliferative retinopathy may also occur in a few cases. Treatment usually involves treating the underlying cause and complications.</p>\n<p>Other options:<br />Option A: <strong>Non-ischaemic\u00a0CRVO</strong>, also called venous stasis retinopathy, is characterised by sudden onset mild to moderate blurring of vision. Relative afferent pupillary defect is either absent or if present, mild. Pathognomonic features of ischaemic CRVO differentiating it from non-ischaemic CRVO are the presence of relative afferent pupillary defect (RAPD), visual field defects and reduced amplitude of b-wave on electroretinogram</p>\n</div>\n</div>\n</div>\n<p>Option C:\u00a0<strong>Branched retinal vein occlusion</strong> is characterised by\u00a0a sudden painless onset of blurred vision if the macula is involved, whereas peripheral occlusion is asymptomatic. Iris neovascularization and neovascular glaucoma are both less common in BRVO than in CRVO. On fundoscopy, dilatation and tortuosity of the affected venous segment is observed, with flame-shaped and dot/blot haemorrhages in the retinal area. Cotton wool spots and retinal edema may also be present.</p>\n<p>Option D:\u00a0<strong>Central retinal artery occlusion</strong> is characterised by sudden profound loss of vision, that is painless and visual acuity is severely reduced. Relative afferent pupillary defect is profound, giving rise to an amaurotic pupil and fundoscopy shows the presence of a cherry red spot at the region of the foveola. The peripapillary retina appears swollen and opaque.</p>\n</div>\n</div>\n</div>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/af9dc2dbc9064a70a2518b899e7ac699.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Fundal changes shown in the image given below can be seen in the case of",
    "choices": [
      {
        "id": 1,
        "text": "Uveitis"
      },
      {
        "id": 2,
        "text": "Glaucoma"
      },
      {
        "id": 3,
        "text": "Retinal detachment"
      },
      {
        "id": 4,
        "text": "Age related macular degeneration"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given image shows severe <strong>cupping</strong> and <strong>thinning</strong> of the <strong>neuroretinal rim</strong> seen in glaucoma.</p>\n<p><strong>Glaucomatous changes in the optic disc</strong></p>\n<p><strong>Early</strong> Glaucomatous changes</p>\n<ul>\n<li>Slit defects of the retinal nerve fiber layer</li>\n<li>Splinter hemorrhages on disc margin</li>\n<li>Large cup: 0.7 or more</li>\n<li>Asymmetry of the cups: A difference equal to or more than 0.2 between two eyes is significant</li>\n<li>Vertically oval cup</li>\n</ul>\n<p><strong>Advanced</strong> Glaucomatous changes</p>\n<ul>\n<li>Marked cupping (Beanpot cupping)</li>\n<li>Thinning of neuroretinal rim</li>\n<li><strong>Bayonetting sign</strong>&nbsp;- Sharp angulation of vessel at the margin of the excavated cup.</li>\n<li><strong>Laminar dot sign</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b54e23f48c194f79884bb4ddd5c73e65.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old male patient who is on ART for AIDS presented with difficulty in vision. Fundoscopic examination revealed the following finding as shown in the image below. Which of the following subfamilies of the Herpesviridae family encompasses the causative agent?",
    "choices": [
      {
        "id": 1,
        "text": "Alpha viruses"
      },
      {
        "id": 2,
        "text": "Beta viruses"
      },
      {
        "id": 3,
        "text": "Gamma viruses"
      },
      {
        "id": 4,
        "text": "Delta viruses"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Pizza pie appearance</strong> on fundoscopy in an <strong>immunocompromised</strong> <strong>person</strong> is characteristic of <strong>cytomegalovirus</strong> (<strong>CMV</strong>)\u00a0<strong>retinitis</strong>. It\u00a0belongs to <strong>beta viruses subfamily</strong> of the\u00a0<em>Herpesviridae</em> family.</p>\n<p><em>Herpesviridae</em> family is divided into 3 subfamilies:</p>\n<ul>\n<li>Alpha herpesviruses (e.g. HSV 1 and 2, varicella-zoster virus)</li>\n<li><strong>Beta herpes viruses (e.g. CMV)</strong></li>\n<li>Gamma herpesviruses (e.g. EBV)</li>\n</ul>\n<table style=\"width: 382px; height: 392px;\">\n<tbody>\n<tr>\n<td style=\"width: 110.344px;\">\n<p><strong>Alpha </strong><strong>viruses</strong></p>\n</td>\n<td style=\"width: 109.055px;\"><strong>Beta viruses</strong></td>\n<td style=\"width: 120.211px;\"><strong>Gamma viruses</strong></td>\n</tr>\n<tr>\n<td style=\"width: 110.344px;\">Short replicative cycle \u2013 12-18 hours</td>\n<td style=\"width: 109.055px;\">Replicative cycle - &gt;24 hours</td>\n<td style=\"width: 120.211px;\">variable</td>\n</tr>\n<tr>\n<td style=\"width: 110.344px;\">Latency \u2013 sensory ganglia</td>\n<td style=\"width: 109.055px;\">Latency \u2013 salivary glands and other organs</td>\n<td style=\"width: 120.211px;\">Lymphocyte specific</td>\n</tr>\n<tr>\n<td style=\"width: 110.344px;\">Ex: HSV 1 and 2, varicella-zoster virus</td>\n<td style=\"width: 109.055px;\">\n<p>Ex: CMV</p>\n<p>HHV6</p>\n<p>HHV7</p>\n</td>\n<td style=\"width: 120.211px;\">\n<p>Ex: EBV</p>\n<p>HHV8</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ef42f999e04c411fa2929e8897173805.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 67-year-old male presents to the emergency department with sudden painless vision loss in his left eye. He has had a similar episode before but his vision was quickly restored. On physical exam, a carotid bruit is heard and a relative afferent pupillary defect is noted on ocular examination. His fundus appears as shown below. Which of the following is the best immediate step in the management of this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Ocular massage"
      },
      {
        "id": 2,
        "text": "Steroids"
      },
      {
        "id": 3,
        "text": "Laser photodisruption"
      },
      {
        "id": 4,
        "text": "Fibrinolytic therapy"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Sudden painless unilateral vision loss with carotid bruit (carotid artery disease) and the fundus picture showing a cherry-red spot is suggestive of <strong>central retinal artery occlusion </strong>(CRAO)<strong>.\u00a0</strong>The best immediate step in management is <strong>ocular massage</strong> among the given options.</p>\n<p>Central retinal artery occlusion (CRAO)<strong> </strong>occurs due to obstruction of the retinal artery at the level of<strong> lamina cribrosa</strong>. Risk factors include heart disease, carotid artery disease, mucormycosis, varicella infection, radiation exposure and trauma. It may be caused by the following:\u00a0</p>\n<ul>\n<li>Emboli of <strong>carotid artery </strong>or <strong>cardiac origin</strong> are the <strong>most common</strong> cause of CRAO. Other emboli are cholesterol emboli, calcium emboli, and platelet fibrin emboli</li>\n<li>Atherosclerosis-related thrombosis</li>\n<li>Retinal arteritis with obliteration</li>\n<li>Angiospasm</li>\n<li>Raised intraocular pressure</li>\n<li>Thrombophilic disorders</li>\n</ul>\n<p>Patients often present with sudden painless monocular loss of vision with history of a similar episode that resolved spontaneously (<strong>amaurosis fugax</strong>). On examination, <strong>d<span class=\"s1\"><strong>ir</strong>ect pupillary reflex </span></strong>is absent and <strong>r</strong><strong>elative afferent pupillary defect </strong>(RAPD) is positive. Fundus examination <span class=\"s1\">shows m</span>arked attenuation of arteries (thread like arteries), interrupted blood flow in vein (<strong>cattle track</strong>\u00a0<strong>appearance</strong>)<strong>, c</strong><strong>herry red spot</strong>,<strong> </strong>severe edema and retinal pallor.</p>\n<p>A <strong>cherry-red spot</strong> of the macula is typical and arises in this area because of the absence of ganglion cells at the foveola resulting in the transmission of the normal choroidal color. This in contrast to the surrounding area where intense retinal whitening blocks the transmission of the normal choroidal color.</p>\n<p><strong>Treatment </strong>is to dislodge the emboli by suddenly decreasing the IOP by <strong>IV acetazolamide</strong> or<strong> </strong>ocular massage.<strong> Ocular massage</strong>\u00a0is considered the <strong>most effective</strong> method. Other treatment options include IV mannitol, vasodilators (nitrates), fibrinolytic therapy, or laser photodisruption in some cases. In cases of giant cell arteritis, steroids are beneficial.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/664903b987d846ad963e0fbb5e38a5b6.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 2-year-old girl was evaluated for delayed developmental milestones. Fundus examination revealed the findings as shown in the image below. The abdominal examination is normal. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Krabbe's disease"
      },
      {
        "id": 2,
        "text": "Fabry's disease"
      },
      {
        "id": 3,
        "text": "Tay-Sachs disease"
      },
      {
        "id": 4,
        "text": "Gaucher's disease"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above clinical scenario with a fundus image showing a<strong> cherry-red spot</strong> at the macula is suggestive of <strong>Tay-Sachs disease</strong>.&nbsp;</p>\n<p><strong><span data-preserver-spaces=\"true\">Tay-Sachs disease</span></strong><span data-preserver-spaces=\"true\">&nbsp;is a lysosomal storage disorder due to the&nbsp;</span><strong><span data-preserver-spaces=\"true\">deficiency&nbsp;</span></strong><span data-preserver-spaces=\"true\">of the enzyme</span><strong><span data-preserver-spaces=\"true\">&nbsp;hexosaminidase A&nbsp;</span></strong><span data-preserver-spaces=\"true\">which</span><strong><span data-preserver-spaces=\"true\">&nbsp;degrades GM2 gangliosides. </span></strong><span data-preserver-spaces=\"true\">GM2 ganglioside accumulates more commonly in neurons of the <strong>central</strong> and <strong>autonomic nervous systems</strong> and <strong>retina.</strong></span></p>\n<p><span data-preserver-spaces=\"true\">Tay-Sachs disease is c</span><span data-preserver-spaces=\"true\">ommon among people from the Ashkenazi Jewish population. Affected infants usually present with loss of motor skills, exaggerated startle response to noise (<strong>hyperacusis</strong>), s</span><span data-preserver-spaces=\"true\">eizures, and m</span><span data-preserver-spaces=\"true\">acrocephaly without hydrocephalus.<br /></span></p>\n<p><span data-preserver-spaces=\"true\">On examination of the fundus, a&nbsp;<strong>cherry-red spot</strong> appears in the macula in almost all patients. </span><span data-preserver-spaces=\"true\">This is produced by the accentuation of the <strong>red color of the macular choroid</strong>, against the background of the rest of the retina appearing pale due to ganglion cells being swollen with GM2 ganglioside.</span></p>\n<p><span data-preserver-spaces=\"true\">Histopathological examination reveals <strong>ballooned-out neuronal tissue</strong> with<strong> vacuoles </strong>representing lysosomes filled with gangliosides.</span></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1f9c94e822e04800bcd9453556251c72.JPEG"
    ],
    "explanation_images": []
  }
];
        let quizName = 'Retinal Images Mini Test - -Tmt';
        const quizFilename = 'retinal-images-mini-test-tmt-4a6bee01.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2023-24"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>