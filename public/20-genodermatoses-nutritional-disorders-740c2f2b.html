<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20 Genodermatoses & Nutritional Disorders - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Dermatology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is a genodermal disease that can cause skin malignancies due to defective DNA repair?",
    "choices": [
      {
        "id": 1,
        "text": "Neurofibromatosis"
      },
      {
        "id": 2,
        "text": "Actinic keratosis"
      },
      {
        "id": 3,
        "text": "Xeroderma pigmentosa"
      },
      {
        "id": 4,
        "text": "Tuberous sclerosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Xeroderma pigmentosa </strong>is an <strong>autosomal recessive </strong>genodermal disease that&nbsp;occurs due to <strong>defective DNA repair </strong>as a result of defective nucleotide excision and repair pathway.</p>\n<p>It is characterized by <strong>severe photosensitivity,</strong>&nbsp;UV-induced skin and mucous membrane <strong>cancers,</strong> and neurodegeneration.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is incorrect regarding the given condition?",
    "choices": [
      {
        "id": 1,
        "text": "Fundus fluorescein angiography shows avascular peripheral retina"
      },
      {
        "id": 2,
        "text": "X-linked recessive inheritance"
      },
      {
        "id": 3,
        "text": "Miscarriage of affected male conceptuses"
      },
      {
        "id": 4,
        "text": "Cone-shaped teeth"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The characteristic finding of <strong>hyperpigmentation</strong> along&nbsp;<strong>Blaschko's</strong> lines is suggestive of <strong>i</strong><strong>ncontinentia pigmenti, </strong>an<strong> X linked dominant </strong>disorder<strong>.</strong>&nbsp;Blaschko's lines are the lines of normal embryological development of skin.&nbsp;</p>\n<p>It occurs due to <strong>loss-of-function mutation </strong>in IKBKG gene which encodes the nuclear factor kappa B essential modulator (<strong>NEMO</strong>), which is essential for protection against tumor necrosis factors.&nbsp;</p>\n<p>It usually affects females, as it is believed to be<strong> lethal in males</strong> in utero leading to miscarriage of the affected male conceptuses.<strong>&nbsp;</strong></p>\n<p>It is characterized by <strong>erythematous</strong> <strong>vesicular</strong> <strong>rash</strong> following Blaschko's lines, malformed<strong> cone-shaped teeth, onychodystrophy,</strong> and<strong> alopecia</strong>.</p>\n<p>The image given below shows cone-shaped teeth.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7ab50e44eac84d32a19707713593e09a.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fd19eede36a3487da4cc9428744748f6x1280x1094.0479548660085.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8c443877d856465aa28d1d2039a62d71x439x602.PNG"
    ]
  },
  {
    "text": "An anxious mother from rural India brings her 2-year-old boy with complaints of uncontrolled jerking of the left side of his body. She says that he has had the 'devil\u2019s stain' over the right side of his face since birth. She claims that the stain has been becoming larger and darker depicting the 'devil's strength increasing over time'. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Neurofibromatosis"
      },
      {
        "id": 2,
        "text": "Vein of Galen malformation"
      },
      {
        "id": 3,
        "text": "Hemangioma"
      },
      {
        "id": 4,
        "text": "Sturge-Weber syndrome"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The clinical scenario describes unilateral seizure activity with a port-wine stain, suggestive of <strong>Sturge&ndash;Weber syndrome (SWS),</strong>&nbsp;a severe neurocutaneous disorder.</p>\n<p>The port-wine stain is a&nbsp;<strong>vascular plaque </strong>(capillary malformation) over the lateral aspect of the forehead mainly involving the territory of ophthalmic(V1) and maxillary (V2) division of the <strong>trigeminal nerve.&nbsp;</strong>It presents with <strong>ipsilateral</strong> <strong>leptomeningeal</strong> <strong>angiomas</strong>&nbsp;and <strong>contralateral</strong> <strong>seizures&nbsp;</strong>or hemiparesis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/60872cd0e4564916b2aaedfc89055161x1280x1940.7616361071932.JPEG"
    ]
  },
  {
    "text": "Which of the following cutaneous disorders is not associated with a nucleotide excision repair defect?",
    "choices": [
      {
        "id": 1,
        "text": "Xeroderma pigmentosum"
      },
      {
        "id": 2,
        "text": "Cockayne syndrome"
      },
      {
        "id": 3,
        "text": "Trichothiodystrophy"
      },
      {
        "id": 4,
        "text": "Muir\u2013Torre syndrome"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Muir&ndash;Torre syndrome</strong> is a rare <strong>autosomal dominant</strong> disorder of <strong>DNA mismatch repair</strong>.</p>\n<p>It occurs due to mutation in one of the DNA mismatch repair genes (MSH\u20102, MLH\u20101, MSH\u20106).&nbsp;It is characterized by <strong>sebaceous gland neoplasms</strong>, <strong>keratoacanthomas</strong> associated with <strong>gastrointestinal</strong> and <strong>genito</strong><strong>urinary</strong> malignancies.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The given CT finding is associated with which of the following genodermal disorders?",
    "choices": [
      {
        "id": 1,
        "text": "Von- Hippel- Lindau syndrome"
      },
      {
        "id": 2,
        "text": "Sturge Weber syndrome"
      },
      {
        "id": 3,
        "text": "Tuberous sclerosis"
      },
      {
        "id": 4,
        "text": "Ataxia telangiectasia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The CT brain shows <strong>t</strong><strong>ram-track cortical calcifications,&nbsp;</strong>a characteristic feature of<strong> Sturge-Weber syndrome</strong>.</p>\n<p>It occurs due to<strong> leptomeningeal</strong> <strong>hemangioma,&nbsp;</strong>resulting in a <strong>vascular</strong> <strong>steal</strong>&nbsp;affecting the subjacent cortex and white matter producing localized ischemia and calcification.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/be9b2940237c423b8607eb8f47991247.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 17-year-old boy presented with the following skin finding. On inquiry, he also tells you that his father has similar complaints. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Tuberous sclerosis"
      },
      {
        "id": 2,
        "text": "Neurofibramatosis"
      },
      {
        "id": 3,
        "text": "Cowden syndrome"
      },
      {
        "id": 4,
        "text": "Gardner syndrome"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<ul>\n<li>Other cutaneous manifestations- include <strong>firm fibromatous plaques</strong>, especially on the forehead and scalp, soft pedunculated fibromas around the neck and axillae, and poliosis.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/546982aed7364476aecf65605eca02df.GIF"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b3ddf3ac3bd74a798f6f54f1d127dbeex1280x747.4188998589563.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7c3b6fdf9cf940debcb3de660eac25c6x1280x1100.3667136812412.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/da9ac3bb563c48cc96365acaeb01570dx512x669.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/86e8a5c0c46d4eeb925de76bb8d3377dx748x922.PNG"
    ]
  },
  {
    "text": "Button-hole sign can be seen in which of the following disorders?",
    "choices": [
      {
        "id": 1,
        "text": "Discoid lupus erythematosus"
      },
      {
        "id": 2,
        "text": "Von Recklinghausen's disease"
      },
      {
        "id": 3,
        "text": "Tuberous sclerosis"
      },
      {
        "id": 4,
        "text": "Xeroderma pigmentosum"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Buttonhole sign</strong> is seen in type 1 neurofibromatosis (<strong>Von Recklinghausen's\u00a0disease</strong>).</p>\n<p>Neurofibromas can be <strong>invaginated</strong> into the <strong>subcutis\u00a0</strong>with the tip of the index finger back and they\u00a0<strong>reappear after</strong> the<strong>\u00a0pressure</strong> is<strong> released. </strong>This is the buttonhole sign.</p>\n<p>This sign is also <strong>positive</strong> in<strong>\u00a0anetoderma</strong> and<strong> dermatofibroma.</strong></p>\n<p>The image below shows a dermatofibroma.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/81f0a4ede06c4f85ad9038ad71cdf85cx1280x1100.3667136812412.JPEG"
    ]
  },
  {
    "text": "A male patient comes with complaints of dry skin over his legs appearing as shown below. On examination, hyperlinear palms are noted. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Psoriasis"
      },
      {
        "id": 2,
        "text": "X-linked recessive ichthyosis"
      },
      {
        "id": 3,
        "text": "Nummular eczema"
      },
      {
        "id": 4,
        "text": "Ichthyosis vulgaris"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The image shows&nbsp;<strong>fish-like scales</strong> with dry skin, characteristically seen in <strong>ichthyosis</strong>&nbsp;<strong>vulgaris</strong>&nbsp;(icthyos<strong>-</strong>fish).</p>\n<p>Ichthyosis vulgaris is an <strong>autosomal dominant</strong> disorder, that occurs due to <strong>reduced</strong> or <strong>absence</strong> of <strong>filaggrin</strong> protein and granular layer.&nbsp;It occurs when the skin does not shed the dead skin cells. This leads to dry, dead skin cells that accumulate in <strong>small</strong> <strong>patches</strong> on the surface, especially on the <strong>arms</strong> and <strong>legs</strong>.&nbsp;It&rsquo;s also called the 'fish scale disease'.&nbsp;</p>\n<table style=\"width: 574px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"width: 93px; height: 18px;\"><strong>Features</strong></td>\n<td style=\"width: 205px; height: 18px;\"><strong>Ichthyosis Vulgaris</strong></td>\n<td style=\"width: 254px; height: 18px;\"><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;XLR-Ichthyosis</strong></td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 93px; height: 18px;\">Defect</td>\n<td style=\"width: 205px; height: 18px;\">Filaggrin protein</td>\n<td style=\"width: 254px; height: 18px;\">Steroid sulphatase enzyme</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"width: 93px; height: 18px;\">Scales</td>\n<td style=\"width: 205px; height: 18px;\">Fine scales</td>\n<td style=\"width: 254px; height: 18px;\">Dark plate-like adherent scales</td>\n</tr>\n<tr style=\"height: 36px;\">\n<td style=\"width: 93px; height: 36px;\">Spared areas</td>\n<td style=\"width: 205px; height: 36px;\">Flexors and face</td>\n<td style=\"width: 254px; height: 36px;\">Palms and soles</td>\n</tr>\n<tr style=\"height: 79px;\">\n<td style=\"width: 93px; height: 79px;\">Associations</td>\n<td style=\"width: 205px; height: 79px;\">\n<p>Keratosis pilaris&nbsp;</p>\n<p>Hyperlinear palms</p>\n</td>\n<td style=\"width: 254px; height: 79px;\">\n<p>Corneal opacities</p>\n<p>Cryptorchidism</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d4eb4fa31ea4469e9ba7b339e7623cbb.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A male child with cryptorchidism presents with large dirty brown scales on body flexures. Workup revealed steroid sulfatase deficiency. What is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Ichthyosis vulgaris"
      },
      {
        "id": 2,
        "text": "Lamellar ichthyosis"
      },
      {
        "id": 3,
        "text": "X-linked recessive ichthyosis"
      },
      {
        "id": 4,
        "text": "Non - bullous ichthyosiform erythroderma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>&nbsp;</strong><strong>X</strong>-<strong>linked recessive ichthyosis&nbsp;</strong>is a disease affecting only <strong>males</strong> and presenting with large, generalized <strong>dirty&nbsp;brown-black scales</strong> encroaching <strong>flexures</strong> along with <strong>cryptorchidism</strong>.</p>\n<p>It is due to a mutation in the&nbsp;<strong>STS gene</strong> encoding steroid sulfatase.&nbsp;</p>\n<p>At the age of <strong>2&ndash;6 months</strong>, usually large thick dark brown to yellow\u2010brown hyperkeratosis&nbsp;develop covering the trunk, the extremities and the neck.&nbsp;Skin biopsy shows <strong>hyperkeratosis</strong> with <strong>hypergranulosis</strong>.&nbsp;Palms, soles, and larger flexures are <strong>spared</strong>.&nbsp;Deep stromal <strong>corneal opacity</strong> is a frequent finding.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d4843d86ac2445bf8d0308764696d674x1280x1195.148095909732.JPEG"
    ]
  },
  {
    "text": "A child was born with membranes around the body and had ectropion and eclabium. He is brought to the OPD with lesions covering his face, trunk, and extremities. Which of the following is an unlikely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Ichthyosis vulgaris"
      },
      {
        "id": 2,
        "text": "Lamellar ichthyosis"
      },
      {
        "id": 3,
        "text": "Bathing suit ichthyosis"
      },
      {
        "id": 4,
        "text": "Harlequin ichthyosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical picture shows a neonate encased in a <strong>shiny, parchment-like membrane</strong> (collodion baby) suggestive of a disorder belonging to the <strong>autosomal recessive congenital ichthyosis spectrum</strong>.</p>\n<p>Ichthyosis vulgaris is not a part of this disease spectrum. It <strong>does not present at birth</strong> and is therefore an unlikely diagnosis.<br /> <br /><strong>Ichthyosis vulgaris</strong> is an <strong>autosomal dominant</strong> condition caused due to a mutation in the <strong>filaggrin gene (FLG).</strong> It develops in the first few months of life. Patients exhibit <strong>accentuated palmar </strong>and<strong> plantar creases</strong> and have <strong>dry scaly skin</strong>. The scales appear light grey and cover the extensor surfaces of the limbs and the trunk. It usually spares the groin and larger flexures.&nbsp;Immunohistochemistry reveals an <strong>absent </strong>or<strong> markedly reduced filaggrin</strong> signal. </p>\n<p>Autosomal recessive congenital ichthyosis spectrum includes the following:</p>\n<ul>\n<li>Harlequin ichthyosis (HI)</li>\n<li>Bathing suit ichthyosis (BSI)</li>\n<li>Lamellar ichthyosis (LI)</li>\n<li>Congenital ichthyosiform erythroderma (CIE)</li>\n<li>Self- improving congenital ichthyosis (SICI)</li>\n<li>Transient manifestations, such as collodion baby.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/2596aff9ba73469ba2ac5201630db157.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the incorrect statement regarding this condition.",
    "choices": [
      {
        "id": 1,
        "text": "X-linked recessive inheritance"
      },
      {
        "id": 2,
        "text": "May progress to lamellar icthyosis"
      },
      {
        "id": 3,
        "text": "May progress to bathing suit icthyosis"
      },
      {
        "id": 4,
        "text": "Peels off within 4 weeks of life"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>A neonate encased in a<strong> shiny parchment\u2010like membrane&nbsp;</strong>is&nbsp;called a<strong>&nbsp;collodion baby</strong>. It is the presentation for all <strong>autosomal recessive</strong> congenital ichthyoses (except for Harlequin ichthyosis).&nbsp;</p>\n<p>The membrane usually <strong>peels</strong> off within the first <strong>4 weeks </strong>of life.&nbsp;Initially, the clinical presentation can be quite severe and often includes <strong>ectropion </strong>and<strong> everted lips</strong> of different degrees. This later clears.</p>\n<p>Collodion babies look alike at birth, but later take different clinical courses such as:</p>\n<ul>\n<li><strong>Lamellar ichthyosis</strong>&nbsp;-&nbsp;shedding of the collodion membrane is followed by development of large dark grey/brownish scales affecting the trunk and scalp, but sparing the face and extremities</li>\n<li><strong>Bathing suit ichthyosis - </strong>develop a lamellar type of ichthyosis that spares the face and the extremities and follows a bathing suits distribution&nbsp;</li>\n<li>Congenital ichthyosiform erythroderma</li>\n<li>Self\u2010healing collodion baby&nbsp;</li>\n<li>Acral self\u2010healing collodion baby</li>\n</ul>\n<p>Note: That several syndromic types of congenital ichthyosis such as trichothiodystrophy or Gaucher syndrome type 2&nbsp;also typically present as collodion baby.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/abe391454105426c98ce3b9ce1c49134.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "The ocular condition shown below is associated with:",
    "choices": [
      {
        "id": 1,
        "text": "Xeroderma pigmentosa"
      },
      {
        "id": 2,
        "text": "Incontinentia pigmenti"
      },
      {
        "id": 3,
        "text": "Neurofibromatosis"
      },
      {
        "id": 4,
        "text": "Louis-Bar syndrome"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shows <strong>Lisch&rsquo;s nodules</strong>,&nbsp;the most common ocular manifestation of&nbsp;<strong>neurofibromatosis type 1.&nbsp; </strong></p>\n<p>These are&nbsp;<strong>melanocytic hamartomas</strong>, which are usually <strong>brown</strong> or<strong> yellow</strong> in color. They are found&nbsp;as round elevations on the surface of the<strong> iris,&nbsp;</strong>often visible to the naked eye. However, optimal evaluation is done by<strong>&nbsp;slit-lamp examination</strong>.&nbsp;</p>\n<p>They do not produce visual impairment.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4e36df327d5f43c8892815ae4e580666.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the incorrect statement regarding the condition shown below.",
    "choices": [
      {
        "id": 1,
        "text": "Six or more cafe-au-lait macules form the part of diagnostic criteria"
      },
      {
        "id": 2,
        "text": "Confetti skin lesions can be seen in this condition"
      },
      {
        "id": 3,
        "text": "Axillary freckling is pathognomonic"
      },
      {
        "id": 4,
        "text": "Tibial pseudoarthrosis can be seen"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image below shows neurofibromatosis: axillary freckling and&nbsp;caf&eacute;-au-lait spots.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/62294a4113b343cb8b8f8a698ef19296.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9df2178457e44452b5f3bc6e29b8ee8bx358x269.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/98241c9645634e29bc4e8991d49fe5b6x512x254.PNG"
    ]
  },
  {
    "text": "The image shows certain changes in the conjunctiva commonly found in a DNA repair defect syndrome. What is the first clinical manifestation of this disease?",
    "choices": [
      {
        "id": 1,
        "text": "Caf\u00e9\u2010au\u2010lait spot"
      },
      {
        "id": 2,
        "text": "Premature hair greying"
      },
      {
        "id": 3,
        "text": "Insulin resistance"
      },
      {
        "id": 4,
        "text": "Progressive cerebellar degeneration"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given image shows <strong>multiple telangiectasias</strong> of conjunctival vessels. This along with DNA repair defect point towards&nbsp;<strong>ataxia-telangiectasia</strong>&nbsp;(AT) or Louis&ndash;Bar syndrome.&nbsp;<strong>Progressive cerebellar degeneration</strong> is the first <strong>clinical manifestation</strong> in ataxia-telangiectasia, presenting at about 1 year of age.</p>\n<p>AT is a rare <strong>autosomal-recessive</strong> disorder. There is&nbsp;<strong>chromosomal instability</strong>&nbsp;due to inactivating mutations in the <strong><em>ATM</em></strong> gene. The ATM protein kinase plays a key role in the control of double-strand break DNA repair.</p>\n<p>It is a <strong>multisystem</strong> disorder characterized by ataxia and mucocutaneous telangiectasia. <strong>Cutaneous features</strong> include:&nbsp;</p>\n<ul>\n<li>Telangiectasias - initially conjunctival, most prominent on&nbsp;face</li>\n<li>Premature hair greying</li>\n<li>Caf&eacute;\u2010au\u2010lait spots</li>\n<li>Pigmentary changes -&nbsp;poikiloderma.</li>\n</ul>\n<p>Other cardinal features of AT are:</p>\n<ul>\n<li>Immunodeficiency - increased susceptibility to infections</li>\n<li>Hypogonadism</li>\n<li>Sensitivity to ionizing radiation</li>\n<li><strong>Insulin resistance </strong></li>\n<li>Predisposition to cancer</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b4cc3d885a0545aebea87449b6058906.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following conditions resolve spontaneously in an infant except:",
    "choices": [
      {
        "id": 1,
        "text": "Pustular melanosis"
      },
      {
        "id": 2,
        "text": "Epstein pearls"
      },
      {
        "id": 3,
        "text": "Cutis marmorata"
      },
      {
        "id": 4,
        "text": "Port wine stain"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Port-wine stain </strong>represents <strong>progressive ectasia</strong> of superficial vascular plexus mostly involving the face. It <strong>does not resolve spontaneously</strong> and is usually treated by a 585 nm <strong>pulsed dye laser</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2ff136c533da46809a1e8615c5c9afa2x1280x959.5486600846262.JPEG"
    ]
  },
  {
    "text": "Deficiency of which of the following nutrients will not cause the finding shown in the image given below?",
    "choices": [
      {
        "id": 1,
        "text": "Essential fatty acids"
      },
      {
        "id": 2,
        "text": "Vitamin A"
      },
      {
        "id": 3,
        "text": "Vitamin C"
      },
      {
        "id": 4,
        "text": "Vitamin D"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The image shows <strong>phrynoderma. </strong>It is <strong>not</strong> associated with<strong> vitamin D deficiency</strong>.</p>\n<p>Phrynoderma (<strong>toad skin</strong>) is common in children in the 5-15 year age group. Earlier thought to be purely due to vitamin A deficiency, phrynoderma has now been associated with other nutritional deficiencies, including those of&nbsp;<strong>B complex</strong>, <strong>ribofla&shy;vin, vitamin C, vitamin E, </strong>and<strong> essential fatty acids&nbsp;</strong>and<strong> malnutrition.</strong></p>\n<p>It is a non-specific finding that can be associated with various conditions:&nbsp;</p>\n<div class=\"page\" title=\"Page 2188\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>&bull; Liver cirrhosis<br /> &bull; Malabsorption syndromes<br /> &bull; Anorexia nervosa<br /> &bull; Alcohol abuse<br /> &bull; Nutritional deficiency following bariatric surgery</p>\n</div>\n</div>\n</div>\n</div>\n<p>It manifests as <strong>groups of papules</strong>, each one around 3-4 mm in diameter, with a <strong>central keratotic plug</strong>.&nbsp;The papules have a <strong>follicular distribution</strong> and give the skin a rough texture.&nbsp;The <strong>elbows</strong> and<strong> knees</strong> are the<strong> most commonly</strong> affected areas, but the buttocks and extensor surfaces of the limbs may also be affected.</p>\n<p>All patients with phrynoderma should have their vitamin A levels measured.&nbsp;</p>\n<p>Treatment involves the correction of poor diet and administration of&nbsp;<strong>multivitamin</strong> preparations.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c766318622f84b2c9588319ddfa74bda.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A child is brought to pediatric OPD with the given skin condition. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Marasmus"
      },
      {
        "id": 2,
        "text": "Pellagra"
      },
      {
        "id": 3,
        "text": "Vitamin A deficiency"
      },
      {
        "id": 4,
        "text": "Kwashiorkor"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Option C: Phrynoderma or toad skin is seen in vitamin A deficiency. It is seen in deficiency of vitamin B complex, C, E, and essential fatty acids as well.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e18bfe7c44fd4a34a0dd7ef989788e39.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6db868f262a84e509de08311f3a7b425x1280x1787.664079040226.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0d3e554afdc2445bbe9104082c8e2179x1280x1266.459802538787.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/41f98247e0d44fedbd428ad1bfe67580x720x449.PNG"
    ]
  },
  {
    "text": "A 4-year-old boy has been brought to you by his parents with the following skin lesions. Which of the following is not true regarding this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Autosomal recessive inheritance"
      },
      {
        "id": 2,
        "text": "Due to zinc deficiency and reverses with zinc supplement"
      },
      {
        "id": 3,
        "text": "Triad of dermatitis, dementia and diarrhoea"
      },
      {
        "id": 4,
        "text": "Mutation of SLC39A4 gene"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The image shows<strong> acrodermatitis enteropathica.&nbsp;</strong>It is classically&nbsp;associated with:&nbsp;</p>\n<ol>\n<li>Diarrhea</li>\n<li>Alopecia</li>\n<li>Periorificial and acral cutaneous eruptions.</li>\n</ol>\n<p><strong>Zinc deficiency</strong> can be inherited (acrodermatitis enteropathica) or acquired.</p>\n<p>Acrodermatitis enteropathica is an <strong>autosomal</strong> <strong>recessive</strong> disorder caused by a mutation in the <strong>intestinal</strong> <strong>zinc</strong> <strong>transporter</strong> <strong>gene</strong>,&nbsp;<strong>SLC39A4</strong>,&nbsp;which leads to deficiency of zinc.&nbsp;</p>\n<p>Children commonly present with <strong>symmetrical, eczematous plaques</strong> that become vesicular, bullous, pustular or erosive with characteristic crusting at the edges.&nbsp;The perioral eruption usually spares the upper lip, giving it a &lsquo;U\u2010shaped&rsquo; or &lsquo;horseshoe\u2010shaped&rsquo; appearance.&nbsp;</p>\n<p><strong>Zinc supplementation</strong> rapidly improves the condition within 24 to 48 hours. If untreated, it maybe fatal.</p>\n<p><strong>Mnemonic</strong>: <strong>DEAL</strong> for acrodermatitis enteropathica:&nbsp;</p>\n<ul>\n<li><strong>D</strong>iarrhoea</li>\n<li><strong>E</strong>czematous dermatitis</li>\n<li><strong>A</strong>lopecia</li>\n<li><strong>L</strong>ethargy</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9da1785bd29e4f6887ad71916633300a.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Identify the skin condition shown in this photograph of a newborn.",
    "choices": [
      {
        "id": 1,
        "text": "Icthyosis vulgaris"
      },
      {
        "id": 2,
        "text": "Bathing suit icthyosis"
      },
      {
        "id": 3,
        "text": "Harlequin ichthyosis"
      },
      {
        "id": 4,
        "text": "Lamellar ichthyosis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The neonate is most likely suffering from<strong> Harlequin ichthyosis</strong>, as evidenced by the presence of <strong>armor-like skin</strong>.</p>\n<p>It<strong>\u00a0</strong>is the most devastating type of <strong>a</strong><strong>utosomal recessive congenital icthyosis</strong>. It is due to mutations of the <strong>ABCA12 gene</strong>. The gene plays a role in lamellar body formation in the stratum granulosum and desquamation of the stratum corneum.\u00a0</p>\n<p>It presents in the neonatal period with <strong>armor\u2010like skin</strong> (truncal plates with fissuring). It can impair body movement and breathing. <strong>Bilateral ectropion</strong> and <strong>eclabium</strong> are present. <strong>Respiratory problems</strong> are the major cause of death due to alveolar collapse in neonates. They are also prone to skin and lung infections.</p>\n<p><strong>Defective lamellar bodies</strong> in the <strong>stratum granulosum</strong> seen in <strong>electron microscopy</strong> are pathognomic of Harlequin ichthyosis. In early life, constant <strong>supportive care</strong> is required. Treatment includes <strong>moisturizing cream</strong>, <strong>antibiotics</strong>, <strong>etretinate</strong>, or <strong>retinoids</strong>.</p>\n<p>Other options -\u00a0</p>\n<p>Option A) <strong>Ichthyosis vulgaris</strong> - The <strong>most common</strong> type of ichthyosis, involving mutations in <strong>filaggrin protein</strong>. Filaggrin is an<strong> epidermal protein</strong> that\u00a0helps <strong>retain moisture</strong> in the <strong>stratum corneum</strong>. Ichthyosis is <strong>not present at birth</strong> but develops during the first months of life.\u00a0The<strong> scaling</strong> usually involves the <strong>extensor surfaces</strong> of the extremities with <strong>flexural sparing</strong>.\u00a0They are <strong>strongly correlated</strong> with<strong> atopic dermatitis</strong> and other forms of atopy such as allergic rhinitis, asthma, etc.</p>\n<p>Option B) <strong>Bathing suit ichthyosis </strong>is a type of congenital ichthyosis caused by mutations in the TGM1 gene. It presents as a <strong>collodion baby</strong> at birth where the neonate is encased in a <strong>shiny parchment\u2010like membrane. </strong>Shedding of the collodion membrane is followed by the development of <strong>large dark grey/brownish scales</strong> affecting the<strong> trunk </strong>and the <strong>scalp</strong>, but sparing the face and extremities resembling a <strong>bathing suit</strong>. The disease tends to become worse in the summer months and improves in winter.</p>\n<p>Option D) <strong>Lamellar ichthyosis</strong> is also a congenital ichthyosis, involving mutations in the <strong>TGM1 gene</strong>. It is characterized by large plate\u2010like <strong>dark\u2010brown hyperkeratoses</strong> covering the <strong>entire body</strong> with <strong>mild palmoplantar </strong>involvement. The extreme spectrum of lamellar ichthyosis is <strong>congenital ichthyosiform erythroderma (CIE)</strong> which is similar to erythroderma seen in psoriasis.\u00a0</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/6b756e8781a7469584bd704e7695a65e.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 4-month-old boy presents with hypotonia, seizures, and failure to thrive.  The mother reports that his hair started to appear short, lusterless, and thin when he was 2-months-old. A trichogram of his scalp hair is as shown. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Kwashiorkor"
      },
      {
        "id": 2,
        "text": "Keshan's disease"
      },
      {
        "id": 3,
        "text": "Menke's disease"
      },
      {
        "id": 4,
        "text": "Zinc deficiency"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image shows <strong>pili torti</strong> seen in <strong>Menke's syndrome</strong> or trichopoliodystrophy or steely hair disease.</p>\n<p>Pili torti refers to hair showing <strong>180-degree twists</strong> under the microscope. Scalp and eyebrow hair appear <strong>short, sparse, lustreless, tangled,\u00a0</strong>and<strong> depigmented</strong>. Hair changes can be the first sign of disease at 1\u20132 months of age.</p>\n<p>It is an <strong>X\u2010linked recessive</strong> disorder. At 2\u20133 months of age, children with Menke's disease present with:\u00a0</p>\n<ul>\n<li>Loss of developmental milestones</li>\n<li>Hypotonia</li>\n<li>Seizures</li>\n<li>Failure to thrive</li>\n<li><strong>Cherubic appearance -\u00a0</strong>depressed nasal bridge, pudgy cheeks, <strong>\u2018cupids bow\u2019</strong> upper lip, and doughy skin.</li>\n</ul>\n<p>Option A: In kwashiorkor, hair\u00a0develops a lustreless, <strong>red\u2010brown color</strong> that may show alternation with more normal color; this so\u2010called \u2018<strong>flag sign\u2019</strong> corresponds to alternating periods of significant undernutrition and improved nutrition.</p>\n<p>Option B: <strong>Selenium</strong> deficiency presents as\u00a0brittle hair and may be associated with <strong>exfoliative dermatitis</strong> on the scalp.</p>\n<p>Option D: In <strong>zinc</strong> deficiency, hair is <strong>dry and brittle</strong>, and large areas of alopecia may arise.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/812665378ea04220b95e9649c3cac9ef.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "While examining a malnourished patient admitted in the ward, you note the following finding. What is the most likely deficiency?",
    "choices": [
      {
        "id": 1,
        "text": "Vitamin A"
      },
      {
        "id": 2,
        "text": "Vitamin B12"
      },
      {
        "id": 3,
        "text": "Vitamin C"
      },
      {
        "id": 4,
        "text": "Vitamin D"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given image shows&nbsp;<strong>corkscrew-like hair</strong>&nbsp;and the <strong>perifollicular purpura</strong>,<strong>&nbsp;</strong>characteristic of<strong>&nbsp;vitamin C deficiency</strong> o<strong>r</strong> scurvy.<strong>&nbsp;</strong></p>\n<p>Scurvy develops 1&ndash;3 months after a vitamin C deficient diet.&nbsp;The cutaneous manifestations of scurvy include:&nbsp;</p>\n<ul>\n<li><strong>Phrynoderma</strong></li>\n<li>Corkscrew hairs -&nbsp; fractured and coiled hairs due to impaired keratin cross\u2010links by disulfide bonds</li>\n<li>Perifollicular hemorrhage and purpura</li>\n<li>Lower limb edema&nbsp;</li>\n<li>Splinter hemorrhages</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5e1941a8cc5141039a78b8b193ae3257.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A mother brings her infant to you with the given finding. Which of the following is not a feature of this hypervitaminosis?",
    "choices": [
      {
        "id": 1,
        "text": "Mucous membranes are involved"
      },
      {
        "id": 2,
        "text": "Pseudotumor cerebri maybe seen"
      },
      {
        "id": 3,
        "text": "Pathological bone fractures"
      },
      {
        "id": 4,
        "text": "Pigmentation of the face, palms, and soles"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This image shows&nbsp;<strong>carotenoderma </strong>(of the nose), associated with <strong>hypervitaminosis</strong> <strong>A</strong>. <strong>Mucous membranes</strong> are <strong>uninvolved </strong>in this condition.<br /><br /> Carotenoderma is a condition associated with&nbsp;hypervitaminosis A. It is characterized by prominent <strong>yellow\u2010orange pigmentation</strong> of the <strong>face, palms, </strong>and<strong> soles</strong> of the feet. It can mimic jaundice and medication\u2010induced pigmentation, but unlike jaundice, carotenoderma spares the mucous membranes.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/a9a4f1986af248528dc9cd4801cdd683.JPEG"
    ],
    "explanation_images": []
  }
];
        let quizName = '20 Genodermatoses & Nutritional Disorders';
        const quizFilename = '20-genodermatoses-nutritional-disorders-740c2f2b.html';
        let hierarchy = ["Marrow", "qBank", "Dermatology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>