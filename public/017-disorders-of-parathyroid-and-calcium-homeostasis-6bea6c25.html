<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>017 Disorders Of Parathyroid And Calcium Homeostasis - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">22</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Hypercalcemia is associated with all of the following medical conditions except:",
    "choices": [
      {
        "id": 1,
        "text": "Multiple myeloma"
      },
      {
        "id": 2,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 3,
        "text": "Sarcoidosis"
      },
      {
        "id": 4,
        "text": "Hypothyroidism"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hypercalcemia</strong> is associated with all of the following conditions <strong>except hypothyroidism</strong>. Hyperthyroidism is however associated with hypercalcemia.</p>\n<p>Other options:</p>\n<p>1) <strong>Multiple myeloma</strong> is a hemotological malignancy associated with hypercalcemia.</p>\n<p>2) <strong>Hyperparathyroidism</strong> is associated with sub-periosteal bone resorption resulting in hypercalcemia.</p>\n<p>3)&nbsp;<strong>&nbsp;Sarcoidosis&nbsp;</strong>is associated with hypercalcemia due to increased activity of 1 alpha hydroxylase activity in the macrophages.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following can cause hypercalcemia in a patient?",
    "choices": [
      {
        "id": 1,
        "text": "Vitamin D deficiency"
      },
      {
        "id": 2,
        "text": "Amyloidosis"
      },
      {
        "id": 3,
        "text": "Vitamin A intoxication"
      },
      {
        "id": 4,
        "text": "Vitamin C intoxication"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Vitamin A intoxication</strong> can cause <strong>hypercalcemia.&nbsp;</strong>This is&nbsp;due to <strong>high bone turnover</strong>. Ingestion of 50,000&ndash;100,000 units of Vitamin A daily can increase calcium levels up to 12&ndash;14 mg/dL.</p>\n<p>Note:<strong> Vitamin D</strong> intoxication also leads to hypercalcemia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 66-year-old woman is brought to the emergency department after being found unconscious by her neighbors. She is found to have marked dehydration and serum calcium levels of 16 mg/dl. All of the following can cause this presentation except:",
    "choices": [
      {
        "id": 1,
        "text": "Metastatic breast carcinoma"
      },
      {
        "id": 2,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 3,
        "text": "Pancreatitis"
      },
      {
        "id": 4,
        "text": "Hodgkin\u2019s lymphoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>This clinical scenario with&nbsp;<strong>severe</strong> <strong>hypercalcemia</strong>&nbsp;(<strong>&gt; 14.8 </strong>mg/dl) is suggestive of a <strong>hypercalcemic crisis</strong>. <strong>Pancreatitis</strong> causes&nbsp;<strong>hypocalcemia</strong>,&nbsp;not hypercalcemia.<strong>&nbsp;</strong></p>\n<p>Hypercalcemic crisis is often caused by&nbsp;<strong>malignancies</strong>&nbsp;due to an acute rise in calcium levels following bone resorption due to metastases.<strong>&nbsp;</strong>It is<strong>&nbsp;</strong>a <strong>medical emergency</strong> that presents with polyuria, <strong>severe dehydration</strong>, gastrointestinal symptoms, and <strong>altered consciousness</strong>. It can lead to cardiac arrest and coma.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following will not be seen in a patient with hypercalcemia?",
    "choices": [
      {
        "id": 1,
        "text": "Polyuria"
      },
      {
        "id": 2,
        "text": "Diarrhoea"
      },
      {
        "id": 3,
        "text": "Depression"
      },
      {
        "id": 4,
        "text": "Vomiting"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Hypercalcemia</strong> is associated with <strong>constipation</strong> and not diarrhea.</p>\n<p>Clinical manifestations of hypercalcemia include:</p>\n<table style=\"height: 348px; width: 322px;\">\n<tbody>\n<tr>\n<td style=\"width: 113px; text-align: center;\"><strong>System</strong></td>\n<td style=\"width: 195px; text-align: center;\"><strong>Clinical features</strong></td>\n</tr>\n<tr>\n<td style=\"width: 113px;\" rowspan=\"4\">Renal</td>\n<td style=\"width: 195px;\">Renal stones (Calcium oxalate &gt; calcium phosphate)</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Nephrocalcinosis</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\"><strong>Polyuria</strong> and dehydration</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Renal failure</td>\n</tr>\n<tr>\n<td style=\"width: 113px;\" rowspan=\"3\">Musculoskeletal</td>\n<td style=\"width: 195px;\">Bone pain, bone cysts</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Myalgia and arthralgia</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Osteopenia, osteoporosis</td>\n</tr>\n<tr>\n<td style=\"width: 113px;\" rowspan=\"5\">GIT</td>\n<td style=\"width: 195px;\"><strong>Constipation</strong></td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Nausea, <strong>vomiting</strong>, anorexia</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Abdominal pain</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Peptic ulcer disease</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Acute pancreatitis</td>\n</tr>\n<tr>\n<td style=\"width: 113px;\" rowspan=\"3\">Neuropsychiatric</td>\n<td style=\"width: 195px;\">Anxiety, <strong>depression</strong>, fatigue</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Cognitive dysfunction</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Drowsiness, obtundation, coma</td>\n</tr>\n<tr>\n<td style=\"width: 113px;\" rowspan=\"2\">Cardiac</td>\n<td style=\"width: 195px;\">Short QT interval, bradycardia</td>\n</tr>\n<tr>\n<td style=\"width: 195px;\">Hypertension</td>\n</tr>\n<tr>\n<td style=\"width: 113px;\">Others</td>\n<td style=\"width: 195px;\">Ectopic calcification&nbsp;</td>\n</tr>\n</tbody>\n</table>\n<p>The clinical signs associated with primary hyperparathyroidism can be remembered with the mnemonic '<strong>stones, bones, abdominal groans, psychic moans'.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not seen in patients following excessive intake of calcium?",
    "choices": [
      {
        "id": 1,
        "text": "Chronic renal failure"
      },
      {
        "id": 2,
        "text": "Milk-alkali syndrome"
      },
      {
        "id": 3,
        "text": "Burnett's syndrome"
      },
      {
        "id": 4,
        "text": "Restrictive cardiomyopathy"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Excess calcium ingestion is <strong>not associated</strong> with <strong>restrictive cardiomyopathy</strong>. It results in<strong>&nbsp;milk-alkali syndrome,</strong>&nbsp;commonly associated with&nbsp;excessive intake of absorbable antacids such as<strong> milk </strong>or<strong> calcium carbonate</strong>.</p>\n<p>In susceptible individuals, there is a loss of negative feedback, leading to <strong>excess calcium absorption</strong> when there is excess intake. It results in the following triad of clinical features:</p>\n<ul>\n<li>Hypercalcemia&nbsp;</li>\n<li>Alkalosis - due to HCO3 reabsorption caused by PTH suppression, natriuresis, and water depletion.</li>\n<li><strong>Renal failure&nbsp;</strong>- due to damage to renal tubules.</li>\n</ul>\n<p>It is reversible once ingestion of antacid is stopped. However, in severe cases, a chronic form called&nbsp;<strong>Burnett&rsquo;s syndrome&nbsp;</strong>can develop. It is associated with <strong>irreversible renal damage.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of primary hyperparathyroidism?",
    "choices": [
      {
        "id": 1,
        "text": "Parathyroid hyperplasia"
      },
      {
        "id": 2,
        "text": "Parathyroid adenoma"
      },
      {
        "id": 3,
        "text": "MEN 1 syndrome"
      },
      {
        "id": 4,
        "text": "Iatrogenic conditions"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Parathyroid adenomas</strong> are the most common cause of <strong>primary hyperparathyroidism</strong>.</p>\n<p>Causes of primary hyperparathyroidism:</p>\n<ul>\n<li>Parathyroid adenomas: These maybe\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Solitary (more common)&nbsp;</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Multiple&nbsp;</li>\n<li style=\"font-weight: 400;\" aria-level=\"1\">Part of MEN-1, MEN-2A or MEN-4</li>\n</ul>\n</li>\n<li>Chief cell parathyroid hyperplasia</li>\n<li>Parathyroid gland carcinoma</li>\n<li>Lithium use</li>\n<li>Hyperparathyroidism-jaw tumor (HPT-JT) syndrome</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following sets of lab values will be seen in a patient with secondary hyperparathyroidism?",
    "choices": [
      {
        "id": 1,
        "text": "Option 3"
      },
      {
        "id": 2,
        "text": "Option 1"
      },
      {
        "id": 3,
        "text": "Option 4"
      },
      {
        "id": 4,
        "text": "Option 2"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Secondary&nbsp;</strong><strong>hyperparathyroidism</strong> presents with <strong>decreased calcium</strong> and <strong>increased</strong> levels of <strong>PTH</strong>, <strong>phosphate</strong>, and <strong>ALP</strong>.</p>\n<p>In this condition, calcium deficiency leads to reactive stimulation of the parathyroid. It is caused by the following:</p>\n<ul>\n<li>Chronic kidney disease</li>\n<li>Vitamin D deficiency</li>\n<li>Gastrointestinal malabsorption</li>\n<li>Liver disease</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/11928fe152444e8e988fe5d8922d3611.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following statements are true about primary hyperparathyroidism except:",
    "choices": [
      {
        "id": 1,
        "text": "It causes prolongation of QT interval"
      },
      {
        "id": 2,
        "text": "Asymptomatic disease can occur"
      },
      {
        "id": 3,
        "text": "Peptic ulcer disease is seen"
      },
      {
        "id": 4,
        "text": "Hyperuricemia can occur"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Primary hyperparathyroidism</strong> (PHPT) causes <strong>shortening</strong> of the<strong> QT interval</strong>.</p>\n<p>The <strong>asymptomatic&nbsp;</strong>form is the <strong>most common</strong>&nbsp;presentation in the&nbsp;<strong>Western</strong> population. But in developing countries, the patients are usually symptomatic.&nbsp;The classical symptoms and signs of PHPT&nbsp;are due to hypercalcemia as well as increased parathyroid hormone (PTH) levels.</p>\n<p>The features of <strong>hypercalcemia</strong> are as follows:</p>\n<table style=\"width: 416.828125px;\">\n<tbody>\n<tr>\n<td style=\"width: 136px;\"><strong>System</strong></td>\n<td style=\"width: 275.828125px;\"><strong>Clinical features</strong></td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">Musculoskeletal</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li>Bone pain</li>\n<li>Skeletal deformities</li>\n<li>Pathological fractures</li>\n<li>Myalgia and arthralgia</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">Renal</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li>Renal stones(Calcium oxalate &gt; calcium phosphate)</li>\n<li>Nephrocalcinosis</li>\n<li>Polyuria and dehydration</li>\n<li>Renal failure</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">GIT</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li>Constipation</li>\n<li>Nausea, vomiting, anorexia</li>\n<li>Abdominal pain</li>\n<li><strong>Peptic ulcer disease</strong></li>\n<li>Acute pancreatitis</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">Neuropsychiatric</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li>Anxiety, depression</li>\n<li>Cognitive dysfunction</li>\n<li>Irritability</li>\n<li>Hallucinations</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">Cardiac</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li><strong>Short QT interval</strong></li>\n<li>bradycardia</li>\n<li>Hypertension</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td style=\"width: 136px;\">Ectopic calcification</td>\n<td style=\"width: 275.828125px;\">\n<ul>\n<li>Cornea: Band keratopathy</li>\n<li>Extravascular tissues: calcinosis</li>\n<li>Small arteries: calciphylaxis</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>\n<p>The features of<strong> elevated PTH levels</strong>&nbsp;are as follows:</p>\n<ul>\n<li>Osteitis fibrosa cystica</li>\n<li>Osteopenia/osteoporosis</li>\n<li><strong>Hyperuricemia</strong> and <strong>gout</strong>&nbsp;</li>\n<li>Pseudogout</li>\n<li>Increased production of calcitriol &nbsp;</li>\n<li>Nephrolithiasis</li>\n<li>Hypophosphatemia</li>\n<li>Anemia</li>\n</ul>\n<p>The clinical signs associated with primary hyperparathyroidism can be remembered with the mnemonic -<strong>&nbsp;&ldquo;bones, stones, groans, moans with fatigue overtones&rdquo;</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following would you expect in a patient with primary hyperparathyroidism?",
    "choices": [
      {
        "id": 1,
        "text": "Gallstones"
      },
      {
        "id": 2,
        "text": "Recurrent abortions"
      },
      {
        "id": 3,
        "text": "Hypotension"
      },
      {
        "id": 4,
        "text": "Neuropsychiatric changes"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Neuropsychiatric</strong> changes are seen in patients with <strong>primary</strong> <strong>hyperparathyroidism</strong> (PHPT).</p>\n<p>The clinical signs associated with primary hyperparathyroidism can be remembered with the mnemonic -<strong>&nbsp;&ldquo;bones, stones, groans, moans with fatigue overtones&rdquo;</strong></p>\n<table>\n<tbody>\n<tr>\n<td><strong>System</strong></td>\n<td><strong>Clinical features</strong></td>\n</tr>\n<tr>\n<td>Musculoskeletal</td>\n<td>\n<ul>\n<li>Bone pain</li>\n<li>Skeletal deformities</li>\n<li>Pathological fractures</li>\n<li>Myalgia and arthralgia</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>Renal</td>\n<td>\n<ul>\n<li>Renal stones(Calcium oxalate &gt; calcium phosphate)</li>\n<li>Nephrocalcinosis</li>\n<li>Polyuria and dehydration</li>\n<li>Renal failure</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>GIT</td>\n<td>\n<ul>\n<li>Constipation</li>\n<li>Nausea, vomiting, anorexia</li>\n<li>Abdominal pain</li>\n<li>Peptic ulcer disease</li>\n<li>Acute pancreatitis</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td><strong>Neuropsychiatric</strong></td>\n<td>\n<ul>\n<li>Anxiety, depression</li>\n<li>Cognitive dysfunction</li>\n<li>Irritability</li>\n<li>Hallucinations</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>Cardiac</td>\n<td>\n<ul>\n<li>Short QT interval</li>\n<li>bradycardia</li>\n<li>Hypertension</li>\n</ul>\n</td>\n</tr>\n<tr>\n<td>Ectopic calcification</td>\n<td>\n<ul>\n<li>Cornea: Band keratopathy</li>\n<li>Extravascular tissues: calcinosis</li>\n<li>Small arteries: calciphylaxis</li>\n</ul>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Note:&nbsp;Though multiple clinical studies have found an increased incidence of gall stones in primary HPT, there is no reference to this in Harrison's and Williams's endocrinology. Hence, option D would be the most appropriate answer.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Calcitonin levels are increased in:",
    "choices": [
      {
        "id": 1,
        "text": "Hyperthyroidism"
      },
      {
        "id": 2,
        "text": "Hypoparathyroidism"
      },
      {
        "id": 3,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 4,
        "text": "Cushing's syndrome"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Other options</p>\n<p>Option A: In <strong>hyperthyroidism</strong>, the direct effect of thyroid hormones can lead to bone resorption and <strong>mild hypercalcemia</strong>. However, hyperparathyroidism is a better answer.</p>\n<p>Options B and D: <strong>Hypoparathyroidism</strong> and <strong>Cushing&rsquo;s syndrome</strong> will have <strong>low serum calcium</strong> and hence, will not have <strong>increased calcitonin</strong> levels.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The spinal x-ray of a patient with elevated ALP levels is shown below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Paget's disease"
      },
      {
        "id": 2,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 3,
        "text": "Osteopetrosis"
      },
      {
        "id": 4,
        "text": "Ankylosing spondylitis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above x-ray shows a&nbsp;<strong>rugger jersey spine</strong>&nbsp;which is a distinct feature of<strong> hyperparathyroidism.&nbsp;</strong>It is associated with <strong>elevated</strong> <strong>ALP</strong>.</p>\n<p>It refers to the prominent <strong>hyperdensities</strong> at the <strong>endplates</strong> of successive <strong>vertebrae</strong>, which mimics the striped appearance of a rugby jersey.&nbsp;</p>\n<p>Option A:&nbsp;<strong>Paget's</strong> disease causes cortical thickening, which results in increased opacity on all sides of the vertebral body. These are called <strong>picture frame vertebrae</strong>.</p>\n<p>Option C: <strong>Osteopetrosis</strong> presents with <strong>normal ALP</strong> levels. It results in sclerotic endplates of vertebrae that are termed <strong>sandwich vertebrae</strong>. Though this finding is similar to rugger jersey spine, it is denser and more sharply defined than rugger jersey spine. In addition, there is&nbsp;sclerosis of inner margins of vertebral bodies, resulting in a <strong>bone within a bone</strong>&nbsp;appearance.</p>\n<p>Option D: Ankylosing spondylitis produces a bamboo spine appearance due to fusion of vertebral bodies.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/03b3c7200ad042e9a66b07dddba62143.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A middle-aged woman presents with worsening pain and an inability to bear weight on her left leg. She says that she had banged her leg against a chair 3 days ago. X-ray reveals a fracture of her left tibia. In view of this finding, a skeletal survey was performed and reveals the following additional finding. What is the likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Renal osteodystrophy"
      },
      {
        "id": 2,
        "text": "Osteomalacia"
      },
      {
        "id": 3,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 4,
        "text": "Hypoparathyroidism"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>This clinical scenario is suggestive of a pathological fracture of the tibia. The given x-ray shows <strong>brown tumors</strong> or <strong>osteitis fibrosa cystica</strong>, which are characteristic of<strong>&nbsp;hyperparathyroidism.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/c6093631bd6c46e59fb854e3c505d320.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "This x-ray finding in a patient is characteristic of which of the following conditions?",
    "choices": [
      {
        "id": 1,
        "text": "Hyperparathyroidism"
      },
      {
        "id": 2,
        "text": "Down's syndrome"
      },
      {
        "id": 3,
        "text": "Acromegaly"
      },
      {
        "id": 4,
        "text": "Psoriasis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Option A:&nbsp;Hyperparathyroidism causes&nbsp;<strong>subperiosteal bone resorption,</strong>&nbsp;which is marked along the radial aspect of the middle phalanges of the index and middle fingers.</p>\n<p>Option B: Down's syndrome can cause hypoplasia of the middle phalanx of the 5th finger.</p>\n<p>Option C: Psoriasis causes a pencil-in-cup appearance of the distal phalanx.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/955d46f81486420e9a4ea1bbbf794e47.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following is not used to treat a patient with hypercalcemia due to primary hyperparathyroidism?",
    "choices": [
      {
        "id": 1,
        "text": "Forced diuresis with loop diuretics"
      },
      {
        "id": 2,
        "text": "Glucocorticoids"
      },
      {
        "id": 3,
        "text": "Pamidronate"
      },
      {
        "id": 4,
        "text": "Hydration with saline"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Glucocorticoids</strong><strong>&nbsp;</strong>have<strong> no effect&nbsp;</strong>on the serum<strong> calcium </strong>concentration in <strong>primary hyperparathyroidism</strong> and normal individuals.&nbsp;</p>\n<p>They are effective in the treatment of hypercalcemia when associated with the following conditions:</p>\n<ul>\n<li>Malignancy</li>\n<li>Vitamin D intoxication</li>\n<li>Sarcoidosis</li>\n</ul>\n<p>Initial medical management of hypercalcemia involves the following:</p>\n<ul>\n<li><strong>Normal</strong> <strong>saline</strong> (200-500 ml/hour): It<strong>&nbsp;</strong>is the mainstay treatment to correct dehydration, and titrated to maintain a urine output of &gt;100 ml/hour</li>\n<li><strong>Pamidronate</strong>&nbsp;or <strong>zoledronate</strong>: These are <strong>bisphosphonates</strong> and are considered as the <strong>drug of choice</strong> in primary hyperparathyroidism</li>\n<li><strong>Cinacalcet</strong>:&nbsp;This is a calcimimetic that increases the affinity of the glands to extracellular calcium, thereby decreasing parathyroid hormone secretion</li>\n<li><strong>Denosumab</strong>:<strong>&nbsp;</strong>This inhibits RANK-ligand, which acts on osteoclasts</li>\n<li><strong>Calcitonin</strong>:&nbsp;This is an activated vitamin D analog that may be used to reduce calcium levels. It should&nbsp;be used within the first 24 hours</li>\n</ul>\n<p><strong>Forced diuresis</strong> refers to aggressive fluid hydration with loop diuretic administration. Although this is an <strong>effective</strong> method to <strong>reduce calcium</strong> levels, it requires careful monitoring for adverse effects like <strong>fluid overload</strong>, <strong>hypokalemia</strong>, and hypomagnesia. Due to this reason as well as the availability of more effective treatment modalities, forced diuresis is <strong>not preferred</strong> any longer.</p>\n<p>The <strong>definitive</strong> management of primary hyperparathyroidism is the&nbsp;<strong>surgical removal</strong> of the parathyroid gland.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is used in the treatment of hypercalcemia due to Vitamin D toxicity?",
    "choices": [
      {
        "id": 1,
        "text": "Dexamethasone"
      },
      {
        "id": 2,
        "text": "Hydroxychloroquine"
      },
      {
        "id": 3,
        "text": "Chloroquine"
      },
      {
        "id": 4,
        "text": "Ketoconazole"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In patients with <strong>hypercalcemia </strong>due to<strong> vitamin D toxicity</strong>, glucocorticoids like <strong>dexamethasone</strong> are the preferred therapy as they <strong>decrease 1,25 (OH2) vitamin D</strong> (calcitriol) production. This results in r<strong>educed intestinal calcium absorption</strong> and <strong>increased urinary excretion of calcium</strong>.</p>\n<p>Hydroxychloroquine, chloroquine, and ketoconazole may also decrease calcitriol production and are used occasionally. But the <strong>preferred therapy</strong> is <strong>steroids</strong>.</p>\n<p><strong>Vitamin D toxicity</strong> presents acutely with <strong>features of hypercalcemia</strong> such as <strong>confusion</strong>, <strong>polyuria</strong>, <strong>polydipsia</strong>, anorexia, vomiting, and muscle weakness. <strong>Chronic intoxication</strong> may cause <strong>nephrocalcinosis</strong>, bone demineralization, and pain.</p>\n<p>Lab features include <strong>elevated 25 (OH) vitamin D</strong>, <strong>high calcium</strong>, and <strong>suppressed PTH</strong>.</p>\n<p>Dexamethasone can also be used in the treatment of hypercalcemia caused by the humoral hypercalcemia of malignancy (due to PTHr) and sarcoidosis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient is brought to the emergency department with confusion, drowsiness, and multiple episodes of vomiting. His family members say that he was diagnosed with bipolar disorder several years ago and has been on medication ever since. Further evaluation reveals a serum calcium level of 16 mg/dl. What should be the next step in the management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Saline hydration"
      },
      {
        "id": 2,
        "text": "Denosumab"
      },
      {
        "id": 3,
        "text": "IV biphosphonate"
      },
      {
        "id": 4,
        "text": "Subcutaneous calcitonin"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This clinical scenario is suggestive of a <strong>hypercalcemic crisis.</strong> The next best step in management is <strong>saline hydration</strong>. Typically&nbsp;200-500 ml/hour fluids are given to correct dehydration and titrated to maintain a urine output of &gt;100 ml/hour.</p>\n<p>Hypercalcemic crisis is<strong>&nbsp;</strong>a <strong>medical emergency</strong>&nbsp;associated with serum <strong>calcium &gt;14&nbsp;</strong>mg/dl. It is often&nbsp;caused by conditions causing an acute rise in calcium levels such as&nbsp;<strong>malignancies</strong>&nbsp;or <strong>lithium</strong> overdose.</p>\n<p>It presents with oliguria, severe dehydration, gastrointestinal symptoms, and altered consciousness. It can lead to<strong> cardiac arrest </strong>and <strong>coma</strong>.</p>\n<p>Initial medical management of hypercalcemia involves the following:</p>\n<ul>\n<li>Fluids&nbsp;are the mainstay treatment</li>\n<li>Bisphosphonates</li>\n<li>Cinacalcet</li>\n<li>Denosumab</li>\n<li>Calcitonin&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In a patient with hypocalcemia and hyperphosphatemia, which of the following will you not suspect?",
    "choices": [
      {
        "id": 1,
        "text": "Vitamin D-dependent rickets type 1"
      },
      {
        "id": 2,
        "text": "Pseudohypoparathyroidism"
      },
      {
        "id": 3,
        "text": "Chronic kidney disease"
      },
      {
        "id": 4,
        "text": "DiGeorge syndrome"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Vitamin D-dependent rickets type 1</strong>&nbsp;is associated with hypocalcemia and <strong>hypophosphatemia</strong></p>\n<p><strong>Hypocalcemia </strong>with<strong> hyperphosphatemia </strong>is observed&nbsp;in the following conditions:</p>\n<ul>\n<li>True hypoparathyroidism\n<ul>\n<li>Hereditary hypoparathyroidism</li>\n<li>Acquired hypoparathyroidism &ndash; following surgery</li>\n<li>Hypomagnesemia</li>\n</ul>\n</li>\n<li><strong>Pseudohypoparathyroidism</strong></li>\n<li><strong>Chronic kidney disease</strong></li>\n<li><strong>DiGeorge syndrome</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "All of the following medical conditions are associated with hyperphosphatemia except:",
    "choices": [
      {
        "id": 1,
        "text": "Chronic renal failure"
      },
      {
        "id": 2,
        "text": "Prolonged phosphate intake"
      },
      {
        "id": 3,
        "text": "Pseudopseudohypoparathyroidism"
      },
      {
        "id": 4,
        "text": "Pseudohypoparathyroidism"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Pseudopseudohypoparathyroidism</strong> is a type of pseudohypoparathyroidism type 1A associated with <strong>normal calcium&nbsp;</strong>and <strong>normal phosphate</strong>.&nbsp;The clinical features are similar to&nbsp;pseudohypoparathyroidism but there is<strong> no PTH resistance</strong>.</p>\n<p><strong>Pseudohypoparathyroidism</strong> is an autosomal dominant condition caused by a <strong>mutation</strong> of the <strong>alpha subunit</strong> of the<strong> Gs protein</strong>. This causes <strong>PTH</strong> <strong>resistance</strong>. It is associated with&nbsp;<strong>Albright hereditary osteodystrophy</strong> (short stature, round facies, and short fourth metacarpal).</p>\n<p>Types of pseudohypoparathyroidism:</p>\n<table style=\"height: 174px; width: 441px;\">\n<tbody>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">Type</td>\n<td style=\"height: 18px; width: 78px;\">PHP 1A</td>\n<td style=\"height: 18px; width: 81px;\">PHP 1B</td>\n<td style=\"height: 18px; width: 82.203125px;\">PHP 1C</td>\n<td style=\"height: 18px; width: 40.796875px;\">PHP 2</td>\n<td style=\"height: 18px; width: 66px;\">PPHP</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">Hypocalcemia</td>\n<td style=\"height: 18px; width: 78px;\">Yes</td>\n<td style=\"height: 18px; width: 81px;\">Yes</td>\n<td style=\"height: 18px; width: 82.203125px;\">Yes</td>\n<td style=\"height: 18px; width: 40.796875px;\">Yes</td>\n<td style=\"height: 18px; width: 66px;\">No</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">Hyperphosphatemia</td>\n<td style=\"height: 18px; width: 78px;\">Yes</td>\n<td style=\"height: 18px; width: 81px;\">Yes</td>\n<td style=\"height: 18px; width: 82.203125px;\">Yes</td>\n<td style=\"height: 18px; width: 40.796875px;\">Yes</td>\n<td style=\"height: 18px; width: 66px;\">No</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">PTH levels</td>\n<td style=\"height: 18px; width: 78px;\">&uarr;</td>\n<td style=\"height: 18px; width: 81px;\">&uarr;</td>\n<td style=\"height: 18px; width: 82.203125px;\">&uarr;</td>\n<td style=\"height: 18px; width: 40.796875px;\">&uarr;</td>\n<td style=\"height: 18px; width: 66px;\">Normal</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">GS &alpha; subunit deficiency</td>\n<td style=\"height: 18px; width: 78px;\">Yes</td>\n<td style=\"height: 18px; width: 81px;\">No&nbsp;</td>\n<td style=\"height: 18px; width: 82.203125px;\">No</td>\n<td style=\"height: 18px; width: 40.796875px;\">No</td>\n<td style=\"height: 18px; width: 66px;\">Yes</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">Albright hereditary osteodystrophy</td>\n<td style=\"height: 18px; width: 78px;\">Yes</td>\n<td style=\"height: 18px; width: 81px;\">No</td>\n<td style=\"height: 18px; width: 82.203125px;\">Yes</td>\n<td style=\"height: 18px; width: 40.796875px;\">No</td>\n<td style=\"height: 18px; width: 66px;\">Yes</td>\n</tr>\n<tr style=\"height: 18px;\">\n<td style=\"height: 18px; width: 130px;\">PTH resistance</td>\n<td style=\"height: 18px; width: 78px;\">Yes</td>\n<td style=\"height: 18px; width: 81px;\">Yes</td>\n<td style=\"height: 18px; width: 82.203125px;\">Yes</td>\n<td style=\"height: 18px; width: 40.796875px;\">Partial</td>\n<td style=\"height: 18px; width: 66px;\">No</td>\n</tr>\n</tbody>\n</table>\n<p>PHP: pseudohypoparathyroidism, PPHP: pseudopseudohypoparathyroidism, PTH: parathyroid hormone</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 5-year-old boy is brought by his mother with with the following abnormality. Serum levels of vitamin D are found to be low. Which of the following would not be seen in this boy?",
    "choices": [
      {
        "id": 1,
        "text": "Decrease in parathyroid hormone level"
      },
      {
        "id": 2,
        "text": "Decrease in renal calcium excretion"
      },
      {
        "id": 3,
        "text": "Increase in renal phosphate excretion"
      },
      {
        "id": 4,
        "text": "Increase in serum alkaline phosphatase"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given image shows a&nbsp;<strong>windswept deformity</strong>&nbsp;of the lower limbs (combination of valgus deformity of one leg with varus deformity of the other leg). This finding along with low serum vitamin D points to a diagnosis of<strong>&nbsp;vitamin D deficiency rickets</strong>. It is associated with an&nbsp;<strong>increase </strong>in<strong>&nbsp;</strong>parathyroid hormone (<strong>PTH</strong>) levels.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7276beb0e5e24793ae4d416c16177005.GIF"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e33bf8ce8be8488ab64ae81136fdf9c9x1280x1405.JPEG"
    ]
  },
  {
    "text": "Which of the following statements is incorrect with respect to hypocalcemia?",
    "choices": [
      {
        "id": 1,
        "text": "Can occur due to hypermagnesemia"
      },
      {
        "id": 2,
        "text": "Latent tetany is observed"
      },
      {
        "id": 3,
        "text": "Prolonged QT interval"
      },
      {
        "id": 4,
        "text": "Not a feature of hyperparathyroidism"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Hypocalcemia </strong>is a feature of <strong>secondary hyperparathyroidism </strong>(SHPT).</p>\n<p>Hypocalcemia refers to total serum <strong>calcium &le;8.4 </strong>mg/dl. The causes include:</p>\n<ul>\n<li>Low PTH\n<ul>\n<li>Hypoparathyroidism</li>\n</ul>\n</li>\n<li><strong>High PTH</strong> (SHPT)\n<ul>\n<li><strong>Chronic kidney disease&nbsp;</strong></li>\n<li>Vitamin D deficiency</li>\n<li>Pseudohypoparathyroidism</li>\n<li>Hyperphosphatemia</li>\n</ul>\n</li>\n<li>Loop diuretics, calcitonin, bisphosphonates</li>\n<li>Massive blood transfusions</li>\n<li>Hyperventilation</li>\n<li>Hypomagnesemia&nbsp;- Mg is essential for&nbsp;PTH release</li>\n<li>Severe <strong>hypermagnesemia</strong> - higher Mg levels suppress PTH secretion</li>\n</ul>\n<p>Hypocalcemia causes tetany or increased neuromuscular excitability. It can cause paresthesias, cramps, spasms, and seizures. <strong>Latent tetany</strong> can only be detected by performing <strong>Chvostek</strong> and <strong>Trousseau's</strong> signs.<strong>&nbsp;</strong>A <strong>prolonged QT</strong> interval is seen on ECG.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The following sign is elicited in a patient. What is it called?",
    "choices": [
      {
        "id": 1,
        "text": "Chvostek\u2019s sign"
      },
      {
        "id": 2,
        "text": "Trousseau's sign"
      },
      {
        "id": 3,
        "text": "Tinel's sign"
      },
      {
        "id": 4,
        "text": "Troisier\u2019s sign"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The above image indicates&nbsp;<strong>Trousseau's sign </strong>or<strong> carpopedal spasm</strong>&nbsp;classically seen in patients with&nbsp;<strong>hypocalcemia</strong>.</p>\n<p>Trousseau's sign is elicited by making the forearm ischemic by applying a sphygmomanometer cuff to the arm and keeping the pressure <strong>above</strong> systolic blood pressure (<strong>SBP</strong>) for <strong>5 minutes</strong>. The hand goes into a painful carpopedal spasm and assumes the <strong>accoucheur&rsquo;s hand position</strong>.</p>\n<p>Hypocalcemia results in&nbsp;<strong>tetany</strong> or increased <strong>neuromuscular</strong> <strong>irritability</strong>. It leads to <strong>paresthesia</strong> and tingling of extremities and <strong>perioral</strong> area. Severe hypocalcemia can cause <strong>seizures</strong>.</p>\n<p>Option A: Chvostek's sign is also seen in <strong>hypocalcemia</strong>.&nbsp;Tapping the facial nerve in front of the tragus will cause&nbsp;<strong>spasms</strong> of&nbsp;the <strong>facial muscles.</strong>&nbsp;</p>\n<p>Option C:&nbsp;Tinel's sign is seen in carpal tunnel syndrome. It refers to a tingling sensation on tapping over the median nerve.</p>\n<p>Option D: Troisier's sign refers to&nbsp;left supraclavicular lymphadenopathy in metastatic abdominal malignancy.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/43e3dd9f8b524397b9ca03f9564f1d13.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following agents cannot be used to manage a patient with chronic hypocalcemia?",
    "choices": [
      {
        "id": 1,
        "text": "Etidronate"
      },
      {
        "id": 2,
        "text": "Thiazide"
      },
      {
        "id": 3,
        "text": "Elemental calcium"
      },
      {
        "id": 4,
        "text": "Vitamin D analogues"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Etidronate</strong> is not used in the management of hypocalcemia. It&nbsp;is a <strong>bisphosphonate</strong>&nbsp;used in the management of&nbsp;<strong>hypercalcemia</strong>.</p>\n<p>The goal in the management of hypoparathyroidism&nbsp;is to restore the <strong>calcium-phosphate balance</strong>. The mainstay is <strong>calcium </strong>and<strong> vitamin D supplements</strong>. Other underlying conditions must also be treated.</p>\n<p>Instead of loop diuretics, <strong>thiazides</strong>&nbsp;can be administered on a low sodium diet as&nbsp;they enhance <strong>urinary calcium</strong> <strong>reabsorption</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '017 Disorders Of Parathyroid And Calcium Homeostasis';
        const quizFilename = '017-disorders-of-parathyroid-and-calcium-homeostasis-6bea6c25.html';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>