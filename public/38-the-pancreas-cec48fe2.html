<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>38 The Pancreas - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Physiology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">25</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which scientists were awarded the Nobel Prize for the discovery of insulin?",
    "choices": [
      {
        "id": 1,
        "text": "Banting and Best"
      },
      {
        "id": 2,
        "text": "Sanger"
      },
      {
        "id": 3,
        "text": "Banting and McLeod"
      },
      {
        "id": 4,
        "text": "Collip and McLeod"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Banting</strong> and <strong>McLeod</strong> were awarded the Nobel Prize for the discovery of insulin.</p>\n<p>In 1921, Banting took his idea to Professor John Macleod at the University of Toronto, who was a leading figure in the study of diabetes in Canada. Macleod gave Banting a laboratory with a minimum equipments and ten dogs. Banting also got an assistant, a medical student by the name of Charles Best. &nbsp;</p>\n<p>In 1923, the Nobel Committee decided to award Banting and Macleod the Nobel Prize in Physiology or Medicine. The decision of the Nobel Committee made Banting furious. He felt that the prize should have been shared between him and Best.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "For cells of islets of Langerhans, which of the following is correctly matched?",
    "choices": [
      {
        "id": 1,
        "text": "\u0392 \u2013somatostatin"
      },
      {
        "id": 2,
        "text": "D- glucagon"
      },
      {
        "id": 3,
        "text": "F- pancreatic polypeptide"
      },
      {
        "id": 4,
        "text": "A \u2013 insulin"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The correctly matched pair is<strong> F-Pancreatic polypeptide</strong>.&nbsp;</p>\n<p>Cells of the endocrine pancreas are divided into:&nbsp;</p>\n<table style=\"width: 288px;\">\n<tbody>\n<tr>\n<td style=\"width: 128px;\">\n<p><strong>Cell type</strong></p>\n</td>\n<td style=\"width: 146px;\">\n<p><strong>What they secrete</strong></p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 128px;\">\n<p><strong>A (alpha)</strong></p>\n</td>\n<td style=\"width: 146px;\">\n<p>Glucagon</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 128px;\">\n<p><strong>B (beta)</strong></p>\n</td>\n<td style=\"width: 146px;\">\n<p>Insulin and amylin</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 128px;\">\n<p><strong>D (delta)</strong></p>\n</td>\n<td style=\"width: 146px;\">\n<p>Somatostatin</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 128px;\">\n<p><strong>F or PP</strong></p>\n</td>\n<td style=\"width: 146px;\">\n<p>Pancreatic polypeptide</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>The close interrelations among these cells allow direct control of secretion of some of the hormones by the other hormones. For example:</p>\n<ul>\n<li>Insulin inhibits glucagon secretion,</li>\n<li>Amylin inhibits glucagon secretion, and</li>\n<li>Somatostatin inhibits secretion of insulin and glucagon.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 21-year-old female is found in a semiconscious state. On initial evaluation, her CBG is 23mg/dL. Her parents tell that the patient is an athlete and was trying to gain weight recently. An evaluation of which of the following will help in establishing a diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pancreatic polypeptide"
      },
      {
        "id": 2,
        "text": "Glucagon"
      },
      {
        "id": 3,
        "text": "Somatostain"
      },
      {
        "id": 4,
        "text": "C peptide"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Insulin is composed of two chains A and B, and a connecting peptide called C peptide. The insulin and C peptide are packaged in the <strong>secretory granules</strong> and secreted in <strong>equimolar amounts</strong>.&nbsp;</p>\n<p>Importance of C-peptide:</p>\n<div class=\"page\" title=\"Page 939\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li>C peptide is measured by <strong>radioimmunoassay</strong>, and its level in the blood provides an index of beta-cell function in patients receiving exogenous insulin.&nbsp;If they are unable to produce insulin, they have greatly decreased levels of C peptide.</li>\n<li>C peptide levels can be used to differentiate between an insulinoma (high C-peptide) and exogenous insulin overdose (low C-peptide) in a patient with hypoglycemia.&nbsp;</li>\n</ul>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2119e165009f4a7d8fa86f6642290706x1280x1166.JPEG"
    ]
  },
  {
    "text": "The half-life of insulin is ______ minutes?",
    "choices": [
      {
        "id": 1,
        "text": "1-2"
      },
      {
        "id": 2,
        "text": "4-6"
      },
      {
        "id": 3,
        "text": "10-12"
      },
      {
        "id": 4,
        "text": "12-16"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The half-life of <strong>insulin</strong> is <strong>4-6 minutes.&nbsp;</strong></p>\n<p>Insulin is degraded by the<strong> insulinase</strong> enzyme in the <strong>liver</strong>, and to a lesser extent, in the kidneys and muscles.&nbsp;</p>\n<p>Note: Half-life of <strong>C-peptide</strong> is <strong>20-30 minutes</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old diabetic man is initiated on a new hypoglycemic drug whose mechanism of action is extremely similar to the glucose-mediated insulin release mechanism. Which of the following best represents its mode of action?",
    "choices": [
      {
        "id": 1,
        "text": "Closes ATP sensitive K+ channels"
      },
      {
        "id": 2,
        "text": "Increases cAMP level in cell"
      },
      {
        "id": 3,
        "text": "Participates in carrier mediated transport"
      },
      {
        "id": 4,
        "text": "Causes receptor phosphorylation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Diazoxide</strong> keeps the ATP sensitive <strong>K+ channels</strong> <strong>open</strong> and <strong>prevents</strong> depolarization, resulting in a decreased&nbsp;<strong>insulin release</strong>. It is used in patients with insulinoma.</p>\n<p><strong>Sulfonylureas</strong> cause <strong>closure</strong> of the ATP sensitive <strong>K+ channels</strong>, leading to <strong>increased insulin</strong> secretion. It is used in patients with diabetes mellitus.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8b3b2a05626e43a3b5317c85e2f28c37x1280x1768.JPEG"
    ]
  },
  {
    "text": "Insulin mainly facilitates glucose uptake in which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Brain"
      },
      {
        "id": 2,
        "text": "Skeletal muscle"
      },
      {
        "id": 3,
        "text": "RBC"
      },
      {
        "id": 4,
        "text": "Kidney"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Insulin mainly&nbsp;</strong>stimulates glucose uptake<strong> by skeletal muscles.</strong></p>\n<p>Glucose uptake by skeletal muscle, cardiac muscle and adipose tissues is via <strong>GLUT-4</strong> which is <strong>insulin-dependent</strong>. In the presence of insulin, GLUT-4 receptors translocate to the cell membrane and hence, glucose uptake by the cell occurs.&nbsp;</p>\n<div class=\"page\" title=\"Page 437\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Most of the <strong>other GLUT</strong> transporters are <strong>not insulin sensitive</strong> and are constitutively expressed in the cell membrane. Ex: GLUT-1 in RBCs, brain and kidneys. (GLUT-3 is also present in the brain and kidneys)</p>\n</div>\n</div>\n</div>\n</div>\n<p>Note: Insulin promotes glucose uptake in the liver. However, this is done by <strong>increasing</strong> the activity of <strong>glucokinase</strong> and <strong>inactivating glycogen phosphorylase</strong>. The net effect is the synthesis of glycogen and decreased breakdown of glycogen.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Insulin acts on glucose metabolism by______",
    "choices": [
      {
        "id": 1,
        "text": "\u2191 facilitated diffusion of glucose"
      },
      {
        "id": 2,
        "text": "\u2193 permeability of glucose across cell membrane"
      },
      {
        "id": 3,
        "text": "\u2191 reabsorption of glucose from renal tubules"
      },
      {
        "id": 4,
        "text": "\u2191 glucose reabsorption from intestine"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Insulin stimulates the glucose entry into the cells via <strong>facilitated diffusion</strong> by increasing the number of glucose transporters (GLUTs) in the cell membrane.</p>\n<p>This type of insulin-dependent glucose transport via GLUT 4 is observed in <strong>skeletal muscle, cardiac muscle, </strong>and<strong> adipose tissues.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old diabetic man develops a gradually increasing demand for exogenous subcutaneous insulin therapy for glycemic control. His current insulin requirement is 130 IU/day. Downregulation of which of the following is associated with his condition?",
    "choices": [
      {
        "id": 1,
        "text": "GLUT 1"
      },
      {
        "id": 2,
        "text": "GLUT 2"
      },
      {
        "id": 3,
        "text": "GLUT 3"
      },
      {
        "id": 4,
        "text": "GLUT 4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical vignette is suggestive of<strong> insulin resistance</strong>, which is characterized by the <strong>downregulation</strong> of<strong> GLUT-4</strong>.</p>\n<p><strong>GLUT-4</strong> is an <strong>insulin-dependent</strong> GLUT. Other GLUTs are not insulin sensitive and are constitutively expressed in the cell membrane.&nbsp;</p>\n<p>An arbitrary but clinically useful benchmark considers patients insulin resistant if they require greater than 1 unit/kilogram/day of exogenous insulin to maintain glycemic control. Patients requiring greater than 200 units of&nbsp;exogenous insulin per day are considered severely insulin resistant.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 40-year-old man presented with diabetic ketoacidosis. After the initial evaluation, he is started on intravenous insulin therapy via an infusion pump. He is at increased risk of developing which of the following electrolyte abnormalities?",
    "choices": [
      {
        "id": 1,
        "text": "Hyperkalemia"
      },
      {
        "id": 2,
        "text": "Hypokalemia"
      },
      {
        "id": 3,
        "text": "Hypernatremia"
      },
      {
        "id": 4,
        "text": "Hyponatermia"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In patients who require intravenous insulin therapy, a&nbsp;<strong>rapid</strong> insulin infusion results in <strong>hypokalemia</strong>.&nbsp;</p>\n<p>Therefore such patients should undergo serum electrolyte level assessment at frequent intervals while on insulin infusion for prompt diagnosis and early correction of hypokalemia.</p>\n<p>Insulin <strong>increases</strong> the activity of <strong>Na-K ATPase</strong> in cell membranes so that more <strong>K<sup>+</sup></strong> is <strong>pumped into cells</strong>. Hence, <strong>serum K+ falls</strong>.&nbsp;</p>\n<p>Note: Since insulin decreases serum potassium level, insulin-glucose infusions are used to treat hyperkalemia.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following increases insulin secretion?",
    "choices": [
      {
        "id": 1,
        "text": "Arginine"
      },
      {
        "id": 2,
        "text": "Propranolol"
      },
      {
        "id": 3,
        "text": "Epinephrine"
      },
      {
        "id": 4,
        "text": "K+ depletion"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Arginine</strong> increases insulin secretion.</p>\n<p>Option B:&nbsp;<strong>&beta;-adrenergic blockers</strong> like propranolol <strong>inhibits</strong> insulin secretion.</p>\n<p>Option C: Epinephrine both stimulates (by beta-adrenergic agonistic action) and inhibits (by alpha-adrenergic agonistic action) the secretion of insulin. However, the<strong> inhibitory effect</strong> of epinephrine is <strong>more dominant</strong> than the stimulatory effect.</p>\n<p>Option D:<strong> Insulin</strong> promotes glucose uptake by cells, <strong>causing reduced</strong> serum <strong>K+</strong>. Low serum K+ does&nbsp;not cause an&nbsp;increase in insulin secretion.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Sympathetic stimulation has the following effect on insulin secretion______",
    "choices": [
      {
        "id": 1,
        "text": "Inhibition"
      },
      {
        "id": 2,
        "text": "Stimulation"
      },
      {
        "id": 3,
        "text": "Inhibition followed by stimulation"
      },
      {
        "id": 4,
        "text": "No effect"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"page\" title=\"Page 454\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Sympathetic</strong> stimulation\u00a0<strong>inhibits </strong>insulin secretion.\u00a0</p>\n<p>The regulation of insulin secretion can be controlled by\u00a0alpha-adrenergic mediated response and\u00a0beta-adrenergic mediated response. The stimulation of\u00a0<strong>alpha-adrenergic </strong>receptor (<strong>\u03b12</strong>) plays an <strong>inhibitory</strong> role in insulin secretion. On the other hand,\u00a0the stimulation of\u00a0<strong>beta-adrenergic</strong> receptor (<strong>\u03b22</strong>) plays a <strong>stimulatory</strong> role in insulin secretion.</p>\n<div class=\"page\" title=\"Page 445\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Stimulation of the <strong>sympathetic</strong> nerves to the pancreas releases <strong>norepinephrine</strong> which predominantly acts on <strong>\u03b12-adrenergic receptors, </strong>causing a decrease in insulin secretion.</p>\n<p>Note: If <strong>\u03b1-</strong>adrenergic receptors are <strong>blocked</strong>, stimulation of the <strong>sympathetic</strong> nerves causes <strong>increased insulin</strong> secretion mediated by <strong>\u03b22-</strong>adrenergic receptors.\u00a0</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following decreases the secretion of both insulin and glucagon?",
    "choices": [
      {
        "id": 1,
        "text": "Epinephrine"
      },
      {
        "id": 2,
        "text": "Somatostatin"
      },
      {
        "id": 3,
        "text": "\u2191 blood glucose"
      },
      {
        "id": 4,
        "text": "None"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Somatostatin inhibits insulin and glucagon secretion.&nbsp;</p>\n<p>Note: Other actions of somatostatin:</p>\n<ul>\n<li>Inhibits growth hormone secretion. Somatostatin is also known as growth hormone inhibitory hormone (GHIH).</li>\n<li>Decreases motility of the stomach, duodenum, and gallbladder.</li>\n<li>Decreases both secretion and absorption in the gastrointestinal tract.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Insulin secretion is normally stimulated by_____",
    "choices": [
      {
        "id": 1,
        "text": "GLP 1"
      },
      {
        "id": 2,
        "text": "GLP 2"
      },
      {
        "id": 3,
        "text": "VIP"
      },
      {
        "id": 4,
        "text": "Adrenergic receptor"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Insulin secretion is normally stimulated by <strong>GLP-1</strong>.</p>\n<div class=\"page\" title=\"Page 946\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Glucagon-like peptide&ndash;1</strong> (GLP-1) and <strong>glucose-dependent insulinotropic peptide</strong> (GIP) are called <strong>incretins</strong>&nbsp;and are potent <strong>stimulators</strong> of <strong>insulin secretion</strong>. They also<strong> inhibit</strong> <strong>glucagon</strong> secretion. They are released in the gastrointestinal tract after a person eats a meal. They then cause an <strong>&ldquo;anticipatory&rdquo; increase</strong> in blood insulin in preparation for the glucose and amino acids to be absorbed from the meal.&nbsp;</p>\n<p>Note: Drugs that mimic the action of incretins are used in the management of diabetes.&nbsp;</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following compounds antagonizes the action of insulin?",
    "choices": [
      {
        "id": 1,
        "text": "Neuropeptide Y"
      },
      {
        "id": 2,
        "text": "Growth Hormone"
      },
      {
        "id": 3,
        "text": "Substance P"
      },
      {
        "id": 4,
        "text": "Vasoactive Intestinal Peptide (VIP)"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Growth hormone is a hyperglycemic hormone and antagonizes the effect of insulin.</p>\n<p><strong>Hyperglycemic Hormones</strong></p>\n<ul>\n<li>Glucagon</li>\n<li>Epinephrine</li>\n<li>Cortisol</li>\n<li>Growth hormone</li>\n<li>Thyroid Hormone</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In fetus, the insulin secretion begins by _____(months)",
    "choices": [
      {
        "id": 1,
        "text": "5"
      },
      {
        "id": 2,
        "text": "3"
      },
      {
        "id": 3,
        "text": "7"
      },
      {
        "id": 4,
        "text": "9"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In a fetus, the <strong>pancreatic islets</strong> are formed in the <strong>third month</strong> of the fetal life, while&nbsp;<strong>insulin secretion</strong> begins&nbsp;at about <strong>5th month</strong> of fetal life.</p>\n<p>The exocrine pancreas starts functioning after birth.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "How many parts are there in insulin receptor?",
    "choices": [
      {
        "id": 1,
        "text": "1"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "3"
      },
      {
        "id": 4,
        "text": "4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>An <strong>insulin recepto</strong>r has 4\u00a0 parts.\u00a0It is <strong>a tetramer</strong> made up of <strong>two \u03b1</strong> and <strong>two \u03b2</strong> subunits.</p>\n<p>The <strong>\u03b1 subunits</strong> are <strong>extracel\u00adlular</strong>, whereas the <strong>\u03b2 subunits</strong> <strong>penetrate</strong> through the <strong>cell membrane</strong> into the cytoplasm. \u00a0The intracel\u00adlular portions of the <strong>\u03b2 subunits </strong>have<strong> tyrosine kinase </strong>activity.</p>\n<div class=\"page\" title=\"Page 939\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Once <strong>insulin binds</strong> to the <strong>alpha</strong> subunits, the portions of the <strong>beta</strong> subunits protruding into the cell become <strong>autophosphorylated</strong>. Autophosphorylation of the beta subunits, in turn, activates a <strong>local tyrosine kinase</strong>, which causes <strong>phosphorylation</strong> of multiple intracellular enzymes. The net effect is to activate some of these enzymes while inactivating others.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4a3e2a65c239420fbe62e4de43bd667fx1280x1109.JPEG"
    ]
  },
  {
    "text": "Regarding the action of insulin, which of the following is true?",
    "choices": [
      {
        "id": 1,
        "text": "Decreased K+ uptake in adipose tissue"
      },
      {
        "id": 2,
        "text": "Increased protein catabolism in Muscle"
      },
      {
        "id": 3,
        "text": "Activation of hormone sensitive lipase"
      },
      {
        "id": 4,
        "text": "Decreased ketogenesis in liver"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Insulin&nbsp;<strong>decreases ketogenesis&nbsp;</strong>in the liver. In the absence of insulin (Type-1 DM), diabetic ketosis may occur.</p>\n<div class=\"page\" title=\"Page 437\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Effects of insulin on various tissues:</strong></p>\n</div>\n</div>\n</div>\n</div>\n<table style=\"width: 419px; height: 521px;\" border=\"1\">\n<tbody>\n<tr style=\"height: 126px;\">\n<td style=\"width: 78.484375px; height: 126px;\"><strong>Tissue</strong></td>\n<td style=\"width: 170.703125px; height: 126px;\"><strong>Increases</strong></td>\n<td style=\"width: 147.828125px; height: 126px;\"><strong>Decreases</strong></td>\n</tr>\n<tr style=\"height: 126px;\">\n<td style=\"width: 78.484375px; height: 126px;\"><strong>Adipose tissue</strong></td>\n<td style=\"width: 170.703125px; height: 126px;\">Increased glucose entry<br />Increased fatty acid synthesis<br />Increased glycerol phosphate synthesis<br />Increased triglycerides deposition<br />Activation of lipoprotein lipase<br />Increased K+ uptake</td>\n<td style=\"width: 147.828125px; height: 126px;\">Inhibition of hormone-sensitive lipase</td>\n</tr>\n<tr style=\"height: 126px;\">\n<td style=\"width: 78.484375px; height: 126px;\"><strong>Muscle</strong></td>\n<td style=\"width: 170.703125px; height: 126px;\">Increased glucose entry<br />Increased glycogen synthesis<br />Increased amino acid uptake<br />Increased protein synthesis in ribosome<br />Increase ketone uptake<br />Increase K+ uptake</td>\n<td style=\"width: 147.828125px; height: 126px;\">\n<p>Decrease protein catabolism</p>\n<p>Decrease&nbsp; release of glucogenic amino acids</p>\n</td>\n</tr>\n<tr style=\"height: 114px;\">\n<td style=\"width: 78.484375px; height: 114px;\"><strong>Liver</strong></td>\n<td style=\"width: 170.703125px; height: 114px;\">Increased protein synthesis<br />Increased lipid synthesis<br />Increased glycogen synthesis &amp; glycolysis</td>\n<td style=\"width: 147.828125px; height: 114px;\">\n<p>Decrease ketogenesis</p>\n<p>Decreased glucose output due to decreased gluconeogenesis</p>\n</td>\n</tr>\n<tr style=\"height: 73px;\">\n<td style=\"width: 78.484375px; height: 73px;\"><strong>General</strong></td>\n<td style=\"width: 170.703125px; height: 73px;\">Increased cell growth</td>\n<td style=\"width: 147.828125px; height: 73px;\">&nbsp;</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "On giving a patient insulin, which of the following is expected to occur first?",
    "choices": [
      {
        "id": 1,
        "text": "Increased transport of K+ into adipocytes"
      },
      {
        "id": 2,
        "text": "Stimulation of protein synthesis"
      },
      {
        "id": 3,
        "text": "Activation of glycolysis"
      },
      {
        "id": 4,
        "text": "Increase in mRNA for lipolysis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Increased transport of K+ into adipocytes will occur first on giving an injection of insulin.&nbsp;</p>\n<p>Based on time on onset, actions of insulin are classified as:</p>\n<p><strong>Rapid (seconds):&nbsp;</strong>Increased permeability, leading to:</p>\n<ul>\n<li>Increased transport of glucose, amino acids, and K+ into insulin sensitive cells</li>\n</ul>\n<p><strong>Intermediate (minutes):&nbsp;</strong>Changes in activity levels of intracellular enzymes, leading to:</p>\n<ul>\n<li>Stimulation of protein synthesis</li>\n<li>Inhibition of protein degradation</li>\n<li>Activation of glycolytic enzymes and glycogen synthase</li>\n<li>Inhibition of phosphorylase and gluconeogenic enzymes</li>\n</ul>\n<p><strong>Delayed (hours to days):&nbsp;</strong>Changed rates of transcription of DNA, leading to:&nbsp;</p>\n<ul>\n<li>Increase in mRNAs for lipogenic and other enzymes</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is incorrectly paired?",
    "choices": [
      {
        "id": 1,
        "text": "Epinephrine: increased glycolysis"
      },
      {
        "id": 2,
        "text": "Insulin: increased protein synthesis"
      },
      {
        "id": 3,
        "text": "Glucagon: increased gluconeogenesis"
      },
      {
        "id": 4,
        "text": "Thyroxine: decrease blood glucose"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The incorrect pair is thyroxine - decreased blood glucose.&nbsp;<strong>Thyroxine</strong> is a <strong>diabetogenic hormone</strong> leading to an increase in blood glucose levels.</p>\n<p><strong> Effects Of Hormones On Carbohydrate Metabolism:&nbsp;</strong>&nbsp;</p>\n<ul>\n<li><strong>Catecholamines</strong>: Activation of glycogen phosphorylase and therefore glycogenolysis occurs. Hepatic glucose output is increased, producing hyperglycemia. &nbsp;</li>\n<li><strong> Glucocorticoids</strong>: Glucocorticoids from the adrenal cortex elevate blood glucose by stimulating gluconeogenesis and inhibiting glucose utilization by the cells. &nbsp;</li>\n<li><strong>Growth Hormone</strong>: The effects of growth hormone are partly direct and partly mediated via IGF-I (Insulin-like Growth Factor-I). The growth hormone mobilizes FFA from adipose tissue, thus favoring ketogenesis. It decreases glucose uptake into some tissues (&ldquo;anti-insulin action&rdquo;), increases hepatic glucose output, and may decrease tissue binding of insulin.</li>\n</ul>\n<p>Note: Infusing catecholamine (Epinephrine) mainly promotes <strong>glycogenolysis</strong> and it is also associated with enhanced rates of aerobic <strong>glycolysis in skeletal muscles during exercise</strong> (resulting in adenosine triphosphate production).</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A meal rich in insulin-stimulating amino acids but low in carbohydrates does not cause hypoglycemia because _____",
    "choices": [
      {
        "id": 1,
        "text": "Cortisol in the circulation prevents glucose from entering muscle."
      },
      {
        "id": 2,
        "text": "Glucagon secretion is also stimulated by the meal."
      },
      {
        "id": 3,
        "text": "The amino acids in the meal are promptly converted to glucose."
      },
      {
        "id": 4,
        "text": "Insulin does not bind to insulin receptors if the plasma concentration of amino acids is elevated."
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A meal rich in arginine and alanine stimulates both insulin and glucagon secretion. Hence, hypoglycemia does not occur.</p>\n<p>Increased blood&nbsp;<strong>amino acids</strong>&nbsp;stimulate secretion of&nbsp;<strong>glucagon</strong>, which in turn causes the amino acids to get&nbsp;<strong>converted</strong>&nbsp;to glucose. So, the mechanism by which hypoglycemia is prevented after a protien rich meal is secretion of glucagon.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following would be least likely seen 14 days after a rat is injected with a drug that kills all of its pancreatic \u03b2 cells?",
    "choices": [
      {
        "id": 1,
        "text": "A rise in the plasma H+ concentration"
      },
      {
        "id": 2,
        "text": "A rise in the plasma amino acid  concentration"
      },
      {
        "id": 3,
        "text": "A fall in the plasma amino acid concentration"
      },
      {
        "id": 4,
        "text": "A rise in plasma osmolality"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A fall is plasma amino acid concentration is least likely to be seen in this case.</p>\n<p>Injury to the beta cells of the pancreas impairs insulin production rendering the rat insulin deficient.&nbsp;Due to<strong> insulin deficiency</strong>, catabolism of proteins increases and<strong>&nbsp;amino acids </strong>in plasma<strong> increase.&nbsp;</strong></p>\n<p>Insulin deficiency <strong>increases blood glucose</strong> levels, which lead to glycosuria and osmotic diuresis with <strong>extracellular dehydration</strong>. &nbsp;There is <strong>increase i</strong>n the <strong>plasma osmolality.</strong> &nbsp;</p>\n<p>Insulin deficiency causes increased utilization of fats, excess production of&nbsp;ketoacids and <strong>metabolic acidosis</strong>. Metabolic acidosis -&nbsp;a<strong> rise </strong>in the <strong>plasma H+</strong>&nbsp;develops.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an action of insulin?",
    "choices": [
      {
        "id": 1,
        "text": "Activation of liver phosphorylase"
      },
      {
        "id": 2,
        "text": "Decreased activity of glucokinase"
      },
      {
        "id": 3,
        "text": "Decreased activity of glycogen synthase"
      },
      {
        "id": 4,
        "text": "Inhibition of  glucose 6-phosphatase"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<div class=\"page\" title=\"Page 941\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Insulin inhibits glucose-6-phosphatase.</p>\n<p>Insulin promotes liver uptake, storage, and the use of glucose. After a meal, insulin causes glucose&nbsp;to be rapidly stored in the liver in the form of glycogen. This occurs by:&nbsp;</p>\n<div class=\"page\" title=\"Page 941\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<ul>\n<li><strong>Inactivation</strong> of <strong>liver phosphorylase</strong>, which is the principal enzyme that causes liver glycogen to split into glucose.&nbsp;</li>\n<li><strong>Enhanced</strong> uptake of glucose by the liver cells by increasing the activity of the enzyme <strong>glucokinase</strong>&nbsp;which causes phosphorylation of glucose after it enters the liver cells. Once phosphorylated, the glucose is temporarily trapped inside the liver cells because phosphorylated glucose cannot diffuse back through the cell membrane.</li>\n<li><strong>Increased</strong> activity of enzymes that promote glycogen synthesis, like <strong>glycogen synthase</strong>.</li>\n</ul>\n<p>When insulin levels drop (Ex: Fasting), glucose phosphatase gets activated. This causes phosphate to get detached from glucose phosphate, allowing free glucose from the liver cells to re-enter circulation.&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30 yr old male presents with recurrent attacks of sweating and dizziness. Further workup reveals hypoglycemia, elevated insulin and C-peptide levels. He is diagnosed with insulinoma and given diazoxide. Which of the following is the mechanism of action of this drug?",
    "choices": [
      {
        "id": 1,
        "text": "Opening of the ATP Sensitive K+ channels"
      },
      {
        "id": 2,
        "text": "Closing of the ATP Sensitive K+ channels"
      },
      {
        "id": 3,
        "text": "Increase in number of GLUT-4 receptors"
      },
      {
        "id": 4,
        "text": "Opening of the voltage sensitive Ca2+ channels"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Diazoxide acts by&nbsp;<strong>opening ATP sensitive K+ channels</strong> and causing a <strong>decrease</strong> in<strong> insulin</strong> secretion.&nbsp;</p>\n<p><strong>Glucose</strong> enters beta cells of the pancreas via <strong>GLUT-2</strong> receptors. Once inside, it is phosphorylated by <strong>glucokinase</strong> (rate-limiting step) to glucose-6-phosphate which is&nbsp;oxidized to form adenosine triphosphate (<strong>ATP</strong>). This ATP causes <strong>closure</strong> of ATP-sensitive <strong>potassium</strong> channels and hence <strong>depolarization</strong>. This leads to <strong>opening</strong> voltage-gated <strong>calcium</strong> channels and Ca2+ influx. This stimulates <strong>fusion</strong> of the insulin-containing vesicles with the cell membrane and <strong>secretion of insulin</strong> into the extracellular fluid by <strong>exocytosis</strong>.&nbsp;</p>\n<p><strong>Diazoxide</strong> keeps the ATP sensitive <strong>K+ channels</strong> <strong>open</strong> and prevents depolarization and subsequent insulin release.&nbsp;</p>\n<p><strong>Sulfonylureas</strong> cause <strong>closure</strong> of the ATP sensitive <strong>K+ channels</strong>, leading to increased insulin secretion.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f34b03dde7034bfa9a0264068500b34bx1280x1768.JPEG"
    ]
  },
  {
    "text": "Coma occurs at a glucose level below _____.",
    "choices": [
      {
        "id": 1,
        "text": "30 mg/dl"
      },
      {
        "id": 2,
        "text": "45 mg/dl"
      },
      {
        "id": 3,
        "text": "15 mg/dl"
      },
      {
        "id": 4,
        "text": "5 mg/dl"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Coma occurs when glucose levels fall below 30 mg/dL.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2d29bde55b0045a8b7a573f74632e9a2x1021x1405.JPEG"
    ]
  },
  {
    "text": "Which of the following hormones use receptor tyrosine kinase signalling?",
    "choices": [
      {
        "id": 1,
        "text": "Insulin"
      },
      {
        "id": 2,
        "text": "TSH"
      },
      {
        "id": 3,
        "text": "TRH"
      },
      {
        "id": 4,
        "text": "MSH"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Insulin</strong>&nbsp;uses the <strong>receptor tyrosine kinase signalling</strong> to exert its functions.</p>\n<p>Other hormones acting in a similar fashion includes</p>\n<ul>\n<li>Growth hormone</li>\n<li><strong>Growth</strong> <strong>factors</strong> like VEGF, PDGF, FGF, NGF</li>\n<li>Prolactin</li>\n<li>Leptin</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '38 The Pancreas';
        const quizFilename = '38-the-pancreas-cec48fe2.html';
        let hierarchy = ["Marrow", "qBank", "Physiology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>