<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>099 Hiv   Aids - Epidemiology And Clinical Features - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">18</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "What is the approximate time interval between HIV infection & manifestation of AIDS?",
    "choices": [
      {
        "id": 1,
        "text": "7.5 years"
      },
      {
        "id": 2,
        "text": "10 years"
      },
      {
        "id": 3,
        "text": "12 years"
      },
      {
        "id": 4,
        "text": "5 years"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>After exposure to the HIV virus, there occurs <strong>primary infection</strong> following an incubation period of <strong>2-4 weeks</strong>, which is usually symptomatic in more than 50% of cases, following <strong>3-6 weeks</strong> there is <strong>acute HIV syndrome</strong> due to wide dissemination of the virus, characterized by fever, sore throat, diarrhea, lymphadenopathy, and rash.</p>\n<p>This <strong>peak viremia drops</strong> as the <strong>immune response develops</strong>, to reach a <strong>plateau</strong> about <strong>3 months later</strong>.&nbsp;Following this there is a prolonged period of <strong>clinical latency</strong>, during which infected individuals are <strong>asymptomatic</strong>, lasting for a median of <strong>10 years</strong>.</p>\n<p>Following this period, <strong>chronic persistent infection</strong> develops which is the hallmark of HIV disease called&nbsp;<strong>Acquired immunodeficiency syndrome</strong> (AIDS).</p>\n<p>Long-term non-progressors: a small part of <strong>untreated HIV-infected</strong> people with <strong>CD4 counts</strong> within the <strong>reference range</strong> for <strong>&gt;10 years</strong>.&nbsp;</p>\n<p>Elite controllers: Some <strong>long-term non-progressors</strong> have <strong>undetectable viral loads</strong>.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3427d6415f6a4fbaa5309f656fe49894x1280x1475.JPEG"
    ]
  },
  {
    "text": "Which of the following case scenarios depict a mode of transmission that carries the highest risk of acquiring HIV?",
    "choices": [
      {
        "id": 1,
        "text": "A 23-year-old drug addict sharing syringes during intravenous drug abuse"
      },
      {
        "id": 2,
        "text": "A 15-year-old thalassemic adolescent undergoing blood transfusion"
      },
      {
        "id": 3,
        "text": "A 30-year-old man engaging in unprotected sexual intercourse with multiple partners"
      },
      {
        "id": 4,
        "text": "A 27-year-old nurse accidentally injuring herself while drawing blood"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Blood transfusion</strong> carries the highest risk of acquiring HIV.</p>\n<p>Salient features of transmission of HIV:</p>\n<ul>\n<li>The <strong>highest&nbsp;</strong>risk of acquiring HIV from an infected source is via&nbsp;<strong>blood transfusion</strong> &gt; needle sharing during drug abuse &gt; receptive anal intercourse &gt; needle-stick injury &gt; vaginal &amp; oral sexual intercourse.</li>\n<li>The <strong>most common </strong>mode of transmission worldwide is <strong>sexual transmission</strong> (heterosexual in India) &gt; mother to child &gt; <strong>least common</strong> modes are blood transfusion &amp; <strong>needle-stick injury</strong>.</li>\n<li>Male to female transmission &gt; female to male transmission.</li>\n<li>Viral load is <strong>highest</strong> in <strong>blood</strong> &gt; semen &gt; vaginal fluid &gt; breastmilk &amp; saliva and minimal to absent in tears, sweat &amp; urine.&nbsp;</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which statement regarding HIV infection is true?",
    "choices": [
      {
        "id": 1,
        "text": "HIV-2 is more pathogenic than HIV -1"
      },
      {
        "id": 2,
        "text": "HIV-1 subtype C is the most common form worldwide"
      },
      {
        "id": 3,
        "text": "HIV-2 is prevalent worldwide"
      },
      {
        "id": 4,
        "text": "Donated blood is not screened for HIV- 2"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>HIV-1 subtype C</strong> is the <strong>most common</strong> form worldwide.</p>\n<p>Human Immunodeficiency Virus (HIV) has two<strong>\u00a0serotypes HIV-1 and HIV- 2 </strong>based on differences in the<strong> env (envelope) gene</strong>.\u00a0</p>\n<p><strong>HIV-1</strong> is further divided into 4 distinct groups,\u00a0group\u00a0<strong>M</strong> (major)<strong>/N/O/P</strong>. The M group comprises nine\u00a0subtypes A, B, C, D, F, G, H, J, and K.</p>\n<ul>\n<li><strong>Subtype C</strong> is the <strong>most common</strong> form worldwide &amp; is more associated with <strong>heterosexual</strong> transmission.</li>\n<li><strong>Subtype B</strong> is more associated with spread through blood and <strong>homosexual</strong> contact.</li>\n</ul>\n<p>Options A, C: HIV- 2\u00a0is <strong>less pathogenic</strong> than HIV-1 and is predominantly confined to <strong>Africa</strong>.</p>\n<p>Option D: Donated blood\u00a0is\u00a0screened for both <strong>HIV -1 &amp; HIV-2</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 47-year-old phlebotomist suffered a needle-stick injury while drawing blood from a patient with HIV. Which of the following mutations in him can cause a resistance to acquiring HIV infection?",
    "choices": [
      {
        "id": 1,
        "text": "CXCR4 2q21 mutation"
      },
      {
        "id": 2,
        "text": "HLA B*35"
      },
      {
        "id": 3,
        "text": "CCR5 delta 32 mutation"
      },
      {
        "id": 4,
        "text": "DC-SIGN"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>CCR 5 delta 32 mutation</strong> causes <strong>resistance</strong> <strong>to HIV infection</strong>. It&nbsp;is a mutated allele that causes a <strong>lack</strong> of surface expression of the <strong>CCR5</strong> co-receptor resulting in blockade of HIV entry and resistance to HIV infection.</p>\n<p>Homozygous alleles cause complete resistance to HIV infection &amp; heterozygous alleles cause partial resistance.</p>\n<p><strong>CXCR4 </strong>and<strong> CCR5</strong> are <strong>chemokine receptors</strong> (co-receptors) present on the surface of CD4+ T-helper&nbsp;cells &amp; macrophages that aid in the <strong>fusion and entry</strong> of the HIV virus.&nbsp;</p>\n<p><strong>DC-SIGN</strong> is a type of cell surface lectin receptor to which the HIV virus has the affinity to bind. The expression of this type of receptor on dendritic cells (antigen-presenting cells)<strong> enhances the infectivity</strong> of HIV.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 19-year-old woman presents to the casualty with a 24-hour history of fever, sore throat, and diffuse erythematous macular rash. Past history is positive for unprotected intercourse with a new partner. What is true about the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Incubation period is around 1 week"
      },
      {
        "id": 2,
        "text": "Weight loss is not seen"
      },
      {
        "id": 3,
        "text": "Virus is transmissible"
      },
      {
        "id": 4,
        "text": "Opportunistic infections do not occur"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The given clinical scenario is suggestive of&nbsp;<strong>acute HIV syndrome</strong>. The <strong>virus is transmissible</strong>&nbsp;during this early infection period.</p>\n<p class=\"p1\">It is characterized by <strong>acute burst of viremia</strong> and <strong>wide virus dissemination</strong> and seeding of lymphoid organs (e.g., gut-associated lymphoid tissue), culminating in the destruction of CD4+ cells.&nbsp;</p>\n<div class=\"page\" title=\"Page 5864\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>The <strong>p24 antigen capture assay</strong> is used as a screening test for HIV infection in patients suspected of having the acute HIV syndrome.</p>\n</div>\n</div>\n</div>\n</div>\n<p>Option A: The <strong>incubation period</strong> for acute HIV syndrome is around <strong>3 to 6 weeks.</strong></p>\n<p>Option B: The acute HIV syndrome is typical of an acute viral syndrome and is very similar to acute infectious mononucleosis. The clinical findings include fever, sore throat, and lymphadenopathy. Rash, headache, arthralgia, and anorexia/<strong>weight loss</strong> can also be seen.</p>\n<p>Option D: <strong>Opportunistic infections can occur&nbsp;</strong>during this stage of infection, reflecting the immunodeficiency that results from reduced numbers of CD4+T cells.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the correct WHO staging for an HIV-infected child with unexplained persistent parotid enlargement?",
    "choices": [
      {
        "id": 1,
        "text": "Stage 1"
      },
      {
        "id": 2,
        "text": "Stage 2"
      },
      {
        "id": 3,
        "text": "Stage 3"
      },
      {
        "id": 4,
        "text": "Stage 4"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Unexplained persistent <strong>parotid enlargement</strong> in an HIV-infected child is categorized as&nbsp;<strong>stage 2</strong> of HIV disease according to WHO staging.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bee35d0a8b4c44a8b5b129428a4b73cbx720x671.JPEG"
    ]
  },
  {
    "text": "An HIV-positive individual presents with the following finding. What is the diagnosis & WHO staging?",
    "choices": [
      {
        "id": 1,
        "text": "Oral candidiasis & WHO stage 2"
      },
      {
        "id": 2,
        "text": "Oral hairy leukoplakia & WHO stage 3"
      },
      {
        "id": 3,
        "text": "Oral candidiasis & WHO stage 3"
      },
      {
        "id": 4,
        "text": "Oral hairy leukoplakia & WHO stage 2"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Oral candidiasis</strong> (thrush) is categorized as&nbsp;<strong>WHO stage 3</strong>.</p>\n<p>Oral candidiasis&nbsp;and oral hairy leukoplakia are oral lesions categorized as WHO clinical stage 3. They generally occur in patients with <strong>CD4+ T cell counts of &lt;300/&mu;L.</strong></p>\n<table style=\"height: 210px; width: 465px;\">\n<tbody>\n<tr style=\"height: 23px;\">\n<td style=\"width: 80px; height: 23px;\">&nbsp;</td>\n<td style=\"width: 282.047px; height: 23px;\"><strong>Oral candidiasis</strong></td>\n<td style=\"width: 303.953px; height: 23px;\"><strong>Oral hairy leukoplakia</strong></td>\n</tr>\n<tr style=\"height: 2px;\">\n<td style=\"width: 80px; height: 2px;\">\n<p class=\"\">Cause</p>\n</td>\n<td style=\"width: 282.047px; height: 2px;\">\n<p class=\"\"><em>Candida albicans</em></p>\n</td>\n<td style=\"width: 303.953px; height: 2px;\">Epstein-Barr virus&nbsp;</td>\n</tr>\n<tr style=\"height: 11px;\">\n<td style=\"width: 80px; height: 11px;\">Appearance</td>\n<td style=\"width: 282.047px; height: 11px;\">\n<p class=\"\">White, plaque-like lesions with cheesy exudate, on an erythematous mucosa</p>\n</td>\n<td style=\"width: 303.953px; height: 11px;\">\n<p>White, frond-like lesions with hair-like growths from folds in the patches</p>\n</td>\n</tr>\n<tr style=\"height: 23px;\">\n<td style=\"width: 80px; height: 23px;\">Location&nbsp;</td>\n<td style=\"width: 282.047px; height: 23px;\">Posterior oropharynx</td>\n<td style=\"width: 303.953px; height: 23px;\">Lateral borders of tongue</td>\n</tr>\n<tr style=\"height: 23px;\">\n<td style=\"width: 80px; height: 23px;\">Clinical features</td>\n<td style=\"width: 282.047px; height: 23px;\">\n<p class=\"\">Typically painful, can be easily brushed off</p>\n</td>\n<td style=\"width: 303.953px; height: 23px;\">Typically painless,&nbsp;cannot be brushed&nbsp;</td>\n</tr>\n<tr style=\"height: 23px;\">\n<td style=\"width: 80px; height: 23px;\">Investigation&nbsp;</td>\n<td style=\"width: 282.047px; height: 23px;\">\n<p class=\"\">KOH preparation demonstrates budding yeasts, hyphae, or pseudohyphae</p>\n</td>\n<td style=\"width: 303.953px; height: 23px;\">\n<p class=\"\">Despite its name, it is not considered premalignant.&nbsp;</p>\n</td>\n</tr>\n<tr style=\"height: 23px;\">\n<td style=\"width: 80px; height: 23px;\">Treatment&nbsp;</td>\n<td style=\"width: 282.047px; height: 23px;\">&nbsp;Antifungals</td>\n<td style=\"width: 303.953px; height: 23px;\">Antivirals</td>\n</tr>\n</tbody>\n</table>\n<p class=\"p1\">The image given below shows a patient with&nbsp;oral hairy leukoplakia.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/9521c953e6664507b3e6ee8d585b3eff.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8c2e6a01699046e8969f6f264309a917x334x242.PNG"
    ]
  },
  {
    "text": "What is the most common opportunistic infection in HIV-infected individuals?",
    "choices": [
      {
        "id": 1,
        "text": "Tuberculosis"
      },
      {
        "id": 2,
        "text": "Disseminated candidiasis"
      },
      {
        "id": 3,
        "text": "Herpes zoster"
      },
      {
        "id": 4,
        "text": "Pneumocystis jiroveci pneumonia"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Tuberculosisis</strong> the most common opportunistic infection in HIV-infected individuals <strong>globally and</strong> in <strong>India</strong>.</p>\n<p>In patients with relatively<strong> high CD4+ T cell counts</strong>, the typical pattern of <strong>pulmonary reactivation</strong> occurs (60&ndash;80%). In patients with <strong>lower</strong> CD4+ T cell counts, <strong>disseminated disease</strong>&nbsp;is seen.</p>\n<p><strong>Primary prophylaxis:</strong>&nbsp;<strong>Isoniazid </strong>and <strong>pyridoxine</strong> for <strong>9 months</strong> for HIV-infected individuals meeting the following conditions:</p>\n<ul>\n<li>PPD skin-test reaction of &gt;5 mm or,</li>\n<li>Positive IFN-&gamma; release assay or,</li>\n<li>Close household contacts of persons with active tuberculosis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A previously untreated HIV-positive patient is diagnosed with tuberculosis and treatment is initiated for both the diseases. Two weeks into treatment, he suddenly complains of high fever, severe malaise and worsening cough. What is the likely explanation?",
    "choices": [
      {
        "id": 1,
        "text": "Resistance to anti-tubercular therapy"
      },
      {
        "id": 2,
        "text": "Concurrent treatment with anti-retroviral therapy"
      },
      {
        "id": 3,
        "text": "Bacterial endotoxin release due to death of TB bacilli"
      },
      {
        "id": 4,
        "text": "Hypersensitivity reaction to isoniazid"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Concurrent treatment</strong> with <strong>anti-retroviral therapy</strong> is the most likely explanation in this case resulting in&nbsp;<strong>Immune Reconstitution Inflammatory Syndrome</strong> (IRIS). Its characteristics are:</p>\n<ul>\n<li>Temporary <strong>paradoxical exacerbation</strong> of symptoms (lymphadenopathy, fever or worsening of pulmonary infiltrations, pleural effusion) and radiographic manifestations of TB after starting ART. This occurs as a result of <strong>immune reconstitution</strong> due to <strong>simultaneous&nbsp;</strong>administration of <strong>ART and ATT</strong>.&nbsp;</li>\n<li>It<strong>&nbsp;</strong>is seen weeks to months following the initiation of combination antiretroviral therapy (cART).</li>\n<li>It is most common in <strong>previously untreated</strong> patients starting therapy with a CD4+ T cell count <strong>&lt;50/&mu;L</strong> who experience a sudden drop in viral load.</li>\n<li>The earlier ART is started and the lower the baseline CD4+ T-cell count, the greater the risk of IRIS.</li>\n<li>In severe cases, the use of immunosuppressive drugs such as <strong>glucocorticoids</strong> may be required to blunt the inflammatory component of IRIS while specific antimicrobial therapy takes effect.</li>\n</ul>\n<p>Note: Hypersensitivity to isoniazid is extremely rare and the presentation includes maculopapular rash.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An HIV-positive man presents with a high-grade fever. Examination reveals the following finding. CSF shows reduced glucose, increased protein, and increased leukocytes. What is the most common cause of this condition in such patients?",
    "choices": [
      {
        "id": 1,
        "text": "Streptococcus pneumoniae"
      },
      {
        "id": 2,
        "text": "Herpes simplex virus"
      },
      {
        "id": 3,
        "text": "Toxoplasma gondii"
      },
      {
        "id": 4,
        "text": "Cryptococcus neoformans"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p class=\"p1\">The given clinical scenario, along with a&nbsp;<strong>positive Kernig's sign</strong>,&nbsp;is suggestive of&nbsp;<strong>meningitis</strong>. <strong>Cryptococcus</strong> is the leading infectious cause of meningitis in patients&nbsp;with AIDS.&nbsp;It generally occurs in untreated patients, with CD4+ T cell counts <strong>&lt;100/&mu;L</strong>. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>\n<p>Most patients present with a picture of <strong>subacute meningoencephalitis</strong>.&nbsp;The CSF profile may show modest elevations in WBC or protein levels and decrease in glucose. The CSF opening pressure is usually elevated (yeast colonies obstruct the free flow of CSF causing <strong>increased CSF pressure</strong>).</p>\n<p>The <strong>diagnosis</strong> of cryptococcal meningitis is made by identification of <em>Cryptococcus neoformans</em> yeast cells in <strong>CSF</strong> with<strong> india ink stain</strong> or by the detection of cryptococcal antigen using <strong>latex agglutination&nbsp;(CrAg).</strong></p>\n<p>Prophylaxis: <strong>Oral fluconazole </strong>when CD4+ T cell count is <strong>&lt;100/&mu;L.</strong></p>\n<p>Treatment:</p>\n<ul>\n<li><strong>Induction&nbsp;</strong>- IV or liposomal <strong>amphotericin B with flucytosine</strong> for at least 2 weeks, continuing with amphotericin alone ideally until the CSF culture turns negative.</li>\n<li><strong>Maintenance&nbsp;</strong>-&nbsp; Oral <strong>fluconazole</strong> until the CD4+ T cell count has increased to &gt;200 cells/&mu;L for 6 months in response to cART.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/505060e2c15c41f5a879f53aa4a8efa6.GIF"
    ],
    "explanation_images": []
  },
  {
    "text": "AIDS-defining malignancies include all except :",
    "choices": [
      {
        "id": 1,
        "text": "Kaposi's sarcoma"
      },
      {
        "id": 2,
        "text": "Melanoma"
      },
      {
        "id": 3,
        "text": "Invasive cervical carcinoma"
      },
      {
        "id": 4,
        "text": "Non hodgkins lymphoma"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Note :&nbsp;<span data-sheets-value=\"{&quot;1&quot;:2,&quot;2&quot;:&quot;The FDA has expanded the indication of pomalidomide, a thalidomide analogue to be included in treating adult patients with AIDS-related Kaposi sarcoma after failure of highly active antiretroviral therapy and Kaposi sarcoma in adult patients who are HIV-negative&quot;}\" data-sheets-userformat=\"{&quot;2&quot;:33555327,&quot;3&quot;:{&quot;1&quot;:0},&quot;4&quot;:{&quot;1&quot;:2,&quot;2&quot;:16777215},&quot;5&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;6&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;7&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;8&quot;:{&quot;1&quot;:[{&quot;1&quot;:2,&quot;2&quot;:0,&quot;5&quot;:{&quot;1&quot;:2,&quot;2&quot;:0}},{&quot;1&quot;:0,&quot;2&quot;:0,&quot;3&quot;:3},{&quot;1&quot;:1,&quot;2&quot;:0,&quot;4&quot;:1}]},&quot;9&quot;:0,&quot;11&quot;:4,&quot;12&quot;:0,&quot;28&quot;:1}\">The FDA has approved <strong>pomalidomide</strong>, a thalidomide analogue to be included in treating adult patients with AIDS-related Kaposi's sarcoma after failure of highly active antiretroviral therapy and Kaposi's sarcoma in adult patients who are HIV-negative.</span></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2a1b5b50b45e4f01b58e94ceed3aefbdx1280x854.PNG"
    ]
  },
  {
    "text": "A 45-year-old HIV-positive woman presented with fever and malaise. She gives a history of bleeding from the following lesions. Warthin-Starry staining of a biopsy sample taken from the lesion showed which organism?",
    "choices": [
      {
        "id": 1,
        "text": "Bartonella henselae"
      },
      {
        "id": 2,
        "text": "Human Herpes virus - 8"
      },
      {
        "id": 3,
        "text": "Bartonella  bacilliformis"
      },
      {
        "id": 4,
        "text": "Ebstein Barr Virus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Option B: <strong>HHV 8</strong>&nbsp;is strongly associated with Kaposi sarcoma.</p>\n<p>Option C: <strong><em>Bartonella bacilliformis</em>&nbsp;</strong>causes Oroya fever.</p>\n<p>Option D: <strong>EBV</strong> causes infectious mononucleosis.</p>\n<p>Note:&nbsp;<em>Bartonella henselae</em> causes <strong>cat-scratch disease,&nbsp;</strong>a necrotizing granulomatous disorder of lymph nodes, in<strong> immunocompetent hosts.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4b7b01fce7a348aba1f4a21a73369ef0.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c3fd558935c49d09f89841c1eaecb67x224x180.JPEG"
    ]
  },
  {
    "text": "An HIV-positive woman was rushed to the ICU following an episode of generalized tonic-clonic seizures. There was no history of fever, night sweats or weight loss. MRI scan is shown below. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Cryptococcal meningitis"
      },
      {
        "id": 2,
        "text": "Primary central nervous system lymphoma"
      },
      {
        "id": 3,
        "text": "Cerebral toxoplasmosis"
      },
      {
        "id": 4,
        "text": "Progressive multifocal leukoencephalopathy"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The given clinical scenario is suggestive of&nbsp;<strong>cerebral toxoplasmosis.</strong>&nbsp;<strong>MRI</strong> scan shows multiple <strong>ring-enhancing lesions</strong>.</p>\n<p>Cerebral toxoplasmosis is one of the <strong>most common </strong>AIDS-defining <strong>opportunistic CNS infections</strong> and usually occurs in patients with CD4+ T cell counts <strong>&lt;200/&mu;L.&nbsp;</strong>It&nbsp;is usually a reactivation of latent tissue cysts.<span style=\"font-size: 14px;\">&nbsp;</span></p>\n<p>It usually has&nbsp;<strong>multiple lesions</strong> in multiple locations which are associated with inflammation and central necrosis, and hence show&nbsp;ring enhancement&nbsp;on contrast MRI. Sometimes an eccentric nodular area of enhancement is seen within the ring; this so-called <strong>eccentric target sign</strong> is typical of cerebral toxoplasmosis.&nbsp;<strong>Surrounding edema </strong>is also present.</p>\n<p>Treatment includes&nbsp;<strong>sulfadiazine/pyrimethamine</strong> and <strong>leucovorin</strong> for a minimum of 4&ndash;6 weeks.&nbsp;</p>\n<p><strong>Primary prophylaxis: </strong>It is given to patients with <strong>IgG antibody to toxoplasma and</strong>&nbsp;<strong>CD4+ T cell</strong> count <strong>&lt;100/&mu;L</strong>.&nbsp;A single double strength tablet of&nbsp;trimethoprim/sulfamethoxazole (TMP/SMX)&nbsp;is given.</p>\n<p><strong>Secondary prophyaxis</strong>/maintanace therapy: It is given when&nbsp;<strong>CD4+ T cell counts &lt;200 cells/&mu;L</strong>. Sulfadiazine/pyrimethamine and leucovorin&nbsp;is given. It is discontinued if the CD4+ T cell counts are maintained &gt;200/&mu;L for 6 months.</p>\n<p>Option A: <strong>Cryptococcal meningitis</strong> presents with fever, nausea, vomiting, altered mental status, headache, and meningeal signs. Seizures and focal neurologic deficits are rarely seen.&nbsp;<strong>MRI</strong> findings include <strong>dilated perivascular spaces</strong> and basal ganglia pseudocysts.&nbsp;</p>\n<p>Option B: <strong>Primary CNS lymphoma</strong> also presents with seizures and focal neurological deficit.<strong>&nbsp;</strong>Symptoms of fever, night sweats and weight loss are present in&nbsp;80% of the patients.&nbsp;On imaging, it is identified as a CT hyperdense enhancing supratentorial mass, with <strong>MRI </strong>T1 <strong>hypointense</strong>, T2 iso- to hypointense, vivid <strong>homogeneous enhancement</strong> as well as <strong>restricted diffusion</strong>.&nbsp;</p>\n<p>Option C: <strong>Progressive multifocal leukoencephalopathy,</strong>&nbsp;caused by JC virus, is characterized by demyelination in subcortical white matter reflected on <strong>MRI</strong> as <strong>multiple, non-enhancing</strong> white matter lesions.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/92e01cc7c83d41c2bb2579d461cf39d7.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following are AIDS defining illnesses except:",
    "choices": [
      {
        "id": 1,
        "text": "Encephalopathy attributed to HIV"
      },
      {
        "id": 2,
        "text": "Invasive cervical cancer"
      },
      {
        "id": 3,
        "text": "Mycobacterium tuberculosis of any site"
      },
      {
        "id": 4,
        "text": "Oral candidiasis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Oral candidiasis</strong>, although seen in AIDS patients, is <strong>not</strong> an <strong>AIDS-defining</strong> illness. <strong>Candidiasis</strong> of the <strong>esophagus</strong>, <strong>trachea</strong>, <strong>bronchi,</strong> and <strong>lungs</strong> are AIDS-defining illnesses.&nbsp;</p>\n<p>AIDS-defining illnesses are specific <strong>opportunistic</strong> illnesses in patients with <strong>AIDS</strong>, which signify an advanced stage of illness (<strong>Stage 3</strong>).</p>\n<p>A case of HIV can be classified into five stages as per current CDC guidelines (0, 1, 2, 3, and unknown).</p>\n<table style=\"border-collapse: collapse; width: 100.025%; height: 166.368px;\" border=\"1\">\n<tbody>\n<tr style=\"height: 22.3924px;\">\n<td style=\"width: 32.2899%; height: 22.3924px;\">\n<p><strong>Stage</strong></p>\n</td>\n<td style=\"width: 32.2899%; height: 22.3924px;\"><strong>Criteria</strong></td>\n<td style=\"width: 32.2906%; height: 22.3924px;\"><strong>CD4+ count (&gt;5 years)</strong></td>\n</tr>\n<tr style=\"height: 54.3924px;\">\n<td style=\"width: 32.2899%; height: 54.3924px;\">\n<p>0</p>\n</td>\n<td style=\"width: 32.2899%; height: 54.3924px;\">A negative HIV test within 6 months of first diagnosis</td>\n<td style=\"width: 32.2906%; height: 54.3924px;\">NA</td>\n</tr>\n<tr style=\"height: 22.3958px;\">\n<td style=\"width: 32.2899%; height: 22.3958px;\">1</td>\n<td style=\"width: 32.2899%; height: 22.3958px;\">Based on CD4+ count</td>\n<td style=\"width: 32.2906%; height: 22.3958px;\">&gt;=500</td>\n</tr>\n<tr style=\"height: 22.3958px;\">\n<td style=\"width: 32.2899%; height: 22.3958px;\">2</td>\n<td style=\"width: 32.2899%; height: 22.3958px;\">Based on CD4+ count</td>\n<td style=\"width: 32.2906%; height: 22.3958px;\">200-499</td>\n</tr>\n<tr style=\"height: 22.3958px;\">\n<td style=\"width: 32.2899%; height: 22.3958px;\">3</td>\n<td style=\"width: 32.2899%; height: 22.3958px;\"><strong>AIDS-defining opportunistic illness</strong></td>\n<td style=\"width: 32.2906%; height: 22.3958px;\">&lt;200</td>\n</tr>\n<tr style=\"height: 22.3958px;\">\n<td style=\"width: 32.2899%; height: 22.3958px;\">unknown</td>\n<td style=\"width: 32.2899%; height: 22.3958px;\">Unavailable CD4+ counts</td>\n<td style=\"width: 32.2906%; height: 22.3958px;\">unknown</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An HIV-positive woman was referred to the ophthalmology OPD for decreased visual acuity. She described her vision as blurry with apparent flies floating in her field of vision. Fundoscopy revealed the following finding.  What is the CD4+T cell count at which majority of such cases occur?",
    "choices": [
      {
        "id": 1,
        "text": "< 200/\u03bcL"
      },
      {
        "id": 2,
        "text": "< 50/\u03bcL"
      },
      {
        "id": 3,
        "text": "< 150/\u03bcL"
      },
      {
        "id": 4,
        "text": "< 250/\u03bcL"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p class=\"p1\">The given clinical scenario, along with the\u00a0<strong>p</strong><strong>izza pie appearance </strong>on fundoscopy<strong>,\u00a0</strong>is suggestive of <strong>cytomegalovirus (CMV) retinitis.</strong>\u00a0The majority of such cases occur in HIV-infected patients with a CD4+T cell count <strong>&lt;50/\u03bcL</strong>.</p>\n<p>CMV retinitis is a necrotic retinal infection that results in a <strong>painless</strong>\u00a0<strong>irreversible vision loss</strong>. Patients may complain of blurred vision, <strong>floaters\u00a0</strong>(described by patient as flies or spiders in the field of vision), and scintillations. It is usually bilateral and is characterized by <strong>perivascular hemorrhage </strong>and <strong>exudates</strong> in the retina\u00a0(<strong>pizza pie appearance</strong>\u00a0or\u00a0<strong>scrambled eggs and ketchup appearance</strong>).</p>\n<p>Treatment:</p>\n<ul>\n<li>Induction - IV <strong>ganciclovir </strong>(3 weeks)</li>\n<li>Maintenance - Oral <strong>valganciclovir </strong>(till CD4 count &gt; 100/\u03bcl for 6months)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b26695e10a7f4c52b271d3f99fcf3e8b.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A unemployed HIV-positive patient, resident of a missionary home, presents with 2 weeks of fever, cough and night sweats. He was devastated after getting fired from his job because of his diagnosis and has since been non-compliant to cART. His CD4 count is <10/ \u03bcL. CT scan shows the following finding. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Cytomegalovirus infection"
      },
      {
        "id": 2,
        "text": "Candidiasis"
      },
      {
        "id": 3,
        "text": "Mycobacterium avium complex infection"
      },
      {
        "id": 4,
        "text": "Pneumocystis jiroveci pneumonia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p class=\"p1\">The given clinical scenario is suggestive of <strong>mycobacterium avium complex (MAC) </strong>infection. It&nbsp;is an <strong>AIDS-defining opportunistic infection</strong>, occurring predominantly at CD4+ T cell counts of <strong>&lt;50/&mu;L.</strong></p>\n<p class=\"p1\">The most common presentation is <strong>disseminated disease</strong> with fever, weight loss, and night sweats. The diagnosis is made by <strong>culture</strong> of blood or involved tissue.</p>\n<p class=\"p1\"><strong>CT scan&nbsp;</strong>shows&nbsp;<strong>peribronchial inflammation</strong> of the infected lung giving rise to a <strong>tree in a bud appearance </strong>(small round structures attached to linear structures) indicated by the arrowhead. In severe cases, there might be bronchiectasis and cavity formation.</p>\n<p class=\"p1\">Treatment consists of <strong>clarithromycin / azithromycin</strong> with ethambutol/ rifabutin. Primary prophylaxis with <strong>azithromycin</strong> is indicated in patients with CD4+ T cell counts &lt;50/&mu;L.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4e1d63cd405c4a1985c845e7a600d4f9.PNG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old man with HIV presents with lab reports showing: Low albumin, massive proteinuria. Renal ultrasound shows large, echogenic kidneys. Blood pressure is normal. Which of the following is the most likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Minimal change disease"
      },
      {
        "id": 2,
        "text": "Focal segmental glomerulosclerosis"
      },
      {
        "id": 3,
        "text": "Membranoproliferative glomerulonephritis"
      },
      {
        "id": 4,
        "text": "IgA nephropathy"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>This patient with HIV presents with massive proteinuria and hypoalbuminemia. The most likely cause is HIV-1-associated nephropathy (<strong>HIVAN</strong>) - a form of <strong>focal segmental glomerulosclerosis (FSGS)</strong>.&nbsp;</p>\n<p>Proteinuria is the hallmark of this disorder. Edema and hypertension are rare. A definitive diagnosis is obtained through renal biopsy.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most common form of heart disease associated with HIV?",
    "choices": [
      {
        "id": 1,
        "text": "Dilated cardiomyopathy"
      },
      {
        "id": 2,
        "text": "Thrombotic endocarditis"
      },
      {
        "id": 3,
        "text": "Coronary heart disease"
      },
      {
        "id": 4,
        "text": "Pericardial effusion"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The most common form of heart disease associated with HIV infection is <strong>coronary heart disease. </strong></p>\n<p>In patients with HIV infection, cardiovascular disease may be a direct consequence of HIV infection, a complication of anti-retroviral therapy or due to classical risk factors like smoking.&nbsp;</p>\n<p>Exposure to HIV<strong> protease inhibitors</strong> and reverse transcriptase inhibitors have been associated with an <strong>increase in total cholesterol</strong> and/or risk of MI (Myocardial infarction).</p>\n<p><strong>Dilated cardiomyopathy</strong> associated with congestive heart failure (CHF) is referred to as <strong>HIV-associated cardiomyopathy</strong>. This generally occurs as a late complication of HIV infection and, histologically, displays elements of myocarditis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '099 Hiv   Aids - Epidemiology And Clinical Features';
        const quizFilename = '099-hiv-aids-epidemiology-and-clinical-features-c20825a6.html';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>