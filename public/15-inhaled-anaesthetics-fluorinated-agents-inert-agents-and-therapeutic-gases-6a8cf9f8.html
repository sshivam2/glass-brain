<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15 Inhaled Anaesthetics - Fluorinated Agents, Inert Agents And Therapeutic Gases - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
  
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}


    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Anesthesia
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">23</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following inhaled anesthetics is the induction agent of choice in a patient planned for surgery under GA?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Sevoflurane"
      },
      {
        "id": 3,
        "text": "Desflurane"
      },
      {
        "id": 4,
        "text": "Nitrous oxide"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Sevoflurane</strong> is the<strong> induction agent</strong> <strong>of choice</strong> among<strong> inhalational anesthetics</strong>.<strong>&nbsp;</strong></p>\n<p>It is&nbsp;<strong>non-pungent</strong>&nbsp;and has&nbsp;<strong>low blood-gas solubility </strong>(0.65), allowing for smooth induction of anesthesia.</p>\n<p>Option A: Halothane has high blood gas solubility, leading to a slower induction of anesthesia.</p>\n<p>Option C: Desflurane and isoflurane&nbsp;are airway irritants, of which <strong>desflurane</strong> is the <strong>most pungent</strong> inhalational agent. Hence, they are not used for the induction of anesthesia as they can precipitate <strong>laryngospasm</strong>. These agents are used only during the <strong>maintenance</strong> of anesthesia.</p>\n<p>Option D: N<sub>2</sub>O has a MAC value of 104%,&nbsp;which makes it the<strong>&nbsp;least potent</strong>&nbsp;inhaled anesthetic. It is always used in combination with more potent volatile agents.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 7-year-old boy is posted for laparoscopic appendectomy. Which of the following inhalational agents is preferred for induction?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Isoflurane"
      },
      {
        "id": 3,
        "text": "Sevoflurane"
      },
      {
        "id": 4,
        "text": "Desflurane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sevoflurane</strong> is preferred for induction as it is the <strong>agent of choice</strong> in <strong>pediatric anesthesia</strong>.</p>\n<p>Option A: Although both halothane and sevoflurane provide a smooth induction, sevoflurane appears to have a greater therapeutic index than halothane and hence is the preferred agent for inhaled induction in pediatric anesthesia.</p>\n<p>Options B and D: Isoflurane&nbsp;and&nbsp;desflurane&nbsp;are&nbsp;airway irritants. Hence they are not used for induction of anesthesia as they can precipitate laryngospasm. These agents are used only during the maintenance of anesthesia.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which inhaled anesthetic has the maximum global warming potential?",
    "choices": [
      {
        "id": 1,
        "text": "Nitrous oxide"
      },
      {
        "id": 2,
        "text": "Sevoflurane"
      },
      {
        "id": 3,
        "text": "Isoflurane"
      },
      {
        "id": 4,
        "text": "Desflurane"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Desflurane</strong> has the maximum global warming potential (GWP) among inhaled anesthetics.</p>\n<p>Global warming potential of Anesthetic Gases: Nitrous oxide &lt; Isoflurane &lt; Sevoflurane &lt;&nbsp;<strong>Desflurane (m</strong><strong>aximum)</strong></p>\n<p><strong>Xenon</strong> produces <strong>no greenhouse effect</strong> or ozone depletion as it is entirely unreactive in the biosphere.</p>\n<p>Although the GWP factor of desflurane is much higher than that of<strong> nitrous oxide</strong>, the latter&nbsp;contributes the <strong>most </strong>to increased climate impact (99.97%) as the consumption volumes of N<sub>2</sub>O far exceed those of other anesthetic gases.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 39-year-old woman is posted for resection of an intracranial tumor. Which inhalational anesthetic is most suitable in this case?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Sevoflurane"
      },
      {
        "id": 3,
        "text": "Isoflurane"
      },
      {
        "id": 4,
        "text": "Desflurane"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The inhalational agent of choice for neurosurgery in patients with<strong> elevated intracranial pressure</strong>&nbsp;(intracranial tumor) is<strong> sevoflurane</strong>.</p>\n<p>Sevoflurane best <strong>preserves</strong> the <strong>autoregulation</strong> of <strong>cerebral blood flow</strong> and produces <strong>limited vasodilatation.</strong> Hence, it is the preferred volatile agent in patients with elevated ICP.</p>\n<p>The order of vasodilating potency is approximately : <strong>halothane</strong> &gt; enflurane &gt; desflurane &gt; isoflurane &gt; <strong>sevoflurane.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which anesthetic agent is to be avoided in patients diagnosed with epilepsy?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Enflurane"
      },
      {
        "id": 3,
        "text": "Nitrous oxide"
      },
      {
        "id": 4,
        "text": "Sevoflurane"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Enflurane</strong> is&nbsp;<strong>contraindicated </strong>in patients with a known history of <strong>seizures</strong>, <strong>cerebrovascular disease,</strong> and&nbsp;<strong>head injuries.</strong></p>\n<p>Enflurane is the <strong>most epileptogenic</strong> inhalational anesthetic. It increases seizure activity, especially in the presence of cerebral injury and hypocapnia, and results in increasing the cerebral metabolism manifold.&nbsp;</p>\n<p>Besides, enflurane <strong>increases cerebrospinal fluid secretion</strong> and <strong>decreases</strong> its <strong>absorption</strong> which is deleterious in those with poor intracranial compliance.</p>\n<p>Seizures have also been associated with the use of sevoflurane in high concentrations, especially in the pediatric population.</p>\n<p>Epileptogenic potential: enflurane &gt;&gt;&gt; sevoflurane</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An elderly male patient is scheduled to undergo an elective procedure. What is the choice of inhalational anesthetic you will consider for him?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Desflurane"
      },
      {
        "id": 3,
        "text": "Isoflurane"
      },
      {
        "id": 4,
        "text": "Sevoflurane"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Desflurane</strong> is the inhalational agent of choice in the <strong>elderly</strong> as it is <strong>rapidly eliminated</strong> and undergoes<strong> minimal metabolism</strong>.</p>\n<p>The amount of <strong>fluoride ion </strong>produced is only about 5 &micro;m which is much lower than the other fluorinated agents and hence safe in elderly as they may have a compromised renal function.</p>\n<p>Desflurane is also the inhalational <strong>agent of choice</strong> in <strong>renal disease</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the inhalational agent of choice for general anesthesia in asthmatic patients?",
    "choices": [
      {
        "id": 1,
        "text": "Desflurane"
      },
      {
        "id": 2,
        "text": "Sevoflurane"
      },
      {
        "id": 3,
        "text": "Halothane"
      },
      {
        "id": 4,
        "text": "Isoflurane"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Sevoflurane is the <strong>inhalational</strong>&nbsp;<strong>agent of choice</strong> for <strong>asthmatics</strong> because of its <strong>bronchodilatory</strong> <strong>effect</strong>.</p>\n<p>Although halothane produces greater bronchodilation, sevoflurane appears to have a <strong>greater therapeutic index.</strong> Halothane sensitizes the heart to adrenaline and causes cardiovascular depression, bradycardia, arrhythmias, and respiratory depression which are less likely with sevoflurane.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man with liver cirrhosis is posted for surgery. Which would be the inhalational anesthetic agent of choice?",
    "choices": [
      {
        "id": 1,
        "text": "Methoxyflurane"
      },
      {
        "id": 2,
        "text": "Nitrous oxide"
      },
      {
        "id": 3,
        "text": "Sevoflurane"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sevoflurane</strong> is the inhalational anesthetic <strong>agent</strong> <strong>of</strong> <strong>choice</strong> in <strong>liver cirrhosis.</strong></p>\n<p>A cirrhotic liver has a compromised portal venous blood flow and hence it is essential to preserve the hepatic arterial blood flow.</p>\n<p>Sevoflurane decreases portal vein blood flow but<strong> increases</strong> hepatic artery blood flow. Thus the total hepatic blood flow and oxygen delivery are better maintained.</p>\n<p>An alternative is isoflurane which may reduce hepatic arterial blood flow but maintains hepatic oxygen supply.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 7-year-old kid recovering from anesthesia started developing seizures. Which of the following inhalational agents would have been used?",
    "choices": [
      {
        "id": 1,
        "text": "Desflurane"
      },
      {
        "id": 2,
        "text": "Isoflurane"
      },
      {
        "id": 3,
        "text": "Sevoflurane"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Seizures</strong> have been associated with the use of <strong>sevoflurane</strong> in <strong>high concentrations,</strong> especially in the <strong>pediatric</strong> population.</p>\n<p>Emergence from sevoflurane is associated with tonic-clonic movements suggestive of the seizure. Hence sevoflurane must be used cautiously in patients with a known history of seizure.</p>\n<p>Though isoflurane can cause myoclonus and EEG spiking, frank seizure activity is not seen.</p>\n<p><strong>Note: Enflurane</strong> has the <strong>most epileptogenic</strong> potential among the inhaled anesthetics.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A first-year anaesthesia resident was managing a patient undergoing coronary artery bypass grafting (CABG). They noticed that the coronary perfusion pressure was not adequate. During the procedure, the patient exhibited signs of myocardial ischemia, including hypotension, ST-segment changes, and decreased cardiac output. The resident was evaluating potential causes and considering the role of anaesthetic agents. Which of the following anaesthetic agents is most likely to exacerbate these symptoms?",
    "choices": [
      {
        "id": 1,
        "text": "Nitrous oxide"
      },
      {
        "id": 2,
        "text": "Isoflurane"
      },
      {
        "id": 3,
        "text": "Desflurane"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The given clinical scenario of <strong>myocardial ischemia</strong>, <strong>hypotension</strong>, ST-segment changes, and <strong>decreased cardiac output</strong> point towards a diagnosis of <strong>coronary steal syndrome</strong>.</p>\n<p><strong>Isoflurane</strong> has been associated with myocardial ischemic symptoms, particularly in scenarios <strong>where</strong> <strong>coronary perfusion pressure</strong> is <strong>compromised</strong>.</p>\n<p>It dilates normal coronary arteries, which can redirect blood flow away from areas supplied by stenotic or diseased vessels, worsening ischemia in those regions. This redistribution of blood flow may contribute to hypotension, ST-segment changes, and reduced cardiac output. However, these effects are typically seen when hypotension occurs and can be mitigated by maintaining adequate coronary perfusion pressure.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient with impaired renal function was administered desflurane for general anesthesia. Which of the following statements is true regarding this drug?",
    "choices": [
      {
        "id": 1,
        "text": "Commonly used for induction in children"
      },
      {
        "id": 2,
        "text": "Rapid induction and recovery"
      },
      {
        "id": 3,
        "text": "Environmentally safe anesthetic"
      },
      {
        "id": 4,
        "text": "Less potent than nitrous oxide"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Desflurane has <strong>rapid induction </strong>and<strong> recovery </strong>from anesthesia due to its <strong>low blood gas solubility</strong>.</p>\n<p>Option A: Desflurane is not&nbsp;used for induction as it is very <strong>pungent</strong>&nbsp;and may result in cough, <strong>laryngospasm</strong>, and bronchospasm.</p>\n<p>Option C: Desflurane is not environmentally safe as it has the <strong>maximum global warming</strong> <strong>potential</strong> among inhalational anesthetics. However,&nbsp;<strong>N<sub>2</sub>O</strong>&nbsp;contributes the&nbsp;<strong>most</strong> to increased climate impact&nbsp;(99.97%) as the consumption volumes of N<sub>2</sub>O far exceed those of other anesthetic gases.</p>\n<p>Option D: Desflurane is 17 times more potent than nitrous oxide.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An intern notices the following canister attached to the anesthesia circuit. Which gas produces carbon monoxide when passed through it?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Methoxyflurane"
      },
      {
        "id": 3,
        "text": "Sevoflurane"
      },
      {
        "id": 4,
        "text": "Desflurane"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The canister contains desiccated <strong>soda lime.</strong>&nbsp;<strong>Desflurane</strong> undergoes <strong>degradation</strong> to produce&nbsp;<strong>carbon monoxide,</strong> in the presence of strong bases in dry <strong>CO2 absorbents</strong> (like desiccated soda lime).</p>\n<p><strong>CO</strong> production is predominantly seen with <strong>absorbents </strong>that contain<strong> sodium </strong>or<strong> potassium hydroxide.</strong>&nbsp;It is seen less with&nbsp;barium hydroxide.&nbsp;The propensity for CO production correlates with the <strong>anesthetic concentration</strong> in the breathing circuit (desflurane &gt; enflurane &gt; isoflurane).&nbsp;</p>\n<p><strong>Amsorb</strong> is a CO2 absorbent that is more inert than soda-lime and baralyme and so associated with lesser degradation of anesthetics and so <strong>less carbon monoxide</strong> production.</p>\n<p>Sevoflurane, methoxyflurane, and halothane also undergo degradation in the presence of strong bases, but they do not produce CO.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/2700327ec94645ed9293b36cdc90484d.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Which of the following inhalational agents produces a nephrotoxic substance called compound A?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Methoxyflurane"
      },
      {
        "id": 3,
        "text": "Sevoflurane"
      },
      {
        "id": 4,
        "text": "Desflurane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Sevoflurane</strong> reacts with strong bases like sodium hydroxide and potassium hydroxide present in <strong>soda-lime</strong> and <strong>baralyme</strong> leading to the formation of a <strong>haloalkene</strong> (fluoromethyl-2,2-difluoro-1-[trifluoromethyl] vinyl ether) known as <strong>compound A.</strong></p>\n<p>Compound A has the potential to cause<strong> proximal tubular necrosis.&nbsp;</strong></p>\n<p><strong>Risk factors </strong>for increased compound A production:</p>\n<ul>\n<li>Prolonged duration of anesthesia</li>\n<li>High concentration of sevoflurane</li>\n<li>Low flow techniques</li>\n<li>Dry baralyme</li>\n</ul>\n<p>A fresh gas flow of<strong> at least&nbsp;2L/ min</strong> can prevent the generation of compound A</p>\n<p><strong>Amsorb</strong> is a CO2 absorbent that is more inert than soda-lime and baralyme and so associated with lesser degradation of sevoflurane and&nbsp;<strong>less compound A</strong> production.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an incorrect statement regarding xenon?",
    "choices": [
      {
        "id": 1,
        "text": "Increases airflow resistance and work of breathing"
      },
      {
        "id": 2,
        "text": "Safe in cardiac patients"
      },
      {
        "id": 3,
        "text": "Teratogenic"
      },
      {
        "id": 4,
        "text": "Does not trigger malignant hyperthermia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Xenon is <strong>n</strong><strong>on-teratogenic</strong>.</p>\n<p>Option A:&nbsp; Xenon is its&nbsp;<strong>high density</strong>&nbsp;(5.9 g/L) gas, (much higher than oxygen and nitrous oxide) which leads to&nbsp;<strong>increased flow resistance&nbsp;</strong>and<strong>&nbsp;work of breathing</strong>. Thus it is unsuitable for patients with compromised respiratory function.</p>\n<p>Option B:&nbsp;&nbsp;It has minimal cardiovascular effects. It produces minimal cardiovascular depression and is not arrhythmogenic, hence<strong>&nbsp;safe in cardiac patients</strong>.</p>\n<p>Option D: Does <strong>not</strong> trigger malignant hyperthermia</p>\n<table style=\"height: 117px;\" width=\"1055\">\n<tbody>\n<tr>\n<td style=\"width: 519.5px; text-align: center;\"><strong>Advantages of xenon</strong></td>\n<td style=\"width: 519.5px; text-align: center;\"><strong>Disadvantages of xenon&nbsp;</strong></td>\n</tr>\n<tr>\n<td style=\"width: 519.5px;\">Inert, Non-explosive</td>\n<td style=\"width: 519.5px;\">High cost</td>\n</tr>\n<tr>\n<td style=\"width: 519.5px;\">Safe in cardiac disease&nbsp;</td>\n<td style=\"width: 519.5px;\">Low potency&nbsp;</td>\n</tr>\n<tr>\n<td style=\"width: 519.5px;\">Has analgesic activity- reduces intraoperative opioid requirements&nbsp;</td>\n<td style=\"width: 519.5px;\">High-density gas- higher flow resistance, poor choice for patients with respiratory compromise&nbsp;</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which inhalational anesthetic has a negligible greenhouse effect?",
    "choices": [
      {
        "id": 1,
        "text": "Nitrous oxide"
      },
      {
        "id": 2,
        "text": "Desflurane"
      },
      {
        "id": 3,
        "text": "Xenon"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Xenon</strong> produces <strong>no greenhouse effect</strong> or <strong>ozone depletion</strong> as it is inert in the biosphere.</p>\n<p>All the other inhaled anesthetics are greenhouse gases.&nbsp;</p>\n<p>Option A: The global warming potential of nitrous oxide is about 300 times greater than carbon dioxide.</p>\n<p>Option B: <strong>Desflurane</strong> has the <strong>maximum global warming</strong> potential among inhaled anesthetics.&nbsp;Isoflurane, sevoflurane, and desflurane undergo minimal metabolism in the body and are predominantly <strong>eliminated on expiration</strong>. If these are let out into the atmosphere without scavenging, they contribute significantly to the greenhouse effect and global warming.</p>\n<p>Option D: Halothane has the potential to destroy stratospheric ozone due to its bromine-bearing molecules.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A middle-aged man presented to the ER with stridor due to partial upper airway obstruction. You are asked to administer heliox for symptomatic relief. What is the composition of this breathing mixture?",
    "choices": [
      {
        "id": 1,
        "text": "Helium 30% and oxygen 70%"
      },
      {
        "id": 2,
        "text": "Helium 70% and oxygen 30%"
      },
      {
        "id": 3,
        "text": "Helium 50% and oxygen 50%"
      },
      {
        "id": 4,
        "text": "Helium 40% and oxygen 60%"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Heliox</strong> is a mixture of <strong>70% helium</strong> and<strong> 30% oxygen</strong>.&nbsp;</p>\n<p>It is supplied in E-size cylinders and delivered through a <strong>non-rebreathing face mask</strong> starting at a <strong>flow rate</strong> of <strong>10L/min</strong>.&nbsp;</p>\n<p>Heliox is used in cases of partial airway obstruction as in stridor to relieve the increased work of breathing.&nbsp;The flow of heliox through obstruction when compared to oxygen is higher due to its density being 40% of pure oxygen. Thus it provides <strong>symptomatic relief</strong> from <strong>acute distress</strong> before definite treatment can be instituted.</p>\n<p>The use of heliox in relieving lower airway obstruction as in acute asthma or COPD is unsatisfactory.</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an incorrect statement regarding oxygen as a therapeutic agent?",
    "choices": [
      {
        "id": 1,
        "text": "Hyperbaric oxygen increases the availability of dissolved O2 in blood"
      },
      {
        "id": 2,
        "text": "Primarily used in hypoxia"
      },
      {
        "id": 3,
        "text": "Inhalation of higher oxygen concentration increases the partial pressure of nitrogen inside the body"
      },
      {
        "id": 4,
        "text": "Can be administered at pressures greater than atmospheric oxygen pressure"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Inhalation of <strong>higher oxygen concentrations</strong> can<strong> reduce </strong>the partial <strong>pressure</strong> of <strong>nitrogen</strong> inside the body.&nbsp;&nbsp;</p>\n<p>Reduction in total body partial pressure of nitrogen provides a substantial gradient for the removal of nitrogen from gas spaces. This is beneficial in conditions such as bowel distension from obstruction of ileus, intravascular air embolism, or pneumothorax.&nbsp;</p>\n<p>Oxygen is administered at greater than atmospheric pressure in hyperbaric chambers (<strong>hyperbaric</strong> <strong>oxygen</strong>).</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "During a coronary artery bypass graft surgery, the surgeon uses a therapeutic gas to flood the surgical field. Which of the following would he use?",
    "choices": [
      {
        "id": 1,
        "text": "Oxygen"
      },
      {
        "id": 2,
        "text": "Nitric oxide"
      },
      {
        "id": 3,
        "text": "Nitrous oxide"
      },
      {
        "id": 4,
        "text": "Carbon dioxide"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Carbon dioxide</strong> (CO2) is commonly used to flood the <strong>surgical field</strong> during <strong>cardiac surgery.</strong>&nbsp;</p>\n<p>A common cause of <strong>myocardial ischemia</strong> during open-heart surgery is <strong>air embolism</strong>&nbsp;to the coronary arteries.</p>\n<p>Carbon dioxide because of its higher density, <strong>displaces</strong> the <strong>air</strong> surrounding the open heart so that any <strong>gas bubbles trapped</strong> in the heart are of <strong>carbon dioxide</strong> (soluble) and not nitrogen (insoluble).&nbsp;&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "In which of the following patients is inhaled nitric oxide approved for management?",
    "choices": [
      {
        "id": 1,
        "text": "52-year-old man with hypertensive emergency"
      },
      {
        "id": 2,
        "text": "44-year-old woman with gastric varices"
      },
      {
        "id": 3,
        "text": "3-day-old neonate with persistent pulmonary hypertension"
      },
      {
        "id": 4,
        "text": "80-year-old man with malignant hypertension"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Inhaled nitric oxide</strong> (NO) is approved (USFDA) for use in <strong>persistent pulmonary hypertension\u00a0</strong>of the <strong>newborn</strong>.\u00a0</p>\n<p>Inhaled NO <strong>selectively dilates</strong> the <strong>pulmonary vasculature</strong> and has the potential to treat many conditions that result in increased pulmonary hypertension.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following inhalational anesthetics does not preserve cardiac output?",
    "choices": [
      {
        "id": 1,
        "text": "Isoflurane"
      },
      {
        "id": 2,
        "text": "Desflurane"
      },
      {
        "id": 3,
        "text": "Halothane"
      },
      {
        "id": 4,
        "text": "Sevoflurane"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Halothane</strong> produces the <strong>maximum decrease </strong>in<strong> cardiac output</strong> by a combination of decreased heart rate and depressed myocardial contractility</p>\n<p>Halothane and enflurane produce a greater decrease in myocardial contractility than isoflurane, desflurane, and sevoflurane which best maintain cardiac output.</p>\n<p>Of these, cardiac output is <strong>best preserved</strong> with <strong>isoflurane</strong> &ndash; though it does produce some myocardial depression, reflex tachycardia maintains cardiac output. Isoflurane is the <strong>agent of choice</strong> in <strong>cardiac patients.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Ozone depletion is least with which inhaled anesthetic ?",
    "choices": [
      {
        "id": 1,
        "text": "Xenon"
      },
      {
        "id": 2,
        "text": "Nitrous oxide"
      },
      {
        "id": 3,
        "text": "Isoflurane"
      },
      {
        "id": 4,
        "text": "Halothane"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Xenon</strong> is a noble gas which is used for its anesthetic properties and it has no effect on the ozone.</p>\n<p><strong>Other options :</strong></p>\n<ul>\n<li>&nbsp;Halothane and isoflurane have the potential to destroy stratospheric ozone due to their bromine (halothane only) and chlorine-bearing molecules.</li>\n<li>The contribution to stratospheric ozone loss by the anesthetic N2O is likely more significant, compared to halothane and isoflurane.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is true regarding xenon?",
    "choices": [
      {
        "id": 1,
        "text": "Decreases airflow resistance and work of breathing"
      },
      {
        "id": 2,
        "text": "Contraindicated in cardiac patients"
      },
      {
        "id": 3,
        "text": "Contributes to green house effect"
      },
      {
        "id": 4,
        "text": "Rapid induction  and recovery"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Xenon has a very low blood-gas solubility coefficient (0.115) and so produces <strong>rapid induction</strong>&nbsp;and <strong>emergence</strong> from anesthesia.</p>\n<p>Option A: the disadvantage with xenon gas is its <strong>high density</strong> (5.9 g/L), which is much higher than oxygen and nitrous oxide which leads to <strong>increased flow resistance </strong>and<strong> work of breathing</strong>. Thus it is not suitable for patients with compromised respiratory function.</p>\n<p>Option B: It has minimal cardiovascular effects- it produces minimal cardiovascular depression, and it is not arrhythmogenic- so<strong> safe in cardiac patients</strong>.</p>\n<p>Option C: Xenon produces <strong>no greenhouse effect </strong>or<strong> ozone depletion</strong> and is environmentally safe, unlike the other inhaled anesthetics.</p>\n<ul>\n<li>Other advantages of xenon:\n<ul>\n<li>Does not trigger malignant hyperthermia</li>\n<li>Nonexplosive</li>\n<li>Has <strong>analgesic</strong> activity - reduces intraoperative opioid requirements</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following inhalational agents is suitable for neurosurgery?",
    "choices": [
      {
        "id": 1,
        "text": "Halothane"
      },
      {
        "id": 2,
        "text": "Isoflurane"
      },
      {
        "id": 3,
        "text": "Nitrous oxide"
      },
      {
        "id": 4,
        "text": "Ether"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Among the given options, <strong>isoflurane</strong> is best suited for neurosurgery.</p>\n<p>All of the inhalational anesthetics are<strong> cerebral vasodilators</strong>. The order of vasodilating potency is:</p>\n<p>halothane &gt; enflurane &gt; desflurane &gt;&nbsp;<strong>isoflurane </strong>&gt;&nbsp;sevoflurane.&nbsp;</p>\n<p><strong>Note: </strong>Due to its lesser vasodilating property,&nbsp;<strong>sevoflurane</strong> is preferred to isoflurane for neurosurgery.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '15 Inhaled Anaesthetics - Fluorinated Agents, Inert Agents And Therapeutic Gases';
        let hierarchy = ["Marrow", "qBank", "Anesthesia"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        const urlParams = new URLSearchParams(window.location.search);
        currentQuestionIndex = Math.min(parseInt(urlParams.get('startAt')) || 0, questionsData.length - 1);

        function goBack() {
            if (isQuizCompleted || confirm('Are you sure you want to leave the quiz? Your progress will be lost.')) {
                window.history.back();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                setTimeout(processAnswer, 300);
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            setTimeout(showSolution, 1500);
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (!window.location.pathname.endsWith('custom_quiz.html')) {
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>