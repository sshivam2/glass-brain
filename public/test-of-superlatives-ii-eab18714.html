<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Of Superlatives Ii - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2018-19
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">25</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following factors maximally increases the risk of tubal pregnancy?",
    "choices": [
      {
        "id": 1,
        "text": "Intrauterine device"
      },
      {
        "id": 2,
        "text": "Pelvic Inflammatory disease"
      },
      {
        "id": 3,
        "text": "Prior tubal surgery"
      },
      {
        "id": 4,
        "text": "Artificial reproductive technique"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Prior tubal surgery </strong>for ectopic pregnancy<strong>&nbsp;</strong>has the <strong>highest risk</strong> of tubal pregnancy among the given options.</p>\n<p>Risk factors for ectopic pregnancy:</p>\n<ul>\n<li>Prior ectopic pregnancy</li>\n<li><strong>Prior tubal surgery</strong> for ectopic, recanalization of tube post-sterilization</li>\n<li><strong>Pelvic inflammatory disease</strong> - <strong>most common</strong> cause for ectopic pregnancy</li>\n<li>Infertility</li>\n<li>Artificial reproductive therapy</li>\n<li>Endometriosis</li>\n<li>Smoking</li>\n<li>Maternal age &gt;40 years</li>\n<li>Contraceptive methods - intrauterine device, progesterone-only pills</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Most common cause of acute diarrhoea in paediatric age group in India is :",
    "choices": [
      {
        "id": 1,
        "text": "ETEC"
      },
      {
        "id": 2,
        "text": "EPEC"
      },
      {
        "id": 3,
        "text": "Rota virus"
      },
      {
        "id": 4,
        "text": "Campylobacter jejuni"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Rotavirus infection</strong> is the <strong>most common cause</strong> of diarrhoea in all children &lt;5years of age.</p>\n<p>Other agents are:</p>\n<ul>\n<li>E.coli \u2013 second most common cause</li>\n<li>Campylobacter jejuni</li>\n<li>Salmonella</li>\n<li>Shigella</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The most common benign tumor of bone is :",
    "choices": [
      {
        "id": 1,
        "text": "Enchondroma"
      },
      {
        "id": 2,
        "text": "Osteoid osteoma"
      },
      {
        "id": 3,
        "text": "Osteochondroma"
      },
      {
        "id": 4,
        "text": "Chondroblastoma"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Osteochondroma</strong> is the <strong>most common benign tumour of bone</strong>.</p>\n<p>It is not a true neoplasm since its growth stops with cessation of growth at the epiphyseal plate. It is a result of an aberration at the growth plate, where a few cells from the plate grow centrifugally as a separate lump of bone.</p>\n<p><strong>Osteochondromas</strong> occur most commonly between <strong>10&ndash;30&nbsp;</strong>years of age.</p>\n<p>Osteochondroma of tibia:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/520652d48c294411afcedbf2251aadd9x800x578.PNG"
    ]
  },
  {
    "text": "The most common primary Immunodeficiency is:",
    "choices": [
      {
        "id": 1,
        "text": "Common variable immunodeficiency"
      },
      {
        "id": 2,
        "text": "Isolated IgA immunodeficiency"
      },
      {
        "id": 3,
        "text": "Wiskott- Aldrich syndrome"
      },
      {
        "id": 4,
        "text": "AIDS"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most common primary immunodeficiency is Isolated IgA immunodeficiency.</p>\n<p><strong>Selective IgA deficiency:- </strong></p>\n<ul>\n<li>Recurrent respiratory and genitourinary tract infections resulting from lack of secreted IgA on mucosal surfaces are common.</li>\n<li>Problems such as intestinal malabsorption, allergic disease, and autoimmune disorders may also be associated with low IgA levels.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common anomaly of the hepatic artery?",
    "choices": [
      {
        "id": 1,
        "text": "Independent origin of the right and left hepatic arteries from the cealic axis"
      },
      {
        "id": 2,
        "text": "Replaced right hepatic artery arising from the superior mesentric artery"
      },
      {
        "id": 3,
        "text": "Replaced left hepatic artery"
      },
      {
        "id": 4,
        "text": "Accessory right hepatic artery"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The<strong> most common anomaly</strong> of the hepatic artery is <strong>replaced right hepatic artery</strong>&nbsp;arising from the<strong> superior mesenteric artery</strong>.&nbsp;</p>\n<p>Normally, the&nbsp;common hepatic artery gives off the right and left hepatic arteries. A middle hepatic artery branches off from the proximal left hepatic artery.</p>\n<p>The replaced right hepatic artery directly<strong> supplies</strong> the <strong>right lobe </strong>of the liver.</p>\n<p>Surgical significance:<strong>&nbsp;</strong></p>\n<p>In individuals with replaced right hepatic artery,&nbsp;the diameter of the <strong>common hepatic artery</strong> is <strong>smaller.</strong>&nbsp;In liver <strong>transplant recipients</strong>, this can be a cause for the <strong>increased </strong>incidence of <strong>complications</strong> such as <strong>thrombosis</strong>.</p>\n<p>Whereas, replaced right hepatic artery is a <strong>beneficial variant for donors</strong> undergoing donation of the right lobe of the liver. The replaced right hepatic artery provides a <strong>longer </strong>and<strong> larger graft</strong> thus <strong>reducing</strong> chances of <strong>thrombosis.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/28b0046b2ec843d39563aecec9daa0b3x1280x1514.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/11fee5fe56574ed7abd6c1b05ac87655x1279x1384.JPEG"
    ]
  },
  {
    "text": "The most common site for amebiasis is:-",
    "choices": [
      {
        "id": 1,
        "text": "Sigmoid colon"
      },
      {
        "id": 2,
        "text": "Transverse colon"
      },
      {
        "id": 3,
        "text": "Cecum"
      },
      {
        "id": 4,
        "text": "Hepatic flexure"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>&nbsp;</p>\n<p><strong>The most common site for amebiasis is cecum.</strong></p>\n<p>Amebiasis is caused by&nbsp;Entamoeba histolytica.</p>\n<p>Although most cases of amebiasis are asymptomatic, dysentery and invasive extraintestinal disease can occur.&nbsp;Amebic liver abscess&nbsp;is the most common manifestation of invasive amebiasis.</p>\n<ul>\n<li>E histolytica&nbsp;is transmitted via ingestion of the cystic form (infective stage) of the protozoa (fecal- oral route)</li>\n<li>Excystation then occurs in the terminal ileum or colon, resulting in trophozoites (invasive form)</li>\n<li>The trophozoites can penetrate and invade the colonic mucosal barrier, leading to tissue destruction, secretory bloody diarrhea, and colitis resembling&nbsp;inflammatory bowel disease.</li>\n<li>In addition, the trophozoites can spread hematogenously via the portal circulation to the liver or even to more distant organs</li>\n<li>E histolytica&nbsp;is capable of causing a spectrum of illnesses. Intestinal conditions resulting from&nbsp;<em>E histolytica</em>&nbsp;infection include the following:\n<ul>\n<li>Asymptomatic infection</li>\n<li>Symptomatic noninvasive infection</li>\n<li>Acute proctocolitis (dysentery)</li>\n<li>Fulminant colitis with perforation</li>\n<li>Toxic megacolon</li>\n<li>Chronic nondysenteric colitis</li>\n<li>Ameboma</li>\n<li>Perianal ulceration</li>\n</ul>\n</li>\n</ul>\n<p>Extraintestinal conditions resulting from&nbsp;E histolytica&nbsp;infection include the following:</p>\n<ul>\n<li>Liver abscess</li>\n<li>Pleuropulmonary disease</li>\n<li>Peritonitis</li>\n<li>Pericarditis</li>\n<li>Brain abscess</li>\n<li>Genitourinary disease</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient has enlarged neck veins, hepatomegaly and a holosystolic murmur along the lower left sternal margin. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Tricuspid regurgitation"
      },
      {
        "id": 2,
        "text": "Mitral regurgitation"
      },
      {
        "id": 3,
        "text": "Left heart failure"
      },
      {
        "id": 4,
        "text": "Right heart failure"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most likely diagnosis in the above clinical scenario is <strong>tricuspid regurgitation</strong>.</p>\n<p><strong>Clinical features</strong> of tricuspid regurgitation are:</p>\n<ul>\n<li><strong>Distended neck veins</strong> with <strong>prominent c-v waves</strong></li>\n<li>Hepatomegaly with systolic pulsations</li>\n<li><strong>Positive hepatojugular reflex</strong> - the distension of the jugular vein when firm pressure is applied over the liver</li>\n<li>Blowing <strong>holosystolic murmur</strong> along the lower left sternal margin</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 55-year-old female patient who is a known case of hypertension, diabetes, and hyperlipidemia presents to the emergency department with a severe headache and vomiting. The patient is agitated and her blood pressure is 220/120 mmHg. Ophthalmoscopy reveals the presence of papilledema. Which of the following antihypertensive is least useful in the management of this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Furosemide"
      },
      {
        "id": 2,
        "text": "Nicardipine"
      },
      {
        "id": 3,
        "text": "Labetolol"
      },
      {
        "id": 4,
        "text": "Enalaprilat"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above scenario points towards the diagnosis of <strong>malignant hypertension</strong>. The drug which is<strong> least useful</strong> in the management is<strong>&nbsp;</strong>furosemide(<strong>diuretic</strong>).&nbsp;</p>\n<p>Volume depletion is common in patients with malignant hypertension, and the administration of a diuretic together with a hypertensive agent can lead to an extreme drop in blood pressure.</p>\n<p>Diuretics are generally not recommended for the rapid reduction of blood pressure in patients with hypertensive crises. They are used only in conditions of volume overload such as acute pulmonary edema.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The most important stimulus controlling the level of resting ventilation is_____",
    "choices": [
      {
        "id": 1,
        "text": "pH of CSF on central chemoreceptors"
      },
      {
        "id": 2,
        "text": "pH on peripheral chemoreceptors"
      },
      {
        "id": 3,
        "text": "Pco2 on peripheral chemoreceptors"
      },
      {
        "id": 4,
        "text": "Po2 on peripheral chemoreceptors"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most important stimulus comes from the <strong>pH of the CSF on the central chemoreceptors.&nbsp;</strong>The CO<sub>2</sub> that enters the brain and CSF is hydrated to H<sub>2</sub>CO<sub>3</sub> and dissociates, leading to rising H<sup>+</sup> levels. The CSF H<sup>+</sup> concentration hence <strong>parallels</strong> the arterial CO<sub>2</sub> levels.</p>\n<p>The effect of pO<sub>2</sub> on peripheral chemoreceptors under normoxic conditions is very small. Changes in pCO<sub>2</sub> do affect the peripheral chemoreceptors, but the magnitude is less than that for the central chemoreceptors.</p>\n<p>The effect of changes in the pH on peripheral chemoreceptors under normal conditions is small: and the changes in pO<sub>2</sub> do not affect the central chemoreceptors.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following lipoproteins have the highest cholesterol:triglyceride ratio?",
    "choices": [
      {
        "id": 1,
        "text": "Chylomicron and VLDL"
      },
      {
        "id": 2,
        "text": "LDL and HDL"
      },
      {
        "id": 3,
        "text": "HDL and VLDL"
      },
      {
        "id": 4,
        "text": "IDL and HDL"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p style=\"text-align: justify;\">As <strong>cholesterol</strong> is the predominant lipid in <strong>LDL</strong> and <strong>HDL</strong>, they have a <strong>higher cholesterol: triglyceride ratio.</strong></p>\n<p style=\"text-align: justify;\"><strong>VLDL</strong> also has a significant amount of cholesterol but it <strong>predominantly comprises triglycerides</strong> (lower cholesterol: triglyceride ratio). Therefore <strong>LDL</strong> and <strong>HDL</strong> are considered the <strong>major carriers of cholesterol</strong>.</p>\n<p style=\"text-align: justify;\">IDLs are formed by the removal of triglycerides from VLDL by muscle and adipose tissue and are hence enriched in cholesterol. LDLs are derived from VLDL and IDL particles and contain more cholesterol than IDLs.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old man presents with a history of fatigue, dark-coloured urine and photosensitivity. He consumes alcohol regularly. On examination, hyperpigmentation and scarring are present on the face and dorsum of the hand. Lab findings are given below. Which of the following is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Acute intermittent porphyria"
      },
      {
        "id": 2,
        "text": "Porphyria cutanea tarda"
      },
      {
        "id": 3,
        "text": "Hereditary coproporphyria"
      },
      {
        "id": 4,
        "text": "Variegate porphyria"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>A middle-aged adult presenting with features of hemolysis and photosensitivity with elevated urine uroporphyrin suggests a diagnosis of<strong> porphyria cutanea tarda.</strong></p>\n<p>Porphyria cutanea tarda (PCT) is the<strong> most common </strong>porphyria. It is caused by the deficiency of <strong>uroporphyrinogen</strong> decarboxylase, which converts uroporphyrinogen III to coproporphyrinogen III. \u00a0It is characterized by photosensivity, which manifests as <strong>blistering skin lesions</strong>\u00a0on the back of the hands with crusting and scarring. It is associated with <strong>hemochromatosis </strong>and patients may develop <strong>chronic liver disease.</strong>\u00a0There is increased excretion of <strong>uroporphyrin</strong> in the urine.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common reaction occurring in patients undergoing blood transfusions?",
    "choices": [
      {
        "id": 1,
        "text": "Febrile hemolytic"
      },
      {
        "id": 2,
        "text": "Febrile non-hemolytic"
      },
      {
        "id": 3,
        "text": "Non-febrile hemolytic"
      },
      {
        "id": 4,
        "text": "Acute hemolytic"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The <strong>most common</strong> blood transfusion reaction is the <strong>febrile nonhemolytic</strong> reaction.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Most common route of nosocomial infections:",
    "choices": [
      {
        "id": 1,
        "text": "Droplet transmission"
      },
      {
        "id": 2,
        "text": "Direct contact"
      },
      {
        "id": 3,
        "text": "Indirect contact"
      },
      {
        "id": 4,
        "text": "Vehicle transmission"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<ul>\n<li>Most common route of nosocomial infections are through direct contact.</li>\n<li><strong>Indirect contact</strong> refers to contact with infectious objects.</li>\n<li><strong>Vehicle transmission </strong>and <strong>droplet transmission</strong> are also routes of nosocomial infections.</li>\n<li><strong>Nosocomial infections</strong> are hospital acquired infections like <strong>blood stream infections and surgical site infections</strong>.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The most common banding technique used for the staining of chromosomes in Karyotyping is",
    "choices": [
      {
        "id": 1,
        "text": "Q banding"
      },
      {
        "id": 2,
        "text": "C banding"
      },
      {
        "id": 3,
        "text": "G banding"
      },
      {
        "id": 4,
        "text": "R banding"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<ul>\n<li><strong>G banding (Giemsa banding) </strong>is the most common technique used in cytogenetics to produce a visible karyotype by staining condensed chromosomes.</li>\n<li>It is useful for <strong>identifying genetic diseases</strong> through the photographic representation of the entire chromosome complement.</li>\n<li>The <strong>metaphase chromosomes</strong> are treated with <strong>trypsin</strong> (to partially digest the chromosome) and stained with <strong>Giemsa stain</strong>.</li>\n<li><strong>Heterochromatic regions,</strong> which tend to be rich with adenine and thymine <strong>(AT-rich)</strong> DNA and relatively gene-poor, stain more darkly and appear as <strong>Dark bands</strong> in G-banding.</li>\n<li>In contrast, <strong>less condensed chromatin</strong>&mdash;which tends to be rich with guanine and cytosine <strong>(GC-rich)</strong> and more transcriptionally active&mdash;incorporates less Giemsa stain, and these regions appear as <strong>light bands</strong> in G-banding.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8799a8e4005d47e596a2a8a6f7510d70x554x427.PNG"
    ]
  },
  {
    "text": "Which of the following types is the most common presentation of psoriatic arthritis?",
    "choices": [
      {
        "id": 1,
        "text": "Axial spondyloarthritis"
      },
      {
        "id": 2,
        "text": "Arthritis mutilans"
      },
      {
        "id": 3,
        "text": "Asymmetric oligoarthritis"
      },
      {
        "id": 4,
        "text": "Symmetric polyarthritis"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Asymmetric oligoarthritis</strong> is the&nbsp;<strong>most common type</strong>&nbsp;of Psoriatic arthritis.</p>\n<p class=\"p1\">Asymmetric oligoarthritis commonly involves a knee or another large joint with a few small joints in the fingers or toes, often with dactylitis.</p>\n<p><strong>Psoriatic arthritis</strong>&nbsp;is a&nbsp;<strong>seronegative</strong>&nbsp;inflammatory arthritis that is destructive to the joints, associated with moderate to severe psoriasis. It usually develops before 40 years of age.</p>\n<div class=\"page\" title=\"Page 1\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>A diagnosis of psoriatic arthritis can be made from the Classification Criteria for Psoriatic Arthritis (<strong>CASPAR</strong>)&nbsp;<strong>criteria</strong>, if there is an&nbsp;<strong>inflammatory articular</strong>&nbsp;disease of a joint, enthesis or spine, along with &gt;=3 of the following criteria:</p>\n<ol>\n<li>Current or history of psoriasis/ family history of psoriasis</li>\n<li>Typical psoriatic nail involvement</li>\n<li>Rheumatoid factor negative</li>\n<li>Current or history of dactylitis</li>\n<li>Radiological evidence of juxta-articular new bone formation</li>\n</ol>\n<div class=\"page\" title=\"Page 2\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Triggers include trauma to a joint or tendon (<strong>Koebner effect</strong>), smoking, alcohol excess and&nbsp;<strong>HIV infection</strong>.&nbsp;<strong>Streptococcal infection</strong>, medications like lithium or&nbsp;<strong>stress</strong>&nbsp;do&nbsp;<strong>not trigger</strong>&nbsp;the onset of psoriatic arthritis. There is an activation of both innate and acquired immunity with the overproduction of cytokines like&nbsp;<strong>TNF\u2010&alpha;</strong>,&nbsp;<strong>IL\u201017</strong>&nbsp;and&nbsp;<strong>IL\u201023</strong>&nbsp;via the&nbsp;<strong>JAK-STAT pathway</strong>. This results in joint fibrosis and erosion of bone with abnormal bone formation.</p>\n<p><strong>Wright &amp; Moll Classification of Psoriatic Arthritis</strong></p>\n<ul>\n<li>Arthritis of the&nbsp;<strong>DIP joints</strong></li>\n<li><strong>Asymmetric oligoarthritis</strong></li>\n<li><strong>Symmetric polyarthritis</strong></li>\n<li>Axial involvement such as&nbsp;<strong>spine and sacroiliac joints</strong></li>\n<li><strong>Arthritis mutilans</strong>, a destructive form of arthritis</li>\n</ul>\n<div class=\"page\" title=\"Page 3\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 3\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 3\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Psoriatic arthritis&nbsp;</strong>involves proximal and distal interphalangeal joints<strong>&nbsp;(PIP,&nbsp;DIP)&nbsp;</strong>and metacarpophalangeal joints<strong>&nbsp;(MCP). Clinical features</strong>&nbsp;include:</p>\n<ul>\n<li><strong>Early morning stiffness</strong></li>\n<li><strong>Swollen, tender, one or more joints</strong></li>\n<li>Enthesitis: Heel pain due to Achilles tendon inflammation</li>\n<li>Plantar fasciitis</li>\n<li><strong>Dactylitis</strong>&nbsp;/sausage fingers with&nbsp;<strong>telescoping&nbsp;</strong>(shortening of toes due to osteolysis)</li>\n<li><strong>Nail changes:&nbsp;</strong>hyperkeratosis and onycholysis</li>\n<li>Axial involvement may occur</li>\n</ul>\n<p>The image below shows psoriatic arthritis of the hands:</p>\n<p>&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c107617e6fb34768b0053265b23c2dcex720x1280.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d41aa95bdf084bd3a139e2cd4a7c19f8x1279x1062.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/51633e94adef4b8897fca5bf88e0edc5x1280x1194.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8589d92c18984765aa31260ed6a97b91x512x428.PNG"
    ]
  },
  {
    "text": "The  most common causative organism of pyomyositis is:",
    "choices": [
      {
        "id": 1,
        "text": "Streptococcus pyogenes"
      },
      {
        "id": 2,
        "text": "Pseudomonas"
      },
      {
        "id": 3,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 4,
        "text": "E. Coli"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Staphylococcus aureus </strong>is the <strong>most</strong> <strong>common</strong> organism causing <strong>Pyomyositis</strong>.</p>\n<p><strong>Pyomyositis</strong> also known as <strong>tropical pyomyositis</strong> or <strong>myositis tropicans</strong> is a bacterial infection of <strong>skeletal</strong> <strong>muscles</strong> resulting in pus filled abscess that is seen primarily in tropical climates but also occurs in immunocompromised and HIV-infected patients.</p>\n<p>Causative Organism:</p>\n<ul>\n<li><strong>Tropical pyomyositis</strong> &ndash; Most Common cause is <strong>S. Aureus</strong></li>\n<li><strong>Acute bacterial myositis</strong> &ndash; Most Common cause is<strong> Group A Streptococcus</strong></li>\n<li><strong>Overall - </strong>Most Common cause of pyomyositis is <strong>S.aureus</strong></li>\n</ul>\n<p><strong>Clinical Presentation:</strong></p>\n<ul>\n<li><strong>Children aged 2 &ndash; 5 years</strong> are <strong>most commonly affected.</strong></li>\n<li>Pyomyositis presents as fever, swelling, and pain overlying the involved muscle.</li>\n<li><strong>Most common</strong> <strong>Muscles</strong> infected by pyomyositis are <strong>Quadriceps</strong> and <strong>Gluteal Muscles.</strong></li>\n</ul>\n<p><strong>Treatment:</strong></p>\n<ul>\n<li><strong>Surgical drainage</strong> of abscess followed by antibiotics for minimum three weeks to treat infection.</li>\n</ul>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Most common cause of failure of male sterilization is:",
    "choices": [
      {
        "id": 1,
        "text": "Advanced age at the time of procedure"
      },
      {
        "id": 2,
        "text": "Mistake in identifying the vas"
      },
      {
        "id": 3,
        "text": "Usage of wrong surgical method"
      },
      {
        "id": 4,
        "text": "Spontaneous recanalization"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Most common cause of failure of male sterilization or <strong>vasectomy </strong>is mistake in identifying the vas.</p>\n<p>Although the failure rate of vasectomy is low, sometimes failure arises as some other structure in the spermatic cord is taken.</p>\n<p><strong>Histological confirmation</strong> or <strong>microscopy</strong> with staining is recommended in vasectomy procedures.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is the best device to detect abnormal hemoglobins?",
    "choices": [
      {
        "id": 1,
        "text": "Pulse oximeter"
      },
      {
        "id": 2,
        "text": "CO-oximeter"
      },
      {
        "id": 3,
        "text": "Capnogragh"
      },
      {
        "id": 4,
        "text": "Spirometer"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>CO-oximeter</strong>&nbsp;is the best device to detect abnormal hemoglobins.</p>\n<p>CO-oximeter utilizes an <strong>eight</strong> wavelength sensor (unlike pulse oximeter which uses two wavelengths) to distinguish between oxygenated blood, deoxygenated blood and blood containing CO.&nbsp;</p>\n<p>CO-oximeter is useful in measuring:</p>\n<ul>\n<li>Carboxyhemoglobin</li>\n<li>Methemoglobin</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The drug cevimeline acts on which receptor for the expulsion of the secretions from the salivary gland?",
    "choices": [
      {
        "id": 1,
        "text": "M1"
      },
      {
        "id": 2,
        "text": "M2"
      },
      {
        "id": 3,
        "text": "M3"
      },
      {
        "id": 4,
        "text": "M4"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Cevimeline is a&nbsp;<strong>muscarinic agonist</strong>&nbsp;with affinity for both&nbsp;<strong>M1</strong>&nbsp;and<strong>&nbsp;M3&nbsp;</strong>receptors on the&nbsp;lacrimal and salivary glands.</p>\n<p>While&nbsp;<strong>M1 activation results in increased secretion</strong>,&nbsp;<strong>M3 activation results in smooth muscle contraction</strong>&nbsp;and expulsion of the secretions.</p>\n<p>Cevimeline has a long-lasting sialogogic action and may have fewer side effects than pilocarpine.</p>\n<p>Cevimeline enhances lacrimal secretions in&nbsp;<strong>Sjo\u0308gren&rsquo;s syndrome</strong>. The usual dose is&nbsp;<strong>30 mg three times daily</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is an important epidemiological tool to assess disability in children?",
    "choices": [
      {
        "id": 1,
        "text": "Activities of Daily Living scale"
      },
      {
        "id": 2,
        "text": "Wing\u2019s Comprehensive Handicaps, Behaviour and Skills Schedule"
      },
      {
        "id": 3,
        "text": "Binet and Simon\u2019s IQ test"
      },
      {
        "id": 4,
        "text": "Physical Quality of Life Index"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Wing\u2019s Comprehensive Handicaps, Behaviour and Skills Schedule (HBS) </strong>has been used in epidemiological studies to assess the total child population in terms of detailed scales of <strong>specific abilities and disabilities</strong>.</p>\n<p>HBS is not useful for children with mental retardation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most common form of acute transient psychotic disorder?",
    "choices": [
      {
        "id": 1,
        "text": "Acute polymorphic psychotic disorder without symptoms of schizophrenia"
      },
      {
        "id": 2,
        "text": "Acute polymorphic psychotic disorder with symptoms of schizophrenia"
      },
      {
        "id": 3,
        "text": "Acute schizophrenia \u2013 like psychotic disorder"
      },
      {
        "id": 4,
        "text": "Acute transient psychotic disorder, unspecified"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common form of acute transient psychotic disorders is <strong>polymorphic psychotic disorder without symptoms of schizophrenia</strong> (one third to a half of all cases).</p>\n<p>This is <strong>followed by</strong> polymorphic psychotic disorder <strong>with symptoms of schizophrenia</strong>.</p>\n<p>Polymorphic psychotic disorder commonly presents with marked hallucinations, delusions, and perceptual disturbances that change in type and intensity from day to day or even from hour to hour.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the earliest sign of left atrial enlargement on a chest x-ray ?",
    "choices": [
      {
        "id": 1,
        "text": "Straightening of right cardiac border"
      },
      {
        "id": 2,
        "text": "Enlargement of left atrial appendage"
      },
      {
        "id": 3,
        "text": "Presence of double atrial shadow"
      },
      {
        "id": 4,
        "text": "Elevation of left main bronchus and widening of carina"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p><strong>Enlargement</strong> of the <strong>left atrial appendage</strong>\u00a0is the <strong>earliest</strong>\u00a0<strong>sign</strong> of left atrial enlargement (<strong>LAE</strong>) on a chest x-ray. <strong>\u00a0</strong>It is<strong>\u00a0</strong>seen as a fullness below the pulmonary artery.\u00a0</p>\n<p>Other radiographic signs seen in LAE include:</p>\n<ul>\n<li>The third mogul sign represents an enlargement of the left atrial appendage along the upper left cardiac border, leading to <strong>straightening of the left heart border.</strong></li>\n<li><strong>Posterior\u00a0displacement</strong> of the <strong>oesophagus</strong> - seen on the lateral view of the barium swallow study.</li>\n<li>Elevation of left main bronchus and widening of the carina.</li>\n<li><strong>Double</strong> <strong>density\u00a0</strong>sign or double atrial shadow - the enlarged LA extends towards the right cardiac border, hence, both RA and LA borders can be seen distinctly over the right heart border (as shown below):</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/dc9f03a621aa4e91a5fabdf444107afdx1069x699.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e5d5ded10df847af8a9ca993699a6317x753x785.JPEG"
    ]
  },
  {
    "text": "Most common mode of occupational lead poisoning is:",
    "choices": [
      {
        "id": 1,
        "text": "Ingestion"
      },
      {
        "id": 2,
        "text": "Inhalation"
      },
      {
        "id": 3,
        "text": "Absorption through skin"
      },
      {
        "id": 4,
        "text": "Inoculation"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<ul>\n<li><strong>Inhalation </strong>of fumes and dust of lead is the most common mode of occupational lead poisoning.</li>\n<li><strong>Ingestion and absorption</strong> through skin are other modes of occupational lead poisoning in industries.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is the most accepted theory for secondary cholesteatoma?",
    "choices": [
      {
        "id": 1,
        "text": "Presence of congenital cell rests"
      },
      {
        "id": 2,
        "text": "Basal cell hyperplasia"
      },
      {
        "id": 3,
        "text": "Squamous metaplasia"
      },
      {
        "id": 4,
        "text": "Migration of squamous epithelium"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Th<strong>e most accepted</strong> theory for <strong>secondary cholesteatoma</strong> is&nbsp;<strong>Habermann's theory.</strong> It proposes that the skin of the external auditory meatus grows or migrates into the middle ear through the posterosuperior marginal perforation or attic perforation forming cholesteatoma.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 45-year-old Nigerian man hailing from an area endemic for river blindness presented with the given finding. What is the drug of choice for the treatment?",
    "choices": [
      {
        "id": 1,
        "text": "Diethylcarbamazine (DEC)"
      },
      {
        "id": 2,
        "text": "Ivermectin"
      },
      {
        "id": 3,
        "text": "Suramin"
      },
      {
        "id": 4,
        "text": "Fluconazole"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The image shows <strong>sclerosing keratitis</strong> of <strong>onchocerciasis</strong> or <strong>river blindness.</strong> The drug of choice for the treatment of onchocerciasis is&nbsp;<strong>ivermectin</strong>.<strong>&nbsp;</strong></p>\n<p>Ivermectin:<strong> 6 mg, single-dose, repeated every 6-12 months,</strong> according to the weight of the patient<strong>.&nbsp;</strong></p>\n<p><strong>Suramin</strong> and<strong> diethylcarbamazine</strong> (DEC) were given in the past but have been discontinued due to serious adverse effects.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/7b6efc6a2ece4d06a8d6e1b6c2f9496b.PNG"
    ],
    "explanation_images": []
  }
];
        let quizName = 'Test Of Superlatives Ii';
        const quizFilename = 'test-of-superlatives-ii-eab18714.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2018-19"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>