<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>062 Infective Endocarditis And Acute Rheumatic Fever - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Medicine
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">29</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "In patients with infective endocarditis, the vegetations are most commonly present on:",
    "choices": [
      {
        "id": 1,
        "text": "Aortic valve"
      },
      {
        "id": 2,
        "text": "Pulmonary valve"
      },
      {
        "id": 3,
        "text": "Mitral valve"
      },
      {
        "id": 4,
        "text": "Tricuspid valve"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Note:&nbsp;Infection of the arteriovenous shunts and the arterio-arterial shunt is called infective endarteritis and not infective endocarditis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f9351c06f3ee4594b907382bf0c24802x795x1052.JPEG"
    ]
  },
  {
    "text": "Which of the following is not a cardiac manifestation of infective endocarditis?",
    "choices": [
      {
        "id": 1,
        "text": "Impaired conduction system"
      },
      {
        "id": 2,
        "text": "Heart failure"
      },
      {
        "id": 3,
        "text": "Perivalvular abscess"
      },
      {
        "id": 4,
        "text": "Roth's spots"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Roth's spots</strong> are not the cardiac manifestation of infective endocarditis (IE). They are the <strong>immunological</strong> phenomenon seen in patients with infective endocarditis.</p>\n<p>Symptoms of infective endocarditis can be broadly divided into cardiac and non-cardiac manifestations.&nbsp;Non-cardiac manifestations of infective endocarditis are further divided into immunologic and vascular phenomena.</p>\n<ul>\n<li>Cardiac manifestations of IE:\n<ul>\n<li>Presence of new regurgitant murmurs</li>\n<li>Congestive <strong>heart failure</strong> due to valve dysfunction</li>\n<li><strong>Perivalvular abscesses</strong> and intracardiac fistulae- caused due to the extension of infection beyond the valves and into the adjacent myocardial tissue</li>\n<li><strong>Conduction system defects</strong>- due to the damage of the interventricular septum by the abscess.</li>\n<li>Embolization of coronary arteries</li>\n</ul>\n</li>\n<li class=\"page\" title=\"Page 971\">Non-cardiac manifestations of IE:<br />\n<ul>\n<li>Immunological phenomena (mnemonic ROGeR):\n<ul>\n<li><strong>Osler's nodes</strong>- small,&nbsp;<strong>tender</strong>, red papules that are present on the distal finger and toe pads.</li>\n<li><strong>Roth's spots</strong>- white-centered retinal hemorrhages</li>\n<li>Immune-complex mediated glomerulonephritis</li>\n<li>Positivity for<strong>&nbsp;rheumatoid factor</strong></li>\n</ul>\n</li>\n<li>Vascular phenomena:\n<ul>\n<li><strong>Janeway lesions- </strong>these are faint, red, macular,&nbsp;<strong>painless</strong>&nbsp;lesions, commonly present on the thenar and hypothenar eminences.</li>\n<li>Major arterial emboli</li>\n<li>Septic pulmonary infarct</li>\n<li>Mycotic aneurysm</li>\n<li>Intracranial hemorrhages</li>\n<li>Conjunctival hemorrhages</li>\n<li>Splenic abscess</li>\n<li>Cerebral abscess</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>The image below shows Roth spot on the retina.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f2beaccebfbf4c2e8f1e534047c19065x610x607.PNG"
    ]
  },
  {
    "text": "Which of the following is not included in the minor criteria of modified Duke criteria for clinical diagnosis of infective endocarditis?",
    "choices": [
      {
        "id": 1,
        "text": "History of injection drug use"
      },
      {
        "id": 2,
        "text": "Immunological evidence of glomerulonephritis"
      },
      {
        "id": 3,
        "text": "Positive blood culture but not meeting the major criterion"
      },
      {
        "id": 4,
        "text": "Positive echocardiogram not meeting major criteria"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Positive echocardiogram not meeting major criteria was earlier a minor criterion but is now removed.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "According to the modified Duke criteria, a single positive blood culture is included in the major criteria for which organism?",
    "choices": [
      {
        "id": 1,
        "text": "Coagulase negative staphylococcus aureus"
      },
      {
        "id": 2,
        "text": "Coxiella burnetii"
      },
      {
        "id": 3,
        "text": "Viridans streptococci"
      },
      {
        "id": 4,
        "text": "HACEK group"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>According to modified Duke criteria for the diagnosis of infective endocarditis,<strong> single positive blood culture</strong> for <em><strong>Coxiella burnetii</strong></em> or phase I IgG antibody titre &gt; 1:800 is included in the major criteria.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A known IV drug abuser is referred to medicine OPD from the de-addiction wing due to prolonged fever and new-onset seizures. His fever has been present for 2 weeks and did not come down with antibiotics. An early diastolic murmur is heard on auscultation. Multiple painless skin lesions are present on the hands. What are these lesions?",
    "choices": [
      {
        "id": 1,
        "text": "Osler\u2019s nodes"
      },
      {
        "id": 2,
        "text": "Janeway lesions"
      },
      {
        "id": 3,
        "text": "Roth's spots"
      },
      {
        "id": 4,
        "text": "Pink rim rashes"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Another skin finding that can be found in patients with infective endocarditis is&nbsp;<strong>Osler's nodes.&nbsp;</strong>In contrast to Janeway lesions, these are small, <strong>tender</strong>, red papules which are present on the distal finger and toe pads.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/49118a8b752b4297be2ffedefe4beec0.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c3d63edfc18c4f9f94efcc959cf489eex600x468.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6cf5ec365ee3472488fbff96ed832bf2x768x1024.JPEG"
    ]
  },
  {
    "text": "Which of the following is true about the vegetations seen in infective endocarditis?",
    "choices": [
      {
        "id": 1,
        "text": "Present mainly along the lines of closure"
      },
      {
        "id": 2,
        "text": "Present on both side of valve leaflets"
      },
      {
        "id": 3,
        "text": "Extend into the chordae"
      },
      {
        "id": 4,
        "text": "Small and warty"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Vegetations of infective endocarditis can <strong>extend</strong> onto <strong>chordae </strong>and are:</p>\n<ul>\n<li><strong>Large</strong> and <strong>irregular</strong>&nbsp;</li>\n<li>Mainly present on <strong>valve cusps</strong></li>\n<li>Prone to <strong>embolization</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "You are asked to collect blood samples for culture from a patient suspected to have infective endocarditis by a typical pathogen. Choose the correct statement for the same.",
    "choices": [
      {
        "id": 1,
        "text": "3 separate culture sets - two aerobic and one anaerobic"
      },
      {
        "id": 2,
        "text": "3 separate culture sets - two anaerobic and one aerobic"
      },
      {
        "id": 3,
        "text": "2 separate culture sets - two aerobic"
      },
      {
        "id": 4,
        "text": "2 separate culture sets - one aerobic and one anaerobic"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Option D. According to the <strong>Modified Duke 2023 Criteria </strong>for infective endocarditis, when a <strong>typical organism</strong> is suspected, <strong>two separate culture sets</strong> are required, <strong>one aerobic</strong> and <strong>one anaerobic</strong>.<br />If an atypical organism is suspected, three or more separate culture sets are used.&nbsp;</p>\n<p>According to the new Duke&rsquo;s criteria, there is <strong>no specific timing</strong> to draw blood for blood culture.&nbsp;</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient develops prosthetic valve endocarditis 2 years after valve replacement surgery. Which of the following organism is the most likely cause?",
    "choices": [
      {
        "id": 1,
        "text": "Streptococci"
      },
      {
        "id": 2,
        "text": "Staphylococcus aureus"
      },
      {
        "id": 3,
        "text": "Coagulase negative staphylococci"
      },
      {
        "id": 4,
        "text": "HACEK organisms"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Patient developing endocarditis 2 years after prosthetic valve surgery suggests <strong>late-onset endocarditis</strong>. In such cases, the most common causative organism is <strong>streptococci.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 38-year-old patient presented with malaise, fatigue, and rigors for 1 week. Multiple puncture sites were present on the forearm along with sclerosed veins. His temperature on admission was 38.5 \u00b0C. Examination revealed a pan-systolic murmur which was loudest at the left sternal edge. Three sets of blood cultures were taken. Which organism is most likely to be found in his blood cultures?",
    "choices": [
      {
        "id": 1,
        "text": "Streptococcus sanguis"
      },
      {
        "id": 2,
        "text": "Enterococcus faecium"
      },
      {
        "id": 3,
        "text": "Coxiella burnetii"
      },
      {
        "id": 4,
        "text": "Staphylococcus aureus"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above clinical scenario is suggestive of infective endocarditis.<strong>&nbsp;<em>Staphylococcus aureus</em></strong> is most likely to be positive in cultures as it is the most common cause of <strong>infective endocarditis</strong> in<strong> IV drug abusers.</strong></p>\n<p>Endocarditis in <strong>injection</strong> drug users is mostly <strong>right-sided</strong> and involves the <strong>tricuspid</strong> valve.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common cause of culture-negative infective endocarditis?",
    "choices": [
      {
        "id": 1,
        "text": "Coxiella burnetii"
      },
      {
        "id": 2,
        "text": "HACEK group of organisms"
      },
      {
        "id": 3,
        "text": "Fungal endocarditis"
      },
      {
        "id": 4,
        "text": "Prior antibiotic use"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The most common cause of <strong>culture-negative</strong> infective endocarditis is the <strong>prior use of antibiotics</strong>.</p>\n<p>Some proportion of patients with endocarditis have negative blood cultures. The important causes are:</p>\n<ul>\n<li>Prior antibiotic use (most common cause)</li>\n<li>IE due to <strong>fastidious organisms </strong>or unusual pathogens or fungi such as:\n<ul>\n<li>Streptococci (Granulicatella and Abiotrophia species)</li>\n<li><strong>HACEK organisms</strong></li>\n<li><strong>Coxiella burnetii</strong></li>\n<li>Bartonella species</li>\n<li>Brucella</li>\n<li>Tropheryma whipplei</li>\n</ul>\n</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "An 80-year-old woman with a history of moderate aortic stenosis presented with fatigue, weight loss, and night sweats for 2 weeks. Blood tests showed the following.  Echocardiography revealed an intracardiac mass on the mitral valve. Blood cultures showed growth of Streptococcus gallolyticus. What additional investigation should be performed?",
    "choices": [
      {
        "id": 1,
        "text": "Hysteroscopy"
      },
      {
        "id": 2,
        "text": "Cystoscopy"
      },
      {
        "id": 3,
        "text": "Colonoscopy"
      },
      {
        "id": 4,
        "text": "Bronchoscopy"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The given clinical features and laboratory investigations are suggestive of <strong>infective endocarditis</strong> caused due to&nbsp;<em>Streptococcus gallolyticus</em>. In this condition, a <strong>colonoscopy</strong> should be performed.</p>\n<p><strong><em>Streptococcus gallolyticus</em></strong> originates from the gastrointestinal tract and is associated with <strong>polyps</strong> and <strong>colon cancer. </strong>Hence, the presence of this organism in the vegetation of infective endocarditis should warrant a gastrointestinal investigation.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Transesophageal echocardiography is preferred over transthoracic echocardiography as initial investigation in all of the following patients, except:",
    "choices": [
      {
        "id": 1,
        "text": "Patient with suspected prosthetic valve endocarditis"
      },
      {
        "id": 2,
        "text": "Patient with suspected IE presenting with fever"
      },
      {
        "id": 3,
        "text": "Patient with suspected IE with a new onset regurgitant murmur"
      },
      {
        "id": 4,
        "text": "Patient with suspected IE who has previous history of IE"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>For a patient with <strong>low suspicion</strong> of IE, transthoracic echocardiography (<strong>TTE</strong>) will be done as an initial investigation.</p>\n<p>Transesophageal echocardiography (<strong>TEE</strong>) is preferred as the initial investigation in all <strong>high-risk</strong> patients and/or in patients where a <strong>high</strong> clinical <strong>suspicion</strong> of infective endocarditis (IE) exists.&nbsp;</p>\n<p>TEE is also preferred over TTE for evaluating:</p>\n<ul>\n<li>Vegetations &lt; 2mm in diameter</li>\n<li><strong>Prosthetic valve endocarditis</strong> (PVE)</li>\n<li>Detection of myocardial abscess</li>\n<li>Detection of valve perforation</li>\n<li>Detection of intracardiac fistulae</li>\n<li>Detection of vegetations in a patient with a cardiovascular implantable electronic device (CIED)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Patients with which of the following conditions have the lowest risk of developing infective endocarditis?",
    "choices": [
      {
        "id": 1,
        "text": "Atrial septal defect"
      },
      {
        "id": 2,
        "text": "Ventricular septal defect"
      },
      {
        "id": 3,
        "text": "Patent ductus arteriosus"
      },
      {
        "id": 4,
        "text": "Tetralogy of Fallot"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Atrial septal defect</strong>&nbsp;(ASD) is associated with a very low incidence of IE. In ASD, the velocity of the shunt blood is low due to the decreased pressure gradient between the two atria. This low velocity of the blood does not usually damage the lining endocardium.</p>\n<p>Unrepaired <strong>VSD</strong> is the <strong>most frequent</strong> congenital heart disease lesion <strong>associated with IE,</strong> followed by ventricular outflow tract obstructive lesions, such as with tetralogy of Fallot.</p>\n<table style=\"height: 299px; width: 395px;\">\n<tbody>\n<tr style=\"height: 31px;\">\n<td style=\"width: 386.354px; text-align: center; height: 31px;\" colspan=\"3\"><strong>Risk factors for infective endocarditis</strong></td>\n</tr>\n<tr style=\"height: 42.6597px;\">\n<td style=\"width: 149.392px; text-align: center; height: 42.6597px;\"><strong>High risk</strong></td>\n<td style=\"width: 103.646px; text-align: center; height: 42.6597px;\"><strong>Moderate risk</strong></td>\n<td style=\"width: 122.691px; text-align: center; height: 42.6597px;\"><strong>Low risk</strong></td>\n</tr>\n<tr style=\"height: 53px;\">\n<td style=\"width: 149.392px; height: 53px;\"><strong>Prosthetic cardiac valves</strong></td>\n<td style=\"width: 103.646px; height: 53px;\">Mitral valve prolapse with regurgitation</td>\n<td style=\"width: 122.691px; height: 53px;\">Mitral valve prolapse without regurgitation</td>\n</tr>\n<tr style=\"height: 35px;\">\n<td style=\"width: 149.392px; height: 35px;\">Previous bacterial endocarditis</td>\n<td style=\"width: 103.646px; height: 175px;\" rowspan=\"5\">Isolated mitral stenosis&nbsp;&nbsp;&nbsp;</td>\n<td style=\"width: 122.691px; height: 35px;\">Atrial septal defect</td>\n</tr>\n<tr style=\"height: 35px;\">\n<td style=\"width: 149.392px; height: 35px;\">Cyanotic congenital heart diseases</td>\n<td style=\"width: 122.691px; height: 140px;\" rowspan=\"4\">Surgically corrected left to right shunt with no residual shunt&nbsp;&nbsp;</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 149.392px; height: 17px;\">Mitral regurgitation</td>\n</tr>\n<tr style=\"height: 35px;\">\n<td style=\"width: 149.392px; height: 35px;\">Ventricular septal defect</td>\n</tr>\n<tr style=\"height: 53px;\">\n<td style=\"width: 149.392px; height: 53px;\">Uncorrected left to right shunt (except ASD)</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 50-year-old woman underwent mitral valve replacement for severe MR, 5 years ago. She is now posted for an elective colonoscopy, for evaluation of altered bowel habits. What is the recommendation regarding antibiotic prophylaxis for this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Amoxicillin, 2g orally, taken 30 to 60 minutes before the procedure"
      },
      {
        "id": 2,
        "text": "Clindamycin 600mg orally, taken 30 minutes before the procedure"
      },
      {
        "id": 3,
        "text": "Ampicillin, 2g IM or IV  60 minutes before the procedure"
      },
      {
        "id": 4,
        "text": "No antibiotic prophylaxis required"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Antibiotic prophylaxis is <strong>not required</strong> in patients undergoing <strong>genitourinary</strong> or <strong>gastrointestinal</strong> procedures even if they have a high-risk cardiac lesion for developing infecting endocarditis (e.g., prosthetic valve).</p>\n<p><strong>Antibiotic prophylaxis</strong> is recommended for patients who are undergoing <strong>dental procedures</strong>, <strong>invasive respiratory tract</strong> procedures, and procedures on the <strong>infected skin</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Antibiotic prophylaxis is recommended for each of the following patients undergoing dental procedures, except:",
    "choices": [
      {
        "id": 1,
        "text": "A patient with palliative shunt for cyanotic CHD"
      },
      {
        "id": 2,
        "text": "A patient with previous CABG surgery"
      },
      {
        "id": 3,
        "text": "Patient with valvulopathy post cardiac transplantation"
      },
      {
        "id": 4,
        "text": "A patient with prosthetic heart valve"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Routine antibiotic prophylaxis for infective endocarditis is not recommended for patients with previous coronary artery bypass graft surgery. They do not have a long-term risk of infection.</p>\n<p><strong>High-risk cardiac lesions</strong>, for which endocarditis <strong>prophylaxis</strong> is advised before <strong>dental procedures</strong> are:</p>\n<ul>\n<li><strong>Prosthetic heart valves</strong></li>\n<li>Prior endocarditis</li>\n<li><strong>Unrepaired cyanotic congenital heart disease,</strong> including palliative shunts or conduits</li>\n<li>Completely repaired congenital heart defects during the 6 months after repair</li>\n<li>Incompletely repaired congenital heart disease with residual defects adjacent to prosthetic material</li>\n<li><strong>Valvulopathy</strong> developing <strong>after cardiac transplantation</strong></li>\n</ul>\n<p>Antibiotic prophylaxis is not routinely recommended for patients with acquired valvular heart diseases.</p>\n<p>Standard regimen: <strong>Amoxicillin 2g</strong> per orally is given 1-hour prior to surgery. In patients with penicillin allergy, clarithromycin, and azithromycin 500mg per orally can be given.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The blood culture of a patient with suspected infective endocarditis is positive for gram-positive cocci in chains. What is the treatment of choice?",
    "choices": [
      {
        "id": 1,
        "text": "Ampicillin with gentamicin for 2 weeks"
      },
      {
        "id": 2,
        "text": "Penicillin with gentamicin for 2 weeks"
      },
      {
        "id": 3,
        "text": "Vancomycin for 2 weeks"
      },
      {
        "id": 4,
        "text": "Ceftriaxone for 2 weeks"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The treatment for\u00a0<strong>infective endocarditis</strong> with <strong>streptococci</strong>\u00a0consists of <strong>penicillin </strong>with<strong> gentamicin</strong> for 2 weeks.</p>\n<p><strong>Penicillin G</strong> (2-3mU IV Q4h) or <strong>Ceftriaxone</strong> (2g single dose daily) can be given as a monotherapy for <strong>4 weeks</strong>.</p>\n<table style=\"height: 251px;\" width=\"515\">\n<tbody>\n<tr style=\"height: 29.9479px;\">\n<td style=\"width: 506.354px; text-align: center; height: 29.9479px;\" colspan=\"2\"><strong>Treatment of infective endocarditis</strong></td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">Streptococci</td>\n<td style=\"width: 258.299px; height: 17px;\">Penicillin + Gentamicin</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">Staphylococcus aureus infecting native valve</td>\n<td style=\"width: 258.299px; height: 17px;\">Vancomycin</td>\n</tr>\n<tr style=\"height: 35px;\">\n<td style=\"width: 242.743px; height: 35px;\">Staphylococcus aureus infecting prosthetic valves</td>\n<td style=\"width: 258.299px; height: 35px;\">Vancomycin + Gentamicin + Rifampin</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">Enterococci</td>\n<td style=\"width: 258.299px; height: 17px;\">Ampicillin + Gentamicin</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">HACEK group</td>\n<td style=\"width: 258.299px; height: 17px;\">Ceftriaxone or Ampicillin + Sulbactam</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">Coxiella burnetti</td>\n<td style=\"width: 258.299px; height: 17px;\">Doxycycline + Hydroxychloroquine</td>\n</tr>\n<tr style=\"height: 17px;\">\n<td style=\"width: 242.743px; height: 17px;\">Bartonella</td>\n<td style=\"width: 258.299px; height: 17px;\">Doxycycline + Gentamicin</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 43-year-old patient presented with spikes of fever and difficulty in breathing. Transesophageal echo revealed vegetations in the heart. The culture was positive for Burkholderia cepacia. Which of the following is the first line of management?",
    "choices": [
      {
        "id": 1,
        "text": "Aminoglycosides and colistin"
      },
      {
        "id": 2,
        "text": "Cotrimoxazole with 3rd generation cephalosporin"
      },
      {
        "id": 3,
        "text": "Cefepime and tigecycline"
      },
      {
        "id": 4,
        "text": "Carbepenams and 3rd generation cephalosporins"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The first-line agents used in the management of<strong>\u00a0<em>Burkholderia cepacia</em></strong>\u00a0complex<em><strong>\u00a0</strong></em>(BCC)<em><strong>\u00a0</strong></em>infections are\u00a0trimethoprim-sulfamethoxazole (<strong>cotrimoxazole</strong>), meropenem, minocycline, and <strong>ceftazidime</strong> (3<sup>rd</sup> generation cephalosporin).</p>\n<p>Other options:</p>\n<p>Option A<strong>:</strong> <em>Burkholderia</em> species are <strong>intrinsically resistant to aminoglycosides and polymyxins</strong>.</p>\n<p>Option C: Tigecycline is less effective in the\u00a0case of <em>Burkholderia</em> infections.</p>\n<p>Option D: Carbapenems and 3<sup>rd</sup> generation cephalosporins have the\u00a0same mechanism of action and compete for the\u00a0same binding site. Hence, it is not a rational drug combination.\u00a0</p>\n<p>BCC is a group of bacteria known for causing <strong>severe respiratory distress</strong> and <strong>septicemia</strong>, particularly in patients with <strong>cystic fibrosis</strong> (CF). BCC organisms are also found in <strong>ICU</strong> patients and individuals with <strong>chronic granulomatous disease</strong>, leading to lung disease.\u00a0BCC colonization in CF patients <strong>prior to</strong> <strong>lung transplantation</strong> increases the risk of death during the early transplant period.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the causative organism of acute rheumatic fever?",
    "choices": [
      {
        "id": 1,
        "text": "Group A streptococcus"
      },
      {
        "id": 2,
        "text": "Group B streptococcus"
      },
      {
        "id": 3,
        "text": "Group C streptococcus"
      },
      {
        "id": 4,
        "text": "Group D streptococcus"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Acute rheumatic fever</strong> is caused due to infection with&nbsp;<strong>group A streptococcus</strong> (GAS), which is <em><strong>Streptococcus pyogenes</strong></em>. It usually follows a streptococcal sore throat or scarlet fever. Other groups of streptococci do not cause acute rheumatic fever.&nbsp;</p>\n<p>The pathogenesis of the development of ARF is based on the concept of <strong>molecular mimicry</strong>. The antibodies which are produced against <strong>M protein</strong> and N-acetyl glucosamine of group A streptococci, bind to and damage the human endothelial cells.</p>\n<p>It mainly affects children between <strong>5-14 years</strong> of age. Patients have various rheumatologic, cardiac, and neurological manifestations. <strong>Modified Jone's criteria</strong> is used for the diagnosis of acute rheumatic fever.&nbsp;</p>\n<p>The main aim of treatment of rheumatic fever is to relieve symptoms, prevent inflammation and prevent further infections by group A streptoccus by the use of penicillins.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "What is the most common clinical feature seen in patients with acute rheumatic fever?",
    "choices": [
      {
        "id": 1,
        "text": "carditis"
      },
      {
        "id": 2,
        "text": "Polyarthritis"
      },
      {
        "id": 3,
        "text": "Chorea"
      },
      {
        "id": 4,
        "text": "Erythema marginatum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The most common clinical feature of acute rheumatic fever is <strong>carditis</strong>\u00a0followed by polyarthritis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is a feature of Sydenham\u2019s chorea?",
    "choices": [
      {
        "id": 1,
        "text": "Always associated with arthritis"
      },
      {
        "id": 2,
        "text": "Affects mainly the head and upper limbs"
      },
      {
        "id": 3,
        "text": "Occurs within 3 weeks of streptococcal infection"
      },
      {
        "id": 4,
        "text": "Only restricted to one half of the body"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Choreiform movements in <strong>Sydenham&rsquo;s chorea</strong> is mainly seen in the&nbsp;<strong>head &amp; upper limbs</strong>.</p>\n<p>Sydenham chorea is characterized by the presence of <strong>involuntary</strong>, purposeless, <strong>jerky movements</strong> of the hands, arms, shoulders, feet, legs, face, and trunk. The movements may be generalized or restricted to one side of the body.</p>\n<p>It follows a <strong>long latent</strong> <strong>period</strong> (more than 6 months) and therefore can occur alone without any other clinical manifestations.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ea25fdbaa4aa4f1e9d86c7d59a3e1f91x510x451.GIF"
    ]
  },
  {
    "text": "Which of the following is a feature of subcutaneous nodules palpated in a patient with acute rheumatic fever?",
    "choices": [
      {
        "id": 1,
        "text": "Painful"
      },
      {
        "id": 2,
        "text": "Early manifestation"
      },
      {
        "id": 3,
        "text": "Common in hands and feet"
      },
      {
        "id": 4,
        "text": "Fixed to underlying structure"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Subcutaneous nodules are commonly present in hands, feet, elbows, and occiput.</p>\n<p>They are firm, <strong>painless</strong>, and <strong>freely movable</strong> subcutaneous nodules, present over the bony prominences of <strong>hands, feet, elbow,&nbsp;</strong>and<strong> occiput.&nbsp;</strong>They are a&nbsp;<strong>delayed manifestation</strong>&nbsp;of rheumatic fever and are usually associated with carditis.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following is a minor criterion according to modified Jones criteria for diagnosis of rheumatic fever in low risk population?",
    "choices": [
      {
        "id": 1,
        "text": "1,5"
      },
      {
        "id": 2,
        "text": "2,4"
      },
      {
        "id": 3,
        "text": "2,3"
      },
      {
        "id": 4,
        "text": "3,5"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>ESR &ge;60 mm</strong>&nbsp;and <strong>polyarthralgia</strong> are a part of minor criteria for the low-risk population among the given options.</p>\n<p>The major and minor criteria for arthritis differ in low risk and medium to high-risk populations.</p>\n<ul>\n<li>For low-risk populations, polyarthritis is a major criterion and polyarthralgia is a minor criterion.</li>\n<li>In the medium to high-risk populations, polyarthritis, polyarthralgia, monoarthritis are major criteria and monoarthralgia is a minor criterion.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which among the following is not a feature of joint pain seen in patients with rheumatic fever?",
    "choices": [
      {
        "id": 1,
        "text": "Migratory arthritis"
      },
      {
        "id": 2,
        "text": "Mainly involves large joints"
      },
      {
        "id": 3,
        "text": "Symmetric involvement"
      },
      {
        "id": 4,
        "text": "Good response to salicylates"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>In rheumatic fever, joint pain is usually <strong>asymmetric.</strong></p>\n<p>Characteristic features of arthritis of acute rheumatic fever are:</p>\n<ul>\n<li><strong>Migratory</strong>- the pain moves from one joint to another over a period of hours</li>\n<li>Involvement of&nbsp;<strong>large joints</strong> &ndash; most commonly knees, ankle, hips &amp; elbows</li>\n<li><strong>Asymmetric</strong></li>\n<li>Highly responsive to <strong>salicylates</strong></li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old patient presented to the clinic with skin lesions as shown in the image. On examination, body temperature is 38.5 \u00b0C, ESR and ASLO titers are elevated. What is true about the skin finding?",
    "choices": [
      {
        "id": 1,
        "text": "Pruritic"
      },
      {
        "id": 2,
        "text": "It is called erythema migrans"
      },
      {
        "id": 3,
        "text": "Disappears after hot shower"
      },
      {
        "id": 4,
        "text": "Generally occurs in patients with carditis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The above clinical features are suggestive of <strong>rheumatic fever</strong> and the skin finding shown in the image is <strong>erythema marginatum.&nbsp;</strong>It generally occurs in patients with <strong>carditis</strong>.&nbsp;</p>\n<p>Erythema marginatum is a <strong>pink, non-pruritic rash</strong> that generally occurs on the <strong>upper part </strong>of the <strong>arms </strong>or<strong> trunk</strong> but not on the face. It extends from the centre with an&nbsp;<strong>irregular serpiginous border</strong>. As the size of the rash increases, the <strong>center</strong> of the rash returns to <strong>normal</strong>, while the borders remain pink. Hence it is named erythema marginatum.</p>\n<p>The rash may also become more prominent after a hot shower.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0a34819b2d2c4be0bbc94e59f285fafb.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "Evidence of preceding streptococcal infection is not essential for making a diagnosis of acute rheumatic fever in patients presenting with:",
    "choices": [
      {
        "id": 1,
        "text": "Polyarthritis"
      },
      {
        "id": 2,
        "text": "Chorea"
      },
      {
        "id": 3,
        "text": "Subcutaenous nodules"
      },
      {
        "id": 4,
        "text": "Erythema marginatum"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Evidence of preceding streptococcal infection for making diagnosis of acute rheumatic fever (ARF) is not required in the presence of chorea.</p>\n<p><strong>Chorea</strong> is frequently a <strong>late finding </strong>of ARF<strong>. </strong>When chorea appears,&nbsp;major findings, minor findings and findings of preceding streptococcal infection would have been disappeared.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A patient diagnosed with acute rheumatic fever develops a new-onset murmur. His echocardiography is likely to reveal:",
    "choices": [
      {
        "id": 1,
        "text": "Mitral stenosis"
      },
      {
        "id": 2,
        "text": "Aortic stenosis"
      },
      {
        "id": 3,
        "text": "Mitral regurgitation"
      },
      {
        "id": 4,
        "text": "Aortic regurgitation"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Characteristic <strong>initial valvular</strong> manifestation in acute rheumatic fever (ARF) is&nbsp;<strong>mitral regurgitation.</strong></p>\n<p>Damage of the valves leads to mitral regurgitation in the early stages.<strong>&nbsp;</strong>With repeated episodes of rheumatic fever, there is thickening, calcification, and <strong>stenosis</strong> of the affected valve.</p>\n<p><strong>Mitral regurgitation</strong> is the most common cardiac lesion in <strong>ARF</strong>, while <strong>m</strong><strong>itral stenosis</strong> is the most common lesion in <strong>r</strong><strong>heumatic heart disease</strong>.</p>\n<p>Other cardiac manifestations of acute rheumatic fever include myocardial inflammation that can also affect electrical conduction pathways, <strong>leading to P-R interval prolongation</strong> (first-degree atrioventricular block or rarely higher-level block) and softening of the first heart sound.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The prevalence of rheumatic valvular heart disease peaks between:",
    "choices": [
      {
        "id": 1,
        "text": "5-15 years"
      },
      {
        "id": 2,
        "text": "15-25 years"
      },
      {
        "id": 3,
        "text": "25-40 years"
      },
      {
        "id": 4,
        "text": ">40 years"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The prevalence of rheumatic valvular heart disease peaks between <strong>25-40 years</strong>.</p>\n<p><strong>Acute rheumatic fever</strong> is mainly a disease of children and is common between&nbsp;<strong>5&ndash;14 </strong>years of age and rare in a person aged more 30 years. In contrast to this,&nbsp;<strong>rheumatic valvular heart disease</strong>&nbsp;is common between <strong>25-40 years</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "The drug used for refractory intractable rheumatic chorea is:",
    "choices": [
      {
        "id": 1,
        "text": "Probenecid"
      },
      {
        "id": 2,
        "text": "Diazepam"
      },
      {
        "id": 3,
        "text": "Haloperidol"
      },
      {
        "id": 4,
        "text": "Sodium valproate"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The drug used for refractory intractable rheumatic chorea is <strong>sodium valproate.</strong></p>\n<p><strong>Sydenham's chorea</strong>&nbsp;is characterized by involuntary, purposeless, jerky movements which mainly affect the&nbsp;<strong>head&nbsp;</strong>and<strong>&nbsp;upper limbs</strong>. In the tongue, it is visible as the characteristic darting movements.</p>\n<p>Medications used to treat Sydenham chorea are:</p>\n<ul>\n<li>Mild cases: managed by providing a calm environment</li>\n<li>Severe cases: dopamine antagonists like haloperidol, pimozide, or antiepileptic medications like sodium valproate (preferred due to no extrapyramidal side effects) and carbamazepine</li>\n<li>Since Sydenham chorea is thought to be an immune-mediated disorder, <strong>steroids</strong> are effective in the treatment of <strong>severe</strong> or <strong>refractory</strong> cases.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 12-year-old boy is admitted with fever and polyarthritis. His ESR on admission is 80mm/hr. There is no evidence of carditis. A diagnosis of acute rheumatic fever is made and treatment is initiated. How long will you put the patient on secondary prophylaxis?",
    "choices": [
      {
        "id": 1,
        "text": "Till 21 years of age"
      },
      {
        "id": 2,
        "text": "Till 17 years of age"
      },
      {
        "id": 3,
        "text": "Till 22 years of age"
      },
      {
        "id": 4,
        "text": "Lifelong"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>This patient has a&nbsp;<strong>rheumatic fever without carditis.&nbsp;</strong>He should be given prophylaxis <strong>till 21 years of age</strong> as&nbsp;the duration of secondary prophylaxis is <strong>5 years or until 21 years of age</strong> (whichever is longer).</p>\n<div class=\"page\" title=\"Page 2591\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 2591\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>Secondary prophylaxis is given for patients with acute rheumatic fever (ARF). These patients are at a higher risk of developing a further episode of ARF after a group A streptococcal infection. Hence they should receive long-term penicillin prophylaxis to prevent recurrent infections.&nbsp;</p>\n<p><span class=\"fontstyle0\">The antibiotics that can be given for secondary prophylaxis are:</span></p>\n<ul>\n<li><span class=\"fontstyle0\"><strong>Benzathine penicillin G</strong> (1.2 million units) given&nbsp;<strong>every 4 weeks&nbsp;</strong>(Best antibiotic)</span></li>\n<li><span class=\"fontstyle0\">Oral penicillin V (250 mg) given twice daily (less effective than benzathine penicillin G)</span></li>\n<li><span class=\"fontstyle0\">Erythromycin (250 mg) twice daily (For patients allergic to penicillin)</span></li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '062 Infective Endocarditis And Acute Rheumatic Fever';
        const quizFilename = '062-infective-endocarditis-and-acute-rheumatic-fever-b9bfc89f.html';
        let hierarchy = ["Marrow", "qBank", "Medicine"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>