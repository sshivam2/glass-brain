<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecg Mini Test - -Tmt - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / NEET PG Mini Test Series / 2023-24
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Which of the following is the site of placement of the V4 chest lead while recording an ECG?",
    "choices": [
      {
        "id": 1,
        "text": "At the midclavicular line in the fifth intercostal space"
      },
      {
        "id": 2,
        "text": "In the fifth intercostal space just to the left of the sternum"
      },
      {
        "id": 3,
        "text": "At the anterior axillary line in the fifth intercostal space"
      },
      {
        "id": 4,
        "text": "In the fourth intercostal space just to the left of the sternum"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<div class=\"page\" title=\"Page 525\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<div class=\"page\" title=\"Page 523\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>While recording an ECG,&nbsp;the <strong>V4</strong> chest lead is placed at the <strong>midclavicular line</strong> in the <strong>fifth intercostal space</strong>.</p>\n<p>The site of placement of the chest leads is as follows:</p>\n<p>V1: 4th intercostal space, right of the sternum&nbsp;<br />V2:&nbsp;4th intercostal space, left of the sternum (Option D)<br />V3: 5th intercostal space, left of the sternum (Option B)<br />V4:&nbsp;5th intercostal space, centered on clavicle<br />V5:&nbsp;5th intercostal space, left of V4<br />V6:&nbsp;5th intercostal space, under the left arm</p>\n<p>An ECG can be recorded by using an active electrode that is connected to an electrode at zero potential (<strong>unipolar recording</strong>) or by using two active electrodes (<strong>bipolar recording</strong>).</p>\n<div class=\"page\" title=\"Page 525\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>For unipolar recording, six chest leads or precordial leads (V1&ndash;V6) and three limb leads (VR-right arm, VL-left arm, and VF-left foot) are used. Because the heart surfaces are close to the chest wall, the chest lead mainly records the electrical potential of the cardiac musculature immediately beneath it. Therefore, relatively minute abnormalities in the heart muscles can cause marked changes in the ECGs recorded from individual chest leads.</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bebb55396029440681ac8d4070a44a44x824x598.PNG"
    ]
  },
  {
    "text": "Which of the following is the electrocardiograph changes seen in early stages of acute pericarditis?",
    "choices": [
      {
        "id": 1,
        "text": "ST-segment depression with flat T waves"
      },
      {
        "id": 2,
        "text": "Electrical alternans"
      },
      {
        "id": 3,
        "text": "ST-segment elevation with PR segment depression"
      },
      {
        "id": 4,
        "text": "Tall, tented T waves"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>ECG showing <strong>diffuse ST-segment elevation</strong> with <strong>PR segment depression</strong>\u00a0is\u00a0seen in early stages of acute pericarditis.</p>\n<p>The ECG changes in acute pericarditis evolves through four stages:</p>\n<ul>\n<li>Stage 1-\u00a0<strong>Generalized ST-segment elevation</strong> with <strong>upward concavity</strong> with reciprocal depressions only in aVR and V1 and PR segment depression.\u00a0</li>\n<li>Stage 2 - The ST segments return to normal</li>\n<li>Stage 3 - Diffuse\u00a0<strong>T wave inversion</strong></li>\n<li>Stage 4 - ECG returns to normal in weeks or months</li>\n</ul>\n<div class=\"page\" title=\"Page 564\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p><strong>Echocardiography</strong>\u00a0findings are usually normal or may show evidence of a pericardial effusion. If abnormal, regular echocardiographic monitoring is recommended.</p>\n<p>The ECG below shows acute pericarditis causing diffuse ST-segment elevations in leads I, II, aVF, and V2 to V6, with reciprocal ST depressions in lead aVR.</p>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f6e86c7cbcb94379b807a560058d1a69x600x600.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8df729c12dce41d28eb552651300fc3bx719x411.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/68937153497b4df2a129f9c70166ecedx1280x1090.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/d0af2f335ca14cf1b984195a4fb9e56ax640x494.JPEG"
    ]
  },
  {
    "text": "A 72-year-old man comes to the emergency room complaining his heart is pounding and that he is going to die. The emergency physician orders an ECG. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Inferior wall MI"
      },
      {
        "id": 2,
        "text": "Extensive anterior wall MI"
      },
      {
        "id": 3,
        "text": "Anterolateral wall MI"
      },
      {
        "id": 4,
        "text": "Anteroseptal MI"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given ECG shows&nbsp;<strong>ST elevation </strong>in leads<strong> V1-V4</strong>&nbsp;which is suggestive of <strong>acute anteroseptal myocardial infarction</strong> (MI)<strong>. </strong>ST depression in the leads III and aVF signifies an old inferior wall infarction.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/edfec934c9dd4e948efdec9aa4fdee9e.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "All of the following are true about the U wave in an ECG except?",
    "choices": [
      {
        "id": 1,
        "text": "Normally deflection is \u22641 mm and usually has the same polarity as the T wave"
      },
      {
        "id": 2,
        "text": "Prominent U waves are a marker of increased susceptibility to torsades de pointes"
      },
      {
        "id": 3,
        "text": "Abnormal increase in amplitude is seen in hyperkalemia"
      },
      {
        "id": 4,
        "text": "Occurs due to repolarization of ventricular myocytes with long action potential"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>An abnormal <strong>increase in the amplitude</strong> of the<strong> U wave</strong> is seen in <strong>hypokalemia</strong>\u00a0and not hyperkalemia.</p>\n<p>U waves in the ECG represent the ventricular repolarization, particularly of myocytes with long action potentials (option D). The U wave is a small, rounded <strong>deflection\u00a0\u22641 mm</strong> that occurs after the T wave. It usually has the <strong>same polarity</strong> as the T wave (option A). A very <strong>prominent U wave</strong> is considered a marker of increased susceptibility to <strong>torsades de pointes </strong>(option B). Abnormal <strong>increase</strong> in U-wave <strong>amplitude</strong> are most commonly due to <strong>drugs</strong> such as dofetilide, amiodarone, sotalol, and quinidine. It may also be seen in <strong>hypokalemia</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3e338cc5cbbd475e913c20cf595d1907x1280x1081.JPEG"
    ]
  },
  {
    "text": "Which of the following is true about the normal calibration of a typical ECG tracing?",
    "choices": [
      {
        "id": 1,
        "text": "Vertically, 1 small box represents 1 millivolt."
      },
      {
        "id": 2,
        "text": "Horizontally, one large box corresponds to 0.4 seconds."
      },
      {
        "id": 3,
        "text": "Horizontally, one small box corresponds to 0.02 seconds."
      },
      {
        "id": 4,
        "text": "It is recorded at a speed of 25 millimeters per second."
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>An ECG is recorded at the speed of&nbsp;<strong>25 millimeters per second</strong>.</p>\n<div class=\"page\" title=\"Page 1865\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>An <strong>electrocardiogram</strong> is a representation of electrical activity generated by the heart and is recorded on graph paper that is divided into 1-mm<sup>2</sup> gridlike boxes. A typical ECG is run at a speed of <strong>25 millimeters per second</strong>, although faster speeds are sometimes used.</p>\n<div class=\"page\" title=\"Page 1865\">\n<div class=\"section\">\n<div class=\"layoutArea\">\n<div class=\"column\">\n<p>On the horizontal axis, one <strong>small</strong> box is <strong>1mm</strong> and 5 such boxes make up a <strong>large</strong> box which is&nbsp;<strong>5mm</strong>. When the recording speed is 25 mm/s or 25 small boxes/second, the time represented by one small box is 1/25 second. Thus, horizontally</p>\n<ul>\n<li><strong>1 small box = 0.04 seconds</strong>&nbsp;(Option C)</li>\n<li><strong>1 large box = </strong>5 x&nbsp;0.04 seconds =<strong> 0.2 seconds&nbsp;</strong>(Option B)</li>\n</ul>\n<p>On the vertical axis representing the amplitude of the deflections, 1 small box is 1mm and 10 such boxes represent 1 millivolt. So, <strong>1 small box</strong> represents 1/10 = <strong>0.1</strong> <strong>millivolt</strong>.<strong>&nbsp;</strong>(Option A). Calibration is often confirmed using the reference pulse tracing that is present in ECG tracings.&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b7d285c6da3a43d794758e02bf6827e7x1280x1789.JPEG"
    ]
  },
  {
    "text": "Which of the following is/are correct with respect to the cardiac cycle, heart sounds, and the waveforms seen on the ECG?",
    "choices": [
      {
        "id": 1,
        "text": "2 and 3"
      },
      {
        "id": 2,
        "text": "1 and 4"
      },
      {
        "id": 3,
        "text": "1, 2, and 4"
      },
      {
        "id": 4,
        "text": "1, 2, and 3"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The statements<strong>\u00a01, 2, and 3\u00a0</strong>are correct.</p>\n<p>As clear from Wigger's diagram below, S1 corresponds the timing of S1 heart sound corresponds temporally to the occurrence of QRS wave in ECG.</p>\n<p>Similarly, the timing of the S2 heart sound corresponds to the end of the T wave in ECG.\u00a0</p>\n<p>The statement D is incorrect as the\u00a0<strong>\u2018c\u2019 wave of JVP </strong>is seen during the<strong>\u00a0isovolumetric contraction </strong>(with all valves closed)<strong>\u00a0</strong>phase<strong>\u00a0</strong>when the ventricular muscle continues to contract.\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7c11ba5e94b749528b9e51f2fefad15ex783x600.PNG"
    ]
  },
  {
    "text": "A 35-year-old female presents with dizziness and breathing difficulty to the emergency department. Vitals are significant for a BP of 100/70mm of Hg and a pulse rate of 110 bpm. Her heart sounds are muffled. The ECG tracing is shown in the image below. Which of the following is most likely to be seen in this patient?",
    "choices": [
      {
        "id": 1,
        "text": "Pulsus bisferiens"
      },
      {
        "id": 2,
        "text": "Pulsus parvus et tardus"
      },
      {
        "id": 3,
        "text": "Pulsus paradoxus"
      },
      {
        "id": 4,
        "text": "Pulsus alternans"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The ECG shows <strong>electrical alternans with sinus tachycardia. </strong>This along with the patient's symptoms<strong>&nbsp;</strong>of<strong> muffled heart sounds</strong>, breathlessness, and hypotension points to a diagnosis of<strong>&nbsp;cardiac tamponade. P</strong><strong>ulsus paradoxus</strong> is typically associated with cardiac tamponade.</p>\n<p><strong>Pulsus paradoxus</strong>&nbsp;refers to the&nbsp;<strong>fall in systolic blood pressure &gt;10 mmHg</strong>&nbsp;with&nbsp;<strong>inspiration.</strong>&nbsp;In cardiac tamponade, the ventricles are covered by an incompressible pericardial sac with increased pressure in the pericardial sac. Increased blood flows into the right ventricle during inspiration causes the interventricular septum to bulge into the left ventricle, which in turn causes a reduction in left ventricular volume, stroke volume, and arterial blood pressure. Severe cases may show weakening or disappearance of arterial pulse on palpation during inspiration.</p>\n<p>Other causes of pulsus paradoxus include:</p>\n<ul>\n<li>Massive pulmonary embolism</li>\n<li>Tension pneumothorax</li>\n<li>Severe obstructive lung disease</li>\n<li>Hemorrhagic shock</li>\n</ul>\n<p><strong>Cardiac tamponade </strong>is the accumulation of fluid in the pericardial space causing raised intra-pericardial pressure. This results in poor ventricular filling and a fall in cardiac output. This may be <strong>acute</strong>&nbsp;following&nbsp;trauma or as a complication of an invasive diagnostic or therapeutic procedure.&nbsp;<strong>Subacute cardiac tamponade&nbsp;</strong>occurs&nbsp;over days to weeks and can be associated with neoplastic, uremic, or idiopathic pericarditis.</p>\n<p>Symptoms of cardiac tamponade include dyspnea, chest discomfort or fullness, peripheral edema, and fatigue. Examination findings are:</p>\n<ul>\n<li>Tachycardia and hypotension</li>\n<li>Jugular venous distention with a <strong>prominent x (early systolic) descent but an absent y (early diastolic) descent</strong></li>\n<li>Pericardial rub</li>\n<li>Pulsus paradoxus</li>\n</ul>\n<p><strong>ECG&nbsp;</strong>shows<strong>&nbsp;</strong>reduced voltage and electrical alternans.&nbsp;<strong>Electric alternans</strong>&nbsp;is a specific finding caused by the&nbsp;<strong>anteroposterior swinging</strong>&nbsp;of the heart with each contraction. When the heart is nearer to the chest wall, it leads to an increased amplitude deflection on the ECG, whereas, a lower amplitude deflection is seen when the heart moves away from the chest wall.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/1824c7f173f9441784106323ac349b84.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1c6c060940e3403eb77355813df0c89ax1280x1090.JPEG"
    ]
  },
  {
    "text": "A 64-year-old man presents with complaints of palpitations and syncope. He has a history of inferior-wall myocardial infarction a year ago. The ECG strip obtained during his admission is given below. What is the long-term treatment for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Amiodarone"
      },
      {
        "id": 2,
        "text": "Atropine only"
      },
      {
        "id": 3,
        "text": "Permanent pacemaker"
      },
      {
        "id": 4,
        "text": "Atropine and isoproterenol"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Based on his ECG findings, this patient is suffering from\u00a0<strong>symptomatic </strong>(palpitations, syncope)\u00a0<strong>Mobitz Type II AV block</strong>. The definitive long-term treatment is, therefore, a\u00a0<strong>permanent pacemaker.\u00a0</strong></p>\n<p>Mobitz Type II AV block is characterized by:</p>\n<ul>\n<li>a <strong>constant PR interval</strong></li>\n<li>some P waves not be followed by QRS complexes</li>\n</ul>\n<p>According to the rhythm strip (Lead II) of the ECG shown, the patient is experiencing a <strong>3:2 AV block</strong> which is then progressing to a 2:1 AV block.</p>\n<p>This patient is also suffering from a <strong>right bundle branch block</strong>\u00a0(RBBB)<strong>\u00a0</strong>as indicated by the wide QRS complexes in leads V1, V2, and <strong>V3 ('M'-shaped)</strong>.\u00a0</p>\n<p>This patient with a history of ischemic heart disease (previous history of inferior-wall MI) and objective signs of Mobitz Type II AV block and RBBB will benefit most from a permanent pacemaker.\u00a0</p>\n<p>In the ECG below, the <strong>blue arrows</strong> show\u00a0some <strong>P waves</strong> that were not followed by QRS complexes. The <strong>missed QRS complex</strong> is pointed by the <strong>red arrow</strong>. The <strong>red box</strong> indicates the <strong>wide QRS complexes</strong>\u00a0in leads V1, V2, and V3:</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/d4aad04e5c1c4043bdb02d3835b5d743.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9b0310f1672747cb9a200242d8371321x765x510.PNG"
    ]
  },
  {
    "text": "An ECG showing S1Q3T3 changes is suggestive of which of the following?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary embolism"
      },
      {
        "id": 2,
        "text": "Pleural effusion"
      },
      {
        "id": 3,
        "text": "Acute pericarditis"
      },
      {
        "id": 4,
        "text": "Tricuspid stenosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>An ECG showing <strong>S1Q3T3</strong> changes is most likely suggestive of acute\u00a0<strong>pulmonary embolism </strong>(PE).</p>\n<p>ECG changes in acute PE (shown below) are characterized by the classic <strong>S1Q3T3 changes</strong>, due to right ventricular strain and ischemia:</p>\n<ul>\n<li>A prominent S wave in lead I (blue arrow)</li>\n<li>Q wave in lead III (red arrow)</li>\n<li>An inverted T wave in lead III (green arrow)</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ced1c813881f4142998ba1d92081f44ex1280x879.JPEG"
    ]
  },
  {
    "text": "A 66-year-old man presents to the emergency department with complaints of palpitations and breathlessness. He has a history of chronic obstructive pulmonary disease. His ECG is given below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Paroxysmal supraventricular tachycardia"
      },
      {
        "id": 2,
        "text": "Atrial fibrillation"
      },
      {
        "id": 3,
        "text": "Atrial flutter"
      },
      {
        "id": 4,
        "text": "Multifocal atrial tachycardia"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The given clinical feature and the ECG are pointing towards the diagnosis of <strong>multifocal atrial tachycardia </strong>(MAT).</p>\n<p>Identifying features in ECG:</p>\n<ul>\n<li><strong>Heart rate &gt;100 bpm</strong></li>\n<li><strong>Irregular</strong> rhythm</li>\n<li><strong>Discrete P</strong> waves with<strong> &gt;3 different morphologies </strong>(black arrows)</li>\n<li>Variable PR interval</li>\n<li>Narrow QRS complex</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/0afb68727c024ff38a47dcd2496e4040.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/97a93cce9c7143ef9827b285aef64e5ex800x406.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2b5361afe5e44e269aa5fa35fe2f487dx800x372.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bb221c8a95ec44e0bfc15cead3b35f1bx800x549.JPEG"
    ]
  },
  {
    "text": "Which of the following conditions is least likely to result in the following ECG picture?",
    "choices": [
      {
        "id": 1,
        "text": "Congenital pulmonary valve stenosis"
      },
      {
        "id": 2,
        "text": "Left bundle branch block"
      },
      {
        "id": 3,
        "text": "Aortic valvular stenosis"
      },
      {
        "id": 4,
        "text": "Hypertension"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The given ECG shows a <strong>left-axis deviation</strong>. <strong>Left bundle branch block</strong>,&nbsp;<strong>aortic valvular stenosis</strong>, and <strong>hypertension</strong> cause left ventricular hypertrophy leading to left-axis deviation in ECG. <strong>Congenital pulmonary valve</strong> <strong>stenosis</strong> causes right ventricular hypertrophy leads to a <strong>right-axis deviation </strong>and hence is unlikely to be associated with the above ECG.</p>\n<p>In a given ECG, the axis can be calculated based on lead I, lead II, and aVF. The direction of vectors is decided based on the <strong>axis of the leads</strong> as shown below and whether the QRS complex in that lead has a positive or a negative <strong>deflection</strong>.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/550844d382654d7ab4365411dae793d4.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b66f18980198441fa8f6282ffc1cfbf6x1280x1581.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3b36fd9d7ac84093a6b48c57df86c8cdx1280x2683.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b147c047783e497692d71bd321a6b4adx1279x1625.JPEG"
    ]
  },
  {
    "text": "A 35-year-old man is brought to the emergency room after a syncopal episode. Additionally, he complains of palpitations that had started before the syncopal episode. His BP is 135/90 mm of Hg and a heart rate is 110 bpm. He recently had started taking azithromycin for an infection. Serum electrolytes are as shown below",
    "choices": [
      {
        "id": 1,
        "text": "Magnesium Sulphate"
      },
      {
        "id": 2,
        "text": "Procainamide"
      },
      {
        "id": 3,
        "text": "Ibutilide"
      },
      {
        "id": 4,
        "text": "Defibrillation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The clinical vignette and ECG represent a case of<strong>&nbsp;torsades de pointes. Magnesium Sulphate </strong>is the first line of management in hemodynamically stable cases.</p>\n<p>Torsades de pointes commonly present as <strong>syncope</strong> or <strong>chest pain</strong>. This patient's <strong>hypokalemia</strong> and use of <strong>azithromycin</strong> predispose him to develop symptomatic torsades de pointes.</p>\n<p><strong>Torsades de pointes</strong> means twisting of points, it implies twisting of the QRS complexes around the isoelectric line of the ECG. It is a form of <strong>polymorphic ventricular tachycardia</strong> that is seen in patients with <strong>prolonged QT interval</strong>.&nbsp;</p>\n<p>A prolonged QT interval usually results from prolonged ventricular repolarization (lengthening of the T wave). A premature ventricular contraction falling in the elongated T wave can initiate torsades de Pointes.</p>\n<p>The features of torsades de pointes are:</p>\n<ul>\n<li><strong>Polymorphic QRS </strong>complexes that change in amplitude (as seen in the image)</li>\n<li>Cycle length gives an appearance of <strong>oscillations around the baseline</strong></li>\n<li><strong>QT prolongation</strong></li>\n</ul>\n<p>Other options:</p>\n<p>Options B &amp; C - Procainamide and Ibutilide are used in the management of Wolff Parkinson White syndrome.&nbsp;</p>\n<p>Option D - Defibrillation is indicated only if the patient is hemodynamically unstable, or as a last resort.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ca20c085d20344fab6c45813bc1688ac.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/3ea46b0de72e4c99addbd553fdb9fa08x720x184.JPEG"
    ]
  },
  {
    "text": "Which of the following findings is not seen in a patient with a Dextrocardia?",
    "choices": [
      {
        "id": 1,
        "text": "Inverted P wave in lead I and lead aVL"
      },
      {
        "id": 2,
        "text": "Negative QRS comples in Lead I"
      },
      {
        "id": 3,
        "text": "Negative T wave in Lead I"
      },
      {
        "id": 4,
        "text": "Progressively increasing voltage across precordium in chest leads"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Progressively <strong>decreasing&nbsp;</strong>(not increasing) voltage across the precordium is seen in<strong>&nbsp;dextrocardia.&nbsp;</strong>This is because the heart is located on the right side, while the leads are placed on the left. Right-sided lead placement would show a normal progression.</p>\n<p><strong>Findings Suggestive of Dextrocardia</strong></p>\n<ul>\n<li>Inverted P waves in Lead I and aVL</li>\n<li>Negative QRS complex and T wave in Lead I\n<ul>\n<li><strong>(Lead I</strong>: <strong>inversion of all complexes, aka &lsquo;global negativity&rsquo; i.e. inverted P wave, negative QRS, inverted T wave)</strong></li>\n</ul>\n</li>\n<li>Progressively decreasing voltage across the precordium</li>\n</ul>\n<p>&nbsp;</p>\n<p>ECG showing dextrocardia:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/4d4432a66fb64db3a9f2235f55833eb2x720x209.JPEG"
    ]
  },
  {
    "text": "Which of the following ECGs represents the Wenckebach phenomenon?",
    "choices": [
      {
        "id": 1,
        "text": "4"
      },
      {
        "id": 2,
        "text": "2"
      },
      {
        "id": 3,
        "text": "1"
      },
      {
        "id": 4,
        "text": "3"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>ECG 4 showing&nbsp;a <strong>progressive PR elongation</strong> leading to an eventual <strong>drop</strong> in the<strong> QRS complex</strong> represents the&nbsp;<strong>Wenckebach phenomenon.&nbsp;</strong>It is also known as<strong>&nbsp;Mobitz</strong>&nbsp;<strong>type 1&nbsp;</strong>and is a subtype of&nbsp;<strong>second-degree atrioventricular block.</strong></p>\n<p>ECG 1:&nbsp;Mobitz type 2 heart block<br />ECG 2:&nbsp;First-degree heart block<br />ECG 3:&nbsp;Complete heart block<br />ECG 4:&nbsp;Mobitz type 1 heart block</p>\n<p><strong>Second-degree heart block</strong>&nbsp;occurs due to the&nbsp;<strong>intermittent failure</strong> of electrical <strong>impulse conduction</strong> from the atrium to the ventricle. It is characterized by <strong>a missed QRS</strong> and maybe of Mobitz type I or II.</p>\n<p><strong>Mobitz type 1/ Wenckebach</strong>&nbsp;(ECG 4) occurs due to the decremental conduction of electrical impulses in the AV node. It is characterized by a progressive PR elongation leading to an eventual drop in the QRS complex. This occurs because the&nbsp;<strong>atria</strong>&nbsp;are&nbsp;<strong>unable to conduct</strong>&nbsp;the electrical impulse to the&nbsp;<strong>ventricles</strong>.&nbsp;Patients are usually&nbsp;<strong>asymptomatic</strong>&nbsp;unless there is significant ventricular bradyarrhythmia. They also have irregular pulse rates.&nbsp;</p>\n<p>&nbsp;</p>\n<p>&nbsp;</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/12b33dd84cec4e06835f5cd7e7bba70d.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e87143ee6a84490ca01e5ab28a11d2b5x436x135.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/93a4a2eb43154cf4af9520d5163d584bx800x145.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/58896f29e1c74329b2c4e84aab59a295x436x132.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0f28649a04cd42918f13e700369016cbx434x125.PNG"
    ]
  },
  {
    "text": "A patient's ECG strip is given below. His cardiac output was found to be 4.8 L/min. What is the stroke volume?",
    "choices": [
      {
        "id": 1,
        "text": "100 ml"
      },
      {
        "id": 2,
        "text": "60 ml"
      },
      {
        "id": 3,
        "text": "120 ml"
      },
      {
        "id": 4,
        "text": "80 ml"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Cardiac output is calculated by the following formula -</p>\n<p>Cardiac output = Heart rate x Stroke volume</p>\n<p>The patient's <strong>cardiac output is 4.8L/min</strong>.</p>\n<p>His heart rate can be calculated from the rhythm strip given i.e., HR = 300/number of large squares between consecutive beats. There are approximately 5 large boxes between beats in this ECG.</p>\n<p><strong>HR = 300/5 = 60 beats/min.</strong></p>\n<p>Therefore, the patient's stroke volume = CO/HR = 4.8L/min/60 beats/min = 0.08 L = <strong>80ml</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/55e0754e85aa4cd3aa9a9395929311b3.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "The ECG wave as shown in the image below is commonly seen in",
    "choices": [
      {
        "id": 1,
        "text": "Myocardial infarction"
      },
      {
        "id": 2,
        "text": "Hyperkalemia"
      },
      {
        "id": 3,
        "text": "Digoxin treatment"
      },
      {
        "id": 4,
        "text": "Hypokalemia"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The above ECG wave characteristically depicts <strong>Digoxin</strong> <strong>effect</strong>.</p>\n<p><strong>Digoxin effect</strong> refers to the presence on the ECG of:</p>\n<ul>\n<li><strong>Downsloping</strong> <strong>ST depression</strong> with a characteristic &ldquo;<strong>Salvador Dali sagging</strong>&rdquo; or &ldquo;<strong>Hockey Stick</strong>&rdquo; appearance.</li>\n<li>Flattened, inverted, or biphasic T waves.</li>\n<li>Shortened QT interval.</li>\n</ul>\n<p><strong>Additional ECG Features:</strong></p>\n<ul>\n<li>Mild PR interval prolongation of up to 240ms (due to increased vagal tone).</li>\n<li>Prominent <strong>U waves</strong>.</li>\n<li>Peaking of the terminal portion of the <strong>T waves</strong>.</li>\n<li><strong>J point depression</strong> (usually in leads with tall R waves).</li>\n</ul>\n<p><strong>QRS complex / ST segment changes:</strong></p>\n<ul>\n<li>The morphology of the QRS complex / ST segment is variously described as either &ldquo;slurred&rdquo;, &ldquo;sagging&rdquo; or &ldquo;scooped&rdquo; and resembling either a &ldquo;reverse tick&rdquo;, &ldquo;hockey stick&rdquo; or &ldquo;Salvador Dali&rsquo;s moustache&rdquo;.</li>\n</ul>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/4cb28c06e60e495dae0fb1b9131d27e5.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "A 30-year-old female patient presents to the emergency department with complaints of chest pain and palpitations. ECG strip obtained is shown in the image below. His BP is 120/76 mm Hg. Vagal maneuvers were tried but failed. What is the drug of choice for this condition?",
    "choices": [
      {
        "id": 1,
        "text": "Lidocaine"
      },
      {
        "id": 2,
        "text": "Esmolol"
      },
      {
        "id": 3,
        "text": "Digoxin"
      },
      {
        "id": 4,
        "text": "Adenosine"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>This ECG strip&nbsp;is suggestive of the AV nodal reentry (<strong>AVNRT</strong>) variant of&nbsp;<strong>paroxysmal supraventricular tachycardia (PSVT). </strong>The drug of choice for the termination of PSVT is <strong>adenosine.</strong><strong>&nbsp;</strong></p>\n<div class=\"O0\">\n<p>PSVT spans a variety of tachycardia that differ based on the pathway of impulse conduction. They include AV node reentry, AV reentry via an accessory pathway, and atrial tachycardia. AVNRT is the most commonly seen pattern of PSVT in healthy adults, especially in women. This form of PSVT is due to the re-entry of the electrical impulse from the AV node to the right atrium via either of the 2 pathways (superior fast pathway and inferior slow pathway).</p>\n<p>The given ECG strip shows changes suggestive of <strong>AV node reentry tachycardia</strong> based on the following findings-</p>\n<ul>\n<li><strong>Narrow QRS complex</strong> tachycardia (green arrows) at 150 bpm - indicative of a regular atrial rate (<strong>1:1 AV response</strong>). Heart rate is calculated by dividing 300 by the number of large boxes between 2 consecutive R waves. The ECG strip shows the presence of roughly 2 large boxes between 2 consecutive R waves, thereby making the HR ~150 bpm.&nbsp;</li>\n<li><strong>No visible P waves</strong> - indicative of dual conduction pathways (slow and fast) that cause simultaneous atrial and ventricular activation.</li>\n<li>The P wave may sometimes be seen at the end of the QRS complex as a <strong>pseudo-r' wave (V1)</strong>&nbsp;(black arrow) and <strong>pseudo-S wave (II, III, aVF)&nbsp;</strong>(blue arrows).&nbsp;</li>\n</ul>\n</div>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/fbcd52b7772648e9a6a49d11b9f4fb45.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/1124ef0817754554a5b835c82e1377d2x1280x644.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/73866a11df3b4cba923658ca97b6c962x510x812.PNG"
    ]
  },
  {
    "text": "The electrocardiograph (ECG) of a patient with core body temperature of 85 \u00b0F is shown below. What is the hallmark of this patient's ECG marked by arrows in the image below?",
    "choices": [
      {
        "id": 1,
        "text": "Prominent U wave"
      },
      {
        "id": 2,
        "text": "Tall peaked T waves"
      },
      {
        "id": 3,
        "text": "ST segment elevation"
      },
      {
        "id": 4,
        "text": "Osborne J wave"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The hallmark of this patient's ECG is the&nbsp;<strong>Osborn J wave.</strong></p>\n<p>Hypothermia is defined as core body temperature is less than 95&deg;F.</p>\n<p>In the <strong>initial stages</strong> of hypothermia, as a reaction to the general stress, there is <strong>sinus tachycardia</strong>.&nbsp;As the temperature drops <strong>below 90&deg;F,</strong> there is <strong>sinus bradycardia</strong> associated with prolongation of the PR interval, QRS complex, and QT interval progressively.</p>\n<p>With temperature approaching<strong> 86&deg;F</strong>, <strong>atrial ectopic activity</strong> is often noted and can progress to atrial fibrillation. It is at this level of hypothermia that many patients have <strong>Osborn waves</strong> that consist of an extra deflection at the end of the QRS complex.&nbsp;J waves occur when a heterogeneous distribution of potassium current enhances the activity of a transient outward potassium current in the heart, caused by low temperatures.</p>\n<p>Osborn waves, also known as J waves, camel-hump waves, or hypothermic waves, are best seen in the inferior and lateral precordial leads. They become more prominent as the body temperature drops, and they regress gradually with rewarming.</p>\n<p>A progressive widening of the QRS complex occurs when the temperature falls below 86&deg;F, which is associated with an increased risk of ventricular fibrillation and asystole occurs when the temperature drops to about 60&deg;F.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/e224aa9def024a7e92f970b68ece1ce6.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9759e9288cff443c9c7c7f47eb48cc5ax482x442.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e2585b32265f4c10a09df8fb8de3a0f4x800x396.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/7d1e1eb526434febab8be809c93f0338x1158x893.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fa0165e238c64668b95e5cc970686958x378x378.JPEG"
    ]
  },
  {
    "text": "An elderly obese man was brought to casualty with complaints of severe chest pain for the last two hours. He has also had profuse sweating, pain in the left arm, nausea, and one episode of vomiting.  On examination, pulse rate is 58/min and BP is 90/60 mmHg. His ECG is shown below. Cardiac biomarkers showed elevated troponin levels. What is the most likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Anterior wall MI"
      },
      {
        "id": 2,
        "text": "Inferior wall MI"
      },
      {
        "id": 3,
        "text": "Posterior wall MI"
      },
      {
        "id": 4,
        "text": "Pericarditis"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The most likely diagnosis is&nbsp;<strong>inferior wall MI </strong>based&nbsp;on the<strong>&nbsp;</strong>given presentation of <strong>chest pain,&nbsp;bradycardia </strong>(pulse rate 58/min),<strong> hypotension</strong> (BP 90/60 mm Hg)<strong>,&nbsp;elevated cardiac biomarkers, </strong>and<strong>&nbsp;ECG changes </strong>(<strong>ST-segment elevation</strong> in leads&nbsp;<strong>II, III, aVF</strong>, with<strong> reciprocal</strong> change in lead <strong>aVL</strong>).&nbsp;</p>\n<p>Inferior wall MI mainly occurs due to blockage of the <strong>posterior descending branch</strong> of the <strong>right coronary artery.</strong> While anterior infarction shows sympathetic nervous system hyperactivity (tachycardia and hypertension), the inferior wall MI shows parasympathetic hyperactivity (<strong>bradycardia </strong>and&nbsp;<strong>hypotension</strong>).</p>\n<p>The table below gives the localization of MI and probable vessel involved based on ECG findings.</p>\n<table style=\"height: 291px; width: 463.703px;\">\n<thead>\n<tr>\n<td style=\"width: 14px;\">Location of MI</td>\n<td style=\"width: 62px;\">Leads Affected</td>\n<td style=\"width: 139.703px;\">Vessel Involved</td>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"width: 14px;\">Anterior wall</td>\n<td style=\"width: 62px;\">V<sub>2</sub>&nbsp;to V<sub>4</sub></td>\n<td style=\"width: 139.703px;\">Left Anterior Descending artery&nbsp;<br />&ndash; Diagonal branch</td>\n</tr>\n<tr>\n<td style=\"width: 14px;\">Septal wall</td>\n<td style=\"width: 62px;\">V<sub>1</sub>&nbsp;and V<sub>2</sub></td>\n<td style=\"width: 139.703px;\">Left Anterior Descending artery&nbsp;<br />&ndash; Septal branch</td>\n</tr>\n<tr>\n<td style=\"width: 14px;\">Lateral wall</td>\n<td style=\"width: 62px;\">I, aV<sub>L</sub>, V<sub>5</sub>, V<sub>6</sub></td>\n<td style=\"width: 139.703px;\">Left Coronary Artery (LCA)<br />&ndash; Circumflex branch</td>\n</tr>\n<tr>\n<td style=\"width: 14px;\">Inferior wall</td>\n<td style=\"width: 62px;\">II, III, aV<sub>F</sub></td>\n<td style=\"width: 139.703px;\">Right Coronary Artery (RCA)<br />&ndash; Posterior descending branch</td>\n</tr>\n<tr>\n<td style=\"width: 14px;\">Posterior wall</td>\n<td style=\"width: 62px;\">V<sub>1</sub>&nbsp;to V<sub>4</sub></td>\n<td style=\"width: 139.703px;\">Left Coronary Artery (LCA)<br />&ndash; Circumflex branch\n<p>Right Coronary Artery (RCA)<br />&ndash; Posterior descending branch</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>Patients with <strong>pericarditis</strong> also present with severe chest pain and ST-segment elevations. However, this<strong> ST-segment elevation</strong> has <strong>upward concavity</strong>&nbsp;with depression of the PR segment.</p>\n<p>An ECG showing pericarditis is given below.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/74b2c49cf1ab49008b40781f7d4aad04.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/2a10570b6df74845b957b8ff3b836f30x800x446.JPEG"
    ]
  },
  {
    "text": "Sequentially arrange the following changes seen in hyperkalemia in ascending order of the potassium values in which they would be seen.",
    "choices": [
      {
        "id": 1,
        "text": "4-3-2-1"
      },
      {
        "id": 2,
        "text": "1-3-2-4"
      },
      {
        "id": 3,
        "text": "1-2-4-3"
      },
      {
        "id": 4,
        "text": "1-2-3-4"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>The correct sequence of changes is&nbsp;</p>\n<ol>\n<li>Tall peaked T waves&nbsp;</li>\n<li>Loss of P waves</li>\n<li>Widened QRS complex</li>\n<li>Sine wave pattern</li>\n</ol>\n<p><strong>Hyperkalemia</strong> is an increase in the levels of <strong>serum potassium</strong>&nbsp;<strong>&gt;5.5 mM. </strong>It is a medical emergency and has to be treated when ECG changes are present or severe hyperkalemia (serum K &gt;6.5) without ECG changes.&nbsp;&nbsp;<strong>Features</strong> include cardiac arrhythmias which include sinus bradycardia, sinus arrest, ventricular tachycardia, ventricular fibrillation and asystole.</p>\n<p><strong>ECG</strong> shows tall and peaked T waves, widening of QRS complexes, loss of P waves and sine wave pattern.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a6d663a7281c486dbbd20aeda9e60784x1280x1585.JPEG"
    ]
  }
];
        let quizName = 'Ecg Mini Test - -Tmt';
        const quizFilename = 'ecg-mini-test-tmt-b9ec44c1.html';
        let hierarchy = ["Marrow", "NEET PG Mini Test Series", "2023-24"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>