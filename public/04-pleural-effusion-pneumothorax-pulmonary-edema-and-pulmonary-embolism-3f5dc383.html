<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04 Pleural Effusion, Pneumothorax, Pulmonary Edema And Pulmonary Embolism - Brain And Scalpel</title>
    <link rel="preload" href="assets/background.jpg" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HLS.js for M3U8 support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        
/* Liquid Glass Morphism Universal Theme - Enhanced & Mobile-First */
:root {
  --glass-bg: rgba(0, 0, 0, 0.6);
  --glass-bg-light: rgba(255, 255, 255, 0.1);
  --glass-bg-medium: rgba(255, 255, 255, 0.15);
  --glass-bg-heavy: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-border-light: rgba(255, 255, 255, 0.1);
  --text-primary: rgba(255, 255, 255, 0.95);
  --text-secondary: rgba(255, 255, 255, 0.7);
  --text-tertiary: rgba(255, 255, 255, 0.5);
  --accent-blue: #60a5fa;
  --accent-purple: #a855f7;
  --accent-green: #34d399;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --accent-yellow: #fbbf24;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  position: relative;
  overflow-x: hidden;
  color: var(--text-primary);
  background-color: #000;
}

/* iOS Background Fix */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
  z-index: -2;
  background: url("assets/background.jpg") center center / cover no-repeat;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: -1;
}

/* Glass morphism components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-light {
  background: var(--glass-bg-light);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border-light);
  border-radius: 12px;
}

.glass-medium {
  background: var(--glass-bg-medium);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
}

.glass-heavy {
  background: var(--glass-bg-heavy);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
}

.glass-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.glass-card:hover {
  transform: translateY(-8px);
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.glass-button {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(168, 85, 247, 0.8));
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: white;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
  cursor: pointer;
  border: none;
}

.glass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(96, 165, 250, 0.4);
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.9), rgba(168, 85, 247, 0.9));
}

.glass-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.glass-input {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}

.glass-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  background: rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
}

.glass-input::placeholder {
  color: var(--text-tertiary);
}

/* Performance analysis styles */
.performance-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.score-circle {
  position: relative;
  width: 150px;
  height: 150px;
  margin: 0 auto;
}

.score-circle svg {
  transform: rotate(-90deg);
}

.score-circle .circle-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.1);
  stroke-width: 8;
}

.score-circle .circle-progress {
  fill: none;
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dasharray 2s cubic-bezier(0.4, 0, 0.2, 1);
}

.score-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

/* Review question styles */
.review-question {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.review-question.correct {
  border-left: 4px solid #22c55e;
}

.review-question.incorrect {
  border-left: 4px solid #ef4444;
}

.review-question.not-attempted {
  border-left: 4px solid #6b7280;
}

/* Gradient backgrounds for accents */
.gradient-blue {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
}

.gradient-purple {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
}

.gradient-green {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
}

.gradient-orange {
  background: linear-gradient(135deg, var(--accent-orange), #f97316);
}

.gradient-red {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
}

.gradient-yellow {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
}

/* Navigation button styles */
.nav-btn-not-attempted {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.7);
}

.nav-btn-current {
  background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  box-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
}

.nav-btn-correct {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-incorrect {
  background: linear-gradient(135deg, var(--accent-red), #ef4444);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-bookmarked {
  background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-marked-review {
  background: linear-gradient(135deg, var(--accent-purple), #8b5cf6);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

.nav-btn-answered {
  background: linear-gradient(135deg, #6b7280, #4b5563);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
}

/* Option button styles - REVISED FOR INLINE FEEDBACK */
.option-button {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  width: 100%;
  text-align: left;
  padding: 1rem;
  border-radius: 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1rem;
}

.option-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(96, 165, 250, 0.5);
  transform: translateX(8px);
}

.option-button.selected {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(59, 130, 246, 0.3));
  border-color: var(--accent-blue);
  transform: translateX(8px);
}

#optionsContainer.answered .option-button:hover {
    transform: translateX(0); /* Disable hover effect after answering */
}

#optionsContainer.answered .option-button {
    cursor: not-allowed;
    pointer-events: none;
}

#optionsContainer.answered .option-button:not(.correct):not(.incorrect) {
    opacity: 0.5;
}

.option-button.correct {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: #22c55e;
    color: white;
    transform: translateX(0);
}

.option-button.incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: white;
    transform: translateX(0);
}

.option-letter {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: var(--text-primary);
  flex-shrink: 0;
}

.option-button.selected .option-letter {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: white;
}

.option-button.correct .option-letter, .option-button.incorrect .option-letter {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.option-text {
  flex: 1;
  font-size: 1rem;
  line-height: 1.5;
}

/* Stats bar responsive grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  align-items: center;
  justify-items: center;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }
 
  .stats-grid > div:nth-child(4),
  .stats-grid > div:nth-child(5) {
    grid-column: span 1;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
 
  .stats-grid > div:last-child {
    grid-column: span 2;
    justify-self: center;
  }
}

/* Animations */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.3); }
  50% { box-shadow: 0 0 40px rgba(96, 165, 250, 0.6); }
}

@keyframes checkmark {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(180deg); }
  100% { transform: scale(1) rotate(360deg); }
}

@keyframes cross {
  0% { transform: scale(0) rotate(0deg); }
  50% { transform: scale(0.8) rotate(90deg); }
  100% { transform: scale(1) rotate(180deg); }
}

.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-checkmark {
  animation: checkmark 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-cross {
  animation: cross 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* --- MOBILE RESPONSIVE STYLES --- */
.quiz-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#mobile-nav-toggle {
    display: none; /* Hidden on desktop */
}

@media (min-width: 1024px) {
    .quiz-container {
        flex-direction: row;
        gap: 2rem;
    }
}

@media (max-width: 1023px) {
    .quiz-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 10px 0px 30px rgba(0,0,0,0.5);
    }
    .quiz-sidebar.open {
        transform: translateX(0);
    }
    #mobile-nav-toggle {
        display: flex;
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 50;
    }
    .quiz-main-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .glass-card, .glass {
        border-radius: 16px;
    }
    h1 { font-size: 2.5rem; }
    #questionText { font-size: 1.125rem; }
    .controls-container {
        flex-direction: column;
        gap: 1rem;
    }
    .controls-container button {
        width: 100%;
    }
}

    </style>
</head>
<body>
    <!-- Mode Selection Modal -->
    <div id="modeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Choose Study Mode</h2>
            
            <div class="space-y-4">
                <button onclick="selectMode('study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Study Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Interactive learning with immediate feedback</p>
                        </div>
                        <div class="gradient-blue w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('test')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Test Mode</h3>
                            <p class="text-sm text-white text-opacity-70">Practice test with performance analysis at end</p>
                        </div>
                        <div class="gradient-purple w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_study')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Study</h3>
                            <p class="text-sm text-white text-opacity-70">Study with time pressure and immediate feedback</p>
                        </div>
                        <div class="gradient-green w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                
                <button onclick="selectMode('timed_exam')" class="w-full text-left p-4 glass-light hover:bg-white hover:bg-opacity-10 transition-all duration-300 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">Timed Exam</h3>
                            <p class="text-sm text-white text-opacity-70">Real exam simulation with strict timing</p>
                        </div>
                        <div class="gradient-red w-10 h-10 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Analysis Modal -->
    <div id="performanceModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="glass-heavy p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-white">Performance Analysis</h2>
                <button onclick="closePerformanceModal()" class="glass-light p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Score Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="performance-card p-6 text-center">
                    <div class="score-circle mb-4">
                        <svg width="150" height="150" class="mx-auto">
                            <circle class="circle-bg" cx="75" cy="75" r="65"></circle>
                            <circle id="scoreCircle" class="circle-progress" cx="75" cy="75" r="65" stroke="#22c55e" stroke-dasharray="0 408"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="text-3xl font-bold text-white" id="accuracyScore">0%</div>
                            <div class="text-sm text-white text-opacity-70">Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Results Summary</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Questions:</span>
                            <span class="text-white font-semibold" id="totalQuestionsResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400">Correct:</span>
                            <span class="text-green-400 font-semibold" id="correctResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-red-400">Incorrect:</span>
                            <span class="text-red-400 font-semibold" id="incorrectResult">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Not Attempted:</span>
                            <span class="text-gray-400 font-semibold" id="notAttemptedResult">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">Time Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Total Time:</span>
                            <span class="text-white font-semibold" id="totalTimeResult">0:00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white text-opacity-70">Avg per Question:</span>
                            <span class="text-white font-semibold" id="avgTimeResult">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 mb-8">
                <button onclick="reviewQuestions()" class="glass-button px-8 py-3 text-lg">
                    Review All Questions
                </button>
                <button onclick="retakeQuiz()" class="glass-light px-8 py-3 text-lg text-white hover:bg-white hover:bg-opacity-20">
                    Retake Quiz
                </button>
            </div>
            
            <!-- Question Review Section -->
            <div id="questionReviewSection" class="hidden">
                <h3 class="text-2xl font-bold text-white mb-6">Question Review</h3>
                <div id="reviewQuestionsContainer">
                    <!-- Review questions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 mb-6">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="glass-light px-4 py-2 text-white hover:bg-white hover:bg-opacity-20 transition-all duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Back
                    </button>
                    <div id="quizHierarchy" class="text-sm text-white text-opacity-60">
                        Marrow / qBank / Radiology
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="glass-light px-3 py-1 text-sm text-white">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">21</span>
                    </div>
                    
                    <!-- Timer -->
                    <div id="timerContainer" class="hidden gradient-red px-3 py-1 text-sm text-white font-bold animate-pulse-glow">
                        <span id="timeDisplay">2:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-1 bg-black bg-opacity-30 mb-6">
        <div id="progressBar" class="h-1 gradient-blue transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Stats Bar - Show only in study modes -->
    <div id="statsBar" class="glass-light mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="stats-grid">
                <div class="text-center">
                    <div class="text-lg font-bold text-green-400" id="correctCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Correct</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-red-400" id="incorrectCount">0</div>
                    <div class="text-xs text-white text-opacity-60">Incorrect</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-blue-400" id="totalAttempted">0</div>
                    <div class="text-xs text-white text-opacity-60">Attempted</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-purple-400" id="accuracy">0%</div>
                    <div class="text-xs text-white text-opacity-60">Accuracy</div>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold text-orange-400" id="timeSpent">0:00</div>
                    <div class="text-xs text-white text-opacity-60">Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="quiz-container container mx-auto px-6">
        <!-- Question Navigation Sidebar -->
        <div id="quizSidebar" class="quiz-sidebar glass p-6 h-fit lg:sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4">Question Navigator</h3>
            <div id="questionNav" class="grid grid-cols-5 gap-2 mb-6">
                <!-- Question numbers will be populated here -->
            </div>
            
            <div class="space-y-3 text-xs">
                <h4 class="text-sm font-medium text-white text-opacity-80 mb-3">Legend</h4>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-not-attempted rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Not Attempted</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-current rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Current</span>
                </div>
                <div id="studyModeLegend" class="space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-correct rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Correct</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-incorrect rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Incorrect</span>
                    </div>
                </div>
                <div id="testModeLegend" class="hidden space-y-2">
                    <div class="flex items-center">
                        <div class="w-6 h-6 nav-btn-answered rounded mr-2"></div>
                        <span class="text-white text-opacity-60">Answered</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 nav-btn-bookmarked rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Bookmarked</span>
                </div>
                <div id="testModeReviewLegend" class="hidden items-center">
                    <div class="w-6 h-6 nav-btn-marked-review rounded mr-2"></div>
                    <span class="text-white text-opacity-60">Marked for Review</span>
                </div>
            </div>
            
            <!-- Submit Quiz Button for test modes -->
            <div id="submitSection" class="hidden mt-6">
                <button onclick="submitQuiz()" class="glass-button w-full py-3 text-lg font-bold">
                    Submit Quiz
                </button>
            </div>
        </div>

        <!-- Main Quiz Interface -->
        <div class="quiz-main-content flex-1 max-w-4xl">
            <div class="glass-card p-4 md:p-8 lg:p-12 mb-8 relative">
                <!-- Question Text -->
                <div id="questionText" class="text-xl lg:text-2xl leading-relaxed text-white mb-8">
                    Loading question...
                </div>

                <!-- Question Media -->
                <div id="questionMedia" class="mb-8"></div>

                <!-- Options -->
                <div id="optionsContainer" class="space-y-3 mb-8">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Solution Display (only for study modes) -->
                <div id="solutionContainer" class="hidden glass-light p-6 border-l-4 border-green-400">
                    <h3 class="text-lg font-bold text-green-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        Explanation
                    </h3>
                    <div id="solutionText" class="text-white text-opacity-90 leading-relaxed mb-4"></div>
                    <div id="solutionAudio" class="space-y-2 mt-4"></div>
                    <div id="solutionImages" class="space-y-4 mt-4"></div>
                    <div id="solutionVideo" class="hidden mt-4">
                        <video id="explanationVideoPlayer" class="w-full rounded-lg" controls>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls-container flex justify-between items-center mb-8">
                <button onclick="previousQuestion()" id="prevBtn" class="glass-button px-6 py-3 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Previous
                </button>
                
                <div class="flex justify-center flex-grow">
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" id="bookmarkIcon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
                        </svg>
                        <span id="bookmarkText">Bookmark</span>
                    </button>
                    
                    <button onclick="toggleMarkForReview()" id="markReviewBtn" class="hidden glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                           <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v12H5V4z" clip-rule="evenodd" />
                           <path d="M12.586 6.586a2 2 0 10-2.828 2.828l-3 3a2 2 0 102.828-2.828l3-3z" />
                        </svg>
                        <span id="markReviewText">Mark for Review</span>
                    </button>
                </div>
                
                <button onclick="nextQuestion()" class="glass-button px-6 py-3 flex items-center justify-center">
                    Next
                    <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

     <!-- Mobile Nav Toggle -->
    <button id="mobile-nav-toggle" onclick="toggleSidebar()" class="glass-button w-14 h-14 rounded-full items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>


    <script>
        let questionsData = [
  {
    "text": "Chest X-ray is most commonly performed in which of the following views?",
    "choices": [
      {
        "id": 1,
        "text": "PA view"
      },
      {
        "id": 2,
        "text": "AP view"
      },
      {
        "id": 3,
        "text": "Lateral view"
      },
      {
        "id": 4,
        "text": "Oblique view"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Chest X-ray</strong> is most commonly performed in <strong>posteroanterior view (PA view)</strong> because it minimizes the magnification of the cardiac silhouette.\u00a0</p>\n<p>In PA view, the anterior structures are closer to the detector. It is usually done in <strong>full inspiration</strong> and <strong>standing</strong> position. Ideally, there should be <strong>no rotation.</strong> If there is no rotation the distance between the medial end of the clavicle and the spinous process will be equidistant, on both sides. In a normal chest X-ray, the left dome of the diaphragm is <strong>lower</strong> than the right because the heart pushes the left dome down.</p>\n<p>In anterior-to-posterior (<strong>AP</strong>) radiographs, the posterior structures are closer to the detector. \u00a0</p>\n<p>Identification of PA and AP view chest X-ray:</p>\n<table style=\"width: 415px;\">\n<tbody>\n<tr>\n<td style=\"width: 67px;\">\u00a0</td>\n<td style=\"width: 157.438px;\"><strong>PA view</strong></td>\n<td style=\"width: 202.562px;\"><strong>AP view</strong></td>\n</tr>\n<tr>\n<td style=\"width: 67px;\"><strong>Clavicles</strong></td>\n<td style=\"width: 157.438px;\">Seen over the lung fields</td>\n<td style=\"width: 202.562px;\">Seen above the apex of lung fields</td>\n</tr>\n<tr>\n<td style=\"width: 67px;\"><strong>Scapula</strong></td>\n<td style=\"width: 157.438px;\">The inner border is seen away from lung fields</td>\n<td style=\"width: 202.562px;\">The inner border is seen over the lung fields</td>\n</tr>\n<tr>\n<td style=\"width: 67px;\"><strong>Ribs</strong></td>\n<td style=\"width: 157.438px;\">Posterior ribs are more visible</td>\n<td style=\"width: 202.562px;\">Anterior ribs are more visible</td>\n</tr>\n</tbody>\n</table>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/85979d375fde4f0f9adc9d4555cb5988x1280x1339.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6612073a7cc54d9d92bad4fa1de9e8d6x1280x1363.JPEG"
    ]
  },
  {
    "text": "What is the best chest X-ray view to visualise the right lung?",
    "choices": [
      {
        "id": 1,
        "text": "Right anterior oblique"
      },
      {
        "id": 2,
        "text": "Left anterior oblique"
      },
      {
        "id": 3,
        "text": "Right posterior oblique"
      },
      {
        "id": 4,
        "text": "Left posterior oblique"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The best view to visualize the <strong>right lung</strong> is the <strong>left anterior oblique.</strong> For the left lung, it is the right anterior oblique.&nbsp;</p>\n<p>The <strong>left anterior oblique</strong> view demonstrates the maximum area of the<strong> right lung field</strong>. It is also used for the assessment of both the&nbsp;<strong>ventricles</strong>,<strong> left atrium</strong>, aortic window, and <strong>aorta</strong>.</p>\n<p>The <strong>right anterior oblique</strong> view demonstrates the maximum area of the<strong> left lung field</strong>. It is used for the assessment of the <strong>pulmonary artery</strong>, <strong>right ventricle</strong>, and <strong>right atrium</strong></p>\n<p>Both these views are also used in coronary angiography.</p>\n<p>The image below shows the right anterior oblique (image 1) and the left anterior oblique (image 2) views of chest radiograph:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/908464067c7943a6bb26f96c3652de68x1280x806.JPEG"
    ]
  },
  {
    "text": "What is the best view to visualise middle lobe pathologies?",
    "choices": [
      {
        "id": 1,
        "text": "Left anterior oblique"
      },
      {
        "id": 2,
        "text": "PA view"
      },
      {
        "id": 3,
        "text": "Lordotic view"
      },
      {
        "id": 4,
        "text": "Oblique view"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>\u00a0</p>\n<p>The <strong>lordotic AP projection </strong>brings the displaced fissure into the<strong> </strong>line of the x-ray and elegantly demonstrates the <strong>middle lobe pathologies</strong>.\u00a0The lordotic view is suitable in apical lung pathologies and middle lobe or lingula pathology.\u00a0</p>\n<p>The image depicts a normal X-ray chest in lordotic view:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/013bd21e31044fec93b3b3f071ead8dbx1280x1465.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/5626df0a00d94e7186b4d1bbcc444063x1280x1054.JPEG"
    ]
  },
  {
    "text": "Which of the following structures do not form the hilar shadow in a chest X-ray?",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary artery"
      },
      {
        "id": 2,
        "text": "Bronchus"
      },
      {
        "id": 3,
        "text": "Lower lobe veins"
      },
      {
        "id": 4,
        "text": "Upper lobe veins"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p><strong>Lower lobe veins</strong> are not part of the radiological hilum.</p>\n<p>The radiological hilum is formed by the <strong>pulmonary arteries</strong> (and their bifurcations), the <strong>upper lobe veins</strong>, and the<strong> bronchi.</strong> The lower lobe pulmonary veins, which pass inferiorly, form no component of the normal hilar shadow. Lymph nodes only contribute to the shadow when enlarged.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "A 25-year-old male with Marfanoid features presented with sudden onset breathlessness. The chest X-ray is given below. What is the likely diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pneumothorax"
      },
      {
        "id": 2,
        "text": "Pleural effusion"
      },
      {
        "id": 3,
        "text": "Consolidation"
      },
      {
        "id": 4,
        "text": "Fibrosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>When there is a progressive accumulation of air intrapleurally in the thoracic cavity (caused by a valve effect during inspiration and expiration), it is called <strong>Tension pneumothorax</strong>. It can result in compression of mediastinal structures and compromise cardiopulmonary function. It is <strong>life-threatening</strong> and requires emergency intervention.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/cea5bf53bb95469c8fbb2f9abe7d4dbb.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8ee5055876e24b769bd3024f9a6eeba5x720x663.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/9502666a59f747688d61e9ca1a5f4379x1224x1200.JPEG"
    ]
  },
  {
    "text": "A 62-year-old male with COPD presents with sudden onset chest pain and shortness of breath. On auscultation, breath sounds were absent on the left side. What is the best chest x-ray view to diagnose this condition?",
    "choices": [
      {
        "id": 1,
        "text": "PA view in full inspiration"
      },
      {
        "id": 2,
        "text": "PA view in full expiration"
      },
      {
        "id": 3,
        "text": "AP view in full inspiration"
      },
      {
        "id": 4,
        "text": "AP view in full expiration"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>The patient most likely has<strong> pneumothorax. </strong>The best chest x-ray view to diagnose a pneumothorax is<strong> PA view</strong> <strong>in full expiration</strong>.</p>\n<p><strong>Expiratory chest X-ray</strong> is done in pneumothorax, conditions causing air trapping (foreign body, partial bronchial obstruction), and diaphragmatic palsy.\u00a0</p>\n<p>Image showing left-sided pneumothorax:\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/15974567f2ea48f8bd0500dc63f00123x877x807.JPEG"
    ]
  },
  {
    "text": "All of the following features can be seen in patients with pneumothorax except:",
    "choices": [
      {
        "id": 1,
        "text": "Deep sulcus sign"
      },
      {
        "id": 2,
        "text": "Mediastinal shift to the ipsilateral side"
      },
      {
        "id": 3,
        "text": "Area of hypertranslucency on the ipsilateral side"
      },
      {
        "id": 4,
        "text": "Collapse of ipsilateral lung"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>In pneumothorax, especially tension pneumothorax there is a<strong> mediastinal shift</strong> <strong>to the</strong> <strong>contralateral\u00a0</strong><strong>side</strong> of the pneumothorax, <strong>not to the ipsilateral side</strong>.\u00a0\u00a0</p>\n<p>Chest radiograph in spontaneous pneumothorax demonstrates:\u00a0\u00a0</p>\n<ul>\n<li>A rim of hyperlucent area (dark area <strong>without lung markings</strong>) is seen between the lung margin and chest wall\u00a0</li>\n<li>Inwardly shifted visceral pleural line (thin, sharp white line)</li>\n<li><strong>Deep sulcus sign</strong>: Deep lateral costophrenic angle can be seen in a <strong>supine X-ray</strong></li>\n<li>Depression of the diaphragm, rib cage expansion, and <strong>mediastinal</strong> <strong>shift to the contralateral side</strong> - indicates tension pneumothorax</li>\n</ul>\n<p>The image below shows a <strong>right pneumothorax</strong>\u00a0with <strong>total</strong> right lung collapse and tracheal deviation to the left.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b1e1c2975a9d4dacbc69a0d672394292x597x600.PNG"
    ]
  },
  {
    "text": "The given USG of lung shows:",
    "choices": [
      {
        "id": 1,
        "text": "Stratosphere sign"
      },
      {
        "id": 2,
        "text": "Sea shore sign"
      },
      {
        "id": 3,
        "text": "Troposphere sign"
      },
      {
        "id": 4,
        "text": "Mirror image artifact"
      }
    ],
    "correct_choice_id": 2,
    "solution": "<p>Option C: There is no named sign called troposphere sign.</p>\n<p>Option D: <strong>Mirror image artifact\u00a0</strong>is seen when there is a highly reflective surface (eg: diaphragm) is in the path of the primary beam.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/ad556c7ce01d44e799c614fa4eb260ad.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/50c0b518254e4f9f94097f851896d826x1280x1064.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/27f7b0e0e97f49cd8e2ad84b49d049a2x1280x1064.JPEG"
    ]
  },
  {
    "text": "A 42-year-old man is brought to the emergency department with complaints of right-sided chest pain after a motor vehicle collision. Physical examination revealed bilateral breath sounds and a supine chest radiograph was unremarkable. On performing an ultrasound the following was seen. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pneumothorax"
      },
      {
        "id": 2,
        "text": "Pleural effusion"
      },
      {
        "id": 3,
        "text": "Consolidation"
      },
      {
        "id": 4,
        "text": "Collapse"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Supine chest radiography </strong>has <strong>low sensitivity</strong> for traumatic pneumothorax. <strong>Thoracic ultrasound</strong> has <strong>high sensitivity</strong> and specificity for the detection of small or occult pneumothorax in critical care patients.</p>\n<p>Other options:</p>\n<p>Option B: <strong>Pleural effusion </strong>on ultrasound appears anechoic with an echogenic line at the fluid-lung interface if it is transudate. Exudative and hemorrhagic effusions may appear echogenic with pleural thickening. The fluid shows movement and changes in shape with breathing, along with the presence of septa and fibrous strands.</p>\n<p>Option C: <strong>Consolidation</strong> on ultrasound appears hypoechoic with heterogeneous echotexture. It is isoechoic with the liver and is referred to as lung hepatization.\u00a0</p>\n<p>Option D: A <strong>collapsed lung</strong> under a large effusion will be seen as a hyperechoic wedge-shaped area.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/203794b90ce3451387ddce5b845b977e.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/057c6a0707744d58bf851e2e29137bb9x1279x1522.JPEG"
    ]
  },
  {
    "text": "A term neonate born by vacuum-assisted delivery developed mild respiratory distress 1 hour after birth. Arterial oxygen saturation remained > 95% without supplemental oxygen. Chest radiography performed 6 hours after birth is given below. What is the diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Pneumomediastinum"
      },
      {
        "id": 2,
        "text": "Pneumothorax"
      },
      {
        "id": 3,
        "text": "Pneumoperitoneum"
      },
      {
        "id": 4,
        "text": "Consolidation"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The image given below shows <strong>continuous diaphragm sign.</strong></p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/5794398e8f584aa19204408c1b8a7d1c.PNG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/e0065750e66e4060b7ddcb21b26ea36ex510x500.GIF",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/6fd1579450de416b89ffb8d2a7866a8dx1280x1140.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/8d7e8414a3d74f578f8a7e9556f5c5bfx481x452.JPEG"
    ]
  },
  {
    "text": "A patient presented with pleuritic chest pain and absent breath sounds on the right side. A pleural effusion is suspected. What is the best chest x-ray view to diagnose this condition?",
    "choices": [
      {
        "id": 1,
        "text": "PA view"
      },
      {
        "id": 2,
        "text": "Right anterior oblique"
      },
      {
        "id": 3,
        "text": "Left anterior oblique"
      },
      {
        "id": 4,
        "text": "Lateral decubitus view"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Marking A shows fluid</strong> layering in the right pleural cavity. <strong>Marking</strong>\u00a0<strong>B shows the normal width of the lung</strong> in the cavity. The amount of pleural fluid can be approximately quantified by measuring the distance A.</p>\n<p>Best investigation for minimal pleural effusion is <strong>USG.</strong></p>\n<p>The minimal amount of fluid required to be detected on X-ray imaging for pleural effusion:</p>\n<ul>\n<li>Lateral (erect) view : <strong>75 ml</strong> pleural fluid</li>\n<li>Erect PA view : <strong>200 ml</strong> pleural fluid</li>\n<li>Lateral decubitus view\u00a0 : <strong>&lt;25 ml</strong> pleural fluid</li>\n</ul>\n<p>The image below is a chest X-ray PA view showing\u00a0<strong>pleural effusion</strong>\u00a0with<strong> Ellis-S curve.</strong></p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/a54cce0babb747c3a9d18ce12dd916f3x1280x1103.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ad5f2dd38b3a470998db1567823ff0d5x1030x871.PNG"
    ]
  },
  {
    "text": "A 30-year-old man presented with a history of fever and chest pain for the last 7 days. A chest X-ray was done. What is the probable diagnosis?",
    "choices": [
      {
        "id": 1,
        "text": "Loculated pleural effusion"
      },
      {
        "id": 2,
        "text": "Pneumothorax"
      },
      {
        "id": 3,
        "text": "Consolidation"
      },
      {
        "id": 4,
        "text": "Fibrosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>The above clinical scenario and X-ray is suggestive of <strong>loculated pleural effusion</strong>.</p>\n<p>The chest X-ray shows <strong>obliteration </strong>of <strong>right costophrenic angle</strong> with a wide pleural-based dome-shaped opacity projecting into the lung. It tracks along the costphrenic angle and lateral chest wall.</p>\n<p>A pleural lesion can be differentiated from a parenchymal lesion by the angle it makes with the chest wall. <strong>Pleural lesions</strong> makes an <strong>obtuse angle</strong> with the chest wall whereas a <strong>parenchymal lesions</strong>\u00a0makes an <strong>acute angle</strong> with the chest wall.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/b1f07eb0f90d413ab544769de70084c2.JPEG"
    ],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/16b5b0da389146fa8e355cf6db27d282x1055x827.JPEG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/0dd63f00a08a448abc7c6a490a5381d8x1280x1090.PNG"
    ]
  },
  {
    "text": "Split pleura sign is seen in:",
    "choices": [
      {
        "id": 1,
        "text": "Pneumothorax"
      },
      {
        "id": 2,
        "text": "Pleural effusion"
      },
      {
        "id": 3,
        "text": "Empyema"
      },
      {
        "id": 4,
        "text": "Hydropneumothorax"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>A<strong> </strong>split pleura sign is seen in<strong> empyema</strong>.\u00a0</p>\n<p>Empyema is defined as a collection of pus in the pleural cavity. It is usually associated with pneumonia but may also develop after thoracic surgery or trauma.</p>\n<p>A hallmark feature of empyema on CT imaging is the <strong>split pleura sign</strong>, where the pleura divides into the parietal and visceral layers. This sign is considered the <strong>most sensitive</strong> and <strong>specific</strong> indicator of empyema on CT, helping to distinguish it from peripheral lung abscess.</p>\n<p>CT scan showing split pleura sign:\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/fc1381024116410fb4db78c030e1298ax511x196.PNG"
    ]
  },
  {
    "text": "The chest radiograph of a patient showed silhouetting of the left border of the heart. Pathology of which part of the lung does this indicate?",
    "choices": [
      {
        "id": 1,
        "text": "Right lower lobe"
      },
      {
        "id": 2,
        "text": "Hilar"
      },
      {
        "id": 3,
        "text": "Apex of left lower lobe"
      },
      {
        "id": 4,
        "text": "Lingula"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p><strong>Silhouetting</strong> of the<strong> left border</strong> of the heart indicates a pathology in the <strong>lingula </strong>segments.\u00a0</p>\n<p>The principle of silhouette sign is that the <strong>mediastinal borders</strong> can be <strong>obscured </strong>only by a <strong>pathology</strong> that is in <strong>direct anatomical contact</strong>.\u00a0</p>\n<p>Positive silhouette sign and corresponding anatomical site of pathology:</p>\n<ul>\n<li><strong>Right heart border- </strong>right middle lobe or medial right lower lobe</li>\n<li><strong>Left heart border - </strong>lingula segments of the left upper lobe</li>\n<li>Left hemidiaphragm or descending aorta - left lower lobe</li>\n<li><strong>Aortic knuckle - </strong>left upper lobe (posterior segment)</li>\n<li>Right hemidiaphragm - right lower lobe</li>\n<li>Right paratracheal stripe - right upper lobe</li>\n</ul>\n<p>Recognition of this sign is useful in localising areas of airspace opacities, atelectasis, or mass within the lung.</p>\n<p>The radiograph below shows the silhouette sign- the left cardiac border is obscured due to pneumonia of the lingula of the left lung.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/b7612ba8ff48480a95b26971b830974ex805x740.JPEG"
    ]
  },
  {
    "text": "In which of the following conditions will you not see an air bronchogram?",
    "choices": [
      {
        "id": 1,
        "text": "Consolidation"
      },
      {
        "id": 2,
        "text": "Pulmonary oedema"
      },
      {
        "id": 3,
        "text": "Pleural effusion"
      },
      {
        "id": 4,
        "text": "Hyaline membrane disease"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>CT showing consolidation with air bronchograms:</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/bbca903eee554c518f34cd9b438bde3ax646x516.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/f58d9fad87d24bc08447dd227623867ex600x600.JPEG"
    ]
  },
  {
    "text": "In which of the following conditions is pleural calcification least likely to be seen?",
    "choices": [
      {
        "id": 1,
        "text": "Asbestosis"
      },
      {
        "id": 2,
        "text": "Hemothorax"
      },
      {
        "id": 3,
        "text": "Healed empyema"
      },
      {
        "id": 4,
        "text": "Sarcoidosis"
      }
    ],
    "correct_choice_id": 4,
    "solution": "<p>Pleural calcification is <strong>least likely</strong> to be seen\u00a0in <strong>sarcoidosis,</strong> as it is extremely rare, distinguishing it from other conditions like asbestosis, hemothorax and empyema where calcifications are<strong> </strong>more commonly observed.\u00a0</p>\n<p>Sarcoidosis is a multisystem disease characterised by non-caseating granulomas, most commonly affecting the lung parenchyma and lymph nodes. Pleural involvement in sarcoidosis is rare and typically presents as pleural effusion, thickening and nodules. <strong>Lymph node calcification</strong> in sarcoidosis may have a stippled and eggshell appearance.</p>\n<p>Conditions showing <strong>pleural calcification</strong>:</p>\n<ul>\n<li><strong>Asbestosis</strong></li>\n<li><strong>Haemothorax</strong></li>\n<li>Pyothorax/<strong>empyema</strong></li>\n<li>Tuberculosis</li>\n<li>Previous surgery\u00a0</li>\n<li>Radiation therapy\u00a0</li>\n</ul>\n<p>Difference between pleural calcification in asbestosis and empyema:</p>\n<table style=\"width: 317px;\">\n<tbody>\n<tr>\n<td style=\"width: 119.141px;\"><strong>Asbestosis</strong></td>\n<td style=\"width: 169.266px;\"><strong>Empyema &amp; hemothorax</strong></td>\n</tr>\n<tr>\n<td style=\"width: 119.141px;\">Calcification occurs as more discrete collections within plaques</td>\n<td style=\"width: 169.266px;\">\n<p>Calcification is irregular and resembles a plaque or sheet</p>\n<p>It is contained within thickened pleura</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 119.141px;\">It is usually bilateral</td>\n<td style=\"width: 169.266px;\">\n<p>Most common in the lower posterior half of the chest</p>\n<p>Usually unilateral</p>\n</td>\n</tr>\n</tbody>\n</table>\n<p>The chest radiograph below shows extensive sheet-like calcification of the right pleura and a smaller localised calcification of the left pleura.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c50e14e0e2754c7ca8d0285b3988ab91x847x1119.JPEG"
    ]
  },
  {
    "text": "A 65-year-old man presents with complaints of sudden onset pleuritic chest pain and dyspnea. He had arrived from an international trip three days ago. A chest x-ray was done. What is this finding called?",
    "choices": [
      {
        "id": 1,
        "text": "Westermark sign"
      },
      {
        "id": 2,
        "text": "McConell's sign"
      },
      {
        "id": 3,
        "text": "Palla's sign"
      },
      {
        "id": 4,
        "text": "Sausage sign"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>In\u00a0the above clinical scenario, chest pain and dyspnea after air travel most likely points to a diagnosis of\u00a0<strong>pulmonary embolism</strong>.\u00a0<strong>Westermark sign\u00a0</strong>is seen in the given chest x-ray.</p>\n<p>It is defined by a <strong>hyper-lucent area</strong> with <strong>decreased vascularity</strong> due to reduced blood supply to the involved part of the lung.</p>\n<p>Even though characteristic signs are seen on chest x-ray, it is neither sensitive nor specific for pulmonary embolism. <strong>CT pulmonary angiography</strong> (CTPA) is the investigation of choice in pulmonary embolism.</p>",
    "explanation_video": "",
    "question_images": [
      "https://cdn1.dailyrounds.org/uploads/6906896e91c84d6ebb9d045f34b22789.JPEG"
    ],
    "explanation_images": []
  },
  {
    "text": "In which of the following patients, hypertranslucent lungs is not seen on chest X-ray?",
    "choices": [
      {
        "id": 1,
        "text": "Middle aged man with Macleod syndrome"
      },
      {
        "id": 2,
        "text": "Smoker with emphysema"
      },
      {
        "id": 3,
        "text": "Patient who has undergone pneumonectomy"
      },
      {
        "id": 4,
        "text": "Teenager with Poland syndrome"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>Pneumonectomy causes<strong> </strong>opacification of hemithorax, <strong>not\u00a0hypertranslucency.</strong></p>\n<p>Causes for <strong>hypertranslucency/hypertransradiancy </strong>of\u00a0hemithorax:</p>\n<ul>\n<li>Increased rotation while taking chest X-ray (most common)</li>\n<li>Scoliosis</li>\n<li>Poliomyelitis</li>\n<li>Mastectomy</li>\n<li>Pneumothorax</li>\n<li><strong>Emphysema</strong></li>\n<li><strong>Macleod syndrome</strong> (a complication of bronchiolitis characterized by a reduction in the pulmonary vasculature and alveolar hyperdistention)</li>\n<li><strong>Poland syndrome</strong> (unilateral absence of pectoralis major +/- other chest muscles)</li>\n<li>Pulmonary embolism</li>\n</ul>\n<p>Causes of <strong>opacification</strong> of a hemithorax:</p>\n<ul>\n<li><strong>Pneumonectomy</strong></li>\n<li>Pleural effusion</li>\n<li>Consolidation</li>\n<li>Collapse</li>\n<li>Massive tumour</li>\n<li>Fibrothorax</li>\n<li>Lung agenesis</li>\n</ul>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  },
  {
    "text": "Which of the following statements is true regarding Kerley A lines?",
    "choices": [
      {
        "id": 1,
        "text": "Radiate from the hilum of lungs"
      },
      {
        "id": 2,
        "text": "Runs perpendicular to the pleural surface and extend out to it"
      },
      {
        "id": 3,
        "text": "Has spider web appearance"
      },
      {
        "id": 4,
        "text": "Short lines which do not reach the pleura"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p>Types of Kerley lines: \u00a0</p>\n<ul>\n<li><strong>Kerley A lines:</strong>\n<ul>\n<li>Thin, oblique lines(2-6cm long and thickness under 1mm), <strong>radiating from the hilum to the upper lobes.\u00a0</strong></li>\n<li><strong>HRCT</strong> is the most effective imaging technique to identify these lines.\u00a0</li>\n</ul>\n</li>\n<li><strong>Kerley B lines:</strong>\n<ul>\n<li>Thin, horizontal lines (1-2 cm long), seen at the lung periphery, usually near the bases.\u00a0</li>\n<li>Run <strong>perpendicular to the pleural surface and reach it</strong>, representing thickened subpleural interlobular septa.</li>\n</ul>\n</li>\n<li><strong>Kerley C lines</strong>\u00a0:\n<ul>\n<li>Short, irregular lines with a spider web-like appearance.\u00a0</li>\n<li>Unlike Kerley B and D lines, they do not extend to the pleura; unlike Kerley A lines, they do not radiate outward from the hila.</li>\n</ul>\n</li>\n<li><strong>Kerley D lines - </strong>the same as Kerley B lines, except that they are seen on lateral chest radiographs in the retrosternal air gap</li>\n</ul>\n<p>The image below depicts the <strong>Kerley B line</strong>, perpendicular to the pleural surface:\u00a0</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/126901b9554746708f558cb873515c5dx742x1024.JPEG"
    ]
  },
  {
    "text": "Bat-wing appearance is seen in:",
    "choices": [
      {
        "id": 1,
        "text": "Pulmonary oedema"
      },
      {
        "id": 2,
        "text": "Pulmonary embolism"
      },
      {
        "id": 3,
        "text": "Pneumoconiosis"
      },
      {
        "id": 4,
        "text": "Sarcoidosis"
      }
    ],
    "correct_choice_id": 1,
    "solution": "<p><strong>Pulmonary oedema </strong>is defined as an abnormal <strong>accumulation of fluid</strong> in the <strong>extravascular compartments </strong>of the lung.</p>\n<p>Features of <strong>pulmonary interstitial oedema </strong>-</p>\n<ul>\n<li>Peri-bronchial cuffing\u00a0and perihilar haze</li>\n<li>Septal lines /\u00a0<strong>Kerley lines</strong></li>\n<li>Thickening of interlobar fissures</li>\n<li>Pulmonary venous engorgement -\u00a0<strong>stag's antler sign</strong></li>\n<li>Airspace opacification\u00a0classically in a<strong>\u00a0</strong>batwing distribution</li>\n<li>May have<strong>\u00a0</strong>air bronchograms</li>\n<li>Pleural effusions\u00a0and fluid in interlobar fissures (including <strong>'vanishing'\u00a0pulmonary pseudotumour</strong>)</li>\n<li>Increased\u00a0cardio-thoracic ratio\u00a0/ cardiac silhouette size (assessing for an underlying cardiogenic cause)</li>\n</ul>\n<p>The image below is a chest X-ray showing thickened interlobular septa (Kerley B) at the base of the right lower lobe, bronchial wall thickening (cuffing), overall distended veins, and a small pleural effusion with fluid in the interlobar fissures.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": [
      "https://dhmbxeygs57ff.cloudfront.net/uploads/ef6ca27563a844bbbf5413662290a83ax512x373.PNG",
      "https://dhmbxeygs57ff.cloudfront.net/uploads/c8d92a9ec32a4aabb8a0256f36aad519x1280x1284.JPEG"
    ]
  },
  {
    "text": "Which lung segment is most commonly sequestered?",
    "choices": [
      {
        "id": 1,
        "text": "Apical segment of right upper lobe"
      },
      {
        "id": 2,
        "text": "Apical segment of left upper lobe"
      },
      {
        "id": 3,
        "text": "Posterobasal segment of left lower lobe"
      },
      {
        "id": 4,
        "text": "Posterobasal segment of right lower lobe"
      }
    ],
    "correct_choice_id": 3,
    "solution": "<p>The lung segment most commonly sequestered is the <strong>posterobasal segment of the left lower lobe.</strong>\u00a0The majority of the sequestrations are located in left lower lobe.</p>\n<p>Pulmonary sequestration is a bronchopulmonary foregut malformation in which a segment or lobe of<strong> dysplastic lung </strong>tissue is <strong>disconnected</strong> from the rest of the tracheobronchial tree or pulmonary arteries. It receives an <strong>anomalous</strong>\u00a0vascular supply. It is a<strong> non-functional tissue</strong>.</p>",
    "explanation_video": "",
    "question_images": [],
    "explanation_images": []
  }
];
        let quizName = '04 Pleural Effusion, Pneumothorax, Pulmonary Edema And Pulmonary Embolism';
        const quizFilename = '04-pleural-effusion-pneumothorax-pulmonary-edema-and-pulmonary-embolism-3f5dc383.html';
        let hierarchy = ["Marrow", "qBank", "Radiology"];
        
        // Handle Custom Quiz Loading
        if (window.location.pathname.endsWith('custom_quiz.html')) {
            const customData = JSON.parse(localStorage.getItem('customQuizData'));
            if (customData) {
                questionsData = customData.questions;
                quizName = customData.name;
                hierarchy = customData.hierarchy;
                document.title = quizName + ' - Brain And Scalpel';
                document.getElementById('totalQuestions').textContent = questionsData.length;
                document.getElementById('quizHierarchy').textContent = hierarchy.join(' > ');
            }
        }

        let currentQuestionIndex = 0;
        let selectedOption = null;
        let currentMode = 'study';
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = Date.now();
        let quizStartTime = Date.now();
        let isQuizCompleted = false;
        
        let questionStates = new Array(questionsData.length).fill(null).map(() => ({
            status: 'not_attempted',
            bookmarked: false,
            markedForReview: false,
            selectedAnswer: null,
            timeSpent: 0
        }));
        
        let stats = {
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalAttempted: 0,
            totalTime: 0,
            notAttempted: questionsData.length
        };

        // --- NEW: History Management ---
        function saveProgress() {
            if (isQuizCompleted) return; // Don't save after completion
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            userHistory[quizFilename] = {
                questionStates,
                stats,
                currentQuestionIndex,
                currentMode,
                status: 'incomplete',
                lastSeen: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }

        function loadProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const savedState = userHistory[quizFilename];
            if (savedState) {
                questionStates = savedState.questionStates;
                stats = savedState.stats;
                currentQuestionIndex = savedState.currentQuestionIndex;
                currentMode = savedState.currentMode;
                console.log('Progress loaded.');
                return true;
            }
            return false;
        }

        function clearProgress() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            if(userHistory[quizFilename]) {
                delete userHistory[quizFilename];
                localStorage.setItem('userHistory', JSON.stringify(userHistory));
                console.log('Previous progress cleared.');
            }
        }

        function markQuizAsCompleted() {
            const userHistory = JSON.parse(localStorage.getItem('userHistory')) || {};
            const totalQuestions = questionsData.length;
            const correct = stats.correctAnswers || 0;
            
            userHistory[quizFilename] = {
                score: correct,
                total: totalQuestions,
                status: 'completed',
                completedOn: new Date().toISOString()
            };
            localStorage.setItem('userHistory', JSON.stringify(userHistory));
        }
        // --- End of History Management ---

        const urlParams = new URLSearchParams(window.location.search);
        const startAt = parseInt(urlParams.get('startAt'));
        const resume = urlParams.get('resume') === 'true';

        function goBack() {
            if (!isQuizCompleted) saveProgress(); // Save progress before leaving
            window.location.href = document.referrer || 'index.html';
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeModal').style.display = 'none';
            initializeQuiz();
        }

        function initializeQuiz() {
            quizStartTime = Date.now();
            
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const testModeReviewLegend = document.getElementById('testModeReviewLegend');
            const isTestMode = currentMode === 'test' || currentMode === 'timed_exam';
            
            document.getElementById('statsBar').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('studyModeLegend').style.display = isTestMode ? 'none' : 'block';
            document.getElementById('testModeLegend').style.display = isTestMode ? 'block' : 'none';
            document.getElementById('submitSection').style.display = isTestMode ? 'block' : 'none';
            bookmarkBtn.style.display = isTestMode ? 'none' : 'flex';
            markReviewBtn.style.display = isTestMode ? 'flex' : 'none';
            testModeReviewLegend.style.display = isTestMode ? 'flex' : 'none';
            
            if (currentMode === 'timed_study' || currentMode === 'timed_exam') {
                document.getElementById('timerContainer').classList.remove('hidden');
            }
            
            if (!isNaN(startAt) && startAt >= 0 && startAt < questionsData.length) {
                currentQuestionIndex = startAt;
            }

            loadBookmarkedQuestions();
            generateQuestionNav();
            updateStats();
            displayQuestion();
        }

        function generateQuestionNav() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'w-8 h-8 text-sm font-medium rounded transition-all duration-200';
                btn.onclick = () => jumpToQuestion(i);
                btn.id = `navBtn_${i}`;
                nav.appendChild(btn);
            }
            
            updateQuestionNav();
        }

        function updateQuestionNav() {
            for (let i = 0; i < questionsData.length; i++) {
                const btn = document.getElementById(`navBtn_${i}`);
                const state = questionStates[i];
                let className = '';
                
                if (i === currentQuestionIndex) {
                    className = 'nav-btn-current';
                } else if (state.bookmarked) {
                    className = 'nav-btn-bookmarked';
                } else if (state.markedForReview) {
                    className = 'nav-btn-marked-review';
                } else if (currentMode === 'study' || currentMode === 'timed_study') {
                    if (state.status === 'correct') className = 'nav-btn-correct';
                    else if (state.status === 'incorrect') className = 'nav-btn-incorrect';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                } else {
                    if (state.selectedAnswer !== null) className = 'nav-btn-answered';
                    else className = 'nav-btn-not-attempted hover:bg-white hover:bg-opacity-20';
                }
                btn.className = `w-8 h-8 text-sm font-medium rounded ${className}`;
            }
        }

        function jumpToQuestion(index) {
            if (index >= 0 && index < questionsData.length) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex = index;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function updateStats() {
            if (currentMode === 'study' || currentMode === 'timed_study') {
                document.getElementById('correctCount').textContent = stats.correctAnswers;
                document.getElementById('incorrectCount').textContent = stats.incorrectAnswers;
                document.getElementById('totalAttempted').textContent = stats.totalAttempted;
                
                const accuracy = stats.totalAttempted > 0 
                    ? Math.round((stats.correctAnswers / stats.totalAttempted) * 100)
                    : 0;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                stats.totalTime = questionStates.reduce((acc, state) => acc + state.timeSpent, 0);
                const timeSpent = Math.floor(stats.totalTime / 1000);
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                document.getElementById('timeSpent').textContent = 
                    minutes + ':' + seconds.toString().padStart(2, '0');
            }
        }

        function setupVideo(videoElement, url) {
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = url;
            }
        }

        function displayQuestion() {
            if (!questionsData || questionsData.length === 0) {
                document.getElementById('questionText').innerHTML = 'No questions available for this quiz.';
                return;
            };
            
            const question = questionsData[currentQuestionIndex];
            questionStartTime = Date.now();
            
            selectedOption = questionStates[currentQuestionIndex].selectedAnswer;
            
            const progress = ((currentQuestionIndex + 1) / questionsData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            updateQuestionNav();
            
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            
            document.getElementById('solutionContainer').classList.add('hidden');
            
            document.getElementById('questionText').innerHTML = question.text || 'No question text available';
            
            let mediaHtml = '';
            if (question.question_audio) mediaHtml += `<div class="glass-light p-4 mb-4"><audio src="${question.question_audio}" controls class="w-full"></audio></div>`;
            if (question.question_video) mediaHtml += `<div class="glass-light p-4 mb-4"><video src="${question.question_video}" controls class="w-full rounded-lg"></video></div>`;
            if (question.question_images) {
                question.question_images.forEach(imgSrc => {
                    if (imgSrc) mediaHtml += `<div class="glass-light p-4 mb-4"><img src="${imgSrc}" alt="Question Image" class="w-full rounded-lg"></div>`;
                });
            }
            document.getElementById('questionMedia').innerHTML = mediaHtml;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('answered');
            
            if (question.choices && Array.isArray(question.choices)) {
                question.choices.forEach((choice, index) => {
                    const optionLetter = String.fromCharCode(65 + index);
                    const isSelected = selectedOption === index;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `
                        <button type="button" class="option-button ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                            <div class="option-letter">${optionLetter}</div>
                            <div class="option-text">${choice.text || 'Option ' + (index + 1)}</div>
                        </button>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                optionsContainer.addEventListener('click', function(e) {
                    const optionButton = e.target.closest('.option-button');
                    if (optionButton) {
                        const optionIndex = parseInt(optionButton.getAttribute('data-option-index'));
                        selectOption(optionIndex);
                    }
                });
            }
            
            updateBookmarkButton();
            updateMarkReviewButton();

            if ((currentMode === 'timed_study' || currentMode === 'timed_exam') && !isQuizCompleted) {
                startTimer();
            }
        }

        function selectOption(index) {
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer.classList.contains('answered')) return;

            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                questionStartTime = Date.now();
            }
            
            selectedOption = index;
            questionStates[currentQuestionIndex].selectedAnswer = index;
            
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            if (currentMode === 'study' || currentMode === 'timed_study') {
                processAnswer();
            } else {
                if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                    questionStates[currentQuestionIndex].status = 'answered';
                    stats.totalAttempted++;
                    stats.notAttempted--;
                }
                updateQuestionNav();
            }
            saveProgress(); // NEW: Save on answer selection
        }

        function processAnswer() {
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            
            if(selectedOption === null) return;

            const selectedChoice = question.choices[selectedOption];
            const isCorrect = selectedChoice.id === correctChoiceId;
            
            if (questionStates[currentQuestionIndex].status === 'not_attempted') {
                stats.totalAttempted++;
                stats.notAttempted--;
                if(isCorrect) stats.correctAnswers++; else stats.incorrectAnswers++;
            }
            questionStates[currentQuestionIndex].status = isCorrect ? 'correct' : 'incorrect';
            
            updateStats();
            showInlineFeedback(isCorrect);
            updateQuestionNav();
        }

        function showInlineFeedback(isCorrect) {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;

            const optionsContainer = document.getElementById('optionsContainer');
            const optionButtons = optionsContainer.querySelectorAll('.option-button');
            const question = questionsData[currentQuestionIndex];
            const correctChoiceId = question.correct_choice_id;
            let correctOptionIndex = question.choices.findIndex(c => c.id === correctChoiceId);

            optionsContainer.classList.add('answered');

            optionButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === correctOptionIndex) btn.classList.add('correct');
                else if (index === selectedOption && !isCorrect) btn.classList.add('incorrect');
            });

            showSolution();
        }


        function showSolution() {
            if (currentMode !== 'study' && currentMode !== 'timed_study') return;
            
            const question = questionsData[currentQuestionIndex];
            document.getElementById('solutionText').innerHTML = question.solution || 'No solution provided';
            
            const videoContainer = document.getElementById('solutionVideo');
            const videoPlayer = document.getElementById('explanationVideoPlayer');
            const explanationVideo = question.explanation_video;
            
            if (explanationVideo) {
                videoContainer.classList.remove('hidden');
                if (explanationVideo.includes('.m3u8')) setupVideo(videoPlayer, explanationVideo);
                else videoPlayer.src = explanationVideo;
            } else {
                videoContainer.classList.add('hidden');
            }

            const audioContainer = document.getElementById('solutionAudio');
            audioContainer.innerHTML = '';
            if (question.explanation_audio_eng) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English Explanation:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
            }
            if (question.explanation_audio_hin) {
                audioContainer.innerHTML += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish Explanation:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;
            }
            
            const imagesContainer = document.getElementById('solutionImages');
            imagesContainer.innerHTML = '';
            if (question.explanation_images) {
                 question.explanation_images.forEach(imgSrc => {
                    if(imgSrc) imagesContainer.innerHTML += `<div class="mt-4"><img src="${imgSrc}" alt="Explanation Image" class="w-full rounded-lg"></div>`;
                });
            }

            document.getElementById('solutionContainer').classList.remove('hidden');
        }

        function submitQuiz() {
            if (timer) clearInterval(timer);
            if (!confirm('Are you sure you want to submit the quiz?')) return;
            
            isQuizCompleted = true;
            let correct = 0, incorrect = 0;
            const totalTime = Date.now() - quizStartTime;
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                if (state.selectedAnswer !== null) {
                    if (question.choices[state.selectedAnswer].id === question.correct_choice_id) {
                        correct++;
                        state.status = 'correct';
                    } else {
                        incorrect++;
                        state.status = 'incorrect';
                    }
                }
            });
            
            // Save performance data
            const performanceData = JSON.parse(localStorage.getItem('quizPerformanceData')) || [];
            performanceData.push({
                quizName: quizName,
                hierarchy: hierarchy,
                timestamp: Date.now(),
                totalTime: totalTime,
                stats: {
                    correct: correct,
                    incorrect: incorrect,
                    notAttempted: questionsData.length - (correct + incorrect)
                }
            });
            localStorage.setItem('quizPerformanceData', JSON.stringify(performanceData));

            stats.correctAnswers = correct; // Update global stats
            stats.incorrectAnswers = incorrect;
            markQuizAsCompleted(); // NEW: Mark quiz as complete in history
            showPerformanceAnalysis(correct, incorrect, questionsData.length - (correct + incorrect), totalTime);
        }

        function showPerformanceAnalysis(correct, incorrect, notAttempted, totalTime) {
            const modal = document.getElementById('performanceModal');
            const accuracy = (correct + incorrect) > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0;
            
            const circumference = 2 * Math.PI * 65;
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            scoreCircle.style.strokeDashoffset = circumference - (accuracy / 100) * circumference;
            
            document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            document.getElementById('totalQuestionsResult').textContent = questionsData.length;
            document.getElementById('correctResult').textContent = correct;
            document.getElementById('incorrectResult').textContent = incorrect;
            document.getElementById('notAttemptedResult').textContent = notAttempted;
            
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            document.getElementById('totalTimeResult').textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
            
            const avgTime = totalTime / questionsData.length;
            const avgMinutes = Math.floor(avgTime / 60000);
            const avgSeconds = Math.floor((avgTime % 60000) / 1000);
            document.getElementById('avgTimeResult').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            
            modal.classList.remove('hidden');
        }

        function closePerformanceModal() { document.getElementById('performanceModal').classList.add('hidden'); }

        function reviewQuestions() {
            document.getElementById('questionReviewSection').classList.remove('hidden');
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((question, index) => {
                const state = questionStates[index];
                const correctChoiceId = question.correct_choice_id;
                
                let statusClass = 'not-attempted', statusText = 'Not Attempted';
                if (state.selectedAnswer !== null) {
                    const selectedChoice = question.choices[state.selectedAnswer];
                    if (selectedChoice.id === correctChoiceId) { statusClass = 'correct'; statusText = 'Correct'; }
                     else { statusClass = 'incorrect'; statusText = 'Incorrect'; }
                }
                
                const reviewDiv = document.createElement('div');
                reviewDiv.className = `review-question ${statusClass}`;
                
                let optionsHtml = (question.choices || []).map((choice, choiceIndex) => {
                    const isSelected = state.selectedAnswer === choiceIndex;
                    const isCorrect = choice.id === correctChoiceId;
                    let borderClass = 'border-gray-600';
                    if(isCorrect) borderClass = 'border-green-500';
                    else if(isSelected) borderClass = 'border-red-500';
                    
                    return `<div class="p-3 rounded-lg border ${borderClass}"><span class="font-bold mr-3">${String.fromCharCode(65 + choiceIndex)}</span><span>${choice.text}</span></div>`;
                }).join('');

                const videoHtml = question.explanation_video ? `<div class="mt-4"><video id="review-video-${index}" data-src="${question.explanation_video}" class="w-full rounded-lg" controls></video></div>` : '';
                
                let audioHtml = '';
                if(question.explanation_audio_eng) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">English:</p><audio src="${question.explanation_audio_eng}" controls class="w-full"></audio></div>`;
                if(question.explanation_audio_hin) audioHtml += `<div class="mt-2"><p class="text-sm text-white text-opacity-70 mb-1">Hinglish:</p><audio src="${question.explanation_audio_hin}" controls class="w-full"></audio></div>`;

                let imagesHtml = (question.explanation_images || []).map(src => src ? `<div class="mt-4"><img src="${src}" alt="Explanation Image" class="w-full rounded-lg"></div>` : '').join('');

                reviewDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-bold text-white">Question ${index + 1}</h4>
                            <span class="text-sm px-3 py-1 rounded-full bg-${statusClass === 'correct' ? 'green' : statusClass === 'incorrect' ? 'red' : 'gray'}-600 text-white">${statusText}</span>
                        </div>
                        <div class="text-white mb-4">${question.text}</div>
                    </div>
                    <div class="space-y-2 mb-4">${optionsHtml}</div>
                    <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                        <h5 class="text-green-400 font-bold mb-2">Explanation:</h5>
                        <div class="text-white text-opacity-90">${question.solution || 'No solution available.'}</div>
                        ${videoHtml}
                        ${audioHtml}
                        ${imagesHtml}
                    </div>`;
                container.appendChild(reviewDiv);
            });
            initializeReviewVideos();
        }

        function initializeReviewVideos() {
            document.querySelectorAll('video[data-src]').forEach(videoEl => {
                const src = videoEl.dataset.src;
                if (src && src.includes('.m3u8')) {
                    setupVideo(videoEl, src);
                } else if (src) {
                    videoEl.src = src;
                }
            });
        }

        function retakeQuiz() {
            if (confirm('Are you sure you want to retake the quiz? This will reset all your answers.')) {
                if (window.location.pathname.endsWith('custom_quiz.html')) {
                    localStorage.removeItem('customQuizData');
                }
                clearProgress(); // NEW: Clear history on retake
                location.reload();
            }
        }

        function loadBookmarkedQuestions() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            bookmarks.forEach(bookmark => {
                if (bookmark.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-'))) {
                    if (bookmark.questionIndex < questionsData.length) {
                        questionStates[bookmark.questionIndex].bookmarked = true;
                    }
                }
            });
        }

        function toggleBookmark() {
            const isBookmarked = !questionStates[currentQuestionIndex].bookmarked;
            questionStates[currentQuestionIndex].bookmarked = isBookmarked;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarkedQuestions')) || [];
            
            if (isBookmarked) {
                const bookmarkData = {
                    quizName: quizName,
                    quizFile: window.location.pathname.split('/').pop(),
                    questionIndex: currentQuestionIndex,
                    question: questionsData[currentQuestionIndex],
                    hierarchy: hierarchy,
                    timestamp: Date.now()
                };
                bookmarks.push(bookmarkData);
            } else {
                bookmarks = bookmarks.filter(b => 
                    !(b.quizFile.includes(quizName.toLowerCase().replace(/ /g, '-')) && b.questionIndex === currentQuestionIndex)
                );
            }
            
            localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarks));
            updateBookmarkButton();
            updateQuestionNav();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            const text = document.getElementById('bookmarkText');
            const isBookmarked = questionStates[currentQuestionIndex].bookmarked;
            
            btn.className = isBookmarked ? 'gradient-yellow px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-yellow-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
        }
        
        function toggleMarkForReview() {
            questionStates[currentQuestionIndex].markedForReview = !questionStates[currentQuestionIndex].markedForReview;
            updateMarkReviewButton();
            updateQuestionNav();
        }

        function updateMarkReviewButton() {
            const btn = document.getElementById('markReviewBtn');
            const text = document.getElementById('markReviewText');
            const isMarked = questionStates[currentQuestionIndex].markedForReview;
            
            btn.className = isMarked ? 'gradient-purple px-6 py-3 text-white transition-all duration-300 flex items-center' : 'glass-light px-6 py-3 text-white hover:bg-purple-500 hover:bg-opacity-20 transition-all duration-300 flex items-center';
            text.textContent = isMarked ? 'Marked' : 'Mark for Review';
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                if (questionStartTime) {
                    questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
                }
                
                currentQuestionIndex--;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            }
        }

        function nextQuestion() {
            if (questionStartTime) {
                questionStates[currentQuestionIndex].timeSpent += Date.now() - questionStartTime;
            }
            
            if (currentQuestionIndex < questionsData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                saveProgress(); // NEW: Save on navigation
            } else {
                if (currentMode === 'test' || currentMode === 'timed_exam') {
                    if (confirm('You have reached the end of the quiz. Would you like to submit your answers now?')) {
                        submitQuiz();
                    }
                } else {
                    if (confirm('You have completed all questions. Would you like to review from the beginning?')) {
                        currentQuestionIndex = 0;
                        displayQuestion();
                        saveProgress();
                    }
                }
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timeRemaining = 120; // 2 minutes per question
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    if (currentMode === 'timed_exam') {
                        submitQuiz();
                    } else {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timeDisplay').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
        }

        function toggleSidebar() {
            document.getElementById('quizSidebar').classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
             if (resume) {
                if (loadProgress()) {
                    document.getElementById('modeModal').style.display = 'none';
                    initializeQuiz(); // Resume directly into the saved mode and state
                } else {
                    // If resume fails (e.g., cleared history), start fresh
                    clearProgress();
                    document.getElementById('modeModal').style.display = 'flex';
                }
             } else if (!window.location.pathname.endsWith('custom_quiz.html')) {
                clearProgress(); // Clear old progress if not resuming
                document.getElementById('modeModal').style.display = 'flex';
             } else {
                initializeQuiz();
             }
        });
        
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('modeModal').style.display !== 'none') return;
            if (document.getElementById('performanceModal').classList.contains('hidden') === false) return;
            
            if (e.key >= '1' && e.key <= '4') {
                const optionIndex = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-button');
                if (optionIndex < options.length) selectOption(optionIndex);
            } else if (e.key === 'ArrowLeft') {
                previousQuestion();
            } else if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key.toLowerCase() === 'b' && (currentMode === 'study' || currentMode === 'timed_study')) {
                toggleBookmark();
            } else if (e.key.toLowerCase() === 'm' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                toggleMarkForReview();
            } else if (e.key.toLowerCase() === 's' && (currentMode === 'test' || currentMode === 'timed_exam')) {
                submitQuiz();
            }
        });
    </script>
</body>
</html>